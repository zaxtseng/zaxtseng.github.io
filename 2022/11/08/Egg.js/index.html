<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="核心思想: 约定大于配置  基础用法建议直接去这里: 官方快速入门 目录结构12345678910111213141516171819202122232425262728293031323334353637egg-project├── package.json├── app.js (可选)├── agent.js (可选)├── app|   ├── router.js│   ├── contro">
<meta property="og:type" content="article">
<meta property="og:title" content="Egg.js">
<meta property="og:url" content="http://example.com/2022/11/08/Egg.js/index.html">
<meta property="og:site_name" content="ZAX">
<meta property="og:description" content="核心思想: 约定大于配置  基础用法建议直接去这里: 官方快速入门 目录结构12345678910111213141516171819202122232425262728293031323334353637egg-project├── package.json├── app.js (可选)├── agent.js (可选)├── app|   ├── router.js│   ├── contro">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-11-08T09:08:35.000Z">
<meta property="article:modified_time" content="2023-06-17T00:38:32.494Z">
<meta property="article:author" content="Zax Tseng">
<meta property="article:tag" content="javascript, React, Vue, HTML5">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2022/11/08/Egg.js/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/11/08/Egg.js/","path":"2022/11/08/Egg.js/","title":"Egg.js"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Egg.js | ZAX</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ZAX</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95"><span class="nav-number">1.</span> <span class="nav-text">基础用法</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">目录结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="nav-number">3.</span> <span class="nav-text">初始化脚本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span class="nav-number">4.</span> <span class="nav-text">模块设计</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%9F%BA%E7%A1%80%E5%AF%B9%E8%B1%A1"><span class="nav-number">5.</span> <span class="nav-text">内置基础对象</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Application"><span class="nav-number">6.</span> <span class="nav-text">Application</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Controller"><span class="nav-number">7.</span> <span class="nav-text">Controller</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E7%9B%B8%E5%85%B3"><span class="nav-number">8.</span> <span class="nav-text">路由相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-get-%E4%BC%A0%E5%80%BC"><span class="nav-number">8.1.</span> <span class="nav-text">1. get 传值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E7%A7%8D%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95"><span class="nav-number">8.2.</span> <span class="nav-text">2. 4 种配置方法</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">9.</span> <span class="nav-text">重定向</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-ctx"><span class="nav-number">9.1.</span> <span class="nav-text">1. ctx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%B7%AF%E7%94%B1%E9%87%8D%E5%AE%9A%E5%90%91"><span class="nav-number">9.2.</span> <span class="nav-text">2. 路由重定向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84"><span class="nav-number">9.3.</span> <span class="nav-text">3.路由分组</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">10.</span> <span class="nav-text">控制器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Controller-%E5%9F%BA%E7%B1%BB"><span class="nav-number">10.1.</span> <span class="nav-text">自定义 Controller 基类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="nav-number">11.</span> <span class="nav-text">模板引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8-ejs"><span class="nav-number">11.1.</span> <span class="nav-text">1. 安装和使用 ejs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E5%AE%89%E8%A3%85%EF%BC%9A"><span class="nav-number">11.1.1.</span> <span class="nav-text">（1）安装：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E9%85%8D%E7%BD%AE%EF%BC%9A-x2F-config"><span class="nav-number">11.1.2.</span> <span class="nav-text">（2）配置：&#x2F;config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E4%BD%BF%E7%94%A8"><span class="nav-number">11.1.3.</span> <span class="nav-text">（3）使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">12.</span> <span class="nav-text">模型和数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E5%92%8C%E5%88%9B%E5%BB%BA%E8%BF%81%E7%A7%BB%E6%96%87%E4%BB%B6"><span class="nav-number">12.1.</span> <span class="nav-text">配置和创建迁移文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">12.1.1.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E8%A1%A8"><span class="nav-number">12.1.2.</span> <span class="nav-text">创建数据迁移表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%B2%E5%88%9B%E5%BB%BA%E6%96%B0%E5%A2%9E%E5%AD%97%E6%AE%B5"><span class="nav-number">12.1.3.</span> <span class="nav-text">已创建新增字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B"><span class="nav-number">12.1.4.</span> <span class="nav-text">创建模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0"><span class="nav-number">12.1.5.</span> <span class="nav-text">模型其他参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sequelize-%E5%91%BD%E4%BB%A4"><span class="nav-number">12.1.6.</span> <span class="nav-text">sequelize 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F%EF%BC%88%E9%87%8D%E8%A6%81%EF%BC%89"><span class="nav-number">12.1.7.</span> <span class="nav-text">外键约束（重要）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%A7%8D%E5%AD%90"><span class="nav-number">12.1.8.</span> <span class="nav-text">创建第一个种子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%A7%8D%E5%AD%90"><span class="nav-number">12.1.9.</span> <span class="nav-text">运行种子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%92%A4%E9%94%80%E7%A7%8D%E5%AD%90"><span class="nav-number">12.1.10.</span> <span class="nav-text">撤销种子</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E6%93%8D%E4%BD%9C"><span class="nav-number">12.2.</span> <span class="nav-text">关联操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="nav-number">12.2.1.</span> <span class="nav-text">一对一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="nav-number">12.2.2.</span> <span class="nav-text">一对多</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="nav-number">12.2.3.</span> <span class="nav-text">多对多</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E8%81%94%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">12.2.4.</span> <span class="nav-text">关联常用操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%99%A8%E5%92%8C%E4%BF%AE%E6%94%B9%E5%99%A8"><span class="nav-number">12.3.</span> <span class="nav-text">获取器和修改器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E9%92%A9%E5%AD%90"><span class="nav-number">12.4.</span> <span class="nav-text">模型钩子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2"><span class="nav-number">12.5.</span> <span class="nav-text">查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E9%94%AE%E6%9F%A5%E8%AF%A2"><span class="nav-number">12.5.1.</span> <span class="nav-text">主键查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E4%B8%8D%E5%AD%98%E5%9C%A8%E5%88%99%E5%88%9B%E5%BB%BA"><span class="nav-number">12.5.2.</span> <span class="nav-text">查找不存在则创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E5%B9%B6%E8%AE%A1%E6%95%B0"><span class="nav-number">12.5.3.</span> <span class="nav-text">查找并计数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%A4%9A%E4%B8%AA%EF%BC%88%E5%B8%B8%E7%94%A8%EF%BC%89"><span class="nav-number">12.5.4.</span> <span class="nav-text">查询多个（常用）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%90%88%E8%BF%87%E6%BB%A4-x2F-OR-x2F-NOT-%E6%9F%A5%E8%AF%A2"><span class="nav-number">12.5.5.</span> <span class="nav-text">复合过滤 &#x2F; OR &#x2F; NOT 查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E9%99%90%E5%88%B6-%E5%81%8F%E7%A7%BB-%E9%A1%BA%E5%BA%8F%E5%92%8C%E5%88%86%E7%BB%84%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="nav-number">12.5.6.</span> <span class="nav-text">用限制,偏移,顺序和分组操作数据集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E8%BF%87%E6%BB%A4"><span class="nav-number">12.5.7.</span> <span class="nav-text">字段过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Where"><span class="nav-number">12.5.8.</span> <span class="nav-text">Where</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80"><span class="nav-number">12.5.8.1.</span> <span class="nav-text">基础</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-number">12.5.8.2.</span> <span class="nav-text">操作符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8C%83%E5%9B%B4%E9%80%89%E9%A1%B9"><span class="nav-number">12.5.8.3.</span> <span class="nav-text">范围选项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E5%90%88"><span class="nav-number">12.5.8.4.</span> <span class="nav-text">组合</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E7%B3%BB-x2F-%E5%85%B3%E8%81%94"><span class="nav-number">12.5.8.5.</span> <span class="nav-text">关系 &#x2F; 关联</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5-x2F-%E9%99%90%E5%88%B6"><span class="nav-number">12.5.9.</span> <span class="nav-text">分页 &#x2F; 限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F"><span class="nav-number">12.5.10.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#count-%E8%AE%A1%E7%AE%97%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%85%83%E7%B4%A0%E7%9A%84%E5%87%BA%E7%8E%B0%E6%AC%A1%E6%95%B0"><span class="nav-number">12.5.11.</span> <span class="nav-text">count - 计算数据库中元素的出现次数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#max-%E8%8E%B7%E5%8F%96%E7%89%B9%E5%AE%9A%E8%A1%A8%E4%B8%AD%E7%89%B9%E5%AE%9A%E5%B1%9E%E6%80%A7%E7%9A%84%E6%9C%80%E5%A4%A7%E5%80%BC"><span class="nav-number">12.5.12.</span> <span class="nav-text">max - 获取特定表中特定属性的最大值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#min-%E8%8E%B7%E5%8F%96%E7%89%B9%E5%AE%9A%E8%A1%A8%E4%B8%AD%E7%89%B9%E5%AE%9A%E5%B1%9E%E6%80%A7%E7%9A%84%E6%9C%80%E5%B0%8F%E5%80%BC"><span class="nav-number">12.5.13.</span> <span class="nav-text">min - 获取特定表中特定属性的最小值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sum-%E7%89%B9%E5%AE%9A%E5%B1%9E%E6%80%A7%E7%9A%84%E5%80%BC%E6%B1%82%E5%92%8C"><span class="nav-number">12.5.14.</span> <span class="nav-text">sum - 特定属性的值求和</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">12.6.</span> <span class="nav-text">预加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E9%A2%84%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%A1%B6%E5%B1%82-WHERE"><span class="nav-number">12.6.1.</span> <span class="nav-text">使用预加载模型的顶层 WHERE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%85%E6%8B%AC%E6%89%80%E6%9C%89"><span class="nav-number">12.6.2.</span> <span class="nav-text">包括所有</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%85%E6%8B%AC%E8%BD%AF%E5%88%A0%E9%99%A4%E7%9A%84%E8%AE%B0%E5%BD%95"><span class="nav-number">12.6.3.</span> <span class="nav-text">包括软删除的记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%92%E5%BA%8F%E9%A2%84%E5%8A%A0%E8%BD%BD%E5%85%B3%E8%81%94"><span class="nav-number">12.6.4.</span> <span class="nav-text">排序预加载关联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B5%8C%E5%A5%97%E9%A2%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">12.6.5.</span> <span class="nav-text">嵌套预加载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E"><span class="nav-number">12.7.</span> <span class="nav-text">新增</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E9%99%90%E5%88%B6"><span class="nav-number">12.7.1.</span> <span class="nav-text">字段限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E%E5%8D%95%E4%B8%AA"><span class="nav-number">12.7.2.</span> <span class="nav-text">新增单个</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E6%96%B0%E5%A2%9E"><span class="nav-number">12.7.3.</span> <span class="nav-text">批量新增</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9"><span class="nav-number">12.8.</span> <span class="nav-text">修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E9%99%90%E5%88%B6-1"><span class="nav-number">12.8.1.</span> <span class="nav-text">字段限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E4%B8%AA%E4%BF%AE%E6%94%B9"><span class="nav-number">12.8.2.</span> <span class="nav-text">单个修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9"><span class="nav-number">12.8.3.</span> <span class="nav-text">批量修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%92%E5%A2%9E"><span class="nav-number">12.8.4.</span> <span class="nav-text">递增</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%92%E5%87%8F"><span class="nav-number">12.8.5.</span> <span class="nav-text">递减</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4"><span class="nav-number">12.9.</span> <span class="nav-text">删除</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E5%88%A0%E9%99%A4"><span class="nav-number">12.9.1.</span> <span class="nav-text">软删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E8%AF%A2%E5%8C%85%E6%8B%AC%E8%BD%AF%E5%88%A0%E9%99%A4%E5%86%85%E5%AE%B9"><span class="nav-number">12.9.2.</span> <span class="nav-text">查询包括软删除内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4"><span class="nav-number">12.9.3.</span> <span class="nav-text">彻底删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%81%A2%E5%A4%8D%E8%BD%AF%E5%88%A0%E9%99%A4%E7%9A%84%E5%AE%9E%E4%BE%8B"><span class="nav-number">12.9.4.</span> <span class="nav-text">恢复软删除的实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%A1%E4%BB%B6%E5%88%A0%E9%99%A4"><span class="nav-number">12.9.5.</span> <span class="nav-text">条件删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%B9%E9%87%8F%E5%88%A0%E9%99%A4"><span class="nav-number">12.9.6.</span> <span class="nav-text">批量删除</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E8%BD%BD%E5%AE%9E%E4%BE%8B"><span class="nav-number">12.10.</span> <span class="nav-text">重载实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95"><span class="nav-number">12.11.</span> <span class="nav-text">模型自定义方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Scopes-%E4%BD%9C%E7%94%A8%E5%9F%9F%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%89"><span class="nav-number">12.12.</span> <span class="nav-text">Scopes - 作用域（重点）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89"><span class="nav-number">12.12.1.</span> <span class="nav-text">定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">12.12.2.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%88%E5%B9%B6"><span class="nav-number">12.12.3.</span> <span class="nav-text">合并</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%88%E5%B9%B6-include"><span class="nav-number">12.12.3.1.</span> <span class="nav-text">合并 include</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E8%81%94"><span class="nav-number">12.12.4.</span> <span class="nav-text">关联</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%A9%E5%B1%95"><span class="nav-number">13.</span> <span class="nav-text">扩展</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">14.</span> <span class="nav-text">中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%AE%9A%E4%B9%89"><span class="nav-number">14.1.</span> <span class="nav-text">1. 定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%85%8D%E7%BD%AE"><span class="nav-number">14.2.</span> <span class="nav-text">2. 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BD%BF%E7%94%A8"><span class="nav-number">14.3.</span> <span class="nav-text">3. 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="nav-number">14.3.1.</span> <span class="nav-text">路由中使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Koa-%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%88gzip-%E5%8E%8B%E7%BC%A9%EF%BC%89"><span class="nav-number">14.3.2.</span> <span class="nav-text">使用 Koa 的中间件（gzip 压缩）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A1%A8%E5%8D%95%E6%8F%90%E4%BA%A4"><span class="nav-number">15.</span> <span class="nav-text">表单提交</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#post"><span class="nav-number">15.1.</span> <span class="nav-text">post</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#cookie"><span class="nav-number">16.</span> <span class="nav-text">cookie</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#session"><span class="nav-number">17.</span> <span class="nav-text">session</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">18.</span> <span class="nav-text">定时任务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#API"><span class="nav-number">19.</span> <span class="nav-text">API</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-context"><span class="nav-number">19.1.</span> <span class="nav-text">1. context</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#curl"><span class="nav-number">19.1.1.</span> <span class="nav-text">curl</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="nav-number">20.</span> <span class="nav-text">常用插件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98"><span class="nav-number">20.1.</span> <span class="nav-text">缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">20.2.</span> <span class="nav-text">验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E5%AF%86"><span class="nav-number">20.3.</span> <span class="nav-text">加密</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zax Tseng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">123</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/Egg.js/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Egg.js | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Egg.js
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:08:35" itemprop="dateCreated datePublished" datetime="2022-11-08T17:08:35+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-06-17 08:38:32" itemprop="dateModified" datetime="2023-06-17T08:38:32+08:00">2023-06-17</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">核心思想: 约定大于配置</div>

<h1 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h1><p>建议直接去这里: <a target="_blank" rel="noopener" href="https://www.eggjs.org/zh-CN/intro/quickstart">官方快速入门</a></p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">egg-project</span><br><span class="line">├── package.json</span><br><span class="line">├── app.js (可选)</span><br><span class="line">├── agent.js (可选)</span><br><span class="line">├── app</span><br><span class="line">|   ├── router.js</span><br><span class="line">│   ├── controller</span><br><span class="line">│   |   └── home.js</span><br><span class="line">│   ├── service (可选)</span><br><span class="line">│   |   └── user.js</span><br><span class="line">│   ├── middleware (可选)</span><br><span class="line">│   |   └── response_time.js</span><br><span class="line">│   ├── schedule (可选)</span><br><span class="line">│   |   └── my_task.js</span><br><span class="line">│   ├── public (可选)</span><br><span class="line">│   |   └── reset.css</span><br><span class="line">│   ├── view (可选)</span><br><span class="line">│   |   └── home.tpl</span><br><span class="line">│   └── extend (可选)</span><br><span class="line">│       ├── helper.js (可选)</span><br><span class="line">│       ├── request.js (可选)</span><br><span class="line">│       ├── response.js (可选)</span><br><span class="line">│       ├── context.js (可选)</span><br><span class="line">│       ├── application.js (可选)</span><br><span class="line">│       └── agent.js (可选)</span><br><span class="line">├── config</span><br><span class="line">|   ├── plugin.js</span><br><span class="line">|   ├── config.default.js</span><br><span class="line">│   ├── config.prod.js</span><br><span class="line">|   ├── config.test.js (可选)</span><br><span class="line">|   ├── config.local.js (可选)</span><br><span class="line">|   └── config.unittest.js (可选)</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── middleware</span><br><span class="line">    |   └── response_time.test.js</span><br><span class="line">    └── controller</span><br><span class="line">        └── home.test.js</span><br></pre></td></tr></table></figure>

<h1 id="初始化脚本"><a href="#初始化脚本" class="headerlink" title="初始化脚本"></a>初始化脚本</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm create egg --type=simple -r=https://registry.npmmirror.com/</span><br></pre></td></tr></table></figure>

<h1 id="模块设计"><a href="#模块设计" class="headerlink" title="模块设计"></a>模块设计</h1><p>model 层: 放置一些要往数据库中存储的数据类型的模型.主要是<code>Schema</code>的实例.<br>service 层: 对 model 层中对应数据库的数据的操作,增删改查之类.<br>controller 层: 设计的业务逻辑,通过调用 service 的一些方法实现,返回给前端.<br>middleware: 在多处使用的方法可以抽离出,比如<code>auth</code>,<code>error</code>等模块.<br>config: 配置基础参数.<br>extend: 扩展方法,主要是一些和业务逻辑关联性不大的方法.比如<code>md5</code>加密.<br>schedule: 定时任务.</p>
<h1 id="内置基础对象"><a href="#内置基础对象" class="headerlink" title="内置基础对象"></a>内置基础对象</h1><p>Application,Context,Request,Response,Controller,Service,Helper,Config,Logger,Subscription.<br>其中前 4 个是从 Koa 继承而来.其他是框架自身的.</p>
<h1 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h1><p>Application 是全局应用对象。在一个应用中，每个进程只会实例化一个 Application 实例。在它上面我们可以挂载一些全局的方法和对象。</p>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><p>框架提供了一个 Controller 基类，并推荐所有的 Controller 都继承于该基类实现。这个 Controller 基类有下列属性：</p>
<ul>
<li><code>ctx</code> - 当前请求的 Context 实例。</li>
<li><code>app</code> - 应用的 Application 实例。</li>
<li><code>config</code> - 应用的配置。</li>
<li><code>service</code> - 应用所有的 service。</li>
<li><code>logger</code> - 为当前 controller 封装的 logger 对象。</li>
</ul>
<h1 id="路由相关"><a href="#路由相关" class="headerlink" title="路由相关"></a>路由相关</h1><h2 id="1-get-传值"><a href="#1-get-传值" class="headerlink" title="1. get 传值"></a>1. get 传值</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/admin/:id&#x27;</span>, controller.<span class="property">admin</span>.<span class="property">index</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// controller</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取路由get传值参数（路由:id）</span></span><br><span class="line">    ctx.<span class="property">params</span>;</span><br><span class="line">    <span class="comment">// 获取url的问号get传值参数</span></span><br><span class="line">    ctx.<span class="property">query</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-种配置方法"><a href="#2-4-种配置方法" class="headerlink" title="2. 4 种配置方法"></a>2. 4 种配置方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;path-match&#x27;</span>, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;router-name&#x27;</span>, <span class="string">&#x27;path-match&#x27;</span>, app.<span class="property">controller</span>.<span class="property">action</span>);<span class="comment">// 第一个参数可以给name</span></span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;path-match&#x27;</span>, middleware1, ..., middlewareN, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;router-name&#x27;</span>, <span class="string">&#x27;path-match&#x27;</span>, middleware1, ..., middlewareN, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br></pre></td></tr></table></figure>

<h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><h2 id="1-ctx"><a href="#1-ctx" class="headerlink" title="1. ctx"></a>1. ctx</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">status</span> = <span class="number">301</span>; <span class="comment">// 把重定向改为301</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">redirect</span>(<span class="string">&#x27;/admin/add&#x27;</span>); <span class="comment">// 默认临时重定向 302</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-路由重定向"><a href="#2-路由重定向" class="headerlink" title="2. 路由重定向"></a>2. 路由重定向</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="property">router</span>.<span class="title function_">redirect</span>(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/home/index&quot;</span>, <span class="number">302</span>);</span><br></pre></td></tr></table></figure>

<h2 id="3-路由分组"><a href="#3-路由分组" class="headerlink" title="3.路由分组"></a>3.路由分组</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./router/news&quot;</span>)(app);</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./router/admin&quot;</span>)(app);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/news.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/news/list&quot;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">list</span>);</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/news/detail&quot;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">detail</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/admin.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/admin/user&quot;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">user</span>);</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/admin/log&quot;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">log</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h1><h2 id="自定义-Controller-基类"><a href="#自定义-Controller-基类" class="headerlink" title="自定义 Controller 基类"></a>自定义 Controller 基类</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/core/base_controller.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Controller</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">user</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">session</span>.<span class="property">user</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">success</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">      data,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">notFound</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">    msg = msg || <span class="string">&quot;not found&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="keyword">throw</span>(<span class="number">404</span>, msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">BaseController</span>;</span><br></pre></td></tr></table></figure>

<p>此时在编写应用的 Controller 时，可以继承 BaseController，直接使用基类上的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app/controller/post.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Controller</span> = <span class="built_in">require</span>(<span class="string">&quot;../core/base_controller&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PostController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> posts = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">service</span>.<span class="title function_">listByUser</span>(<span class="variable language_">this</span>.<span class="property">user</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">success</span>(posts);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h1><h2 id="1-安装和使用-ejs"><a href="#1-安装和使用-ejs" class="headerlink" title="1. 安装和使用 ejs"></a>1. 安装和使用 ejs</h2><h3 id="（1）安装："><a href="#（1）安装：" class="headerlink" title="（1）安装："></a>（1）安装：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-view-ejs --save</span><br></pre></td></tr></table></figure>

<h3 id="（2）配置：-x2F-config"><a href="#（2）配置：-x2F-config" class="headerlink" title="（2）配置：&#x2F;config"></a>（2）配置：&#x2F;config</h3><p>config&#x2F;config.default.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">appInfo</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    config.<span class="property">view</span> = &#123;</span><br><span class="line">        <span class="attr">mapping</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;.html&#x27;</span>: <span class="string">&#x27;ejs&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>config&#x2F;plugin.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 配置ejs</span></span><br><span class="line">  <span class="attr">ejs</span>: &#123;</span><br><span class="line">    <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">package</span>: <span class="string">&quot;egg-view-ejs&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="（3）使用"><a href="#（3）使用" class="headerlink" title="（3）使用"></a>（3）使用</h3><p>app&#x2F;controller</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 渲染变量</span></span><br><span class="line">    <span class="keyword">let</span> msg = <span class="string">&quot;测试内容&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line">    <span class="comment">// 渲染模板（render需要加await）</span></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;</span><br><span class="line">        msg,</span><br><span class="line">        list</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app&#x2F;view&#x2F;index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--渲染变量--&gt;</span></span><br><span class="line">    &lt;%=msg%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      &lt;% for(var i=0; i &lt; list.length; i++)&#123; %&gt;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%=list[i]%&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载 app/public 下的资源文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/public/images/find.png&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="模型和数据库"><a href="#模型和数据库" class="headerlink" title="模型和数据库"></a>模型和数据库</h1><h2 id="配置和创建迁移文件"><a href="#配置和创建迁移文件" class="headerlink" title="配置和创建迁移文件"></a>配置和创建迁移文件</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><strong>文档地址：</strong><a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/blob/v5/migrations.md"><strong>https://github.com/demopark/sequelize-docs-Zh-CN/blob/v5/migrations.md</strong></a></p>
<ol>
<li>安装并配置<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg-sequelize">egg-sequelize</a>插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和<a target="_blank" rel="noopener" href="https://github.com/sidorares/node-mysql2">mysql2</a>模块：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在<code>config/plugin.js</code>中引入 egg-sequelize 插件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exports.sequelize = &#123;</span><br><span class="line">  enable: true,</span><br><span class="line">  package: &#x27;egg-sequelize&#x27;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在<code>config/config.default.js</code></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">config.<span class="property">sequelize</span> = &#123;</span><br><span class="line">  <span class="attr">dialect</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">  <span class="attr">username</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&quot;friends&quot;</span>,</span><br><span class="line">  <span class="comment">// 中国时区</span></span><br><span class="line">  <span class="attr">timezone</span>: <span class="string">&quot;+08:00&quot;</span>,</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// 取消数据表名复数</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 自动写入时间戳 created_at updated_at</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 字段生成软删除时间戳 deleted_at</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">createdAt</span>: <span class="string">&quot;created_at&quot;</span>,</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;updated_at&quot;</span>,</span><br><span class="line">    <span class="attr">deletedAt</span>: <span class="string">&quot;deleted_at&quot;</span>,</span><br><span class="line">    <span class="comment">// 所有驼峰命名格式化</span></span><br><span class="line">    <span class="attr">underscored</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>sequelize 提供了<a target="_blank" rel="noopener" href="https://github.com/sequelize/cli">sequelize-cli</a>工具来实现<a target="_blank" rel="noopener" href="http://docs.sequelizejs.com/manual/tutorial/migrations.html">Migrations</a>，我们也可以在 egg 项目中引入 sequelize-cli。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev sequelize-cli</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在<code>database</code>目录下，所以我们在项目根目录下新建一个<code>.sequelizerc</code>配置文件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">config</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/config.json&quot;</span>),</span><br><span class="line">  <span class="string">&quot;migrations-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/migrations&quot;</span>),</span><br><span class="line">  <span class="string">&quot;seeders-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/seeders&quot;</span>),</span><br><span class="line">  <span class="string">&quot;models-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;app/model&quot;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>初始化 Migrations 配置文件和目录</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">init</span>:config</span><br><span class="line">npx sequelize <span class="attr">init</span>:migrations</span><br><span class="line"><span class="comment">// npx sequelize init:models</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>行完后会生成<code>database/config.json</code>文件和<code>database/migrations</code>目录，我们修改一下<code>database/config.json</code>中的内容，将其改成我们项目中使用的数据库配置：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;development&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dialect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timezone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+08:00&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="8">
<li>创建数据库</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">db</span>:create</span><br></pre></td></tr></table></figure>

<h3 id="创建数据迁移表"><a href="#创建数据迁移表" class="headerlink" title="创建数据迁移表"></a>创建数据迁移表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">migration</span>:generate --name=init-users</span><br></pre></td></tr></table></figure>

<p>1.执行完命令后，会在 database &#x2F; migrations &#x2F; 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="keyword">async</span> (queryInterface, <span class="title class_">Sequelize</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="comment">// 创建表</span></span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">createTable</span>(</span><br><span class="line">      <span class="string">&quot;users&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>).<span class="property">UNSIGNED</span>,</span><br><span class="line">          <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">username</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户名称&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">email</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">160</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户邮箱&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">avatar_url</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">mobile</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">20</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户手机&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">prifix</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">32</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">abstract</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">255</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">role_id</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">          <span class="comment">//  定义外键（重要）</span></span><br><span class="line">          <span class="attr">references</span>: &#123;</span><br><span class="line">            <span class="attr">model</span>: <span class="string">&quot;users&quot;</span>, <span class="comment">// 对应表名称（数据表名称）</span></span><br><span class="line">            <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>, <span class="comment">// 对应表的主键</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">          <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>, <span class="comment">// 删除时操作</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">gender</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="variable constant_">ENUM</span>,</span><br><span class="line">          <span class="attr">values</span>: [<span class="string">&quot;男&quot;</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;保密&quot;</span>],</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户性别&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">        <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; <span class="attr">engine</span>: <span class="string">&quot;MYISAM&quot;</span> &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 添加索引</span></span><br><span class="line">    queryInterface.<span class="title function_">addIndex</span>(<span class="string">&quot;users&quot;</span>, [<span class="string">&quot;gender&quot;</span>]);</span><br><span class="line">    <span class="comment">// 添加唯一索引</span></span><br><span class="line">    queryInterface.<span class="title function_">addIndex</span>(<span class="string">&quot;users&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>, <span class="comment">// 索引名称</span></span><br><span class="line">      <span class="attr">unique</span>: <span class="literal">true</span>, <span class="comment">// 唯一索引</span></span><br><span class="line">      <span class="attr">fields</span>: [<span class="string">&quot;name&quot;</span>], <span class="comment">// 索引对应字段</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="keyword">async</span> (queryInterface) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行 migrate 进行数据库变更</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级数据库</span></span><br><span class="line">npx sequelize db:migrate</span><br><span class="line"><span class="comment"># 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo</span></span><br><span class="line"><span class="comment"># 可以通过 `db:migrate:undo:all` 回退到初始状态</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo:all</span></span><br></pre></td></tr></table></figure>

<h3 id="已创建新增字段"><a href="#已创建新增字段" class="headerlink" title="已创建新增字段"></a>已创建新增字段</h3><p>1.创建迁移文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=user-addcolumn</span><br></pre></td></tr></table></figure>

<p>2.执行完命令后，会在 database &#x2F; migrations &#x2F; 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="property">sequelize</span>.<span class="title function_">transaction</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">        queryInterface.<span class="title function_">addColumn</span>(</span><br><span class="line">          <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="string">&quot;role_id&quot;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="property">INTEGER</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">transaction</span>: t &#125;</span><br><span class="line">        ),</span><br><span class="line">        queryInterface.<span class="title function_">addColumn</span>(</span><br><span class="line">          <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ceshi&quot;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">transaction</span>: t &#125;</span><br><span class="line">        ),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="property">sequelize</span>.<span class="title function_">transaction</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">        queryInterface.<span class="title function_">removeColumn</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;role_id&quot;</span>, &#123; <span class="attr">transaction</span>: t &#125;),</span><br><span class="line">        queryInterface.<span class="title function_">removeColumn</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;ceshi&quot;</span>, &#123; <span class="attr">transaction</span>: t &#125;),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>3.执行 migrate 进行数据库变更</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:migrate</span><br></pre></td></tr></table></figure>

<h3 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app / model / user.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line">  <span class="comment">// 配置（重要：一定要配置详细，一定要！！！）</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">    <span class="string">&quot;user&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">      <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">timestamps</span>: <span class="literal">true</span>, <span class="comment">// 是否自动写入时间戳</span></span><br><span class="line">      <span class="attr">tableName</span>: <span class="string">&quot;users&quot;</span>, <span class="comment">// 自定义数据表名称</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个 Model 就可以在 Controller 和 Service 中通过 <code>app.model.User</code> 或者 <code>ctx.model.User</code> 访问到了，例如我们编写 <code>app/controller/users.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/users.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Controller</span> = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>).<span class="property">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toInt</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> str === <span class="string">&quot;number&quot;</span>) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">if</span> (!str) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">parseInt</span>(str, <span class="number">10</span>) || <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> query = &#123;</span><br><span class="line">      <span class="attr">limit</span>: <span class="title function_">toInt</span>(ctx.<span class="property">query</span>.<span class="property">limit</span>),</span><br><span class="line">      <span class="attr">offset</span>: <span class="title function_">toInt</span>(ctx.<span class="property">query</span>.<span class="property">offset</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findAll</span>(query);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123; name, age &#125;);</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">201</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">update</span>(&#123; name, age &#125;);</span><br><span class="line">    ctx.<span class="property">body</span> = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">destroy</span>();</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">UserController</span>;</span><br></pre></td></tr></table></figure>

<p>最后我们将这个 controller 挂载到路由上：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">  router.<span class="title function_">resources</span>(<span class="string">&quot;users&quot;</span>, <span class="string">&quot;/users&quot;</span>, controller.<span class="property">users</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>针对 <code>users</code> 表的 CURD 操作的接口就开发完了</p>
<h3 id="模型其他参数"><a href="#模型其他参数" class="headerlink" title="模型其他参数"></a>模型其他参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置（重要）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">  <span class="string">&quot;user&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">    <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 自定义表名</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">tableName</span>: <span class="string">&quot;xyz_users&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否需要增加createdAt、updatedAt、deletedAt字段</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不需要createdAt字段</span></span><br><span class="line">    <span class="attr">createdAt</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将updatedAt字段改个名</span></span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;utime&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将deletedAt字段改名</span></span><br><span class="line">    <span class="comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span></span><br><span class="line">    <span class="attr">deletedAt</span>: <span class="string">&quot;dtime&quot;</span>,</span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="sequelize-命令"><a href="#sequelize-命令" class="headerlink" title="sequelize 命令"></a>sequelize 命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>sequelize db:migrate</td>
<td>运行迁移文件</td>
</tr>
<tr>
<td>sequelize db:migrate:status</td>
<td>列出所有迁移的状态</td>
</tr>
<tr>
<td>sequelize db:migrate:undo</td>
<td>隔离数据库：迁移：撤消</td>
</tr>
<tr>
<td>sequelize db:migrate:undo:all</td>
<td>还原所有运行的迁移</td>
</tr>
<tr>
<td>sequelize db:create</td>
<td>创建由配置指定的数据库</td>
</tr>
<tr>
<td>sequelize db:drop</td>
<td>删除由配置指定的数据库</td>
</tr>
</tbody></table>
<h3 id="外键约束（重要）"><a href="#外键约束（重要）" class="headerlink" title="外键约束（重要）"></a>外键约束（重要）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 迁移文件</span></span><br><span class="line">queryInterface.<span class="title function_">addConstraint</span>(<span class="string">&quot;tableName&quot;</span>, [<span class="string">&quot;user_id&quot;</span>], &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;foreign key&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;user_id&quot;</span>,</span><br><span class="line">  <span class="attr">references</span>: &#123;</span><br><span class="line">    <span class="comment">//Required field</span></span><br><span class="line">    <span class="attr">table</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">    <span class="attr">field</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">  <span class="attr">onUpdate</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="创建第一个种子"><a href="#创建第一个种子" class="headerlink" title="创建第一个种子"></a>创建第一个种子</h3><p>假设我们希望在默认情况下将一些数据插入到几个表中. 如果我们跟进前面的例子,我们可以考虑为 <code>User</code> 表创建演示用户.</p>
<p>要管理所有数据迁移,你可以使用 <code>seeders</code>. 种子文件是数据的一些变化,可用于使用样本数据或测试数据填充数据库表.</p>
<p>让我们创建一个种子文件,它会将一个演示用户添加到我们的 <code>User</code> 表中.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize seed:generate --name demo-user</span><br></pre></td></tr></table></figure>

<p>这个命令将会在 <code>seeders</code> 文件夹中创建一个种子文件.文件名看起来像是 <code>XXXXXXXXXXXXXX-demo-user.js</code>,它遵循相同的 <code>up/down</code> 语义,如迁移文件.</p>
<p>现在我们应该编辑这个文件,将演示用户插入<code>User</code>表.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">bulkInsert</span>(</span><br><span class="line">      <span class="string">&quot;Users&quot;</span>,</span><br><span class="line">      [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">firstName</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">          <span class="attr">lastName</span>: <span class="string">&quot;Doe&quot;</span>,</span><br><span class="line">          <span class="attr">email</span>: <span class="string">&quot;demo@demo.com&quot;</span>,</span><br><span class="line">          <span class="attr">createdAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">          <span class="attr">updatedAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">      &#123;&#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">bulkDelete</span>(<span class="string">&quot;Users&quot;</span>, <span class="literal">null</span>, &#123;&#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="运行种子"><a href="#运行种子" class="headerlink" title="运行种子"></a>运行种子</h3><p>在上一步中,你创建了一个种子文件. 但它还没有保存到数据库. 为此,我们需要运行一个简单的命令.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:all</span><br></pre></td></tr></table></figure>

<p>这将执行该种子文件,你将有一个演示用户插入 <code>User</code> 表.</p>
<p><strong>注意:</strong> _ <em><code>\_seeders_</code></em> 执行不会存储在任何使用 <em><code>_SequelizeMeta_</code></em> 表的迁移的地方. 如果你想覆盖这个,请阅读 <em><code>_存储_</code></em> 部分_</p>
<h3 id="撤销种子"><a href="#撤销种子" class="headerlink" title="撤销种子"></a>撤销种子</h3><p>Seeders 如果使用了任何存储那么就可以被撤消. 有两个可用的命令</p>
<p>如果你想撤消最近的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo</span><br></pre></td></tr></table></figure>

<p>如果你想撤消特定的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo --seed name-of-seed-as-in-data</span><br></pre></td></tr></table></figure>

<p>如果你想撤消所有的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo:all</span><br></pre></td></tr></table></figure>

<h2 id="关联操作"><a href="#关联操作" class="headerlink" title="关联操作"></a>关联操作</h2><h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>模型层：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个用户对应一个用户资料</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app/model/user.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;user&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">    <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联用户资料 一对一</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">hasOne</span>(app.<span class="property">model</span>.<span class="property">Userinfo</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/model/userinfo.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line">  <span class="keyword">const</span> userinfo = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">    <span class="string">&quot;userinfo&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">nickname</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">user_id</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 关联用户表</span></span><br><span class="line">  userinfo.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    app.<span class="property">model</span>.<span class="property">Userinfo</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> userinfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制器调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/users.js</span></span><br><span class="line"><span class="comment">// 显示单条</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根据主键查询 查询一条用findOne</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="comment">// 主表查询字段限制</span></span><br><span class="line">        <span class="attr">attributes</span>:[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">        <span class="comment">// 关联查询</span></span><br><span class="line">        <span class="attr">include</span>: [&#123;</span><br><span class="line">            <span class="comment">// 需要查询的模型</span></span><br><span class="line">            <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">Userinfo</span>,</span><br><span class="line">            <span class="comment">// 副表查询的字段</span></span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;nickname&#x27;</span>]</span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="comment">// 主表条件</span></span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">City</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">City</span>.<span class="title function_">init</span>(&#123; <span class="attr">countryCode</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;city&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Country</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Country</span>.<span class="title function_">init</span>(</span><br><span class="line">  &#123; <span class="attr">isoCode</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;,</span><br><span class="line">  &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;country&quot;</span> &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里,我们可以根据国家代码连接国家和城市</span></span><br><span class="line"><span class="title class_">Country</span>.<span class="title function_">hasMany</span>(<span class="title class_">City</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;countryCode&quot;</span>, <span class="attr">sourceKey</span>: <span class="string">&quot;isoCode&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">City</span>.<span class="title function_">belongsTo</span>(<span class="title class_">Country</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;countryCode&quot;</span>, <span class="attr">targetKey</span>: <span class="string">&quot;isoCode&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">belongsToMany</span>(<span class="title class_">Project</span>, &#123;</span><br><span class="line">  <span class="attr">as</span>: <span class="string">&quot;Tasks&quot;</span>,</span><br><span class="line">  <span class="attr">through</span>: <span class="string">&quot;worker_tasks&quot;</span>,</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;userId&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">belongsToMany</span>(<span class="title class_">User</span>, &#123;</span><br><span class="line">  <span class="attr">as</span>: <span class="string">&quot;Workers&quot;</span>,</span><br><span class="line">  <span class="attr">through</span>: <span class="string">&quot;worker_tasks&quot;</span>,</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;projectId&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="关联常用操作"><a href="#关联常用操作" class="headerlink" title="关联常用操作"></a>关联常用操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取关联模型对象，n对一不需要加s</span></span><br><span class="line"><span class="keyword">let</span> userinfo = <span class="keyword">await</span> user.<span class="title function_">getUserinfo</span>();</span><br><span class="line"><span class="comment">// n对多需要加s</span></span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;title&quot;</span>],</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 关联操作</span></span><br><span class="line"><span class="comment">// 1：用户创建文章（一对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&quot;第一篇文章&quot;</span>,</span><br><span class="line">  <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.获取当前用户所有文章</span></span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>();</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;id&quot;</span>],</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;测试&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3：用户删除文章（一对多）</span></span><br><span class="line"><span class="comment">// (1) 获取当前用户的所有文章</span></span><br><span class="line"><span class="keyword">let</span> posts = <span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;id&quot;</span>],</span><br><span class="line">&#125;);</span><br><span class="line">posts = posts.<span class="title function_">map</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="property">id</span>);</span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: posts,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景三：用户关注话题（多对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">bulkCreate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户关注话题（多对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="获取器和修改器"><a href="#获取器和修改器" class="headerlink" title="获取器和修改器"></a>获取器和修改器</h2><p>模型层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/model/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;user&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">      <span class="comment">// 单独字段的getter，查询时都会调用</span></span><br><span class="line">      <span class="comment">// this.getDataValue(&#x27;name&#x27;) 获取原始值</span></span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> age = <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;name&quot;</span>) + <span class="string">&quot;年龄：&quot;</span> + age;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="comment">// 单独字段的setter，新增和更新时调用</span></span><br><span class="line">      <span class="comment">// this.setDataValue(&#x27;name&#x27;) 设置原始值</span></span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setDataValue</span>(<span class="string">&quot;age&quot;</span>, val * <span class="number">10</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联用户资料</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">hasOne</span>(app.<span class="property">model</span>.<span class="property">Userinfo</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制器层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根据主键查询</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 获取原始值 user.getDataValue(&#x27;name&#x27;)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = user.<span class="title function_">getDataValue</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="模型钩子"><a href="#模型钩子" class="headerlink" title="模型钩子"></a>模型钩子</h2><p>模型层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 钩子</span></span><br><span class="line">    <span class="comment">// 查询前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeFind</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 查询后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterFind</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 新增前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeCreate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新增前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 新增后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterCreate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新增后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 修改前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeUpdate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;修改前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 修改后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterUpdate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;修改后&#x27;</span>); <span class="comment">// 真正修改才会触发，数据相同不会触发</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 删除前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 删除后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量删除前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeBulkDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;批量删除前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 批量删除后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterBulkDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;批量删除后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="主键查询"><a href="#主键查询" class="headerlink" title="主键查询"></a>主键查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findByPk</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="查找不存在则创建"><a href="#查找不存在则创建" class="headerlink" title="查找不存在则创建"></a>查找不存在则创建</h3><p>方法 <code>findOrCreate</code> 可用于检查数据库中是否已存在某个元素. 如果是这种情况,则该方法将生成相应的实例. 如果元素不存在,将会被创建.</p>
<p>如果是这种情况,则该方法将导致相应的实例. 如果元素不存在,将会被创建.</p>
<p>假设我们有一个空的数据库,一个 <code>User</code> 模型有一个 <code>username</code> 和 <code>job</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findOrCreate</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&quot;sdepold&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">defaults</span>: &#123;</span><br><span class="line">    <span class="attr">job</span>: <span class="string">&quot;Technical Lead JavaScript&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">[user, created]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    user.<span class="title function_">get</span>(&#123;</span><br><span class="line">      <span class="attr">plain</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(created);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    findOrCreate 返回一个包含已找到或创建的对象的数组,找到或创建的对象和一个布尔值,如果创建一个新对象将为true,否则为false,像这样:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [ &#123;</span></span><br><span class="line"><span class="comment">        username: &#x27;sdepold&#x27;,</span></span><br><span class="line"><span class="comment">        job: &#x27;Technical Lead JavaScript&#x27;,</span></span><br><span class="line"><span class="comment">        id: 1,</span></span><br><span class="line"><span class="comment">        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),</span></span><br><span class="line"><span class="comment">        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      true ]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">在上面的例子中,第三行的数组将分成2部分,并将它们作为参数传递给回调函数,在这种情况下将它们视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;true&quot;.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码创建了一个新的实例. 所以当我们已经有一个实例了 …</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">create</span>(&#123; <span class="attr">username</span>: <span class="string">&quot;fnord&quot;</span>, <span class="attr">job</span>: <span class="string">&quot;omnomnom&quot;</span> &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">findOrCreate</span>(&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;fnord&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">defaults</span>: &#123;</span><br><span class="line">        <span class="attr">job</span>: <span class="string">&quot;something else&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">[user, created]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">      user.<span class="title function_">get</span>(&#123;</span><br><span class="line">        <span class="attr">plain</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(created);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在这个例子中,findOrCreate 返回一个如下的数组:</span></span><br><span class="line"><span class="comment">    [ &#123;</span></span><br><span class="line"><span class="comment">        username: &#x27;fnord&#x27;,</span></span><br><span class="line"><span class="comment">        job: &#x27;omnomnom&#x27;,</span></span><br><span class="line"><span class="comment">        id: 2,</span></span><br><span class="line"><span class="comment">        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),</span></span><br><span class="line"><span class="comment">        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      false</span></span><br><span class="line"><span class="comment">    ]</span></span><br><span class="line"><span class="comment">    由findOrCreate返回的数组通过第三行的数组扩展为两部分,并且这些部分将作为2个参数传递给回调函数,在这种情况下将其视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;false&quot;.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>…现有条目将不会更改. 看到第二个用户的 “job”,并且实际上创建操作是假的.</p>
<h3 id="查找并计数"><a href="#查找并计数" class="headerlink" title="查找并计数"></a>查找并计数</h3><p><code>findAndCountAll</code> - 在数据库中搜索多个元素,返回数据和总计数</p>
<p>这是一个方便的方法,它结合了 <code>findAll</code> 和 <code>count</code>(见下文),当处理与分页相关的查询时,这是有用的,你想用 <code>limit</code> 和 <code>offset</code> 检索数据,但也需要知道总数与查询匹配的记录数:</p>
<p>处理程序成功将始终接收具有两个属性的对象:</p>
<ul>
<li><code>count</code> - 一个整数,总数记录匹配 where 语句和关联的其它过滤器</li>
<li><code>rows</code> - 一个数组对象,记录在 limit 和 offset 范围内匹配 where 语句和关联的其它过滤器,</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;foo%&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">offset</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">count</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">rows</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>它支持 include. 只有标记为 <code>required</code> 的 include 将被添加到计数部分:</p>
<p>假设你想查找附有个人资料的所有用户:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Profile</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;],</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">3</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>因为 <code>Profile</code> 的 include 有 <code>required</code> 设置,这将导致内部连接,并且只有具有 profile 的用户将被计数. 如果我们从 include 中删除<code>required</code>,那么有和没有 profile 的用户都将被计数. 在 include 中添加一个 <code>where</code> 语句会自动使它成为 required:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Profile</span>, <span class="attr">where</span>: &#123; <span class="attr">active</span>: <span class="literal">true</span> &#125; &#125;],</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">3</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的查询只会对具有 active profile 的用户进行计数,因为在将 where 语句添加到 include 时,<code>required</code> 被隐式设置为 true.</p>
<p>传递给 <code>findAndCountAll</code> 的 options 对象与 <code>findAll</code> 相同(如下所述).</p>
<h3 id="查询多个（常用）"><a href="#查询多个（常用）" class="headerlink" title="查询多个（常用）"></a>查询多个（常用）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到多个条目</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects 将是所有 Project 实例的数组</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索特定属性 - 使用哈希</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;A Project&quot;</span> &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects将是一个具有指定 name 的 Project 实例数组</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在特定范围内进行搜索</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects将是一系列具有 id 1,2 或 3 的项目</span></span><br><span class="line">  <span class="comment">// 这实际上是在做一个 IN 查询</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">and</span>]: &#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, <span class="comment">// 且 (a = 5)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">a</span>: <span class="number">6</span> &#125;], <span class="comment">// (a = 5 或 a = 6)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">6</span>, <span class="comment">// id &gt; 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gte</span>]: <span class="number">6</span>, <span class="comment">// id &gt;= 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">10</span>, <span class="comment">// id &lt; 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lte</span>]: <span class="number">10</span>, <span class="comment">// id &lt;= 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="number">20</span>, <span class="comment">// id != 20</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">between</span>]: [<span class="number">6</span>, <span class="number">10</span>], <span class="comment">// 在 6 和 10 之间</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notBetween</span>]: [<span class="number">11</span>, <span class="number">15</span>], <span class="comment">// 不在 11 和 15 之间</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">in</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// 在 [1, 2] 之中</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notIn</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// 不在 [1, 2] 之中</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 包含 &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notLike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 不包含 &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 包含 &#x27;%hat&#x27; (不区分大小写)  (仅限 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notILike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 不包含 &#x27;%hat&#x27;  (仅限 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// @&gt; [1, 2] (PG数组包含运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="number">2</span>, <span class="number">3</span>], <span class="comment">// 任何数组[2, 3]::INTEGER (仅限 PG)</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">status</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">not</span>]: <span class="literal">false</span>, <span class="comment">// status 不为 FALSE</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="复合过滤-x2F-OR-x2F-NOT-查询"><a href="#复合过滤-x2F-OR-x2F-NOT-查询" class="headerlink" title="复合过滤 &#x2F; OR &#x2F; NOT 查询"></a>复合过滤 &#x2F; OR &#x2F; NOT 查询</h3><p>你可以使用多层嵌套的 AND,OR 和 NOT 条件进行一个复合的 where 查询. 为了做到这一点,你可以使用 <code>or</code> , <code>and</code> 或 <code>not</code> <code>运算符</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;, &#123; <span class="attr">id</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">10</span> &#125; &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">10</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这两段代码将生成以下内容:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> *</span><br><span class="line"><span class="variable constant_">FROM</span> <span class="string">`Projects`</span></span><br><span class="line"><span class="variable constant_">WHERE</span> (</span><br><span class="line">  <span class="string">`Projects`</span>.<span class="string">`name`</span> = <span class="string">&#x27;a project&#x27;</span></span><br><span class="line">   <span class="variable constant_">AND</span> (<span class="string">`Projects`</span>.<span class="string">`id`</span> <span class="variable constant_">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>) <span class="variable constant_">OR</span> <span class="string">`Projects`</span>.<span class="string">`id`</span> &gt; <span class="number">10</span>)</span><br><span class="line">)</span><br><span class="line"><span class="variable constant_">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><code>not</code> 示例:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">not</span>]: [&#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;, &#123; <span class="attr">array</span>: &#123; [<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] &#125; &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将生成:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> *</span><br><span class="line"><span class="variable constant_">FROM</span> <span class="string">`Projects`</span></span><br><span class="line"><span class="variable constant_">WHERE</span> (</span><br><span class="line">  <span class="string">`Projects`</span>.<span class="string">`name`</span> = <span class="string">&#x27;a project&#x27;</span></span><br><span class="line">   <span class="variable constant_">AND</span> <span class="variable constant_">NOT</span> (<span class="string">`Projects`</span>.<span class="string">`id`</span> <span class="variable constant_">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>) <span class="variable constant_">OR</span> <span class="string">`Projects`</span>.<span class="string">`array`</span> @&gt; <span class="variable constant_">ARRAY</span>[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]::<span class="variable constant_">INTEGER</span>[])</span><br><span class="line">)</span><br><span class="line"><span class="variable constant_">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="用限制-偏移-顺序和分组操作数据集"><a href="#用限制-偏移-顺序和分组操作数据集" class="headerlink" title="用限制,偏移,顺序和分组操作数据集"></a>用限制,偏移,顺序和分组操作数据集</h3><p>要获取更多相关数据,可以使用限制,偏移,顺序和分组:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限制查询的结果</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">limit</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过前10个元素</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过前10个元素,并获取2个</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">10</span>, <span class="attr">limit</span>: <span class="number">2</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>分组和排序的语法是相同的,所以下面只用一个单独的例子来解释分组,而其余的则是排序. 你下面看到的所有内容也可以对分组进行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">order</span>: [[<span class="string">&quot;title&quot;</span>, <span class="string">&quot;DESC&quot;</span>]] &#125;);</span><br><span class="line"><span class="comment">// 生成 ORDER BY title DESC</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">group</span>: <span class="string">&quot;name&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// 生成 GROUP BY name</span></span><br></pre></td></tr></table></figure>

<p>请注意,在上述两个示例中,提供的字符串逐字插入到查询中,所以不会转义列名称. 当你向 order &#x2F; group 提供字符串时,将始终如此. 如果要转义列名,你应该提供一个参数数组,即使你只想通过单个列进行 order &#x2F; group</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">something.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">order</span>: [</span><br><span class="line">    <span class="comment">// 将返回 `name`</span></span><br><span class="line">    [<span class="string">&quot;name&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 `username` DESC</span></span><br><span class="line">    [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;DESC&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 max(`age`)</span></span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&quot;max&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;age&quot;</span>)),</span><br><span class="line">    <span class="comment">// 将返回 max(`age`) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&quot;max&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;age&quot;</span>)), <span class="string">&quot;DESC&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 otherfunction(`col1`, 12, &#x27;lalala&#x27;) DESC</span></span><br><span class="line">    [</span><br><span class="line">      sequelize.<span class="title function_">fn</span>(<span class="string">&quot;otherfunction&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;col1&quot;</span>), <span class="number">12</span>, <span class="string">&quot;lalala&quot;</span>),</span><br><span class="line">      <span class="string">&quot;DESC&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// 将返回 otherfunction(awesomefunction(`col`)) DESC,这个嵌套是可以无限的！</span></span><br><span class="line">    [</span><br><span class="line">      sequelize.<span class="title function_">fn</span>(</span><br><span class="line">        <span class="string">&quot;otherfunction&quot;</span>,</span><br><span class="line">        sequelize.<span class="title function_">fn</span>(<span class="string">&quot;awesomefunction&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;col&quot;</span>))</span><br><span class="line">      ),</span><br><span class="line">      <span class="string">&quot;DESC&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>回顾一下,order &#x2F; group 数组的元素可以是以下内容:</p>
<ul>
<li>String - 将被引用</li>
<li>Array - 第一个元素将被引用,第二个将被逐字地追加</li>
<li>Object -<ul>
<li>raw 将被添加逐字引用</li>
<li>如果未设置 raw,一切都被忽略,查询将失败</li>
</ul>
</li>
<li>Sequelize.fn 和 Sequelize.col 返回函数和引用的列名</li>
</ul>
<h3 id="字段过滤"><a href="#字段过滤" class="headerlink" title="字段过滤"></a>字段过滤</h3><p>想要只选择某些属性,可以使用 <code>attributes</code> 选项. 通常是传递一个数组:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT foo, bar …</p>
</blockquote>
<p>属性可以使用嵌套数组来重命名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;foo&quot;</span>, [<span class="string">&quot;bar&quot;</span>, <span class="string">&quot;baz&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT foo, bar AS baz …</p>
</blockquote>
<p>也可以使用 <code>sequelize.fn</code> 来进行聚合:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [[sequelize.<span class="title function_">fn</span>(<span class="string">&quot;COUNT&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;hats&quot;</span>)), <span class="string">&quot;no_hats&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT COUNT(hats) AS no_hats …</p>
</blockquote>
<p>使用聚合功能时,必须给它一个别名,以便能够从模型中访问它. 在上面的例子中,你可以使用 <code>instance.get(&#39;no_hats&#39;)</code> 获得帽子数量.</p>
<p>有时,如果你只想添加聚合,则列出模型的所有属性可能令人厌烦:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is a tiresome way of getting the number of hats...</span></span><br><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>, <span class="string">&#x27;baz&#x27;</span>, <span class="string">&#x27;quz&#x27;</span>, [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;COUNT&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;hats&#x27;</span>)), <span class="string">&#x27;no_hats&#x27;</span>]]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is shorter, and less error prone because it still works if you add / remove attributes</span></span><br><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: &#123; <span class="attr">include</span>: [[sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;COUNT&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;hats&#x27;</span>)), <span class="string">&#x27;no_hats&#x27;</span>]] &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable constant_">SELECT</span> id, foo, bar, baz, quz, <span class="title function_">COUNT</span>(hats) <span class="variable constant_">AS</span> no_hats ...</span><br></pre></td></tr></table></figure>

<p>同样,它也可以排除一些指定的表字段:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: &#123; <span class="attr">exclude</span>: [<span class="string">&#x27;baz&#x27;</span>] &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable constant_">SELECT</span> id, foo, bar, quz ...</span><br></pre></td></tr></table></figure>

<h3 id="Where"><a href="#Where" class="headerlink" title="Where"></a>Where</h3><p>无论你是通过 findAll&#x2F;find 或批量 updates&#x2F;destroys 进行查询,都可以传递一个 <code>where</code> 对象来过滤查询.</p>
<p><code>where</code> 通常用 attribute:value 键值对获取一个对象,其中 value 可以是匹配等式的数据或其他运算符的键值对象.</p>
<p>也可以通过嵌套 <code>or</code> 和 <code>and</code> <code>运算符</code> 的集合来生成复杂的 AND&#x2F;OR 条件.</p>
<h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Op</span> = <span class="title class_">Sequelize</span>.<span class="property">Op</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 2</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;active&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 AND status = &#x27;active&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">authorId</span>: <span class="number">12</span> &#125;, &#123; <span class="attr">authorId</span>: <span class="number">13</span> &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [<span class="number">12</span>, <span class="number">13</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;inactive&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// DELETE FROM post WHERE status = &#x27;inactive&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">update</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">deletedAt</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// UPDATE post SET updatedAt = null WHERE deletedAt NOT NULL;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: sequelize.<span class="title function_">where</span>(</span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&quot;char_length&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;status&quot;</span>)),</span><br><span class="line">    <span class="number">6</span></span><br><span class="line">  ),</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE char_length(status) = 6;</span></span><br></pre></td></tr></table></figure>

<h4 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h4><p>Sequelize 可用于创建更复杂比较的符号运算符 -</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Op</span> = <span class="title class_">Sequelize</span>.<span class="property">Op</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">and</span>]: &#123;<span class="attr">a</span>: <span class="number">5</span>&#125;           <span class="comment">// 且 (a = 5)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123;<span class="attr">a</span>: <span class="number">5</span>&#125;, &#123;<span class="attr">a</span>: <span class="number">6</span>&#125;]  <span class="comment">// (a = 5 或 a = 6)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">6</span>,                <span class="comment">// id &gt; 6</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">gte</span>]: <span class="number">6</span>,               <span class="comment">// id &gt;= 6</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">10</span>,               <span class="comment">// id &lt; 10</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">lte</span>]: <span class="number">10</span>,              <span class="comment">// id &lt;= 10</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="number">20</span>,               <span class="comment">// id != 20</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">eq</span>]: <span class="number">3</span>,                <span class="comment">// = 3</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">not</span>]: <span class="literal">true</span>,            <span class="comment">// 不是 TRUE</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">between</span>]: [<span class="number">6</span>, <span class="number">10</span>],     <span class="comment">// 在 6 和 10 之间</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notBetween</span>]: [<span class="number">11</span>, <span class="number">15</span>], <span class="comment">// 不在 11 和 15 之间</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">in</span>]: [<span class="number">1</span>, <span class="number">2</span>],           <span class="comment">// 在 [1, 2] 之中</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notIn</span>]: [<span class="number">1</span>, <span class="number">2</span>],        <span class="comment">// 不在 [1, 2] 之中</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;%hat&#x27;</span>,         <span class="comment">// 包含 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notLike</span>]: <span class="string">&#x27;%hat&#x27;</span>       <span class="comment">// 不包含 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&#x27;%hat&#x27;</span>         <span class="comment">// 包含 &#x27;%hat&#x27; (不区分大小写)  (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notILike</span>]: <span class="string">&#x27;%hat&#x27;</span>      <span class="comment">// 不包含 &#x27;%hat&#x27;  (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">startsWith</span>]: <span class="string">&#x27;hat&#x27;</span>     <span class="comment">// 类似 &#x27;hat%&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">endsWith</span>]: <span class="string">&#x27;hat&#x27;</span>       <span class="comment">// 类似 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">substring</span>]: <span class="string">&#x27;hat&#x27;</span>      <span class="comment">// 类似 &#x27;%hat%&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">regexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>    <span class="comment">// 匹配正则表达式/~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span> <span class="comment">// 不匹配正则表达式/!~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">iRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>    <span class="comment">// ~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notIRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span> <span class="comment">// !~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">like</span>]: &#123; [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;hat&#x27;</span>]&#125; <span class="comment">// 包含任何数组[&#x27;cat&#x27;, &#x27;hat&#x27;] - 同样适用于 iLike 和 notLike</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>]       <span class="comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// @&gt; [1, 2] (PG数组包含运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>]     <span class="comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="number">2</span>,<span class="number">3</span>]            <span class="comment">// 任何数组[2, 3]::INTEGER (仅限PG)</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">col</span>]: <span class="string">&#x27;user.organization_id&#x27;</span> <span class="comment">// = &#x27;user&#x27;.&#x27;organization_id&#x27;, 使用数据库语言特定的列标识符, 本例使用 PG</span></span><br></pre></td></tr></table></figure>

<h4 id="范围选项"><a href="#范围选项" class="headerlink" title="范围选项"></a>范围选项</h4><p>所有操作符都支持支持的范围类型查询.</p>
<p>请记住,提供的范围值也可以<a target="_blank" rel="noopener" href="https://itfun.tv/documents/266#range-types">定义绑定的 inclusion&#x2F;exclusion</a>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有上述相等和不相等的操作符加上以下内容:</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: <span class="number">2</span>           <span class="comment">// @&gt; &#x27;2&#x27;::integer (PG range contains element operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// @&gt; [1, 2) (PG range contains range operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>]     <span class="comment">// &lt;@ [1, 2) (PG range is contained by operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>]       <span class="comment">// &amp;&amp; [1, 2) (PG range overlap (have points in common) operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">adjacent</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// -|- [1, 2) (PG range is adjacent to operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">strictLeft</span>]: [<span class="number">1</span>, <span class="number">2</span>]    <span class="comment">// &lt;&lt; [1, 2) (PG range strictly left of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">strictRight</span>]: [<span class="number">1</span>, <span class="number">2</span>]   <span class="comment">// &gt;&gt; [1, 2) (PG range strictly right of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">noExtendRight</span>]: [<span class="number">1</span>, <span class="number">2</span>] <span class="comment">// &amp;&lt; [1, 2) (PG range does not extend to the right of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">noExtendLeft</span>]: [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment">// &amp;&gt; [1, 2) (PG range does not extend to the left of operator)</span></span><br></pre></td></tr></table></figure>

<h4 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">rank</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">1000</span>,</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">eq</span>]: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// rank &lt; 1000 OR rank IS NULL</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">createdAt</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>() - <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// createdAt &lt; [timestamp] AND createdAt &gt; [timestamp]</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="title class_">Op</span>.<span class="property">or</span>]: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;Boat%&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">description</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;%boat%&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// title LIKE &#x27;Boat%&#x27; OR description LIKE &#x27;%boat%&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="关系-x2F-关联"><a href="#关系-x2F-关联" class="headerlink" title="关系 &#x2F; 关联"></a>关系 &#x2F; 关联</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到所有具有至少一个 task 的  project,其中 task.state === project.state</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Task</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">state</span>: <span class="title class_">Sequelize</span>.<span class="title function_">col</span>(<span class="string">&quot;project.state&quot;</span>) &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="分页-x2F-限制"><a href="#分页-x2F-限制" class="headerlink" title="分页 &#x2F; 限制"></a>分页 &#x2F; 限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取10个实例/行</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">limit</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过8个实例/行</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">8</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过5个实例,然后取5个</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">5</span>, <span class="attr">limit</span>: <span class="number">5</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p><code>order</code> 需要一个条目的数组来排序查询或者一个 sequelize 方法.一般来说,你将要使用任一属性的 tuple&#x2F;array,并确定排序的正反方向.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Subtask</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">order</span>: [</span><br><span class="line">    <span class="comment">// 将转义标题,并根据有效的方向参数列表验证DESC</span></span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按最大值排序(age)</span></span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按最大顺序(age) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)), <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按 otherfunction 排序(`col1`, 12, &#x27;lalala&#x27;) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;otherfunction&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;col1&#x27;</span>), <span class="number">12</span>, <span class="string">&#x27;lalala&#x27;</span>), <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将使用模型名称作为关联的名称排序关联模型的 created_at.</span></span><br><span class="line">    [<span class="title class_">Task</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order through an associated model&#x27;s created_at using the model names as the associations&#x27; names.</span></span><br><span class="line">    [<span class="title class_">Task</span>, <span class="title class_">Project</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将使用关联的名称由关联模型的created_at排序.</span></span><br><span class="line">    [<span class="string">&#x27;Task&#x27;</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by a nested associated model&#x27;s created_at using the names of the associations.</span></span><br><span class="line">    [<span class="string">&#x27;Task&#x27;</span>, <span class="string">&#x27;Project&#x27;</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by an associated model&#x27;s created_at using an association object. (优选方法)</span></span><br><span class="line">    [<span class="title class_">Subtask</span>.<span class="property">associations</span>.<span class="property">Task</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by a nested associated model&#x27;s created_at using association objects. (优选方法)</span></span><br><span class="line">    [<span class="title class_">Subtask</span>.<span class="property">associations</span>.<span class="property">Task</span>, <span class="title class_">Task</span>.<span class="property">associations</span>.<span class="property">Project</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by an associated model&#x27;s created_at using a simple association object.</span></span><br><span class="line">    [&#123;<span class="attr">model</span>: <span class="title class_">Task</span>, <span class="attr">as</span>: <span class="string">&#x27;Task&#x27;</span>&#125;, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 嵌套关联模型的 created_at 简单关联对象排序</span></span><br><span class="line">    [&#123;<span class="attr">model</span>: <span class="title class_">Task</span>, <span class="attr">as</span>: <span class="string">&#x27;Task&#x27;</span>&#125;, &#123;<span class="attr">model</span>: <span class="title class_">Project</span>, <span class="attr">as</span>: <span class="string">&#x27;Project&#x27;</span>&#125;, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将按年龄最大值降序排列</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">literal</span>(<span class="string">&#x27;max(age) DESC&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按最年龄大值升序排列,当省略排序条件时默认是升序排列</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按升序排列是省略排序条件的默认顺序</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将根据方言随机排序 (而不是 fn(&#x27;RAND&#x27;) 或 fn(&#x27;RANDOM&#x27;))</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">random</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="count-计算数据库中元素的出现次数"><a href="#count-计算数据库中元素的出现次数" class="headerlink" title="count - 计算数据库中元素的出现次数"></a><code>count</code> - 计算数据库中元素的出现次数</h3><p>还有一种数据库对象计数的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">count</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;There are &quot;</span> + c + <span class="string">&quot; projects!&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">count</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">25</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;There are &quot;</span> + c + <span class="string">&quot; projects with an id greater than 25.&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="max-获取特定表中特定属性的最大值"><a href="#max-获取特定表中特定属性的最大值" class="headerlink" title="max - 获取特定表中特定属性的最大值"></a><code>max</code> - 获取特定表中特定属性的最大值</h3><p>这里是获取属性的最大值的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">max</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">max</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 40</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">max</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">20</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">max</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 10</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="min-获取特定表中特定属性的最小值"><a href="#min-获取特定表中特定属性的最小值" class="headerlink" title="min - 获取特定表中特定属性的最小值"></a><code>min</code> - 获取特定表中特定属性的最小值</h3><p>这里是获取属性的最小值的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">min</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">min</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 5</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">min</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">5</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">min</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 10</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="sum-特定属性的值求和"><a href="#sum-特定属性的值求和" class="headerlink" title="sum - 特定属性的值求和"></a><code>sum</code> - 特定属性的值求和</h3><p>为了计算表的特定列的总和,可以使用“sum”方法.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">sum</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">sum</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 55</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">sum</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">5</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">sum</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 50</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="预加载"><a href="#预加载" class="headerlink" title="预加载"></a>预加载</h2><p>当你从数据库检索数据时,也想同时获得与之相关联的查询,这被称为预加载.这个基本思路就是当你调用 <code>find</code> 或 <code>findAll</code> 时使用 <code>include</code> 属性.让我们假设以下设置:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;user&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Task</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;task&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Tool</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;tool&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Task</span>.<span class="title function_">belongsTo</span>(<span class="title class_">User</span>);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Task</span>);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Tool</span>, &#123; <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">sequelize.<span class="title function_">sync</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这是我们继续的地方 ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>首先,让我们用它们的关联 user 加载所有的 task.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Task</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">User</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">tasks</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(tasks));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;A Task&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;</span></span><br><span class="line"><span class="comment">      &#125;</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请注意,访问者(结果实例中的 <code>User</code> 属性)是单数形式,因为关联是一对一的.</p>
<p>接下来的事情:用多对一的关联加载数据！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Task</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;tasks&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;A Task&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请注意,访问者(结果实例中的 <code>Tasks</code> 属性)是复数形式,因为关联是多对一的.</p>
<p>如果关联是别名的(使用 <code>as</code> 参数),则在包含模型时必须指定此别名. 注意用户的 <code>Tool</code> 如何被别名为 <code>Instruments</code>. 为了获得正确的权限,你必须指定要加载的模型以及别名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Tool</span>, <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span> &#125;] &#125;).<span class="title function_">then</span>(</span><br><span class="line">  <span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>你还可以通过指定与关联别名匹配的字符串来包含别名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="string">&quot;Instruments&quot;</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">association</span>: <span class="string">&quot;Instruments&quot;</span> &#125;] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当预加载时,我们也可以使用 <code>where</code> 过滤关联的模型. 这将返回 <code>Tool</code> 模型中所有与 <code>where</code> 语句匹配的行的<code>User</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">name</span>: &#123; [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%ooth%&quot;</span> &#125; &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Smith&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 2,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当使用 <code>include.where</code> 过滤一个预加载的模型时,<code>include.required</code> 被隐式设置为 <code>true</code>. 这意味着内部联接完成返回具有任何匹配子项的父模型.</p>
<h3 id="使用预加载模型的顶层-WHERE"><a href="#使用预加载模型的顶层-WHERE" class="headerlink" title="使用预加载模型的顶层 WHERE"></a>使用预加载模型的顶层 WHERE</h3><p>将模型的 <code>WHERE</code> 条件从 <code>ON</code> 条件的 include 模式移动到顶层,你可以使用 <code>&#39;$nested.column$&#39;</code> 语法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;$Instruments.name$&#x27;</span>: &#123; [<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&#x27;%ooth%&#x27;</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">        <span class="attr">as</span>: <span class="string">&#x27;Instruments&#x27;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Smith&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 2,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment">    */</span></span><br></pre></td></tr></table></figure>

<h3 id="包括所有"><a href="#包括所有" class="headerlink" title="包括所有"></a>包括所有</h3><p>要包含所有属性,你可以使用 <code>all:true</code> 传递单个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">all</span>: <span class="literal">true</span> &#125;] &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="包括软删除的记录"><a href="#包括软删除的记录" class="headerlink" title="包括软删除的记录"></a>包括软删除的记录</h3><p>如果想要加载软删除的记录,可以通过将 <code>include.paranoid</code> 设置为 <code>false</code> 来实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">name</span>: &#123; [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%ooth%&quot;</span> &#125; &#125;,</span><br><span class="line">      <span class="attr">paranoid</span>: <span class="literal">false</span>, <span class="comment">// query and loads the soft deleted records</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="排序预加载关联"><a href="#排序预加载关联" class="headerlink" title="排序预加载关联"></a>排序预加载关联</h3><p>在一对多关系的情况下.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Division</span>], <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="string">&quot;name&quot;</span>]] &#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Division</span>], <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;DESC&quot;</span>]] &#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;DESC&quot;</span>]],</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">include</span>: [<span class="title class_">Department</span>] &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="title class_">Department</span>, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在多对多关系的情况下,你还可以通过表中的属性进行排序.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">include</span>: [<span class="title class_">Department</span>] &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="title class_">DepartmentDivision</span>, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="嵌套预加载"><a href="#嵌套预加载" class="headerlink" title="嵌套预加载"></a>嵌套预加载</h3><p>你可以使用嵌套的预加载来加载相关模型的所有相关模型:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="title class_">Teacher</span>,</span><br><span class="line">          <span class="attr">include</span>: [</span><br><span class="line">            <span class="comment">/* etc */</span></span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123; // 1:M and N:M association</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;Teacher&quot;: &#123; // 1:1 association</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Jimi Hendrix&quot;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这将产生一个外连接. 但是,相关模型上的 <code>where</code> 语句将创建一个内部连接,并仅返回具有匹配子模型的实例. 要返回所有父实例,你应该添加 <code>required: false</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="title class_">Teacher</span>,</span><br><span class="line">          <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">school</span>: <span class="string">&quot;Woodstock Music School&quot;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">required</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上查询将返回所有用户及其所有乐器,但只会返回与 <code>Woodstock Music School</code> 相关的老师.</p>
<p>包括所有也支持嵌套加载:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">all</span>: <span class="literal">true</span>, <span class="attr">nested</span>: <span class="literal">true</span> &#125;] &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h2><h3 id="字段限制"><a href="#字段限制" class="headerlink" title="字段限制"></a>字段限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(</span><br><span class="line">  &#123; <span class="attr">username</span>: <span class="string">&quot;barfooz&quot;</span>, <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">fields</span>: [<span class="string">&quot;username&quot;</span>] &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 只有username有效</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">bulkCreate</span>([&#123; <span class="attr">username</span>: <span class="string">&quot;foo&quot;</span> &#125;, &#123; <span class="attr">username</span>: <span class="string">&quot;bar&quot;</span>, <span class="attr">admin</span>: <span class="literal">true</span> &#125;], &#123;</span><br><span class="line">  <span class="attr">fields</span>: [<span class="string">&quot;username&quot;</span>],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// admin 将不会被构建</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="新增单个"><a href="#新增单个" class="headerlink" title="新增单个"></a>新增单个</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;哈哈哈&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">12</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量新增"><a href="#批量新增" class="headerlink" title="批量新增"></a>批量新增</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量新增 bulkCreate</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">bulkCreate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第一个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第二个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第三个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><h3 id="字段限制-1"><a href="#字段限制-1" class="headerlink" title="字段限制"></a>字段限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task.<span class="property">title</span> = <span class="string">&quot;foooo&quot;</span>;</span><br><span class="line">task.<span class="property">description</span> = <span class="string">&quot;baaaaaar&quot;</span>;</span><br><span class="line"><span class="keyword">await</span> task.<span class="title function_">save</span>(&#123; <span class="attr">fields</span>: [<span class="string">&quot;title&quot;</span>] &#125;);</span><br><span class="line"><span class="comment">// title 现在将是 “foooo”,而 description 与以前一样</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用等效的 update 调用如下所示:</span></span><br><span class="line"><span class="keyword">await</span> task.<span class="title function_">update</span>(</span><br><span class="line">  &#123; <span class="attr">title</span>: <span class="string">&quot;foooo&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;baaaaaar&quot;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">fields</span>: [<span class="string">&quot;title&quot;</span>] &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">//  title 现在将是 “foooo”,而 description 与以前一样</span></span><br></pre></td></tr></table></figure>

<h3 id="单个修改"><a href="#单个修改" class="headerlink" title="单个修改"></a>单个修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">update</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;我被修改了&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">30</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量修改"><a href="#批量修改" class="headerlink" title="批量修改"></a>批量修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量修改</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">update</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;批量修改&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 条件</span></span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;第一个&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="递增"><a href="#递增" class="headerlink" title="递增"></a>递增</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录 increment</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> user.<span class="title function_">increment</span>(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">3</span>, <span class="comment">// age每次递增3</span></span><br><span class="line">  <span class="attr">other</span>: <span class="number">2</span>, <span class="comment">// other每次递增2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="递减"><a href="#递减" class="headerlink" title="递减"></a>递减</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录 decrement</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> user.<span class="title function_">decrement</span>(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">3</span>, <span class="comment">// age每次递减3</span></span><br><span class="line">  <span class="attr">other</span>: <span class="number">2</span>, <span class="comment">// other每次递减2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><h3 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h3><p>模型中配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置（重要）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">  <span class="string">&quot;user&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* bla */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="查询包括软删除内容"><a href="#查询包括软删除内容" class="headerlink" title="查询包括软删除内容"></a>查询包括软删除内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: &#123;</span><br><span class="line">    <span class="attr">model</span>: ctx.<span class="property">model</span>.<span class="property">Video</span>,</span><br><span class="line">    <span class="comment">// 包括软删除</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">33</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 包括软删除</span></span><br><span class="line">  <span class="attr">paranoid</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="彻底删除"><a href="#彻底删除" class="headerlink" title="彻底删除"></a>彻底删除</h3><p>如果 <code>paranoid</code> 选项为 true,则不会删除该对象,而将 <code>deletedAt</code> 列设置为当前时间戳. 要强制删除,可以将 <code>force: true</code> 传递给 destroy 调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task.<span class="title function_">destroy</span>(&#123; <span class="attr">force</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>在 <code>paranoid</code> 模式下对象被软删除后,在强制删除旧实例之前,你将无法使用相同的主键创建新实例.</p>
<h3 id="恢复软删除的实例"><a href="#恢复软删除的实例" class="headerlink" title="恢复软删除的实例"></a>恢复软删除的实例</h3><p>如果你使用 <code>paranoid:true</code> 软删除了模型的实例,之后想要撤消删除,请使用 <code>restore</code> 方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行软删除...</span></span><br><span class="line">task.<span class="title function_">destroy</span>();</span><br><span class="line"><span class="comment">// 恢复软删除...</span></span><br><span class="line">task.<span class="title function_">restore</span>();</span><br></pre></td></tr></table></figure>

<h3 id="条件删除"><a href="#条件删除" class="headerlink" title="条件删除"></a>条件删除</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;批量修改&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: posts,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="重载实例"><a href="#重载实例" class="headerlink" title="重载实例"></a>重载实例</h2><p>如果你需要让你的实例同步,你可以使用 <code>reload</code> 方法. 它将从数据库中获取当前数据,并覆盖调用该方法的模型的属性.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Person</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;john&quot;</span> &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">person</span>) =&gt;</span> &#123;</span><br><span class="line">  person.<span class="property">name</span> = <span class="string">&quot;jane&quot;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>); <span class="comment">// &#x27;jane&#x27;</span></span><br><span class="line"></span><br><span class="line">  person.<span class="title function_">reload</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>); <span class="comment">// &#x27;john&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="模型自定义方法"><a href="#模型自定义方法" class="headerlink" title="模型自定义方法"></a>模型自定义方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型</span></span><br><span class="line"><span class="comment">// 模型自定义方法</span></span><br><span class="line">topic_user.<span class="property">ceshi</span> = <span class="function">(<span class="params">param</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;模型自定义方法&quot;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(param);</span><br><span class="line">  <span class="keyword">return</span> param;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制器</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">ceshi</span>(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Scopes-作用域（重点）"><a href="#Scopes-作用域（重点）" class="headerlink" title="Scopes - 作用域（重点）"></a>Scopes - 作用域（重点）</h2><p>作用域允许你定义常用查询,以便以后轻松使用. 作用域可以包括与常规查找器 <code>where</code>, <code>include</code>, <code>limit</code> 等所有相同的属性.</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>作用域在模型定义中定义,可以是 finder 对象或返回 finder 对象的函数,除了默认作用域,该作用域只能是一个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Project</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">  <span class="comment">// 属性</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">defaultScope</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scopes</span>: &#123;</span><br><span class="line">    <span class="attr">deleted</span>: &#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">deleted</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">activeUsers</span>: &#123;</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123; <span class="attr">model</span>: <span class="title class_">User</span>, <span class="attr">where</span>: &#123; <span class="attr">active</span>: <span class="literal">true</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    random () &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">          <span class="attr">someNumber</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    accessLevel (value) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">          <span class="attr">accessLevel</span>: &#123;</span><br><span class="line">            [<span class="title class_">Op</span>.<span class="property">gte</span>]: value</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sequelize,</span><br><span class="line">    <span class="attr">modelName</span>: <span class="string">&#x27;project&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过调用 <code>addScope</code> 定义模型后,还可以添加作用域. 这对于具有包含的作用域特别有用,其中在定义其他模型时可能不会定义 include 中的模型.</p>
<p>始终应用默认作用域. 这意味着,通过上面的模型定义,<code>Project.findAll()</code> 将创建以下查询:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> active = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>可以通过调用 <code>.unscoped()</code>, <code>.scope(null)</code> 或通过调用另一个作用域来删除默认作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>(); <span class="comment">// 删除默认作用域</span></span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> deleted = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>还可以在作用域定义中包含作用域模型. 这让你避免重复 <code>include</code>,<code>attributes</code> 或 <code>where</code> 定义.</p>
<p>使用上面的例子,并在包含的用户模型中调用 <code>active</code> 作用域(而不是直接在该 include 对象中指定条件):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">activeUsers</span>: &#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">User</span>.<span class="title function_">scope</span>(<span class="string">&quot;active&quot;</span>) &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>通过在模型定义上调用 <code>.scope</code> 来应用作用域,传递一个或多个作用域的名称. <code>.scope</code> 返回一个全功能的模型实例,它具有所有常规的方法:<code>.findAll</code>,<code>.update</code>,<code>.count</code>,<code>.destroy</code>等等.你可以保存这个模型实例并稍后再次使用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">DeletedProjects</span> = <span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&quot;deleted&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">DeletedProjects</span>.<span class="title function_">findAll</span>();</span><br><span class="line"><span class="comment">// 过一段时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 让我们再次寻找被删除的项目！</span></span><br><span class="line"><span class="title class_">DeletedProjects</span>.<span class="title function_">findAll</span>();</span><br></pre></td></tr></table></figure>

<p>作用域适用于 <code>.find</code>, <code>.findAll</code>, <code>.count</code>, <code>.update</code>, <code>.increment</code> 和 <code>.destroy</code>.</p>
<p>可以通过两种方式调用作为函数的作用域. 如果作用域没有任何参数,它可以正常调用. 如果作用域采用参数,则传递一个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;random&#x27;</span>, &#123; <span class="attr">method</span>: [<span class="string">&#x27;accessLevel&#x27;</span>, <span class="number">19</span>]&#125;).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> someNumber = <span class="number">42</span> <span class="variable constant_">AND</span> accessLevel &gt;= <span class="number">19</span></span><br></pre></td></tr></table></figure>

<h3 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h3><p>通过将作用域数组传递到 <code>.scope</code> 或通过将作用域作为连续参数传递,可以同时应用多个作用域.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这两个是等价的</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>, <span class="string">&#x27;activeUsers&#x27;</span>).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>([<span class="string">&#x27;deleted&#x27;</span>, <span class="string">&#x27;activeUsers&#x27;</span>]).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects</span><br><span class="line"><span class="variable constant_">INNER</span> <span class="variable constant_">JOIN</span> users <span class="variable constant_">ON</span> projects.<span class="property">userId</span> = users.<span class="property">id</span></span><br><span class="line"><span class="variable constant_">WHERE</span> projects.<span class="property">deleted</span> = <span class="literal">true</span></span><br><span class="line"><span class="variable constant_">AND</span> users.<span class="property">active</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>如果要将其他作用域与默认作用域一起应用,请将键 <code>defaultScope</code> 传递给 <code>.scope</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;defaultScope&#x27;</span>, <span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> active = <span class="literal">true</span> <span class="variable constant_">AND</span> deleted = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>当调用多个作用域时,后续作用域的键将覆盖以前的作用域(类似于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a>),除了<code>where</code>和<code>include</code>,它们将被合并. 考虑两个作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">scope1</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">firstName</span>: <span class="string">&#x27;bob&#x27;</span>,</span><br><span class="line">      <span class="attr">age</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scope2</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">age</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">30</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">10</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <code>.scope(&#39;scope1&#39;, &#39;scope2&#39;)</code> 将产生以下查询</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">WHERE</span> firstName = <span class="string">&#x27;bob&#x27;</span> <span class="variable constant_">AND</span> age &gt; <span class="number">30</span> <span class="variable constant_">LIMIT</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>注意 <code>scope2</code> 将覆盖 <code>limit</code> 和 <code>age</code>,而 <code>firstName</code> 被保留. <code>limit</code>,<code>offset</code>,<code>order</code>,<code>paranoid</code>,<code>lock</code>和<code>raw</code>字段被覆盖,而<code>where</code>被浅层合并(意味着相同的键将被覆盖). <code>include</code> 的合并策略将在后面讨论.</p>
<p>请注意,多个应用作用域的 <code>attributes</code> 键以这样的方式合并,即始终保留 <code>attributes.exclude</code>. 这允许合并多个作用域,并且永远不会泄漏最终作用域内的敏感字段.</p>
<p>将查找对象直接传递给作用域模型上的<code>findAll</code>(和类似的查找程序)时,适用相同的合并逻辑:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">firstName</span>: <span class="string">&#x27;john&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable constant_">WHERE</span> deleted = <span class="literal">true</span> <span class="variable constant_">AND</span> firstName = <span class="string">&#x27;john&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里的 <code>deleted</code> 作用域与 finder 合并. 如果我们要将 <code>where: &#123; firstName: &#39;john&#39;, deleted: false &#125;</code> 传递给 finder,那么 <code>deleted</code> 作用域将被覆盖.</p>
<h4 id="合并-include"><a href="#合并-include" class="headerlink" title="合并 include"></a>合并 include</h4><p>Include 是根据包含的模型递归合并的. 这是一个非常强大的合并,在 v5 上添加,并通过示例更好地理解.</p>
<p>考虑四种模型:Foo,Bar,Baz 和 Qux,具有如下多种关联:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Baz</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Qux</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Foo</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Bar</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Baz</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Qux</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Foo</span>.<span class="title function_">hasMany</span>(<span class="title class_">Bar</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;fooId&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">Bar</span>.<span class="title function_">hasMany</span>(<span class="title class_">Baz</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;barId&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">Baz</span>.<span class="title function_">hasMany</span>(<span class="title class_">Qux</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;bazId&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>现在,考虑 Foo 上定义的以下四个作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">includeEverything</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">include</span>: <span class="variable language_">this</span>.<span class="property">Qux</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">limitedBars</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">limitedBazs</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">excludeBazName</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">exclude</span>: [<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这四个作用域可以很容易地深度合并,例如通过调用 <code>Foo.scope(&#39;includeEverything&#39;, &#39;limitedBars&#39;, &#39;limitedBazs&#39;, &#39;excludeBazName&#39;).findAll()</code>,这完全等同于调用以下内容:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Foo</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: &#123;</span><br><span class="line">    <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">include</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">exclude</span>: [<span class="string">&quot;name&quot;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">include</span>: <span class="variable language_">this</span>.<span class="property">Qux</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>观察四个作用域如何合并为一个. 根据所包含的模型合并作用域的 include. 如果一个作用域包括模型 A 而另一个作用域包括模型 B,则合并结果将包括模型 A 和 B.另一方面,如果两个作用域包括相同的模型 A,但具有不同的参数(例如嵌套 include 或其他属性) ,这些将以递归方式合并,如上所示.</p>
<p>无论应用于作用域的顺序如何,上面说明的合并都以完全相同的方式工作. 如果某个参数由两个不同的作用域设置,那么只会该顺序产生差异 - 这不是上述示例的情况,因为每个作用域都做了不同的事情.</p>
<p>这种合并策略的工作方式与传递给<code>.findAll</code>,<code>.findOne</code>等的参数完全相同.</p>
<h3 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h3><p>Sequelize 与关联有两个不同但相关的作用域概念. 差异是微妙但重要的:</p>
<ul>
<li><strong>关联作用域</strong> 允许你在获取和设置关联时指定默认属性 - 在实现多态关联时很有用. 当使用<code>get</code>,<code>set</code>,<code>add</code>和<code>create</code>相关联的模型函数时,这个作用域仅在两个模型之间的关联上被调用</li>
<li><strong>关联模型上的作用域</strong> 允许你在获取关联时应用默认和其他作用域,并允许你在创建关联时传递作用域模型. 这些作用域都适用于模型上的常规查找和通过关联查找.</li>
</ul>
<p>举个例子,思考模型 Post 和 Comment. Comment 与其他几个模型(图像,视频等)相关联,Comment 和其他模型之间的关联是多态的,这意味着除了外键 <code>commentable_id</code> 之外,注释还存储一个<code>commentable</code>列.</p>
<p>可以使用 association scope 来实现多态关联:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">Post</span>.<span class="title function_">hasMany</span>(<span class="variable language_">this</span>.<span class="property">Comment</span>, &#123;</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;commentable_id&quot;</span>,</span><br><span class="line">  <span class="attr">scope</span>: &#123;</span><br><span class="line">    <span class="attr">commentable</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当调用 <code>post.getComments()</code> 时,这将自动添加 <code>WHERE commentable = &#39;post&#39;</code>. 类似地,当向帖子添加新的注释时,<code>commentable</code> 会自动设置为 <code>&#39;post&#39;</code>. 关联作用域是为了存活于后台,没有程序员不必担心 - 它不能被禁用. 有关更完整的多态性示例,请参阅 <a target="_blank" rel="noopener" href="https://itfun.tv/documents/272#scopes">关联作用域</a></p>
<p>那么考虑那个 Post 的默认作用域只显示活动的帖子:<code>where: &#123; active: true &#125;</code>. 该作用域存在于相关联的模型(Post)上,而不是像<code>commentable</code> 作用域那样在关联上. 就像在调用<code>Post.findAll()</code> 时一样应用默认作用域,当调用 <code>User.getPosts()</code> 时,它也会被应用 - 这只会返回该用户的活动帖子.</p>
<p>要禁用默认作用域,将 <code>scope: null</code> 传递给 getter: <code>User.getPosts(&#123; scope: null &#125;)</code>. 同样,如果要应用其他作用域,请像这样:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">getPosts</span>(&#123; <span class="attr">scope</span>: [<span class="string">&quot;scope1&quot;</span>, <span class="string">&quot;scope2&quot;</span>] &#125;);</span><br></pre></td></tr></table></figure>

<p>如果要为关联模型上的作用域创建快捷方式,可以将作用域模型传递给关联. 考虑一个快捷方式来获取用户所有已删除的帖子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Post</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">init</span>(attributes, &#123;</span><br><span class="line">  <span class="attr">defaultScope</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scopes</span>: &#123;</span><br><span class="line">    <span class="attr">deleted</span>: &#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">deleted</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  sequelize,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Post</span>); <span class="comment">// 常规 getPosts 关联</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Post</span>.<span class="title function_">scope</span>(<span class="string">&quot;deleted&quot;</span>), &#123; <span class="attr">as</span>: <span class="string">&quot;deletedPosts&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">getPosts</span>(); <span class="comment">// WHERE active = true</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">getDeletedPosts</span>(); <span class="comment">// WHERE deleted = true</span></span><br></pre></td></tr></table></figure>

<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><p>extend&#x2F;helper.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/helper.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 扩展一个格式日期的方法</span></span><br><span class="line">  <span class="title function_">formatTime</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(val * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> d.<span class="title function_">getFullYear</span>();</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>模板中调用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=helper.formatTime(dateline)%&gt;</span><br></pre></td></tr></table></figure>

<p>其他地方调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">helper</span>.<span class="title function_">formatTime</span>(dateline);</span><br></pre></td></tr></table></figure>

<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p>app&#x2F;middleware&#x2F;getIp.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">options: 中间件的配置项，框架会将 app.config[$&#123;middlewareName&#125;] 传递进来。</span></span><br><span class="line"><span class="comment">app: 当前应用 Application 的实例。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 返回一个异步的方法</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 通过option传入额外参数</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(option);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">ip</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h2><p>config&#x2F;config.default.js（配置全局中间件，所有路由都会调用）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">appInfo</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置全局中间件</span></span><br><span class="line">    config.<span class="property">middleware</span> = [<span class="string">&#x27;getIp&#x27;</span>]; <span class="comment">// 注意驼峰式写法，如果中间件是a_bc.js，则要写成aBc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置中间件参数</span></span><br><span class="line">    config.<span class="property">getIp</span> = &#123;</span><br><span class="line">        <span class="attr">ceshi</span>: <span class="number">123</span>,</span><br><span class="line">        <span class="comment">// 通用配置（以下是重点）</span></span><br><span class="line">        <span class="attr">enable</span>:<span class="literal">true</span>, <span class="comment">// 控制中间件是否开启。</span></span><br><span class="line">        <span class="attr">match</span>:<span class="string">&#x27;/news&#x27;</span>, <span class="comment">// 设置只有符合某些规则的请求才会经过这个中间件（匹配路由）</span></span><br><span class="line">        <span class="attr">ignore</span>:<span class="string">&#x27;/shop&#x27;</span> <span class="comment">// 设置符合某些规则的请求不经过这个中间件。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        注意：</span></span><br><span class="line"><span class="comment">        1. match 和 ignore 不允许同时配置</span></span><br><span class="line"><span class="comment">        2. 例如：match:&#x27;/news&#x27;，只要包含/news的任何页面都生效</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// match 和 ignore 支持多种类型的配置方式：字符串、正则、函数（推荐）</span></span><br><span class="line">        <span class="title function_">match</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">          <span class="comment">// 只有 ios 设备才开启</span></span><br><span class="line">          <span class="keyword">const</span> reg = <span class="regexp">/iphone|ipad|ipod/i</span>;</span><br><span class="line">          <span class="keyword">return</span> reg.<span class="title function_">test</span>(ctx.<span class="title function_">get</span>(<span class="string">&#x27;user-agent&#x27;</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h2><h3 id="路由中使用"><a href="#路由中使用" class="headerlink" title="路由中使用"></a>路由中使用</h3><p>app&#x2F;router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 局部中间件（如果只需要局部调用，则不需要在config.default.js中配置）</span></span><br><span class="line">  router.<span class="title function_">get</span>(</span><br><span class="line">    <span class="string">&quot;/admin/:id&quot;</span>,</span><br><span class="line">    app.<span class="property">middleware</span>.<span class="title function_">getIp</span>(&#123;</span><br><span class="line">      <span class="attr">ceshi</span>: <span class="string">&quot;我是admin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    controller.<span class="property">admin</span>.<span class="property">index</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Koa-的中间件（gzip-压缩）"><a href="#使用-Koa-的中间件（gzip-压缩）" class="headerlink" title="使用 Koa 的中间件（gzip 压缩）"></a>使用 Koa 的中间件（gzip 压缩）</h3><p>大大提高网站的访问速度（非常有效）</p>
<p>以 <a target="_blank" rel="noopener" href="https://github.com/koajs/compress">koa-compress</a> 为例，在 Koa 中使用时：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> compress = <span class="built_in">require</span>(<span class="string">&quot;koa-compress&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123; <span class="attr">threshold</span>: <span class="number">2048</span> &#125;;</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">compress</span>(options));</span><br></pre></td></tr></table></figure>

<p>我们按照框架的规范来在应用中加载这个 Koa 的中间件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/compress.js</span></span><br><span class="line"><span class="comment">// koa-compress 暴露的接口(`(options) =&gt; middleware`)和框架对中间件要求一致</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-compress&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">middleware</span>: [<span class="string">&quot;compress&quot;</span>],</span><br><span class="line">  <span class="attr">compress</span>: &#123;</span><br><span class="line">    <span class="attr">threshold</span>: <span class="number">2048</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="表单提交"><a href="#表单提交" class="headerlink" title="表单提交"></a>表单提交</h1><h2 id="post"><a href="#post" class="headerlink" title="post"></a>post</h2><p>app&#x2F;controller&#x2F;home.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">addInput</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;post&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">add</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="comment">// 通过ctx.request.body获取post提交数据</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">body</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app&#x2F;view&#x2F;post.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">需要定义：?_csrf=&lt;%=ctx.csrf%&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/add?_csrf=&lt;%=ctx.csrf%&gt;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>app&#x2F;router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/post&quot;</span>, controller.<span class="property">home</span>.<span class="property">addInput</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/add&quot;</span>, controller.<span class="property">home</span>.<span class="property">add</span>);</span><br></pre></td></tr></table></figure>

<h1 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.设置</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;ceshi&quot;</span>);</span><br><span class="line"><span class="comment">// 2.获取</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.设置中文(加密操作 encrypt: true)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.设置（其他参数配置）</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;ceshi&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">3600</span> * <span class="number">24</span>, <span class="comment">// 存储24小时，单位毫秒，关闭浏览器cookie还存在</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span></span><br><span class="line">  <span class="attr">signed</span>: <span class="literal">true</span>, <span class="comment">// 签名，防止用户前台修改</span></span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>, <span class="comment">// 加密，注意：get获取时需要解密</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 5.获取时解密</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.清除cookie</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h1 id="session"><a href="#session" class="headerlink" title="session"></a>session</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.设置</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="string">&quot;测试&quot;</span>;</span><br><span class="line"><span class="comment">// 2.获取</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span>;</span><br><span class="line"><span class="comment">// 3.默认配置（全局配置，config/config.default.js）</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">session</span> = &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;EGG_SESS&quot;</span>, <span class="comment">// 设置cookies的key值</span></span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>, <span class="comment">// 1 天，过期时间</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span></span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>, <span class="comment">// 加密</span></span><br><span class="line">  <span class="attr">renew</span>: <span class="literal">true</span>, <span class="comment">// 每次刷新页面都会被延期</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 4.动态配置</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">maxAge</span> = <span class="number">5000</span>; <span class="comment">// 5秒的过期时间</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="string">&quot;测试&quot;</span>;</span><br><span class="line"><span class="comment">// 5.清空session</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h1 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/schedule/ceshi.js</span></span><br><span class="line"><span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 设置定时任务的执行间隔等配置</span></span><br><span class="line">  <span class="attr">schedule</span>: &#123;</span><br><span class="line">    <span class="attr">interval</span>: <span class="string">&quot;5s&quot;</span>, <span class="comment">// 每5秒执行一次</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;all&quot;</span>, <span class="comment">// 指定所有的 worker 都需要执行</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 任务</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">task</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    ++i;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><h2 id="1-context"><a href="#1-context" class="headerlink" title="1. context"></a>1. context</h2><h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">ceshi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 通过ctx中的curl方法获取数据</span></span><br><span class="line">    <span class="keyword">let</span> r = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">curl</span>(<span class="string">&#x27;http://www.phonegap100.com/appapi.php?a=getPortalList&amp;catid=20&amp;page=1&#x27;</span>);</span><br><span class="line">    <span class="comment">// 将buffer类型数据转为json类型</span></span><br><span class="line">    <span class="keyword">let</span> &#123; result &#125; = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(r.<span class="property">data</span>)</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h1><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-cache">https://www.npmjs.com/package/egg-cache</a><br><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-redis">https://www.npmjs.com/package/egg-redis</a></p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p><a target="_blank" rel="noopener" href="https://github.com/temool/egg-validate-plus">https://github.com/temool/egg-validate-plus</a></p>
<h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-jwt">https://www.npmjs.com/package/egg-jwt</a></p>
<p>前端访问：header 头添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authorization:&quot;Bearer token值&quot;</span></span><br><span class="line"><span class="title class_">Authorization</span>: <span class="string">&quot;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6MTIzLCJpYXQiOjE1NzkxOTQxNTN9.Ml5B02ZPfYo78QwJic-Jdp2LUi2_AU0RGNgPhhJH--o&quot;</span>;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/11/08/Koa/" rel="prev" title="Koa">
                  <i class="fa fa-chevron-left"></i> Koa
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/11/08/GraphQL/" rel="next" title="GraphQL">
                  GraphQL <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zax Tseng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
