<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Zax&#39;s BLOG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Zax&#39;s BLOG">
<meta property="og:type" content="website">
<meta property="og:title" content="Zax&#39;s BLOG">
<meta property="og:url" content="http://yoursite.com/page/12/index.html">
<meta property="og:site_name" content="Zax&#39;s BLOG">
<meta property="og:description" content="Zax&#39;s BLOG">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zax Tseng">
<meta property="article:tag" content="javascript, React, Vue, HTML5">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Zax&#39;s BLOG" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Zax&#39;s BLOG</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-其他人面试题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/16/%E5%85%B6%E4%BB%96%E4%BA%BA%E9%9D%A2%E8%AF%95%E9%A2%98/" class="article-date">
  <time datetime="2019-11-16T10:40:25.000Z" itemprop="datePublished">2019-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/16/%E5%85%B6%E4%BB%96%E4%BA%BA%E9%9D%A2%E8%AF%95%E9%A2%98/">其他人面试题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="第一份"><a href="#第一份" class="headerlink" title="第一份"></a>第一份</h1><p>1. </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">name</span> = <span class="string">&quot;nick&quot;</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">age</span> = <span class="number">20</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">job</span> = <span class="string">&quot;Engineer&quot;</span></span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">sayName</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person1 = <span class="keyword">new</span> <span class="title class_">Person</span>()</span><br><span class="line"><span class="keyword">var</span> person2 = <span class="keyword">new</span> <span class="title class_">Person</span>()</span><br><span class="line">person1.<span class="property">name</span> = <span class="string">&quot;Greg&quot;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person1.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person2.<span class="property">name</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person1.<span class="title function_">hasOwnProperty</span>(<span class="string">&quot;name&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Greg</span></span><br><span class="line">nick <span class="comment">//实例并没有改变对象的属性</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>请列举js的数据类型</li>
<li>请写出dom事件流的三个阶段</li>
<li>js如何添加,移除,创建,复制,查找dom节点</li>
<li>jQuery的bind,live,delegate的区别</li>
<li>请写出至少4种vue的指令和用法</li>
<li>什么是闭包,什么时候使用闭包</li>
<li>如何编写响应式网页</li>
<li>简单描述一下微信小程序的文件类型</li>
<li>如何优化代码</li>
<li>请列举ES6的语法</li>
</ol>
<h1 id="第二份"><a href="#第二份" class="headerlink" title="第二份"></a>第二份</h1><ol>
<li>this原型链new结合的题,问输出什么</li>
<li>css有什么选择器,优先级,什么属性,哪些可以继承,哪些不能继承,css3新增的伪类有哪些</li>
<li>vue组件通信</li>
<li>ajax返回三个状态码,成功失败未知,假如是未知就轮询,1到5秒延迟3秒发请求,6到10秒延迟1秒,10到20延迟0.5秒,轮询20次失败,手写可运行的代码</li>
<li>数组{城市,省份,代号}输出成{省份,城市[城市名,代号]}</li>
<li>js有什么bug让你写代码出错,答类型判断.追问,怎么通过原型链判断一个对象是json,</li>
<li>平时写代码有什么逻辑上的错误</li>
<li>当前端有什么技巧?(不是优化).答:console二分法定位错误</li>
</ol>
<h1 id="第三份"><a href="#第三份" class="headerlink" title="第三份"></a>第三份</h1><ol>
<li>将下列数据封装成json</li>
</ol>
<table>
<thead>
<tr>
<th>数据名</th>
<th>值</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>kate</td>
<td>string</td>
</tr>
<tr>
<td>age</td>
<td>10</td>
<td>int</td>
</tr>
<tr>
<td>phone</td>
<td>15455234376</td>
<td>string</td>
</tr>
<tr>
<td>phone</td>
<td>15455234376</td>
<td>string</td>
</tr>
<tr>
<td>date_time</td>
<td>2019-01-01 15:00:00</td>
<td>string</td>
</tr>
</tbody></table>
<ol start="2">
<li>将如下json字符串转化成js对象并获取到name的值<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> json_str = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;tiger&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> json_str = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;tiger&quot;</span>&#125;</span><br><span class="line"><span class="keyword">var</span> str = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;json_str&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str.<span class="property">name</span>)</span><br></pre></td></tr></table></figure></li>
<li>获取如下变量中的月和日<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> date_time = <span class="string">&quot;2019-01-01 15:00:00&quot;</span></span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(date_time).<span class="title function_">getMonth</span>() + <span class="number">1</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(date_time).<span class="title function_">getDate</span>()</span><br></pre></td></tr></table></figure></li>
<li>写出尽可能多的dom事件和js事件</li>
<li>写出尽可能多的伪类和伪元素</li>
<li>css3 2D转换,如右图效果(效果是第二个div方块向上位移一半,能够覆盖一点第一个div,然后顺时针旋转30度),代码如下,请填写div2的代码<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> html&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-tag">div</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="attribute">width</span>: <span class="number">100px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="attribute">height</span>: <span class="number">75px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="attribute">background-color</span>: lightgray;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-tag">div</span><span class="selector-id">#div2</span>&#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="comment">/*请写代码 */</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>1号div元素<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;div2&quot;</span>&gt;</span>2号div元素<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">div#div2&#123;</span><br><span class="line"><span class="attr">transform</span>: <span class="title function_">translateY</span>(-<span class="number">20</span>%);</span><br><span class="line"><span class="attr">transform</span>: <span class="title function_">rotate</span>(30deg);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>css动画使用哪个属性,过渡使用哪个属性</li>
<li>写一种灰色的rgb值</li>
<li>尽可能多的vue的生命周期,并标注运行时间</li>
<li>控制元素是否显示的vue属性</li>
<li>下面代码的打印结果. 简述什么是变量的作用域,全局变量和局部变量的区别<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    a = <span class="number">100</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">a</span>)</span><br><span class="line">    <span class="keyword">var</span> a </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">test</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">100</span> <span class="comment">//声明前置,函数内部a=100</span></span><br><span class="line"><span class="number">10</span> <span class="comment">//this指向window,a=10</span></span><br><span class="line"><span class="number">100</span> <span class="comment">//继续输出函数内部的a</span></span><br><span class="line"><span class="number">10</span> <span class="comment">//函数内部的a只在函数内有效,在外部看全局的a,a=10</span></span><br></pre></td></tr></table></figure></li>
<li>简述cookie和session的区别</li>
<li>简述axios的作用和优势.</li>
</ol>
<h1 id="第四份"><a href="#第四份" class="headerlink" title="第四份"></a>第四份</h1><ol>
<li>v-show和v-if的区别</li>
<li>let和const的区别</li>
<li>fetch和axios支持跨域请求吗?fetch第一次得到什么数据,怎么进行转换?</li>
<li>什么是MVC和MVVM,vue属于那一种?小程序是什么思想实现双向数据绑定的?</li>
<li>async和await实现同步的好处</li>
<li>React&#x2F;Vue中key会影响diff算法吗</li>
<li>Vue-router的路由原理</li>
<li>什么是虚拟dom</li>
</ol>
<h1 id="第五份"><a href="#第五份" class="headerlink" title="第五份"></a>第五份</h1><ol>
<li>使用css让该节点不可见,方法越多越好<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="keyword">class</span>=<span class="string">&quot;hidden&quot;</span>&gt;<span class="title class_">Hi</span>&lt;/div&gt;</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>在哪些场景下用过position的哪些值,他们分别有什么特性.</li>
<li>什么是单进程?什么是单进程异步?</li>
<li>输出结果<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fn = []</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">    fn[i] = <span class="keyword">function</span>(<span class="params">param</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i + param)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn[<span class="number">5</span>](<span class="number">5</span>)</span><br><span class="line"><span class="keyword">var</span> data = &#123; <span class="attr">a</span>:<span class="number">10</span>, <span class="attr">b</span>:<span class="number">20</span> &#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;第&#x27;</span>+ i +<span class="string">&#x27;条数据:&#x27;</span> + data)</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span> <span class="comment">//闭包,打印最后是10个闭包,且i=10,传入[5],打出来i也是10</span></span><br><span class="line"><span class="string">&quot;第10条数据:[object Object]&quot;</span> <span class="comment">//字符串+对象就会把对象打印成[object Object].这是+运算符的特点</span></span><br></pre></td></tr></table></figure></li>
<li>输出结果<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">&#125;,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>)</span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>)</span><br><span class="line">&#125;, <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">6</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">7</span>)</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察微任务和宏任务</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span> <span class="comment">//此时并未执行异步,仍属于宏任务中script下同步代码</span></span><br><span class="line"><span class="number">7</span> <span class="comment">//此时同步代码执行完毕,执行栈为空,</span></span><br><span class="line"><span class="number">5</span> <span class="comment">//开始执行微任务,promise属于微任务</span></span><br><span class="line">  <span class="comment">//不输出6是因为那是失败时的回调</span></span><br><span class="line"><span class="number">2</span> <span class="comment">//开始下一轮event loop,执行宏任务中的异步代码.setTimeout开始执行.</span></span><br></pre></td></tr></table></figure></li>
<li>输出结果<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = [<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> j=<span class="number">0</span>;j&lt;<span class="number">5</span>;j++)&#123;</span><br><span class="line">        a[i] = a[i] + a[j]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a[i])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//双重遍历</span></span><br><span class="line"><span class="comment">//可以假设外层的不变</span></span><br><span class="line"><span class="comment">//当i=0时,内层开始遍历,得到</span></span><br><span class="line">a[<span class="number">0</span>] = a[<span class="number">0</span>] + a[<span class="number">0</span>] <span class="comment">//2</span></span><br><span class="line">a[<span class="number">0</span>] = a[<span class="number">0</span>] + a[<span class="number">1</span>] <span class="comment">//3</span></span><br><span class="line">a[<span class="number">0</span>] = a[<span class="number">0</span>] + a[<span class="number">2</span>] <span class="comment">//4</span></span><br><span class="line">a[<span class="number">0</span>] = a[<span class="number">0</span>] + a[<span class="number">3</span>] <span class="comment">//5</span></span><br><span class="line">a[<span class="number">0</span>] = a[<span class="number">0</span>] + a[<span class="number">4</span>] <span class="comment">//6,</span></span><br><span class="line"><span class="comment">//此时a[0] = 6</span></span><br><span class="line"><span class="comment">//当i=1时,内层再次遍历,得到</span></span><br><span class="line">a[<span class="number">1</span>] = a[<span class="number">1</span>] + a[<span class="number">0</span>] <span class="comment">//7</span></span><br><span class="line">a[<span class="number">1</span>] = a[<span class="number">1</span>] + a[<span class="number">1</span>] <span class="comment">//14</span></span><br><span class="line">a[<span class="number">1</span>] = a[<span class="number">1</span>] + a[<span class="number">2</span>] <span class="comment">//15</span></span><br><span class="line">a[<span class="number">1</span>] = a[<span class="number">1</span>] + a[<span class="number">3</span>] <span class="comment">//16</span></span><br><span class="line">a[<span class="number">1</span>] = a[<span class="number">1</span>] + a[<span class="number">4</span>] <span class="comment">//17,</span></span><br><span class="line"><span class="comment">//此时a[1] = 17</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以此类推,得到</span></span><br><span class="line">a = [<span class="number">6</span>,<span class="number">17</span>,<span class="number">50</span>,<span class="number">149</span>,<span class="number">446</span>]</span><br></pre></td></tr></table></figure></li>
<li>写出1所在的while循环的作用.补全2的代码<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//isSymmetry用来判断正整数n是否是一个对称数.例如:12321是对称数,123不是.</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isSymmetry</span>(<span class="params">n</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> i = n</span><br><span class="line">    <span class="keyword">let</span> j = <span class="number">0</span></span><br><span class="line">    <span class="comment">//位置1</span></span><br><span class="line">    <span class="keyword">while</span>(i)&#123;</span><br><span class="line">        j = j * <span class="number">10</span> + i % <span class="number">10</span></span><br><span class="line">        i = <span class="built_in">parseInt</span>(i/<span class="number">10</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="comment">//位置2补充代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isSymmetry</span>(<span class="number">12321</span>)) <span class="comment">//true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">isSymmetry</span>(<span class="number">12312</span>)) <span class="comment">//false</span></span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">假设: n = <span class="number">11</span>,</span><br><span class="line">i = <span class="number">11</span>,j = <span class="number">0</span>;</span><br><span class="line">i = <span class="number">1</span>,j = <span class="number">1</span>;</span><br><span class="line">i = <span class="number">0</span> ,j = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">n = <span class="number">111</span>,</span><br><span class="line">i = <span class="number">111</span>,j = <span class="number">0</span>;</span><br><span class="line">i = <span class="number">11</span>,j = <span class="number">1</span>;</span><br><span class="line">i = <span class="number">1</span>,j = <span class="number">11</span>;</span><br><span class="line">i = <span class="number">0</span>,j = <span class="number">111.</span></span><br><span class="line"></span><br><span class="line">n = <span class="number">12</span>,</span><br><span class="line">i = <span class="number">12</span>,j = <span class="number">0</span>;</span><br><span class="line">i = <span class="number">1</span>,j = <span class="number">2</span>;</span><br><span class="line">i = <span class="number">0</span>,j = <span class="number">21.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//结论</span></span><br><span class="line"><span class="keyword">return</span> n == j</span><br><span class="line"><span class="keyword">while</span>的作用: 循环判断是否将输入值的高低位置颠倒.</span><br></pre></td></tr></table></figure></li>
<li>把数组倒序输出(不是排序,不能用内置方法)<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;first&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="string">&#x27;2&#x27;</span>, <span class="number">9</span>]</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> key <span class="keyword">in</span> arr)&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(arr[key])</span><br><span class="line">    &#125;,<span class="number">100</span>-key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>(过一面必做题)数组中的重复项最多出现N次.(时间复杂度越低得分越高)<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原题</span></span><br><span class="line"><span class="title function_">outputNth</span>([<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>], <span class="number">2</span>) <span class="comment">//return [1,1]</span></span><br><span class="line"><span class="title function_">outputNth</span>([<span class="number">20</span>, <span class="number">37</span>, <span class="number">20</span>, <span class="number">20</span>, <span class="number">21</span>], <span class="number">2</span>) <span class="comment">//return [20,20,37,21]</span></span><br><span class="line"><span class="comment">//预估时间复杂度</span></span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//附加题</span></span><br><span class="line"><span class="comment">//如果要求</span></span><br><span class="line"><span class="title function_">outputNth</span>([<span class="number">20</span>, <span class="number">37</span>, <span class="number">20</span>, <span class="number">20</span>, <span class="number">21</span>], <span class="number">2</span>) <span class="comment">//return [20,37,20,21] 按原数组的先后返回</span></span><br><span class="line"><span class="comment">//预估时间复杂度</span></span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="第六份"><a href="#第六份" class="headerlink" title="第六份"></a>第六份</h1><ol>
<li>假设有两个数组a和b,数组的内容都是从小到大排好序的数字.现在我们合并这两个数字.并且合并之后的数字也是从小到大排好序的.<br>请写下你的实现.不要直接使用js的sort方法,并且确保只使用一次for循环.<br>例如,a&#x3D;[2,5,10],b&#x3D;[4,7,9,11],那么合并的结果是c&#x3D;[2,4,5,7,9,10,11]<br>提示,你可以在一个for循环中同时控制两个数组下标i和j.比较a[i]和a[j].将小的数字加到c中,同时更新相应的下标.但是注意各种边界条件.<br>输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察排序算法</span></span><br><span class="line"><span class="keyword">var</span> arr = a.<span class="title function_">concat</span>(b) <span class="comment">//arr=[2,5,10,4,7,9,11]</span></span><br><span class="line"><span class="keyword">var</span> c =[]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>输入一个数字组成的字符串,请把它转化成整数并输出.<br>例如,输入字符串’123’,输出整数123.不要使用库函数,函数原型为: <code>function strToInt(str)</code><br>输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">&#x27;123&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(+str)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">parseInt</span>(str))</span><br></pre></td></tr></table></figure></li>
<li>合并数组中相邻且重复的元素<br>说明: 请实现一个函数merge,传入一个数组,合并数组中相邻且重复的元素,示例:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">merge</span>([<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">1</span>]) <span class="comment">//[3,2,4,5,6,2,1]</span></span><br><span class="line"><span class="title function_">merge</span>([<span class="number">3</span>,<span class="number">2</span>,<span class="number">3</span>]) <span class="comment">//[3,2,3]</span></span><br><span class="line"><span class="title function_">merge</span>([<span class="number">2</span>,<span class="number">2</span>,<span class="number">3</span>]) <span class="comment">//[2,3]</span></span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">  </span><br></pre></td></tr></table></figure></li>
<li>请按顺序取出下方log<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">async1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async1 start&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">async2</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async1 end&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">async2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async2&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script start&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout&quot;</span>)</span><br><span class="line">&#125;,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="title function_">async1</span>()</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise1&quot;</span>)</span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise2&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script end&quot;</span>)</span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">script start </span><br><span class="line">async1 start <span class="comment">//async 表达式定义的函数是立即执行的</span></span><br><span class="line">async2</span><br><span class="line">promise1</span><br><span class="line">script end</span><br><span class="line">async1 end <span class="comment">//</span></span><br><span class="line">promise2</span><br><span class="line"><span class="built_in">setTimeout</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="第七份"><a href="#第七份" class="headerlink" title="第七份"></a>第七份</h1><ol>
<li>对MVC,MVVM的理解.</li>
<li>vue对于jquery在开发上有什么优点</li>
<li>前后端分离的思想了解吗</li>
<li>你上一个项目都用了哪些方法优化js的性能</li>
<li>说一下你对vue和veux的使用方法,vue的组件复用机制</li>
<li>js怎样实现一个类,怎么实例化这个类</li>
</ol>
<h1 id="第八份"><a href="#第八份" class="headerlink" title="第八份"></a>第八份</h1><ol>
<li>下面的函数执行后会输出什么<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">a</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> b = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve,reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">        <span class="title function_">reject</span>(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;<span class="number">10</span>; ++i)&#123;</span><br><span class="line">        b.<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data + i)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">a</span>() <span class="comment">//输出什么</span></span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hello world0</span><br><span class="line">hello world1</span><br><span class="line">hello world2</span><br><span class="line">hello world3</span><br><span class="line">hello world4</span><br><span class="line">hello world5</span><br><span class="line">hello world6</span><br><span class="line">hello world7</span><br><span class="line">hello world8</span><br><span class="line">hello world9</span><br></pre></td></tr></table></figure></li>
<li>下面的函数执行后会输出什么<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="keyword">async</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> b = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve,reject</span>)&#123;</span><br><span class="line">            <span class="title function_">resolve</span>(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">            <span class="title function_">reject</span>(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(data + i)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">b</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">a</span>() <span class="comment">//输出什么</span></span><br></pre></td></tr></table></figure>
输出<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hello0</span><br><span class="line">hello1</span><br><span class="line">hello2</span><br><span class="line">hello3</span><br><span class="line">hello4</span><br><span class="line">hello5</span><br><span class="line">hello6</span><br><span class="line">hello7</span><br><span class="line">hello8</span><br><span class="line">hello9</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="第九份-半截"><a href="#第九份-半截" class="headerlink" title="第九份(半截)"></a>第九份(半截)</h1><ol start="7">
<li><p>什么是延迟加载?</p>
</li>
<li><p>请谈谈vue中的mvvm模式</p>
</li>
<li><p>vue中引入组件的步骤</p>
</li>
<li><p>什么是vuex?为什么要用vuex?</p>
</li>
</ol>
<h1 id="第十份"><a href="#第十份" class="headerlink" title="第十份"></a>第十份</h1><ol>
<li>请说明值类型和引用类型的区别?那些是值类型,哪些是引用类型?</li>
<li>请简述private,protected,public,internal修饰符的访问权限.</li>
<li>简述session和cookie的作用和区别</li>
<li>请简述ajax工作原理和常用的ajax框架</li>
<li>css规范中, <code>.</code>后面跟一个名称代表什么?<code>#</code>代表什么?</li>
<li>字符串反转,给定字符串<code>&quot;we;tonight;you;&quot;</code>,编码实现输出<code>&quot;ew;thginot;uoy;&quot;</code></li>
</ol>
<h1 id="第十一份"><a href="#第十一份" class="headerlink" title="第十一份"></a>第十一份</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;The Window&quot;</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;My Obj&quot;</span>,</span><br><span class="line">    <span class="attr">getNameFunc</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">name</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">getNameFunc</span>()()) <span class="comment">//输出什么</span></span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj.<span class="title function_">getNameFunc</span>()的<span class="variable language_">this</span>是obj</span><br><span class="line">obj.<span class="title function_">getNameFunc</span>()()的<span class="variable language_">this</span>是<span class="variable language_">window</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&quot;The Window&quot;</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;My Obj&quot;</span>,</span><br><span class="line">    <span class="attr">getNameFunc</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> that = <span class="variable language_">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> that.<span class="property">name</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="title function_">getNameFunc</span>()()) <span class="comment">//输出什么</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">My</span> <span class="title class_">Obj</span></span><br></pre></td></tr></table></figure>
<h1 id="第十二份"><a href="#第十二份" class="headerlink" title="第十二份"></a>第十二份</h1><ol>
<li>vue-router原理</li>
<li>相关钩子函数</li>
<li>nexttick</li>
<li>css3常用属性</li>
<li>keep-alive</li>
<li>屏幕滚动</li>
<li>箭头函数什么时候就已经绑定this</li>
<li>数组方法,map和forEach的区别</li>
<li>route和router的区别</li>
<li>中间件原理</li>
</ol>
<h1 id="第十三份"><a href="#第十三份" class="headerlink" title="第十三份"></a>第十三份</h1><ol>
<li>虚拟dom</li>
<li>生命周期,常用的那些,在这些阶段一般都做了什么</li>
<li>Vuex是干什么的?有哪些属性?怎么操作state中的属性</li>
<li>vue-router有哪些方法?怎么传递参数,获取参数,路由导航钩子有哪几种,全局钩子的移动端适配(媒体查询,flex,viewport,rem)</li>
<li>常用的ES6内容.const a &#x3D;{b:1},改变b的值会不会报错.模板字符串,解构赋值,拓展运算符及使用场景.</li>
<li>element-UI常用的插件,之前项目是怎么搭建的</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/16/%E5%85%B6%E4%BB%96%E4%BA%BA%E9%9D%A2%E8%AF%95%E9%A2%98/" data-id="cl9xpujrq003udmopcb66hom7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-电话面试题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/16/%E7%94%B5%E8%AF%9D%E9%9D%A2%E8%AF%95%E9%A2%98/" class="article-date">
  <time datetime="2019-11-16T08:29:01.000Z" itemprop="datePublished">2019-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/16/%E7%94%B5%E8%AF%9D%E9%9D%A2%E8%AF%95%E9%A2%98/">电话面试题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#CSS<br>1.	重绘和回流(那些操作会引起重回和回流,如何减少回流)<br>2.	Css伪类有哪些?<br>3.	Position的几个属性,各个区别?<br>4.	Css3常用的属性<br>5.	实现水平垂直居中的方法<br>6.	<code>Visible:none</code>和<code>display:none</code>,<code>hidden</code>的区别<br>7.	Css的预处理器,好处,优点作用.<br>8.	Css实现三角形.<br>9.	Css引入的方法与区别</p>
<h1 id="JS"><a href="#JS" class="headerlink" title="JS"></a>JS</h1><ol>
<li><pre><code>闭包的理解,作用,场景,缺点.
</code></pre>
<ol start="2">
<li><pre><code>类如何创建和继承
</code></pre>
<ol start="3">
<li><pre><code>深拷贝有哪些
</code></pre>
<ol start="4">
<li><pre><code>微任务和宏任务
</code></pre>
<ol start="5">
<li><pre><code>setInterval如何实现,用setTimeout实现.
</code></pre>
<ol start="6">
<li><pre><code>for循环里面有setTimeout,里面有console.log(i).不属于for循环最后面再有个console.log(i).17:40处.
</code></pre>
<ol start="7">
<li><pre><code>如果把var改为let,结果如何
</code></pre>
<ol start="8">
<li><pre><code>[] == ![]结果如何?为什么?
</code></pre>
<ol start="9">
<li><pre><code>Promise的理解
</code></pre>
<ol start="10">
<li><pre><code>Async/Await与Promise的区别和联系.
</code></pre>
Await相对于Promise相当于Promise的什么?<ol start="11">
<li><pre><code>随机生成一个100-200之间的数
</code></pre>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h1 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h1><ol>
<li><pre><code>虚拟DOM的理解
</code></pre>
<ol start="2">
<li><pre><code>Vue如何实现双向绑定,底层
</code></pre>
<ol start="3">
<li><pre><code>如何监听数组
</code></pre>
<ol start="4">
<li><pre><code>异步组件在哪用,优点
</code></pre>
<ol start="5">
<li><pre><code>计算属性和侦听器的区别(watch和computed)
</code></pre>
<ol start="6">
<li><pre><code>Slot插槽,用在哪里.
</code></pre>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>独立配置webpack?有过修改吗?</li>
</ol>
<h1 id="Vue面试题"><a href="#Vue面试题" class="headerlink" title="Vue面试题"></a>Vue面试题</h1><ol>
<li>向后台请求数据放在哪个生命周期,为什么?</li>
<li>Vue的特性是数据驱动和组件化开发,有封装过自己的组件吗?</li>
<li>组件和v-model,如果组件内数据变动,页面会不会都变动?</li>
<li>V-model的实现原理</li>
<li>路由菜单动态改变</li>
<li>请求菜单时,是每个请求都加上token还是加上其他东西?</li>
<li>v-model绑定相同类目在不同页面,点击其中一个,另一个会变化吗?为什么?</li>
</ol>
<h1 id="腾讯面试"><a href="#腾讯面试" class="headerlink" title="腾讯面试"></a>腾讯面试</h1><p>1.ES6导入为什么是require？如何require模块？<br>2.密码加密用什么插件？这个插件是对称加密还是什么？<br>3.说下http状态码<br>4.缓存有几个阶段？浏览器请求网页，发现没有缓存到，就去重新请求，请问这个过程是怎样的？<br>5.如果遇到304，会用到缓存的哪些字段？<br>6.前端工程化是什么？<br>7.webpack插件和loader的区别<br>8.webpack如何优化<br>8.vue的底层原理.<br>9.说下虚拟dom<br>10. js的异步机制，底层原理是什么？<br>11.node.js和js区别<br>12.计算机网络</p>
<p>#酒铺</p>
<ol>
<li>API输出格式规范</li>
<li>单页和多页的区别</li>
<li>鉴权方式</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/16/%E7%94%B5%E8%AF%9D%E9%9D%A2%E8%AF%95%E9%A2%98/" data-id="cl9xpujs2004ldmop6jgaayzf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-上海公司面试题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/16/%E4%B8%8A%E6%B5%B7%E5%85%AC%E5%8F%B8%E9%9D%A2%E8%AF%95%E9%A2%98/" class="article-date">
  <time datetime="2019-11-16T08:28:19.000Z" itemprop="datePublished">2019-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/16/%E4%B8%8A%E6%B5%B7%E5%85%AC%E5%8F%B8%E9%9D%A2%E8%AF%95%E9%A2%98/">上海公司面试题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="云印-以-vue-为主"><a href="#云印-以-vue-为主" class="headerlink" title="云印(以 vue 为主)"></a>云印(以 vue 为主)</h1><p>1.页面初始化一般放在哪个生命周期里,为什么?<br>2.vue 组件之间如何传递参数<br>3.同步组件和异步组件之间的区别,优缺点<br>4.vue-router 实现原理<br>5.微信小程序的跳转方式有哪几种<br>6. ajax 的同步和异步有什么区别<br>7.css 那些属性是默认继承的?<br>8. canvas和style怎么进行绑定?<br>9. v-for中in和of的区别<br>10. watch如何使用<br>11. 如何存储localstorage<br>12. router如何传值,如何取值<br>13. vuex如何存储值<br>14. 分页组件的实现<br>15. 如何监听物理返回键</p>
<h1 id="报关-以-http-为主"><a href="#报关-以-http-为主" class="headerlink" title="报关(以 http 为主)"></a>报关(以 http 为主)</h1><ol>
<li>http 请求原理</li>
<li>http 请求的几种方式,有什么区别</li>
<li>如何进行登录验证,token 失效如何处理</li>
<li>如何调换数组中两个元素的位置.例如:[1,2,3,4,5]中调换3和4的位置,变成[1,2,4,3,5].</li>
<li>向后端发送文件的格式?</li>
</ol>
<h1 id="外包公司-1"><a href="#外包公司-1" class="headerlink" title="外包公司 1"></a>外包公司 1</h1><ol>
<li>js 中如何检测一个变量是 String 类型.请写出函数具体实现</li>
<li>写出下面函数输出什么(tips:闭包)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> count = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(count);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> s = <span class="title function_">add</span>();</span><br><span class="line"><span class="title function_">s</span>();</span><br><span class="line"><span class="title function_">s</span>();</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察闭包</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>如何阻止事件冒泡和默认事件</li>
<li>下面的问题打印什么</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">&quot;我是MT&quot;</span>;</span><br><span class="line"><span class="title function_">test</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br><span class="line">  <span class="keyword">var</span> str = <span class="string">&quot;哈哈哈&quot;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察变量声明和作用域</span></span><br><span class="line"><span class="literal">undefined</span> <span class="comment">//因为打印str时,首先从str所在的作用域找变量str,</span></span><br><span class="line"><span class="comment">//因为有声明前置,var str,但是未赋值,是undefined.所以不再从外部找str</span></span><br><span class="line">哈哈哈</span><br><span class="line">我是<span class="variable constant_">MT</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>什么是盒子模型</li>
<li>sessionStorage,localStorage 和 cookie 的区别</li>
<li>px 和 em 的区别</li>
<li>列举不同的清除浮动的技巧</li>
<li><code>display: none</code>和<code>visibility: hidden</code>的区别</li>
<li>组件中<code>&lt;style scoped&gt;</code>的<code>scoped</code>的作用.</li>
<li>v-show 和 v-if 的共同点和区别</li>
<li>vue 注册组件使用什么关键字</li>
<li>vue 如何实现父子组件通信</li>
<li>vue 的双向数据绑定原理是什么?</li>
</ol>
<h1 id="外包公司-2"><a href="#外包公司-2" class="headerlink" title="外包公司 2"></a>外包公司 2</h1><ol>
<li>使用 js 将数组: <code>[&#123; name: &quot;king&quot;, age: 18&#125;, &#123;name: &quot;bob&quot;, age: 22&#125;]</code>变成[18,22],并且筛选出大于 20 的值.</li>
<li>使用 js 获取页面一个 id 为 myP 的<code>&lt;p&gt;</code>标签,并为其增加点击事件,并说明一下 addEventLister 方法的第三个可选参数的冒泡和捕获.</li>
<li>控制台运行一下代码:</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br></pre></td></tr></table></figure>

<p>输出什么</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span> <span class="comment">//先执行for循环,i=1,有异步代码,封存数据,console.log(i).</span></span><br><span class="line"><span class="comment">//i=2,console.log(i)</span></span><br><span class="line"><span class="comment">//i=3,console.log(i)</span></span><br><span class="line"><span class="comment">//此时i的最终形态是3,执行最后一行的console.log(i),是3</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>个<span class="number">3</span> <span class="comment">//同步代码执行完,看任务队列中排着3个console.log(i),i=3,连续输出3个3</span></span><br></pre></td></tr></table></figure>
<h1 id="大钱"><a href="#大钱" class="headerlink" title="大钱"></a>大钱</h1><ol>
<li>写一个原生 ajax 请求</li>
<li>写几个常用的数组,字符串,对象的方法</li>
<li><code>npm install --save</code>和<code>npm install --save --dev</code>的区别</li>
<li>IE 与火狐的事件机制有什么区别?如何阻止冒泡?</li>
<li>什么是闭包? 闭包的用途</li>
<li>css3 动画最后一帧如何恢复到原样?</li>
<li>sessionStorage,localStorage 和 cookie 的区别?分别在什么时候用?</li>
<li>HTML5 新特性?移除那些?如何处理 HTML5 新标签的浏览器兼容问题?做过的项目中,那些 CSS 样式需要单独写兼容样式?</li>
<li>ES6 运算符…是用来做什么的?用 ES6 语法遍历一个数组.</li>
<li>px,em,rem 的区别</li>
<li>prototype 是什么?什么时候用</li>
<li>js 添加,移除,替换,删除,创建,查找节点的方法是什么</li>
<li>如何优化网站性能(js)</li>
<li>编写一个方法,去掉以下数组的重复元素</li>
<li>vue 如何监听一个对象的变化,写个例子</li>
<li>setTimeout,promise,async&#x2F;await 的区别</li>
<li>intercepter用在什么地方</li>
<li>路由拦截在什么地方</li>
<li>切换用户如何处理</li>
<li>用户不是提交验证进来而是输入url进来如何处理</li>
<li>组件里name的作用</li>
</ol>
<h1 id="外包公司-3"><a href="#外包公司-3" class="headerlink" title="外包公司 3"></a>外包公司 3</h1><ol>
<li>js 有哪些基本数据类型</li>
<li>var let const 的区别</li>
<li>数字计算: 在 js 中,0.1+0.2 的结果是?</li>
<li>下面代码有什么问题?(tips:闭包)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>test1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>test2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">li</span>&gt;</span>test3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">&lt;/ul&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"> <span class="keyword">var</span> lis = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;ul li&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"> <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;lis.<span class="property">length</span>; i++)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">     lis[i].<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">     &#125;,<span class="literal">false</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"> &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>无论点击哪个都会输出3<br>解决方法:<br>1.将var换成let<br>2. for循环改造</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;lis.<span class="property">length</span>; i++)&#123;</span><br><span class="line">    (<span class="keyword">function</span>(<span class="params">i</span>)&#123;lis[i].<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(i)</span><br><span class="line">    &#125;,<span class="literal">false</span>)&#125;)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>请写出下面输出结果,</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;,arr = [];</span><br><span class="line">(&#123; <span class="attr">foo</span>: obj.<span class="property">prop</span>, <span class="attr">bar</span>: arr[<span class="number">0</span>] &#125; = &#123; <span class="attr">foo</span>: <span class="number">123</span>, <span class="attr">bar</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj, arr);</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">prop</span>: <span class="number">123</span>;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="literal">true</span>];</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>promise 有几种状态,什么时候会进入 catch?</li>
<li>在 8*8 的国际象棋摆放八个皇后,使其不同相互攻击,即任意两个皇后不能处在同一行,同一列,同一对角线.总共有多少种摆法.</li>
<li>git 命令有哪些?</li>
</ol>
<h1 id="外包公司-4-才匠"><a href="#外包公司-4-才匠" class="headerlink" title="外包公司 4 才匠"></a>外包公司 4 才匠</h1><ol>
<li>下面代码的输出是什么?</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shape = &#123;</span><br><span class="line">  <span class="attr">radius</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="title function_">diameter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">radius</span> * <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">perimeter</span>: <span class="function">() =&gt;</span> <span class="number">2</span> * <span class="title class_">Math</span>.<span class="property">PI</span> * <span class="variable language_">this</span>.<span class="property">radius</span></span><br><span class="line">&#125;;</span><br><span class="line">shape.<span class="title function_">diameter</span>();</span><br><span class="line">shape.<span class="title function_">perimeter</span>();</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span></span><br><span class="line"><span class="title class_">NaN</span> <span class="comment">//考察箭头函数的this</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> c = &#123; <span class="attr">greeting</span>: <span class="string">&quot;hey&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> d;</span><br><span class="line">d = c;</span><br><span class="line">c.<span class="property">greeting</span> = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(d.<span class="property">greeting</span>);</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello <span class="comment">//考察引用类型的指针,或者说堆内存</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Chameleon</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">colorChange</span>(<span class="params">newColor</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newColor</span> = newColor;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">&#123; newColor = <span class="string">&quot;green&quot;</span> &#125; = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newColor</span> = newColor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> freddie = <span class="keyword">new</span> <span class="title class_">Chameleon</span>(&#123; <span class="attr">newColor</span>: <span class="string">&quot;purple&quot;</span> &#125;);</span><br><span class="line">freddie.<span class="title function_">colorChange</span>(<span class="string">&quot;orange&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察class中static的方法</span></span><br><span class="line"><span class="string">&quot;freddie.colorChange is not a function&quot;</span></span><br><span class="line"><span class="comment">//static不能在类的实例上调用</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">firstName, lastName</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">firstName</span> = firstName;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastName</span> = lastName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> member = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Lydia&quot;</span>, <span class="string">&quot;Hallie&quot;</span>);</span><br><span class="line"><span class="title class_">Person</span>.<span class="property">getFullName</span> = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">firstName</span> + <span class="variable language_">this</span>.<span class="property">lastName</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(member.<span class="title function_">getFullName</span>());</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察ES6中的class</span></span><br><span class="line"><span class="string">&quot;member.getFullName is not a function&quot;</span></span><br><span class="line"><span class="comment">//getFullName并没有写到Person的原型上,member并不能调用该函数</span></span><br><span class="line">解决办法:</span><br><span class="line"><span class="title class_">ES6</span>:</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">firstName, lastName</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">firstName</span> = firstName</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lastName</span> = lastName</span><br><span class="line">  &#125;</span><br><span class="line">  getFullName = <span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">firstName</span> + <span class="variable language_">this</span>.<span class="property">lastName</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> member = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Lydia&quot;</span>,<span class="string">&quot;Hallie&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(member.<span class="title function_">getFullName</span>())</span><br><span class="line"><span class="title class_">ES5</span>原型法:</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">firstName, lastName</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">firstName</span> = firstName;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastName</span> = lastName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getFullName</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">firstName</span> + <span class="variable language_">this</span>.<span class="property">lastName</span>;</span><br><span class="line">  &#125; <span class="comment">//这里不能用箭头函数,否则this指向window</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> member = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Lydia&quot;</span>, <span class="string">&quot;Hallie&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(member.<span class="title function_">getFullName</span>());</span><br></pre></td></tr></table></figure>
<ol start="5">
<li></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkAge</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (data === &#123; <span class="attr">age</span>: <span class="number">18</span> &#125;) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;you are an adult!&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">checkAge</span>(&#123; <span class="attr">age</span>: <span class="number">18</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察引用类型</span></span><br><span class="line">hh <span class="comment">//考点在&#123;age: 18&#125; === &#123;age: 18&#125;是否相等,</span></span><br><span class="line"><span class="comment">//两个不同的地址,所以不相等</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/16/%E4%B8%8A%E6%B5%B7%E5%85%AC%E5%8F%B8%E9%9D%A2%E8%AF%95%E9%A2%98/" data-id="cl9xpujro003ndmopfr8hfv54" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-头条面试题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/16/%E5%A4%B4%E6%9D%A1%E9%9D%A2%E8%AF%95%E9%A2%98/" class="article-date">
  <time datetime="2019-11-16T08:26:56.000Z" itemprop="datePublished">2019-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/16/%E5%A4%B4%E6%9D%A1%E9%9D%A2%E8%AF%95%E9%A2%98/">头条面试题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="第一套"><a href="#第一套" class="headerlink" title="第一套"></a>第一套</h1><ol>
<li><pre><code>替换元素与非替换元素,差异?
</code></pre>
<ol start="2">
<li><pre><code>offsetWidth,clientWidth,scrollwidth区别
</code></pre>
<ol start="3">
<li><pre><code>Dom标准事件模型是什么?是否所有的事件都支持冒泡?如果不是,举例说明.
</code></pre>
<ol start="4">
<li><pre><code>css选择器的优先级
</code></pre>
<ol start="5">
<li><pre><code>简述什么是IFC,作用
</code></pre>
<ol start="6">
<li><pre><code>用CSS实现自适应正方形
</code></pre>
<ol start="7">
<li><pre><code>`Http://toutiao.com`往`http://mp.toutiao.com`发`ajax`请求,跨域了吗?`mp.toutiao.com`的服务器可以收到请求吗,是怎样的请求?
</code></pre>
<ol start="8">
<li><pre><code>XSS和CRSF分别是什么?有什么联系?如何防御?
</code></pre>
<ol start="9">
<li><pre><code>关于js Bridge
</code></pre>
<ol>
<li><pre><code>是什么?
</code></pre>
<ol start="2">
<li><pre><code>实现原理
</code></pre>
<ol start="3">
<li><pre><code>优化方案
</code></pre>
<ol start="10">
<li><pre><code>TCP/UDP是什么?有什么区别?如何进行拥塞控制?
</code></pre>
<ol start="11">
<li><pre><code>请用算法实现.从给定的无序,不重复的数组A中,取出N个数,使其相加和为M.并给出算法的时间空间复杂度.
</code></pre>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h1 id="第二套"><a href="#第二套" class="headerlink" title="第二套"></a>第二套</h1><ol>
<li><pre><code>ES5和ES6的继承有什么区别?
</code></pre>
<ol start="2">
<li><pre><code>Web动画的几种常见方式
</code></pre>
<ol start="3">
<li><pre><code>POST提交数据的几种常见content-type
</code></pre>
<ol start="4">
<li><pre><code>如何定义一个方法,通过调用把视频的一帧生产预览图
</code></pre>
<ol start="5">
<li><pre><code>什么是重放攻击,列举几个防御手段.
</code></pre>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="编程题"><a href="#编程题" class="headerlink" title="编程题"></a>编程题</h2><ol>
<li><pre><code>实现一个函数sum,运算结果满足如下预期结果:
</code></pre>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>	<span class="title function_">sum</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>).<span class="title function_">valueof</span>(); <span class="comment">//6</span></span><br><span class="line"><span class="number">2.</span>	<span class="title function_">sum</span>(<span class="number">2</span>,<span class="number">3</span>)(<span class="number">2</span>).<span class="title function_">valueof</span>(); <span class="comment">//7</span></span><br><span class="line"><span class="number">3.</span>	<span class="title function_">sum</span>(<span class="number">1</span>)(<span class="number">2</span>)(<span class="number">3</span>)(<span class="number">4</span>).<span class="title function_">valueof</span>(); <span class="comment">//10</span></span><br><span class="line"><span class="number">4.</span>	<span class="title function_">sum</span>(<span class="number">2</span>)(<span class="number">4</span>,<span class="number">1</span>)(<span class="number">2</span>).<span class="title function_">valueof</span>(); <span class="comment">//9</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li><pre><code>实现一个优先队列,使得可以这样使用.
</code></pre>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>	<span class="title class_">Const</span> priorityQuene = <span class="keyword">new</span> <span class="title class_">PriorityQuene</span>()</span><br><span class="line"><span class="number">2.</span>	priorityQuene.<span class="title function_">enquene</span>(‘优先级<span class="number">2</span>-<span class="number">1</span>’,<span class="number">2</span>)’</span><br><span class="line"><span class="number">3.</span>	priorityQuene.<span class="title function_">enquene</span>(‘优先级<span class="number">1</span>-<span class="number">1</span>’,<span class="number">1</span>)’</span><br><span class="line"><span class="number">4.</span>	priorityQuene.<span class="title function_">enquene</span>(‘优先级<span class="number">1</span>-<span class="number">2</span>’,<span class="number">1</span>)’</span><br><span class="line"><span class="number">5.</span>	priorityQuene.<span class="title function_">enquene</span>(‘优先级<span class="number">3</span>-<span class="number">1</span>’,<span class="number">3</span>)’</span><br><span class="line"><span class="number">6.</span>	priorityQuene.<span class="title function_">enquene</span>(‘优先级<span class="number">2</span>-<span class="number">2</span>’,<span class="number">2</span>)’</span><br><span class="line"><span class="number">7.</span>	priorityQuene.<span class="title function_">enquene</span>(‘优先级<span class="number">1</span>-<span class="number">3</span>’,<span class="number">1</span>)’</span><br><span class="line"><span class="number">8.</span>	priorityQuene..<span class="title function_">print</span>(); <span class="comment">//按优先级顺序输出</span></span><br><span class="line"><span class="number">9.</span>	priorityQuene.<span class="title function_">dequene</span>(); <span class="comment">//出队</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li><pre><code>硬币找零问题:
</code></pre>
有面额为d1…dn的硬币,和要找零的钱数,找出所需最小硬币个数的方案,<br>例如,美国有以下面额的硬币: d1&#x3D;1,d2&#x3D;5,d3&#x3D;10,d4&#x3D;25.如果要找36美分.,所需最少硬币是[1,10,25],即满足如下输出:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> miniCoinChange = <span class="keyword">new</span> <span class="title class_">MinCoinChange</span>(<span class="number">1</span>,<span class="number">5</span>,<span class="number">10</span>,<span class="number">25</span>));</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(minCoinChange.<span class="title function_">makeChange</span>(<span class="number">36</span>)) <span class="comment">//[1,10,25]</span></span><br><span class="line"><span class="keyword">const</span> minCoinChange2 = <span class="keyword">new</span> <span class="title class_">MinCoinChange</span>([<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(minCoinChange2.<span class="title function_">makeChange</span>(<span class="number">6</span>); <span class="comment">//[3,3]</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/16/%E5%A4%B4%E6%9D%A1%E9%9D%A2%E8%AF%95%E9%A2%98/" data-id="cl9xpujry0049dmopen1341xt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-photoshop切图" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/27/photoshop%E5%88%87%E5%9B%BE/" class="article-date">
  <time datetime="2019-10-27T08:08:59.000Z" itemprop="datePublished">2019-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/27/photoshop%E5%88%87%E5%9B%BE/">photoshop切图</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="新建图层"><a href="#新建图层" class="headerlink" title="新建图层"></a>新建图层</h1><p>建议背景图层透明.<br>移动工具: 快捷键<code>V</code><br>按住<code>Ctrl</code>,自动选择图层.<br>放大缩小: <code>Alt+滚轮</code></p>
<h1 id="界面设置"><a href="#界面设置" class="headerlink" title="界面设置"></a>界面设置</h1><p>视图设置:</p>
<ol>
<li>智能参考线</li>
<li>标尺(<code>ctrl+R</code>)</li>
</ol>
<p>##窗口设置</p>
<ol>
<li>信息</li>
<li>字符</li>
<li>历史记录</li>
</ol>
<p>修改信息-面板选项<br>        |-鼠标坐标单位-像素<br>        |-第一颜色信息-RGB颜色<br>        |-第二颜色信息-RGB颜色<br>        |-状态信息-文档尺寸</p>
<h2 id="编辑设置"><a href="#编辑设置" class="headerlink" title="编辑设置"></a>编辑设置</h2><p>首选项-单位与标尺-标尺,文字改为像素</p>
<h2 id="格局"><a href="#格局" class="headerlink" title="格局"></a>格局</h2><ol>
<li>图层和历史记录</li>
<li>信息和字符</li>
</ol>
<h2 id="保存为web切图"><a href="#保存为web切图" class="headerlink" title="保存为web切图"></a>保存为web切图</h2><p>窗口-工作区-新建工作区-web切图</p>
<h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="套索工具L"><a href="#套索工具L" class="headerlink" title="套索工具L"></a>套索工具<code>L</code></h2><p>放大<code>Ctrl+ +</code><br>缩小<code>Ctrl+ -</code><br>按住空格键拖动<br>按住<code>shift</code>键: 增加选区<br>按住<code>alt</code>键: 删除选区</p>
<h3 id="磁性套索工具L"><a href="#磁性套索工具L" class="headerlink" title="磁性套索工具L"></a>磁性套索工具<code>L</code></h3><p>可以吸附到同颜色区域边界.<br>多余地方可以按住<code>shfit</code>或者<code>alt</code>进行增删</p>
<h2 id="快速选择工具W"><a href="#快速选择工具W" class="headerlink" title="快速选择工具W"></a>快速选择工具<code>W</code></h2><p>可以快速选择相同颜色区块<br>画笔大小快捷键:<code>[]</code></p>
<h2 id="魔棒工具W"><a href="#魔棒工具W" class="headerlink" title="魔棒工具W"></a>魔棒工具<code>W</code></h2><p>类似于快速选择工具</p>
<h2 id="裁剪工具C"><a href="#裁剪工具C" class="headerlink" title="裁剪工具C"></a>裁剪工具<code>C</code></h2><p>使用魔棒工具或快速选择工具选取一块区域,直接按裁剪工具,然后回车,可快速裁剪出所选区域.<br>此时,按住Alt,点击当前图层的眼睛图标,可隐藏其他图层,只保留当前图层.即显影模式.<br>裁剪工具时,按住<code>Alt</code>,点击所选图案,可以让图案成为中心.</p>
<h2 id="吸管工具I"><a href="#吸管工具I" class="headerlink" title="吸管工具I"></a>吸管工具I</h2><p>选取当前颜色,<br>前景色填充<code>Alt+Delete</code><br>背景色填充<code>Ctrl+Delete</code></p>
<h1 id="污点修复画笔工具J"><a href="#污点修复画笔工具J" class="headerlink" title="污点修复画笔工具J"></a>污点修复画笔工具J</h1><p>选取周围的颜色覆盖选取区域的颜色.比如照片中黑点会被抹除.</p>
<h2 id="修复画笔工具"><a href="#修复画笔工具" class="headerlink" title="修复画笔工具"></a>修复画笔工具</h2><p>按住<code>Alt</code>键单击左键选取要复制的区域,在其他区域就可以复制过去.</p>
<h2 id="修补工具"><a href="#修补工具" class="headerlink" title="修补工具"></a>修补工具</h2><p>画出一个选取,将选取拖动到想要使用修补的地方进行替换修补.</p>
<h1 id="仿制图章工具"><a href="#仿制图章工具" class="headerlink" title="仿制图章工具"></a>仿制图章工具</h1><p>类似于修复画笔工具,双击选取要复制的点,在其他地方可以复制出来.与 修复画笔工具区别是,修复画笔工具复制出来的有羽化效果.</p>
<h2 id="图案图章工具"><a href="#图案图章工具" class="headerlink" title="图案图章工具"></a>图案图章工具</h2><p>有可选择的备用图案,作用类似于打马赛克.</p>
<h1 id="历史记录画笔工具Y"><a href="#历史记录画笔工具Y" class="headerlink" title="历史记录画笔工具Y"></a>历史记录画笔工具Y</h1><p>作用类似于祛斑.先用高斯模糊将照片模糊到没有斑点.再将画笔圆记录到历史记录的高斯模糊这一步,再回到原图,使用该画笔圆进行处理.</p>
<h1 id="渐变"><a href="#渐变" class="headerlink" title="渐变"></a>渐变</h1><p>渐变颜色方向是顺时针</p>
<h1 id="文字"><a href="#文字" class="headerlink" title="文字"></a>文字</h1><p>双击空白区域,即可写字.按住Ctrl可以拖动区域大小,Alt也可以拖动.</p>
<h1 id="抓手工具H"><a href="#抓手工具H" class="headerlink" title="抓手工具H"></a>抓手工具H</h1><p>按住<code>Alt</code>缩小,按住<code>shift</code>放大.</p>
<h1 id="图层"><a href="#图层" class="headerlink" title="图层"></a>图层</h1><h2 id="奥运五环"><a href="#奥运五环" class="headerlink" title="奥运五环"></a>奥运五环</h2><ol>
<li>新建文件,背景色为白色.</li>
<li>右下角新建图层.</li>
<li>使用椭圆选区工具<code>M</code>,按住<code>shift</code>(有的是<code>alt</code>),拉出一个标准圆.</li>
<li>使用吸管工具<code>I</code>,点击拾色器,选择颜色,确定.使用快捷键<code>Alt+Delete</code>填充圆形选区的颜色.</li>
<li>使用选区工具<code>M</code>,右键变化选区,按住<code>Alt</code>进行同心圆的缩小.右上角对号确定.按下<code>delete</code>删除内圆,得到圆环.</li>
<li><code>Ctrl+ T</code>自由变换,进行调整.</li>
<li>使用移动工具<code>V</code>,按住<code>Alt</code>进行拖动,即复制一张图层.</li>
<li>在右下角图层菜单中,双击图层名,进行重命名.</li>
<li>选取复制图层,按住<code>Ctrl</code>单击图层菜单中缩略图.选择颜色,<code>Alt+Delete</code>填充颜色.</li>
<li>按<code>M</code>使用选区后,单击空白就结束选区了.</li>
<li>删除覆盖在黄色上的蓝色,按住<code>Ctrl</code>,单击蓝色图层的缩略图,选中蓝色选区,</li>
<li>使用选区工具<code>M</code>,点击黄色图层,按住<code>Alt</code>选取要排除的区块(因为此时要删掉黄色图层上的两小块区域,而选区是蓝色选区,排除掉保留的蓝色,剩下的就是要真正删除的蓝色小块了),按<code>Delete</code>删除,就出现交叉效果了.</li>
</ol>
<h1 id="参考线"><a href="#参考线" class="headerlink" title="参考线"></a>参考线</h1><ol>
<li>视图-新建参考线(按住<code>Alt</code>,依次按<code>V+E</code>)</li>
<li><code>Ctrl+R</code>调出标尺,切换到移动工具<code>V</code>,然后从标尺处拖出参考线.</li>
</ol>
<p>参考线切换: 拉动参考线,按住<code>Alt</code>.</p>
<h2 id="参考线初始化"><a href="#参考线初始化" class="headerlink" title="参考线初始化"></a>参考线初始化</h2><p>通用页面像素一般是1920*1080,页面内容一般占1200,两侧留白共720px<br>起始左侧线可设置为360px,右侧线设置为1560px.</p>
<h2 id="隐藏参考线"><a href="#隐藏参考线" class="headerlink" title="隐藏参考线"></a>隐藏参考线</h2><p>快捷键: <code>Ctrl+ ;</code></p>
<h1 id="切图"><a href="#切图" class="headerlink" title="切图"></a>切图</h1><h2 id="传统切图"><a href="#传统切图" class="headerlink" title="传统切图"></a>传统切图</h2><p>裁剪工具<code>C</code>-切片工具</p>
<h2 id="参考线辅助切图"><a href="#参考线辅助切图" class="headerlink" title="参考线辅助切图"></a>参考线辅助切图</h2><p>先设置参考线,再点击切片工具<code>C</code>,上面菜单基于参考线切片.<br>通过删除多余切片将零碎切片合并为一个切片.<br>文件-存储为web所用格式,一般格式为PNG-24.</p>
<blockquote>
<p>建议将大图裁剪成多份,然后使用参考线切片.</p>
</blockquote>
<h2 id="精准切图"><a href="#精准切图" class="headerlink" title="精准切图"></a>精准切图</h2><p>文件-脚本-将图层导出到文件-文件类型-PNG24-全部打√<br>文件-导出-将图层导出导出到文件-文件类型-PNG24-全部打√<br>(因为软件版本不同,可能命令不在上述中,上述是同一命令的两个位置)<br>选择导出目录,运行</p>
<h1 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h1><p>将整个图层切成一个图<br>编辑-首选项-增效工具-启动生成器打√<br>文件-生成-图像资源</p>
<h1 id="抠图"><a href="#抠图" class="headerlink" title="抠图"></a>抠图</h1><p>先打开图片,<br>图层-新建图层-新建图层背景<br>图像-画布大小<br><code>Ctrl+T</code>选中图片,<code>Alt</code>进行比例放大<br><code>Ctrl+ X</code>可以把选取内不需要的内容删掉<br>导出-快速导出PNG即可.</p>
<h1 id="描白边"><a href="#描白边" class="headerlink" title="描白边"></a>描白边</h1><p>使用魔棒选取大部分边缘,使用选区工具进行修补.<br>编辑-描边-白色-5px左右,外部<br>使用魔棒点击外部区域,选择反向,就选中了包含白边的区域.<br>此时可以使用编辑-填充-黑色,就出现纯黑背景的白边图片了.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/27/photoshop%E5%88%87%E5%9B%BE/" data-id="cl9xpujrf002ydmopa2iqhhuu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-滚动阅读" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/25/%E6%BB%9A%E5%8A%A8%E9%98%85%E8%AF%BB/" class="article-date">
  <time datetime="2019-10-25T12:04:22.000Z" itemprop="datePublished">2019-10-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/25/%E6%BB%9A%E5%8A%A8%E9%98%85%E8%AF%BB/">滚动阅读</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="初步构思"><a href="#初步构思" class="headerlink" title="初步构思"></a>初步构思</h1><ol>
<li>定时任务启动</li>
<li>滑到面板桌面(从常规桌面上滑)</li>
<li>点击礼盒图标(右上角,测量位置)</li>
<li>点击完成相关任务(位置)</li>
<li>自动唤醒京东读书app</li>
<li>点击图书(位置)</li>
<li>自动翻页(swipe)</li>
<li>完成后返回打卡页面</li>
<li>点击完成打卡(位置)</li>
</ol>
<p>新增: </p>
<ol>
<li>时间统计(共阅读了多久)</li>
<li>页数统计(共阅读了多少页)</li>
</ol>
<h1 id="防检测"><a href="#防检测" class="headerlink" title="防检测"></a>防检测</h1><p>自动翻页位置</p>
<ol>
<li>滑动翻页(swipe) Math.random</li>
<li>点击翻页(touch),时间和位置都随机</li>
<li>映射音量键翻页</li>
</ol>
<p>该机分辨率为1440*720<br>下一页触摸区域在x(480-720),y(0-1440)</p>
<p>规则:<br>30分钟阅读300页,则每分钟阅读10页,至少6秒阅读完一页.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6000</span> * (<span class="title class_">Math</span>.<span class="title function_">random</span>() + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>每页最少6秒,最多12秒不到.<br>每300页最少30分钟.最多60分钟不到.</p>
<h1 id="随机时间"><a href="#随机时间" class="headerlink" title="随机时间"></a>随机时间</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> initTime = <span class="number">6000</span> * (<span class="title class_">Math</span>.<span class="title function_">random</span>() + <span class="number">0.33333</span>)</span><br><span class="line"><span class="keyword">if</span>(initTime &lt; <span class="number">6000</span>)&#123;</span><br><span class="line">    initTime += <span class="number">4000</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">iTime</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> initTime = <span class="number">6000</span> * ( <span class="title class_">Math</span>.<span class="title function_">random</span>()+ <span class="number">0.33333</span>)</span><br><span class="line"><span class="keyword">if</span>(initTime &lt; <span class="number">6000</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> initTime += <span class="number">4000</span></span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">return</span> initTime</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">iTime</span>()</span><br></pre></td></tr></table></figure>
<p>每页最少2秒,最多8秒不到.<br>每300页最少不到16分钟.最多40分钟不到.</p>
<h1 id="定时运行脚本"><a href="#定时运行脚本" class="headerlink" title="定时运行脚本"></a>定时运行脚本</h1><p>点击脚本右边的菜单按钮-&gt;更多-&gt;定时任务设置定时运行脚本.注意<strong>必须保持Auto.js后台运行(自启动白名单、电源管理白名单等),不可加锁屏密码</strong>.</p>
<p>脚本的开头使用device.wakeUp()来唤醒屏幕</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//# 启动app</span></span><br><span class="line">app.<span class="title function_">launchApp</span>(<span class="string">&quot;京东读书&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//暂停运行5秒</span></span><br><span class="line"><span class="title function_">sleep</span>(<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>
<h1 id="气泡信息toast-message"><a href="#气泡信息toast-message" class="headerlink" title="气泡信息toast(message)"></a>气泡信息<code>toast(message)</code></h1><p>注意，信息的显示是”异步”执行的，并且，不会等待信息消失程序才继续执行。如果在循环中执行该命令，可能出现脚本停止运行后仍然有不断的气泡信息出现的情况</p>
<p>官方貌似说了会实时显示进度,那么下面的统计就不需要了.<br>这里可以显示已经看了几页(估计得写个函数),看具体是怎么翻页了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果触发一次,就次数<span class="string">`total += 1`</span></span><br><span class="line"><span class="keyword">if</span>(total == <span class="number">300</span>)&#123;</span><br><span class="line">    <span class="comment">//toast(&#x27;看完300页了,准备打卡去&#x27;)</span></span><br><span class="line">    <span class="comment">//建议此时不停,不知道时间够不够,继续刷一会</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(total &gt;=<span class="number">300</span> &amp;&amp; totalTime &gt;= <span class="number">30</span>*<span class="number">6000</span>)&#123;</span><br><span class="line">    <span class="comment">//条件满足,停止刷页</span></span><br><span class="line">    <span class="title function_">stop</span>()</span><br><span class="line">    <span class="comment">//跳转打卡页面</span></span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//继续刷页</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="立即停止exit"><a href="#立即停止exit" class="headerlink" title="立即停止exit()"></a>立即停止<code>exit()</code></h1><h1 id="console-show"><a href="#console-show" class="headerlink" title="console.show()"></a><code>console.show()</code></h1><p>显示控制台。这会显示一个控制台的悬浮窗(需要悬浮窗权限)。</p>
<h2 id="print-text"><a href="#print-text" class="headerlink" title="print(text)"></a><code>print(text)</code></h2><p><code>text &#123;string&#125; | &#123;Object&#125; </code>要打印到控制台的信息,相当于log(text)。</p>
<h1 id="基于坐标的触摸模拟"><a href="#基于坐标的触摸模拟" class="headerlink" title="基于坐标的触摸模拟"></a>基于坐标的触摸模拟</h1><p>要获取要点击的位置的坐标，可以在开发者选项中开启”指针位置”。</p>
<h2 id="setScreenMetrics-width-height"><a href="#setScreenMetrics-width-height" class="headerlink" title="setScreenMetrics(width, height)"></a>setScreenMetrics(width, height)</h2><p>设置脚本坐标点击所适合的屏幕宽高.<br>如果脚本运行时，屏幕宽度不一致会自动放缩坐标.</p>
<h1 id="安卓7-0以上的触摸和手势模拟"><a href="#安卓7-0以上的触摸和手势模拟" class="headerlink" title="安卓7.0以上的触摸和手势模拟"></a>安卓7.0以上的触摸和手势模拟</h1><h2 id="click-x-y"><a href="#click-x-y" class="headerlink" title="click(x, y)"></a>click(x, y)</h2><p>模拟点击坐标(x, y)，并返回是否点击成功。只有在点击执行完成后脚本才继续执行。<br>使用该函数模拟连续点击时可能有点击速度过慢的问题，这时可以用<code>press()</code>函数代替。</p>
<h2 id="press-x-y-duration"><a href="#press-x-y-duration" class="headerlink" title="press(x, y, duration)"></a>press(x, y, duration)</h2><p><code>duration: &#123;number&#125;</code> 按住时长，单位毫秒<br>模拟按住坐标(x, y), 并返回是否成功。只有按住操作执行完成时脚本才会继续执行。<br>如果按住时间过短，那么会被系统认为是点击；如果时长超过500毫秒，则认为是长按。</p>
<h2 id="swipe-x1-y1-x2-y2-duration"><a href="#swipe-x1-y1-x2-y2-duration" class="headerlink" title="swipe(x1, y1, x2, y2, duration)"></a>swipe(x1, y1, x2, y2, duration)</h2><p><code>x1</code> {number} 滑动的起始坐标的x值<br><code>y1</code> {number} 滑动的起始坐标的y值<br><code>x2</code> {number} 滑动的结束坐标的x值<br><code>y2</code> {number} 滑动的结束坐标的y值<br><code>duration</code> {number} 滑动时长，单位毫秒<br>模拟从坐标(x1, y1)滑动到坐标(x2, y2)，并返回是否成功。只有滑动操作执行完成时脚本才会继续执行。</p>
<h1 id="随机数random"><a href="#随机数random" class="headerlink" title="随机数random"></a>随机数random</h1><h1 id="random-min-max"><a href="#random-min-max" class="headerlink" title="random(min, max)"></a>random(min, max)</h1><p><code>min</code> {number} 随机数产生的区间下界<br><code>max</code> {number} 随机数产生的区间上界<br>返回 {number}<br>返回一个在<code>[min...max]</code>之间的随机数(正整数)。例如<code>random(0, 2)</code>可能产生0, 1, 2。</p>
<h2 id="random"><a href="#random" class="headerlink" title="random()"></a>random()</h2><p>返回 {number}<br>返回在[0, 1)的随机浮点数。</p>
<h1 id="device-wakeUp"><a href="#device-wakeUp" class="headerlink" title="device.wakeUp()"></a>device.wakeUp()</h1><p>唤醒设备。包括唤醒设备CPU、屏幕等。可以用来点亮屏幕。</p>
<h2 id="device-wakeUpIfNeeded"><a href="#device-wakeUpIfNeeded" class="headerlink" title="device.wakeUpIfNeeded()"></a>device.wakeUpIfNeeded()</h2><p>如果屏幕没有点亮，则唤醒设备。</p>
<h1 id="按键模拟"><a href="#按键模拟" class="headerlink" title="按键模拟"></a>按键模拟</h1><p>实体按键模拟依赖root权限,故放弃.</p>
<h1 id="基于控件的操作"><a href="#基于控件的操作" class="headerlink" title="基于控件的操作"></a>基于控件的操作</h1><p>推荐使用<code>auto()</code>函数来确保无障碍服务已启用.</p>
<h1 id="auto-mode"><a href="#auto-mode" class="headerlink" title="auto([mode])"></a>auto([mode])</h1><p>检查无障碍服务是否已经启用，如果没有启用则抛出异常并跳转到无障碍服务启用界面；同时设置无障碍模式为mode。<br>如果不加mode参数，则为正常模式。<br>建议使用<code>auto.waitFor()</code>和<code>auto.setMode()</code>代替该函数，因为<code>auto()</code>函数如果无障碍服务未启动会停止脚本；而<code>auto.waitFor()</code>则会在在无障碍服务启动后继续运行。</p>
<h2 id="auto-waitFor"><a href="#auto-waitFor" class="headerlink" title="auto.waitFor()"></a>auto.waitFor()</h2><p>检查无障碍服务是否已经启用，如果没有启用则跳转到无障碍服务启用界面，并等待无障碍服务启动；当无障碍服务启动后脚本会继续运行。</p>
<h1 id="点击文本click-text-i"><a href="#点击文本click-text-i" class="headerlink" title="点击文本click(text[, i])"></a>点击文本<code>click(text[, i])</code></h1><p><code>text</code> {string} 要点击的文本<br><code>i</code> {number} 如果相同的文本在屏幕中出现多次，则i表示要点击第几个文本, i从0开始计算<br>该函数可以点击大部分包含文字的按钮。例如微信主界面下方的”微信”, “联系人”, “发现”, “我”的按钮。<br>通常与while同时使用以便点击按钮直至成功。例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!<span class="title function_">click</span>(<span class="string">&quot;扫一扫&quot;</span>));</span><br></pre></td></tr></table></figure>

<h1 id="UiSelector-exists"><a href="#UiSelector-exists" class="headerlink" title="UiSelector.exists()"></a>UiSelector.exists()</h1><p>返回 {Boolean}<br>判断屏幕上是否存在控件符合选择器所确定的条件。<br>例如要判断某个文本出现就执行某个动作，可以用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_">text</span>(<span class="string">&quot;某个文本&quot;</span>).<span class="title function_">exists</span>())&#123;</span><br><span class="line">    <span class="comment">//要支持的动作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="暂停sleep"><a href="#暂停sleep" class="headerlink" title="暂停sleep()"></a>暂停sleep()</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//暂停1秒</span></span><br><span class="line"><span class="title function_">sleep</span>(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<h1 id="选取控件"><a href="#选取控件" class="headerlink" title="选取控件"></a>选取控件</h1><p>一般软件的界面是由一个个控件构成的，例如图片部分是一个图片控件(ImageView)，文字部分是一个文字控件(TextView)；同时，通过各种布局来决定各个控件的位置，例如，线性布局(LinearLayout)里面的控件都是按水平或垂直一次叠放的，列表布局(AbsListView)则是以列表的形式显示控件。<br>控件有各种属性，包括文本(text), 描述(desc), 类名(className), id等等。我们通常用一个控件的属性来找到这个控件，例如，想要点击QQ聊天窗口的”发送”按钮，我们就可以通过他的文本属性为”发送”来找到这个控件并点击他，具体代码为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sendButton = <span class="title function_">text</span>(<span class="string">&quot;发送&quot;</span>).<span class="title function_">findOne</span>();</span><br><span class="line">sendButton.<span class="title function_">click</span>();</span><br></pre></td></tr></table></figure>
<p>在这个例子中, text(“发送”)表示一个条件(文本属性为”发送”)，findOne()表示基于这个条件找到一个符合条件的控件，从而我们可以得到发送按钮sendButton，再执行sendButton.click()即可点击”发送”按钮。</p>
<p>果一个控件是图片控件.我们注意到这个图标的desc(描述)属性为”搜索”，那么我们就可以通过desc属性来定位这个控件，得到点击搜索图标的代码为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">desc</span>(<span class="string">&quot;搜索&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>();</span><br></pre></td></tr></table></figure>
<p>另外，对于这个搜索图标而言，id属性也是唯一的，我们也可以用id(“action_search”).findOne().click()来点击这个控件。如果一个控件有id属性，那么这个属性很可能是唯一的.</p>
<p>i_reader_folder</p>
<h1 id="定时器Timers"><a href="#定时器Timers" class="headerlink" title="定时器Timers"></a>定时器Timers</h1><h2 id="setTimeout"><a href="#setTimeout" class="headerlink" title="setTimeout()"></a>setTimeout()</h2><p>与web端用法一致.但是使用了一个不同的内部实现，它是基于 Android Looper-Handler消息循环机制构建的。其实现机制与Node.js比较相似.</p>
<h2 id="setInterval-callback-delay-…args"><a href="#setInterval-callback-delay-…args" class="headerlink" title="setInterval(callback, delay[,…args])"></a>setInterval(callback, delay[,…args])</h2><p>callback {Function} 当定时器到点时要调用的函数。<br>delay {number} 调用 callback 之前要等待的毫秒数。<br>…args {any} 当调用 callback 时要传入的可选参数。</p>
<p>因为定时器是异步执行,另外delay只能是number,那么不采用这种方案.</p>
<h1 id="刷页函数"><a href="#刷页函数" class="headerlink" title="刷页函数"></a>刷页函数</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">turnPage</span>(<span class="params"></span>)&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>先打开京东读书,登录账号<br>点击书城-免费-点击一本书-加入书架-(多加几本)</p>
<h1 id="方案一-点击翻页"><a href="#方案一-点击翻页" class="headerlink" title="方案一: 点击翻页"></a>方案一: 点击翻页</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检查无障碍服务开启情况</span></span><br><span class="line">auto.<span class="title function_">waitFor</span>()</span><br><span class="line"><span class="comment">//显示控制台</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">show</span>()</span><br><span class="line"><span class="comment">//设置脚本适合的宽高</span></span><br><span class="line"><span class="title function_">setScreenMetrics</span>(<span class="number">720</span>, <span class="number">1440</span>)</span><br><span class="line"><span class="comment">//打开京东读书app</span></span><br><span class="line">app.<span class="title function_">launchApp</span>(<span class="string">&quot;京东读书&quot;</span>)</span><br><span class="line"><span class="title function_">toast</span>(<span class="string">&quot;开始打卡&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待启动</span></span><br><span class="line"><span class="title function_">sleep</span>(<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//跳过</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_">text</span>(<span class="string">&quot;跳过&quot;</span>).<span class="title function_">exists</span>())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    <span class="title function_">text</span>(<span class="string">&quot;跳过&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">    <span class="title function_">sleep</span>(<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测升级</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_">text</span>(<span class="string">&quot;下次再说&quot;</span>).<span class="title function_">exists</span>())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    <span class="title function_">text</span>(<span class="string">&quot;下次再说&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">    <span class="title function_">sleep</span>(<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//点击控件,跳转书架</span></span><br><span class="line"><span class="title function_">id</span>(<span class="string">&quot;main_tab_bookshelf&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line"><span class="title function_">sleep</span>(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//准备开始图书</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//随机时间</span></span><br><span class="line"><span class="keyword">var</span> initTime = <span class="number">6000</span> * (<span class="title class_">Math</span>.<span class="title function_">random</span>() + <span class="number">0.33333</span>)</span><br><span class="line"><span class="keyword">if</span>(initTime &lt; <span class="number">6000</span>)&#123;</span><br><span class="line">    initTime += <span class="number">4000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="这里有问题"><a href="#这里有问题" class="headerlink" title="这里有问题"></a>这里有问题</h1><p>应该阅读到末尾结束,出现关闭阅读.点击关闭阅读.删除第一本.重新打开一本,开始阅读.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//已读完时,左上角出现关闭阅读</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_">text</span>(<span class="string">&quot;关闭阅读&quot;</span>).<span class="title function_">exists</span>())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    <span class="title function_">text</span>(<span class="string">&quot;关闭阅读&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">    <span class="title function_">sleep</span>(<span class="number">2000</span>)</span><br><span class="line">    <span class="comment">//长按第一本书,左下角删除,弹出确认删除,点击第二个删除.sleep(2000),右上角完成,继续阅读()</span></span><br><span class="line">    <span class="keyword">let</span> index</span><br><span class="line">    <span class="title function_">deleteBook</span>()</span><br><span class="line">    <span class="comment">//继续阅读</span></span><br><span class="line">    <span class="comment">//删掉之后,加上已阅读200页,重新开始,又会阅读300页.</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">index</span> = index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title function_">readBook</span>()</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//执行自动阅读</span></span><br><span class="line">    <span class="title function_">readBook</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开始阅读-阅读完-跳出阅读-删除-重新开始阅读</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行阅读主步骤</span></span><br><span class="line"><span class="title function_">mianStep</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mianStep</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">readeBook</span>()</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">text</span>(<span class="string">&quot;关闭阅读&quot;</span>).<span class="title function_">exists</span>())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    <span class="title function_">text</span>(<span class="string">&quot;关闭阅读&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">    <span class="title function_">sleep</span>(<span class="number">2000</span>)</span><br><span class="line">    <span class="comment">//长按第一本书,左下角删除,弹出确认删除,点击第二个删除.sleep(2000),右上角完成,继续阅读()</span></span><br><span class="line">    <span class="keyword">let</span> index</span><br><span class="line">    <span class="title function_">deleteBook</span>()</span><br><span class="line">    <span class="comment">//继续阅读</span></span><br><span class="line">    <span class="comment">//删掉之后,加上已阅读200页,重新开始,又会阅读300页.</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">index</span> = i</span><br><span class="line">    <span class="title function_">mianStep</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动阅读</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">readBook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title function_">toast</span>(<span class="string">&quot;开始阅读&quot;</span>)</span><br><span class="line">    <span class="comment">//选择第一本</span></span><br><span class="line">    <span class="title function_">id</span>(<span class="string">&quot;i_reader_folder&quot;</span>).<span class="title function_">indexInParent</span>(<span class="number">0</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">    <span class="title function_">sleep</span>(<span class="number">3000</span>)</span><br><span class="line">    <span class="comment">//执行点击</span></span><br><span class="line">    <span class="title function_">clickPage</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//点击阅读</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clickPages</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//点击300页</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> &#123;i=<span class="number">0</span>&#125;=index; i&lt;<span class="number">300</span>; i++)&#123;</span><br><span class="line">    <span class="title function_">randomClick</span>()</span><br><span class="line">    <span class="comment">//间隔时间</span></span><br><span class="line">    <span class="title function_">sleep</span>(initTime)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器版</span></span><br><span class="line"><span class="comment">// for(var i=0; i&lt;5; i++)&#123;</span></span><br><span class="line"><span class="comment">//     setTimeout(randomClick(),initTime)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//随机点坐标</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">randomClick</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="comment">//随机坐标,各缩减20px,防止误触</span></span><br><span class="line">x = <span class="title function_">random</span>(<span class="number">500</span>, <span class="number">700</span>)</span><br><span class="line">y = <span class="title function_">random</span>(<span class="number">20</span>, <span class="number">1420</span>)</span><br><span class="line"><span class="comment">//点击随机坐标区域翻页</span></span><br><span class="line"><span class="title function_">click</span>(x, y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//删除已读数目</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">deleteBook</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//长按图书,坐标就是第一本书的位置</span></span><br><span class="line">    <span class="comment">//press(x, y, 1500)</span></span><br><span class="line">    <span class="title function_">id</span>(<span class="string">&quot;i_reader_folder&quot;</span>).<span class="title function_">indexInParent</span>(<span class="number">0</span>).<span class="title function_">findOne</span>().<span class="title function_">longClick</span>()</span><br><span class="line">    <span class="comment">//删除图书</span></span><br><span class="line">    <span class="title function_">text</span>(<span class="string">&quot;删除&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">    <span class="comment">//要确认删除了</span></span><br><span class="line">    <span class="title function_">id</span>(<span class="string">&quot;confirm&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">    <span class="comment">//右上角完成</span></span><br><span class="line">    <span class="title function_">text</span>(<span class="string">&quot;完成&quot;</span>).<span class="title function_">findOne</span>().<span class="title function_">click</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//点击打卡文本</span></span><br><span class="line"><span class="title function_">click</span>(text[<span class="string">&quot;立即打卡&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印结束</span></span><br><span class="line"><span class="title function_">toast</span>(<span class="string">&quot;打卡结束&quot;</span>)</span><br></pre></td></tr></table></figure>
<h1 id="方案二-滑动翻页"><a href="#方案二-滑动翻页" class="headerlink" title="方案二: 滑动翻页"></a>方案二: 滑动翻页</h1><pre><code class="js">
</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/25/%E6%BB%9A%E5%8A%A8%E9%98%85%E8%AF%BB/" data-id="cl9xpujs1004idmop30bf6pjh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-vue-hackernews-2-0-源码解读-适合入门-二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/17/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8-%E4%BA%8C/" class="article-date">
  <time datetime="2019-10-17T11:07:51.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/17/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8-%E4%BA%8C/">vue-hackernews-2.0 源码解读(适合入门)(二)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>书接上回</p>
<p>我们看下entry-server.js主要做了什么</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;./app&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isDev = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//此导出的函数将由`bundleRenderer`调用。</span></span><br><span class="line"><span class="comment">//这是我们执行数据预取以确定</span></span><br><span class="line"><span class="comment">//实际渲染应用程序之前的状态。</span></span><br><span class="line"><span class="comment">//由于数据获取是异步的，因此该函数有望</span></span><br><span class="line"><span class="comment">//返回解析为应用实例的Promise。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This exported function will be called by `bundleRenderer`.</span></span><br><span class="line"><span class="comment">// This is where we perform data-prefetching to determine the</span></span><br><span class="line"><span class="comment">// state of our application before actually rendering it.</span></span><br><span class="line"><span class="comment">// Since data fetching is async, this function is expected to</span></span><br><span class="line"><span class="comment">// return a Promise that resolves to the app instance.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> context =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s = isDev &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    <span class="keyword">const</span> &#123; app, router, store &#125; = <span class="title function_">createApp</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; url &#125; = context</span><br><span class="line">    <span class="keyword">const</span> &#123; fullPath &#125; = router.<span class="title function_">resolve</span>(url).<span class="property">route</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fullPath !== url) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">reject</span>(&#123; <span class="attr">url</span>: fullPath &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置路由位置</span></span><br><span class="line">    <span class="comment">// set router&#x27;s location</span></span><br><span class="line">    router.<span class="title function_">push</span>(url)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待路由可能的异步钩子</span></span><br><span class="line">    <span class="comment">// wait until router has resolved possible async hooks</span></span><br><span class="line">    router.<span class="title function_">onReady</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> matchedComponents = router.<span class="title function_">getMatchedComponents</span>()</span><br><span class="line">      <span class="comment">// no matched routes</span></span><br><span class="line">      <span class="keyword">if</span> (!matchedComponents.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(&#123; <span class="attr">code</span>: <span class="number">404</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//路由上匹配的组件唤醒fetchData钩子</span></span><br><span class="line">      <span class="comment">//一个预置钩子匹配一个状态返回promise</span></span><br><span class="line">      <span class="comment">//当解析完成且状态更新</span></span><br><span class="line">      <span class="comment">// Call fetchData hooks on components matched by the route.</span></span><br><span class="line">      <span class="comment">// A preFetch hook dispatches a store action and returns a Promise,</span></span><br><span class="line">      <span class="comment">// which is resolved when the action is complete and store state has been</span></span><br><span class="line">      <span class="comment">// updated.</span></span><br><span class="line">      <span class="comment">// 使用Promise.all执行匹配到的Component的asyncData方法，即预取数据</span></span><br><span class="line">      <span class="title class_">Promise</span>.<span class="title function_">all</span>(matchedComponents.<span class="title function_">map</span>(<span class="function">(<span class="params">&#123; asyncData &#125;</span>) =&gt;</span> asyncData &amp;&amp; <span class="title function_">asyncData</span>(&#123;</span><br><span class="line">        store,</span><br><span class="line">        <span class="attr">route</span>: router.<span class="property">currentRoute</span></span><br><span class="line">      &#125;))).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        isDev &amp;&amp; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`data pre-fetch: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - s&#125;</span>ms`</span>)</span><br><span class="line">        <span class="comment">//解析了所有prefetch钩子后,渲染app所需要的state充满了store,</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//在渲染上下文中公开状态，并让请求处理程序</span></span><br><span class="line">        <span class="comment">//内联HTML响应中的状态。这允许客户端</span></span><br><span class="line">        <span class="comment">//存储以获取服务器端状态，而不必重复</span></span><br><span class="line">        <span class="comment">//在客户端上获取初始数据。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// After all preFetch hooks are resolved, our store is now</span></span><br><span class="line">        <span class="comment">// filled with the state needed to render the app.</span></span><br><span class="line">        <span class="comment">// Expose the state on the render context, and let the request handler</span></span><br><span class="line">        <span class="comment">// inline the state in the HTML response. This allows the client-side</span></span><br><span class="line">        <span class="comment">// store to pick-up the server-side state without having to duplicate</span></span><br><span class="line">        <span class="comment">// the initial data fetching on the client.</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">// 把vuex的state设置到传入的context.initialState上</span></span><br><span class="line">        context.<span class="property">state</span> = store.<span class="property">state</span></span><br><span class="line">         <span class="comment">// 返回state, router已经设置好的Vue实例app</span></span><br><span class="line">        <span class="title function_">resolve</span>(app)</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(reject)</span><br><span class="line">    &#125;, reject)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>entry-server.js的主要工作：<br>0.返回一个函数，该函数接受一个从服务端传递过来的 context 的参数，<br>将 vue 实例通过 Promise 返回。 context 一般包含 当前页面的url。<br>1.手动路由切换到请求的url，即’&#x2F;‘<br>2.找到该路由对应要渲染的组件，并调用组件的asyncData方法来预取数据<br>3.同步vuex的state数据至传入的context.initialState上，<br>后面会把这些数据直接发送到浏览器端与客户端的vue 实例进行数据(状态)同步，<br>以避免客户端首屏重新加载数据（在客户端入口文件entry-client.js）</p>
<p>还记得index.template.html被设置到template属性中吗？<br>此时Vue渲染器内部就会将Vue实例渲染进我们传入的这个html模板，那么Vue render内部是如何知道把Vue实例插入到模板的什么位置呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;!--vue-ssr-outlet--&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>就是这里，这个<code>&lt;!--vue-ssr-outlet--&gt;</code>Vue渲染器就是根据这个自动替换插入，所以这是个固定的placeholder。<br>如果改动，服务端渲染时会有错误提示：Error: Content placeholder not found in template.</p>
<p>接下来，Vue渲染器会回调callback方法，我们回到server.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (req, res) &#123;</span><br><span class="line">	</span><br><span class="line">  ···</span><br><span class="line">  renderer.<span class="title function_">renderToString</span>(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(html)</span><br><span class="line">    ···</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时只需要将渲染好的html写入http响应体就结束了，浏览器客户端就可以看到页面了。</p>
<p>接下来我们看看服务端数据预取的实现</p>
<h1 id="服务端渲染时的数据预取流程"><a href="#服务端渲染时的数据预取流程" class="headerlink" title="服务端渲染时的数据预取流程"></a>服务端渲染时的数据预取流程</h1><p>上文提到，服务端渲染时，会手动将路由导航到请求地址即’&#x2F;‘下，然后调用该路由组件的asyncData方法来预取数据</p>
<p>那么我们看看路由配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/router/index.js</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Router</span>)</span><br><span class="line"><span class="comment">// route-level code splitting</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createListView</span> = id =&gt; <span class="function">() =&gt;</span> <span class="title class_">System</span>.<span class="title function_">import</span>(<span class="string">&#x27;../views/CreateListView&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">m</span> =&gt;</span> m.<span class="title function_">default</span>(id))</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ItemView</span> = (<span class="params"></span>) =&gt; <span class="title class_">System</span>.<span class="title function_">import</span>(<span class="string">&#x27;../views/ItemView.vue&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">UserView</span> = (<span class="params"></span>) =&gt; <span class="title class_">System</span>.<span class="title function_">import</span>(<span class="string">&#x27;../views/UserView.vue&#x27;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRouter</span> () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;</span><br><span class="line">    <span class="attr">mode</span>: <span class="string">&#x27;history&#x27;</span>,</span><br><span class="line">    <span class="attr">scrollBehavior</span>: <span class="function">() =&gt;</span> (&#123; <span class="attr">y</span>: <span class="number">0</span> &#125;),</span><br><span class="line">    <span class="attr">routes</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/top/:page(\\d+)?&#x27;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&#x27;top&#x27;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/new/:page(\\d+)?&#x27;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&#x27;new&#x27;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/show/:page(\\d+)?&#x27;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&#x27;show&#x27;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/ask/:page(\\d+)?&#x27;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&#x27;ask&#x27;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/job/:page(\\d+)?&#x27;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&#x27;job&#x27;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/item/:id(\\d+)&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ItemView</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/user/:id&#x27;</span>, <span class="attr">component</span>: <span class="title class_">UserView</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>, <span class="attr">redirect</span>: <span class="string">&#x27;/top&#x27;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>地址’&#x2F;‘是做了redirect到’&#x2F;top’,其实就是默认地址就是到top页面，在看第一条路由配置，’&#x2F;top’路由对应的组件是createListView(‘top’)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/CreateListView.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ItemList</span> <span class="keyword">from</span> <span class="string">&#x27;./ItemList.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">camelize</span> = str =&gt; str.<span class="title function_">charAt</span>(<span class="number">0</span>).<span class="title function_">toUpperCase</span>() + str.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a factory function for dynamically creating root-level list views,</span></span><br><span class="line"><span class="comment">// since they share most of the logic except for the type of items to display.</span></span><br><span class="line"><span class="comment">// They are essentially higher order components wrapping ItemList.vue.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createListView</span> (type) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">`<span class="subst">$&#123;type&#125;</span>-stories-view`</span>,</span><br><span class="line">    <span class="comment">//从store中取值</span></span><br><span class="line">    asyncData (&#123; store &#125;) &#123;</span><br><span class="line">      <span class="keyword">return</span> store.<span class="title function_">dispatch</span>(<span class="string">&#x27;FETCH_LIST_DATA&#x27;</span>, &#123; type &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">title</span>: <span class="title function_">camelize</span>(type),</span><br><span class="line">    <span class="comment">//创建itemlist的节点,渲染节点</span></span><br><span class="line">    render (h) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(<span class="title class_">ItemList</span>, &#123; <span class="attr">props</span>: &#123; type &#125;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Vuex-state状态变更流程"><a href="#Vuex-state状态变更流程" class="headerlink" title="Vuex state状态变更流程"></a>Vuex state状态变更流程</h1><p><img src="https://s2.ax1x.com/2019/10/17/KEZjTP.jpg" alt="KEZjTP.jpg"><br>asyncData方法被调用，通过store.dispatch分发了一个数据预取的事件，接下来我们可以看到通过FireBase的API获取到Top分类的数据，然后又做了一系列的内部事件分发，保存数据状态到Vuex store，获取Top页面的List子项数据，最后处理并保存数据到store.</p>
<p>最后数据就都保存在store这里了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> actions <span class="keyword">from</span> <span class="string">&#x27;./actions&#x27;</span></span><br><span class="line"><span class="keyword">import</span> mutations <span class="keyword">from</span> <span class="string">&#x27;./mutations&#x27;</span></span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">&#x27;./getters&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createStore</span> () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">      <span class="attr">activeType</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">itemsPerPage</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">items</span>: &#123;<span class="comment">/* [id: number]: Item */</span>&#125;,</span><br><span class="line">      <span class="attr">users</span>: &#123;<span class="comment">/* [id: string]: User */</span>&#125;,</span><br><span class="line">      <span class="attr">lists</span>: &#123;</span><br><span class="line">        <span class="attr">top</span>: [<span class="comment">/* number */</span>],</span><br><span class="line">        <span class="attr">new</span>: [],</span><br><span class="line">        <span class="attr">show</span>: [],</span><br><span class="line">        <span class="attr">ask</span>: [],</span><br><span class="line">        <span class="attr">job</span>: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    actions,</span><br><span class="line">    mutations,</span><br><span class="line">    getters</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后将开始通过Render 函数创建HTML</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/CreateListView.js</span></span><br><span class="line">render (h) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`createListView render`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(<span class="title class_">ItemList</span>, &#123; <span class="attr">props</span>: &#123; type &#125;&#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/ItemList.vue</span></span><br><span class="line">···</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-view&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-list-nav&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">v-if</span>=<span class="string">&quot;page &gt; 1&quot;</span> <span class="attr">:to</span>=<span class="string">&quot;&#x27;/&#x27; + type + &#x27;/&#x27; + (page - 1)&quot;</span>&gt;</span><span class="symbol">&amp;lt;</span> prev<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;disabled&quot;</span>&gt;</span><span class="symbol">&amp;lt;</span> prev<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; page &#125;&#125;/&#123;&#123; maxPage &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">v-if</span>=<span class="string">&quot;hasMore&quot;</span> <span class="attr">:to</span>=<span class="string">&quot;&#x27;/&#x27; + type + &#x27;/&#x27; + (page + 1)&quot;</span>&gt;</span>more <span class="symbol">&amp;gt;</span><span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;disabled&quot;</span>&gt;</span>more <span class="symbol">&amp;gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">:name</span>=<span class="string">&quot;transition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-list&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;displayedPage&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;displayedPage &gt; 0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">transition-group</span> <span class="attr">tag</span>=<span class="string">&quot;ul&quot;</span> <span class="attr">name</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">item</span> <span class="attr">v-for</span>=<span class="string">&quot;item in displayedItems&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.id&quot;</span> <span class="attr">:item</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">transition-group</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line">···</span><br></pre></td></tr></table></figure>
<p>这样创建完HTML Body部分，前面提到的Vue渲染器会自动把这部分内容插入index.template.html中，替换对应的<!--vue-ssr-outlet-->,然后就又回到前面的流程了，server.js将整个html写入http响应体，浏览器就得到了整个html页面，整个首次访问过程完成。<br>暂时先这样</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/17/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8-%E4%BA%8C/" data-id="cl9xpujrj0039dmopfzr8gblh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-SSR/" rel="tag">Vue-SSR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-js/" rel="tag">Vue.js</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-yuque/vue-hackernews-2-0-源码解读-适合入门-二" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/17/yuque/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8-%E4%BA%8C/" class="article-date">
  <time datetime="2019-10-17T11:07:51.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/17/yuque/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8-%E4%BA%8C/">vue-hackernews-2.0 源码解读(适合入门)(二)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>书接上回</p>
<p>我们看下 entry-server.js 主要做了什么</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&quot;./app&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isDev = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此导出的函数将由`bundleRenderer`调用。</span></span><br><span class="line"><span class="comment">//这是我们执行数据预取以确定</span></span><br><span class="line"><span class="comment">//实际渲染应用程序之前的状态。</span></span><br><span class="line"><span class="comment">//由于数据获取是异步的，因此该函数有望</span></span><br><span class="line"><span class="comment">//返回解析为应用实例的Promise。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This exported function will be called by `bundleRenderer`.</span></span><br><span class="line"><span class="comment">// This is where we perform data-prefetching to determine the</span></span><br><span class="line"><span class="comment">// state of our application before actually rendering it.</span></span><br><span class="line"><span class="comment">// Since data fetching is async, this function is expected to</span></span><br><span class="line"><span class="comment">// return a Promise that resolves to the app instance.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> (context) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s = isDev &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">const</span> &#123; app, router, store &#125; = <span class="title function_">createApp</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; url &#125; = context;</span><br><span class="line">    <span class="keyword">const</span> &#123; fullPath &#125; = router.<span class="title function_">resolve</span>(url).<span class="property">route</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fullPath !== url) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">reject</span>(&#123; <span class="attr">url</span>: fullPath &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置路由位置</span></span><br><span class="line">    <span class="comment">// set router&#x27;s location</span></span><br><span class="line">    router.<span class="title function_">push</span>(url);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待路由可能的异步钩子</span></span><br><span class="line">    <span class="comment">// wait until router has resolved possible async hooks</span></span><br><span class="line">    router.<span class="title function_">onReady</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> matchedComponents = router.<span class="title function_">getMatchedComponents</span>();</span><br><span class="line">      <span class="comment">// no matched routes</span></span><br><span class="line">      <span class="keyword">if</span> (!matchedComponents.<span class="property">length</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reject</span>(&#123; <span class="attr">code</span>: <span class="number">404</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//路由上匹配的组件唤醒fetchData钩子</span></span><br><span class="line">      <span class="comment">//一个预置钩子匹配一个状态返回promise</span></span><br><span class="line">      <span class="comment">//当解析完成且状态更新</span></span><br><span class="line">      <span class="comment">// Call fetchData hooks on components matched by the route.</span></span><br><span class="line">      <span class="comment">// A preFetch hook dispatches a store action and returns a Promise,</span></span><br><span class="line">      <span class="comment">// which is resolved when the action is complete and store state has been</span></span><br><span class="line">      <span class="comment">// updated.</span></span><br><span class="line">      <span class="comment">// 使用Promise.all执行匹配到的Component的asyncData方法，即预取数据</span></span><br><span class="line">      <span class="title class_">Promise</span>.<span class="title function_">all</span>(</span><br><span class="line">        matchedComponents.<span class="title function_">map</span>(</span><br><span class="line">          <span class="function">(<span class="params">&#123; asyncData &#125;</span>) =&gt;</span></span><br><span class="line">            asyncData &amp;&amp;</span><br><span class="line">            <span class="title function_">asyncData</span>(&#123;</span><br><span class="line">              store,</span><br><span class="line">              <span class="attr">route</span>: router.<span class="property">currentRoute</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          isDev &amp;&amp; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`data pre-fetch: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - s&#125;</span>ms`</span>);</span><br><span class="line">          <span class="comment">//解析了所有prefetch钩子后,渲染app所需要的state充满了store,</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">//在渲染上下文中公开状态，并让请求处理程序</span></span><br><span class="line">          <span class="comment">//内联HTML响应中的状态。这允许客户端</span></span><br><span class="line">          <span class="comment">//存储以获取服务器端状态，而不必重复</span></span><br><span class="line">          <span class="comment">//在客户端上获取初始数据。</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// After all preFetch hooks are resolved, our store is now</span></span><br><span class="line">          <span class="comment">// filled with the state needed to render the app.</span></span><br><span class="line">          <span class="comment">// Expose the state on the render context, and let the request handler</span></span><br><span class="line">          <span class="comment">// inline the state in the HTML response. This allows the client-side</span></span><br><span class="line">          <span class="comment">// store to pick-up the server-side state without having to duplicate</span></span><br><span class="line">          <span class="comment">// the initial data fetching on the client.</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// 把vuex的state设置到传入的context.initialState上</span></span><br><span class="line">          context.<span class="property">state</span> = store.<span class="property">state</span>;</span><br><span class="line">          <span class="comment">// 返回state, router已经设置好的Vue实例app</span></span><br><span class="line">          <span class="title function_">resolve</span>(app);</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(reject);</span><br><span class="line">    &#125;, reject);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>entry-server.js 的主要工作：</p>
<p>0.返回一个函数，该函数接受一个从服务端传递过来的 context 的参数，</p>
<p>将 vue 实例通过 Promise 返回。 context 一般包含 当前页面的 url。</p>
<p>1.手动路由切换到请求的 url，即’&#x2F;‘</p>
<p>2.找到该路由对应要渲染的组件，并调用组件的 asyncData 方法来预取数据</p>
<p>3.同步 vuex 的 state 数据至传入的 context.initialState 上，</p>
<p>后面会把这些数据直接发送到浏览器端与客户端的 vue 实例进行数据(状态)同步，</p>
<p>以避免客户端首屏重新加载数据（在客户端入口文件 entry-client.js）</p>
<p>还记得 index.template.html 被设置到 template 属性中吗？</p>
<p>此时 Vue 渲染器内部就会将 Vue 实例渲染进我们传入的这个 html 模板，那么 Vue render 内部是如何知道把 Vue 实例插入到模板的什么位置呢？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;!--vue-ssr-outlet--&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<p>就是这里，这个<code>&lt;!--vue-ssr-outlet--&gt;</code>Vue 渲染器就是根据这个自动替换插入，所以这是个固定的 placeholder。</p>
<p>如果改动，服务端渲染时会有错误提示：Error: Content placeholder not found in template.</p>
<p>接下来，Vue 渲染器会回调 callback 方法，我们回到 server.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (req, res) &#123;</span><br><span class="line"></span><br><span class="line">  ···</span><br><span class="line">  renderer.<span class="title function_">renderToString</span>(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(html)</span><br><span class="line">    ···</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时只需要将渲染好的 html 写入 http 响应体就结束了，浏览器客户端就可以看到页面了。</p>
<p>接下来我们看看服务端数据预取的实现</p>
<h1 id="服务端渲染时的数据预取流程"><a href="#服务端渲染时的数据预取流程" class="headerlink" title="服务端渲染时的数据预取流程"></a>服务端渲染时的数据预取流程</h1><p>上文提到，服务端渲染时，会手动将路由导航到请求地址即’&#x2F;‘下，然后调用该路由组件的 asyncData 方法来预取数据</p>
<p>那么我们看看路由配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/router/index.js</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Router</span>);</span><br><span class="line"><span class="comment">// route-level code splitting</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createListView</span> = (<span class="params">id</span>) =&gt; <span class="function">() =&gt;</span></span><br><span class="line">  <span class="title class_">System</span>.<span class="title function_">import</span>(<span class="string">&quot;../views/CreateListView&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">m</span>) =&gt;</span> m.<span class="title function_">default</span>(id));</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ItemView</span> = (<span class="params"></span>) =&gt; <span class="title class_">System</span>.<span class="title function_">import</span>(<span class="string">&quot;../views/ItemView.vue&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">UserView</span> = (<span class="params"></span>) =&gt; <span class="title class_">System</span>.<span class="title function_">import</span>(<span class="string">&quot;../views/UserView.vue&quot;</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRouter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;</span><br><span class="line">    <span class="attr">mode</span>: <span class="string">&quot;history&quot;</span>,</span><br><span class="line">    <span class="attr">scrollBehavior</span>: <span class="function">() =&gt;</span> (&#123; <span class="attr">y</span>: <span class="number">0</span> &#125;),</span><br><span class="line">    <span class="attr">routes</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/top/:page(\\d+)?&quot;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&quot;top&quot;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/new/:page(\\d+)?&quot;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&quot;new&quot;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/show/:page(\\d+)?&quot;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&quot;show&quot;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/ask/:page(\\d+)?&quot;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&quot;ask&quot;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/job/:page(\\d+)?&quot;</span>, <span class="attr">component</span>: <span class="title function_">createListView</span>(<span class="string">&quot;job&quot;</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/item/:id(\\d+)&quot;</span>, <span class="attr">component</span>: <span class="title class_">ItemView</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/user/:id&quot;</span>, <span class="attr">component</span>: <span class="title class_">UserView</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>, <span class="attr">redirect</span>: <span class="string">&quot;/top&quot;</span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地址’&#x2F;‘是做了 redirect 到’&#x2F;top’,其实就是默认地址就是到 top 页面，在看第一条路由配置，’&#x2F;top’路由对应的组件是 createListView(‘top’)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/CreateListView.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ItemList</span> <span class="keyword">from</span> <span class="string">&quot;./ItemList.vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">camelize</span> = (<span class="params">str</span>) =&gt; str.<span class="title function_">charAt</span>(<span class="number">0</span>).<span class="title function_">toUpperCase</span>() + str.<span class="title function_">slice</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a factory function for dynamically creating root-level list views,</span></span><br><span class="line"><span class="comment">// since they share most of the logic except for the type of items to display.</span></span><br><span class="line"><span class="comment">// They are essentially higher order components wrapping ItemList.vue.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createListView</span>(<span class="params">type</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">`<span class="subst">$&#123;type&#125;</span>-stories-view`</span>,</span><br><span class="line">    <span class="comment">//从store中取值</span></span><br><span class="line">    <span class="title function_">asyncData</span>(<span class="params">&#123; store &#125;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> store.<span class="title function_">dispatch</span>(<span class="string">&quot;FETCH_LIST_DATA&quot;</span>, &#123; type &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">title</span>: <span class="title function_">camelize</span>(type),</span><br><span class="line">    <span class="comment">//创建itemlist的节点,渲染节点</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params">h</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(<span class="title class_">ItemList</span>, &#123; <span class="attr">props</span>: &#123; type &#125; &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Vuex-state-状态变更流程"><a href="#Vuex-state-状态变更流程" class="headerlink" title="Vuex state 状态变更流程"></a>Vuex state 状态变更流程</h1><p><img src="https://s2.ax1x.com/2019/10/17/KEZjTP.jpg#alt=KEZjTP.jpg"></p>
<p>asyncData 方法被调用，通过 store.dispatch 分发了一个数据预取的事件，接下来我们可以看到通过 FireBase 的 API 获取到 Top 分类的数据，然后又做了一系列的内部事件分发，保存数据状态到 Vuex store，获取 Top 页面的 List 子项数据，最后处理并保存数据到 store.</p>
<p>最后数据就都保存在 store 这里了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> actions <span class="keyword">from</span> <span class="string">&quot;./actions&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> mutations <span class="keyword">from</span> <span class="string">&quot;./mutations&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">&quot;./getters&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createStore</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">      <span class="attr">activeType</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">itemsPerPage</span>: <span class="number">20</span>,</span><br><span class="line">      <span class="attr">items</span>: &#123;</span><br><span class="line">        <span class="comment">/* [id: number]: Item */</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">users</span>: &#123;</span><br><span class="line">        <span class="comment">/* [id: string]: User */</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">lists</span>: &#123;</span><br><span class="line">        <span class="attr">top</span>: [</span><br><span class="line">          <span class="comment">/* number */</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">new</span>: [],</span><br><span class="line">        <span class="attr">show</span>: [],</span><br><span class="line">        <span class="attr">ask</span>: [],</span><br><span class="line">        <span class="attr">job</span>: [],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    actions,</span><br><span class="line">    mutations,</span><br><span class="line">    getters,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将开始通过 Render 函数创建 HTML</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/CreateListView.js</span></span><br><span class="line">render (h) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`createListView render`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(<span class="title class_">ItemList</span>, &#123; <span class="attr">props</span>: &#123; type &#125;&#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/ItemList.vue</span></span><br><span class="line">···</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-view&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-list-nav&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">v-if</span>=<span class="string">&quot;page &gt; 1&quot;</span> <span class="attr">:to</span>=<span class="string">&quot;&#x27;/&#x27; + type + &#x27;/&#x27; + (page - 1)&quot;</span>&gt;</span>&lt; prev<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;disabled&quot;</span>&gt;</span>&lt; prev<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; page &#125;&#125;/&#123;&#123; maxPage &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">v-if</span>=<span class="string">&quot;hasMore&quot;</span> <span class="attr">:to</span>=<span class="string">&quot;&#x27;/&#x27; + type + &#x27;/&#x27; + (page + 1)&quot;</span>&gt;</span>more &gt;<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">v-else</span> <span class="attr">class</span>=<span class="string">&quot;disabled&quot;</span>&gt;</span>more &gt;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">:name</span>=<span class="string">&quot;transition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;news-list&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;displayedPage&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;displayedPage &gt; 0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">transition-group</span> <span class="attr">tag</span>=<span class="string">&quot;ul&quot;</span> <span class="attr">name</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">item</span> <span class="attr">v-for</span>=<span class="string">&quot;item in displayedItems&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;item.id&quot;</span> <span class="attr">:item</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">transition-group</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line">···</span><br></pre></td></tr></table></figure>

<p>这样创建完 HTML Body 部分，前面提到的 Vue 渲染器会自动把这部分内容插入 index.template.html 中，替换对应的,然后就又回到前面的流程了，server.js 将整个 html 写入 http 响应体，浏览器就得到了整个 html 页面，整个首次访问过程完成。</p>
<p>暂时先这样</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/17/yuque/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8-%E4%BA%8C/" data-id="cl9xpuju1008sdmop8xjphjye" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-SSR/" rel="tag">Vue-SSR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-js/" rel="tag">Vue.js</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-vue-hackernews-2-0-源码解读-适合入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/16/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2019-10-16T03:17:57.000Z" itemprop="datePublished">2019-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/16/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8/">vue-hackernews-2.0 源码解读(适合入门)(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>HackerNews 是基于 HN 的官方 firebase API 、Vue 2.0 、vue-router 和 vuex 来构建的，使用服务器端渲染。<br>vue-hackernews 项目，是尤大神在 Vue-SSR 官方文档所展示的范例 DEMO.涉及知识点及技术栈非常全面，对于初学者来说，直接阅读该项目，极具挑战。那么我就来一句一句的解析,看看到底都是啥.<br>本文借鉴了 osan 的文章(<a target="_blank" rel="noopener" href="https://wangfuda.github.io/2017/05/14/vue-hackernews-2.0-code-explain/),%E5%8A%A0%E4%B8%8A%E6%9C%AC%E4%BA%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%90%86%E8%A7%A3,%E4%BB%8E%E8%8F%9C%E9%B8%A1%E7%9A%84%E8%A7%92%E5%BA%A6%E6%9D%A5%E7%9C%8B,%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3">https://wangfuda.github.io/2017/05/14/vue-hackernews-2.0-code-explain/),加上本人自己的理解,从菜鸡的角度来看,添加一些理解</a>.</p>
</blockquote>
<h1 id="牢骚"><a href="#牢骚" class="headerlink" title="牢骚"></a>牢骚</h1><p>去了一家公司面试,问了半天技术,答基础不错(因为我没有工作经验).回复说我司非常依赖 SSR,对 SEO 要求很高,搜索引擎排名必须第一,要求我必须尽快做出一份 demo 出来满足他们的最低要求.那么问题来了,我对 SSR 基本只是一知半解,怎么用完全属于白板啊.当时周五,那么只剩周六日两天了,也就是说,两天从不知 SSR 为何物到搞出一个 demo.压力好大.回去路上就开始上网查文档.我一看,这是啥,这又是啥.完全不知所云啊.<br>无奈看看有没有入门教程吧,一搜,好少啊,看看掘金,挺多的,挨个看一遍,为什么都在 copy 官方文档啊,把各个组件,方法讲讲都是干嘛的也行啊,根本没讲,copy 完官方文档,直接甩一个 demo.我:what?<br>这真是应验了官方指南的话,</p>
<blockquote>
<p>本指南将会非常深入，并且假设你已经熟悉 Vue.js 本身，并且具有 Node.js 和 webpack 的相当不错的应用经验。<br>我这完全不熟悉 node 和 webpack 的人完全就是抓瞎啊.<br>好吧,经过不断努(bao)力(gan),终于搞出了一个 demo,人家说技术不过关,期待下次合作.wtf?<br>也在意料之中了,有老手为什么还要菜鸡呢?<br>不过这技术不能扔了,我得记下来,以警示后人…</p>
</blockquote>
<h1 id="结构概览"><a href="#结构概览" class="headerlink" title="结构概览"></a>结构概览</h1><p><img src="https://s2.ax1x.com/2019/10/17/KESW6K.png" alt="KESW6K.png"><br>项目结构图上显示，有两个入口文件，entry-server.js 和 entry-client.js， 分别是服务端渲染和客户端渲染的实现入口，webpack 将两个入口文件分别打包成给服务端用的 server bundle 和给客户端用的 client bundle.</p>
<p>服务端：当 Node Server 收到来自 Browser 的请求后，会创建一个 Vue 渲染器 BundleRenderer，这个 bundleRenderer 会读取上面生成的 server bundle 文件（即 entry-server.js），并且执行它，而 server bundle 实现了数据预取并返回已填充数据的 Vue 实例，接下来 Vue 渲染器内部就会将 Vue 实例渲染进 html 模板，最后把这个完整的 html 发送到浏览器。</p>
<p>客户端：Browser 收到 HTML 后，客户端加载了client bundle(即 entry-client.js) ，通过 app.$mount(‘#app’)挂载 Vue 实例到服务端渲染的 DOM 上,并会和服务端渲染的HTML进行 Hydration（合并）.</p>
<h1 id="大体操作"><a href="#大体操作" class="headerlink" title="大体操作"></a>大体操作</h1><p><img src="https://s2.ax1x.com/2019/10/17/KEeeYT.png" alt="KEeeYT.png"></p>
<h1 id="目录概览"><a href="#目录概览" class="headerlink" title="目录概览"></a>目录概览</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">│  manifest.<span class="property">json</span>				# progressive web apps配置文件</span><br><span class="line">│  package.<span class="property">json</span>					# 项目配置文件</span><br><span class="line">│  server.<span class="property">js</span>					# 服务端渲染</span><br><span class="line">│</span><br><span class="line">├─public                                    	# 静态资源</span><br><span class="line">│      logo-<span class="number">120.</span>png</span><br><span class="line">│      logo-<span class="number">144.</span>png</span><br><span class="line">│      logo-<span class="number">152.</span>png</span><br><span class="line">│      logo-<span class="number">192.</span>png</span><br><span class="line">│      logo-<span class="number">384.</span>png</span><br><span class="line">│      logo-<span class="number">48.</span>png</span><br><span class="line">│</span><br><span class="line">└─src</span><br><span class="line">    │  app.<span class="property">js</span>					# 整合 router,filters,vuex 的入口文件</span><br><span class="line">    │  <span class="title class_">App</span>.<span class="property">vue</span>					# 根 vue 组件</span><br><span class="line">    │  entry-client.<span class="property">js</span>				# client 的入口文件</span><br><span class="line">    │  entry-server.<span class="property">js</span>				# server 的入口文件</span><br><span class="line">    │  index.<span class="property">template</span>.<span class="property">html</span>			# html 模板</span><br><span class="line">    │</span><br><span class="line">    ├─api</span><br><span class="line">    │      create-api-client.<span class="property">js</span>			# <span class="title class_">Client</span>数据源配置</span><br><span class="line">    │      create-api-server.<span class="property">js</span>			# server数据源配置</span><br><span class="line">    │      index.<span class="property">js</span>				# 数据请求<span class="variable constant_">API</span></span><br><span class="line">    │</span><br><span class="line">    ├─components</span><br><span class="line">    │      <span class="title class_">Comment</span>.<span class="property">vue</span>				# 评论组件</span><br><span class="line">    │      <span class="title class_">Item</span>.<span class="property">vue</span>				#</span><br><span class="line">    │      <span class="title class_">ProgressBar</span>.<span class="property">vue</span>			# 进度条组件</span><br><span class="line">    │      <span class="title class_">Spinner</span>.<span class="property">vue</span>				# 加载提示组件</span><br><span class="line">    │</span><br><span class="line">    ├─router</span><br><span class="line">    │      index.<span class="property">js</span>				# router配置</span><br><span class="line">    │</span><br><span class="line">    ├─store					# <span class="title class_">Vue</span> store模块</span><br><span class="line">    │      actions.<span class="property">js</span>				# 根级别的 action</span><br><span class="line">    │      getters.<span class="property">js</span>				# 属性接口</span><br><span class="line">    │      index.<span class="property">js</span>				# 我们组装模块并导出 store 的地方</span><br><span class="line">    │      mutations.<span class="property">js</span>				# 根级别的 mutation</span><br><span class="line">    │</span><br><span class="line">    ├─util</span><br><span class="line">    │      filters.<span class="property">js</span>				# 过滤器</span><br><span class="line">    │      title.<span class="property">js</span>				# 工具类</span><br><span class="line">    │</span><br><span class="line">    └─views</span><br><span class="line">            <span class="title class_">CreateListView</span>.<span class="property">js</span>			# 动态生成列表界面的工厂方法</span><br><span class="line">            <span class="title class_">ItemList</span>.<span class="property">vue</span>			# <span class="title class_">List</span>界面组件</span><br><span class="line">            <span class="title class_">ItemView</span>.<span class="property">vue</span>			# 单<span class="title class_">List</span>项组件</span><br><span class="line">            <span class="title class_">UserView</span>.<span class="property">vue</span>			# 用户界面组件</span><br></pre></td></tr></table></figure>

<h1 id="开发环境的服务端渲染流程"><a href="#开发环境的服务端渲染流程" class="headerlink" title="开发环境的服务端渲染流程"></a>开发环境的服务端渲染流程</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># serve <span class="keyword">in</span> dev mode, <span class="keyword">with</span> hot reload at <span class="attr">localhost</span>:<span class="number">8080</span></span><br><span class="line">$npm run dev</span><br></pre></td></tr></table></figure>

<p>看看发生了什么<br><img src="https://s2.ax1x.com/2019/10/17/KEpF10.png" alt="KEpF10.png"><br>上述执行 dev 属性对应的脚本：node server 即 node server.js，即执行 server.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">LRU</span> = <span class="built_in">require</span>(<span class="string">&quot;lru-cache&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> favicon = <span class="built_in">require</span>(<span class="string">&quot;serve-favicon&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> compression = <span class="built_in">require</span>(<span class="string">&quot;compression&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> microcache = <span class="built_in">require</span>(<span class="string">&quot;route-cache&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resolve</span> = file =&gt; path.<span class="title function_">resolve</span>(__dirname, file);</span><br><span class="line"><span class="keyword">const</span> &#123; createBundleRenderer &#125; = <span class="built_in">require</span>(<span class="string">&quot;vue-server-renderer&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置生产环境</span></span><br><span class="line"><span class="keyword">const</span> isProd = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;production&quot;</span>;</span><br><span class="line"><span class="comment">//使用微缓存</span></span><br><span class="line"><span class="keyword">const</span> useMicroCache = process.<span class="property">env</span>.<span class="property">MICRO_CACHE</span> !== <span class="string">&quot;false&quot;</span>;</span><br><span class="line"><span class="comment">//服务端信息</span></span><br><span class="line"><span class="keyword">const</span> serverInfo =</span><br><span class="line">  <span class="string">`express/<span class="subst">$&#123;<span class="built_in">require</span>(<span class="string">&quot;express/package.json&quot;</span>).version&#125;</span> `</span> +</span><br><span class="line">  <span class="string">`vue-server-renderer/<span class="subst">$&#123;<span class="built_in">require</span>(<span class="string">&quot;vue-server-renderer/package.json&quot;</span>).version&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用expess</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建渲染器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createRenderer</span>(<span class="params">bundle, options</span>) &#123;</span><br><span class="line">  <span class="comment">// 调用vue-server-renderer的createBundleRenderer方法创建渲染器，</span></span><br><span class="line">  <span class="comment">//并设置HTML模板，以后后续将服务端预取的数据填充至模板中</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createBundleRenderer</span>(</span><br><span class="line">    bundle,</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(options, &#123;</span><br><span class="line">      <span class="comment">// for component caching</span></span><br><span class="line">      <span class="comment">//设置一个缓存</span></span><br><span class="line">      <span class="attr">cache</span>: <span class="title function_">LRU</span>(&#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span></span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="comment">// this is only needed when vue-server-renderer is npm-linked</span></span><br><span class="line">      <span class="attr">basedir</span>: <span class="title function_">resolve</span>(<span class="string">&quot;./dist&quot;</span>),</span><br><span class="line">      <span class="comment">// recommended for performance</span></span><br><span class="line">      <span class="attr">runInNewContext</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> renderer;</span><br><span class="line"><span class="keyword">let</span> readyPromise;</span><br><span class="line"><span class="comment">//模板路径</span></span><br><span class="line"><span class="keyword">const</span> templatePath = <span class="title function_">resolve</span>(<span class="string">&quot;./src/index.template.html&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (isProd) &#123;</span><br><span class="line">  <span class="comment">//生产环境:</span></span><br><span class="line">  <span class="comment">//webpack结合vue-ssr-webpack-plugin插件生成的server bundle</span></span><br><span class="line">  <span class="comment">//服务端渲染的HTML模板</span></span><br><span class="line">  <span class="keyword">const</span> template = fs.<span class="title function_">readFileSync</span>(templatePath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  <span class="comment">//生产环境的时候这里已经打包好了这个json文件可以直接调用</span></span><br><span class="line">  <span class="keyword">const</span> bundle = <span class="built_in">require</span>(<span class="string">&quot;./dist/vue-ssr-server-bundle.json&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//client manifests是可选项,允许渲染器自动预加载,渲染添加&lt;script&gt;标签</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The client manifests are optional, but it allows the renderer</span></span><br><span class="line">  <span class="comment">// to automatically infer preload/prefetch links and directly add &lt;script&gt;</span></span><br><span class="line">  <span class="comment">// tags for any async chunks used during render, avoiding waterfall requests.</span></span><br><span class="line">  <span class="keyword">const</span> clientManifest = <span class="built_in">require</span>(<span class="string">&quot;./dist/vue-ssr-client-manifest.json&quot;</span>);</span><br><span class="line">  <span class="comment">//vue-server-renderer创建bundle渲染器并绑定server bundle</span></span><br><span class="line">  renderer = <span class="title function_">createRenderer</span>(bundle, &#123;</span><br><span class="line">    template,</span><br><span class="line">    clientManifest</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 开发环境下，使用dev-server来通过回调把生成在内存中的bundle文件传回</span></span><br><span class="line">  <span class="comment">// 通过dev server的webpack-dev-middleware和webpack-hot-middleware实现客户端代码的热更新</span></span><br><span class="line">  <span class="comment">//以及通过webpack的watch功能实现服务端代码的热更新</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// In development: setup the dev server with watch and hot-reload,</span></span><br><span class="line">  <span class="comment">// and create a new renderer on bundle / index template update.</span></span><br><span class="line">  readyPromise = <span class="built_in">require</span>(<span class="string">&quot;./build/setup-dev-server&quot;</span>)(</span><br><span class="line">    app,</span><br><span class="line">    templatePath,</span><br><span class="line">    <span class="function">(<span class="params">bundle, options</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 基于热更新，回调生成最新的bundle渲染器</span></span><br><span class="line">      renderer = <span class="title function_">createRenderer</span>(bundle, options);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态缓存时间</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">serve</span> = (<span class="params">path, cache</span>) =&gt;</span><br><span class="line">  express.<span class="title function_">static</span>(<span class="title function_">resolve</span>(path), &#123;</span><br><span class="line">    <span class="attr">maxAge</span>: cache &amp;&amp; isProd ? <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> : <span class="number">0</span></span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">//依次装载一系列Express中间件，用来处理静态资源，数据压缩等</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">compression</span>(&#123; <span class="attr">threshold</span>: <span class="number">0</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">favicon</span>(<span class="string">&quot;./public/logo-48.png&quot;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/dist&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./dist&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/public&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./public&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/manifest.json&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./manifest.json&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/service-worker.js&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./dist/service-worker.js&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// since this app has no user-specific content, every page is micro-cacheable.</span></span><br><span class="line"><span class="comment">// if your app involves user-specific content, you need to implement custom</span></span><br><span class="line"><span class="comment">// logic to determine whether a request is cacheable based on its url and</span></span><br><span class="line"><span class="comment">// headers.</span></span><br><span class="line"><span class="comment">// 1-second microcache.</span></span><br><span class="line"><span class="comment">// https://www.nginx.com/blog/benefits-of-microcaching-nginx/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置微缓存</span></span><br><span class="line">app.<span class="title function_">use</span>(microcache.<span class="title function_">cacheSeconds</span>(<span class="number">1</span>, <span class="function"><span class="params">req</span> =&gt;</span> useMicroCache &amp;&amp; req.<span class="property">originalUrl</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> s = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&quot;Server&quot;</span>, serverInfo);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleError</span> = err =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">url</span>) &#123;</span><br><span class="line">      res.<span class="title function_">redirect</span>(err.<span class="property">url</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err.<span class="property">code</span> === <span class="number">404</span>) &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&quot;404 | Page Not Found&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Render Error Page or Redirect</span></span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;500 | Internal Server Error&quot;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`error during render : <span class="subst">$&#123;req.url&#125;</span>`</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">stack</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 设置请求的url</span></span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;Vue HN 2.0&quot;</span>, <span class="comment">// default title</span></span><br><span class="line">    <span class="attr">url</span>: req.<span class="property">url</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为渲染器绑定的server bundle（即entry-server.js）设置入参context</span></span><br><span class="line">  renderer.<span class="title function_">renderToString</span>(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">handleError</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(html);</span><br><span class="line">    <span class="keyword">if</span> (!isProd) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`whole request: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - s&#125;</span>ms`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//启动一个服务并监听从 8080 端口进入的所有连接请求。</span></span><br><span class="line">app.<span class="title function_">get</span>(</span><br><span class="line">  <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  isProd</span><br><span class="line">    ? render</span><br><span class="line">    : <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">        readyPromise.<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title function_">render</span>(req, res));</span><br><span class="line">      &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">8080</span>;</span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server started at localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>server.js 最终监听 8080 端口等待处理客户端请求，此时在浏览器访问 localhost:8080<br>请求经由 express 路由接收后，执行处理逻辑:readyPromise.then(() &#x3D;&gt; render(req, res))<br>沿着 Promise 的调用链处理：<br>开发环境下 1.调用 setup-dev-server.js 模块，根据上图中 webpack config 文件实现入口文件打包，热替换功能实现。<br>最终通过回调把生成在内存中的 server bundle 传回。 2.创建渲染器，绑定 server bundle，设置渲染模板，缓存等 3.依次装载一系列 Express 中间件，用来处理静态资源，数据压缩等 4.最后将渲染好的 HTML 写入 http 响应体，传回浏览器。</p>
<h1 id="setup-dev-server"><a href="#setup-dev-server" class="headerlink" title="setup-dev-server"></a>setup-dev-server</h1><p>server.js 的模块依赖关系图<br><img src="https://s2.ax1x.com/2019/10/17/KEpxv6.png" alt="KEpxv6.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup-dev-server.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MFS</span> = <span class="built_in">require</span>(<span class="string">&quot;memory-fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> chokidar = <span class="built_in">require</span>(<span class="string">&quot;chokidar&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> clientConfig = <span class="built_in">require</span>(<span class="string">&quot;./webpack.client.config&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> serverConfig = <span class="built_in">require</span>(<span class="string">&quot;./webpack.server.config&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取文件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">readFile</span> = (<span class="params">fs, file</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//fs读取客户端输出路径</span></span><br><span class="line">    <span class="keyword">return</span> fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">join</span>(clientConfig.<span class="property">output</span>.<span class="property">path</span>, file), <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出模块,创建开发服务</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">setupDevServer</span>(<span class="params">app, templatePath, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> bundle;</span><br><span class="line">  <span class="keyword">let</span> template;</span><br><span class="line">  <span class="keyword">let</span> clientManifest;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ready;</span><br><span class="line">  <span class="keyword">const</span> readyPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">    ready = r;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">//设定更新</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">update</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (bundle &amp;&amp; clientManifest) &#123;</span><br><span class="line">      <span class="title function_">ready</span>();</span><br><span class="line">      <span class="title function_">cb</span>(bundle, &#123;</span><br><span class="line">        template,</span><br><span class="line">        clientManifest</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//读取本地模板并观测</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// read template from disk and watch</span></span><br><span class="line">  template = fs.<span class="title function_">readFileSync</span>(templatePath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  chokidar.<span class="title function_">watch</span>(templatePath).<span class="title function_">on</span>(<span class="string">&quot;change&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    template = fs.<span class="title function_">readFileSync</span>(templatePath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;index.html template updated.&quot;</span>);</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//客户端热加载服务</span></span><br><span class="line">  <span class="comment">// modify client config to work with hot middleware</span></span><br><span class="line">  clientConfig.<span class="property">entry</span>.<span class="property">app</span> = [</span><br><span class="line">    <span class="string">&quot;webpack-hot-middleware/client&quot;</span>,</span><br><span class="line">    clientConfig.<span class="property">entry</span>.<span class="property">app</span></span><br><span class="line">  ];</span><br><span class="line">  clientConfig.<span class="property">output</span>.<span class="property">filename</span> = <span class="string">&quot;[name].js&quot;</span>;</span><br><span class="line">  clientConfig.<span class="property">plugins</span>.<span class="title function_">push</span>(</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">HotModuleReplacementPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">NoEmitOnErrorsPlugin</span>()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//开发中间件</span></span><br><span class="line">  <span class="comment">// dev middleware</span></span><br><span class="line">  <span class="keyword">const</span> clientCompiler = <span class="title function_">webpack</span>(clientConfig);</span><br><span class="line">  <span class="keyword">const</span> devMiddleware = <span class="built_in">require</span>(<span class="string">&quot;webpack-dev-middleware&quot;</span>)(clientCompiler, &#123;</span><br><span class="line">    <span class="attr">publicPath</span>: clientConfig.<span class="property">output</span>.<span class="property">publicPath</span>,</span><br><span class="line">    <span class="attr">noInfo</span>: <span class="literal">true</span></span><br><span class="line">  &#125;);</span><br><span class="line">  app.<span class="title function_">use</span>(devMiddleware);</span><br><span class="line">  <span class="comment">// 在client webpack结合vue-ssr-webpack-plugin完成编译后，获取devMiddleware的fileSystem</span></span><br><span class="line">  <span class="comment">// 读取内存中的bundle 并通过传入的回调更新server.js中的bundle</span></span><br><span class="line">  clientCompiler.<span class="title function_">plugin</span>(<span class="string">&quot;done&quot;</span>, <span class="function"><span class="params">stats</span> =&gt;</span> &#123;</span><br><span class="line">    stats = stats.<span class="title function_">toJson</span>();</span><br><span class="line">    stats.<span class="property">errors</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(err));</span><br><span class="line">    stats.<span class="property">warnings</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(err));</span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="property">errors</span>.<span class="property">length</span>) <span class="keyword">return</span>;</span><br><span class="line">    clientManifest = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(</span><br><span class="line">      <span class="title function_">readFile</span>(devMiddleware.<span class="property">fileSystem</span>, <span class="string">&quot;vue-ssr-client-manifest.json&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//中间件热加载</span></span><br><span class="line">  <span class="comment">// hot middleware</span></span><br><span class="line">  app.<span class="title function_">use</span>(</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;webpack-hot-middleware&quot;</span>)(clientCompiler, &#123; <span class="attr">heartbeat</span>: <span class="number">5000</span> &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//观测更新服务渲染</span></span><br><span class="line">  <span class="comment">// watch and update server renderer</span></span><br><span class="line">  <span class="keyword">const</span> serverCompiler = <span class="title function_">webpack</span>(serverConfig);</span><br><span class="line">  <span class="comment">// 获取基于memory-fs创建的内存文件系统对象</span></span><br><span class="line">  <span class="keyword">const</span> mfs = <span class="keyword">new</span> <span class="title function_">MFS</span>();</span><br><span class="line">  serverCompiler.<span class="property">outputFileSystem</span> = mfs;</span><br><span class="line">  <span class="comment">// 设置文件重新编译监听并通过传入的回调更新server.js中的bundle</span></span><br><span class="line">  serverCompiler.<span class="title function_">watch</span>(&#123;&#125;, <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    stats = stats.<span class="title function_">toJson</span>();</span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="property">errors</span>.<span class="property">length</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取bundle文件</span></span><br><span class="line">    <span class="comment">// read bundle generated by vue-ssr-webpack-plugin</span></span><br><span class="line">    bundle = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title function_">readFile</span>(mfs, <span class="string">&quot;vue-ssr-server-bundle.json&quot;</span>));</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> readyPromise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build/webpack.base.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ExtractTextPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;extract-text-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FriendlyErrorsPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;friendly-errors-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">VueLoaderPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;vue-loader&quot;</span>);</span><br><span class="line"><span class="comment">//生产环境</span></span><br><span class="line"><span class="keyword">const</span> isProd = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;production&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">//开发环境搞这些</span></span><br><span class="line">  <span class="comment">// 开发环境下，开启代码调试map，方便调试断点时代码寻址，推荐模式选择：cheap-module-source-map</span></span><br><span class="line">  <span class="attr">devtool</span>: isProd ? <span class="literal">false</span> : <span class="string">&quot;#cheap-module-source-map&quot;</span>,</span><br><span class="line">  <span class="comment">// 打包输出配置</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../dist&quot;</span>),</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&quot;/dist/&quot;</span>,</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;[name].[chunkhash].js&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="attr">public</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../public&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//解析模块,各种加载器</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">noParse</span>: <span class="regexp">/es6-promise\.js$/</span>, <span class="comment">// avoid webpack shimming process</span></span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;vue-loader&quot;</span>,</span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">compilerOptions</span>: &#123;</span><br><span class="line">            <span class="attr">preserveWhitespace</span>: <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;babel-loader&quot;</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg|gif|svg)$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;url-loader&quot;</span>,</span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">limit</span>: <span class="number">10000</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;[name].[ext]?[hash]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.styl(us)?$/</span>,</span><br><span class="line">        <span class="attr">use</span>: isProd</span><br><span class="line">          ? <span class="title class_">ExtractTextPlugin</span>.<span class="title function_">extract</span>(&#123;</span><br><span class="line">              <span class="attr">use</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">loader</span>: <span class="string">&quot;css-loader&quot;</span>,</span><br><span class="line">                  <span class="attr">options</span>: &#123; <span class="attr">minimize</span>: <span class="literal">true</span> &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;stylus-loader&quot;</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">fallback</span>: <span class="string">&quot;vue-style-loader&quot;</span></span><br><span class="line">            &#125;)</span><br><span class="line">          : [<span class="string">&quot;vue-style-loader&quot;</span>, <span class="string">&quot;css-loader&quot;</span>, <span class="string">&quot;stylus-loader&quot;</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">performance</span>: &#123;</span><br><span class="line">    <span class="attr">hints</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//生产环境搞这些</span></span><br><span class="line">  <span class="attr">plugins</span>: isProd</span><br><span class="line">    ? [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">VueLoaderPlugin</span>(),</span><br><span class="line">        <span class="comment">// 压缩js的插件</span></span><br><span class="line">        <span class="keyword">new</span> webpack.<span class="property">optimize</span>.<span class="title class_">UglifyJsPlugin</span>(&#123;</span><br><span class="line">          <span class="attr">compress</span>: &#123; <span class="attr">warnings</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> webpack.<span class="property">optimize</span>.<span class="title class_">ModuleConcatenationPlugin</span>(),</span><br><span class="line">        <span class="comment">// 从bundle中提取出特定的text到一个文件中,可以把css从js中独立抽离出来</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ExtractTextPlugin</span>(&#123;</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&quot;common.[chunkhash].css&quot;</span></span><br><span class="line">        &#125;)</span><br><span class="line">      ]</span><br><span class="line">    : [<span class="keyword">new</span> <span class="title class_">VueLoaderPlugin</span>(), <span class="keyword">new</span> <span class="title class_">FriendlyErrorsPlugin</span>()]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="创建渲染器"><a href="#创建渲染器" class="headerlink" title="创建渲染器"></a>创建渲染器</h1><p>就是server.js里这一步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createRenderer</span> (bundle, options) &#123;</span><br><span class="line">  <span class="comment">// https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`createRenderer`</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createBundleRenderer</span>(bundle, <span class="title class_">Object</span>.<span class="title function_">assign</span>(options, &#123;</span><br><span class="line">    template,</span><br><span class="line">   </span><br><span class="line">	···</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建渲染器时重点两件事：<br>1.绑定渲染用的server bundle至渲染器，这个bundle是在setup-dev-server.js中将服务端入口文件entry-server.js打包生成的。<br>当渲染器调用renderer.renderToString开始渲染时，会执行该入口文件的默认方法。<br>2.传入了一个html模板index.template.html，这个模板稍后在服务端渲染时就会动态填充预取数据到模板中。</p>
<p>顺着readyPromise.then的调用链，接下来调用render方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (req, res) &#123;</span><br><span class="line">···</span><br><span class="line">  renderer.<span class="title function_">renderToString</span>(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(html)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>renderer.renderToString方法内部会先调用入口模块entry-server.js的默认方法.<br>下节再叙</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/16/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8/" data-id="cl9xpujrk003ddmop0o1bfkmk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-SSR/" rel="tag">Vue-SSR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-js/" rel="tag">Vue.js</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-yuque/vue-hackernews-2-0-源码解读-适合入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/16/yuque/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2019-10-16T03:17:57.000Z" itemprop="datePublished">2019-10-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/16/yuque/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8/">vue-hackernews-2.0 源码解读(适合入门)(一)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>HackerNews 是基于 HN 的官方 firebase API 、Vue 2.0 、vue-router 和 vuex 来构建的，使用服务器端渲染。</p>
</blockquote>
<p>vue-hackernews 项目，是尤大神在 Vue-SSR 官方文档所展示的范例 DEMO.涉及知识点及技术栈非常全面，对于初学者来说，直接阅读该项目，极具挑战。那么我就来一句一句的解析,看看到底都是啥.</p>
<p>本文借鉴了 osan 的文章(<a target="_blank" rel="noopener" href="https://wangfuda.github.io/2017/05/14/vue-hackernews-2.0-code-explain/),%E5%8A%A0%E4%B8%8A%E6%9C%AC%E4%BA%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%90%86%E8%A7%A3,%E4%BB%8E%E8%8F%9C%E9%B8%A1%E7%9A%84%E8%A7%92%E5%BA%A6%E6%9D%A5%E7%9C%8B,%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%BA%9B%E7%90%86%E8%A7%A3">https://wangfuda.github.io/2017/05/14/vue-hackernews-2.0-code-explain/),加上本人自己的理解,从菜鸡的角度来看,添加一些理解</a>.</p>
<h1 id="牢骚"><a href="#牢骚" class="headerlink" title="牢骚"></a>牢骚</h1><p>去了一家公司面试,问了半天技术,答基础不错(因为我没有工作经验).回复说我司非常依赖 SSR,对 SEO 要求很高,搜索引擎排名必须第一,要求我必须尽快做出一份 demo 出来满足他们的最低要求.那么问题来了,我对 SSR 基本只是一知半解,怎么用完全属于白板啊.当时周五,那么只剩周六日两天了,也就是说,两天从不知 SSR 为何物到搞出一个 demo.压力好大.回去路上就开始上网查文档.我一看,这是啥,这又是啥.完全不知所云啊.</p>
<p>无奈看看有没有入门教程吧,一搜,好少啊,看看掘金,挺多的,挨个看一遍,为什么都在 copy 官方文档啊,把各个组件,方法讲讲都是干嘛的也行啊,根本没讲,copy 完官方文档,直接甩一个 demo.我:what?</p>
<p>这真是应验了官方指南的话,</p>
<blockquote>
<p>本指南将会非常深入，并且假设你已经熟悉 Vue.js 本身，并且具有 Node.js 和 webpack 的相当不错的应用经验。</p>
</blockquote>
<p>我这完全不熟悉 node 和 webpack 的人完全就是抓瞎啊.</p>
<p>好吧,经过不断努(bao)力(gan),终于搞出了一个 demo,人家说技术不过关,期待下次合作.wtf?</p>
<p>也在意料之中了,有老手为什么还要菜鸡呢?</p>
<p>不过这技术不能扔了,我得记下来,以警示后人…</p>
<h1 id="结构概览"><a href="#结构概览" class="headerlink" title="结构概览"></a>结构概览</h1><p><img src="https://s2.ax1x.com/2019/10/17/KESW6K.png#alt=KESW6K.png"></p>
<p>项目结构图上显示，有两个入口文件，entry-server.js 和 entry-client.js， 分别是服务端渲染和客户端渲染的实现入口，webpack 将两个入口文件分别打包成给服务端用的 server bundle 和给客户端用的 client bundle.</p>
<p>服务端：当 Node Server 收到来自 Browser 的请求后，会创建一个 Vue 渲染器 BundleRenderer，这个 bundleRenderer 会读取上面生成的 server bundle 文件（即 entry-server.js），并且执行它，而 server bundle 实现了数据预取并返回已填充数据的 Vue 实例，接下来 Vue 渲染器内部就会将 Vue 实例渲染进 html 模板，最后把这个完整的 html 发送到浏览器。</p>
<p>客户端：Browser 收到 HTML 后，客户端加载了 client bundle(即 entry-client.js) ，通过 app.$mount(‘#app’)挂载 Vue 实例到服务端渲染的 DOM 上,并会和服务端渲染的 HTML 进行 Hydration（合并）.</p>
<h1 id="大体操作"><a href="#大体操作" class="headerlink" title="大体操作"></a>大体操作</h1><p><img src="https://s2.ax1x.com/2019/10/17/KEeeYT.png#alt=KEeeYT.png"></p>
<h1 id="目录概览"><a href="#目录概览" class="headerlink" title="目录概览"></a>目录概览</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">│  manifest.<span class="property">json</span>				# progressive web apps配置文件</span><br><span class="line">│  package.<span class="property">json</span>					# 项目配置文件</span><br><span class="line">│  server.<span class="property">js</span>					# 服务端渲染</span><br><span class="line">│</span><br><span class="line">├─public                                    	# 静态资源</span><br><span class="line">│      logo-<span class="number">120.</span>png</span><br><span class="line">│      logo-<span class="number">144.</span>png</span><br><span class="line">│      logo-<span class="number">152.</span>png</span><br><span class="line">│      logo-<span class="number">192.</span>png</span><br><span class="line">│      logo-<span class="number">384.</span>png</span><br><span class="line">│      logo-<span class="number">48.</span>png</span><br><span class="line">│</span><br><span class="line">└─src</span><br><span class="line">    │  app.<span class="property">js</span>					# 整合 router,filters,vuex 的入口文件</span><br><span class="line">    │  <span class="title class_">App</span>.<span class="property">vue</span>					# 根 vue 组件</span><br><span class="line">    │  entry-client.<span class="property">js</span>				# client 的入口文件</span><br><span class="line">    │  entry-server.<span class="property">js</span>				# server 的入口文件</span><br><span class="line">    │  index.<span class="property">template</span>.<span class="property">html</span>			# html 模板</span><br><span class="line">    │</span><br><span class="line">    ├─api</span><br><span class="line">    │      create-api-client.<span class="property">js</span>			# <span class="title class_">Client</span>数据源配置</span><br><span class="line">    │      create-api-server.<span class="property">js</span>			# server数据源配置</span><br><span class="line">    │      index.<span class="property">js</span>				# 数据请求<span class="variable constant_">API</span></span><br><span class="line">    │</span><br><span class="line">    ├─components</span><br><span class="line">    │      <span class="title class_">Comment</span>.<span class="property">vue</span>				# 评论组件</span><br><span class="line">    │      <span class="title class_">Item</span>.<span class="property">vue</span>				#</span><br><span class="line">    │      <span class="title class_">ProgressBar</span>.<span class="property">vue</span>			# 进度条组件</span><br><span class="line">    │      <span class="title class_">Spinner</span>.<span class="property">vue</span>				# 加载提示组件</span><br><span class="line">    │</span><br><span class="line">    ├─router</span><br><span class="line">    │      index.<span class="property">js</span>				# router配置</span><br><span class="line">    │</span><br><span class="line">    ├─store					# <span class="title class_">Vue</span> store模块</span><br><span class="line">    │      actions.<span class="property">js</span>				# 根级别的 action</span><br><span class="line">    │      getters.<span class="property">js</span>				# 属性接口</span><br><span class="line">    │      index.<span class="property">js</span>				# 我们组装模块并导出 store 的地方</span><br><span class="line">    │      mutations.<span class="property">js</span>				# 根级别的 mutation</span><br><span class="line">    │</span><br><span class="line">    ├─util</span><br><span class="line">    │      filters.<span class="property">js</span>				# 过滤器</span><br><span class="line">    │      title.<span class="property">js</span>				# 工具类</span><br><span class="line">    │</span><br><span class="line">    └─views</span><br><span class="line">            <span class="title class_">CreateListView</span>.<span class="property">js</span>			# 动态生成列表界面的工厂方法</span><br><span class="line">            <span class="title class_">ItemList</span>.<span class="property">vue</span>			# <span class="title class_">List</span>界面组件</span><br><span class="line">            <span class="title class_">ItemView</span>.<span class="property">vue</span>			# 单<span class="title class_">List</span>项组件</span><br><span class="line">            <span class="title class_">UserView</span>.<span class="property">vue</span>			# 用户界面组件</span><br></pre></td></tr></table></figure>

<h1 id="开发环境的服务端渲染流程"><a href="#开发环境的服务端渲染流程" class="headerlink" title="开发环境的服务端渲染流程"></a>开发环境的服务端渲染流程</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># serve <span class="keyword">in</span> dev mode, <span class="keyword">with</span> hot reload at <span class="attr">localhost</span>:<span class="number">8080</span></span><br><span class="line">$npm run dev</span><br></pre></td></tr></table></figure>

<p>看看发生了什么</p>
<p><img src="https://s2.ax1x.com/2019/10/17/KEpF10.png#alt=KEpF10.png"></p>
<p>上述执行 dev 属性对应的脚本：node server 即 node server.js，即执行 server.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">LRU</span> = <span class="built_in">require</span>(<span class="string">&quot;lru-cache&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> favicon = <span class="built_in">require</span>(<span class="string">&quot;serve-favicon&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> compression = <span class="built_in">require</span>(<span class="string">&quot;compression&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> microcache = <span class="built_in">require</span>(<span class="string">&quot;route-cache&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resolve</span> = (<span class="params">file</span>) =&gt; path.<span class="title function_">resolve</span>(__dirname, file);</span><br><span class="line"><span class="keyword">const</span> &#123; createBundleRenderer &#125; = <span class="built_in">require</span>(<span class="string">&quot;vue-server-renderer&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置生产环境</span></span><br><span class="line"><span class="keyword">const</span> isProd = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;production&quot;</span>;</span><br><span class="line"><span class="comment">//使用微缓存</span></span><br><span class="line"><span class="keyword">const</span> useMicroCache = process.<span class="property">env</span>.<span class="property">MICRO_CACHE</span> !== <span class="string">&quot;false&quot;</span>;</span><br><span class="line"><span class="comment">//服务端信息</span></span><br><span class="line"><span class="keyword">const</span> serverInfo =</span><br><span class="line">  <span class="string">`express/<span class="subst">$&#123;<span class="built_in">require</span>(<span class="string">&quot;express/package.json&quot;</span>).version&#125;</span> `</span> +</span><br><span class="line">  <span class="string">`vue-server-renderer/<span class="subst">$&#123;<span class="built_in">require</span>(<span class="string">&quot;vue-server-renderer/package.json&quot;</span>).version&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用expess</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建渲染器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createRenderer</span>(<span class="params">bundle, options</span>) &#123;</span><br><span class="line">  <span class="comment">// 调用vue-server-renderer的createBundleRenderer方法创建渲染器，</span></span><br><span class="line">  <span class="comment">//并设置HTML模板，以后后续将服务端预取的数据填充至模板中</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createBundleRenderer</span>(</span><br><span class="line">    bundle,</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">assign</span>(options, &#123;</span><br><span class="line">      <span class="comment">// for component caching</span></span><br><span class="line">      <span class="comment">//设置一个缓存</span></span><br><span class="line">      <span class="attr">cache</span>: <span class="title function_">LRU</span>(&#123;</span><br><span class="line">        <span class="attr">max</span>: <span class="number">1000</span>,</span><br><span class="line">        <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="comment">// this is only needed when vue-server-renderer is npm-linked</span></span><br><span class="line">      <span class="attr">basedir</span>: <span class="title function_">resolve</span>(<span class="string">&quot;./dist&quot;</span>),</span><br><span class="line">      <span class="comment">// recommended for performance</span></span><br><span class="line">      <span class="attr">runInNewContext</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> renderer;</span><br><span class="line"><span class="keyword">let</span> readyPromise;</span><br><span class="line"><span class="comment">//模板路径</span></span><br><span class="line"><span class="keyword">const</span> templatePath = <span class="title function_">resolve</span>(<span class="string">&quot;./src/index.template.html&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (isProd) &#123;</span><br><span class="line">  <span class="comment">//生产环境:</span></span><br><span class="line">  <span class="comment">//webpack结合vue-ssr-webpack-plugin插件生成的server bundle</span></span><br><span class="line">  <span class="comment">//服务端渲染的HTML模板</span></span><br><span class="line">  <span class="keyword">const</span> template = fs.<span class="title function_">readFileSync</span>(templatePath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  <span class="comment">//生产环境的时候这里已经打包好了这个json文件可以直接调用</span></span><br><span class="line">  <span class="keyword">const</span> bundle = <span class="built_in">require</span>(<span class="string">&quot;./dist/vue-ssr-server-bundle.json&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//client manifests是可选项,允许渲染器自动预加载,渲染添加&lt;script&gt;标签</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The client manifests are optional, but it allows the renderer</span></span><br><span class="line">  <span class="comment">// to automatically infer preload/prefetch links and directly add &lt;script&gt;</span></span><br><span class="line">  <span class="comment">// tags for any async chunks used during render, avoiding waterfall requests.</span></span><br><span class="line">  <span class="keyword">const</span> clientManifest = <span class="built_in">require</span>(<span class="string">&quot;./dist/vue-ssr-client-manifest.json&quot;</span>);</span><br><span class="line">  <span class="comment">//vue-server-renderer创建bundle渲染器并绑定server bundle</span></span><br><span class="line">  renderer = <span class="title function_">createRenderer</span>(bundle, &#123;</span><br><span class="line">    template,</span><br><span class="line">    clientManifest,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 开发环境下，使用dev-server来通过回调把生成在内存中的bundle文件传回</span></span><br><span class="line">  <span class="comment">// 通过dev server的webpack-dev-middleware和webpack-hot-middleware实现客户端代码的热更新</span></span><br><span class="line">  <span class="comment">//以及通过webpack的watch功能实现服务端代码的热更新</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// In development: setup the dev server with watch and hot-reload,</span></span><br><span class="line">  <span class="comment">// and create a new renderer on bundle / index template update.</span></span><br><span class="line">  readyPromise = <span class="built_in">require</span>(<span class="string">&quot;./build/setup-dev-server&quot;</span>)(</span><br><span class="line">    app,</span><br><span class="line">    templatePath,</span><br><span class="line">    <span class="function">(<span class="params">bundle, options</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 基于热更新，回调生成最新的bundle渲染器</span></span><br><span class="line">      renderer = <span class="title function_">createRenderer</span>(bundle, options);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态缓存时间</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">serve</span> = (<span class="params">path, cache</span>) =&gt;</span><br><span class="line">  express.<span class="title function_">static</span>(<span class="title function_">resolve</span>(path), &#123;</span><br><span class="line">    <span class="attr">maxAge</span>: cache &amp;&amp; isProd ? <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> : <span class="number">0</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">//依次装载一系列Express中间件，用来处理静态资源，数据压缩等</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">compression</span>(&#123; <span class="attr">threshold</span>: <span class="number">0</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">favicon</span>(<span class="string">&quot;./public/logo-48.png&quot;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/dist&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./dist&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/public&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./public&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/manifest.json&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./manifest.json&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/service-worker.js&quot;</span>, <span class="title function_">serve</span>(<span class="string">&quot;./dist/service-worker.js&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// since this app has no user-specific content, every page is micro-cacheable.</span></span><br><span class="line"><span class="comment">// if your app involves user-specific content, you need to implement custom</span></span><br><span class="line"><span class="comment">// logic to determine whether a request is cacheable based on its url and</span></span><br><span class="line"><span class="comment">// headers.</span></span><br><span class="line"><span class="comment">// 1-second microcache.</span></span><br><span class="line"><span class="comment">// https://www.nginx.com/blog/benefits-of-microcaching-nginx/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置微缓存</span></span><br><span class="line">app.<span class="title function_">use</span>(microcache.<span class="title function_">cacheSeconds</span>(<span class="number">1</span>, <span class="function">(<span class="params">req</span>) =&gt;</span> useMicroCache &amp;&amp; req.<span class="property">originalUrl</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> s = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&quot;Server&quot;</span>, serverInfo);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleError</span> = (<span class="params">err</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">url</span>) &#123;</span><br><span class="line">      res.<span class="title function_">redirect</span>(err.<span class="property">url</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err.<span class="property">code</span> === <span class="number">404</span>) &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&quot;404 | Page Not Found&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Render Error Page or Redirect</span></span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&quot;500 | Internal Server Error&quot;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`error during render : <span class="subst">$&#123;req.url&#125;</span>`</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">stack</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 设置请求的url</span></span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;Vue HN 2.0&quot;</span>, <span class="comment">// default title</span></span><br><span class="line">    <span class="attr">url</span>: req.<span class="property">url</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为渲染器绑定的server bundle（即entry-server.js）设置入参context</span></span><br><span class="line">  renderer.<span class="title function_">renderToString</span>(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">handleError</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(html);</span><br><span class="line">    <span class="keyword">if</span> (!isProd) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`whole request: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - s&#125;</span>ms`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//启动一个服务并监听从 8080 端口进入的所有连接请求。</span></span><br><span class="line">app.<span class="title function_">get</span>(</span><br><span class="line">  <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  isProd</span><br><span class="line">    ? render</span><br><span class="line">    : <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">        readyPromise.<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title function_">render</span>(req, res));</span><br><span class="line">      &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.<span class="property">env</span>.<span class="property">PORT</span> || <span class="number">8080</span>;</span><br><span class="line">app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server started at localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>server.js 最终监听 8080 端口等待处理客户端请求，此时在浏览器访问 localhost:8080</p>
<p>请求经由 express 路由接收后，执行处理逻辑:readyPromise.then(() &#x3D;&gt; render(req, res))</p>
<p>沿着 Promise 的调用链处理：</p>
<p>开发环境下 1.调用 setup-dev-server.js 模块，根据上图中 webpack config 文件实现入口文件打包，热替换功能实现。</p>
<p>最终通过回调把生成在内存中的 server bundle 传回。 2.创建渲染器，绑定 server bundle，设置渲染模板，缓存等 3.依次装载一系列 Express 中间件，用来处理静态资源，数据压缩等 4.最后将渲染好的 HTML 写入 http 响应体，传回浏览器。</p>
<h1 id="setup-dev-server"><a href="#setup-dev-server" class="headerlink" title="setup-dev-server"></a>setup-dev-server</h1><p>server.js 的模块依赖关系图</p>
<p><img src="https://s2.ax1x.com/2019/10/17/KEpxv6.png#alt=KEpxv6.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup-dev-server.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MFS</span> = <span class="built_in">require</span>(<span class="string">&quot;memory-fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> chokidar = <span class="built_in">require</span>(<span class="string">&quot;chokidar&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> clientConfig = <span class="built_in">require</span>(<span class="string">&quot;./webpack.client.config&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> serverConfig = <span class="built_in">require</span>(<span class="string">&quot;./webpack.server.config&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取文件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">readFile</span> = (<span class="params">fs, file</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//fs读取客户端输出路径</span></span><br><span class="line">    <span class="keyword">return</span> fs.<span class="title function_">readFileSync</span>(path.<span class="title function_">join</span>(clientConfig.<span class="property">output</span>.<span class="property">path</span>, file), <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出模块,创建开发服务</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> <span class="title function_">setupDevServer</span>(<span class="params">app, templatePath, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> bundle;</span><br><span class="line">  <span class="keyword">let</span> template;</span><br><span class="line">  <span class="keyword">let</span> clientManifest;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ready;</span><br><span class="line">  <span class="keyword">const</span> readyPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> &#123;</span><br><span class="line">    ready = r;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">//设定更新</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">update</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (bundle &amp;&amp; clientManifest) &#123;</span><br><span class="line">      <span class="title function_">ready</span>();</span><br><span class="line">      <span class="title function_">cb</span>(bundle, &#123;</span><br><span class="line">        template,</span><br><span class="line">        clientManifest,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//读取本地模板并观测</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// read template from disk and watch</span></span><br><span class="line">  template = fs.<span class="title function_">readFileSync</span>(templatePath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  chokidar.<span class="title function_">watch</span>(templatePath).<span class="title function_">on</span>(<span class="string">&quot;change&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    template = fs.<span class="title function_">readFileSync</span>(templatePath, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;index.html template updated.&quot;</span>);</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//客户端热加载服务</span></span><br><span class="line">  <span class="comment">// modify client config to work with hot middleware</span></span><br><span class="line">  clientConfig.<span class="property">entry</span>.<span class="property">app</span> = [</span><br><span class="line">    <span class="string">&quot;webpack-hot-middleware/client&quot;</span>,</span><br><span class="line">    clientConfig.<span class="property">entry</span>.<span class="property">app</span>,</span><br><span class="line">  ];</span><br><span class="line">  clientConfig.<span class="property">output</span>.<span class="property">filename</span> = <span class="string">&quot;[name].js&quot;</span>;</span><br><span class="line">  clientConfig.<span class="property">plugins</span>.<span class="title function_">push</span>(</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">HotModuleReplacementPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">NoEmitOnErrorsPlugin</span>()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//开发中间件</span></span><br><span class="line">  <span class="comment">// dev middleware</span></span><br><span class="line">  <span class="keyword">const</span> clientCompiler = <span class="title function_">webpack</span>(clientConfig);</span><br><span class="line">  <span class="keyword">const</span> devMiddleware = <span class="built_in">require</span>(<span class="string">&quot;webpack-dev-middleware&quot;</span>)(clientCompiler, &#123;</span><br><span class="line">    <span class="attr">publicPath</span>: clientConfig.<span class="property">output</span>.<span class="property">publicPath</span>,</span><br><span class="line">    <span class="attr">noInfo</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  app.<span class="title function_">use</span>(devMiddleware);</span><br><span class="line">  <span class="comment">// 在client webpack结合vue-ssr-webpack-plugin完成编译后，获取devMiddleware的fileSystem</span></span><br><span class="line">  <span class="comment">// 读取内存中的bundle 并通过传入的回调更新server.js中的bundle</span></span><br><span class="line">  clientCompiler.<span class="title function_">plugin</span>(<span class="string">&quot;done&quot;</span>, <span class="function">(<span class="params">stats</span>) =&gt;</span> &#123;</span><br><span class="line">    stats = stats.<span class="title function_">toJson</span>();</span><br><span class="line">    stats.<span class="property">errors</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">error</span>(err));</span><br><span class="line">    stats.<span class="property">warnings</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">warn</span>(err));</span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="property">errors</span>.<span class="property">length</span>) <span class="keyword">return</span>;</span><br><span class="line">    clientManifest = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(</span><br><span class="line">      <span class="title function_">readFile</span>(devMiddleware.<span class="property">fileSystem</span>, <span class="string">&quot;vue-ssr-client-manifest.json&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//中间件热加载</span></span><br><span class="line">  <span class="comment">// hot middleware</span></span><br><span class="line">  app.<span class="title function_">use</span>(</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;webpack-hot-middleware&quot;</span>)(clientCompiler, &#123; <span class="attr">heartbeat</span>: <span class="number">5000</span> &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//观测更新服务渲染</span></span><br><span class="line">  <span class="comment">// watch and update server renderer</span></span><br><span class="line">  <span class="keyword">const</span> serverCompiler = <span class="title function_">webpack</span>(serverConfig);</span><br><span class="line">  <span class="comment">// 获取基于memory-fs创建的内存文件系统对象</span></span><br><span class="line">  <span class="keyword">const</span> mfs = <span class="keyword">new</span> <span class="title function_">MFS</span>();</span><br><span class="line">  serverCompiler.<span class="property">outputFileSystem</span> = mfs;</span><br><span class="line">  <span class="comment">// 设置文件重新编译监听并通过传入的回调更新server.js中的bundle</span></span><br><span class="line">  serverCompiler.<span class="title function_">watch</span>(&#123;&#125;, <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    stats = stats.<span class="title function_">toJson</span>();</span><br><span class="line">    <span class="keyword">if</span> (stats.<span class="property">errors</span>.<span class="property">length</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取bundle文件</span></span><br><span class="line">    <span class="comment">// read bundle generated by vue-ssr-webpack-plugin</span></span><br><span class="line">    bundle = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title function_">readFile</span>(mfs, <span class="string">&quot;vue-ssr-server-bundle.json&quot;</span>));</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> readyPromise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build/webpack.base.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ExtractTextPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;extract-text-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FriendlyErrorsPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;friendly-errors-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">VueLoaderPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;vue-loader&quot;</span>);</span><br><span class="line"><span class="comment">//生产环境</span></span><br><span class="line"><span class="keyword">const</span> isProd = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&quot;production&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">//开发环境搞这些</span></span><br><span class="line">  <span class="comment">// 开发环境下，开启代码调试map，方便调试断点时代码寻址，推荐模式选择：cheap-module-source-map</span></span><br><span class="line">  <span class="attr">devtool</span>: isProd ? <span class="literal">false</span> : <span class="string">&quot;#cheap-module-source-map&quot;</span>,</span><br><span class="line">  <span class="comment">// 打包输出配置</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../dist&quot;</span>),</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&quot;/dist/&quot;</span>,</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;[name].[chunkhash].js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="attr">public</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../public&quot;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//解析模块,各种加载器</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">noParse</span>: <span class="regexp">/es6-promise\.js$/</span>, <span class="comment">// avoid webpack shimming process</span></span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;vue-loader&quot;</span>,</span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">compilerOptions</span>: &#123;</span><br><span class="line">            <span class="attr">preserveWhitespace</span>: <span class="literal">false</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;babel-loader&quot;</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|jpg|gif|svg)$/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&quot;url-loader&quot;</span>,</span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">limit</span>: <span class="number">10000</span>,</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;[name].[ext]?[hash]&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.styl(us)?$/</span>,</span><br><span class="line">        <span class="attr">use</span>: isProd</span><br><span class="line">          ? <span class="title class_">ExtractTextPlugin</span>.<span class="title function_">extract</span>(&#123;</span><br><span class="line">              <span class="attr">use</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="attr">loader</span>: <span class="string">&quot;css-loader&quot;</span>,</span><br><span class="line">                  <span class="attr">options</span>: &#123; <span class="attr">minimize</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;stylus-loader&quot;</span>,</span><br><span class="line">              ],</span><br><span class="line">              <span class="attr">fallback</span>: <span class="string">&quot;vue-style-loader&quot;</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">          : [<span class="string">&quot;vue-style-loader&quot;</span>, <span class="string">&quot;css-loader&quot;</span>, <span class="string">&quot;stylus-loader&quot;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">performance</span>: &#123;</span><br><span class="line">    <span class="attr">hints</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//生产环境搞这些</span></span><br><span class="line">  <span class="attr">plugins</span>: isProd</span><br><span class="line">    ? [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">VueLoaderPlugin</span>(),</span><br><span class="line">        <span class="comment">// 压缩js的插件</span></span><br><span class="line">        <span class="keyword">new</span> webpack.<span class="property">optimize</span>.<span class="title class_">UglifyJsPlugin</span>(&#123;</span><br><span class="line">          <span class="attr">compress</span>: &#123; <span class="attr">warnings</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> webpack.<span class="property">optimize</span>.<span class="title class_">ModuleConcatenationPlugin</span>(),</span><br><span class="line">        <span class="comment">// 从bundle中提取出特定的text到一个文件中,可以把css从js中独立抽离出来</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ExtractTextPlugin</span>(&#123;</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&quot;common.[chunkhash].css&quot;</span>,</span><br><span class="line">        &#125;),</span><br><span class="line">      ]</span><br><span class="line">    : [<span class="keyword">new</span> <span class="title class_">VueLoaderPlugin</span>(), <span class="keyword">new</span> <span class="title class_">FriendlyErrorsPlugin</span>()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="创建渲染器"><a href="#创建渲染器" class="headerlink" title="创建渲染器"></a>创建渲染器</h1><p>就是 server.js 里这一步</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createRenderer</span> (bundle, options) &#123;</span><br><span class="line">  <span class="comment">// https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`createRenderer`</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createBundleRenderer</span>(bundle, <span class="title class_">Object</span>.<span class="title function_">assign</span>(options, &#123;</span><br><span class="line">    template,</span><br><span class="line"></span><br><span class="line">	···</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建渲染器时重点两件事：</p>
<p>1.绑定渲染用的 server bundle 至渲染器，这个 bundle 是在 setup-dev-server.js 中将服务端入口文件 entry-server.js 打包生成的。</p>
<p>当渲染器调用 renderer.renderToString 开始渲染时，会执行该入口文件的默认方法。</p>
<p>2.传入了一个 html 模板 index.template.html，这个模板稍后在服务端渲染时就会动态填充预取数据到模板中。</p>
<p>顺着 readyPromise.then 的调用链，接下来调用 render 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span> (req, res) &#123;</span><br><span class="line">···</span><br><span class="line">  renderer.<span class="title function_">renderToString</span>(context, <span class="function">(<span class="params">err, html</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(html)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>renderer.renderToString 方法内部会先调用入口模块 entry-server.js 的默认方法.</p>
<p>下节再叙</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/16/yuque/vue-hackernews-2-0-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E9%80%82%E5%90%88%E5%85%A5%E9%97%A8/" data-id="cl9xpuju3008tdmop3d577qi6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-SSR/" rel="tag">Vue-SSR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue-js/" rel="tag">Vue.js</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/11/">&amp;laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/13/">下一页 &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/HTML%E5%9F%BA%E7%A1%80/">HTML基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/HTTP%E5%9F%BA%E7%A1%80/">HTTP基础</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTML5/">HTML5</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/HTML5/canvas/">canvas</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/">JS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JS/ES6/">ES6</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/JS%E5%9F%BA%E7%A1%80/">JS基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/JS%E8%BF%9B%E9%98%B6/">JS进阶</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/jQuery/">jQuery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/">前端工程化</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/css/css3/">css3</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/Node-js/">Node.js</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP%E5%AE%89%E5%85%A8/" rel="tag">HTTP安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP%E8%BF%9B%E9%98%B6/" rel="tag">HTTP进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS%E6%B7%B1%E5%85%A5/" rel="tag">JS深入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS%E8%BF%9B%E9%98%B6/" rel="tag">JS进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-SSR/" rel="tag">Vue-SSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-js/" rel="tag">Vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-js%E5%9F%BA%E7%A1%80/" rel="tag">Vue.js基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-js%E8%BF%9B%E9%98%B6/" rel="tag">Vue.js进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css3/" rel="tag">css3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html5/" rel="tag">html5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/" rel="tag">移动端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/HTML/" style="font-size: 18.57px;">HTML</a> <a href="/tags/HTTP%E5%AE%89%E5%85%A8/" style="font-size: 10px;">HTTP安全</a> <a href="/tags/HTTP%E8%BF%9B%E9%98%B6/" style="font-size: 10px;">HTTP进阶</a> <a href="/tags/JS/" style="font-size: 12.86px;">JS</a> <a href="/tags/JS%E6%B7%B1%E5%85%A5/" style="font-size: 10px;">JS深入</a> <a href="/tags/JS%E8%BF%9B%E9%98%B6/" style="font-size: 11.43px;">JS进阶</a> <a href="/tags/React/" style="font-size: 17.14px;">React</a> <a href="/tags/Vue-SSR/" style="font-size: 15.71px;">Vue-SSR</a> <a href="/tags/Vue-js/" style="font-size: 20px;">Vue.js</a> <a href="/tags/Vue-js%E5%9F%BA%E7%A1%80/" style="font-size: 11.43px;">Vue.js基础</a> <a href="/tags/Vue-js%E8%BF%9B%E9%98%B6/" style="font-size: 17.14px;">Vue.js进阶</a> <a href="/tags/android/" style="font-size: 11.43px;">android</a> <a href="/tags/css/" style="font-size: 14.29px;">css</a> <a href="/tags/css3/" style="font-size: 11.43px;">css3</a> <a href="/tags/html5/" style="font-size: 12.86px;">html5</a> <a href="/tags/javascript/" style="font-size: 15.71px;">javascript</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 11.43px;">后端</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 11.43px;">基础</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 11.43px;">小程序</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/" style="font-size: 10px;">移动端</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 14.29px;">面试题</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 12.86px;">项目</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/11/01/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2022/10/25/yuque/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/">自动化构建工具</a>
          </li>
        
          <li>
            <a href="/2022/10/25/yuque/%E8%84%9A%E6%89%8B%E6%9E%B6/">脚手架</a>
          </li>
        
          <li>
            <a href="/2022/10/24/yuque/React%20Query/">React Query</a>
          </li>
        
          <li>
            <a href="/2022/10/19/yuque/%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6/">常用组件</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Zax Tseng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>