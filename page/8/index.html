<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="ZAX">
<meta property="og:url" content="http://example.com/page/8/index.html">
<meta property="og:site_name" content="ZAX">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zax Tseng">
<meta property="article:tag" content="javascript, React, Vue, HTML5">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/8/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/8/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ZAX</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ZAX</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zax Tseng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">123</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/26/HTTP%E8%A1%A5%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/26/HTTP%E8%A1%A5%E6%A1%A3/" class="post-title-link" itemprop="url">HTTP补档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-26 11:03:49" itemprop="dateCreated datePublished" datetime="2022-09-26T11:03:49+08:00">2022-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="cookie-session-token"><a href="#cookie-session-token" class="headerlink" title="cookie,session,token"></a>cookie,session,token</h1><p>服务器验证是前提。<br>cookie 保存在客户端，服务器不加密不保存；大小 4K，一般保存 sessionId。有 expire 和 max-age。<br>session 保存在服务端，服务器要加密并保存；<br>token 保存在客户端，服务器要加密不保存。明文传递给客户端，但是是加密的。</p>
<h1 id="localStorage，sessionStorage，cookie"><a href="#localStorage，sessionStorage，cookie" class="headerlink" title="localStorage，sessionStorage，cookie"></a>localStorage，sessionStorage，cookie</h1><p>localStorage：整个浏览器有效，大小 10M.永久有效。<br>sessionStorage：只在当前 tab 页有效，相邻 tab 不同共享。大小 5M.tab 关闭即失效。<br>cookie：整个浏览器有效，大小 4K.根据设置的过期时间。可以保存在浏览器和服务端。</p>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>cookie 是以键值对的形式保存在浏览器。以<code>=</code>相关联，以<code>;</code>分隔。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看cookie</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span>;</span><br><span class="line"><span class="comment">// 新增cookie</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">cookie</span> = <span class="string">&quot;name = Tom&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h2><p>同源问题：非同源的不能操作修改 localStorage。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置localStorage</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line"><span class="comment">// 查看localStorage</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;name&quot;</span>); <span class="comment">// Tom</span></span><br><span class="line"><span class="comment">// 设置相同键名，会覆盖之前的值</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jack&quot;</span>); <span class="comment">// name被覆盖为Jack</span></span><br><span class="line"><span class="comment">// 删除指定localStorage</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">// 删除所有localStorage</span></span><br><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">clear</span>();</span><br></pre></td></tr></table></figure>

<h1 id="强制缓存-协商缓存"><a href="#强制缓存-协商缓存" class="headerlink" title="强制缓存,协商缓存"></a>强制缓存,协商缓存</h1><p>HTTP 缓存都是从第二次请求开始的：<br>第一次请求资源时，服务器返回资源，并在 response header 中回传资源的缓存策略；<br>第二次请求时，浏览器判断这些请求参数，击中强缓存就直接 200，否则就把请求参数加到 request header 头中传给服务器，看是否击中协商缓存，击中则返回 304，否则服务器会返回新的资源。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1665390838645-21dd5a7c-9d7b-46be-8f11-5295c562a9cf.png#averageHue=%23ebdbd0&clientId=u28f1947f-f233-4&from=paste&height=214&id=u3198c11f&originHeight=214&originWidth=1096&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=126739&status=done&style=none&taskId=ue0545c29-898f-42d5-84b6-38939a39296&title=&width=1096" alt="image.png"></p>
<h2 id="强制缓存"><a href="#强制缓存" class="headerlink" title="强制缓存"></a>强制缓存</h2><p>在缓存未失效时,直接使用浏览器缓存数据,不再请求服务端.生效时,状态码是 200.<br>cache-control 优先级 &gt; expires 优先级。</p>
<h2 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h2><p>第一次请求服务器,或者<code>cache-control</code>和<code>Expire</code>过期,第二次请求就会与服务器协商,与服务端对比资源是否修改更新.没有修改,则返回 304 状态码,继续使用缓存数据.如果更新,则返回 200 状态码,并将缓存信息一并返回.</p>
<h1 id="跨域"><a href="#跨域" class="headerlink" title="跨域"></a>跨域</h1><p>原因: 浏览器的同源策略(为了安全),即同端口,域名,协议.</p>
<blockquote>
<p>跨域并不是请求发不出去，请求能发出去，服务端能收到请求并正常返回结果，只是结果被浏览器拦截了。</p>
</blockquote>
<h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>限制的内容有:</p>
<ul>
<li>cookie, localstorage 等存储内容</li>
<li>DOM 节点</li>
<li>ajax 请求后浏览器返回的结果</li>
</ul>
<p>允许的内容:</p>
<ul>
<li><code>&lt;img src=&quot;xxx&quot;&gt;</code></li>
<li><code>&lt;link href=&quot;xxx&quot;&gt;</code></li>
<li><code>&lt;script src=&quot;xxx&quot;&gt;</code></li>
</ul>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>解决方案有 jsonp、cors、postMessage、websocket、Node 中间件代理(两次跨域)、nginx 反向代理、window.name + iframe、location.hash + iframe、document.domain + iframe<br>日常工作中，用得比较多的跨域方案是 cors 和 nginx 反向代理</p>
<h2 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h2><p>通过 contentWindow 获取内部的 iframe 的 window。非同源的，父级无法获取子级的内容，跨域。<br>父级访问子级：iframe.contentWindow.xxx<br>子级访问父级：window.parent.xxx<br>访问祖先顶级：window.top.xxx</p>
<h1 id="跨域解决"><a href="#跨域解决" class="headerlink" title="跨域解决"></a>跨域解决</h1><h2 id="服务器中转请求"><a href="#服务器中转请求" class="headerlink" title="服务器中转请求"></a>服务器中转请求</h2><p>跨域是浏览器的限制，对服务器没有限制。<br>浏览器向同源的服务器发请求，该服务器向不同源的服务器发请求，返回请求内容，再返给浏览器。</p>
<h2 id="相同基础域名-iframe"><a href="#相同基础域名-iframe" class="headerlink" title="相同基础域名+iframe"></a>相同基础域名+iframe</h2><p>设置<code>document.domain = &#39;xxx&#39;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前页面是test2.jsxx.com；需要请求test.jsxx.com/xx.php，存在跨域</span></span><br><span class="line"><span class="comment">// 利用test2.jsxx.com可以请求该资源，创建一个相同基础域名的iframe，</span></span><br><span class="line"><span class="comment">// 利用iframe去请求资源</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">domain</span> = <span class="string">&quot;jsxx.com&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;ifarme&quot;</span>);</span><br><span class="line">iframe.<span class="property">src</span> = <span class="string">&quot;http://test.jsxx.com/index.html&quot;</span>; <span class="comment">// 这个域名的文件设置相同的基础域名</span></span><br><span class="line">iframe.<span class="property">id</span> = <span class="string">&quot;myIframe&quot;</span>;</span><br><span class="line">iframe.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">iframe.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> contentWindow = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;myIframe&quot;</span>).<span class="property">contentWindow</span>;</span><br><span class="line">  <span class="comment">// 发起请求</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(iframe);</span><br></pre></td></tr></table></figure>

<h2 id="window-name-iframe"><a href="#window-name-iframe" class="headerlink" title="window.name + iframe"></a>window.name + iframe</h2><p>同一个窗口不同的页面，共享同一个 window。<br>在当前窗口的当前页面，设置 window.name &#x3D; ‘123’。跳转到另一个页面，这个页面也可以拿到 window.name&#x3D;’123’。</p>
<p>同一个窗口下的 iframe 如果和父级主窗口不同源，是拿不到 window 的信息的。<br>解决方法：让该不同源的 iframe 跳转到一个和父级同源的 iframe。<br>注意：要在跳转之前，请求数据，使用 window.name 进行保存。跳转的同时，获取 iframe 保存的 name。（iframe 保存的是请求的跨域的那个 window 的 name）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> flag = <span class="literal">false</span>；</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> getDatas = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">    <span class="comment">// 跳转后的加载走这里，contentWindow存的是同一个name，可以获取了</span></span><br><span class="line">    <span class="keyword">var</span> data = iframe.<span class="property">contentWindow</span>.<span class="property">name</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(data));</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// 第一次加载，走这里，跳转到同源地址</span></span><br><span class="line">    flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">setTImeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    	ifrmae.<span class="property">contentWindow</span>.<span class="property">location</span> = <span class="string">&#x27;index2.html&#x27;</span></span><br><span class="line">    &#125;,<span class="number">500</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跨域获取的资源链接</span></span><br><span class="line">iframe.<span class="property">src</span> = <span class="string">&#x27;http://test.jsxx.com/index.html&#x27;</span>;</span><br><span class="line"><span class="comment">// 每次加载时，获取数据</span></span><br><span class="line">iframe.<span class="property">onload</span> = <span class="title function_">getDatas</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(iframe)</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.html</span></span><br><span class="line"><span class="comment">// 获取的数据保存到window上</span></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">name</span> = <span class="string">&#x27;xxx&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="postMessage-iframe"><a href="#postMessage-iframe" class="headerlink" title="postMessage+iframe"></a>postMessage+iframe</h2><p>不经常用原因：</p>
<ol>
<li>伪造数据端漏洞</li>
<li>XSS 攻击</li>
<li>兼容性问题</li>
</ol>
<h2 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h2><p>客户端期望：<code>&#123;&quot;name&quot;: &quot;Jack&quot;, &quot;age&quot;: &quot;18&quot;&#125;</code><br>JSONP 实际返回的：<code>callback(&#123;&quot;name&quot;: &quot;Jack&quot;, &quot;age&quot;: &quot;18&quot;&#125;)</code><br>利用 script 标签允许跨域，在当前页面定义回调函数。在新建的 script 标签上指定要跨域的 src，src 所对应的文件里执行 ajax 请求，成功的回调就是页面中定义的回调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//* 原理</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前页面</span></span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">  <span class="comment">// 定义回调函数</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"><span class="comment">// 新建一个用于跨域的标签,页面加载的时候会执行</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://test.jsxx.com/jsonp/jsonp.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 跨域标签所指向的文件 jsonp.js</span></span><br><span class="line">$.<span class="title function_">ajax</span>(<span class="params"><span class="string">&#x27;xxx&#x27;</span></span>)&#123;</span><br><span class="line">  <span class="title function_">success</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="comment">// 执行回调</span></span><br><span class="line">    <span class="title function_">getData</span>(data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际操作是使用新建 script 的方式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//* 实际操作</span></span><br><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">  <span class="keyword">var</span> oBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;btn&#x27;</span>);</span><br><span class="line"></span><br><span class="line">	oBtn.<span class="property">onClick</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    oScript = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>)</span><br><span class="line">    oScript.<span class="property">src</span> = <span class="string">&quot;http://test.jsxx.com/jsonp/jsonp.php?cb=test&quot;</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(oScript)</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(oScript)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用jQuery封装的方法</span></span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;http://test.jsxx.com/jsonp/jsonp.php&quot;</span>,</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">      <span class="attr">dataType</span>: <span class="string">&quot;JSONP&quot;</span>,</span><br><span class="line">      <span class="attr">jsonp</span>: <span class="string">&quot;cb&quot;</span>,</span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h2 id="cors"><a href="#cors" class="headerlink" title="cors"></a>cors</h2><p>服务端设置<code>Access-Control-Allow-Origin</code>,可以设置哪些域名可以访问资源.</p>
<h2 id="nginx-反向代理"><a href="#nginx-反向代理" class="headerlink" title="nginx 反向代理"></a>nginx 反向代理</h2><p>搭建一个中转 nginx 服务器，用于转发请求.<br>理解: 设置一个中转用的代理服务器,所有接口都访问这个服务器,在这个服务器内设置对应的目标服务器.选择目标服务器获取数据,发送给客户端.<br>实现思路：通过 nginx 配置一个代理服务器（域名与 domain1 相同，端口不同）做跳板机，反向代理访问 domain2 接口，并且可以顺便修改 cookie 中 domain 信息，方便当前域 cookie 写入，实现跨域登录。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>   <span class="number">80</span>; <span class="comment"># 监听的端口</span></span><br><span class="line">    <span class="attribute">server_name</span>   localhost; <span class="comment"># 用户访问 localhost，反向代理到 http://webcanteen.com</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://webcanteen.com <span class="comment"># 即需要代理访问的地址</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 也可以写其他的比如/api</span></span><br><span class="line">    location /api &#123;</span><br><span class="line">      <span class="attribute">proxy_pass</span> http://api.web.com <span class="comment"># 这就可以将请求/api的接口代理到这个地址</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="保持前后端实时通信的方法"><a href="#保持前后端实时通信的方法" class="headerlink" title="保持前后端实时通信的方法"></a>保持前后端实时通信的方法</h1><ol>
<li>websocket</li>
<li>event-source</li>
<li>ajax 轮询</li>
<li>永久帧</li>
</ol>
<h2 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h2><p>优点: 它是在单个 tcp 连接上进行的全双工通讯协议,客户端和服务器只进行一次握手就可以进行持续双向的数据传输.节约资源和带宽.<br>缺点: 1.兼容性.2.不支持断线重连,需要手写心跳连接的逻辑.3.通信机制复杂</p>
<h2 id="event-source"><a href="#event-source" class="headerlink" title="event-source"></a>event-source</h2><p>优点：（1）只需一次请求，便可以 stream 的方式多次传送数据，节约资源和带宽 （2）相对 WebSocket 来说简单易用 （3）内置断线重连功能(retry)<br>缺点： （1）是单向的，只支持服务端-&gt;客户端的数据传送，客户端到服务端的通信仍然依靠 AJAX，没有”一家人整整齐齐“的感觉（2）兼容性令人担忧，IE 浏览器完全不支持</p>
<h2 id="AJAX-轮询"><a href="#AJAX-轮询" class="headerlink" title="AJAX 轮询"></a>AJAX 轮询</h2><p>优点：兼容性良好，对标低版本 IE<br>缺点：请求中有大半是无用的请求，浪费资源</p>
<h1 id="持久登录"><a href="#持久登录" class="headerlink" title="持久登录"></a>持久登录</h1><p>单点登录机制：不同源的站点，相同基础域名，一个登录，其他都登录。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1684758574298-db53e31d-2015-42eb-b58b-9c9b986d9598.png#averageHue=%23ecddc7&clientId=ua496e6b8-bbc9-4&from=paste&height=616&id=u07b71850&originHeight=616&originWidth=1215&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=353330&status=done&style=none&taskId=uc64f2abd-7e23-4097-84aa-99a42ab02b9&title=&width=1215" alt="image.png"></p>
<h2 id="后端加密的操作"><a href="#后端加密的操作" class="headerlink" title="后端加密的操作"></a>后端加密的操作</h2><p>username：md5(md5(username) + salt) &#x3D;&gt; ident_code(身份识别码)<br>password：md5(md5(password) + salt)<br>salt：自定义的字符串<br>token：身份令牌，32&#x2F;16 位随机字符串。每次登录就重新生成。<br>auth：ident_code:token<br>timeout：cookie 的过期时间<br>PC：30 天（如果不点连续登录就是 1 天） App：1 年</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cookie auth= <span class="attr">ident_code</span>:token</span><br><span class="line"><span class="comment">// 后端设置cookie</span></span><br><span class="line"><span class="title function_">setCookie</span>(<span class="string">&#x27;auth&#x27;</span>,<span class="attr">ident_code</span>:token, 过期时间, <span class="string">&#x27;/&#x27;</span>【有效地址】， <span class="string">&#x27;.baidu.com&#x27;</span>【有效域】)</span><br></pre></td></tr></table></figure>

<h2 id="前端获取-cookie"><a href="#前端获取-cookie" class="headerlink" title="前端获取 cookie"></a>前端获取 cookie</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">key, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> cookieArray = <span class="variable language_">document</span>.<span class="property">cookie</span>.<span class="title function_">split</span>(<span class="string">&quot;;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cookieArray.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> cookieItem = cookieArray[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> cookieItemArray = cookieItem.<span class="title function_">split</span>(<span class="string">&quot;=&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cookieItemArray[<span class="number">0</span>] == key) &#123;</span><br><span class="line">      <span class="title function_">cb</span>(cookieItemArray[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">cb</span>(<span class="literal">undefined</span>);</span><br><span class="line">  s;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p>同步上传<br><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1684763445200-a794cc7f-3d6d-4ce7-9a82-639f18030644.png#averageHue=%23242938&clientId=u7e503a4f-f4d3-4&from=paste&height=118&id=ud1f27e89&originHeight=118&originWidth=595&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=84036&status=done&style=none&taskId=ua393ec9e-dcad-4515-b8c2-0e324c9e174&title=&width=595" alt="image.png"></p>
<h2 id="异步上传"><a href="#异步上传" class="headerlink" title="异步上传"></a>异步上传</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1684763305087-a0d802db-3660-4565-85da-eda37a8b7d51.png#averageHue=%23252938&clientId=u7e503a4f-f4d3-4&from=paste&height=592&id=ud7dca94f&originHeight=592&originWidth=663&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=258740&status=done&style=none&taskId=u0617f255-91ed-4625-ab86-5b1546843a2&title=&width=663" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1684763340205-6dea2ec0-e6ec-4e5f-83d9-23d67ff44482.png#averageHue=%23262b3a&clientId=u7e503a4f-f4d3-4&from=paste&height=546&id=u8aaa88f9&originHeight=546&originWidth=625&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=250047&status=done&style=none&taskId=u0a8fd559-b908-4353-9083-805ee7f5d6c&title=&width=625" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1684763386413-670088ab-5e98-46cc-a608-753b95d143b9.png#averageHue=%23252a39&clientId=u7e503a4f-f4d3-4&from=paste&height=379&id=u24a5e12b&originHeight=379&originWidth=465&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=118135&status=done&style=none&taskId=u7d57bb70-62f3-4e8c-9c89-08ea96c457a&title=&width=465" alt="image.png"></p>
<h1 id="HTTP-版本"><a href="#HTTP-版本" class="headerlink" title="HTTP 版本"></a>HTTP 版本</h1><h2 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP&#x2F;1.1"></a>HTTP&#x2F;1.1</h2><ul>
<li>默认持久连接（Connection：keep-alive）</li>
<li>增加管道机制（支持多个请求同时发送）</li>
<li>增加 PUT&#x2F;PATCH&#x2F;DELETE&#x2F;OPTIONS 等请求方式</li>
<li>增加 HOST 字段</li>
<li>增加 100 状态码，支持只发送头信息</li>
<li>增加身份认证机制</li>
<li>支持传送内容的一部分和断点续传</li>
<li>增加 24 个状态码</li>
</ul>
<h2 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP&#x2F;2.0"></a>HTTP&#x2F;2.0</h2><ul>
<li>增加双工模式（同时发送和处理多个请求）</li>
<li>服务器推送（服务端会把客户端需要的资源一起推送到客户端）</li>
<li>头部信息压缩机制（每次请求把所有信息发给服务端【HTTP 协议不带状态】）</li>
<li>二进制协议（头信息与数据体使用二进制进行传输）</li>
<li>多工（先发送已处理好的部分，再响应其他请求,最后再处理没解决的地方）</li>
</ul>
<h1 id="HTTP1-和-HTTP2-的区别"><a href="#HTTP1-和-HTTP2-的区别" class="headerlink" title="HTTP1 和 HTTP2 的区别"></a>HTTP1 和 HTTP2 的区别</h1><ol>
<li>http1 是明文传送,http2 是二进制传送</li>
<li>http2 支持多路复用</li>
<li>http2 支持头部压缩</li>
<li>http2 支持服务器推送</li>
</ol>
<h1 id="HTTP-和-HTTPS-的区别"><a href="#HTTP-和-HTTPS-的区别" class="headerlink" title="HTTP 和 HTTPS 的区别"></a>HTTP 和 HTTPS 的区别</h1><ol>
<li>http 是超文本传输协议,信息是明文传输,https 是具有安全性的 TLS 加密传输协议</li>
<li>https 需要 ca 申请证书</li>
<li>http 端口使用 80,https 使用 443</li>
<li>https 的传输内容都被 SSL&#x2F;TLS 加密，且运行在 SSL&#x2F;TLS 上，SSL&#x2F;TLS 运行在 TCP 连接上。</li>
</ol>
<h1 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h1><p>受 TLS 协议保护的通信过程：先对传输的数据进行了加密（使用对称加密算法）。并且对称加密的密钥是为每一个连接唯一生成的（基于 TLS 握手阶段协商的加密算法和共享密钥），然后发送的每条消息都会通过消息验证码（Message authentication code, MAC），来进行消息完整性检查，最后还可以使用公钥对通信双方进行身份验证</p>
<h2 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h2><p>简单理解就是</p>
<ol>
<li>服务端发证书给客户端</li>
<li>客户端获取 CA 证书中的公钥.</li>
<li>客户端生成对称密钥, 用公钥加密私钥 &#x3D;&gt;发给服务端.</li>
<li>服务端用私钥解密</li>
<li>双方使用这个对称秘钥通信,这时候加密方式就是对称加密</li>
</ol>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>证书可能是伪造的,可能被篡改</p>
<h3 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h3><p>数字签名和摘要.<br>对传输内容通过 hash 算法计算出一段固定的串.用私钥加密,就是数字签名.<br>这个只能用 CA 的公钥解密.防止 CA 被篡改或者伪造.</p>
<h1 id="请求网页的过程"><a href="#请求网页的过程" class="headerlink" title="请求网页的过程"></a>请求网页的过程</h1><p>xxxxxxxx</p>
<h1 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h1><p>URI：统一资源标识符，用来标识唯一的一个资源。<br>URL：统一资源定位符。URL 可以标识一个资源，并且可以用地址定位资源。<br>URN：统一资源命名。通过名字来表示资源。用名称定位资源。<br>URL 肯定是 URI，URI 不一定是 URL，也可能是 URN。<br>URI 是比较宽范的，包含了 URL。</p>
<h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><ol>
<li>资源标识</li>
<li>具有资源定位功能</li>
<li>指明了获取资源的协议</li>
</ol>
<h3 id="URL-组成"><a href="#URL-组成" class="headerlink" title="URL 组成"></a>URL 组成</h3><ol>
<li>协议名称（scheme）：http，https，ws</li>
<li>主机名（host）：域名或 IP</li>
<li>端口号（port）：80（http 默认），443（https 默认）</li>
<li>路径（path）：index&#x2F;index.html</li>
<li>查询字符串（query）：<code>?a=1&amp;b=2</code></li>
</ol>
<h2 id="URL-对象"><a href="#URL-对象" class="headerlink" title="URL 对象"></a>URL 对象</h2><p>创建 URL 对象,</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;https://google.com/search?query=JavaScript&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="searchParams-查询参数"><a href="#searchParams-查询参数" class="headerlink" title="searchParams 查询参数"></a>searchParams 查询参数</h2><p>查询参数是 URLSearchParams 类型.<br>有以下方法:</p>
<ul>
<li>append(name, value) —— 按照 name 添加参数，</li>
<li>delete(name) —— 按照 name 移除参数，</li>
<li>get(name) —— 按照 name 获取参数，</li>
<li>getAll(name) —— 获取相同 name 的所有参数（这是可行的，例如 ?user&#x3D;John&amp;user&#x3D;Pete），</li>
<li>has(name) —— 按照 name 检查参数是否存在，</li>
<li>set(name, value) —— set&#x2F;replace 参数，</li>
<li>sort() —— 按 name 对参数进行排序，很少使用，</li>
</ul>
<p>……并且它是可迭代的，类似于 Map。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="keyword">new</span> <span class="title function_">URL</span>(<span class="string">&quot;https://google.com/search&quot;</span>);</span><br><span class="line"></span><br><span class="line">url.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;q&quot;</span>, <span class="string">&quot;test me!&quot;</span>); <span class="comment">// 添加带有一个空格和一个 ! 的参数</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">alert</span>(url); <span class="comment">// https://google.com/search?q=test+me%21</span></span><br><span class="line"></span><br><span class="line">url.<span class="property">searchParams</span>.<span class="title function_">set</span>(<span class="string">&quot;tbs&quot;</span>, <span class="string">&quot;qdr:y&quot;</span>); <span class="comment">// 添加带有一个冒号 : 的参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数会被自动编码</span></span><br><span class="line"><span class="title function_">alert</span>(url); <span class="comment">// https://google.com/search?q=test+me%21&amp;tbs=qdr%3Ay</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历搜索参数（被解码）</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [name, value] <span class="keyword">of</span> url.<span class="property">searchParams</span>) &#123;</span><br><span class="line">  <span class="title function_">alert</span>(<span class="string">`<span class="subst">$&#123;name&#125;</span>=<span class="subst">$&#123;value&#125;</span>`</span>); <span class="comment">// q=test me!，然后是 tbs=qdr:y</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h1><p>传输控制协议<br>特点：面向连接（收发数据前，必须建立可靠的连接）<br>建立连接基础：三次握手<br>应用场景：数据必须准确无误的收发<br>HTTP 请求、FTP 文件传输、邮件收发<br>优点：稳定、重传机制、拥塞机制、断开连接<br>缺点：速度慢、效率低、占用资源、容易被攻击</p>
<h1 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h1><p>类似于喇叭广播<br>特点：面向无连接（不可靠协议，无状态传输机制）<br>无连接信息发送机制<br>应用场景：无需确保通信质量且要求速度快，无需确保信息完整<br>消息收发，语音通话，直播<br>优点：安全，快速，漏洞少<br>缺点：不可靠，不稳定，易丢包<br>总结：只要目的源地址，端口号，地址，端口号 确定，就可以直接发送信息，但不保证一定能收到完整的信息。</p>
<h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1684678066485-5a519a99-2a97-4603-9b1f-e68d863f2018.png#averageHue=%23eae8ea&clientId=ubc734814-557f-4&from=ui&id=u6878ba0b&originHeight=354&originWidth=717&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=141971&status=done&style=none&taskId=u7ca76827-e5df-4898-8fff-201650d97c2&title=" alt="iShot2023-05-21 22.07.22.png"><br><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1684678078009-e12f03d6-0062-4330-b8af-c53f796f011d.png#averageHue=%23e6e5e6&clientId=ubc734814-557f-4&from=ui&id=u1e525aa7&originHeight=339&originWidth=824&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=195343&status=done&style=none&taskId=u3525f51d-9e80-4619-a177-9641e84f70f&title=" alt="iShot2023-05-21 22.06.57.png"></p>
<h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p>FIN-WAIT-1：等待远程 TCP 的中断请求，或先前的连接中断请求的确认<br>FIN-WAIT-2：从远程 TCP 等待连接中断请求<br>CLOSE-WAIT：等待从本地用户发送的连接中断请求<br>LAST-ACK：等待原来发向远程 TCP 的连接中断请求的确认<br>TIME-WAIT：等待足够的时间以确保远程 TCP 接收到连接中断请求的确认<br>CLOSED：没有任何连接状态</p>
<h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><p>第一次：客户端发送连接关闭报文 FN1，客户端进入终止等待（FIN-WAIT-1）<br>第二次：服务器收到连接关闭报文，发送确认报文 ACK1，服务器进入 CLOSE-WAIT 状态。<br>客户端收到服务端的确认请求，客户端进入终止等待 2（FIN-WAIT-2）状态，有可能有未发送完的信息<br>第三次：服务端确认数据发送完毕，向客户端发送连接关闭报文 FN1 ACK1，进入最后确认状态（LAST-ACK）<br>第四次：客户端收到服务端的连接关闭报文后，发出确认接收报文 ACK1，客户端进入时间等待状态（TIME-WAIT）<br>服务端接收到确认报文后，立即进入连接状态（CLOSED）。客户端在等待 2MSL 后关闭连接。</p>
<h1 id="HTTP-报文"><a href="#HTTP-报文" class="headerlink" title="HTTP 报文"></a>HTTP 报文</h1><h2 id="请求方式"><a href="#请求方式" class="headerlink" title="请求方式"></a>请求方式</h2><p>PUT：上传资源。form 表单不支持，提交即存储的原则，需要配置服务器。<br>DELETE：删除资源。form 表单不支持，提交即存储的原则，需要配置服务器。<br>POST：修改资源。<br>GET：获取资源。</p>
<h2 id="GET-POST-异同"><a href="#GET-POST-异同" class="headerlink" title="GET&#x2F;POST 异同"></a>GET&#x2F;POST 异同</h2><ol>
<li>post 更安全：不会作为 url 一部分，不会被缓存，不会保存在浏览器记录中</li>
<li>post 发送的数据量更大：GET 有长度限制</li>
<li>post 能发送更多的数据类型：GET 只能发 ASCII 字符</li>
<li>post 比 get 慢：POST 包含更多请求头，POST 请求先将请求头发给服务器，然后才发数据，GET 会缓存。</li>
<li>post 的请求体是 formData，get 的请求体是 query sring。</li>
</ol>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><p>1xx：信息，服务器收到请求。需要请求者继续执行操作。<br>2xx：成功，操作被成功接收并处理。<br>3xx：重定向，需要进一步的操作以完成请求。<br>4xx：客户端错误。请求包含语法错误或无法完成的请求。<br>5xx：服务端错误。服务器在处理请求的过程中发生错误。</p>
<h3 id="304"><a href="#304" class="headerlink" title="304"></a>304</h3><p>缓存重定向。自上一次请求后，网页未被修改。</p>
<p>第一次发送请求，服务器会返回两个信息在响应头里。<br>E-Tag：唯一标识。<br>Last-Modifed：上次修改时间。<br>第二次发送请求，拿上这两个信息，重新命名，<br>If-Modify-Since：&#x3D;&gt; Last-Modifed 的信息。<br>If-None-Match： &#x3D;&gt; E-Tag 的信息。<br>发给 服务端，服务端对比后，发现没有变化，就返回 304。浏览器从缓存中获取数据。</p>
<h3 id="301-和-302"><a href="#301-和-302" class="headerlink" title="301 和 302"></a>301 和 302</h3><p>301：永久重定向，表示请求的资源分配了新的 url，以后应使用新 url。<br>302：临时重定向，请求的资源临时分配了新的 url（response 中 location 所指的地址），本次请求暂时使用新 url。服务器返回 302 时，也会返回 location，浏览器再次请求 location 中指定的地址，也就是浏览器请求了 2 次</p>
<h3 id="401"><a href="#401" class="headerlink" title="401"></a>401</h3><p>为认证设计，返回 401 说明未通过认证。可能是认证出错或没有认证。</p>
<h3 id="403"><a href="#403" class="headerlink" title="403"></a>403</h3><p>服务器拒绝请求。<br>这是授权相关，完成了认证，但是权限不够，不预授权。</p>
<h3 id="404"><a href="#404" class="headerlink" title="404"></a>404</h3><p>未找到相应网页或资源。</p>
<h2 id="Accept-Content-Type"><a href="#Accept-Content-Type" class="headerlink" title="Accept &amp; Content-Type"></a>Accept &amp; Content-Type</h2><p>q：相对品质因子，权重。从 0 到 1，表示优先级。默认 1。0 表示该类型不被浏览器接受。<br>Accept（请求头）：type;q&#x3D;value, type;q&#x3D;value 分号是表示符号，逗号是分隔符号。</p>
<p>Content-Type（响应头）：text&#x2F;html;charset&#x3D;UTF-8（Accept-Charset）<br>返回的资源类型与编码</p>
<p>Accept-Language：支持的语言。<br>Content-Language：返回的语言。</p>
<p>Accept-Encoding：接受的压缩格式。（gzip,defalte,br)<br>Content-Encoding：返回的压缩格式。(优化传输大小）</p>
<h2 id="Connection：Keep-alive"><a href="#Connection：Keep-alive" class="headerlink" title="Connection：Keep-alive"></a>Connection：Keep-alive</h2><p>长连接。<br>http1.1：默认开启。需要关闭：close。</p>
<h2 id="Content-length"><a href="#Content-length" class="headerlink" title="Content-length"></a>Content-length</h2><p>消息实体的传输长度。</p>
<h2 id="referer"><a href="#referer" class="headerlink" title="referer"></a>referer</h2><p>来源域名。告诉服务器是从哪个域名来的。<br>比如从百度搜 qq 官网，qq 官网请求头会显示 referer:<a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a><br>场景：资源防盗链。拉取资源前判断 referer 是否是自己的域名。</p>
<h1 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h1><p>pragma：no-cache（响应头） &#x3D;&gt; 忽略缓存。每次请求都从走服务器。</p>
<h2 id="cache-control"><a href="#cache-control" class="headerlink" title="cache-control"></a>cache-control</h2><p>http1.0：cache-control 替代 pragma。向下兼容。<br>选项：<br>none-cache：忽略缓存（并非不要缓存）。<br>no-store：不要缓存。<br>max-age&#x3D;316000：缓存的有效时长。从请求开始到过期的时间秒数。<br>public：响应可以被任何对象缓存。<br>private：响应只能被单个用户缓存，不能被共享。</p>
<h2 id="Expires-max-age"><a href="#Expires-max-age" class="headerlink" title="Expires&#x2F;max-age"></a>Expires&#x2F;max-age</h2><p>过期时间。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ol>
<li>发请求</li>
<li>有缓存，查看是否过期，不过期，直接读取缓存，返回 200</li>
<li>是否有 E-tag，Last-Modifed。有向服务端发送。E-tag(If-None-Match)优先级高，先验证它，一致后再验证 Last-Modifed(If-Modifed-Since).</li>
<li>资源未修改，返回 304，从缓存获取资源。失效，返回 200，重新返回资源。</li>
</ol>
<h1 id="history"><a href="#history" class="headerlink" title="history"></a>history</h1><p>histroy 栈<br>存储历史记录。<br>length 属性：存了多少条。</p>
<h2 id="replaceState"><a href="#replaceState" class="headerlink" title="replaceState"></a>replaceState</h2><p>用于替换 history 栈中的条目。有三个参数。</p>
<ol>
<li>对象</li>
<li>网页名</li>
<li>url 地址</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.<span class="title function_">replaceState</span>(<span class="string">&quot;text name&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;text.html&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="pushState"><a href="#pushState" class="headerlink" title="pushState"></a>pushState</h2><p>和 replaceState 类似。也是三个参数。<br>区别：pushState 是添加，replaceState 是直接替换。<br>这两个方法修改 url 后，都不会引起渲染。</p>
<h2 id="popState"><a href="#popState" class="headerlink" title="popState"></a>popState</h2><p>在历史活动条目发送改变时触发。<br>在 pushState 和 replaceState 触发时不改变，手动点击后退时，触发。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;popState&quot;</span>, <span class="function">() =&gt;</span> &#123;&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="hashChange"><a href="#hashChange" class="headerlink" title="hashChange"></a>hashChange</h2><p>当 hash 值改变，可以监听事件。、</p>
<h1 id="web-worker"><a href="#web-worker" class="headerlink" title="web worker"></a>web worker</h1><p>开启一个新的线程。线程内只有 this，没有 window 和 document。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">Worker</span>) &#123;</span><br><span class="line">  <span class="comment">// 实例化</span></span><br><span class="line">  <span class="keyword">var</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&quot;worker.js&quot;</span>);</span><br><span class="line">  <span class="comment">// 信息</span></span><br><span class="line">  <span class="keyword">var</span> message = &#123; <span class="attr">addThis</span>: &#123; <span class="attr">num</span>: <span class="number">1</span>, <span class="attr">num2</span>: <span class="number">1</span> &#125; &#125;;</span><br><span class="line">  <span class="comment">// 传递信息</span></span><br><span class="line">  myWorker.<span class="title function_">postMessage</span>(message);</span><br><span class="line">  <span class="comment">// 接收信息</span></span><br><span class="line">  myWorker.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// wokker.js</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (e.<span class="property">data</span>.<span class="property">addThs</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> message = &#123;</span><br><span class="line">      <span class="attr">result</span>: e.<span class="property">data</span>.<span class="property">addThis</span>.<span class="property">num1</span> + e.<span class="property">data</span>.<span class="property">addThis</span>.<span class="property">num2</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">postMessage</span>(message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/22/JS%E6%89%8B%E5%86%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/22/JS%E6%89%8B%E5%86%99/" class="post-title-link" itemprop="url">JS手写</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-22 16:57:00" itemprop="dateCreated datePublished" datetime="2022-09-22T16:57:00+08:00">2022-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="手写数组转树"><a href="#手写数组转树" class="headerlink" title="手写数组转树"></a>手写数组转树</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 例如将 input 转成output的形式</span></span><br><span class="line"><span class="keyword">let</span> input = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">val</span>: <span class="string">&quot;学校&quot;</span>,</span><br><span class="line">    <span class="attr">parentId</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">val</span>: <span class="string">&quot;班级1&quot;</span>,</span><br><span class="line">    <span class="attr">parentId</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">val</span>: <span class="string">&quot;班级2&quot;</span>,</span><br><span class="line">    <span class="attr">parentId</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">val</span>: <span class="string">&quot;学生1&quot;</span>,</span><br><span class="line">    <span class="attr">parentId</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">5</span>,</span><br><span class="line">    <span class="attr">val</span>: <span class="string">&quot;学生2&quot;</span>,</span><br><span class="line">    <span class="attr">parentId</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="attr">val</span>: <span class="string">&quot;学生3&quot;</span>,</span><br><span class="line">    <span class="attr">parentId</span>: <span class="number">3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> output = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">val</span>: <span class="string">&quot;学校&quot;</span>,</span><br><span class="line">  <span class="attr">children</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">val</span>: <span class="string">&quot;班级1&quot;</span>,</span><br><span class="line">      <span class="attr">children</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">id</span>: <span class="number">4</span>,</span><br><span class="line">          <span class="attr">val</span>: <span class="string">&quot;学生1&quot;</span>,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">id</span>: <span class="number">5</span>,</span><br><span class="line">          <span class="attr">val</span>: <span class="string">&quot;学生2&quot;</span>,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">val</span>: <span class="string">&quot;班级2&quot;</span>,</span><br><span class="line">      <span class="attr">children</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">id</span>: <span class="number">6</span>,</span><br><span class="line">          <span class="attr">val</span>: <span class="string">&quot;学生3&quot;</span>,</span><br><span class="line">          <span class="attr">children</span>: [],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">arrToTree</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> arr.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">    item.<span class="property">children</span> = arr.<span class="title function_">filter</span>(<span class="function">(<span class="params">i</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> item.<span class="property">id</span> === i.<span class="property">parentId</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> !item.<span class="property">parentId</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">arrToTree</span>(<span class="params">arr, parentId</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> parentArr = arr.<span class="title function_">filter</span>(<span class="function">(<span class="params">item</span>) =&gt;</span></span><br><span class="line">    parentId === <span class="literal">undefined</span> ? item.<span class="property">parentId</span> === <span class="literal">null</span> : item.<span class="property">parentId</span> === parentId</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> parentArr.<span class="title function_">map</span>(<span class="function">(<span class="params">i</span>) =&gt;</span> &#123;</span><br><span class="line">    i.<span class="property">children</span> = <span class="title function_">arrToTree</span>(arr, i.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getChildren</span>(<span class="params">arr, result, parentId</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> arr) &#123;</span><br><span class="line">    <span class="keyword">if</span> (item.<span class="property">parentId</span> === parentId) &#123;</span><br><span class="line">      <span class="keyword">const</span> newItem = &#123; ...item, <span class="attr">children</span>: [] &#125;;</span><br><span class="line">      result.<span class="title function_">push</span>(newItem);</span><br><span class="line">      <span class="title function_">getChildren</span>(arr, newItem.<span class="property">children</span>, item.<span class="property">id</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arrToTree</span>(<span class="params">arr, parentId</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> result = [];</span><br><span class="line">  <span class="title function_">getChildren</span>(arr, result, parentId);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">arrToTree</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> map = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> arr) &#123;</span><br><span class="line">    item.<span class="property">children</span> = [];</span><br><span class="line">    map.<span class="title function_">set</span>(item.<span class="property">id</span>, item);</span><br><span class="line">    map.<span class="title function_">has</span>(item.<span class="property">parentId</span>) &amp;&amp; map.<span class="title function_">get</span>(item.<span class="property">parentId</span>).<span class="property">children</span>.<span class="title function_">push</span>(item);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> map.<span class="title function_">get</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写法一</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">arrayToTree</span>(<span class="params">array</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> root = array[<span class="number">0</span>];</span><br><span class="line">  array.<span class="title function_">shift</span>();</span><br><span class="line">  <span class="keyword">let</span> tree = &#123;</span><br><span class="line">    <span class="attr">id</span>: root.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">val</span>: root.<span class="property">val</span>,</span><br><span class="line">    <span class="attr">children</span>: array.<span class="property">length</span> &gt; <span class="number">0</span> ? <span class="title function_">toTree</span>(root.<span class="property">id</span>, array) : [],</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> tree;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toTree</span>(<span class="params">parenId, array</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> children = [];</span><br><span class="line">  <span class="keyword">let</span> len = array.<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> node = array[i];</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">parentId</span> === parenId) &#123;</span><br><span class="line">      children.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">id</span>: node.<span class="property">id</span>,</span><br><span class="line">        <span class="attr">val</span>: node.<span class="property">val</span>,</span><br><span class="line">        <span class="attr">children</span>: <span class="title function_">toTree</span>(node.<span class="property">id</span>, array),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">arrayToTree</span>(input));</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 写法二</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getTreeList</span>(<span class="params">rootList, id, list</span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> item <span class="keyword">of</span> rootList) &#123;</span><br><span class="line">    <span class="keyword">if</span> (item.<span class="property">parentid</span> === id) &#123;</span><br><span class="line">      list.<span class="title function_">push</span>(item);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> list) &#123;</span><br><span class="line">    i.<span class="property">children</span> = [];</span><br><span class="line">    <span class="title function_">getTreeList</span>(rootList, i.<span class="property">id</span>, i.<span class="property">children</span>);</span><br><span class="line">    <span class="comment">// 去除children为[]的情况</span></span><br><span class="line">    <span class="keyword">if</span> (i.<span class="property">children</span>.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">delete</span> i.<span class="property">children</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> res = <span class="title function_">getTreeList</span>(input, <span class="literal">null</span>, []);</span><br></pre></td></tr></table></figure>

<h1 id="手写-Promise-A"><a href="#手写-Promise-A" class="headerlink" title="手写 Promise&#x2F;A+"></a>手写 Promise&#x2F;A+</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义状态</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PENDING</span> = <span class="string">&quot;PENDING&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FULFILLED</span> = <span class="string">&quot;FULFILLED&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REJECTED</span> = <span class="string">&quot;REJECTED&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="comment">// 捕获执行器的错误</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 立即执行执行器</span></span><br><span class="line">      <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// promise状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">PENDING</span>; <span class="comment">// 默认值</span></span><br><span class="line">    <span class="comment">// 成功后的值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="comment">// 失败后的原因</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="comment">// 成功回调</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">successCallback</span> = [];</span><br><span class="line">    <span class="comment">// 失败回调</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">failCallback</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加resolve</span></span><br><span class="line">  resolve = <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 由状态修改后无法再次修改</span></span><br><span class="line">    <span class="comment">// 如果状态不是等待 就阻止程序向下执行</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> !== <span class="variable constant_">PENDING</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将状态更改为成功</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">    <span class="comment">// 保存成功后的值</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = value;</span><br><span class="line">    <span class="comment">// 成功回调是否存在,存在就调用</span></span><br><span class="line">    <span class="comment">// this.successCallback &amp;&amp; this.successCallback(this.value)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">successCallback</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">fn</span>) =&gt;</span> <span class="title function_">fn</span>());</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 添加reject</span></span><br><span class="line">  reject = <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果状态不是等待 就阻止程序向下执行</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> !== <span class="variable constant_">PENDING</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 将状态更改为失败</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">status</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">    <span class="comment">// 保存失败后的原因</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reason</span> = reason;</span><br><span class="line">    <span class="comment">// 失败回调是否存在,存在就调用</span></span><br><span class="line">    <span class="comment">// this.failCallback &amp;&amp; this.failCallback(this.reason)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">failCallback</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">fn</span>) =&gt;</span> <span class="title function_">fn</span>());</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// then方法内部就是判断状态,成功状态调用成功函数,失败状态调用失败函数</span></span><br><span class="line">  <span class="comment">// then成功回调的参数是成功后的值,失败回调的参数是返回的原因</span></span><br><span class="line"></span><br><span class="line">  then = <span class="function">(<span class="params">successCallback, failCallback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// then链式传递</span></span><br><span class="line">    successCallback =</span><br><span class="line">      <span class="keyword">typeof</span> successCallback === <span class="string">&quot;function&quot;</span></span><br><span class="line">        ? successCallback</span><br><span class="line">        : <span class="function">(<span class="params">value</span>) =&gt;</span> value;</span><br><span class="line">    failCallback =</span><br><span class="line">      <span class="keyword">typeof</span> failCallback === <span class="string">&quot;function&quot;</span></span><br><span class="line">        ? failCallback</span><br><span class="line">        : <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">          &#125;;</span><br><span class="line">    <span class="comment">// then方法每次都要返回一个promise</span></span><br><span class="line">    <span class="keyword">let</span> promise2 = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 判断状态</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">FULFILLED</span>) &#123;</span><br><span class="line">        <span class="comment">// 将代码用setTimeout包裹变成异步代码,为了能拿到promise2</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 捕获错误</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> x = <span class="title function_">successCallback</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="comment">// 判断x的值是普通值还是promise对象</span></span><br><span class="line">            <span class="comment">// 如果是普通值,直接调用resolve</span></span><br><span class="line">            <span class="comment">// 如果是promise, 查看promise对象返回的结果,根据结果,绝对调用resolve还是reject</span></span><br><span class="line">            <span class="comment">// 把返回值传递给下一个回调</span></span><br><span class="line">            <span class="title function_">resolvePromise</span>(promise2, x, resolve, reject);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="variable constant_">REJECTED</span>) &#123;</span><br><span class="line">        <span class="comment">// 将代码用setTimeout包裹变成异步代码,为了能拿到promise2</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 捕获错误</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> x = <span class="title function_">failCallback</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span><br><span class="line">            <span class="comment">// 判断x的值是普通值还是promise对象</span></span><br><span class="line">            <span class="comment">// 如果是普通值,直接调用resolve</span></span><br><span class="line">            <span class="comment">// 如果是promise, 查看promise对象返回的结果,根据结果,绝对调用resolve还是reject</span></span><br><span class="line">            <span class="comment">// 把返回值传递给下一个回调</span></span><br><span class="line">            <span class="title function_">resolvePromise</span>(promise2, x, resolve, reject);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(error);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 状态是pending,是存在异步情况</span></span><br><span class="line">        <span class="comment">// 将成功回调和失败回调存储起来</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">successCallback</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 捕获错误</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">let</span> x = <span class="title function_">successCallback</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span><br><span class="line">              <span class="comment">// 判断x的值是普通值还是promise对象</span></span><br><span class="line">              <span class="comment">// 如果是普通值,直接调用resolve</span></span><br><span class="line">              <span class="comment">// 如果是promise, 查看promise对象返回的结果,根据结果,绝对调用resolve还是reject</span></span><br><span class="line">              <span class="comment">// 把返回值传递给下一个回调</span></span><br><span class="line">              <span class="title function_">resolvePromise</span>(promise2, x, resolve, reject);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">              <span class="title function_">reject</span>(error);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, <span class="number">0</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">failCallback</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 捕获错误</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">let</span> x = <span class="title function_">failCallback</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span><br><span class="line">              <span class="comment">// 判断x的值是普通值还是promise对象</span></span><br><span class="line">              <span class="comment">// 如果是普通值,直接调用resolve</span></span><br><span class="line">              <span class="comment">// 如果是promise, 查看promise对象返回的结果,根据结果,绝对调用resolve还是reject</span></span><br><span class="line">              <span class="comment">// 把返回值传递给下一个回调</span></span><br><span class="line">              <span class="title function_">resolvePromise</span>(promise2, x, resolve, reject);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">              <span class="title function_">reject</span>(error);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;, <span class="number">0</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise2;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 捕获错误</span></span><br><span class="line">  <span class="keyword">catch</span>(failCallback) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(<span class="literal">undefined</span>, failCallback);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 then的链式调用</span></span><br><span class="line">  <span class="keyword">finally</span> = <span class="function">(<span class="params">callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 使用then保证链式调用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(</span><br><span class="line">      <span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 使用resolve保证返回promise对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="title function_">callback</span>()).<span class="title function_">then</span>(<span class="function">() =&gt;</span> value);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">MyPromise</span>.<span class="title function_">resolve</span>(<span class="title function_">callback</span>()).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">all</span>(<span class="params">array</span>) &#123;</span><br><span class="line">    <span class="comment">// 设置返回的数组</span></span><br><span class="line">    <span class="keyword">let</span> result = [];</span><br><span class="line">    <span class="comment">// 设置计数器</span></span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; array.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> current = array[i];</span><br><span class="line">        <span class="keyword">if</span> (current <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) &#123;</span><br><span class="line">          <span class="comment">// 是promise对象</span></span><br><span class="line">          current.<span class="title function_">then</span>(</span><br><span class="line">            <span class="function">(<span class="params">value</span>) =&gt;</span> <span class="title function_">addData</span>(i, value),</span><br><span class="line">            <span class="function">(<span class="params">reason</span>) =&gt;</span> <span class="title function_">reject</span>(reason)</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 普通值</span></span><br><span class="line">          <span class="title function_">addData</span>(i, array[i]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">addData</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">        <span class="comment">// 保证位置是按顺序的</span></span><br><span class="line">        result[key] = value;</span><br><span class="line">        <span class="comment">// 跑一个算一个</span></span><br><span class="line">        index++;</span><br><span class="line">        <span class="comment">// 计数器和数组长度相等说明都跑完了</span></span><br><span class="line">        <span class="keyword">if</span> (index === array.<span class="property">length</span>) &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(result);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) <span class="keyword">return</span> value;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> <span class="title function_">resolve</span>(value));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">promise2, x, resolve, reject</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (promise2 === x) &#123;</span><br><span class="line">    <span class="comment">// 如果自我调用就报错,并阻止继续执行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">reject</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot;Chaining cycle detected for promise #&lt;Promise&gt;&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (x <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) &#123;</span><br><span class="line">    <span class="comment">// x 是否是MyPromise的实例对象,是就是promise对象</span></span><br><span class="line">    x.<span class="title function_">then</span>(resolve, reject);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 普通值</span></span><br><span class="line">    <span class="title function_">resolve</span>(x);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="手写去重"><a href="#手写去重" class="headerlink" title="手写去重"></a>手写去重</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> arr = [];</span><br><span class="line"><span class="title class_">Array</span>.<span class="title function_">form</span>(<span class="keyword">new</span> <span class="title class_">Set</span>(arr));</span><br></pre></td></tr></table></figure>

<h1 id="手写防抖"><a href="#手写防抖" class="headerlink" title="手写防抖"></a>手写防抖</h1><p>顾名思义,防止抖动,手抖多点了几次,怎么办,只算最后一次.<br>debounce</p>
<h1 id="手写节流"><a href="#手写节流" class="headerlink" title="手写节流"></a>手写节流</h1><p>顾名思义,一直在流,但是为了节约,隔一段时间流一次.<br>throttle</p>
<h1 id="手写多维数组扁平化"><a href="#手写多维数组扁平化" class="headerlink" title="手写多维数组扁平化"></a>手写多维数组扁平化</h1><h1 id="手写-redux"><a href="#手写-redux" class="headerlink" title="手写 redux"></a>手写 redux</h1><h1 id="手写-useState，useEffect，useReducer"><a href="#手写-useState，useEffect，useReducer" class="headerlink" title="手写 useState，useEffect，useReducer"></a>手写 useState，useEffect，useReducer</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> state = [];</span><br><span class="line"><span class="keyword">let</span> setters = [];</span><br><span class="line"><span class="keyword">let</span> stateIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createSetter</span>(<span class="params">index</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">newState</span>) &#123;</span><br><span class="line">    state[index] = newState;</span><br><span class="line">    <span class="title function_">render</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useState</span>(<span class="params">initState</span>) &#123;</span><br><span class="line">  state[stateIndex] = state[stateIndex] ? state[stateIndex] : initState;</span><br><span class="line">  setters.<span class="title function_">push</span>(<span class="title function_">createSetter</span>(stateIndex));</span><br><span class="line">  stateIndex++;</span><br><span class="line">  <span class="comment">// 状态</span></span><br><span class="line">  <span class="keyword">let</span> value = state[stateIndex];</span><br><span class="line">  <span class="comment">// 方法</span></span><br><span class="line">  <span class="keyword">let</span> setter = setters[stateIndex];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [value, setter];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上一次的依赖值</span></span><br><span class="line"><span class="keyword">let</span> prevDepsAry = [];</span><br><span class="line"><span class="comment">// 这个声明用于多个effect的情况</span></span><br><span class="line"><span class="keyword">let</span> effectIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useEffect</span>(<span class="params">callback, depsAry</span>) &#123;</span><br><span class="line">  <span class="comment">// 判断callback是否为函数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(callback) !== <span class="string">&quot;[object Function]&quot;</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;useEffect接收一个函数&quot;</span>);</span><br><span class="line">  <span class="comment">// 判断depsAry是否传递</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> depsAry === <span class="string">&quot;undefined&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 没有传递</span></span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 判断depsAry是不是数组</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(depsAry) !== <span class="string">&quot;[object Array]&quot;</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;useEffect依赖必须是数组&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取上一次的值,如果有就取,没有不取</span></span><br><span class="line">    <span class="keyword">let</span> prevDeps = prevDepsAry[effectIndex];</span><br><span class="line">    <span class="comment">// 判断当前依赖值与上一次依赖,是否有变化,有才调用callback</span></span><br><span class="line">    <span class="keyword">let</span> hasChanged = prevDeps</span><br><span class="line">      ? depsAry.<span class="title function_">every</span>(<span class="function">(<span class="params">dep, index</span>) =&gt;</span> dep === prevDeps[index]) === <span class="literal">false</span></span><br><span class="line">      : <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 判断值是否有变化</span></span><br><span class="line">    <span class="keyword">if</span> (hasChanged) &#123;</span><br><span class="line">      <span class="title function_">callback</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 比完之后要同步依赖值,保证依赖值最新</span></span><br><span class="line">    prevDepsAry[effectIndex] = depsAry;</span><br><span class="line">    <span class="comment">// 多个useEffect时标记增加,记得在render时归零</span></span><br><span class="line">    effectIndex++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useReducer</span>(<span class="params">reducer, initState</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = <span class="title function_">useState</span>(initState);</span><br><span class="line">  <span class="comment">// useReducer内部返回dispatch方法</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">    <span class="comment">// dispatch内部调用reducer返回最新的state</span></span><br><span class="line">    <span class="keyword">const</span> newState = <span class="title function_">reducer</span>(state, action);</span><br><span class="line">    <span class="title function_">setState</span>(newState);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> [state, dispatch];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, dispatch] = <span class="title function_">useReducer</span>(render, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;increment&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;decrement&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> state - <span class="number">1</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;count&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(&#123; type: &quot;increment&quot; &#125;)&#125;&gt;add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(&#123; type: &quot;decrement&quot; &#125;)&#125;&gt;delete<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  stateIndex = <span class="number">0</span>;</span><br><span class="line">  effectIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="手写-Vue"><a href="#手写-Vue" class="headerlink" title="手写 Vue"></a>手写 Vue</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Observer</span> = <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="comment">// 循环修改为每个属性添加get set</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> data) &#123;</span><br><span class="line">    <span class="title function_">defineReactive</span>(data, key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defineReactive = <span class="keyword">function</span> (<span class="params">obj, key</span>) &#123;</span><br><span class="line">  <span class="comment">// 局部变量dep，用于get set内部调用</span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>();</span><br><span class="line">  <span class="comment">// 获取当前值</span></span><br><span class="line">  <span class="keyword">let</span> val = obj[key];</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="comment">// 设置当前描述属性为可被循环</span></span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 设置当前描述属性可被修改</span></span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;in get&quot;</span>);</span><br><span class="line">      <span class="comment">// 调用依赖收集器中的addSub，用于收集当前属性与Watcher中的依赖关系</span></span><br><span class="line">      dep.<span class="title function_">depend</span>();</span><br><span class="line">      <span class="keyword">return</span> val;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal === val) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      val = newVal;</span><br><span class="line">      <span class="comment">// 当值发生变更时，通知依赖收集器，更新每个需要更新的Watcher，</span></span><br><span class="line">      <span class="comment">// 这里每个需要更新通过什么断定？dep.subs</span></span><br><span class="line">      dep.<span class="title function_">notify</span>();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> observe = <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Observer</span>(data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Vue</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">// 将data赋值给this._data，源码这部分用的Proxy所以我们用最简单的方式临时实现</span></span><br><span class="line">  <span class="keyword">if</span> (options &amp;&amp; <span class="keyword">typeof</span> options.<span class="property">data</span> === <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_data</span> = options.<span class="property">data</span>.<span class="title function_">apply</span>(<span class="variable language_">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 挂载函数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mount</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Watcher</span>(self, self.<span class="property">render</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 渲染函数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">render</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">with</span> (self) &#123;</span><br><span class="line">      _data.<span class="property">text</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 监听this._data</span></span><br><span class="line">  <span class="title function_">observe</span>(<span class="variable language_">this</span>.<span class="property">_data</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Watcher</span> = <span class="keyword">function</span> (<span class="params">vm, fn</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">vm</span> = vm;</span><br><span class="line">  <span class="comment">// 将当前Dep.target指向自己</span></span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">// 向Dep方法添加当前Wathcer</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">addDep</span> = <span class="keyword">function</span> (<span class="params">dep</span>) &#123;</span><br><span class="line">    dep.<span class="title function_">addSub</span>(self);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 更新方法，用于触发vm._render</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">update</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;in watcher update&quot;</span>);</span><br><span class="line">    <span class="title function_">fn</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 这里会首次调用vm._render，从而触发text的get</span></span><br><span class="line">  <span class="comment">// 从而将当前的Wathcer与Dep关联起来</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">value</span> = <span class="title function_">fn</span>();</span><br><span class="line">  <span class="comment">// 这里清空了Dep.target，为了防止notify触发时，不停的绑定Watcher与Dep，</span></span><br><span class="line">  <span class="comment">// 造成代码死循环</span></span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Dep</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> self = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">// 收集目标</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 存储收集器中需要通知的Watcher</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subs</span> = [];</span><br><span class="line">  <span class="comment">// 当有目标时，绑定Dep与Wathcer的关系</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">depend</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">      self.<span class="title function_">addSub</span>(<span class="title class_">Dep</span>.<span class="property">target</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 为当前收集器添加Watcher</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">addSub</span> = <span class="keyword">function</span> (<span class="params">watcher</span>) &#123;</span><br><span class="line">    self.<span class="property">subs</span>.<span class="title function_">push</span>(watcher);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 通知收集器中所的所有Wathcer，调用其update方法</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">notify</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; self.<span class="property">subs</span>.<span class="property">length</span>; i += <span class="number">1</span>) &#123;</span><br><span class="line">      self.<span class="property">subs</span>[i].<span class="title function_">update</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vue = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">text</span>: <span class="string">&quot;hello world&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">vue.<span class="title function_">mount</span>(); <span class="comment">// in get</span></span><br><span class="line">vue.<span class="property">_data</span>.<span class="property">text</span> = <span class="string">&quot;123&quot;</span>; <span class="comment">// in watcher update /n in get</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/20/React%E9%AB%98%E9%98%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/20/React%E9%AB%98%E9%98%B6/" class="post-title-link" itemprop="url">React高阶</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-20 17:27:10" itemprop="dateCreated datePublished" datetime="2022-09-20T17:27:10+08:00">2022-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="错误边界"><a href="#错误边界" class="headerlink" title="错误边界"></a>错误边界</h1><p>捕获错误显示备用 UI,而不是整个组件崩溃.<br>使用 getDerivedStateFromError()渲染备用 UI，使用 ComponentDidCatch 捕获错误。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorBoundary</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123; <span class="attr">hasError</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getDerivedStateFromError</span>(<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 更新 state 使下一次渲染能够显示降级后的 UI</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">hasError</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidCatch</span>(<span class="params">error, errorInfo</span>) &#123;</span><br><span class="line">    <span class="comment">// 你同样可以将错误日志上报给服务器</span></span><br><span class="line">    <span class="title function_">logErrorToMyService</span>(error, errorInfo);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">hasError</span>) &#123;</span><br><span class="line">      <span class="comment">// 你可以自定义降级后的 UI 并渲染</span></span><br><span class="line">      <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Something went wrong.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">children</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无法捕获:</p>
<ol>
<li>事件处理</li>
<li>异步代码 （例如 setTimeout 或 requestAnimationFrame 回调函数）</li>
<li>服务端渲染</li>
<li>错误边界自身抛出来的错误 （而不是其子组件）</li>
</ol>
<p>对于无法捕获的错误，可以使用 try&#x2F;catch.<br>或者监听 oneror 事件，<code>window.addEventListener(&#39;error&#39;,fn())</code></p>
<h1 id="React-更新流程"><a href="#React-更新流程" class="headerlink" title="React 更新流程"></a>React 更新流程</h1><p>通过改变 class 组件或者函数组件的状态来触发页面的更新的过程</p>
<ol>
<li>用户事件(点击等)产生,执行回调</li>
<li>回调调用 setState,产生 update</li>
<li>react 根据 update 创建渲染任务,在任务中进行 fiber 的 diff,最终会将 patch 更新到真实 DOM</li>
<li>渲染任务并非立即执行,会放进调度器队列中,经过调度器调度执行.</li>
</ol>
<h2 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h2><p>整个过程中都有优先级:</p>
<ol>
<li>用户事件产生: 根据不同的事件类型执行回调,指定不同的事件优先级</li>
<li>状态改变,产生 update: 根据产生该 update 的事件优先级,计算 update 优先级</li>
<li>react 创建渲染任务: 根据本次 update 以及未完成的工作计算渲染优先级,根据渲染优先级计算调度优先级</li>
<li>调度器调度执行: 根据挂载到 fiber 上的 update 优先级及渲染优先级来控制需要跳过的 fiber 及 update.</li>
</ol>
<h3 id="总体分为两类"><a href="#总体分为两类" class="headerlink" title="总体分为两类:"></a>总体分为两类:</h3><p>lane 优先级: 事件优先级,update 优先级,渲染优先级<br>调度优先级: 调度优先级.</p>
<h1 id="jsx-转-DOM-过程"><a href="#jsx-转-DOM-过程" class="headerlink" title="jsx 转 DOM 过程"></a>jsx 转 DOM 过程</h1><ul>
<li>使用 React.createElement 或 JSX 编写 React 组件，实际上所有的 JSX 代码最后都会转换成 React.createElement(…) ，Babel 帮助我们完成了这个转换的过程。</li>
<li>createElement 函数对 key 和 ref 等特殊的 props 进行处理，并获取 defaultProps 对默认 props 进行赋值，并且对传入的子节点进行处理，最终构造成一个虚拟 DOM 对象</li>
<li>ReactDOM.render 将生成好的虚拟 DOM 渲染到指定容器上，其中采用了批处理、事务等机制并且对特定浏览器进行了性能优化，最终转换为真实 DOM</li>
</ul>
<h1 id="虚拟-DOM"><a href="#虚拟-DOM" class="headerlink" title="虚拟 DOM"></a>虚拟 DOM</h1><p>Virtual DOM,即虚拟 DOM 节点.使用 JS 的 Object 对象模拟 DOM 中的节点.通过特定的 render 方法将其渲染成真实 DOM.比操作真实 DOM 减小性能开销.<br>操作虚拟 DOM 并不会比操作真实 DOM 快,只不过虚拟 DOM 可以将多次操作合并为一次,也就是减少 DOM 操作.<br>比如添加 1000 个节点,操作真实 DOM 要一个个添加,虚拟 DOM 可以一次性添加.<br>通过对比前后虚拟 dom,得出变化的部分,只修改有变化的 dom,节省性能.<br>虚拟 DOM 因为是对象,所以可以支持跨平台.</p>
<h2 id="Diff-算法"><a href="#Diff-算法" class="headerlink" title="Diff 算法"></a>Diff 算法</h2><p>传统的 Diff 算法也是一直都有的,diff 算法，会对比新老虚拟 DOM，记录下他们之间的变化，然后将变化的部分更新到视图上。其实之前的 diff 算法，是通过循环递归每个节点，然后进行对比，复杂程度为 O(n^3)，n 是树中节点的总数，这样性能是非常差的。<br>dom-diff 的原理？<br>dom-diff 算法会比较前后虚拟 DOM，从而得到 patches(补丁)，然后与老 Virtual DOM 进行对比，将其应用在需要更新的地方，将 O(n^3) 复杂度的问题转换成 O(n^1&#x3D;n) 复杂度的问题，得到新的 Virtual DOM。<br>缺点: 在同级对比中,</p>
<h3 id="降低时间复杂度的方法："><a href="#降低时间复杂度的方法：" class="headerlink" title="降低时间复杂度的方法："></a>降低时间复杂度的方法：</h3><ol>
<li>两个不同类型的元素会产生不同的树</li>
<li>对于同一层级的一组子节点，它们可以通过唯一 key 进行区分</li>
</ol>
<h1 id="React-Diff"><a href="#React-Diff" class="headerlink" title="React Diff"></a>React Diff</h1><p>React 需要同时维护两棵虚拟 DOM 树: 一棵表示当前的 DOM 结构,另一棵在 React 状态变更将要重新渲染时生成.<br>React 通过对比这两棵树的差异,决定是否要修改 DOM 结构.以及如何修改,这就是 Diff 算法.<br>diff 算法的目的就是对比新旧两次结果,找到可复用的部分,然后剩下的该删除删除,该新增新增.</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程:"></a>流程:</h2><ol>
<li>React diff 是先对新旧两棵树做深度优先遍历,避免对两棵树做完全比较,因此算法复杂度 O(n).然后给每个节点生成唯一标识.</li>
<li>在遍历过程中,每遍历一个节点,就将新旧两棵树做对比,并且只对同一级别的的元素进行比较,记录差异,</li>
</ol>
<h2 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h2><h3 id="1-tree-diff"><a href="#1-tree-diff" class="headerlink" title="(1) tree diff"></a>(1) tree diff</h3><p>tree diff 主要针对跨层级操作,如果 A,D 两个节点同级,A 整体被移动到 D 作为子节点,那么并不是真正的移动,而是删除 A 节点,<br>在 D 处创建子节点 A,和 A 的子节点.</p>
<h3 id="2-Component-diff"><a href="#2-Component-diff" class="headerlink" title="(2) Component diff"></a>(2) Component diff</h3><p>针对同一层级的 React 组件的 diff.</p>
<ul>
<li>如果是同类型的组件,就按照原策略继续比较虚拟 DOM 树.</li>
<li>如果不是同类型,就销毁原组件,创建新组件,</li>
</ul>
<h3 id="3-element-diff"><a href="#3-element-diff" class="headerlink" title="(3) element diff"></a>(3) element diff</h3><p>针对同一层级的所有节点.当节点处于同一层级,diff 提供三种操作,插入,移动,删除.<br>对同一层级的同组节点添加唯一的 key 进行区分.通过 key 来判断那些节点可以复用,直接使用移动操作.</p>
<h1 id="为什么不能用-index-作为-key"><a href="#为什么不能用-index-作为-key" class="headerlink" title="为什么不能用 index 作为 key?"></a>为什么不能用 index 作为 key?</h1><p>因为 index 会变,数组中如果删除中间某个值,它的 index 会被后面的替换.<br>key 只是在同层级唯一的,并不是在整个 React 环境下是唯一的.不然的话,复杂度太高.</p>
<h1 id="Fiber-和虚拟-DOM-的关系"><a href="#Fiber-和虚拟-DOM-的关系" class="headerlink" title="Fiber 和虚拟 DOM 的关系"></a>Fiber 和虚拟 DOM 的关系</h1><ul>
<li>在 React16 之前,react 直接递归渲染 VDom,setState 会触发重新渲染,对比渲染出的新旧 VDom,对差异部分进行 dom 操作.</li>
<li>在 React16 之后,为了优化性能,会先把 vdom 转化成 fiber,也就是从树转化成连链表,然后再渲染.整体渲染流程分为两个部分:<ul>
<li>render 阶段: 从虚拟 dom 转化成 fiber,对需要操作的节点打上 effectTag 标记.</li>
<li>commit 阶段: 对有 effectTag 标记的 fiber 节点进行 dom 操作,并执行所有的 effect 副作用函数.</li>
</ul>
</li>
</ul>
<p>从虚拟 dom 转化到 fiber 的过程叫 reconcile(调和),这个过程是可以打断的.由调度执行.</p>
<h1 id="Fiber-和-diff-的关系"><a href="#Fiber-和-diff-的关系" class="headerlink" title="Fiber 和 diff 的关系"></a>Fiber 和 diff 的关系</h1><p>diff 算法作用在 reconcile 阶段:</p>
<ul>
<li>第一次渲染不需要 diff,直接 vdom 转 fiber.</li>
<li>再次渲染时候会产生新的 vdom,这个时候需要和之前的 fiber 做对比,决定怎么产生新的 fiber,对可复用的节点打上修改的标记,剩余的旧节点打上删除标记,新节点打上新增标记.</li>
</ul>
<h1 id="React-Diff-总结"><a href="#React-Diff-总结" class="headerlink" title="React Diff 总结"></a>React Diff 总结</h1><p>react 是基于 vdom 的前端框架，组件渲染产生 vdom，渲染器把 vdom 渲染成 dom。<br>浏览器下使用 react-dom 的渲染器，会先把 vdom 转成 fiber，找到需要更新 dom 的部分，打上增删改的 effectTag 标记，这个过程叫做 reconcile，可以打断，由 scheducler 调度执行。reconcile 结束之后一次性根据 effectTag 更新 dom，叫做 commit。<br>这就是 react 的基于 fiber 的渲染流程，分成 render（reconcile + schedule）、commit 两个阶段。<br>当渲染完一次，产生了 fiber 之后，再次渲染的 vdom 要和之前的 fiber 对比下，再决定如何产生新的 fiber，目标是尽可能复用已有的 fiber 节点，这叫做 diff 算法。<br>react 的 diff 算法分为两个阶段：</p>
<ul>
<li>第一个阶段一一对比，如果可以复用就下一个，不可以复用就结束。</li>
<li>第二个阶段把剩下的老 fiber 放到 map 里，遍历剩余的 vdom，一一查找 map 中是否有可复用的节点。</li>
<li>最后把剩下的老 fiber 删掉，剩下的新 vdom 新增。</li>
</ul>
<p>这样就完成了更新时的 reconcile 过程。<br>其实 diff 算法的核心就是复用节点，通过一一对比也好，通过 map 查找也好，都是为了找到可复用的节点，移动过来。然后剩下的该删删该增增。<br>理解了如何找到可复用的节点，就理解了 diff 算法的核心。</p>
<h1 id="Fiber"><a href="#Fiber" class="headerlink" title="Fiber"></a>Fiber</h1><h2 id="为什么需要-Fiber"><a href="#为什么需要-Fiber" class="headerlink" title="为什么需要 Fiber"></a>为什么需要 Fiber</h2><p>在 React 15 版本中采用的是 Virtual DOM 对比方案，通过对比 Virtual DOM 找出差异部分，从而只将差异部分更新到页面中，避免更新整体 DOM 以提高性能。<br>在 Virtual DOM 比对的过程中 React 使用了递归，递归调用的过程不能被终止，如果 Virtual DOM 的层级比较深，递归比对的过程就会长期占用主线程，而 JavaScript 又是单线程，不能同时执行多个任务，其他任务只能等待执行，而且 JavaScript 的执行和 UI 的渲染又是互斥的，此时用户要么看到的就是空白界面，要么就是有界面但是不能响应用户操作，处于卡顿状态，用户体验差。<br>核心就是<strong>递归比对的过程长期占用主线程产生了性能问题。</strong></p>
<h2 id="Fiber-如何解决这种问题"><a href="#Fiber-如何解决这种问题" class="headerlink" title="Fiber 如何解决这种问题"></a>Fiber 如何解决这种问题</h2><p>在 Fiber 架构中 React 放弃了递归调用，采用循环来模拟递归，因为循环可以随时被中断。<br>React 利用浏览器空闲时间执行比对任务， 解决了 React 执行比对任务长期占用主线程的问题。<br>因为采用了链表的结构,即使被中断了, 也可以从未完成处理的 Fiber 处继续遍历.<br>React 在执行完一个任务单元后，查看是否有其他的高优先级任务，如果有，放弃占用主线程，先执行优先级高的任务.</p>
<h2 id="什么是-Fiber"><a href="#什么是-Fiber" class="headerlink" title="什么是 Fiber"></a>什么是 Fiber</h2><ol>
<li>Fiber 是一个执行单元</li>
</ol>
<p>React16 之前,将 VirtualDOM 树整体看成一个任务,进行递归处理,任务整体庞大,执行耗时且不能中断.<br>React16 开始,将整个任务分成一个个小的任务进行处理,<strong>每个小的任务就是 Fiber 节点的构建</strong>.<br>任务是在浏览器的空余时间执行,每个单元执行后,都会检查是否还有空余时间,如果有,就继续执行,没有就交还主线程的控制权.</p>
<ol start="2">
<li>Fiber 是一种数据结构</li>
</ol>
<p>Fiber 其实是一个 js 对象,对象中有 children 属性表示节点的子节点,有 sibling 属性表示节点的下一个兄弟节点,有 return 属性表示节点的父节点.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">type <span class="title class_">Fiber</span> = &#123;</span><br><span class="line">  <span class="comment">// 组件类型 div、span、组件构造函数</span></span><br><span class="line">  <span class="attr">type</span>: any,</span><br><span class="line">  <span class="comment">// DOM 对象</span></span><br><span class="line">  <span class="attr">stateNode</span>: any,</span><br><span class="line">  <span class="comment">// 指向自己的父级 Fiber 对象</span></span><br><span class="line">  <span class="attr">return</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 指向自己的第一个子级 Fiber 对象</span></span><br><span class="line">  <span class="attr">child</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">// 指向自己的下一个兄弟 iber 对象</span></span><br><span class="line">  <span class="attr">sibling</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1688284382494-52954ee8-827b-49d3-840d-94743dff21ab.png#averageHue=%23dbd2bd&clientId=u7a11d5bb-5c71-4&from=paste&height=241&id=u7991bf42&originHeight=241&originWidth=1461&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=108916&status=done&style=none&taskId=u490ee9d0-2056-4645-a745-25cf187d639&title=&width=1461" alt="image.png"></p>
<h2 id="Fiber-的工作方式"><a href="#Fiber-的工作方式" class="headerlink" title="Fiber 的工作方式"></a>Fiber 的工作方式</h2><p>render 阶段: 构建 Fiber 对象,构建链表,在链表中标记要执行的 DOM 操作,可中断.<br>commit 阶段: 根据构建好的链表进行 DOM 操作,不可中断.</p>
<blockquote>
<p>先从上向下走，构建节点对应的 Fiber 对象，然后再从下向上走，构建 Fiber 对象及链表</p>
</blockquote>
<h2 id="渲染阶段"><a href="#渲染阶段" class="headerlink" title="渲染阶段"></a>渲染阶段</h2><h3 id="Reconcilation-协调阶段"><a href="#Reconcilation-协调阶段" class="headerlink" title="Reconcilation(协调阶段)"></a>Reconcilation(协调阶段)</h3><p>可以认为是 diff 阶段,这个阶段可以被中断.<br>这个阶段会找出所有节点变更,例如节点新增,删除,属性变更.(就是副作用)<br>在 Reconcilation 阶段的生命周期有:</p>
<ul>
<li>constructor</li>
<li>static getDerivedStateFromProps</li>
<li>shouldComponentUpdate</li>
<li>render</li>
</ul>
<h3 id="Commit-提交阶段"><a href="#Commit-提交阶段" class="headerlink" title="Commit(提交阶段)"></a>Commit(提交阶段)</h3><p>将上个阶段计算出来需要处理的<strong>副作用</strong>一次性执行.<br>这个阶段必须同步执行,不能被中断.<br>在 Commit 阶段的生命周期有:</p>
<ul>
<li>componentDidMount</li>
<li>componentDidUpdate</li>
<li>componentWillUnmount</li>
</ul>
<p>在 Reconcilation 阶段如果时间片用完,就会让出控制权。<br>因为协调阶段执行的工作不会导致任何用户可见的变更，所以在这个阶段让出控制权不会有什么问题。<br>需要注意的是：因为协调阶段可能被中断、恢复，甚至重做，React 协调阶段的生命周期钩子可能会被调用多次!, 例如 componentWillMount 可能会被调用两次。</p>
<p>现在你应该知道为什么’提交阶段’必须同步执行，不能中断的吧？ 因为我们要正确地处理各种副作用，包括 DOM 变更、还有你在 componentDidMount 中发起的异步请求、useEffect 中定义的副作用… 因为有副作用，所以必须保证按照次序只调用一次</p>
<h2 id="Fiber-实现所利用的-api"><a href="#Fiber-实现所利用的-api" class="headerlink" title="Fiber 实现所利用的 api"></a>Fiber 实现所利用的 api</h2><p>利用了 window 的一个 API: <code>requestIdleCallback</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">requestIdleCallback</span>(<span class="keyword">function</span> (<span class="params">deadline</span>) &#123;</span><br><span class="line">  <span class="comment">//deadline.timeRemaining() 获取浏览器的空余时间</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h2><p>目前只有 chrome 支持 requestIdleCallback,React 为此自己实现一个.<br>使用 MessageChannel 模拟,将回调延迟到绘制操作之后执行</p>
<h2 id="实现-Fiber"><a href="#实现-Fiber" class="headerlink" title="实现 Fiber"></a>实现 Fiber</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsx = (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;a1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;b1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;c1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;c2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;b2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 为每一个节点构建 Fiber 对象</span></span><br><span class="line"><span class="comment"> * 2. 构建 Fiber 链表</span></span><br><span class="line"><span class="comment"> * 3. 提交 Fiber 链接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建根元素 Fiber 对象</span></span><br><span class="line"><span class="keyword">const</span> workInProgressRoot = &#123;</span><br><span class="line">  <span class="attr">stateNode</span>: container,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">children</span>: [jsx],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> nextUnitOfWork = workInProgressRoot;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoop</span>(<span class="params">deadline</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果下一个要构建的执行单元存在并且浏览器有空余时间</span></span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.<span class="title function_">timeRemaining</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 构建执行单元并返回新的执行单元</span></span><br><span class="line">    nextUnitOfWork = <span class="title function_">performUnitOfWork</span>(nextUnitOfWork);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果所有的执行单元都已经构建完成</span></span><br><span class="line">  <span class="keyword">if</span> (!nextUnitOfWork) &#123;</span><br><span class="line">    <span class="comment">// 进入到第二个阶段 执行 DOM 操作</span></span><br><span class="line">    <span class="title function_">commitRoot</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Fiber 工作的第一个阶段</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">workInProgress</span>) &#123;</span><br><span class="line">  <span class="comment">// 构建阶段向下走的过程</span></span><br><span class="line">  <span class="comment">// 1. 创建当前 Fiber 节点的 DOM 对象并存储在 stateNode 属性中</span></span><br><span class="line">  <span class="comment">// 2. 构建子级 Fiber 对象</span></span><br><span class="line">  <span class="title function_">beginWork</span>(workInProgress);</span><br><span class="line">  <span class="comment">// 如果子级存在</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgress.<span class="property">child</span>) &#123;</span><br><span class="line">    <span class="comment">// 返回子级 构建子级的子级</span></span><br><span class="line">    <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开始构建阶段向上走的过程</span></span><br><span class="line">  <span class="comment">// 如果父级存在</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress) &#123;</span><br><span class="line">    <span class="comment">// 构建 Fiber 链表</span></span><br><span class="line">    <span class="title function_">completeUnitOfWork</span>(workInProgress);</span><br><span class="line">    <span class="comment">// 如果同级存在</span></span><br><span class="line">    <span class="keyword">if</span> (workInProgress.<span class="property">sibling</span>) &#123;</span><br><span class="line">      <span class="comment">// 返回同级 构建同级的子级</span></span><br><span class="line">      <span class="keyword">return</span> workInProgress.<span class="property">sibling</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 同级不存在 退回父级 看父级是否有同级</span></span><br><span class="line">    workInProgress = workInProgress.<span class="property">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params">workInProgress</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果 Fiber 对象没有存储其对应的 DOM 对象</span></span><br><span class="line">  <span class="keyword">if</span> (!workInProgress.<span class="property">stateNode</span>) &#123;</span><br><span class="line">    <span class="comment">// 创建 DOM 对象并存储在 Fiber 对象中</span></span><br><span class="line">    workInProgress.<span class="property">stateNode</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(workInProgress.<span class="property">type</span>);</span><br><span class="line">    <span class="comment">// 为 DOM 对象添加属性</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> attr <span class="keyword">in</span> workInProgress.<span class="property">props</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (attr !== <span class="string">&quot;children&quot;</span>) &#123;</span><br><span class="line">        workInProgress.<span class="property">stateNode</span>[attr] = workInProgress.<span class="property">props</span>[attr];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建子级 Fiber 对象</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(workInProgress.<span class="property">props</span>.<span class="property">children</span>)) &#123;</span><br><span class="line">    <span class="comment">// 记录上一次创建的子级 Fiber 对象</span></span><br><span class="line">    <span class="keyword">let</span> previousFiber = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// 遍历子级</span></span><br><span class="line">    workInProgress.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">child, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 创建子级 Fiber 对象</span></span><br><span class="line">      <span class="keyword">let</span> childFiber = &#123;</span><br><span class="line">        <span class="attr">type</span>: child.<span class="property">type</span>,</span><br><span class="line">        <span class="attr">props</span>: child.<span class="property">props</span>,</span><br><span class="line">        <span class="attr">return</span>: workInProgress,</span><br><span class="line">        <span class="attr">effectTag</span>: <span class="string">&quot;PLACEMENT&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// 第一个子级挂载到父级的 child 属性中</span></span><br><span class="line">      <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">        workInProgress.<span class="property">child</span> = childFiber;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 其他子级挂载到自己的上一个兄弟的 sibling 属性中</span></span><br><span class="line">        previousFiber.<span class="property">sibling</span> = childFiber;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 更新上一个子级</span></span><br><span class="line">      previousFiber = childFiber;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">completeUnitOfWork</span>(<span class="params">workInProgress</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> returnFiber = workInProgress.<span class="property">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (returnFiber) &#123;</span><br><span class="line">    <span class="comment">// 链头上移</span></span><br><span class="line">    <span class="keyword">if</span> (!returnFiber.<span class="property">firstEffect</span>) &#123;</span><br><span class="line">      returnFiber.<span class="property">firstEffect</span> = workInProgress.<span class="property">firstEffect</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// lastEffect 上移</span></span><br><span class="line">    <span class="keyword">if</span> (!returnFiber.<span class="property">lastEffect</span>) &#123;</span><br><span class="line">      returnFiber.<span class="property">lastEffect</span> = workInProgress.<span class="property">lastEffect</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建链表</span></span><br><span class="line">    <span class="keyword">if</span> (workInProgress.<span class="property">effectTag</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (returnFiber.<span class="property">lastEffect</span>) &#123;</span><br><span class="line">        returnFiber.<span class="property">lastEffect</span>.<span class="property">nextEffect</span> = workInProgress;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        returnFiber.<span class="property">firstEffect</span> = workInProgress;</span><br><span class="line">      &#125;</span><br><span class="line">      returnFiber.<span class="property">lastEffect</span> = workInProgress;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Fiber 工作的第二阶段</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitRoot</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 获取链表中第一个要执行的 DOM 操作</span></span><br><span class="line">  <span class="keyword">let</span> currentFiber = workInProgressRoot.<span class="property">firstEffect</span>;</span><br><span class="line">  <span class="comment">// 判断要执行 DOM 操作的 Fiber 对象是否存在</span></span><br><span class="line">  <span class="keyword">while</span> (currentFiber) &#123;</span><br><span class="line">    <span class="comment">// 执行 DOM 操作</span></span><br><span class="line">    currentFiber.<span class="property">return</span>.<span class="property">stateNode</span>.<span class="title function_">appendChild</span>(currentFiber.<span class="property">stateNode</span>);</span><br><span class="line">    <span class="comment">// 从链表中取出下一个要执行 DOM 操作的 Fiber 对象</span></span><br><span class="line">    currentFiber = currentFiber.<span class="property">nextEffect</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在浏览器空闲的时候开始构建</span></span><br><span class="line"><span class="title function_">requestIdleCallback</span>(workLoop);</span><br></pre></td></tr></table></figure>

<h2 id="构建-Fiber-链表"><a href="#构建-Fiber-链表" class="headerlink" title="构建 Fiber 链表"></a>构建 Fiber 链表</h2><ol>
<li>链表的构建顺序</li>
</ol>
<p>链表的顺序是由 DOM 操作的顺序决定的，c1 是第一个要执行 DOM 操作的所以它是链的开始，A1 是最后一个被添加到 Root 中的元素，所以它是链的最后。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1665628426277-2fd08850-6a30-4f2f-a51b-2edf2ccc0438.png#averageHue=%23fafafa&clientId=ucd2db471-e0ef-4&from=paste&height=432&id=u368dabbd&originHeight=432&originWidth=424&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=28089&status=done&style=none&taskId=ube3adbea-32ee-47c1-8d98-0522fc58eca&title=&width=424" alt="image.png"></p>
<ol start="2">
<li>如何向链的尾部添加新元素？</li>
</ol>
<p>在链表结构中通过 nextEffect 存储链中的下一项。<br>在构建链表的过程中，需要通过一个变量存储链表中的最新项，每次添加新项时都使用这个变量，每次操作完成后都需要更新它。这个变量在源码中叫做 lastEffect。<br>lastEffect 是存储在当前 Fiber 对象的父级上的，当父级发生变化时，为避免链接顺序发生错乱，lastEffect 要先上移然后再追加 nextEffect</p>
<ol start="3">
<li>将链表保存在什么位置？</li>
</ol>
<p>链表需要被保存在 Root 中，因为在进入到第二阶段时，也就是 commitRoot 方法中，是将 Root 提交到第二阶段的。<br>在源码中，Root Fiber 下有一个叫 firstEffect 的属性，用于存储链表。<br>在构建链表的遍历过程中，C1 开始，Root 是结尾，如何才能将 C1 存储到 Root 中呢？<br>其实是链头的不断上移做到的。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1665628479417-a56bd511-feff-47cf-8b2f-caa3f3ebeedd.png#averageHue=%23fbfbfb&clientId=ucd2db471-e0ef-4&from=paste&height=467&id=u732bb189&originHeight=467&originWidth=586&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=32753&status=done&style=none&taskId=uc4500bf3-9b14-40d0-af6b-a3f44970565&title=&width=586" alt="image.png"></p>
<h2 id="fiberRoot"><a href="#fiberRoot" class="headerlink" title="fiberRoot"></a>fiberRoot</h2><p>fiberRoot 是整个应用的根节点相当于整棵 fiber 树的大脑，一方面可以作为存储载体，它记录了整个 firber 树的调度状态，以及渲染状态，更重要的是可以控制老 fiber 树和新 fiber 树的切换，从而达到双缓冲的效果。</p>
<h2 id="rootFiber"><a href="#rootFiber" class="headerlink" title="rootFiber"></a>rootFiber</h2><p>代表 root 容器对应的 fiber 节点,作为渲染树的入口节点<br><img src="https://cdn.nlark.com/yuque/0/2023/png/473454/1688288791365-e73cff0a-c16f-4239-8ca6-6222ecce27da.png#averageHue=%23b4b4b3&clientId=uc5516c1c-37b1-4&from=paste&height=549&id=u3a488460&originHeight=549&originWidth=659&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=160434&status=done&style=none&taskId=u3b524bfd-e6bf-417f-8e88-be395d96894&title=&width=659" alt="image.png"></p>
<h2 id="beginwork"><a href="#beginwork" class="headerlink" title="beginwork"></a>beginwork</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params">fiber: Fiber</span>): <span class="title class_">Fiber</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">WorkTag</span>.<span class="property">HostComponent</span>) &#123;</span><br><span class="line">    <span class="comment">// 宿主节点diff</span></span><br><span class="line">    <span class="title function_">diffHostComponent</span>(fiber);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">WorkTag</span>.<span class="property">ClassComponent</span>) &#123;</span><br><span class="line">    <span class="comment">// 类组件节点diff</span></span><br><span class="line">    <span class="title function_">diffClassComponent</span>(fiber);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">WorkTag</span>.<span class="property">FunctionComponent</span>) &#123;</span><br><span class="line">    <span class="comment">// 函数组件节点diff</span></span><br><span class="line">    <span class="title function_">diffFunctionalComponent</span>(fiber);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ... 其他类型节点，省略</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>宿主节点对比</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">diffHostComponent</span>(<span class="params">fiber: Fiber</span>) &#123;</span><br><span class="line">  <span class="comment">// 新增节点</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">stateNode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.<span class="property">stateNode</span> = <span class="title function_">createHostComponent</span>(fiber);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">updateHostComponent</span>(fiber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newChildren = fiber.<span class="property">pendingProps</span>.<span class="property">children</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 比对子节点</span></span><br><span class="line">  <span class="title function_">diffChildren</span>(fiber, newChildren);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类组件节点对比</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">diffClassComponent</span>(<span class="params">fiber: Fiber</span>) &#123;</span><br><span class="line">  <span class="comment">// 创建组件实例</span></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">stateNode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.<span class="property">stateNode</span> = <span class="title function_">createInstance</span>(fiber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">hasMounted</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用更新前生命周期钩子</span></span><br><span class="line">    <span class="title function_">applybeforeUpdateHooks</span>(fiber);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 调用挂载前生命周期钩子</span></span><br><span class="line">    <span class="title function_">applybeforeMountHooks</span>(fiber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 渲染新节点</span></span><br><span class="line">  <span class="keyword">const</span> newChildren = fiber.<span class="property">stateNode</span>.<span class="title function_">render</span>();</span><br><span class="line">  <span class="comment">// 比对子节点</span></span><br><span class="line">  <span class="title function_">diffChildren</span>(fiber, newChildren);</span><br><span class="line"></span><br><span class="line">  fiber.<span class="property">memoizedState</span> = fiber.<span class="property">stateNode</span>.<span class="property">state</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>子节点对比</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">diffChildren</span>(<span class="params">fiber: Fiber, newChildren: React.ReactNode</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> oldFiber = fiber.<span class="property">alternate</span> ? fiber.<span class="property">alternate</span>.<span class="property">child</span> : <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 全新节点，直接挂载</span></span><br><span class="line">  <span class="keyword">if</span> (oldFiber == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">mountChildFibers</span>(fiber, newChildren);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> newFiber = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// 新子节点</span></span><br><span class="line">  <span class="keyword">const</span> elements = <span class="title function_">extraElements</span>(newChildren);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 比对子元素</span></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span> || oldFiber != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevFiber = newFiber;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index];</span><br><span class="line">    <span class="keyword">const</span> sameType = <span class="title function_">isSameType</span>(element, oldFiber);</span><br><span class="line">    <span class="keyword">if</span> (sameType) &#123;</span><br><span class="line">      newFiber = <span class="title function_">cloneFiber</span>(oldFiber, element);</span><br><span class="line">      <span class="comment">// 更新关系</span></span><br><span class="line">      newFiber.<span class="property">alternate</span> = oldFiber;</span><br><span class="line">      <span class="comment">// 打上Tag</span></span><br><span class="line">      newFiber.<span class="property">effectTag</span> = <span class="variable constant_">UPDATE</span>;</span><br><span class="line">      newFiber.<span class="property">return</span> = fiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新节点</span></span><br><span class="line">    <span class="keyword">if</span> (element &amp;&amp; !sameType) &#123;</span><br><span class="line">      newFiber = <span class="title function_">createFiber</span>(element);</span><br><span class="line">      newFiber.<span class="property">effectTag</span> = <span class="variable constant_">PLACEMENT</span>;</span><br><span class="line">      newFiber.<span class="property">return</span> = fiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除旧节点</span></span><br><span class="line">    <span class="keyword">if</span> (oldFiber &amp;&amp; !sameType) &#123;</span><br><span class="line">      oldFiber.<span class="property">effectTag</span> = <span class="variable constant_">DELETION</span>;</span><br><span class="line">      oldFiber.<span class="property">nextEffect</span> = fiber.<span class="property">nextEffect</span>;</span><br><span class="line">      fiber.<span class="property">nextEffect</span> = oldFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber) &#123;</span><br><span class="line">      oldFiber = oldFiber.<span class="property">sibling</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.<span class="property">child</span> = newFiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevFiber &amp;&amp; element) &#123;</span><br><span class="line">      prevFiber.<span class="property">sibling</span> = newFiber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    index++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="双缓冲"><a href="#双缓冲" class="headerlink" title="双缓冲"></a>双缓冲</h2><p>React 中，WorkInProgress 树就是一个缓冲，它在 Reconciliation 完毕后一次性提交给浏览器进行渲染。它可以减少内存分配和垃圾回收，WorkInProgress 的节点不完全是新的，比如某颗子树不需要变动，React 会克隆复用旧树中的子树。</p>
<h2 id="completeWork"><a href="#completeWork" class="headerlink" title="completeWork"></a>completeWork</h2><p>副作用的收集和提交<br>将所有标记为 EffectTag 的节点串联起来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">completeWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> parent = fiber.<span class="property">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 到达顶端</span></span><br><span class="line">  <span class="keyword">if</span> (parent == <span class="literal">null</span> || fiber === topWork) &#123;</span><br><span class="line">    pendingCommit = fiber;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">effectTag</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent.<span class="property">nextEffect</span>) &#123;</span><br><span class="line">      parent.<span class="property">nextEffect</span>.<span class="property">nextEffect</span> = fiber;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      parent.<span class="property">nextEffect</span> = fiber;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.<span class="property">nextEffect</span>) &#123;</span><br><span class="line">    parent.<span class="property">nextEffect</span> = fiber.<span class="property">nextEffect</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提交所有副作用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitAllWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> next = fiber;</span><br><span class="line">  <span class="keyword">while</span> (next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fiber.<span class="property">effectTag</span>) &#123;</span><br><span class="line">      <span class="comment">// 提交，偷一下懒，这里就不展开了</span></span><br><span class="line">      <span class="title function_">commitWork</span>(fiber);</span><br><span class="line">    &#125;</span><br><span class="line">    next = fiber.<span class="property">nextEffect</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理现场</span></span><br><span class="line">  pendingCommit = nextUnitOfWork = topWork = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Concurrent-Mode-优点"><a href="#Concurrent-Mode-优点" class="headerlink" title="Concurrent Mode 优点"></a>Concurrent Mode 优点</h1><ul>
<li>快速响应用户操作和输入，提升用户交互体验</li>
<li>让动画更加流畅，通过调度，可以让应用保持高帧率</li>
<li>利用好 I&#x2F;O 操作空闲期或者 CPU 空闲期，进行一些预渲染。 比如离屏(offscreen)不可见的内容，优先级最低，可以让 React 等到 CPU 空闲时才去渲染这部分内容。这和浏览器的 preload 等预加载技术差不多。</li>
<li>用 Suspense 降低加载状态(load state)的优先级，减少闪屏。 比如数据很快返回时，可以不必显示加载状态，而是直接显示出来，避免闪屏；如果超时没有返回才显式加载状态。</li>
</ul>
<h1 id="React-性能优化"><a href="#React-性能优化" class="headerlink" title="React 性能优化"></a>React 性能优化</h1><h2 id="React-memo-useMemo-useCallback"><a href="#React-memo-useMemo-useCallback" class="headerlink" title="React.memo useMemo useCallback"></a>React.memo useMemo useCallback</h2><ul>
<li>React.memo 是包裹整个组件,浅层对比 props 的变化,决定是否渲染组件,</li>
<li>useMemo 是更加细粒度的进行性能优化.</li>
<li>useMemo 是返回一个 memoized 值,只有当依赖项变化才会触发重新渲染.</li>
<li>useMemo 和 useCallback 用法差不多，都是在第一次渲染的时候执行，然后在依赖项改变时再次执行，不同点在于，useMemo 返回缓存的变量，useCallback 返回缓存的函数</li>
</ul>
<h1 id="异步组件"><a href="#异步组件" class="headerlink" title="异步组件"></a>异步组件</h1><p>Suspense 让组件’等待’某个异步操作,直到异步操作完成再渲染.<br>当数据还没加载完成会展示 suspense 中 fallback 的内容.</p>
<p>那么回到我们的异步组件上来，如果让异步的代码放在同步执行，是肯定不会正常的渲染的，我们还是要先请求数据，等到数据返回，再用返回的数据进行渲染，那么重点在于这个等字，如何让同步的渲染停止下来，去等异步的数据请求呢？ 抛出异常可以吗? 异常可以让代码停止执行，当然也可以让渲染中止。<br>Suspense 就是用抛出异常的方式中止的渲染，Suspense 需要一个 createFetcher 函数会封装异步操作，当尝试从 createFetcher 返回的结果读取数据时，有两种可能：一种是数据已经就绪，那就直接返回结果；还有一种可能是异步操作还没有结束，数据没有就绪，这时候 createFetcher 会抛出一个“异常”。</p>
<p>这个“异常”是正常的代码错误吗？ 非也，这个异常是封装请求数据的 Promise 对象，里面是真正的数据请求方法，既然 Suspense 能够抛出异常，就能够通过类似 componentDidCatch 的 try{}catch{} 去获取这个异常。</p>
<p>获取这个异常之后干什么呢？ 我们知道这个异常是 Promise，那么接下来当然是执行这个 Promise，在成功状态后，获取数据，然后再次渲染组件，此时的渲染就已经读取到正常的数据，那么可以正常的渲染了。<br>接下来我们模拟一下 createFetcher 和 Suspense</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; fn  我们请求数据交互的函数，返回一个数据请求的Promise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createFetcher</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> fetcher = &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;pedding&quot;</span>,</span><br><span class="line">    <span class="attr">result</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">p</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> getDataPromise = <span class="title function_">fn</span>();</span><br><span class="line">    fetcher.<span class="property">p</span> = getDataPromise;</span><br><span class="line">    getDataPromise.<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* 成功获取数据 */</span></span><br><span class="line">      fetcher.<span class="property">result</span> = result;</span><br><span class="line">      fetcher.<span class="property">status</span> = <span class="string">&quot;resolve&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fetcher.<span class="property">status</span> === <span class="string">&quot;pedding&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">/* 第一次执行中断渲染，第二次 */</span></span><br><span class="line">      <span class="keyword">throw</span> fetcher;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 第二次执行 */</span></span><br><span class="line">    <span class="keyword">if</span> (fetcher.<span class="property">status</span>) <span class="keyword">return</span> fetcher.<span class="property">result</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>返回一个函数，在渲染阶段执行，第一次组件渲染，由于 status &#x3D; pedding 所以抛出异常 fetcher 给 Susponse，渲染中止。</li>
<li>Susponse 会在内部 componentDidCatch 处理这个 fetcher，执行 getDataPromise.then， 这个时候 status 已经是 resolve 状态，数据也能正常返回了。</li>
<li>接下来 Susponse 再次渲染组件，此时，此时就能正常的获取数据了</li>
</ul>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Suspense</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  state = &#123; <span class="attr">isRender</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">  <span class="title function_">componentDidCatch</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="comment">/* 异步请求中，渲染 fallback */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">isRender</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    <span class="keyword">const</span> &#123; p &#125; = e;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(p).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* 数据请求后，渲染真实组件 */</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">isRender</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; isRender &#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; children, fallback &#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">    <span class="keyword">return</span> isRender ? children : fallback;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用 componentDidCatch 捕获异步请求，如果有异步请求渲染 fallback，等到异步请求执行完毕，渲染真实组件，借此整个异步流程完毕</p>
<h2 id="lazy-和-Suspense"><a href="#lazy-和-Suspense" class="headerlink" title="lazy 和 Suspense"></a>lazy 和 Suspense</h2><p>异步加载组件<br>React.lazy 接受一个函数，这个函数需要动态调用 import()。它必须返回一个 Promise ，该 Promise 需要 resolve 一个 default export 的 React 组件。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">LazyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;./test.js&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">LazyComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>React.lazy 是如何配合 Susponse 实现动态加载的效果的呢？实际上,lazy 内部就是做了一个 createFetcher，而上面讲到 createFetcher 得到渲染的数据，而 lazy 里面自带的 createFetcher 异步请求的是组件。lazy 内部模拟一个 promiseA 规范场景。我们完全可以理解 React.lazy 用 Promise 模拟了一个请求数据的过程，但是请求的结果不是数据，而是一个动态的组件。</p>
<h1 id="逻辑复用"><a href="#逻辑复用" class="headerlink" title="逻辑复用"></a>逻辑复用</h1><h2 id="高阶组件-HOC"><a href="#高阶组件-HOC" class="headerlink" title="高阶组件 HOC"></a>高阶组件 HOC</h2><p>接收一个组件，返回一个新的组件。<br>接收的组件接受高阶组件的 props，也就是复用的 props 和方法。</p>
<h2 id="render-props"><a href="#render-props" class="headerlink" title="render props"></a>render props</h2><p>使用 children 属性作为传入参数。</p>
<h2 id="自定义-hook"><a href="#自定义-hook" class="headerlink" title="自定义 hook"></a>自定义 hook</h2><p>将复用的 state 和方法抽离到一个 hook 中，返回对应的 state 和方法。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/15/%E9%A1%B9%E7%9B%AE%E9%97%AE%E9%A2%98%E9%9B%86%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/15/%E9%A1%B9%E7%9B%AE%E9%97%AE%E9%A2%98%E9%9B%86%E5%90%88/" class="post-title-link" itemprop="url">项目问题集合</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-15 16:48:51" itemprop="dateCreated datePublished" datetime="2022-09-15T16:48:51+08:00">2022-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Jira"><a href="#Jira" class="headerlink" title="Jira"></a>Jira</h1><h2 id="参数解构"><a href="#参数解构" class="headerlink" title="参数解构"></a>参数解构</h2><p>用于简化浅拷贝操作</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onChange=&#123;<span class="function"><span class="params">e</span> =&gt;</span> <span class="title function_">setParam</span>(...param, e.<span class="property">target</span>.<span class="property">value</span>)&#125;</span><br></pre></td></tr></table></figure>

<h2 id="fetch-方法使用"><a href="#fetch-方法使用" class="headerlink" title="fetch 方法使用"></a>fetch 方法使用</h2><p>fetch 方法返回的是异步的可以使用 async&#x2F;await</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">then</span>(<span class="keyword">async</span> (res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (res.<span class="property">ok</span>) &#123;</span><br><span class="line">    <span class="title function_">setList</span>(<span class="keyword">await</span> res.<span class="title function_">json</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="避免修改原值"><a href="#避免修改原值" class="headerlink" title="避免修改原值"></a>避免修改原值</h2><p>对于修改某个值,可以先将该值拷贝,再修改拷贝值,将修改后的拷贝值抛出,避免修改原值.</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">removeIndex</span>: <span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> copy = [...value];</span><br><span class="line">  copy.<span class="title function_">splice</span>(index, <span class="number">1</span>);</span><br><span class="line">  <span class="title function_">setValue</span>(copy);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="自定义-Hook"><a href="#自定义-Hook" class="headerlink" title="自定义 Hook"></a>自定义 Hook</h1><p>注意点:</p>
<ol>
<li>hooks 要放在最外层,层级要求最高.</li>
<li>不要在循环,条件,嵌套中使用 Hook,确保它在最顶层.</li>
</ol>
<p>只在 React 函数中调用 Hook,不要在 js 函数中调用.</p>
<h2 id="挂载时-Hook"><a href="#挂载时-Hook" class="headerlink" title="挂载时 Hook"></a>挂载时 Hook</h2><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">useMount</span> = (<span class="params">callback</span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="防抖-Hook"><a href="#防抖-Hook" class="headerlink" title="防抖 Hook"></a>防抖 Hook</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数一,需要防抖的值,可以是任意类型</span></span><br><span class="line"><span class="keyword">const</span> useDebounce = &lt;V&gt;(<span class="attr">value</span>: V, delay?: <span class="built_in">number</span>): <span class="function"><span class="params">any</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [debounceValue, setDebounceValue] = <span class="title function_">useState</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//挂载时设置定时器</span></span><br><span class="line">    <span class="keyword">const</span> timeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">setDebounceValue</span>(value), (delay = <span class="number">1000</span>));</span><br><span class="line">    <span class="comment">//卸载时,清除定时器</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="title function_">cleatTimeout</span>(timeout);</span><br><span class="line">    <span class="comment">//设置的依赖用于变化后重新执行</span></span><br><span class="line">  &#125;, [value, delay]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="Hooks-中的闭包陷阱"><a href="#Hooks-中的闭包陷阱" class="headerlink" title="Hooks 中的闭包陷阱"></a>Hooks 中的闭包陷阱</h1><p>以设置网站标题为例</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">useDocument</span> = (<span class="params">title:<span class="built_in">string</span>, keepOnUnmount?:<span class="built_in">boolean</span>=<span class="literal">true</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 拿到文档当前的title</span></span><br><span class="line">  <span class="keyword">const</span> oldTitle = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="variable language_">document</span>.<span class="property">title</span>).<span class="title function_">current</span>()</span><br><span class="line">  <span class="comment">// 挂载时,将传入title赋值</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">title</span> = title</span><br><span class="line">  &#125;,[])</span><br><span class="line">  <span class="comment">// 卸载时,判断是否有保持传入title的参数</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//这里闭包里保存的oldTitle没有变化</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(!keepOnUnmount) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">title</span> = oldTitle</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,[keepOnUnmount,oldTitle])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="闭包陷阱"><a href="#闭包陷阱" class="headerlink" title="闭包陷阱"></a>闭包陷阱</h2><p>“闭包陷阱” 最大的问题就是在函数数内无法获取的最新的 state 的值.<br>函数式组件每次 render 都会生产一个新的 log 函数，这个新的 log 函数会产生一个在当前这个阶段 value 值的闭包。<br>log 方法内的 value 和点击触发时的 value 相同,value 的后续变化对 log 内的 value 不造成影响.<br>如何解决:</p>
<ol>
<li>使用 useRef</li>
</ol>
<p>原理: useRef 每次 render 时都会返回同一个引用类型的对象.设置值和读取值都在这个对象上处理.</p>
<ol start="2">
<li>useState 更新值时传入回调函数</li>
</ol>
<p><code>**setValue**(value =&gt; value + 1)</code></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">FunctionComponent</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">log</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">alert</span>(value);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>FunctionComponent<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>value: &#123;value&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setValue(value + 1)&#125;&gt;add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;log&#125;</span>&gt;</span>alert<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="副作用"><a href="#副作用" class="headerlink" title="副作用"></a>副作用</h1><p>副作用(Side Effect)是指函数或者表达式的行为依赖于外部世界。</p>
<h1 id="useMemo-和-useCallback"><a href="#useMemo-和-useCallback" class="headerlink" title="useMemo 和 useCallback"></a>useMemo 和 useCallback</h1><p>而 useCallback 就是一个特殊版本的 useMemo，专门来处理函数的<br>案例:</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;./styles.css&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>); <span class="comment">// 加了这一行</span></span><br><span class="line">  <span class="keyword">const</span> value = &#123; <span class="attr">name</span>: <span class="number">1</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()); <span class="comment">// 加了这一行</span></span><br><span class="line">    (<span class="string">&quot;render&quot;</span>);</span><br><span class="line">  &#125;, [value]);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello CodeSandbox<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Edit to see some magic happen!<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里循环的原因是：组件渲染 → useEffect 执行 → setCount 触发循环 → 组件渲染 → useEffect 执行 → setCount 触发循环…<br>注意是组件渲染之后,刷新的是 value,和上一个不是同一个 value.那就需要给它套上 useMemo.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">name</span>: <span class="number">1</span> &#125;;</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure>

<p>useMemo 的意思就是：不要每次渲染都重新定义，而是我让你重新定义的时候再重新定义(第二个参数，依赖列表)。大家看到这里的依赖列表是空的，是因为 useMemo 里的回调函数确实没用到啥变量，如果有变量的话大家的 IDE 就会提醒加上依赖了。<br>这就是使用 useMemo 的原理，useMemo 适用于所有类型的值，加入这个值恰好是函数，那么用 useCallback 也可以。也就是说，useCallback 是一种特殊的 useMemo。<br>使用场景:</p>
<ol>
<li>它不是状态，也就是说，不是用 useState 定义的(redux 中的状态实际上也是用 useState 定义的)</li>
<li>它不是基本类型</li>
<li>它会被放在 useEffect 的依赖列表里 || 自定义 hook 的返回值</li>
</ol>
<p>自定义 hook 的返回值也成立是因为，你不知道自定义 hook 的返回值将会被用在哪里，它可能会被用在依赖也可能不会，所以干脆都加上；而像上面那个在组件中定义的 value，你就可以见机行事了</p>
<h1 id="自定义-Hook-1"><a href="#自定义-Hook-1" class="headerlink" title="自定义 Hook"></a>自定义 Hook</h1><p>自定义 Hook 是目前最好的重用 React 逻辑的方法，它和普通的函数很像很像，自定义 Hook 的特殊之处在于，它是有状态的，它返回的也是状态。所以在什么时候我们应该用到自定义 Hook？那就是，我们想要抽象出处理状态的逻辑的时候</p>
<h1 id="状态管理"><a href="#状态管理" class="headerlink" title="状态管理"></a>状态管理</h1><p>大概可以分为三种场景<br>简单场景:使用状态提升,组合组件<br>使用缓存管理:react-query<br>使用客户端状态管理:redux, context, url</p>
<h2 id="关于全局使用的状态操作"><a href="#关于全局使用的状态操作" class="headerlink" title="关于全局使用的状态操作"></a>关于全局使用的状态操作</h2><p>方法一: 可以使用 redux 设置一个 state,设置对应的 reducer,<br>一个同步设置状态,一个异步 thunk.<br>方法二: 使用缓存,react-query.</p>
<h2 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a>useContext</h2><p>给整个 app 设置登录注册用户信息相关的 context.将 app 包裹,就可以随时验证登录状态.</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.创建Context</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">IContext</span> &#123;</span><br><span class="line">  <span class="attr">user</span>: <span class="title class_">User</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">login</span>: <span class="function">(<span class="params">form:AuthForm</span>) =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;;</span><br><span class="line">  <span class="attr">register</span>: <span class="function">(<span class="params">form:AuthForm</span>) =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;;</span><br><span class="line">  <span class="attr">logout</span>: <span class="function">() =&gt;</span> <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">AuthForm</span> &#123;</span><br><span class="line">  <span class="attr">username</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">password</span>: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AuthContext</span> = createContext&lt;<span class="title class_">IContext</span>| <span class="literal">undefined</span>&gt;(<span class="literal">undefined</span>);</span><br><span class="line"><span class="comment">// 2.设置Context的名字</span></span><br><span class="line"><span class="title class_">AuthContext</span>.<span class="property">displayName</span> = <span class="string">&#x27;AuthContext&#x27;</span></span><br><span class="line"><span class="comment">// 3. 设置provider包裹整个app组件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">AuthProvider</span> = (<span class="params">&#123;children&#125;:&#123;children: ReactNode&#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 各种在登录或者要验证用户信息的方法</span></span><br><span class="line">  <span class="comment">// 设置报错反馈</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="language-xml"><span class="tag">&lt;<span class="name">AuthContext.Provider</span> <span class="attr">children</span>=<span class="string">&#123;children&#125;</span> <span class="attr">value</span>=<span class="string">&#123;/*各种方法的变量*/&#125;</span> /&gt;</span></span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 4. 使用自定义Hook设置调用方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useAuth</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> context = <span class="title function_">useContext</span>(<span class="title class_">AuthContext</span>)</span><br><span class="line">  <span class="keyword">if</span>(!context)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;useAuth必须在AuthProvider中使用&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> context</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 5. 将AuthProvider和父级的Provider合并</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">AppProvider</span> = (&#123; children &#125;: &#123; <span class="attr">children</span>: <span class="title class_">ReactNode</span> &#125;)) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">QueryClientProvider</span> <span class="attr">client</span>=<span class="string">&#123;new</span> <span class="attr">QueryClient</span>()&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">AuthProvider</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">AuthProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">QueryClientProvider</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 6. 在index.ts文件将整个app组件包裹</span></span><br><span class="line">&lt;<span class="title class_">AppProviders</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">DevTools</span> /&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">AppProviders</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="redux"><a href="#redux" class="headerlink" title="redux"></a>redux</h2><h2 id="react-query"><a href="#react-query" class="headerlink" title="react-query"></a>react-query</h2><p>这是一个适用于 React Hooks 的请求库，这个库将帮助你获取、同步、更新和缓存你的远程数据， 提供两个简单的 hooks，就能完成增删改查等操作，React-Query 使用声明式管理服务端状态，可以使用零配置开箱即用地处理缓存，后台更新和陈旧数据。</p>
<p>React-Query 封装了完整的请求中间状态（<code>isLoading</code>、<code>isError</code>…）。<br>不仅如此，React-Query 还为我们做了如下工作：<br>多个组件请求同一个 query 时只发出一个请求<br>缓存数据失效&#x2F;更新策略（判断缓存合适失效，失效后自动请求数据）<br>对失效数据垃圾清理<br>数据的 CRUD 由 2 个 hook 处理：<br><code>useQuery</code>处理数据的查<br><code>useMutation</code>处理数据的增&#x2F;删&#x2F;改</p>
<h1 id="乐观更新"><a href="#乐观更新" class="headerlink" title="乐观更新"></a>乐观更新</h1><p>更新操作后,在数据返回前可以先乐观的更新数据,但是有的情况下会有失败的可能.这时候再选择回滚更新.<br><code>useMutation</code> 的 <code>onMutate</code> 回调允许返回一个特定值，该值稍后将作为最后一个参数传递给 <code>onError</code> 和 <code>onSettled</code> 处理</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> queryClient = <span class="title function_">useQueryClient</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">useMutation</span>(updateTodo, &#123;</span><br><span class="line">  <span class="comment">// 当 mutate 调用时</span></span><br><span class="line">  <span class="attr">onMutate</span>: <span class="keyword">async</span> (newTodo) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 撤销相关的查询（这样它们就不会覆盖我们的乐观更新）</span></span><br><span class="line">    <span class="keyword">await</span> queryClient.<span class="title function_">cancelQueries</span>([<span class="string">&quot;todos&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存前一次状态的快照</span></span><br><span class="line">    <span class="keyword">const</span> previousTodos = queryClient.<span class="title function_">getQueryData</span>([<span class="string">&quot;todos&quot;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行&quot;乐观&quot;更新</span></span><br><span class="line">    queryClient.<span class="title function_">setQueryData</span>([<span class="string">&quot;todos&quot;</span>], <span class="function">(<span class="params">old</span>) =&gt;</span> [...old, newTodo]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回具有快照值的上下文对象</span></span><br><span class="line">    <span class="keyword">return</span> &#123; previousTodos &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 如果修改失败，则使用 onMutate 返回的上下文进行回滚</span></span><br><span class="line">  <span class="attr">onError</span>: <span class="function">(<span class="params">err, newTodo, context</span>) =&gt;</span> &#123;</span><br><span class="line">    queryClient.<span class="title function_">setQueryData</span>([<span class="string">&quot;todos&quot;</span>], context.<span class="property">previousTodos</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 总是在错误或成功之后重新获取：</span></span><br><span class="line">  <span class="attr">onSettled</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    queryClient.<span class="title function_">invalidateQueries</span>(<span class="string">&quot;todos&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>项目案例</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">QueryKey</span>, useQueryClient &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Task</span> &#125; <span class="keyword">from</span> <span class="string">&quot;types/task&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; reorder &#125; <span class="keyword">from</span> <span class="string">&quot;./reorder&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">useConfig</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  queryKey: QueryKey,</span></span><br><span class="line"><span class="params">  callback: (target: any, old?: any[]) =&gt; any[]</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> queryClient = <span class="title function_">useQueryClient</span>();</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 第二个参数即在成功获取数据后刷新数据</span></span><br><span class="line">    <span class="attr">onSuccess</span>: <span class="function">() =&gt;</span> queryClient.<span class="title function_">invalidateQueries</span>(queryKey),</span><br><span class="line">    <span class="comment">// 配置乐观更新</span></span><br><span class="line">    <span class="attr">onMutate</span>: <span class="keyword">async</span> (<span class="attr">target</span>: any) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> previousItems = queryClient.<span class="title function_">getQueryData</span>(queryKey);</span><br><span class="line">      queryClient.<span class="title function_">setQueryData</span>(queryKey, <span class="function">(<span class="params">old?: any[]</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">callback</span>(target, old);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        previousItems,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 如果出错就将原数据回滚</span></span><br><span class="line">    <span class="attr">onError</span>: <span class="function">(<span class="params">error: any, newItem: any, context: any</span>) =&gt;</span> &#123;</span><br><span class="line">      queryClient.<span class="title function_">setQueryData</span>(queryKey, context.<span class="property">previousItems</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="fetch-与-axios-区别"><a href="#fetch-与-axios-区别" class="headerlink" title="fetch 与 axios 区别"></a>fetch 与 axios 区别</h1><p>使用 fetch 封装,注意和 axios 的区别,无法捕获非网络异常导致的 error.必须手动 Promise.reject()抛出.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = <span class="keyword">await</span> res.<span class="title function_">json</span>();</span><br><span class="line"><span class="keyword">if</span> (res.<span class="property">ok</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="无感登录"><a href="#无感登录" class="headerlink" title="无感登录"></a>无感登录</h1><p>在挂载时,设置方法.获取 token,更新 user 信息.没有 token 后端返回 401 就跳转到登录页.</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">bootstrapUser</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> user = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">const</span> token = auth.<span class="title function_">getToken</span>();</span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">http</span>(<span class="string">&quot;me&quot;</span>, &#123; token &#125;);</span><br><span class="line">    user = data.<span class="property">user</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="乐观更新-1"><a href="#乐观更新-1" class="headerlink" title="乐观更新"></a>乐观更新</h1><h1 id="自定义-Hook-异步操作"><a href="#自定义-Hook-异步操作" class="headerlink" title="自定义 Hook 异步操作"></a>自定义 Hook 异步操作</h1><p>自带 loading,错误处理</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">State</span>&lt;D&gt; &#123;</span><br><span class="line">  <span class="attr">error</span>: <span class="title class_">Error</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">data</span>: D | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">stat</span>: <span class="string">&quot;idle&quot;</span> | <span class="string">&quot;loading&quot;</span> | <span class="string">&quot;error&quot;</span> | <span class="string">&quot;success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">defaultInitialState</span>: <span class="title class_">State</span> = &#123;</span><br><span class="line">  <span class="attr">stat</span>: <span class="string">&quot;idle&quot;</span>,</span><br><span class="line">  <span class="attr">data</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">error</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useAsync = &lt;D&gt;<span class="function">(<span class="params">initialState?: State&lt;D&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState&lt;<span class="title class_">State</span>&lt;D&gt;&gt;(&#123;</span><br><span class="line">    ...defaultInitialState,</span><br><span class="line">    initialState,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//设置data说明状态成功</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setData</span> = (<span class="params">data: D</span>) =&gt;</span><br><span class="line">    <span class="title function_">setState</span>(&#123;</span><br><span class="line">      data,</span><br><span class="line">      <span class="attr">error</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">stat</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="comment">//设置data说明状态失败</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setError</span> = (<span class="params">error: <span class="built_in">Error</span></span>) =&gt;</span><br><span class="line">    <span class="title function_">setState</span>(&#123;</span><br><span class="line">      error,</span><br><span class="line">      <span class="attr">data</span>: <span class="literal">null</span>,</span><br><span class="line">      <span class="attr">stat</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="comment">// 接收异步</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">run</span> = (<span class="params">promise: <span class="built_in">Promise</span>&lt;D&gt;</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果不是promise类型报错</span></span><br><span class="line">    <span class="keyword">if</span> (!promise || !promise.<span class="property">then</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;请传入Promise类型数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是,刚开始是loading状态</span></span><br><span class="line">    <span class="title function_">setState</span>(&#123; ...state, <span class="attr">stat</span>: <span class="string">&quot;loading&quot;</span> &#125;);</span><br><span class="line">    <span class="comment">// 最后返回promise</span></span><br><span class="line">    <span class="keyword">return</span> promise</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setData</span>(data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setError</span>(error);</span><br><span class="line">        <span class="comment">// 注意catch会捕获error,不主动抛出就不能继续往下传递</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 将所有信息暴露</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">isIdle</span>: state.<span class="property">stat</span> === <span class="string">&quot;idle&quot;</span>,</span><br><span class="line">    <span class="attr">isLoading</span>: state.<span class="property">stat</span> === <span class="string">&quot;loading&quot;</span>,</span><br><span class="line">    <span class="attr">isError</span>: state.<span class="property">stat</span> === <span class="string">&quot;error&quot;</span>,</span><br><span class="line">    <span class="attr">isSuccess</span>: state.<span class="property">stat</span> === <span class="string">&quot;success&quot;</span>,</span><br><span class="line">    run,</span><br><span class="line">    setData,</span><br><span class="line">    setError,</span><br><span class="line">    ...state,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="错误边界"><a href="#错误边界" class="headerlink" title="错误边界"></a>错误边界</h1><p>捕获错误显示备用 UI,而不是整个组件崩溃.<br>无法捕获:</p>
<ol>
<li>事件处理</li>
<li>异步代码 （例如 setTimeout 或 requestAnimationFrame 回调函数）</li>
<li>服务端渲染</li>
<li>错误边界自身抛出来的错误 （而不是其子组件）</li>
</ol>
<p>如果一个类组件定义了生命周期方法中的任何一个（或两个）<code>static getDerivedStateFromError()</code> 或 <code>componentDidCatch()</code>，那么它就成了一个错误边界。<br>使用<code>static getDerivedStateFromError()</code>在抛出错误后渲染回退 UI。 使用 <code>componentDidCatch()</code> 来记录错误信息。</p>
<h2 id="实现方法"><a href="#实现方法" class="headerlink" title="实现方法"></a>实现方法</h2><p>需要使用类组件声明</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">FallBackRender</span> = <span class="function">(<span class="params">props: &#123; error: <span class="built_in">Error</span> | <span class="literal">null</span> &#125;</span>) =&gt;</span> <span class="title class_">React</span>.<span class="property">ReactElement</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ErrorBoundary</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&lt;</span><br><span class="line">  <span class="title class_">React</span>.<span class="property">PropsWithChildren</span>&lt;&#123; <span class="attr">fallbackRender</span>: <span class="title class_">FallBackRender</span> &#125;&gt;,</span><br><span class="line">  &#123; <span class="attr">error</span>: <span class="title class_">Error</span> | <span class="literal">null</span> &#125;</span><br><span class="line">&gt; &#123;</span><br><span class="line">  state = &#123; <span class="attr">error</span>: <span class="literal">null</span> &#125;;</span><br><span class="line">  <span class="comment">// 当子组件抛出异常，这里会接收到并且调用</span></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">getDerivedStateFromError</span>(<span class="params">error: <span class="built_in">Error</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; error &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; error &#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; fallbackRender, children &#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">fallbackRender</span>(&#123; error &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> children;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后包裹整个组件树</p>
<h1 id="类型守卫"><a href="#类型守卫" class="headerlink" title="类型守卫"></a>类型守卫</h1><p>类型守卫(当符合条件时,value 就是 Error 类型)</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> isError = (<span class="attr">value</span>: <span class="built_in">any</span>): value is <span class="title class_">Error</span> =&gt; value?.<span class="property">message</span>;</span><br></pre></td></tr></table></figure>

<h1 id="React-Router"><a href="#React-Router" class="headerlink" title="React Router"></a>React Router</h1><p>在要使用的页面构建 Router 的 Context.</p>
<h2 id="路由参数-Hook"><a href="#路由参数-Hook" class="headerlink" title="路由参数 Hook"></a>路由参数 Hook</h2><p>由此设置依据 url 返回参数进行数据传递.<br>作用:返回页面 URL 中指定键的参数值.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useUrlQueryParam = &lt;K <span class="keyword">extends</span> <span class="built_in">string</span>&gt;<span class="function">(<span class="params">keys: K[]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [searchParams, setSearchParams] = <span class="title function_">useSearchParams</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">//使用useMemo优化这个方法</span></span><br><span class="line">    <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span></span><br><span class="line">      keys.<span class="title function_">reduce</span>(<span class="function">(<span class="params">prev, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...prev, [key]:searchParams.<span class="title function_">get</span>(<span class="string">&#x27;key&#x27;</span>) || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,&#123;&#125; <span class="keyword">as</span> &#123;[key <span class="keyword">in</span> K]: <span class="built_in">string</span>&#125;)</span><br><span class="line">    ,[keys,searchParams]),</span><br><span class="line">    <span class="comment">// 返回setSearchParams,约束入参</span></span><br><span class="line">    <span class="function">(<span class="params">params: Partial&lt;[key <span class="keyword">in</span> K]: <span class="built_in">unknown</span>&gt;</span>) =&gt;</span><span class="title function_">setSearchParams</span>(params)</span><br><span class="line">  ] <span class="keyword">as</span> <span class="keyword">const</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Shop-项目"><a href="#Shop-项目" class="headerlink" title="Shop 项目"></a>Shop 项目</h1><p>使用 reduxjs&#x2F;toolkit 中的 redux.<br>reducer 采用切片的方法.</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/index.ts</span></span><br><span class="line"><span class="comment">// 设置根reducer对象</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> rootReducer = &#123;</span><br><span class="line">  <span class="attr">auth</span>: authSlice.<span class="property">reducer</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = <span class="title function_">configureStore</span>(&#123;</span><br><span class="line">  <span class="attr">reducer</span>: rootReducer,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// auth.slice.ts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> authSlice = <span class="title function_">createSlice</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;auth&#x27;</span>,</span><br><span class="line">  initialState,</span><br><span class="line">  <span class="attr">reducers</span>: &#123;</span><br><span class="line">    <span class="title function_">setUser</span>(<span class="params">state,action</span>) &#123;</span><br><span class="line">      state.<span class="property">user</span> = action.<span class="property">payload</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;setUser&#125; = authSlice.<span class="property">actions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">selectUser</span> = (<span class="params">state:RootState</span>) =&gt; state.<span class="property">auth</span>.<span class="property">user</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">login</span> = (<span class="params">form:AuthForm</span>) =&gt; <span class="function">(<span class="params">dispatch:AppDispatch</span>) =&gt;</span>auth.<span class="title function_">login</span>(form).<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> <span class="title function_">dispatch</span>(<span class="title function_">setUser</span>(user))</span><br></pre></td></tr></table></figure>

<p>记得使用 Provider 将 Context 包裹</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/14/%E5%BE%AE%E5%89%8D%E7%AB%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/14/%E5%BE%AE%E5%89%8D%E7%AB%AF/" class="post-title-link" itemprop="url">微前端</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-14 16:33:54" itemprop="dateCreated datePublished" datetime="2022-09-14T16:33:54+08:00">2022-09-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><ol>
<li>拆分巨型应用,使得应用更好维护</li>
<li>兼容历史应用,实现增量开发</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/22/React%20CSS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/22/React%20CSS/" class="post-title-link" itemprop="url">React CSS</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-22 10:55:31" itemprop="dateCreated datePublished" datetime="2022-08-22T10:55:31+08:00">2022-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><p>可以选择的样式方案根据写法主要分为三种：第一种是常规 CSS（regular CSS），即原生 CSS 和各种预处理语言；第二种是在 JS 侧写样式的 CSS in JS 方案，例如 styled-components；第三种是在 HTML 中写工具类，由 CSS 框架生成对应样式的方案，例如 Tailwind CSS 。</p>
<h1 id="CSS-Modules"><a href="#CSS-Modules" class="headerlink" title="CSS Modules"></a>CSS Modules</h1><p>CSS Modules 是解决命名空间问题的一种方案，它可以基于指定的规则生成选择器名称，无需开发者遵守严格的规范，同时也避免对全局样式造成污染。</p>
<p>以下是一个简单的例子，原始代码是这样的：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.test</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&quot;index.less&quot;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.test&#125;</span> /&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<p>经过转换后，成为了这样:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">_xxxxxx</span> &#123;</span><br><span class="line">   <span class="attr">color</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> modules_xxx = &#123;<span class="string">&quot;test&quot;</span>:<span class="string">&quot;_xxxxxx&quot;</span>&#125;;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;modules_xxx[</span>&#x27;<span class="attr">test</span>&#x27;]&#125; /&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>通过对选择器添加 hash 值等方法，使选择器不会与其他地方产生冲突。</p>
<h1 id="emotion"><a href="#emotion" class="headerlink" title="emotion"></a>emotion</h1><p>可以模块化 css</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @emotion/styled @emotion/react</span><br></pre></td></tr></table></figure>

<p>写法,注意首字母大写</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Container</span> = styled.<span class="property">div</span><span class="string">`</span></span><br><span class="line"><span class="string">  display: flex;</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意styled后只能跟原生元素,如果要修改antd,加括号</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ShadowCard</span> = <span class="title function_">styled</span>(<span class="title class_">Card</span>)<span class="string">`</span></span><br><span class="line"><span class="string">  width: 40rem;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>

<h1 id="antd"><a href="#antd" class="headerlink" title="antd"></a>antd</h1><p>老版本 antd 和新版本 react-script 有冲突会报 less 警告.可以将引入 antd.css 改为 antd.min.css 即可解决.</p>
<h1 id="Grid-布局和-flex-布局"><a href="#Grid-布局和-flex-布局" class="headerlink" title="Grid 布局和 flex 布局"></a>Grid 布局和 flex 布局</h1><p>区别:</p>
<ol>
<li>一维布局: flex;二维布局: grid;</li>
<li>从内容出发用 flex,布局出发用 grid.</li>
</ol>
<p>内容出发:先有一组数据,数量不固定,希望均匀分布在容器中,由内容自己的大小占据空间.<br>布局出发: 先规划网格,再把元素往里面填充.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/08/React%20Router%20v6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/07/08/React%20Router%20v6/" class="post-title-link" itemprop="url">React Router v6</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-08 14:39:54" itemprop="dateCreated datePublished" datetime="2022-07-08T14:39:54+08:00">2022-07-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>v6 版本相对比前面有较大修改</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add react-router-dom</span><br></pre></td></tr></table></figure>

<h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><h1 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h1><h2 id="Routes"><a href="#Routes" class="headerlink" title="Routes"></a>Routes</h2><p>新版本 Routes 替代了 Switch,并且 Routes 和 Route 必须关联,<br>Route 内可以直接嵌套子路由.子路由的位置可以由<code>Outlet</code>组件占位.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Routes</span> , <span class="title class_">Route</span> , <span class="title class_">Outlet</span>  &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router</span></span><br><span class="line"><span class="string">import &#123; BrowserRouter &#125; from &#x27;</span>react-router-dom<span class="string">&#x27;</span></span><br><span class="line"><span class="string">const index = () =&gt; &#123;</span></span><br><span class="line"><span class="string">  return &lt;div className=&quot;page&quot; &gt;</span></span><br><span class="line"><span class="string">    &lt;div className=&quot;content&quot; &gt;</span></span><br><span class="line"><span class="string">       &lt;BrowserRouter &gt;</span></span><br><span class="line"><span class="string">           &lt;Menus /&gt;</span></span><br><span class="line"><span class="string">           &lt;Routes&gt;</span></span><br><span class="line"><span class="string">              &lt;Route element=&#123;&lt;Home /&gt;&#125;</span></span><br><span class="line"><span class="string">                  path=&quot;/home&quot;</span></span><br><span class="line"><span class="string">              &gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">              &lt;Route element=&#123;&lt;List/&gt;&#125;</span></span><br><span class="line"><span class="string">                  path=&quot;/list&quot;</span></span><br><span class="line"><span class="string">              &gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">              &lt;Route element=&#123;&lt;Layout/&gt;&#125;</span></span><br><span class="line"><span class="string">                  path=&quot;/children&quot;</span></span><br><span class="line"><span class="string">              &gt;</span></span><br><span class="line"><span class="string">                  &lt;Route element=&#123;&lt;Child1/&gt;&#125;</span></span><br><span class="line"><span class="string">                      path=&quot;/children/child1&quot;</span></span><br><span class="line"><span class="string">                  &gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">                  &lt;Route element=&#123;&lt;Child2/&gt;&#125;</span></span><br><span class="line"><span class="string">                      path=&quot;/children/child2&quot;</span></span><br><span class="line"><span class="string">                  &gt;&lt;/Route&gt;</span></span><br><span class="line"><span class="string">              &lt;/Route&gt;</span></span><br><span class="line"><span class="string">           &lt;/Routes&gt;</span></span><br><span class="line"><span class="string">       &lt;/BrowserRouter&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Layout渲染二级路由</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Container</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 这里Outlet的占位功能,声明了子路由的渲染位置</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Outlet</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 子路由菜单 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Menus1</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>&quot;/<span class="attr">children</span>/<span class="attr">child1</span>&quot;&#125;&gt;</span> child1 <span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>&quot;/<span class="attr">children</span>/<span class="attr">child2</span>&quot;&#125;&gt;</span> child2 <span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Layout</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      这里是 children 页面</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Menus1</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Container</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="路由状态和页面跳转"><a href="#路由状态和页面跳转" class="headerlink" title="路由状态和页面跳转"></a>路由状态和页面跳转</h1><h2 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Link</span> to=<span class="string">&quot;/invoices&quot;</span>&gt;<span class="title class_">Invoices</span>&lt;/<span class="title class_">Link</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Link-与-a-标签的区别？"><a href="#Link-与-a-标签的区别？" class="headerlink" title="Link 与 a 标签的区别？"></a>Link 与 a 标签的区别？</h3><p>Link 避免了重新渲染。Link 只会触发相匹配路由页面的更新，不会刷新整个页面。<br>Link 所做的事：</p>
<ul>
<li>有 onClick 就执行 onClick</li>
<li>click 的时候阻止 a 标签默认事件</li>
<li>根据跳转的 href，使用 history 跳转，只是链接变了，并不刷新整个页面</li>
</ul>
<h2 id="useLocation"><a href="#useLocation" class="headerlink" title="useLocation"></a>useLocation</h2><p>可以使用 useLocation 获取到路由状态 location 的信息,这里保存了<code>hash | key | pathname | search | state</code>等状态.</p>
<h2 id="useNavigate"><a href="#useNavigate" class="headerlink" title="useNavigate"></a>useNavigate</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> navigate = <span class="title function_">useNavigate</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> navigate(&#x27;/list&#x27;, &#123; state: &#x27;alien&#x27;&#125;)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        跳转列表页</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>navigate</code>第一个参数是路径,第二个是路由状态信息,可以传递<code>state</code>等信息.</p>
<h2 id="useParams"><a href="#useParams" class="headerlink" title="useParams"></a>useParams</h2><h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><p>通过<code>useParams</code>获取 url 上的动态路由信息</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Route</span> element=&#123;<span class="language-xml"><span class="tag">&lt;<span class="name">List</span> /&gt;</span></span>&#125; path=<span class="string">&quot;/list/:id&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<p>跳转动态路由:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;<span class="function">() =&gt;</span> <span class="title function_">navigate</span>(<span class="string">&quot;/lsit/1&quot;</span>)&#125;&gt;跳转列表页&lt;/button&gt;</span><br></pre></td></tr></table></figure>

<p>获取动态参数</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">List</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> params = <span class="title function_">useParams</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(params, <span class="string">&quot;params&quot;</span>); <span class="comment">// &#123;id: &#x27;1&#x27;&#125;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>React yes!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="useSearchParams"><a href="#useSearchParams" class="headerlink" title="useSearchParams"></a>useSearchParams</h2><p>用于 url 参数信息获取或设置.<br><code>const [searchParams, setSearchParams] = useSeatchParams()</code><br>方法中 searchParams 可以获取 params 中的 url 信息,第二个可以设置.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [searchParams, setSearchParams] = <span class="title function_">useSeatchParams</span>();</span><br><span class="line">  <span class="keyword">const</span> name = search.<span class="title function_">get</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">          setSearchParams(&#123; name: &quot;alien&quot;, age: 22 &#125;);</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        设置params</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h2><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Detail</span> = (<span class="params">props</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 方式1：通过search传递参数，比较复杂，不推荐，</span></span><br><span class="line">  <span class="comment">//需要用解构赋值获得search对象，然后调用get函数获取对应的key的值</span></span><br><span class="line">  <span class="comment">// const [search] = useSearchParams()</span></span><br><span class="line">  <span class="comment">// const detail = &#123; id: search.get(&#x27;id&#x27;), title: search.get(&#x27;title&#x27;) &#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方式2：通过params参数传递，非常简单直接使用useParams()</span></span><br><span class="line">  <span class="comment">// const detail = useParams()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方式3：通过state传递参数</span></span><br><span class="line">  <span class="comment">// const &#123; state: detail &#125; = useLocation();</span></span><br><span class="line">  <span class="comment">// console.log(&quot;此处可以收到来自route的state参数：&quot;, detail);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//方式1+plus：自定义的钩子根据传入的key数组拿到search中的数据并包装成对象</span></span><br><span class="line">  <span class="keyword">const</span> detail = <span class="title function_">useUrlQueryParam</span>([<span class="string">&quot;id&quot;</span>, <span class="string">&quot;title&quot;</span>]);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取到对象：&quot;</span>, detail);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>ID:&#123;detail.id&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>TITLE:&#123;detail.title&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        CONTENT:&#123;detail.title&#125;+&#123;detail.id&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Detail</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//js下极简的封装</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">useUrlQueryParam</span> = (<span class="params">keys</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> [search] = <span class="title function_">useSearchParams</span>();</span><br><span class="line">  <span class="comment">//遍历keys，从search中获取对应的值，返回一个新对象</span></span><br><span class="line">  <span class="keyword">const</span> query = keys.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, key</span>) =&gt;</span> &#123;</span><br><span class="line">    acc[key] = search.<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="keyword">return</span> acc;</span><br><span class="line">  &#125;, &#123;&#125;);</span><br><span class="line">  <span class="keyword">return</span> query;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="useRoutes"><a href="#useRoutes" class="headerlink" title="useRoutes"></a>useRoutes</h2><p>用于自由配置路由</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routeConfig = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/home&quot;</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Home</span> /&gt;</span></span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/list/:id&quot;</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">List</span> /&gt;</span></span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/children&quot;</span>,</span><br><span class="line">    <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Layout</span> /&gt;</span></span>,</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/children/child1&quot;</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Child1</span> /&gt;</span></span> &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">&quot;/children/child2&quot;</span>, <span class="attr">element</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">Child2</span> /&gt;</span></span> &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Index</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> element = <span class="title function_">useRoutes</span>(routeConfig);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;page&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Menus</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;element&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">Index</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">BrowserRouter</span>&gt;</span></span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="疑难问题"><a href="#疑难问题" class="headerlink" title="疑难问题"></a>疑难问题</h2><blockquote>
<p>axios 内部只是不能调用 hook，因为 hooks 的定义就是只能在函数组件顶层或其他 hook 内部调用。<br>解决办法：先在 axios 方法外调用 useNavigate 钩子得到 nav 方法，然后在 axios 回调里用 nav 方法进行路由跳转</p>
</blockquote>
<blockquote>
<p>Navigate 组件应该是放在业务组件里。比如路径&#x2F;a 要跳转到路径&#x2F;b，则是放在路径&#x2F;a 对应的 A 组件里，不是放在 routes 里面</p>
</blockquote>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><h2 id="BrowserRouter"><a href="#BrowserRouter" class="headerlink" title="BrowserRouter"></a>BrowserRouter</h2><ul>
<li>通过 createBrowserHistory 创建 history 对象，并通过 useRef 保存 history 对象。</li>
<li>通过 useLayoutEffect 来监听 history 变化，当 history 发生变化（浏览器人为输入，获取 a 标签跳转，api 跳转等 ）。派发更新，渲染整个 router 树。这是和老版本的区别，老版本里面，监听路由变化更新组件是在 Router 中进行的。</li>
<li>还有一点注意的事，在老版本中，有一个 history 对象的概念，新版本中把它叫做 navigator 。</li>
</ul>
<h1 id="不使用"><a href="#不使用" class="headerlink" title="不使用"></a>不使用</h1><h2 id="exact"><a href="#exact" class="headerlink" title="exact"></a>exact</h2><p>取消了,所有路由默认都是严格匹配,如果想模糊匹配,可以在路由后加<code>*</code></p>
<h1 id="新增数据路由"><a href="#新增数据路由" class="headerlink" title="新增数据路由"></a>新增数据路由</h1><p>主要是针对数据的新增一些 api。<br>比如 createBrowser 之类。<br>loader 方法，在路由加载之前可以用来请求数据。<br>errorElement：错误组件，路由通过 useRoutesError 返回错误信息，可以调用这个组件。只在使用数据路由时生效。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/28/Git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/28/Git/" class="post-title-link" itemprop="url">Git</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-28 16:32:14" itemprop="dateCreated datePublished" datetime="2022-06-28T16:32:14+08:00">2022-06-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:33" itemprop="dateModified" datetime="2023-07-23T09:11:33+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="区域划分"><a href="#区域划分" class="headerlink" title="区域划分"></a>区域划分</h1><p>git 初始化后。区域分为工作区，暂存区，版本库。<br>工作区：编写代码的区域。<br>暂存区：将代码暂时保存的区域，命令<code>git add .</code><br>版本库：即本地仓库，代码在本地保存的地方。命令<code>git commit -m &#39;xxx&#39;</code>。<br>远程仓库：即线上仓库。一般关联后，通过<code>git push</code>推送到远程仓库。通过<code>git pull</code>从远端拉取。</p>
<h1 id="新建仓库推送步骤"><a href="#新建仓库推送步骤" class="headerlink" title="新建仓库推送步骤"></a>新建仓库推送步骤</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 本地git初始化</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line">// 创建.gitignore文件</span><br><span class="line">touch .gitignore</span><br><span class="line"></span><br><span class="line">// 提交文件到暂存区</span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line">// 提交提交信息到版本库</span><br><span class="line">git commit -m &#x27;feat: first commit&#x27;</span><br><span class="line"></span><br><span class="line">// 关联远程仓库</span><br><span class="line">git remote add origin https://github.com/zaxtseng/xxx.git</span><br><span class="line"></span><br><span class="line">// 本地分支改名或者不改也行</span><br><span class="line">git branch -M main</span><br><span class="line">// 推送到远程分支(没改名）</span><br><span class="line">git push -u origin master</span><br><span class="line">// 改名了就推送到改名的分支</span><br><span class="line">git push -u origin main</span><br></pre></td></tr></table></figure>

<h1 id="新建分支并推送"><a href="#新建分支并推送" class="headerlink" title="新建分支并推送"></a>新建分支并推送</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 创建并切换</span><br><span class="line">git checkout -b newBranch</span><br><span class="line">// 推送到远程同名</span><br><span class="line">git push origin newBranch:newBranch</span><br></pre></td></tr></table></figure>

<h1 id="切换分支"><a href="#切换分支" class="headerlink" title="切换分支"></a>切换分支</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git checkout dev</span><br><span class="line"># 2.23以后新版本命令</span><br><span class="line">git switch dev</span><br><span class="line"># 创建并切换</span><br><span class="line">git switch -c test</span><br></pre></td></tr></table></figure>

<h1 id="删除远程分支"><a href="#删除远程分支" class="headerlink" title="删除远程分支"></a>删除远程分支</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 推送空分支到远程就删除了</span><br><span class="line">git push origin :newBranch</span><br><span class="line"></span><br><span class="line">//delete删除</span><br><span class="line">git push origin --delete newBranch</span><br><span class="line"></span><br><span class="line">// 对于不想改名，本地是master分支，远程是main分支的情况</span><br><span class="line">// 直接推送到远程master分支就会新建一个master分支并且删除main分支了</span><br><span class="line">// 推送到远程分支(没改名）</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<h1 id="删除本地分支"><a href="#删除本地分支" class="headerlink" title="删除本地分支"></a>删除本地分支</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 只有推送后才会删除</span><br><span class="line">git branch -d master</span><br><span class="line">// 强制删除</span><br><span class="line">git branch -D master</span><br></pre></td></tr></table></figure>

<h1 id="查看所有分支"><a href="#查看所有分支" class="headerlink" title="查看所有分支"></a>查看所有分支</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -a</span><br></pre></td></tr></table></figure>

<h2 id="切换远程分支"><a href="#切换远程分支" class="headerlink" title="切换远程分支"></a>切换远程分支</h2><p>git checkout -b 本地分支名 origin&#x2F;远程分支名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有分支</span><br><span class="line">git branch -a</span><br><span class="line"># 显示所有分支</span><br><span class="line">* dev</span><br><span class="line">master</span><br><span class="line">remotes/origin/HEAD -&gt; origin/master</span><br><span class="line">remotes/origin/master</span><br><span class="line">remotes/origin/release/caigou_v1.0</span><br><span class="line"></span><br><span class="line"># 切换到本地分支并且映射到远程指定分支</span><br><span class="line">git checkout -b dev origin/release/caigou_v1.0</span><br></pre></td></tr></table></figure>

<h1 id="新建本地项目推送远程仓库"><a href="#新建本地项目推送远程仓库" class="headerlink" title="新建本地项目推送远程仓库"></a>新建本地项目推送远程仓库</h1><h2 id="git-初始化"><a href="#git-初始化" class="headerlink" title="git 初始化"></a>git 初始化</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br></pre></td></tr></table></figure>

<h2 id="git-暂存提交"><a href="#git-暂存提交" class="headerlink" title="git 暂存提交"></a>git 暂存提交</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &#x27;first&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="关联远程仓库"><a href="#关联远程仓库" class="headerlink" title="关联远程仓库"></a>关联远程仓库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:xxx/xxx.git</span><br><span class="line"></span><br><span class="line"># 当前分支关联远程分支</span><br><span class="line">git branch --set-upstream-to=origin/dev dev</span><br></pre></td></tr></table></figure>

<h2 id="修改主分支名称"><a href="#修改主分支名称" class="headerlink" title="修改主分支名称"></a>修改主分支名称</h2><p>只有 github 是主分支 main,其他都是 master.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//强制修改当前分支为main</span><br><span class="line">git branch -M main</span><br></pre></td></tr></table></figure>

<h2 id="推送到远程并设置对应关系"><a href="#推送到远程并设置对应关系" class="headerlink" title="推送到远程并设置对应关系"></a>推送到远程并设置对应关系</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin main</span><br><span class="line"></span><br><span class="line">// 强制执行(注意会覆盖之前的)</span><br><span class="line"> git push -u origin master -f</span><br></pre></td></tr></table></figure>

<h2 id="如果之前创建了-Readme"><a href="#如果之前创建了-Readme" class="headerlink" title="如果之前创建了 Readme"></a>如果之前创建了 Readme</h2><p>大概率会推送失败,需要先拉取远程的 readme.md</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git pull origin main</span><br><span class="line">// 如果拉取报错</span><br><span class="line">git pull origin main --allow-unrelated-histories</span><br></pre></td></tr></table></figure>

<p>再执行上面的推送远程</p>
<h1 id="撤销合并"><a href="#撤销合并" class="headerlink" title="撤销合并"></a>撤销合并</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge --abort //回滚到合并之前</span><br></pre></td></tr></table></figure>

<h1 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h1><p>适用场景： 如果想恢复到之前某个提交的版本，且那个版本之后提交的版本我们都不要了，就可以用这种方法。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 版本名</span><br><span class="line">// hash名通过git log查找</span><br></pre></td></tr></table></figure>

<p>使用“git push -f”强制提交更改：<br>此时如果用“git push”会报错，因为我们本地库 HEAD 指向的版本比远程库的要旧.</p>
<blockquote>
<p>此方法就可以用于被其他人覆盖代码导致代码消失.</p>
</blockquote>
<h1 id="版本删除"><a href="#版本删除" class="headerlink" title="版本删除"></a>版本删除</h1><p>原理： git revert 是用于“反做”某一个版本，以达到撤销该版本的修改的目的。比如，我们 commit 了三个版本（版本一、版本二、 版本三），突然发现版本二不行（如：有 bug），想要撤销版本二，但又不想影响撤销版本三的提交，就可以用 git revert 命令来反做版本二，生成新的版本四，这个版本四里会保留版本三的东西，但撤销了版本二的东西</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git revert -n 版本名</span><br></pre></td></tr></table></figure>

<p>git 使用 dev 覆盖本地及远程 master 分支<br>1、切换到 dev 分支：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout dev</span><br></pre></td></tr></table></figure>

<p>2、删除本地的 master 分支：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -D master</span><br></pre></td></tr></table></figure>

<p>3、将 dev 分支复制到本地的 master 分支：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b master</span><br></pre></td></tr></table></figure>

<p>4、推送到远程并覆盖仓库的 master 分支：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin master --force</span><br></pre></td></tr></table></figure>

<p>git 远程分支强制覆盖本地的分支<br>1、下载代码到本地</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch --all</span><br></pre></td></tr></table></figure>

<p>2、将 HEAD 指向最新下载的版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard origin/分支名</span><br></pre></td></tr></table></figure>

<h1 id="git-fetch"><a href="#git-fetch" class="headerlink" title="git fetch"></a>git fetch</h1><ul>
<li>git fetch 是将远程主机的最新内容拉到本地，用户在检查了以后决定是否合并到工作本机分支中。</li>
<li>而 git pull 则是将远程主机的最新内容拉下来后直接合并，即：<code>git pull = git fetch + git merge</code>，这样可能会产生冲突，需要手动解决。</li>
</ul>
<h1 id="git-rebase"><a href="#git-rebase" class="headerlink" title="git rebase"></a>git rebase</h1><p>目的是改变提交的基底.从而实现之前的提交记录都是一条。</p>
<h2 id="git-rebase-和-git-merge-区别"><a href="#git-rebase-和-git-merge-区别" class="headerlink" title="git rebase 和 git merge 区别"></a>git rebase 和 git merge 区别</h2><p>二者的目的都是将代码合并.但是 git rebase 的提交记录更整洁.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 从master的提交A创建了新分支feature,并有两条提交记录</span><br><span class="line">	D---E feature</span><br><span class="line"> /</span><br><span class="line">A---B---C master</span><br></pre></td></tr></table></figure>

<h3 id="使用-merge"><a href="#使用-merge" class="headerlink" title="使用 merge"></a>使用 merge</h3><ul>
<li>切换到 feature 分支： git checkout feature。</li>
<li>合并 master 分支的更新： git merge master。</li>
<li>新增一个提交 F： git add . &amp;&amp; git commit -m “commit F” 。</li>
<li>切回 master 分支并执行快进合并： git chekcout master &amp;&amp; git merge feature。</li>
</ul>
<p>下面提交历史可以看到,提交历史有两条线,一条是 master 的提交记录,一条是 feature 的.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* 6fa5484 (HEAD -&gt; master, feature) commit F</span><br><span class="line">*   875906b Merge branch &#x27;master&#x27; into feature</span><br><span class="line">|\</span><br><span class="line">| | 5b05585 commit E</span><br><span class="line">| | f5b0fc0 commit D</span><br><span class="line">* * d017dff commit C</span><br><span class="line">* * 9df916f commit B</span><br><span class="line">|/</span><br><span class="line">* cb932a6 commit A</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用-rebase"><a href="#使用-rebase" class="headerlink" title="使用 rebase"></a>使用 rebase</h3><p>就是第二条命令换为 git rebase master.<br>而 rebase 的提交记录,只有一条线，rebase 保存了 DE 的修改，把基底从 A 挪到了 C,<br>实际上是<strong>复制</strong>了 DE 的提交，把之前的丢弃，再从 C 处重新新增的。所以 id 和之前的不一样。</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">本地仓库可以使用，线上仓库不要使用，因为id变化了，历史记录变化了，有可能有问题。</div>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 74199ce (HEAD -&gt; master, feature) commit F</span><br><span class="line">* e7c7111 commit E</span><br><span class="line">* d9623b0 commit D</span><br><span class="line">* 73deeed commit C</span><br><span class="line">* c50221f commit B</span><br><span class="line">* ef13725 commit A</span><br></pre></td></tr></table></figure>

<h3 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git checkout feature</span><br><span class="line"># 修改基底为最新的master 的最新的提交</span><br><span class="line">git rebase master</span><br><span class="line"># 提交</span><br><span class="line">git add . &amp;&amp; git commit -m &quot;commit F&quot;</span><br><span class="line"># 切换到master合并feature的代码</span><br><span class="line">git chekcout master &amp;&amp; git merge feature</span><br></pre></td></tr></table></figure>

<h1 id="git-撤销"><a href="#git-撤销" class="headerlink" title="git 撤销"></a>git 撤销</h1><h2 id="git-版本撤销-回滚"><a href="#git-版本撤销-回滚" class="headerlink" title="git 版本撤销(回滚)"></a>git 版本撤销(回滚)</h2><p>已经提交到线上仓库了。<br>可以使用<code>git reset --hard HEAD</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 回滚到上一个版本</span><br><span class="line">git reset --hard HEAD^</span><br><span class="line"># 回退到指定版本可以先通过git log查到某个版本的id</span><br><span class="line">git log</span><br><span class="line"># 指定回退的版本id</span><br><span class="line">git reset --hard HEAD abc123</span><br></pre></td></tr></table></figure>

<h2 id="git-撤销某个文件的修改"><a href="#git-撤销某个文件的修改" class="headerlink" title="git 撤销某个文件的修改"></a>git 撤销某个文件的修改</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git restore file.js</span><br><span class="line">git checkout -- file.js</span><br></pre></td></tr></table></figure>

<h2 id="git-撤销暂存区文件添加"><a href="#git-撤销暂存区文件添加" class="headerlink" title="git 撤销暂存区文件添加"></a>git 撤销暂存区文件添加</h2><p>相当于 git add 的反操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># git@2.23之后新版本操作命令</span><br><span class="line">git restore --staged file.js</span><br><span class="line"># 或者使用git reset</span><br><span class="line">git reset HEAD file.js</span><br></pre></td></tr></table></figure>

<h2 id="文件删除"><a href="#文件删除" class="headerlink" title="文件删除"></a>文件删除</h2><p>对于工作区的删除与撤销删除。<br>下面命令只针对，删除文件的操作保存到暂存区了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 删除某个文件</span><br><span class="line">rm file3.js</span><br><span class="line"># 提交到暂存区</span><br><span class="line">git add file3.js</span><br><span class="line"># 提交到版本库（本地仓库）</span><br><span class="line">git commit -m &quot;删除file3&quot;</span><br><span class="line"></span><br><span class="line"># 撤销删除file3</span><br><span class="line">git checkout -- file3.js</span><br><span class="line"># 新版本命令</span><br><span class="line">git restore file3.js</span><br></pre></td></tr></table></figure>

<h1 id="git-reflog-回流记录"><a href="#git-reflog-回流记录" class="headerlink" title="git reflog(回流记录)"></a>git reflog(回流记录)</h1><p>对于回滚后的记录，没有回滚之前的记录。想查看之前的使用这个命令。<br>查到对应的 ID，使用 git reset 回滚到对应的 id 版本。</p>
<h1 id="git-reset、checkout、revert"><a href="#git-reset、checkout、revert" class="headerlink" title="git reset、checkout、revert"></a>git reset、checkout、revert</h1><table>
<thead>
<tr>
<th>命令</th>
<th>范围</th>
<th>常见用例</th>
</tr>
</thead>
<tbody><tr>
<td>git reset</td>
<td>提交级别</td>
<td>丢弃私有分支中的提交或抛弃未提交的变更</td>
</tr>
<tr>
<td>git reset</td>
<td>文件级</td>
<td>取消暂存文件</td>
</tr>
<tr>
<td>git checkout</td>
<td>提交级别</td>
<td>在分支之间切换或检查旧快照</td>
</tr>
<tr>
<td>git checkout</td>
<td>文件级</td>
<td>丢弃工作目录中的变更</td>
</tr>
<tr>
<td>git revert</td>
<td>提交级别</td>
<td>撤销公共分支中的提交</td>
</tr>
<tr>
<td>git revert</td>
<td>文件级</td>
<td>（不适用）</td>
</tr>
</tbody></table>
<h1 id="常用"><a href="#常用" class="headerlink" title="常用"></a>常用</h1><ul>
<li>stash：存储临时代码。</li>
<li>reset –soft：软回溯，回退 commit 的同时保留修改内容。</li>
<li>cherry-pick：复制 commit。</li>
<li>revert：撤销 commit 的修改内容。</li>
<li>reflog：记录了 commit 的历史操作。</li>
</ul>
<h1 id="git-log"><a href="#git-log" class="headerlink" title="git log"></a>git log</h1><p>查看提交日志</p>
<h1 id="git-merge"><a href="#git-merge" class="headerlink" title="git merge"></a>git merge</h1><p>默认合并是 Fast-forward 模式。没有 git log 记录。<br>可以使用<code>--no--ff -m &#39;xxx&#39;</code>添加记录。<br>场景：master 是主分支，dev 是开发分支。目前 dev 分支 commit 进度超过 master。master 需要将进度赶到 dev 的进度。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 从dev切换到master</span><br><span class="line">git switch master</span><br><span class="line"># 合并dev分支</span><br><span class="line">git merge dev</span><br><span class="line"></span><br><span class="line"># 合并时添加备注信息</span><br><span class="line">git merge --no-ff -m &#x27;合并了功能1&#x27; dev</span><br></pre></td></tr></table></figure>

<h1 id="git-stash"><a href="#git-stash" class="headerlink" title="git stash"></a>git stash</h1><p>贮藏功能，相当于独立一块区域用于保存当前的开发内容。<br>场景：当前分支功能未开发完，需要修改线上开发 master 分支的 bug。<br>git stash apply,pop,drop,clear,list, push -m’xxx’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 当前master分支有bug，又有未开发完的功能在开发分支work</span><br><span class="line"></span><br><span class="line"># 把当前开发的功能贮藏</span><br><span class="line">git stash</span><br><span class="line"># 或者贮藏时加备注信息</span><br><span class="line">git stash push -m &#x27;xxx&#x27; // 贮藏信息为xxx</span><br><span class="line"># 通过list查看</span><br><span class="line">git stash list</span><br><span class="line"># 切换到有bug的master分支</span><br><span class="line">git checkout master</span><br><span class="line"># 创建一个修改bug的分支issue</span><br><span class="line">git checkout -b issue</span><br><span class="line"># 或者使用新版本代码创建</span><br><span class="line">git switch -c issue</span><br><span class="line"># 修改后推送合并</span><br><span class="line">git add .</span><br><span class="line">git commit -m &#x27;修改了功能1&#x27;</span><br><span class="line"># 切换到dev分支再合并</span><br><span class="line">git switch master</span><br><span class="line">git merge --no-ff -m &#x27;合并了修复bug1的分支代码&#x27; issue</span><br><span class="line"></span><br><span class="line"># 删除修复分支issue</span><br><span class="line">git checkout -D issue</span><br><span class="line"></span><br><span class="line"># 切回原分支work</span><br><span class="line">git switch work</span><br><span class="line"></span><br><span class="line"># 把修改好的代码拿到这个分支</span><br><span class="line">git cherry-pick 分支id</span><br><span class="line"># 取回贮藏区的代码</span><br><span class="line">git stash apply  // 只取回，不删除，取回指定的就是在后面加上stash@&#123;id&#125;</span><br><span class="line">git stash pop    // 取回并删除这一项</span><br><span class="line">git stash drop   // 删除第一项</span><br><span class="line">git stash clear  // 清空贮藏区</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="tag-标签"><a href="#tag-标签" class="headerlink" title="tag 标签"></a>tag 标签</h1><p>tag 的指针不会移动，master 的指针随着 commit 而移动。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 给当前的commit打tag</span><br><span class="line">git tag v1.0</span><br><span class="line"># 给以前的commit打tag</span><br><span class="line">git tag v0.9 id名</span><br><span class="line"># 添加备注信息</span><br><span class="line">git tag -a v0.9 -m &#x27;发布了0.9&#x27; id名</span><br><span class="line"># 查看备注信息</span><br><span class="line">git show v0.9</span><br><span class="line"># 删除标签</span><br><span class="line">git tag -d v0.9</span><br><span class="line"># 推送到远程仓库有标签</span><br><span class="line">git push origin v1.0</span><br><span class="line"># 删除远程标签</span><br><span class="line">git push origin :refs/tags/v1.0</span><br></pre></td></tr></table></figure>

<h1 id="commitlint"><a href="#commitlint" class="headerlink" title="commitlint"></a>commitlint</h1><p>提交时的分类<br>必填项，用于说明本次提交做出哪种类型的修改，必须是以下任意一值：</p>
<ul>
<li><strong>feat</strong>: A new feature（新功能）</li>
<li><strong>fix</strong>: A bug fix（bug 的修复）</li>
<li><strong>docs</strong>: Documentation only changes（修改项目中的文档）</li>
<li><strong>style</strong>: Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc)（不影响代码逻辑下的样式修改，通常是风格修改，例如空格、格式、分号方面的修改等）</li>
<li><strong>refactor</strong>: A code change that neither fixes a bug nor adds a feature（重构，不包括修复 bug 和添加新功能）</li>
<li><strong>perf</strong>: A code change that improves performance（性能优化）</li>
<li><strong>test</strong>: Adding missing or correcting existing tests（添加或者修改测试代码）</li>
<li><strong>chore</strong>: Changes to the build process or auxiliary tools and libraries such as documentation generation（对构建过程或辅助工具和库(如文档生成)的更改）</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/14/React%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/14/React%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">React工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-14 17:12:51" itemprop="dateCreated datePublished" datetime="2022-02-14T17:12:51+08:00">2022-02-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:34" itemprop="dateModified" datetime="2023-07-23T09:11:34+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="关于框架选择"><a href="#关于框架选择" class="headerlink" title="关于框架选择"></a>关于框架选择</h1><h2 id="Creat-React-App"><a href="#Creat-React-App" class="headerlink" title="Creat React App"></a>Creat React App</h2><p>它适用于以下类型的网站：<br>管理后台<br>仪表盘<br>数据分析<br>form 表单<br>内网应用</p>
<p>CRA 的优势：<br>✅ 官方出品<br>✅ 零配置<br>✅ CSR（即页面完全在浏览器渲染），简单易于学习<br>✅ 服务器和客户的代码完全解耦<br>✅ 易于部署，因为打包后的文件是静态文件<br>CRA 的劣势：<br>⛔️ 打包后的代码可能会臃肿<br>⛔️ 需要手动配置路由、状态管理、代码分割、样式文件等<br>⛔️ 不能用于需要 SEO 检索的网站<br>⛔️ 首屏效果不好，因为 CSR 页面在初始加载时比较慢，</p>
<h2 id="Gatsby"><a href="#Gatsby" class="headerlink" title="Gatsby"></a>Gatsby</h2><p>它适用于以下类型的网站：<br>完美支持个人网站、博客、文档网站（PS: React 的官方文档使用的就是 Gatsby），甚至是电子商务网站。</p>
<p>Gatsby 的优势：</p>
<p>✅ 页面渲染性能优秀<br>✅ 对 SEO 友好<br>✅ 对打包文件进行了优化<br>✅ 轻松部署到 CDN（基于出色的扩展功能）<br>✅ 可以创建一个具有离线功能的 PWA 应用<br>✅ 丰富的插件系统</p>
<p>Gatsby 的劣势：</p>
<p>⛔️ 使用起来相较于 CRA 更为复杂<br>⛔️ 需要了解 GraphQL 和 Node.Js 的相关知识<br>⛔️ 配置繁重<br>⛔️ 构建时间会随着内容的增加而变长<br>⛔️ 有些功能可能需要付费</p>
<p>值得强调的是，丰富的插件系统是选择 Gatsby 的重要原因，比如 Gatsby 提供许多博客主题插件，其他例如谷歌分析、图片压缩、预加载插件等等。</p>
<h2 id="Next-js"><a href="#Next-js" class="headerlink" title="Next.js"></a>Next.js</h2><p>适用于高动态或者面向用户的网页，这些页面需要优秀的 SEO，并且可能每分每秒都在变化。<br>举个例子：今日头条的首页会根据每个人不同的喜好来推送不同的信息流。如果使用 Gatsby 或 Create React App，会首先渲染一个空页面，然后通过 HTTP 调用来获取信息流的新闻数据。然后有了 Next ，可以在服务器端进行数据的获取，并返回完整的页面。<br>可以在 Next.js 的展示页面 查看有哪些应用是用 Next.js 构建的。<br>Next.js 的优势：</p>
<p>✅ 支持服务器端预渲染<br>✅ 对 SEO 友好<br>✅ 零配置<br>✅ 适用于面向用户的高动态内容<br>✅ 还可以像 Gatsby 一样做 SSG （ Server Side Generation）</p>
<p>Next.js 的劣势：</p>
<p>⛔️ 使用起来比 CRA 更复杂<br>⛔️ SSR 增加了额外的复杂程度<br>⛔️ 扩展取依赖于服务器<br>⛔️ 没有丰富的插件生态系统<br>⛔️ 有些功能可能需要付费</p>
<h1 id="不可变数据"><a href="#不可变数据" class="headerlink" title="不可变数据"></a>不可变数据</h1><p>既然是不可变数据，为何还能变更。这里说的不可变是指不能改变数据本身，如果需要改变数据，是先创建一个该数据的副本，然后在这个副本上进行修改操作，这样就在没有改变原始数据的基础上做了数据变更。此技术称之为写时复制。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [todos, setTodos] = <span class="title function_">useState</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;learn immer&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTodo</span>(<span class="params">todo</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> newTodos = [...todos, todo]; <span class="comment">// 这里不是直接修改todos，而是创建了一个newTodos。</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">setTodos</span>(newTodos);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="immer"><a href="#immer" class="headerlink" title="immer"></a>immer</h2><p>当拷贝一个值时，如果这个值是引用类型，那么直接赋值给另一个值时，会把值的引用也拷贝过去，改变这个值，会影响原值。<br>通常我们会使用深拷贝解决。<br>而 immer 会将改变应用到值的代理上，返回新的值。这样也不会影响原值。<br>immer 是使用 Proxy 进行的包装。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add immer</span><br></pre></td></tr></table></figure>

<h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//常规</span></span><br><span class="line"><span class="keyword">const</span> state = &#123; <span class="attr">id</span>: <span class="string">&quot;1&quot;</span>, <span class="attr">name</span>: <span class="string">&quot;张三&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> newState = &#123; ...state, <span class="attr">name</span>: <span class="string">&quot;李四&quot;</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;;</span><br><span class="line"><span class="comment">//immer</span></span><br><span class="line"><span class="keyword">import</span> produce <span class="keyword">from</span> <span class="string">&quot;immer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = &#123; <span class="attr">id</span>: <span class="string">&quot;1&quot;</span>, <span class="attr">name</span>: <span class="string">&quot;张三&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newState = <span class="title function_">produce</span>(state, <span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">  draft.<span class="property">name</span> = <span class="string">&quot;李四&quot;</span>;</span><br><span class="line">  draft.<span class="property">age</span> = <span class="number">25</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="更多层级"><a href="#更多层级" class="headerlink" title="更多层级"></a>更多层级</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//常规</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="attr">address</span>: &#123;</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&quot;北京&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newState = &#123;</span><br><span class="line">  ...state,</span><br><span class="line">  <span class="attr">address</span>: &#123;</span><br><span class="line">    ...state.<span class="property">address</span>,</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&quot;上海&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//immer</span></span><br><span class="line"><span class="keyword">import</span> produce <span class="keyword">from</span> <span class="string">&quot;immer&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="attr">address</span>: &#123;</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&quot;北京&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newState = <span class="title function_">produce</span>(state, <span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">  draft.<span class="property">address</span>.<span class="property">city</span> = <span class="string">&quot;上海&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(state);</span><br><span class="line"><span class="comment">/*输出：</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  id: &#x27;1&#x27;,</span></span><br><span class="line"><span class="comment">  name: &#x27;张三&#x27;,</span></span><br><span class="line"><span class="comment">  address: &#123;</span></span><br><span class="line"><span class="comment">    city: &#x27;北京&#x27;,</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newState);</span><br><span class="line"><span class="comment">/*输出：</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">  id: &#x27;1&#x27;,</span></span><br><span class="line"><span class="comment">  name: &#x27;张三&#x27;,</span></span><br><span class="line"><span class="comment">  address: &#123;</span></span><br><span class="line"><span class="comment">    city: &#x27;上海&#x27;,</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="更新数组"><a href="#更新数组" class="headerlink" title="更新数组"></a>更新数组</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newNums = [...nums, <span class="number">6</span>]; <span class="comment">// 在数组的末尾添加6</span></span><br><span class="line"><span class="keyword">const</span> newNums2 = [...nums.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">1</span>), ...nums.<span class="title function_">slice</span>(<span class="number">2</span>)]; <span class="comment">//删除数字2</span></span><br><span class="line"><span class="keyword">const</span> newNums3 = [...nums.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">1</span>), <span class="number">7</span>, ...nums.<span class="title function_">slice</span>(<span class="number">2</span>)]; <span class="comment">// 将数字2替换为7</span></span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> produce <span class="keyword">from</span> <span class="string">&quot;immer&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newNums = <span class="title function_">produce</span>(nums, <span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">  draft.<span class="title function_">push</span>(<span class="number">6</span>);</span><br><span class="line">&#125;); <span class="comment">// 在数组的末尾添加6</span></span><br><span class="line"><span class="keyword">const</span> newNums2 = <span class="title function_">produce</span>(nums, <span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">  draft.<span class="title function_">splice</span>(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">&#125;); <span class="comment">//删除数字2</span></span><br><span class="line"><span class="keyword">const</span> newNums3 = <span class="title function_">produce</span>(nums, <span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">  draft.<span class="title function_">splice</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">7</span>);</span><br><span class="line">&#125;); <span class="comment">// 将数字2替换为7</span></span><br></pre></td></tr></table></figure>

<h3 id="对象数组操作"><a href="#对象数组操作" class="headerlink" title="对象数组操作"></a>对象数组操作</h3><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&quot;learn react&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&quot;learn redux&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&quot;learn immer&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTodo</span>(<span class="params">todo</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> [...todos, todo];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toggleTodo</span>(<span class="params">index</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> todos.<span class="title function_">map</span>(<span class="function">(<span class="params">todo, idx</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (idx === index) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; ...todo, <span class="attr">completed</span>: !todo.<span class="property">completed</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> todo;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> todos = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&quot;learn react&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&quot;learn redux&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">text</span>: <span class="string">&quot;learn immer&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTodo</span>(<span class="params">todo</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">produce</span>(todos, <span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">    draft.<span class="title function_">push</span>(todo);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toggleTodo</span>(<span class="params">index</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">produce</span>(todos, <span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">    draft[index].<span class="property">completed</span> = !draft[index].<span class="property">completed</span>;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在底层，immer 使用了 ES6 Proxy 对现有的状态（即 JavaScript 对象）做了代理，形成了 draft 对象。对 draft 对象的任何同步赋值操作都会被代理捕捉到，等变更操作完成后，immer 会根据捕捉到的变更操作，来生成新的 JavaScript 对象。</p>
<h3 id="与-React-的状态更新结合使用"><a href="#与-React-的状态更新结合使用" class="headerlink" title="与 React 的状态更新结合使用"></a>与 React 的状态更新结合使用</h3><p>使用 immer 可以简化深层的状态更新操作。如下所示：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">&quot;React&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> produce <span class="keyword">from</span> <span class="string">&quot;immer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">  <span class="attr">userName</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">16</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常规方式</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleBirthDayClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">setUser</span>(<span class="function">(<span class="params">prevUser</span>) =&gt;</span> (&#123;</span><br><span class="line">    ...prevUser,</span><br><span class="line">    <span class="attr">age</span>: prevUser.<span class="property">age</span> + <span class="number">1</span>,</span><br><span class="line">  &#125;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// immer方式</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleBirthDayClick2</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">setUser</span>(</span><br><span class="line">    <span class="title function_">produce</span>(<span class="function">(<span class="params">draft</span>) =&gt;</span> &#123;</span><br><span class="line">      draft.<span class="property">age</span> += <span class="number">1</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>当然，如果真的遇到很深层次的 React 组件状态，就需要看看是否真的有必要设计出这么深层次的数据结构。</p>
<p>immer 更常见的是与 useReducer 结合使用：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useReducer &#125; <span class="keyword">from</span> <span class="string">&quot;React&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> produce <span class="keyword">from</span> <span class="string">&quot;immer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todoReducers = <span class="title function_">produce</span>(<span class="function">(<span class="params">draft, action</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;ADD_TODO&quot;</span>:</span><br><span class="line">      draft.<span class="title function_">push</span>(action.<span class="property">payload</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;TOGGLE_TODO&quot;</span>:</span><br><span class="line">      draft[action.<span class="property">payload</span>].<span class="property">completed</span> = !draft[action.<span class="property">payload</span>].<span class="property">completed</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [todos, dispatch] = <span class="title function_">useReducer</span>(todoReducers, []);</span><br></pre></td></tr></table></figure>

<h2 id="immutable-js"><a href="#immutable-js" class="headerlink" title="immutable.js"></a>immutable.js</h2><p>这是 Facebook 官方推出的数据不可变工具.</p>
<h2 id="可变数据"><a href="#可变数据" class="headerlink" title="可变数据"></a>可变数据</h2><p>引用类型就是可变数据,复制一份引用类型,改变内部属性的值,所有复制的值都会变化,因为引用的是同一份地址.</p>
<h2 id="不可变数据方案"><a href="#不可变数据方案" class="headerlink" title="不可变数据方案"></a>不可变数据方案</h2><p>常规的比如浅拷贝,但是对于层级比较深的就无法处理.</p>
<h1 id="Redux-devtools"><a href="#Redux-devtools" class="headerlink" title="Redux devtools"></a>Redux devtools</h1><p>调试工具。</p>
<ol>
<li>下载 redux devtools 插件。</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启 redux-devtools</span></span><br><span class="line"><span class="keyword">const</span> composeEnhancers =</span><br><span class="line">  (<span class="variable language_">window</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__REDUX_DEVTOOLS_EXTENSION_COMPOSE__</span> || compose;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用中间件</span></span><br><span class="line"><span class="keyword">const</span> middleWares = <span class="title function_">applyMiddleware</span>(thunk, reduxPromise);</span><br><span class="line"><span class="comment">// 配合 devtools</span></span><br><span class="line"><span class="keyword">const</span> enhancer = <span class="title function_">composeEnhancers</span>(middleWares);</span><br><span class="line"><span class="comment">// 创建store</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">store</span>: <span class="title class_">Store</span> = <span class="title function_">legacy_createStore</span>(enhancer);</span><br></pre></td></tr></table></figure>

<h1 id="动效库-framer-motion"><a href="#动效库-framer-motion" class="headerlink" title="动效库 framer-motion"></a>动效库 framer-motion</h1><p>需要自定义配置。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;motion.<span class="property">div</span></span><br><span class="line">  variants=&#123;staggerTextContainer&#125;</span><br><span class="line">  initial=<span class="string">&quot;initial&quot;</span></span><br><span class="line">  whileInView=<span class="string">&quot;animate&quot;</span></span><br><span class="line">  viewport=&#123;&#123; <span class="attr">once</span>: <span class="literal">false</span>, <span class="attr">amount</span>: <span class="number">0.6</span> &#125;&#125;</span><br><span class="line">  className=<span class="string">&quot;flex flex-col lg:flex-row&quot;</span></span><br><span class="line">&gt;</span><br><span class="line">  &#123;<span class="comment">/* text */</span>&#125;</span><br><span class="line">  &lt;motion.<span class="property">div</span> variants=&#123;fadeInUp&#125; className=<span class="string">&quot;lg:w-[40%]&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">className</span>=<span class="string">&quot;h3&quot;</span>&gt;</span>&#123;pretitle&#125;<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">className</span>=<span class="string">&quot;h2 mb-6&quot;</span>&gt;</span>&#123;title&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">  &lt;/motion.<span class="property">div</span>&gt;</span><br><span class="line">  &#123;<span class="comment">/* slider */</span>&#125;</span><br><span class="line">  &lt;motion.<span class="property">div</span> variants=&#123;fadeInUp&#125; className=<span class="string">&quot;lg:w-[60%] lg:absolute lg:right-0&quot;</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Slider</span> <span class="attr">clients</span>=<span class="string">&#123;clients&#125;</span> /&gt;</span></span></span><br><span class="line">  &lt;/motion.<span class="property">div</span>&gt;</span><br><span class="line">&lt;/motion.<span class="property">div</span>&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/06/React%20Router/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/02/06/React%20Router/" class="post-title-link" itemprop="url">React Router</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-02-06 13:29:44" itemprop="dateCreated datePublished" datetime="2022-02-06T13:29:44+08:00">2022-02-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-07-23 09:11:34" itemprop="dateModified" datetime="2023-07-23T09:11:34+08:00">2023-07-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><code>yarn add react-router-dom</code>或<code>npm i react-router-dom</code></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>导入路由核心组件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>, <span class="title class_">Route</span>, <span class="title class_">Link</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-router-dom&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>使用<code>Router</code>包裹整个应用.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Router</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span>//...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Router</span>&gt;</span><br></pre></td></tr></table></figure>

<p>指定路由入口和出口</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">First</span> = (<span class="params"></span>) =&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>页面<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">App</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&quot;/first&quot;</span>&gt;</span>页面<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/first&quot;</span> <span class="attr">component</span>=<span class="string">&#123;First&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意: v6 版本中将 component 替换成了 element.</p>
</blockquote>
<h1 id="常见组件"><a href="#常见组件" class="headerlink" title="常见组件"></a>常见组件</h1><h2 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h2><p>包裹整个组件,一个 React 应用只使用一次.<br>两种常用 Router: <code>Browser Router</code>和<code>HashRouter</code></p>
<h2 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h2><p>用于指定导航链接,最终会被编译为<code>&lt;a&gt;</code></p>
<h2 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h2><p>展示组件相关信息</p>
<ul>
<li>path 属性: 路由规则</li>
<li>component 属性: 展示的组件</li>
<li>Route 写在哪,渲染的组件就展示在哪</li>
</ul>
<h2 id="Switch-v6-已弃用"><a href="#Switch-v6-已弃用" class="headerlink" title="Switch(v6 已弃用)"></a>Switch(v6 已弃用)</h2><p>使用<code>Switch</code>包裹路由就会只加载一个匹配的路由.</p>
<blockquote>
<p>注意: v6 版本使用 Routes 替换 Switch.</p>
</blockquote>
<h2 id="NavLink"><a href="#NavLink" class="headerlink" title="NavLink"></a>NavLink</h2><p>作用: 选中的 Link 有<code>class=&quot;active&quot;</code>,就可以给对应的类加上样式.</p>
<h3 id="其他参数"><a href="#其他参数" class="headerlink" title="其他参数"></a>其他参数</h3><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">NavLink</span> activeClassName=<span class="string">&quot;selected&quot;</span> exact</span><br><span class="line">  to=&#123;&#123;</span><br><span class="line">    pathname=<span class="string">&quot;/mine&quot;</span>,</span><br><span class="line">    search=<span class="string">&quot;?sort=name&quot;</span>,</span><br><span class="line">    hash=<span class="string">&quot;#the-hash&quot;</span>,</span><br><span class="line">    state=&#123;<span class="attr">flag</span>: <span class="string">&#x27;flag&#x27;</span>&#125; <span class="comment">//可以隐式传参</span></span><br><span class="line">  &#125;&#125;&gt;<span class="title class_">Mine</span>页面&lt;/<span class="title class_">NavLink</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Redirect-v6-弃用"><a href="#Redirect-v6-弃用" class="headerlink" title="Redirect(v6 弃用)"></a>Redirect(v6 弃用)</h2><blockquote>
<p>v6 弃用,使用 Navigate 替代.</p>
</blockquote>
<p>from 是输入某个路径,to 是要跳转的路径.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Redirect</span> <span class="keyword">from</span>=<span class="string">&quot;/home&quot;</span> to=<span class="string">&quot;/&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h3 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h3><p><code>push</code>和<code>replace</code><br>区别: <code>push</code>叠加, <code>replace</code>直接替换.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Mine</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    props.<span class="property">history</span>.<span class="title function_">push</span>(<span class="string">&quot;/home&quot;</span>);</span><br><span class="line">    props.<span class="property">history</span>.<span class="title function_">replace</span>(<span class="string">&quot;/home&quot;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>Click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Navigate"><a href="#Navigate" class="headerlink" title="Navigate"></a>Navigate</h2><p>场景: 首页重定向到指定路由,url 中包含该路由地址</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接将Navigate作为element组件</span></span><br><span class="line">&lt;<span class="title class_">Route</span> path=<span class="string">&quot;/&quot;</span> element=&#123;<span class="language-xml"><span class="tag">&lt;<span class="name">Navigate</span> <span class="attr">to</span>=<span class="string">&#123;</span>&quot;/<span class="attr">projects</span>&quot;&#125; /&gt;</span></span>&#125; /&gt;</span><br></pre></td></tr></table></figure>

<h2 id="withRouter"><a href="#withRouter" class="headerlink" title="withRouter"></a>withRouter</h2><p>高阶组件,用于当前组件没有被<code>Router</code>包裹,而无法拿到相关的参数.<br>使用<code>withRouter(Mine)</code>包裹即可.</p>
<h2 id="Prompt-v6-弃用"><a href="#Prompt-v6-弃用" class="headerlink" title="Prompt(v6 弃用)"></a>Prompt(v6 弃用)</h2><p>类似钩子函数,用于跳转之前的操作</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Prompt</span> when=&#123;!!<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">name</span>&#125; message=&#123;<span class="string">&quot;确定离开?&quot;</span>&#125; /&gt;</span><br></pre></td></tr></table></figure>

<h1 id="编程式导航"><a href="#编程式导航" class="headerlink" title="编程式导航"></a>编程式导航</h1><h2 id="push-path"><a href="#push-path" class="headerlink" title="push(path)"></a>push(path)</h2><p>push 表示跳转到某个页面,参数 path 表示要调整的路径.<br><code>this.props.history.push(&quot;/home&quot;)</code></p>
<h2 id="go-n"><a href="#go-n" class="headerlink" title="go(n)"></a>go(n)</h2><p>前进或后退到某个页面,参数 n 表示前进或后退的页面数量</p>
<h1 id="默认路由"><a href="#默认路由" class="headerlink" title="默认路由"></a>默认路由</h1><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Route</span> path=<span class="string">&quot;/&quot;</span> component=&#123;<span class="title class_">Home</span>&#125; /&gt;</span><br></pre></td></tr></table></figure>

<h2 id="模糊匹配"><a href="#模糊匹配" class="headerlink" title="模糊匹配"></a>模糊匹配</h2><p>React 默认使用模糊匹配,即 pathname 相同即会匹配.</p>
<h2 id="精确匹配"><a href="#精确匹配" class="headerlink" title="精确匹配"></a>精确匹配</h2><p>关键字: <code>exact</code><br>更加精准: <code>strict</code></p>
<h1 id="404-页面"><a href="#404-页面" class="headerlink" title="404 页面"></a>404 页面</h1><p>当所有规则都没有匹配中时,设置 404 页面.即不设置规则.</p>
<h1 id="简约写法"><a href="#简约写法" class="headerlink" title="简约写法"></a>简约写法</h1><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Route</span> path=<span class="string">&quot;/&quot;</span> render=&#123;<span class="function">() =&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Home</span> /&gt;</span></span>&#125; /&gt;</span><br></pre></td></tr></table></figure>

<h1 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h1><p>在 path 上使用<code>path=&quot;name/:name/:id?&quot;</code>,使用冒号传递,问号表示可选.</p>
<h2 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h2><p><code>props.match.params.name</code></p>
<h2 id="其他读取方式"><a href="#其他读取方式" class="headerlink" title="其他读取方式"></a>其他读取方式</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> querystring <span class="keyword">from</span> <span class="string">&quot;querystring&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Mine</span> = (<span class="params">props</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> params = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>(props.<span class="property">location</span>.<span class="property">search</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(params.<span class="title function_">get</span>(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">  <span class="comment">//第二种</span></span><br><span class="line">  <span class="keyword">const</span> value = querystring.<span class="title function_">parse</span>(props.<span class="property">location</span>.<span class="property">search</span>); <span class="comment">//注意会获取前面的?,要截取</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Mine<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="路由嵌套"><a href="#路由嵌套" class="headerlink" title="路由嵌套"></a>路由嵌套</h1><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Book</span> <span class="keyword">from</span> <span class="string">&quot;./Book&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">WebBook</span> <span class="keyword">from</span> <span class="string">&quot;./WebBook&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">JavaBook</span> <span class="keyword">from</span> <span class="string">&quot;./JavaBook&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">component</span>=<span class="string">&#123;Home&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Book</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/book/webBook&quot;</span> <span class="attr">component</span>=<span class="string">&#123;WebBook&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/book/javaBook&quot;</span> <span class="attr">component</span>=<span class="string">&#123;JavaBook&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">Book</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zax Tseng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
