<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Zax&#39;s BLOG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Zax&#39;s BLOG">
<meta property="og:type" content="website">
<meta property="og:title" content="Zax&#39;s BLOG">
<meta property="og:url" content="http://yoursite.com/page/11/index.html">
<meta property="og:site_name" content="Zax&#39;s BLOG">
<meta property="og:description" content="Zax&#39;s BLOG">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zax Tseng">
<meta property="article:tag" content="javascript, React, Vue, HTML5">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Zax&#39;s BLOG" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Zax&#39;s BLOG</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-magisk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/15/magisk/" class="article-date">
  <time datetime="2019-12-15T03:10:15.000Z" itemprop="datePublished">2019-12-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/15/magisk/">magisk</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>magisk</p>
<p>Magisk manager is a magic mask to alter system systemless-ly.</p>
<p>Installing Magisk will give you ROOT, a super powerful Systemless Interface,<br>Magisk Modules support, and hide from tons of integrity tests like SafetyNet!</p>
<h1 id="What-is-Magisk"><a href="#What-is-Magisk" class="headerlink" title="What is Magisk?"></a>What is Magisk?</h1><p>Magisk is a great open-source root solution for Android devices which is developed by topjohnwu[<a target="_blank" rel="noopener" href="https://forum.xda-developers.com/member.php?u=4470081%5D">https://forum.xda-developers.com/member.php?u=4470081]</a>, offering a “Systemless Interface”, allowing easy modification of your favourite device with peace of mind. Magisk is a module based application, so its configuration can be as individual as the member applying them. Many modules exist for Magisk, providing all sorts of modifications, such as cloaking your device from SafetyNet. </p>
<h1 id="Highlights"><a href="#Highlights" class="headerlink" title="Highlights"></a>Highlights</h1><p>Open Source:<br>100% open source and easy to build on all Google supported platforms.<br>Magic Mount:<br>Modify system (vendor) without tampering the partitions.<br>MagiskSU:<br>Unleash your device’s root access.<br>MagiskHide:<br>Hide Magisk from detections: Google SafetyNet, enterprise &#x2F; bank system integrity checks, game tamper checks.<br>Resetprop:<br>Modify or delete any system properties, including read-only props.<br>Magisk Modules:<br>Install Magisk Modules from the community driven Magisk Module Repo.Many custom modules for Magisk,like Fonts,Audio Mod,DNS.</p>
<h1 id="What-is-Magisk-Manager"><a href="#What-is-Magisk-Manager" class="headerlink" title="What is Magisk Manager?"></a>What is Magisk Manager?</h1><p>Magisk Manager is the application same as SuperSU which is pre-installed on your device after you have rooted your Android device. If you want to use the magisk manager you can unroot your device and then root it with the help flashing Magisk-v20.zip or else you can install the magisk manager application and do the system less rooting on your device.</p>
<p>There are many questions raised, and people has a query that is How to root with magisk? The rooting procedure is simple, and you need a custom recovery installed on your device. If you have the custom recovery, then you can root your Android device by flashing the Magisk-v20.zip file.</p>
<h1 id="Magisk-and-superSu"><a href="#Magisk-and-superSu" class="headerlink" title="Magisk and superSu"></a>Magisk and superSu</h1><p>If you root your device with the help of magisk, then the magisk won’t do any changes in your system files. Magisk will modify the boot.img to magisk.img. Magisk won’t add any files in your system files.</p>
<p>When SuperSU roots your device, it will do the changes in the System files and also adds some files in the system partition. If you install SuperSU, you won’t be getting any OTA updates or any financial application won’t work on your device.</p>
<h1 id="guide"><a href="#guide" class="headerlink" title="guide"></a>guide</h1><p>Before Installing Magisk,you must Unlocking Bootloader.</p>
<h1 id="Download-Magisk-Zip-and-Magisk-Manager-APK"><a href="#Download-Magisk-Zip-and-Magisk-Manager-APK" class="headerlink" title="Download Magisk Zip and Magisk Manager APK"></a>Download Magisk Zip and Magisk Manager APK</h1><p>You can usually download Magisk from the original development thread at XDA. But it only provides Magisk download link for the latest version. However, sometimes, the latest version isn’t the best version for you. For instance, a newer version of Magisk may not be able to hide from an app like Google Pay which is actually known to run into problems despite using MagiskHide.</p>
<p>Using an older version of Magisk that you know works for you might be a temporary solution until it’s fixed. In that case, though, you’re out of luck. But not anymore. You can download all Magisk versions from below. The list below is comprehensive and contains all Magisk versions since it was released publicly.</p>
<p>Below, you will find oldest to the latest version of Magisk zip for Android Nougat, Oreo, and Pie and download them directly from the Magisk Github repository. Just click the direct Magisk download links below. Moreover, we’ve also listed the compatible version of Magisk Manager and Magisk Uninstaller for each Magisk release. You can use Magisk Uninstaller zip file to remove Magisk from your Android device.</p>
<h1 id="How-to-install-Magisk"><a href="#How-to-install-Magisk" class="headerlink" title="How to install Magisk?"></a>How to install Magisk?</h1><p>If you don’t have a Android device with a TWRP recovery,you can refer to Plan A.But I suggest you install it,it’s very userful.<br>If you have a Android device with a TWRP recovery,you can refer to Plan B.</p>
<p>If you are using a Huawei device running EMUI 8 and higher, please check its section.<br>If you are using a Samsung device that is launched with Android 9.0 (new devices in 2019), please check its section.</p>
<h1 id="Plan-A"><a href="#Plan-A" class="headerlink" title="Plan A"></a>Plan A</h1><ol>
<li>Download Magisk Manager on your Android device.</li>
<li>Install the application, and you might get an unknown source warning. You need to turn on Unknown Sources to turn it on, click on “Settings”.</li>
<li>Now, try to repeat the installation process again. Try installing the application and open it.</li>
<li>If you have already installed the Chainfire SuperSU on your device, then you need to grant the root permission.</li>
<li>Now, click on the Install button to install the magisk on your device.</li>
<li>If you will click on Install button you will see that it will ask you to select method.</li>
<li>Just click on Direct Install if you want to directly install the file on your phone without using custom recovery on your phone, or you can click on Download Zip File Only.</li>
<li>Now, if the download is the done. Magisk Manager will automatically install the file on your phone.</li>
</ol>
<h1 id="Plan-B"><a href="#Plan-B" class="headerlink" title="Plan B"></a>Plan B</h1><ol>
<li>Download the Magisk zip file.</li>
<li>Place the zip file in your internal storage. Make sure that you remember the proper location of the zip file.</li>
<li>Reboot your phone into recovery ensure that you have a custom recovery such as TWRP is installed on your phone.</li>
<li>Now, click on the Install button in the TWRP recovery.</li>
<li>Navigate the Magisk-v20.zip on your internal storage or SD card.</li>
<li>Now, install the zip file on your device and wait till it is getting installed on your device.</li>
<li>You have successfully flashed the Magisk-v20.zip on your device.</li>
<li>Reboot your phone and see if it works on your device.</li>
<li>Download the magisk manager application from the link given above.</li>
<li>Install the application by following the above procedure.</li>
<li>Open it and then you will see magisk is installed on your Android device.</li>
</ol>
<h1 id="How-to-use-Magisk-Hide"><a href="#How-to-use-Magisk-Hide" class="headerlink" title="How to use Magisk Hide?"></a>How to use Magisk Hide?</h1><p>Magisk Hide is the feature which is available in the Magisk Manager application and if you want to hide the root permission for the particular banking application.</p>
<p>You can turn the Magisk hide option from the settings of the magisk application then you can easily enjoy your favorite app without any issues.</p>
<p>If you want to activate the Magisk Hide option, then you can follow the below tutorial, and you can hide the root permission on your device.</p>
<ol>
<li>First, check the application which is not working on your rooted Android device.</li>
<li>Open Magisk on your device and click on the Menu button.</li>
<li>Now, Click on the Settings to turn on the magisk hide option.</li>
<li>Now, scroll down and enable the Magisk Hide option.</li>
<li>Press the Menu key again and click on the “Magisk Hide” option.</li>
<li>Now, you need to select the application from which you need to hide the root.</li>
<li>Open your banking application and then that’s it. You can run the banking application on your device now.</li>
</ol>
<h1 id="Huawei"><a href="#Huawei" class="headerlink" title="Huawei"></a>Huawei</h1><p>Huawei devices using Kirin processors have a different partitioning method from most common devices. Magisk is usually installed to the boot partition of the device, however Huawei devices do not have this partition. Depending on what EMUI version your device is running, the instructions will be slightly different.</p>
<p>Obtain Stock Images<br>Huawei does not release official factory images, however most firmware zips can be downloaded from the Huawei Firmware Database. To extract images from UPDATE.APP in the zip, you have to use Huawei Update Extractor (Windows only!)</p>
<p>EMUI 8<br>For EMUI 8 devices, your device has a partition named ramdisk, which is where Magisk is going to be installed.</p>
<p>If you plan to use custom recoveries, simply follow the instructions for custom recovery and you’re all set.<br>If you plan not to use custom recoveries, you will have to extract RAMDISK.img from your firmware. Follow the instructions for boot image patching above, but use the RAMDISK.img file instead of a boot image.<br>To flash the patched image to your device, here is the fastboot command:<br>fastboot flash ramdisk &#x2F;path&#x2F;to&#x2F;magisk_patched.img<br>Be aware you are flashing to ramdisk, not boot!<br>EMUI 9 or Higher<br>For EMUI 9+ devices, the ramdisk partition no longer exists. As a workaround, Magisk will be installed to the recovery_ramdisk partition. Please read the Magisk in Recovery section before following the instructions below!</p>
<p>Note: As I tested on my Honor View 10, Huawei’s kernel does not seem to be able to capture key button press events in early boot, so long pressing Volume Up does NOT boot to recovery on my device. Your experience may vary.</p>
<p>If you plan to use custom recoveries, simply follow the instructions for custom recovery and you’re all set.<br>Warning: Magisk will overwrite the custom recovery.<br>If you plan not to use custom recoveries, you will have to extract RECOVERY_RAMDIS.img from your firmware. Follow the instructions for boot image patching above, but use the RECOVERY_RAMDIS.img file instead of a boot image.<br>To flash the patched image to your device, here is the fastboot command:<br>fastboot flash recovery_ramdisk &#x2F;path&#x2F;to&#x2F;magisk_patched.img<br>Be aware you are flashing to recovery_ramdisk, not boot!</p>
<h1 id="Samsung-System-as-root"><a href="#Samsung-System-as-root" class="headerlink" title="Samsung (System-as-root)"></a>Samsung (System-as-root)</h1><p>If your device is NOT launched with Android 9.0 or higher (released after 2019), you are reading the wrong section.</p>
<p>Before Installing Magisk<br>Your device is non-A&#x2F;B and uses system-as-root, so Magisk will be installed to the recovery partition of your device. Please read the Magisk in Recovery section!<br>Installing Magisk WILL trip KNOX<br>Installing Magisk for the first time REQUIRES a full data wipe, backup before continue<br>You have to have your bootloader unlocked before following the instructions<br>Unlocking Bootloader<br>Normally I wouldn’t provide instructions for this, but since things had changed drastically from previous Samsung devices, and there are some caveats, I figure this would be helpful.</p>
<p>Allow bootloader unlocking in Developer options → OEM unlocking<br>Reboot your device to download mode. Either use adb reboot download, or use the key combo for your device.<br>Long press volume up to unlock the bootloader. This will wipe your data and automatically reboot.<br>Just when you think the bootloader is unlocked, it is actually not! Samsung introduced VaultKeeper, meaning the bootloader will reject any unofficial partitions before VaultKeeper explicitly allows it.</p>
<p>Go through the initial setup. Skip through all the steps since data will be wiped again later when we are installing Magisk. Connect the device to internet in the setup!<br>Enable developer options, and confirm that the OEM unlocking option exists and grayed out! The VaultKeeper service will unleash the bootloader after it confirms that the user has the OEM unlocking option enabled.<br>Your bootloader now accepts unofficial images in download mode.<br>Instructions<br>Download the firmware for your device.<br>Unzip the firmware and copy the AP tar file to your device. It is normally named as AP_[device_model_sw_ver].tar.md5<br>Install the latest Magisk Manager<br>In Magisk Manager: Install → Install → Select and Patch a File and select the AP tar file.<br>Magisk Manager will patch the whole firmware file and store the output to [Internal Storage]&#x2F;Download&#x2F;magisk_patched.tar<br>Copy the patched file to your PC with adb pull &#x2F;sdcard&#x2F;Download&#x2F;magisk_patched.tar. Do not use MTP as it is reported to corrupt files.<br>Reboot to download mode, and flash magisk_patched.tar as AP in Odin, together with the BL, CP and HOME_CSC files. Never flash only an AP file, as Odin can shrink your &#x2F;data file-system if you do.<br>Important: Uncheck “Auto Reboot” in Options!<br>Magisk is now successfully flashed to your device! But there are still several steps before you can properly use the device.<br>We now want to boot into the stock recovery to factory reset our device.<br>Full data wipe is mandatory! Do not skip this step.<br>Press Power + Volume Down to exit download mode. As soon as the screen turns off, immediately press the combo key to boot to recovery (e.g. on the S10 it is Power + Bixby + Volume Up). Since we want to boot into stock recovery, continue pressing the volume up button until you see the stock recovery screen.<br>Use volume buttons to navigate through the stock recovery menu, and the power button to select an option. Choose Wipe data&#x2F;factory reset to wipe the data of the device.<br>This time, we can finally boot to the system with Magisk. Select Reboot system now, and immediately press the combo key to recovery. After seeing the bootloader warning screen, release all buttons so it can boot to the system.<br>The device will automatically reboot for the first time it boots. This is completely normal and done by design.<br>After the device is booted up, do the usual initial setup. The following steps will need an internet connection.<br>You shall see Magisk Manager in your app drawer; if not, manually install the APK you downloaded in step 3 and continue to the next step. The app would be a stub and it shall automatically upgrade to the full Magisk Manager when you open it.<br>Magisk Manager will ask to do additional setups. Let it do its job and the app will automatically reboot your device.<br>Voila! Enjoy Magisk :)<br>Additional Info<br>Magisk actually patches 3 partitions on your device:<br>vbmeta: replace with empty vbmeta image to disable partition verification<br>boot: remove the signature of the image to prevent soft bricks<br>recovery: this is where Magisk is actually installed<br>Never, ever try to restore either of the 3 images mentioned back to stock! You can easily brick your device by doing so, and the only way out is to do full Odin restore following with factory reset. Just don’t do it.<br>If you want to upgrade your device, never flash the stock AP tar file with the reasons mentioned above. Always pre-patch the firmware before flashing in Odin.<br>If you don’t need to patch the full firmware, you can manually create a tar file with at least vbmeta.img, boot.img, and recovery.img to let Magisk Manager patch your images in the proper way.</p>
<h1 id="Magisk-Modules"><a href="#Magisk-Modules" class="headerlink" title="Magisk Modules"></a>Magisk Modules</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/15/magisk/" data-id="cl9xpujre002tdmopbwcjhfh5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/" rel="tag">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-排序算法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/05/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" class="article-date">
  <time datetime="2019-12-05T07:26:08.000Z" itemprop="datePublished">2019-12-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/05/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/">排序算法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>算法和数据结构是相互依存的.<br>前端的数据结构主要用数组和对象.js没有指针,无法使用链表.</p>
<h1 id="排序算法"><a href="#排序算法" class="headerlink" title="排序算法"></a>排序算法</h1><h2 id="冒泡排序-体育委员两两对比"><a href="#冒泡排序-体育委员两两对比" class="headerlink" title="冒泡排序(体育委员两两对比)"></a>冒泡排序(体育委员两两对比)</h2><h3 id="时间复杂度：O-n-2"><a href="#时间复杂度：O-n-2" class="headerlink" title="时间复杂度：O(n^2^)"></a>时间复杂度：O(n^2^)</h3><p>需求: 数组a&#x3D;[3,2,4,5,1,6]从小到大排列打印出来.<br>方法: 找出最大的放在最右边,然后排前5个.然后依次把最大的放在最右边.</p>
<h2 id="选择排序-体育老师点人"><a href="#选择排序-体育老师点人" class="headerlink" title="选择排序(体育老师点人)"></a>选择排序(体育老师点人)</h2><h3 id="时间复杂度：O-n-2-1"><a href="#时间复杂度：O-n-2-1" class="headerlink" title="时间复杂度：O(n^2^)"></a>时间复杂度：O(n^2^)</h3><p>方法: 选出最小的一个放在最前面.然后看剩下的.<br>剩下的最小的再放前面.</p>
<h2 id="插入排序-排扑克牌"><a href="#插入排序-排扑克牌" class="headerlink" title="插入排序(排扑克牌)"></a>插入排序(排扑克牌)</h2><h3 id="时间复杂度：O-n-2-2"><a href="#时间复杂度：O-n-2-2" class="headerlink" title="时间复杂度：O(n^2^)"></a>时间复杂度：O(n^2^)</h3><p>声明空数组.取第一张牌,第二个数字和数组中比较,比最后一个大,就放后面,比最后一个小,就往前放.</p>
<h2 id="基数排序-桶排序-整理扑克牌"><a href="#基数排序-桶排序-整理扑克牌" class="headerlink" title="基数排序(桶排序)(整理扑克牌)"></a>基数排序(桶排序)(整理扑克牌)</h2><p>优点：<br>和计数排序不同的是一个桶里可放多个数字，效率高，计数排序的改良版，时间复杂度：O(N+C)<br>缺点：<br>需要hash工具，和计数排序不同的是每个桶里都是无序的，还要再排一次序<br>用途：<br>高考总分排序，每100分放在一个桶里，数字很分散的时候不好用，可用基数排序（比如从几十到几千）<br>有重复的数.类似于4张1,4张2,4张3.拿到1放到最前面,2依次,如果还是1,放在1那一摞.每一种放一摞.最后排序.</p>
<h2 id="快排"><a href="#快排" class="headerlink" title="快排"></a>快排</h2><p>优点：<br>效率高,时间复杂度：O(n*log2n)<br>缺点：<br>有时候比计数排序慢<br>挑选一个数,放中间,比它小的放左边,比它大的放右边.它的位置就固定了.<br>看前面的部分,再挑一个数,比它小的放左边,比它大的放右边.后面的部分,再挑一个数,比它小的放左边,比它大的放右边.又有两个数固定了.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/05/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" data-id="cl9xpujs0004edmopf3343kd8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-HTTP、TCP-IP-协议的原理及应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/03/HTTP%E3%80%81TCP-IP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/" class="article-date">
  <time datetime="2019-12-03T05:18:21.000Z" itemprop="datePublished">2019-12-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/HTML/">HTML</a>►<a class="article-category-link" href="/categories/HTML/HTTP%E5%9F%BA%E7%A1%80/">HTTP基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/03/HTTP%E3%80%81TCP-IP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/">HTTP、TCP/IP协议的原理及应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="访问网页时发生了什么"><a href="#访问网页时发生了什么" class="headerlink" title="访问网页时发生了什么"></a>访问网页时发生了什么</h1><p>当用户在浏览器地址栏输入地址，敲下回车键，直到看到网页界面，一般时间不过两三秒左右。然而在这瞬时间，计算机实际上已经完成了非常复杂的操作。这段过程中发生的事情，其实有很大一部分就与 HTTP TCP&#x2F;IP 有关，我们可以简要的概括一下大概的流程。</p>
<h2 id="第一步，找服务器-IP"><a href="#第一步，找服务器-IP" class="headerlink" title="第一步，找服务器 IP"></a>第一步，找服务器 IP</h2><p>当用户输入一个网址并按下回车键的时候，浏览器得到了一个域名。而在实际通信过程中，浏览器需要的是一个 IP 地址。为了获得 IP 地址，浏览器会做如下操作，一般我们把浏览器通过域名查找对应 IP 的行为叫做 DNS 解析。</p>
<p>1.先找浏览器的本地的缓存<br>2.再找电脑硬盘里的 host 文件，有没有记录这个域名和 IP 的映射关系<br>3.实在没找到，只好通过网络链路去域名供应商那里查询</p>
<h2 id="第二步，建立-TCP-x2F-IP-连接"><a href="#第二步，建立-TCP-x2F-IP-连接" class="headerlink" title="第二步，建立 TCP&#x2F;IP 连接"></a>第二步，建立 TCP&#x2F;IP 连接</h2><p>1.浏览器获取到了服务器对应 IP，就会向对应 IP 的服务器发送 TCP 连接请求。<br>2.服务器收到请求后回应，双方多次确认后建立起 TCP 双向连接。</p>
<blockquote>
<p>从客户端发起连接请求一直到 TCP 连接建立，这个过程，叫做 三次握手。<br>如果请求是 HTTPS 的，还需要在 TCP 连接上，再通过 SSL 或 TLS 提供加密处理数据、验证对方身份以及数据完整性，来保证数据传输的安全。</p>
</blockquote>
<h2 id="第三步，请求资源"><a href="#第三步，请求资源" class="headerlink" title="第三步，请求资源"></a>第三步，请求资源</h2><p>1.TCP 连接创建完成，浏览器开始向服务端发送正式的 HTTP 请求的数据包。<br>2.服务端接受请求，对请求进行解析，经过数据操作后，返回客户端需要的数据包。</p>
<h2 id="第四步，浏览器渲染"><a href="#第四步，浏览器渲染" class="headerlink" title="第四步，浏览器渲染"></a>第四步，浏览器渲染</h2><p>浏览器获取到需要的数据以后，对数据进行拼接、解析、执行，最终将完整的网页绘制在页面上。</p>
<h2 id="第五步，浏览器缓存"><a href="#第五步，浏览器缓存" class="headerlink" title="第五步，浏览器缓存"></a>第五步，浏览器缓存</h2><p>浏览器拿到服务端返回的数据后，会根据一定的策略进行数据的缓存，这样在下一次请求同样数据的时候，就可直接到缓存拿取，不再请求服务器。<br>上述流程可以看作是一个应用在完整网络通信过程中的实践场景，其中带出了很多网络通信的知识点，下面就以这条线为索引，对其中涉及到的知识碎片进行阐述和说明。</p>
<h1 id="经典网络五层模型"><a href="#经典网络五层模型" class="headerlink" title="经典网络五层模型"></a>经典网络五层模型</h1><p><img src="https://s2.ax1x.com/2019/12/03/QKjjtx.md.png" alt="QKjjtx.md.png"><br>在每台计算机设备上，都有这么一套系统链路的关系，来保证网络传输的正常进行，因为统一集成了这么一套经典模型，所以自己使用的计算机也是可以作为一台服务器来提供网络服务的。</p>
<h2 id="应用层："><a href="#应用层：" class="headerlink" title="应用层："></a>应用层：</h2><p>应用层包含了我们所说的 HTTP 协议，为各个应用软件提供了很多服务，常见的应用层服务有：HTTP 服务 、FTP 服务 、Email 服务等。应用层屏蔽了底层模型的相关细节，作为应用支持，只提供给使用者一些必要的使用方式。</p>
<h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><p>常见的传输层协议有 TCP 和 UDP ，传输层作为为应用层的基础，定义了“端到端（end to end）”之间数据间的传输方式，比如：两台设备如何建立连接？设备之间需要以何种规范进行数据传输？需要以什么方式进行数据的分片、重组、拼接？这些都是传输层为我们定义好的。</p>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><p>通常我们常说的 IP 协议就位于这一层。网络层为数据在结点之间传输创建逻辑链路，当我们在浏览器敲下域名，浏览器在网络里如何通过这个域名，找到对应的 IP 映射，这个查询的逻辑关系和链路，是网络层规范和定义的。</p>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><p>数据链路层在通信实体间建立数据链路连接，物理设备连接完成以后，需要相应的软件和驱动来连接和打通这些物理设备，创建电路的连接。</p>
<h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><p>定义物理设备如何传输数据，常见的物理层有网线，光缆，网卡，声卡等，物理层是一切软件的基础。</p>
<h1 id="URI、URL-和-URN"><a href="#URI、URL-和-URN" class="headerlink" title="URI、URL 和 URN"></a>URI、URL 和 URN</h1><p>对于 URL 我们基本比较熟悉，然而对 URI 和 URN 的了解可能比较少，URI、URL 和 URN 是识别、定位和命名互联网上的资源的标准途径。<br>当我们在浏览器地址栏里输入域名的那一刻，其实已经和这三个概念牵扯上了联系。<br><img src="https://s2.ax1x.com/2019/12/03/QKvAAI.md.png" alt="QKvAAI.md.png"></p>
<h2 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h2><p>Uniform Resource Identifier，统一资源标识符，简称为 URI。<br>每个 Web 服务器都有一个 URI 标识符，它在世界范围内唯一标识并定位信息资源，一个资源信息有了 URI 标识以后，在互联网上就能通过一个固定的地址访问到这个资源。<br>它具有两种形式，URN （统一资源名）、URL（统一资源定位符），也就是说 URL 和 URN 是它的子集。</p>
<h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>Uniform Resource Locator，统一资源定位符，简称 URL，下图是一个完整的 URL 组成。<br><img src="https://s2.ax1x.com/2019/12/03/QKvYCV.md.png" alt="QKvYCV.md.png"><br>一个完整的 URL 从左到右包含如下部分：</p>
<ol>
<li>schema 标识了这个资源地址所基于的访问协议，常见的比如：HTTP 和 FTP。</li>
<li>user information 标识了用户信息（如果这个资源需要用户信息认证的话），不过一般现在的认证都不采用这种方式，一来输入非常麻烦，二来不安全。</li>
<li>host 标识了资源的域信息，可以是域名，也可以是 IP ，这块的作用主要是找到资源所存放的物理服务器地址。</li>
<li>port 端口号，一个物理服务器，通过开启不同的端口，就同时可以运行多个 web 服务器，资源文件会部署在某一个 web 服务器的某一个地方，而端口号就是用来定位资源存在的 web 服务器的。</li>
<li>path 路径，或者叫路由，一个 web 服务器下有许多目录，一般 path 就是用来定位到资源文件所存放的目录的。由于现在很多的 web 应用非常庞大，这个路径也不一定就是目录地址，也可能是 web 服务器指定的静态资源文件的请求地址。</li>
<li>query 查询字符串，一般用于 GET 查询，传递查询参数。</li>
<li>fragment 片段，哈希，或者叫锚点，主要用于前端文档的定位，或者是前端渲染时控制路由跳转的手段。</li>
</ol>
<blockquote>
<p>这里需要注意将 URL 与网址区别开来。<br>URL 不仅仅包含了网页的资源地址，还包含了组成网页所需的图片、视频等超文本资源，以及 css js 等资源地址。<br>网址本质上是 IP 地址的一个更有辨别度的映射，在通过 DNS 解析之后，浏览器最先拿到的是 html 文档的 URL 地址，根据浏览器对 Html 文档的解析，继续通过网页内其他资源文件的 URL 获取对应的资源文件。</p>
</blockquote>
<h2 id="URN"><a href="#URN" class="headerlink" title="URN"></a>URN</h2><p>Uniform Resource Name，统一资源名称，简称 URN，它的用处简单说就是永久定位资源，因为同一个资源可能会更换存储位置，存储位置一旦更换，再访问原来的 url 肯定是拿不到的，URN 就是解决这个问题的，不管资源位置怎么移动，只要访问同一个 URN 都能定位到。</p>
<h1 id="TCP-x2F-IP-协议族"><a href="#TCP-x2F-IP-协议族" class="headerlink" title="TCP&#x2F;IP 协议族"></a>TCP&#x2F;IP 协议族</h1><blockquote>
<p>TCP&#x2F;IP 协议（传输控制协议&#x2F;互联网协议）不是简单的一个协议，而是一组特别的协议，包括：TCP，IP，UDP，ARP等，这些被称为子协议。在这些协议中，最重要、最著名的就是 TCP 和 IP。因此我们习惯将整个协议族称为 TCP&#x2F;IP。</p>
</blockquote>
<h2 id="IP-协议"><a href="#IP-协议" class="headerlink" title="IP 协议"></a>IP 协议</h2><p>IP 协议使互联网成为一个允许连接不同类型的计算机和不同操作系统的网络。<br>IP 地址是 IP 协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，相当于这台机器的暂用名，别的机器可以通过这个名字找到它，进而能互相建立起连接进行通信和交流。</p>
<h2 id="TCP-协议"><a href="#TCP-协议" class="headerlink" title="TCP 协议"></a>TCP 协议</h2><p>TCP 协议是面向连接的全双工协议，因此不管是客户端还是服务端都能在 TCP 连接通道下向对端接收和发送数据。<br>TCP 相比于 UDP 的优势在于它的传输稳定性，在数据传输之前必须经过三次握手建立连接；在数据传输过程中必须保证数据有序完整地传到对端。<br>TCP 相比于 UDP 的劣势在于它的复杂度，连接建立、断开都是比较大的性能开销，而且数据传输过程中一旦卡住，则必须等前面的数据发送完毕以后，后续数据才能继续传输。<br>每台服务器可提供支持的 TCP 连接数量是有限的，所以这也使得 TCP 连接变成了稀缺资源，经不起浪费。</p>
<h2 id="UDP-协议"><a href="#UDP-协议" class="headerlink" title="UDP 协议"></a>UDP 协议</h2><p>UDP 协议是面向无连接的，不需要在传输数据前先建立连接，想发就发想传就传。<br>UDP 做的工作只是报文搬运，不负责有序且不丢失地传递到对端，因此容易出现丢包的情况。<br>UDP 不仅支持一对一的传输方式，还支持一对多、多对多、多对一的方式，也就是说 UPD 提供了单播、多播、广播的功能。<br>UDP 相比于 TCP 的优势在于它的轻量、高效和灵活，在一些对于实时性应用要求较高的场景下需要使用到 UDP，比如直播、视频会议、LOL等实时对战游戏。<br>UDP 相比于 TCP 的劣势在于它的不可靠性和不稳定性。</p>
<h1 id="TCP-连接"><a href="#TCP-连接" class="headerlink" title="TCP 连接"></a>TCP 连接</h1><p>在客户端发送正式的 HTTP 请求之前，需要先创建一个 TCP 连接，在创建的 TCP Connect  通道下，所有的 HTTP 请求和响应才能正常的发送和接受。<br>在不同的 HTTP 协议版本里，这个 TCP 连接通道的创建和持续机制也有所不同。</p>
<p>在 HTTP1.0 中，每一次 HTTP 请求都会创建一个 TCP 连接，在请求发送完成，服务器响应以后，这个 TCP 连接就自动断开了。<br>在 HTTP1.1 中，可以通过手动设置 Connection： keep-alive 请求头来建立 TCP 的持久连接，多个 HTTP 请求可以共用一个 TCP 连接。但是 TCP 连接存在线头阻塞，即若干个请求排队等待发送，一旦有某请求超时等，后续请求只能被阻塞。<br>在 HTTP2 中，采用了信道复用，使 TCP 连接支持并发请求，即多个请求可同时在一个连接上并行执行。某个请求任务耗时严重，不会影响到其它连接的正常执行吗，这样一来，大部分请求可以使用一个 TCP 连接，而不用创建新的 TCP 连接通道，既节省了三次握手的开销，又节约了服务端维护 TCP 端口的成本。</p>
<h1 id="TCP-的三次握手和四次挥手"><a href="#TCP-的三次握手和四次挥手" class="headerlink" title="TCP 的三次握手和四次挥手"></a>TCP 的三次握手和四次挥手</h1><h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p><img src="https://s2.ax1x.com/2019/12/03/QKvH8f.md.png" alt="QKvH8f.md.png"></p>
<blockquote>
<p>提示：关于 ACK、FIN、SYN 状态码的含义<br>1.ACK 用于确认，表示通知对方，我已经收到你发来的信息了。<br>2.FIN 用于结束，表示告知对方，我这边已经结束，数据全部发送完毕，没有后续输出，请求终止连接。<br>3.SYN 用于同步和建立连接，表示告知对方，我这边请求同步建立连接。</p>
</blockquote>
<ol>
<li>第一次握手：由客户端向服务端发送连接请求 SYN 报文，该报文段中包含自身的数据通讯初始序号，请求发送后，客户端便进入 SYN-SENT 状态。</li>
<li>第二次握手：服务端收到连接请求报文段后，如果同意连接，则会发送一个包含了 ACK 和 SYN 报文信息的应答，该应答中也会包含自身的数据通讯初始序号（在断开连接的“四次挥手”时，ACK 和 SYN 这两个报文是作为两次应答，独立开来发送的，因此会有四次挥手），服务端发送完成后便进入 SYN-RECEIVED 状态。</li>
<li>第三次握手：当客户端收到连接同意的应答后，还要向服务端发送一个确认报文。客户端发完这个报文段后便进入 ESTABLISHED 状态，服务端收到这个应答后也进入 ESTABLISHED 状态，此时连接建立成功。</li>
</ol>
<blockquote>
<p>面试时可能会问的一个问题就是，明明两次握手就能确定的连接，为什么需要三次握手？<br>因为由于很多不可控制的因素，例如网络原因，可能会造成第一次请求隔了很久才到达服务端，这个时候客户端已经等待响应等了很久，之前发起的请求已超时，已经被客户端废弃掉不再继续守着监听了。<br>然而服务端过了很久，收到了废弃的延迟请求，发起回应的同时又开启了一个新的 TCP 连接端口，在那里呆等客户端。<br>而服务端能维护的 TCP 连接是有限的，这种闲置的无用链接会造成服务端的资源浪费。<br>因此在服务端发送了 SYN 和 ACK 响应后，需要收到客户端接的再次确认，双方连接才能正式建立起来。三次握手就是为了规避这种由于网络延迟而导致服务器额外开销的问题。</p>
</blockquote>
<h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p><img src="https://s2.ax1x.com/2019/12/03/QMkSIg.png" alt="QMkSIg.png"><br>和建立 TCP 连接类似，断开 TCP 连接也同样需要客户端于服务端的双向交流，因为整个断开动作需要双端共发送 4 个数据包才能完成，所以简称为“四次挥手”。</p>
<ol>
<li>第一次挥手：客户端认为自己这边的数据已经全部发送完毕了，于是发送一个 FIN 用来关闭客户端到服务端的数据传输，发送完成以后，客户端进入 FIN_WAIT_1 状态。</li>
<li>第二次挥手：服务端收到客户端发送回来的 FIN 以后，会告诉应用层要释放 TCP 链接，并且发送一个 ACK 给客户端，表明已经收到客户端的释放请求了，不会再接受客户端发来的数据，自此，服务端进入 CLOSE_WAIT 的状态。</li>
<li>第三次挥手：服务端如果此时还有未发送完的数据可以继续发送，发送完毕后，服务端也会发送一个释放连接的 FIN 请求用来关闭服务端到客户端的数据传送，然后服务端进入 LAST_ACK 状态。</li>
<li>第四次挥手：客户端接收到服务端的 FIN 请求后，发送最后一个 ACK 给服务端，接着进入 TIME_WAIT_2 状态，该状态会持续 2MSL（最大段生存期，指报文段在网络中生存的时间，超时会被抛弃） 时间，若该时间段内没有服务端的重发请求的话，客户端就进入 CLOSED 状态.服务端在收到应答消息后，也会进入 CLOSED 状态，至此完成四次挥手的过程，双方正式断开连接。</li>
</ol>
<p>上面的内容可能还是有些不够直观，所以我还准备了一段人话来描述整个过程：</p>
<ol>
<li>客户端：喂，我好了。</li>
<li>服务端：噢，你好了是吧，我知道了，我还没好，你等一哈。</li>
<li>服务端：OK，现在我也好了。</li>
<li>客户端：收到，这次玩的很开心，我们下次再约。</li>
</ol>
<blockquote>
<p>可能有些面试中会问，为什么建立连接有三次握手，而断开连接却有四次？<br>这是因为在建立连接过程中，服务端在收到客户但建立连接请求的 SYN 报文后，会把 ACK 和 SYN 放在一个报文里发送给客户端。<br>而关闭连接时，服务端收到客户端的 FIN 报文，只是表示客户端不再发送数据了，但是还能接收数据，而且这会儿服务端可能还有数据没有发送完，不能马上发送 FIN 报文，只能先发送 ACK 报文，先响应客户端，在确认自己这边所有数据发送完毕以后，才会发送 FIN。<br>所以，在断开连接时，服务器的 ACK 和 FIN 一般都会单独发送，这就导致了断开连接比请求连接多了一次发送操作。</p>
</blockquote>
<h1 id="HTTP-定义"><a href="#HTTP-定义" class="headerlink" title="HTTP 定义"></a>HTTP 定义</h1><p>一旦端对端成功建立起了 TCP 连接，下一步就要开始发送正式的 HTTP 请求了。流淌在 TCP Connect 通道里的 HTTP 只负责传输数据包，并没有连接的概念，因此 HTTP 也被叫做“无状态协议”。</p>
<blockquote>
<p>HTTP 协议是 Hyper Text Transfer Protocol（超文本传输协议）的缩写，它通常运行在 TCP 之上，通过浏览器和服务器进行数据交互，进行超文本（文本、图片、视频等）传输的规定。也就是说，HTTP 协议规定了超文本传输所要遵守的规则。</p>
</blockquote>
<ol>
<li>HTTP 协议是无状态的。这意味着客户端和服务端之间无法知晓当前对方的状态信息，HTTP 请求本身是不带有任何状态存储的。但实际情况下，客户端和服务端必然需要状态的认证和交互，所以就引入了 Cookie， 用于存储当前浏览器的一些状态信息，每次通过独立的 HTTP 请求进行收发，从而解决这个问题。</li>
<li>HTTP 请求互相独立。HTTP 互相之间都是一个独立的个体请求，在客户端请求网页时多数情况下并不是一次请求就能成功的，服务端首先是响应 HTML 页面，然后浏览器收到响应之后发现页面还引用了其他的资源，例如，CSS，JS文件，图片等等，还会自动发送 HTTP 请求获取这些需要的资源。</li>
<li>HTTP 协议基于 TCP 协议。HTTP 协议目的是规定客户端和服务端数据传输的格式和数据交互行为，并不负责数据传输的细节，底层是基于 TCP 实现的。现在使用的版本当中是默认持久连接的，也就是多次 HTTP 请求使用一个 TCP 连接。</li>
</ol>
<blockquote>
<p>注意：HTTP 请求和 TCP 连接是不一样的，HTTP 是在 TCP 连接建立的基础上而发起的传输请求，在同一个 TCP 连接通道下，可以发送多个 HTTP 请求，举个例子的话就是高速公路和车子的关系。</p>
</blockquote>
<h1 id="HTTP-发展历史"><a href="#HTTP-发展历史" class="headerlink" title="HTTP 发展历史"></a>HTTP 发展历史</h1><h2 id="HTTP-0-9-版本"><a href="#HTTP-0-9-版本" class="headerlink" title="HTTP 0.9 版本"></a>HTTP 0.9 版本</h2><p>只有一个 GET 命令。<br>没有请求头和响应头来描述传输相关的数据信息。<br>服务器发送完数据后，直接关闭 TCP 连接，不支持 TCP 持久化连接。</p>
<h2 id="HTTP-1-0-版本"><a href="#HTTP-1-0-版本" class="headerlink" title="HTTP 1.0 版本"></a>HTTP 1.0 版本</h2><p>增加了很多命令，HEAD、POST、PUT、DELETE 等。<br>增设了 status code 状态码和 header 请求头和响应头。<br>增加了多字符集支持、多部分发送、权限、缓存等。<br>可通过开启 Connection： keep-alive 来指定使用 TCP 长连接</p>
<h2 id="HTTP-1-1-（目前普遍使用）"><a href="#HTTP-1-1-（目前普遍使用）" class="headerlink" title="HTTP 1.1 （目前普遍使用）"></a>HTTP 1.1 （目前普遍使用）</h2><p>默认支持持久连接<br>默认支持长连接（PersistentConnection），即默认开启 Connection： keep-alive。<br>支持请求的流水线（Pipelining）处理，即在一个 TCP 连接上可以传送多个 HTTP 请求和响应。<br>增加了 host 请求头字段，通过对 host 解析，就能够允许在同一台物理服务器上运行多个软件服务，极大提高了服务器的使用率。目前的 nginx 反向代理就是根据 HTTP 请求头中的 host 来分辨不同的请求，从而将这些请求代理到同一台服务器不同的软件服务上。</p>
<h2 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP 2.0"></a>HTTP 2.0</h2><p>HTTP1.x 的解析是基于文本，存在解析上的缺陷；而 HTTP2.0 直接使用二进制的解析方式来替代 HTTP 1.X 的字符串解析，更为高效和健壮。<br>HTTP2.0 所有数据以“帧”的方式进行传输，因此同一个连接中发送的多个请求不再需要按照顺序进行返回处理，可以达到并行的数据传输。<br>HTTP2.0 压缩头信息进行传输数据量的优化。HTTP1.x 的请求头带有大量信息，而且每次都要重复发送，HTTP2.0 使用 encoder 来减少需要传输的请求头大小，通讯双方各自缓存一份 header fields 表，既避免了重复的传输，又减小了传输信息的大小。<br>HTTP2.0 新增了 server push（服务端推送） 的概念，服务端可以主动发起一些数据推送。比如，服务端在接收到浏览器发来的 HTML 请求的同时，可以主动推送相关的资源文件（js&#x2F;css）给客户端，并行发送，提高网页的传输和渲染效率。<br>目前如果要使用 HTTP2 需要首先使用 HTTPS 在这基础上，才能使用 HTTP2</p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>我们经常会在有些网页上看到悬浮的弹窗或者广告，有的时候甚至会在自己编写的上线网页上也看到这些垃圾广告，然而开发者明明没有写过这些东西，可是这种垃圾信息是怎么上去的呢？<br>究其根本原因就在于各种代理服务，当我们从客户端发起一个 HTTP 请求，并不是直接就能传递到目标服务器的，期间会经过层层的代理服务，我们常用的 nginx ，以及在 DNS 解析过程中要经过的宽带运营商，都是一种代理服务。<br>由于 HTTP 时使用明文字符串来传递数据的，那么这些数据就能很轻易地被中间服务读取甚至篡改，那么中间服务拿到了原始的 HTML 数据，想插入点小广告进去自然不是难事。<br>HTTPS 是为了解决 HTTP 明文传输而出现的安全问题而出现的一种解决机制 ———— 对 HTTP 请求中的信息进行加密之后传输，从而有效地防止了中间代理服务截获或篡改信息的问题。<br>HTTPS 其实就是一个安全加强版的 HTTP 1.1 ，有几点需要注意的是：</p>
<ol>
<li>HTTPS 协议需要到 CA 申请证书，一般免费证书很少，需要交费</li>
<li>HTTP 协议运行在 TCP 之上，所有传输的内容都是明文，HTTPS 运行在 SSL&#x2F;TLS 之上，SSL&#x2F;TLS 运行在 TCP 之上，所有传输的内容都经过加密的。</li>
<li>HTTP 和 HTTPS 使用的是完全不同的连接方式，用的端口也不一样，前者是 80，后者是 443。</li>
<li>HTTPS 可以有效的防止运营商劫持，解决了防劫持的一个大问题。</li>
</ol>
<h1 id="HTTP-的报文组成"><a href="#HTTP-的报文组成" class="headerlink" title="HTTP 的报文组成"></a>HTTP 的报文组成</h1><p>HTTP 是以请求和响应的形式存在的，由于发起方主动发起一个 HTTP 请求，然后由响应方回应，双方按照一定的报文格式进行数据的互传，一个完整的 HTTP 报文通常由 首行、首部 和 主体 构成。</p>
<h2 id="首行"><a href="#首行" class="headerlink" title="首行"></a>首行</h2><p>首行并不属于 Http Headers ，它包含了：</p>
<ol>
<li>HTTP Method（GET、POST、PUT、DELETE 等 ），不同的 HTTP Method 有不同的语意。</li>
</ol>
<table>
<thead>
<tr>
<th>HTTP Method</th>
<th>对应予以</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>一般用于获取服务器资源</td>
</tr>
<tr>
<td>POST</td>
<td>一般用于传输实体主体</td>
</tr>
<tr>
<td>PUT</td>
<td>一般用于传输文件</td>
</tr>
<tr>
<td>DELETE</td>
<td>用于删除文件</td>
</tr>
<tr>
<td>HEAD</td>
<td>用于获取报文首部，不返回报文主体</td>
</tr>
<tr>
<td>OPTIONS</td>
<td>用于预检请求中，询问请求URI资源支持的方法</td>
</tr>
</tbody></table>
<blockquote>
<p>HTTP Method 只是 HTTP 协议推崇的一种规范，就像 ESLint，你可以选择遵循，也可以选择不遵循，它们所作的事情实质上没有差别，只是语义化更明确。</p>
</blockquote>
<ol start="2">
<li><p>URL请求资源的地址，这个地址只会包含请求的路由地址。</p>
</li>
<li><p>协议的版本，HTTP 1.0 &#x2F; HTTP 1.1 &#x2F; HTTP 2。</p>
</li>
<li><p>HTTP 返回状态码（响应报文首行包含）</p>
<blockquote>
<p>HTTP 定义了40个标准状态代码，可用于传递客户端请求的结果，状态代码分为以下五类，关于各个分段下的返回状态码信息可以参考 HTTP 响应码：</p>
</blockquote>
</li>
</ol>
<blockquote>
<p>这边需要注意的一点是，一个好的 HTTP 应用服务应该是有完善的 HTTP status code 的返回信息的，即访问者单从 HTTP status &gt; code 上就能得知当前 HTTP 请求的状态信息。<br>而目前我们大部分的开发模式下的 HTTP 返回码，只有 200 和 500。服务端的同学会先把 200 返回过来，然后再告诉你出了什么 “没登录” &#x2F; “没认证” &#x2F; “没权限” 这一类的问题。<br>业界也有一句戏言：又不是不能用，其实这种开发方式是不正确的，不管从代码的维护性还是个人自身发展角度，我们都需要&gt; 尽量避免这种问题。</p>
</blockquote>
<h2 id="HTTP-头信息"><a href="#HTTP-头信息" class="headerlink" title="HTTP 头信息"></a>HTTP 头信息</h2><p>HTTP 头信息，即 HTTP Header，首行换行后的信息都是 HTTP Header。HTTP header 里一般存放了客户端和服务端之间交互的非业务信息，例如：本次请求的数据类型、请求日期、字符集支持、自定义头部字段、一些通信凭证和缓存支持等。<br>HTTP Header 完整字段列表：传送门</p>
<h2 id="主体"><a href="#主体" class="headerlink" title="主体"></a>主体</h2><p>主体，即 HTTP body，HTTP Header 信息和主体信息间以一个空行 + 一个换行来区分。HTTP body 里一般会放置请求的一些具体业务信息</p>
<h1 id="HTTP-数据协商"><a href="#HTTP-数据协商" class="headerlink" title="HTTP 数据协商"></a>HTTP 数据协商</h1><p>在 HTTP 协议中，数据协商是这样一种机制，客户端通过请求头告知服务端本次请求希望获取的数据格式、展现形式、以及数据的压缩方式等。常见的数据协商例如，文档使用的自然语言，图片的格式，或者内容编码形式。<br>服务端可以对请求头中携带的数据协商字段进行解析，然后在返回客户端数据的时候，也会用相对字段来通知客户端：本次返回的数据格式、压缩方式等信息。这样浏览器就可以使用特定的解析方式，来对这些资源进行解析、处理和渲染。<br>下面简单列举一些常用的数据协商字段，完整的数据协商信息传送门</p>
<ul>
<li>Accept 请求头字段，指定期望获得的数据类型</li>
<li>Accept-Encoding 请求头字段，指定期望获得的数据需要以什么样的编码方式进行传输，常用于限制服务端对数据的压缩方式，常见的 JS 文件包大小优化的 GZIP 压缩，就使用了这个方法</li>
<li>Accept-Language 请求头字段，指定期望获得的数据语言类型：中文、英语、还是其他语言，这个头信息字段，一般是浏览器自动加上的</li>
<li>User-Agent 请求头字段，指定本次请求的浏览器信息，服务端可根据此信息选择不同兼容性的页面返回给用户，或者是做用户使用浏览器信息、操作系统等数据的统计</li>
<li>Content-Type 响应头字段，请求头里的 Accept 字段可能会指定好几种可以接受的数据格式，服务端最终会返回一种数据格式给客户端</li>
<li>Content-Encoding 响应头字段，对应 Accept-Encoding</li>
<li>Content-Language 响应头字段，对应 Accept-Language</li>
</ul>
<h1 id="HTTP-长连接"><a href="#HTTP-长连接" class="headerlink" title="HTTP 长连接"></a>HTTP 长连接</h1><p>每一个 HTTP 请求都需要在 TCP 连接通道里才能完成发送和接受。在 HTTP 协议的早期版本里，每一条 HTTP 请求发送之前，都会创建一条新的 TCP 连接通道，在这个请求完成以后，该条 TCP 通道就会自动关闭。<br>这样带来的问题就是，单条 TCP 连接没有办法复用，造成很大的新能浪费。好在这一问题随着 HTTP 协议的逐步完善已经得到解决。<br>在 HTTP 1.0 中引入的 Connection 头字段，允许对其设置 Keep-Alive 或者是 Close 来决定是否需要复用 TCP 连接，还是说在一次请求完成之后直接关闭。而在 HTTP 1.1 中默认双端都会默认开启这个字段，即默认支持 HTTP 的长连接。</p>
<blockquote>
<p>需要注意的是：Connection: Keep-Alive 需要双端同时开启才能启动 HTTP 长连接，如果任何一段手动设置 Connection 为 Close，长连接都无法位置，因为 TCP 连接的建立和持久保持是一个双端交互的过程。</p>
</blockquote>
<p>那么我们在本地如何看到 TCP 的连接 ID 呢，可以打开 Chrome 的调试工具来查看：<br><img src="https://s2.ax1x.com/2019/12/05/Q8eLHH.png" alt="Q8eLHH.png"></p>
<p>图上可以看到有不同的 Connection ID，这就代表着本次请求实际上是开启了一个新的 TCP 连接，最下面的请求的 Connection ID 都是相同的，代表着多个 HTTP 请求复用了同一个 TCP 连接。</p>
<blockquote>
<p>Chrome 浏览器所能够支持的最大并发 TCP 连接数是 6个，并且在 HTTP 2.0 以下的 HTTP 版本中，请求是阻塞的。也就是说，一旦六个连接开满，前面的请求未完成，那么后续请求就会被阻塞，直到前面的请求返回，后续才能继续发送。</p>
</blockquote>
<h1 id="HTTP-缓存"><a href="#HTTP-缓存" class="headerlink" title="HTTP 缓存"></a>HTTP 缓存</h1><blockquote>
<p>虽然 HTTP 缓存不是必须的，但重用缓存的资源通常是必要的。然而常见的 HTTP 缓存只能存储 GET 响应，对于其他类型的响应则无能为力。缓存的关键主要包括 request method 和目标 URI（一般只有 GET 请求才会被缓存）。</p>
</blockquote>
<h2 id="缓存读取策略"><a href="#缓存读取策略" class="headerlink" title="缓存读取策略"></a>缓存读取策略</h2><p>前端环境下的文件缓存，分为几个不同的位置。当我们打开 Chrome 控制台，查看 Network 下每条请求记录的 size 选项，会发现非常丰富的来源信息。<br><img src="https://s2.ax1x.com/2019/12/05/Q8mhqg.png" alt="Q8mhqg.png"><br>对于前端浏览器环境来说，缓存读取位置是由先后顺序的，顺序分别是（由上到下寻找，找到即返回；找不到则继续）</p>
<ul>
<li>Service Worker</li>
<li>Memory Cache</li>
<li>Disk Cache</li>
<li>网络请求</li>
</ul>
<h2 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h2><blockquote>
<p>Service Worker 的缓存与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存哪些文件、如何匹配缓存、如何读取缓存，并且缓存是持续性的。</p>
</blockquote>
<p>浏览器优先查找。<br>持久存储。<br>可以更加灵活地控制存储的内容，可以选择缓存哪些文件、定义缓存文件的路由匹配规则等。<br>可以从 Chrome 的 F12 中，Application -&gt; Cache Storage 查看。</p>
<h2 id="Memory-Cache"><a href="#Memory-Cache" class="headerlink" title="Memory Cache"></a>Memory Cache</h2><p>memory cache 是内存中的缓存存储。<br>读取速度快。<br>存储空间较小。<br>存储时间短，当浏览器的 tab 页被关闭，内存资源即被释放。<br>如果明确指定了 Cache-Control 为 no-store，浏览器则不会使用 memory-cache。</p>
<h2 id="Disk-Cache"><a href="#Disk-Cache" class="headerlink" title="Disk Cache"></a>Disk Cache</h2><p>Disk Cache 是硬盘中的缓存存储。<br>读取速度慢于 Memory Cache ，快于网络请求。<br>存储空间较大。<br>持久存储。<br>Disk Cache 严格依照 HTTP 头信息中的字段来判断资源是否可缓存、是否要认证等。<br>经常听到的“强制缓存”，“对比缓存”，以及 Cache-Control 等，归于此类。</p>
<h2 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h2><p>如果一个请求的资源文件均未命中上述缓存策略，那么就会发起网络请求。浏览器拿到资源后，会把这个新资源加入缓存。</p>
<h1 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h1><blockquote>
<p>HTTP&#x2F;1.1定义的 Cache-Control 头用来区分对缓存机制的支持情况， 请求头和响应头都支持这个属性。通过它提供的不同的值来定义缓存策略。需要注意的是，数据变化频率很快的场景并不适合开启 Cache-Control。</p>
</blockquote>
<table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>public</td>
<td>公共缓存：表示该响应可以被任何中间人（比如中间代理、CDN等）缓存。</td>
</tr>
<tr>
<td>private</td>
<td>私有缓存：表示该响应是专用于某单个用户的，中间人不能缓存此响应，该响应只能应用于浏览器私有缓存中。</td>
</tr>
<tr>
<td>max-age</td>
<td>（单位&#x2F;秒）设置缓存的过期时间，过期需要重新请求，否则就读取本地缓存，并不实际发送请求</td>
</tr>
<tr>
<td>s-maxage</td>
<td>（单位&#x2F;秒）覆盖 max-age，作用一样，只在代理服务器中生效</td>
</tr>
<tr>
<td>max-stale</td>
<td>（单位&#x2F;秒）表示即使缓存过期，也使用这个过期缓存</td>
</tr>
<tr>
<td>no-store</td>
<td>禁止进行缓存</td>
</tr>
<tr>
<td>no-transform</td>
<td>不得对资源进行转换或压缩等操作，Content-Encoding、Content-Range、Content-Type 等 HTTP 头不能由代理修改（有时候资源比较大的情况下，代理服务器可能会自行做压缩处理，这个指令就是为了防止这种情况）。</td>
</tr>
<tr>
<td>no-cache</td>
<td>强制确认缓存：即每次使用本地缓存之前，需要请求服务器，查看缓存是否失效，若未过期（注：实际就是返回304），则缓存才使用本地缓存副本。</td>
</tr>
<tr>
<td>must-revalidate</td>
<td>缓存验证确认：意味着缓存在考虑使用一个陈旧的资源时，必须先验证它的状态，已过期的缓存将不被使用</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>与 must-revalidate 作用相同，但它仅适用于共享缓存（例如代理），并被私有缓存忽略。</td>
</tr>
</tbody></table>
<p><img src="https://s2.ax1x.com/2019/12/05/Q8uaHe.png" alt="Q8uaHe.png"></p>
<h1 id="缓存校验"><a href="#缓存校验" class="headerlink" title="缓存校验"></a>缓存校验</h1><blockquote>
<p>在浏览器使用缓存的过程中，为了配合 Cache-Control 中 no-cache ，我们还需要一个机制来验证缓存是否有效。比如服务器的资源更新了，客户端需要及时刷新缓存；又或者客户端的资源过了有效期，但服务器上的资源还是旧的，此时并不需要重新发送。<br>缓存校验就是用来解决这些问题的，在http 1.1 中，我们主要关注下 Last-Modified 和 ETag 这两个字段。</p>
</blockquote>
<h2 id="Last-Modified"><a href="#Last-Modified" class="headerlink" title="Last-Modified"></a>Last-Modified</h2><p>顾名思义，就是资源的最新一次修改时间。当客户端访问服务端的资源，服务端会将这个 Last-Modified 值返回给客户端，客户端收到之后，下次发送请求就会将服务端返回回来的 Last-Modified 值装在 If-Modified-Since 或者 If-Unmodified-Since 里，发送给服务端进行缓存校验。<br>这样服务器就可以通过读取 If-Modified-Since （较常用）或 If-UnModified-Since 的值，和本地的 Last-Modified 值做对比校验。如果校验发现这两个值是一样的，就代表本次请求的资源文件没有被修改过，那么服务器就会告诉浏览器，资源有效，可以继续使用，否则就需要使用最新的资源。<br>来看一下下面的两张图：<br>当请求服务端的 script.js 的脚本资源时，可以看到服务端返回了 Last-Modified，里面记录了该资源最后一次的修改时间</p>
<p>当客户端下次再次发起请求，会携带上这个过期时间给服务端进行验证</p>
<p>来看下服务端的部分代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line">http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> ifModifiedSince = request.<span class="property">headers</span>[<span class="string">&#x27;If-Modified-Since&#x27;</span>];</span><br><span class="line">   <span class="keyword">const</span> lastModified = <span class="string">&#x27;Web Aug 19 2019 19:01:15 GMT+0800 (China Standard Time)&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">   <span class="keyword">if</span> (request.<span class="property">url</span> === <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> html = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;test.html&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">       </span><br><span class="line">       response.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">           <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span></span><br><span class="line">       &#125;);</span><br><span class="line">       response.<span class="title function_">end</span>(html);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (request.<span class="property">url</span> === <span class="string">&#x27;/script.js&#x27;</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> js = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;script.js&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>);</span><br><span class="line">       <span class="keyword">let</span> status = <span class="number">200</span>;</span><br><span class="line">       <span class="comment">// 如果读取到的 If-Modified-Since 和 lastModified 相同，则设置头部 304 表示可使用缓存</span></span><br><span class="line">       <span class="keyword">if</span> (ifModifiedSince === lastModified) &#123;</span><br><span class="line">           status = <span class="number">304</span>;</span><br><span class="line">           response.<span class="title function_">end</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       response.<span class="title function_">writeHead</span>(status, &#123;</span><br><span class="line">           <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/javascript&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;no-cache,max-age=2000&#x27;</span>,</span><br><span class="line">           <span class="string">&#x27;Last-Modified&#x27;</span>: lastModified</span><br><span class="line">       &#125;);</span><br><span class="line">       response.<span class="title function_">end</span>(js);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h1 id="ETag"><a href="#ETag" class="headerlink" title="ETag"></a>ETag</h1><p>Etag 的作用本质上和 Last-Modified 差别不大。相比于 Last-Modified 使用最后修改日期来比较资源是否失效的缓存校验策略，ETag 则是通过数据签名来做一个更加严格的缓存验证。<br>所谓数据签名，其实就是通过对资源内容进行一个唯一的签名标记，一旦资源内容改变，那么签名必将改变，服务端就以此签名作为暗号，来标记缓存的有效性。典型的做法是针对资源内容进行一个 hash 计算，类似于 webpack 打包线上资源所加的 hash 标识<br>和 Last-Modified 对应 If-Modified-Since 相同，ETag 也会对应 If-Match 或者 If-None-Match（If-None-Match 比较常用），如果前后的签名相同，则不需要返回新的资源内容。</p>
<h2 id="缓存校验的合理使用"><a href="#缓存校验的合理使用" class="headerlink" title="缓存校验的合理使用"></a>缓存校验的合理使用</h2><blockquote>
<p>Last-Modified 和 ETag 只是给服务端提供了一个控制缓存有效期的手段，并没有任何强制缓存的作用，最终决定是否使用缓存、还是使用新的资源文件，还是需要靠服务端指定对应的 http code 来决定。<br>对于保存在服务器上的文件，都有最后修改日期的属性，当使用 Last-Modified 可以利用这个有效的属性进行数据缓存验证；或者在数据库存入一个 updatetime 字段来标识具体的修改日期，从而判断缓存是否有效。<br>具体如何构建一个能够合理使用缓存的服务器，就比较涉及后端知识了，这里不做具体描述。</p>
</blockquote>
<h1 id="浏览器的同源策略"><a href="#浏览器的同源策略" class="headerlink" title="浏览器的同源策略"></a>浏览器的同源策略</h1><blockquote>
<p>浏览器的同源限制：当浏览器访问 URL 地址的协议（schema）&#x2F; 端口（port）&#x2F; 域名（host），三者中有任何一个与当前的 URL 片段信息不匹配的时候，便存在跨域问题。</p>
</blockquote>
<p>对于跨域的几点需要明确：</p>
<ol>
<li>跨域，是浏览器提供的一种保护手段，服务端是不存在跨域这一说的。这也就是为什么现在前后端分离的开发模式下，前端比较依赖 webpack-dev-server 启动代理服务来中转和代理后台接口的原因，因为两个服务器之间相互通信是没有跨域障碍的。</li>
<li>跨域，是对于 XMLHttpRequest 来说的，浏览器获取不同源服务器下的静态资源，是没有跨域限制的，这也是 JSONP 跨域请求得以实现的本质。</li>
<li>不同于 XMLHttpRequest 的是，通过 src 属性加载的脚本资源，浏览器限制了 Javascript 的权限，使其不能读写、返回内容。</li>
<li>对于浏览器来说，除了 DOM 、Cookie、XMLHttpRequest 会收到同源策略限制以外，一些常见的插件，比如 Flash、Java Applet 、Silverlight、Google Gears 等也都有自己的控制策略。</li>
</ol>
<blockquote>
<p>当浏览器向不同域的服务器发送请求时，请求是真能发出去，对方服务端也是真能接收到请求，并且真能给你的浏览器响应，浏览器也真能接收到有效数据。<br>但是，如果在跨域的情况下、服务端返回数据的响应头里的 Access-Control-Allow-Origin 字段，没有把当前域名列进白名单，那么浏览器会把服务端返回的数据给藏起来，不告诉你，然后给你抛个 Access-Control-Allow-Origin 的错误。</p>
</blockquote>
<blockquote>
<p>至于为什么资源文件不受同源策略限制呢？可以试想一下，如果资源文件也被限制跨域，那么现在大量使用的 CDN 缓存策略基本就没办法用了。而且现在很多网站的资源文件，都会放到云服务器的 OSS 上，OSS 资源对应的 url 地址肯定是不同域的，那这些资源也不能使用了。</p>
</blockquote>
<h1 id="Access-Control-Allow-Origin"><a href="#Access-Control-Allow-Origin" class="headerlink" title="Access-Control-Allow-Origin"></a>Access-Control-Allow-Origin</h1><p>Access-Control-Allow-Origin 标识了服务器允许的跨域白名单，它有以下几种设置方法：</p>
<ol>
<li>直接设置 * 通配符，简单粗暴，但是这么做等于把服务器的所有接口资源对外完全暴露，是不安全的。</li>
<li>设置制定域，比如 Access-Control-Allow-Origin: <a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a> ，这样只会允许指定域的请求进行跨域访问。</li>
<li>由后端动态设置。Access-Control-Allow-Origin 限制只能写一个白名单，但是当我们有多个域都需要跨域请求怎么呢？这个时候，这时可以由服务端自己维护一套白名单列表，在请求进来的时候对请求的源 host 进行白名单比对，如果在白名单中，就将这个 Access-Control-Allow-Origin 动态设置上去，然后返回响应。</li>
</ol>
<h2 id="CORS-的预请求"><a href="#CORS-的预请求" class="headerlink" title="CORS 的预请求"></a>CORS 的预请求</h2><p>如果我们像上面一样，只设置的 Access-Control-Allow-Origin 白名单，是否就可以完全畅通无阻地进行跨域了呢？并不是。<br>就算对端开启了域名白名单认证，然鹅有一些操作仍然是需要进一步认证的，这种进一步的认证操作，就是 CORS 预请求。</p>
<h2 id="预请求触发过程"><a href="#预请求触发过程" class="headerlink" title="预请求触发过程"></a>预请求触发过程</h2><p>浏览器预请求的触发条件，是判断本次请求是否属于一个简单请求。<br>如果本次请求属于一个复杂请求，那么在发送正式的跨域请求之前，浏览器会先准备一个名为 OPTIONS 的 HTTP Method ，作为预请求发送。<br>在服务器通过预请求后，下面浏览器才会发生正式的数据请求。整个请求过程其实是发生了两次请求：一个预检请求，以及后续的实际数据请求。</p>
<h2 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h2><ol>
<li>请求方式只能是 GET POST HEAD</li>
<li>请求头字段只允许：</li>
</ol>
<p>Accept<br>Accept-Language<br>Content-Language<br>Content-Type</p>
<ol start="3">
<li>Content-Type 的值仅限于：</li>
</ol>
<p>text&#x2F;plain<br>multipart&#x2F;form-data<br>application&#x2F;x-www-form-urlencoded</p>
<ol start="4">
<li>XMLHttpRequestUpload 对象均没有注册任何事件监听器（了解就好）。</li>
<li>请求中没有使用 ReadableStream 对象（了解就好）。</li>
</ol>
<h2 id="复杂请求"><a href="#复杂请求" class="headerlink" title="复杂请求"></a>复杂请求</h2><p>除了简单请求里定义的，都是复杂请求，统统需要预请求。</p>
<h2 id="预请求的验证"><a href="#预请求的验证" class="headerlink" title="预请求的验证"></a>预请求的验证</h2><p>那么怎样使预检请求成功认证呢？还是需要服务端继续帮忙设置请求头的白名单：</p>
<ol>
<li>ccess-Control-Allow-Headers，设置允许的额外请求头字段。</li>
<li>Access-Control-Allow-Methods，设置允许的额外请求方法。</li>
<li>Access-Control-Max-Age （单位&#x2F;秒），指定了预请求的结果能够被缓存多久，在这个时间范围内，再次发送跨域请求不会被预检。</li>
</ol>
<h1 id="HTTP-性能优化方案"><a href="#HTTP-性能优化方案" class="headerlink" title="HTTP 性能优化方案"></a>HTTP 性能优化方案</h1><p>合理使用 HTTP 的缓存策略，避免同一资源多次请求服务端而导致的额外性能开销<br>尽量使用 HTTP 长连接，避免每次重建 TCP 连接带来的时间损耗<br>尽量使用 HTTPS 来保证网络传输的安全性。<br>可以使用 HTTP2 来大幅提高数据传输的效率，使用 server push 开启 HTTP2 的服务端推送功能<br>客户端开启 Accept-Encoding 压缩方式的支持，服务端传输压缩后的文件，减少传输数据的大小</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/03/HTTP%E3%80%81TCP-IP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/" data-id="cl9xpujqb000hdmop5to73syd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-yuque/HTTP、TCP-IP-协议的原理及应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/03/yuque/HTTP%E3%80%81TCP-IP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/" class="article-date">
  <time datetime="2019-12-03T05:18:21.000Z" itemprop="datePublished">2019-12-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/HTML/">HTML</a>►<a class="article-category-link" href="/categories/HTML/HTTP%E5%9F%BA%E7%A1%80/">HTTP基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/03/yuque/HTTP%E3%80%81TCP-IP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/">HTTP、TCP/IP协议的原理及应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="访问网页时发生了什么"><a href="#访问网页时发生了什么" class="headerlink" title="访问网页时发生了什么"></a>访问网页时发生了什么</h1><p>当用户在浏览器地址栏输入地址，敲下回车键，直到看到网页界面，一般时间不过两三秒左右。然而在这瞬时间，计算机实际上已经完成了非常复杂的操作。这段过程中发生的事情，其实有很大一部分就与 HTTP TCP&#x2F;IP 有关，我们可以简要的概括一下大概的流程。</p>
<h2 id="第一步，找服务器-IP"><a href="#第一步，找服务器-IP" class="headerlink" title="第一步，找服务器 IP"></a>第一步，找服务器 IP</h2><p>当用户输入一个网址并按下回车键的时候，浏览器得到了一个域名。而在实际通信过程中，浏览器需要的是一个 IP 地址。为了获得 IP 地址，浏览器会做如下操作，一般我们把浏览器通过域名查找对应 IP 的行为叫做 DNS 解析。</p>
<p>1.先找浏览器的本地的缓存</p>
<p>2.再找电脑硬盘里的 host 文件，有没有记录这个域名和 IP 的映射关系</p>
<p>3.实在没找到，只好通过网络链路去域名供应商那里查询</p>
<h2 id="第二步，建立-TCP-x2F-IP-连接"><a href="#第二步，建立-TCP-x2F-IP-连接" class="headerlink" title="第二步，建立 TCP&#x2F;IP 连接"></a>第二步，建立 TCP&#x2F;IP 连接</h2><p>1.浏览器获取到了服务器对应 IP，就会向对应 IP 的服务器发送 TCP 连接请求。</p>
<p>2.服务器收到请求后回应，双方多次确认后建立起 TCP 双向连接。</p>
<blockquote>
<p>从客户端发起连接请求一直到 TCP 连接建立，这个过程，叫做 三次握手。</p>
</blockquote>
<p>如果请求是 HTTPS 的，还需要在 TCP 连接上，再通过 SSL 或 TLS 提供加密处理数据、验证对方身份以及数据完整性，来保证数据传输的安全。</p>
<h2 id="第三步，请求资源"><a href="#第三步，请求资源" class="headerlink" title="第三步，请求资源"></a>第三步，请求资源</h2><p>1.TCP 连接创建完成，浏览器开始向服务端发送正式的 HTTP 请求的数据包。</p>
<p>2.服务端接受请求，对请求进行解析，经过数据操作后，返回客户端需要的数据包。</p>
<h2 id="第四步，浏览器渲染"><a href="#第四步，浏览器渲染" class="headerlink" title="第四步，浏览器渲染"></a>第四步，浏览器渲染</h2><p>浏览器获取到需要的数据以后，对数据进行拼接、解析、执行，最终将完整的网页绘制在页面上。</p>
<h2 id="第五步，浏览器缓存"><a href="#第五步，浏览器缓存" class="headerlink" title="第五步，浏览器缓存"></a>第五步，浏览器缓存</h2><p>浏览器拿到服务端返回的数据后，会根据一定的策略进行数据的缓存，这样在下一次请求同样数据的时候，就可直接到缓存拿取，不再请求服务器。</p>
<p>上述流程可以看作是一个应用在完整网络通信过程中的实践场景，其中带出了很多网络通信的知识点，下面就以这条线为索引，对其中涉及到的知识碎片进行阐述和说明。</p>
<h1 id="经典网络五层模型"><a href="#经典网络五层模型" class="headerlink" title="经典网络五层模型"></a>经典网络五层模型</h1><p><img src="https://s2.ax1x.com/2019/12/03/QKjjtx.md.png#alt=QKjjtx.md.png"></p>
<p>在每台计算机设备上，都有这么一套系统链路的关系，来保证网络传输的正常进行，因为统一集成了这么一套经典模型，所以自己使用的计算机也是可以作为一台服务器来提供网络服务的。</p>
<h2 id="应用层："><a href="#应用层：" class="headerlink" title="应用层："></a>应用层：</h2><p>应用层包含了我们所说的 HTTP 协议，为各个应用软件提供了很多服务，常见的应用层服务有：HTTP 服务 、FTP 服务 、Email 服务等。应用层屏蔽了底层模型的相关细节，作为应用支持，只提供给使用者一些必要的使用方式。</p>
<h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><p>常见的传输层协议有 TCP 和 UDP ，传输层作为为应用层的基础，定义了“端到端（end to end）”之间数据间的传输方式，比如：两台设备如何建立连接？设备之间需要以何种规范进行数据传输？需要以什么方式进行数据的分片、重组、拼接？这些都是传输层为我们定义好的。</p>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><p>通常我们常说的 IP 协议就位于这一层。网络层为数据在结点之间传输创建逻辑链路，当我们在浏览器敲下域名，浏览器在网络里如何通过这个域名，找到对应的 IP 映射，这个查询的逻辑关系和链路，是网络层规范和定义的。</p>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><p>数据链路层在通信实体间建立数据链路连接，物理设备连接完成以后，需要相应的软件和驱动来连接和打通这些物理设备，创建电路的连接。</p>
<h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><p>定义物理设备如何传输数据，常见的物理层有网线，光缆，网卡，声卡等，物理层是一切软件的基础。</p>
<h1 id="URI、URL-和-URN"><a href="#URI、URL-和-URN" class="headerlink" title="URI、URL 和 URN"></a>URI、URL 和 URN</h1><p>对于 URL 我们基本比较熟悉，然而对 URI 和 URN 的了解可能比较少，URI、URL 和 URN 是识别、定位和命名互联网上的资源的标准途径。</p>
<p>当我们在浏览器地址栏里输入域名的那一刻，其实已经和这三个概念牵扯上了联系。</p>
<p><img src="https://s2.ax1x.com/2019/12/03/QKvAAI.md.png#alt=QKvAAI.md.png"></p>
<h2 id="URI"><a href="#URI" class="headerlink" title="URI"></a>URI</h2><p>Uniform Resource Identifier，统一资源标识符，简称为 URI。</p>
<p>每个 Web 服务器都有一个 URI 标识符，它在世界范围内唯一标识并定位信息资源，一个资源信息有了 URI 标识以后，在互联网上就能通过一个固定的地址访问到这个资源。</p>
<p>它具有两种形式，URN （统一资源名）、URL（统一资源定位符），也就是说 URL 和 URN 是它的子集。</p>
<h2 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h2><p>Uniform Resource Locator，统一资源定位符，简称 URL，下图是一个完整的 URL 组成。</p>
<p><img src="https://s2.ax1x.com/2019/12/03/QKvYCV.md.png#alt=QKvYCV.md.png"></p>
<p>一个完整的 URL 从左到右包含如下部分：</p>
<ol>
<li>schema 标识了这个资源地址所基于的访问协议，常见的比如：HTTP 和 FTP。</li>
<li>user information 标识了用户信息（如果这个资源需要用户信息认证的话），不过一般现在的认证都不采用这种方式，一来输入非常麻烦，二来不安全。</li>
<li>host 标识了资源的域信息，可以是域名，也可以是 IP ，这块的作用主要是找到资源所存放的物理服务器地址。</li>
<li>port 端口号，一个物理服务器，通过开启不同的端口，就同时可以运行多个 web 服务器，资源文件会部署在某一个 web 服务器的某一个地方，而端口号就是用来定位资源存在的 web 服务器的。</li>
<li>path 路径，或者叫路由，一个 web 服务器下有许多目录，一般 path 就是用来定位到资源文件所存放的目录的。由于现在很多的 web 应用非常庞大，这个路径也不一定就是目录地址，也可能是 web 服务器指定的静态资源文件的请求地址。</li>
<li>query 查询字符串，一般用于 GET 查询，传递查询参数。</li>
<li>fragment 片段，哈希，或者叫锚点，主要用于前端文档的定位，或者是前端渲染时控制路由跳转的手段。</li>
</ol>
<blockquote>
<p>这里需要注意将 URL 与网址区别开来。</p>
</blockquote>
<p>URL 不仅仅包含了网页的资源地址，还包含了组成网页所需的图片、视频等超文本资源，以及 css js 等资源地址。</p>
<p>网址本质上是 IP 地址的一个更有辨别度的映射，在通过 DNS 解析之后，浏览器最先拿到的是 html 文档的 URL 地址，根据浏览器对 Html 文档的解析，继续通过网页内其他资源文件的 URL 获取对应的资源文件。</p>
<h2 id="URN"><a href="#URN" class="headerlink" title="URN"></a>URN</h2><p>Uniform Resource Name，统一资源名称，简称 URN，它的用处简单说就是永久定位资源，因为同一个资源可能会更换存储位置，存储位置一旦更换，再访问原来的 url 肯定是拿不到的，URN 就是解决这个问题的，不管资源位置怎么移动，只要访问同一个 URN 都能定位到。</p>
<h1 id="TCP-x2F-IP-协议族"><a href="#TCP-x2F-IP-协议族" class="headerlink" title="TCP&#x2F;IP 协议族"></a>TCP&#x2F;IP 协议族</h1><blockquote>
<p>TCP&#x2F;IP 协议（传输控制协议&#x2F;互联网协议）不是简单的一个协议，而是一组特别的协议，包括：TCP，IP，UDP，ARP 等，这些被称为子协议。在这些协议中，最重要、最著名的就是 TCP 和 IP。因此我们习惯将整个协议族称为 TCP&#x2F;IP。</p>
</blockquote>
<h2 id="IP-协议"><a href="#IP-协议" class="headerlink" title="IP 协议"></a>IP 协议</h2><p>IP 协议使互联网成为一个允许连接不同类型的计算机和不同操作系统的网络。</p>
<p>IP 地址是 IP 协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，相当于这台机器的暂用名，别的机器可以通过这个名字找到它，进而能互相建立起连接进行通信和交流。</p>
<h2 id="TCP-协议"><a href="#TCP-协议" class="headerlink" title="TCP 协议"></a>TCP 协议</h2><p>TCP 协议是面向连接的全双工协议，因此不管是客户端还是服务端都能在 TCP 连接通道下向对端接收和发送数据。</p>
<p>TCP 相比于 UDP 的优势在于它的传输稳定性，在数据传输之前必须经过三次握手建立连接；在数据传输过程中必须保证数据有序完整地传到对端。</p>
<p>TCP 相比于 UDP 的劣势在于它的复杂度，连接建立、断开都是比较大的性能开销，而且数据传输过程中一旦卡住，则必须等前面的数据发送完毕以后，后续数据才能继续传输。</p>
<p>每台服务器可提供支持的 TCP 连接数量是有限的，所以这也使得 TCP 连接变成了稀缺资源，经不起浪费。</p>
<h2 id="UDP-协议"><a href="#UDP-协议" class="headerlink" title="UDP 协议"></a>UDP 协议</h2><p>UDP 协议是面向无连接的，不需要在传输数据前先建立连接，想发就发想传就传。</p>
<p>UDP 做的工作只是报文搬运，不负责有序且不丢失地传递到对端，因此容易出现丢包的情况。</p>
<p>UDP 不仅支持一对一的传输方式，还支持一对多、多对多、多对一的方式，也就是说 UPD 提供了单播、多播、广播的功能。</p>
<p>UDP 相比于 TCP 的优势在于它的轻量、高效和灵活，在一些对于实时性应用要求较高的场景下需要使用到 UDP，比如直播、视频会议、LOL 等实时对战游戏。</p>
<p>UDP 相比于 TCP 的劣势在于它的不可靠性和不稳定性。</p>
<h1 id="TCP-连接"><a href="#TCP-连接" class="headerlink" title="TCP 连接"></a>TCP 连接</h1><p>在客户端发送正式的 HTTP 请求之前，需要先创建一个 TCP 连接，在创建的 TCP Connect   通道下，所有的 HTTP 请求和响应才能正常的发送和接受。</p>
<p>在不同的 HTTP 协议版本里，这个 TCP 连接通道的创建和持续机制也有所不同。</p>
<p>在 HTTP1.0 中，每一次 HTTP 请求都会创建一个 TCP 连接，在请求发送完成，服务器响应以后，这个 TCP 连接就自动断开了。</p>
<p>在 HTTP1.1 中，可以通过手动设置 Connection： keep-alive 请求头来建立 TCP 的持久连接，多个 HTTP 请求可以共用一个 TCP 连接。但是 TCP 连接存在线头阻塞，即若干个请求排队等待发送，一旦有某请求超时等，后续请求只能被阻塞。</p>
<p>在 HTTP2 中，采用了信道复用，使 TCP 连接支持并发请求，即多个请求可同时在一个连接上并行执行。某个请求任务耗时严重，不会影响到其它连接的正常执行吗，这样一来，大部分请求可以使用一个 TCP 连接，而不用创建新的 TCP 连接通道，既节省了三次握手的开销，又节约了服务端维护 TCP 端口的成本。</p>
<h1 id="TCP-的三次握手和四次挥手"><a href="#TCP-的三次握手和四次挥手" class="headerlink" title="TCP 的三次握手和四次挥手"></a>TCP 的三次握手和四次挥手</h1><h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p><img src="https://s2.ax1x.com/2019/12/03/QKvH8f.md.png#alt=QKvH8f.md.png"></p>
<blockquote>
<p>提示：关于 ACK、FIN、SYN 状态码的含义</p>
</blockquote>
<p>1.ACK 用于确认，表示通知对方，我已经收到你发来的信息了。</p>
<p>2.FIN 用于结束，表示告知对方，我这边已经结束，数据全部发送完毕，没有后续输出，请求终止连接。</p>
<p>3.SYN 用于同步和建立连接，表示告知对方，我这边请求同步建立连接。</p>
<ol>
<li>第一次握手：由客户端向服务端发送连接请求 SYN 报文，该报文段中包含自身的数据通讯初始序号，请求发送后，客户端便进入 SYN-SENT 状态。</li>
<li>第二次握手：服务端收到连接请求报文段后，如果同意连接，则会发送一个包含了 ACK 和 SYN 报文信息的应答，该应答中也会包含自身的数据通讯初始序号（在断开连接的“四次挥手”时，ACK 和 SYN 这两个报文是作为两次应答，独立开来发送的，因此会有四次挥手），服务端发送完成后便进入 SYN-RECEIVED 状态。</li>
<li>第三次握手：当客户端收到连接同意的应答后，还要向服务端发送一个确认报文。客户端发完这个报文段后便进入 ESTABLISHED 状态，服务端收到这个应答后也进入 ESTABLISHED 状态，此时连接建立成功。</li>
</ol>
<blockquote>
<p>面试时可能会问的一个问题就是，明明两次握手就能确定的连接，为什么需要三次握手？</p>
</blockquote>
<p>因为由于很多不可控制的因素，例如网络原因，可能会造成第一次请求隔了很久才到达服务端，这个时候客户端已经等待响应等了很久，之前发起的请求已超时，已经被客户端废弃掉不再继续守着监听了。</p>
<p>然而服务端过了很久，收到了废弃的延迟请求，发起回应的同时又开启了一个新的 TCP 连接端口，在那里呆等客户端。</p>
<p>而服务端能维护的 TCP 连接是有限的，这种闲置的无用链接会造成服务端的资源浪费。</p>
<p>因此在服务端发送了 SYN 和 ACK 响应后，需要收到客户端接的再次确认，双方连接才能正式建立起来。三次握手就是为了规避这种由于网络延迟而导致服务器额外开销的问题。</p>
<h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><p><img src="https://s2.ax1x.com/2019/12/03/QMkSIg.png#alt=QMkSIg.png"></p>
<p>和建立 TCP 连接类似，断开 TCP 连接也同样需要客户端于服务端的双向交流，因为整个断开动作需要双端共发送 4 个数据包才能完成，所以简称为“四次挥手”。</p>
<ol>
<li>第一次挥手：客户端认为自己这边的数据已经全部发送完毕了，于是发送一个 FIN 用来关闭客户端到服务端的数据传输，发送完成以后，客户端进入 FIN_WAIT_1 状态。</li>
<li>第二次挥手：服务端收到客户端发送回来的 FIN 以后，会告诉应用层要释放 TCP 链接，并且发送一个 ACK 给客户端，表明已经收到客户端的释放请求了，不会再接受客户端发来的数据，自此，服务端进入 CLOSE_WAIT 的状态。</li>
<li>第三次挥手：服务端如果此时还有未发送完的数据可以继续发送，发送完毕后，服务端也会发送一个释放连接的 FIN 请求用来关闭服务端到客户端的数据传送，然后服务端进入 LAST_ACK 状态。</li>
<li>第四次挥手：客户端接收到服务端的 FIN 请求后，发送最后一个 ACK 给服务端，接着进入 TIME_WAIT_2 状态，该状态会持续 2MSL（最大段生存期，指报文段在网络中生存的时间，超时会被抛弃） 时间，若该时间段内没有服务端的重发请求的话，客户端就进入 CLOSED 状态.服务端在收到应答消息后，也会进入 CLOSED 状态，至此完成四次挥手的过程，双方正式断开连接。</li>
</ol>
<p>上面的内容可能还是有些不够直观，所以我还准备了一段人话来描述整个过程：</p>
<ol>
<li>客户端：喂，我好了。</li>
<li>服务端：噢，你好了是吧，我知道了，我还没好，你等一哈。</li>
<li>服务端：OK，现在我也好了。</li>
<li>客户端：收到，这次玩的很开心，我们下次再约。</li>
</ol>
<blockquote>
<p>可能有些面试中会问，为什么建立连接有三次握手，而断开连接却有四次？</p>
</blockquote>
<p>这是因为在建立连接过程中，服务端在收到客户但建立连接请求的 SYN 报文后，会把 ACK 和 SYN 放在一个报文里发送给客户端。</p>
<p>而关闭连接时，服务端收到客户端的 FIN 报文，只是表示客户端不再发送数据了，但是还能接收数据，而且这会儿服务端可能还有数据没有发送完，不能马上发送 FIN 报文，只能先发送 ACK 报文，先响应客户端，在确认自己这边所有数据发送完毕以后，才会发送 FIN。</p>
<p>所以，在断开连接时，服务器的 ACK 和 FIN 一般都会单独发送，这就导致了断开连接比请求连接多了一次发送操作。</p>
<h1 id="HTTP-定义"><a href="#HTTP-定义" class="headerlink" title="HTTP 定义"></a>HTTP 定义</h1><p>一旦端对端成功建立起了 TCP 连接，下一步就要开始发送正式的 HTTP 请求了。流淌在 TCP Connect 通道里的 HTTP 只负责传输数据包，并没有连接的概念，因此 HTTP 也被叫做“无状态协议”。</p>
<blockquote>
<p>HTTP 协议是 Hyper Text Transfer Protocol（超文本传输协议）的缩写，它通常运行在 TCP 之上，通过浏览器和服务器进行数据交互，进行超文本（文本、图片、视频等）传输的规定。也就是说，HTTP 协议规定了超文本传输所要遵守的规则。</p>
</blockquote>
<ol>
<li>HTTP 协议是无状态的。这意味着客户端和服务端之间无法知晓当前对方的状态信息，HTTP 请求本身是不带有任何状态存储的。但实际情况下，客户端和服务端必然需要状态的认证和交互，所以就引入了 Cookie， 用于存储当前浏览器的一些状态信息，每次通过独立的 HTTP 请求进行收发，从而解决这个问题。</li>
<li>HTTP 请求互相独立。HTTP 互相之间都是一个独立的个体请求，在客户端请求网页时多数情况下并不是一次请求就能成功的，服务端首先是响应 HTML 页面，然后浏览器收到响应之后发现页面还引用了其他的资源，例如，CSS，JS 文件，图片等等，还会自动发送 HTTP 请求获取这些需要的资源。</li>
<li>HTTP 协议基于 TCP 协议。HTTP 协议目的是规定客户端和服务端数据传输的格式和数据交互行为，并不负责数据传输的细节，底层是基于 TCP 实现的。现在使用的版本当中是默认持久连接的，也就是多次 HTTP 请求使用一个 TCP 连接。</li>
</ol>
<blockquote>
<p>注意：HTTP 请求和 TCP 连接是不一样的，HTTP 是在 TCP 连接建立的基础上而发起的传输请求，在同一个 TCP 连接通道下，可以发送多个 HTTP 请求，举个例子的话就是高速公路和车子的关系。</p>
</blockquote>
<h1 id="HTTP-发展历史"><a href="#HTTP-发展历史" class="headerlink" title="HTTP 发展历史"></a>HTTP 发展历史</h1><h2 id="HTTP-0-9-版本"><a href="#HTTP-0-9-版本" class="headerlink" title="HTTP 0.9 版本"></a>HTTP 0.9 版本</h2><p>只有一个 GET 命令。</p>
<p>没有请求头和响应头来描述传输相关的数据信息。</p>
<p>服务器发送完数据后，直接关闭 TCP 连接，不支持 TCP 持久化连接。</p>
<h2 id="HTTP-1-0-版本"><a href="#HTTP-1-0-版本" class="headerlink" title="HTTP 1.0 版本"></a>HTTP 1.0 版本</h2><p>增加了很多命令，HEAD、POST、PUT、DELETE 等。</p>
<p>增设了 status code 状态码和 header 请求头和响应头。</p>
<p>增加了多字符集支持、多部分发送、权限、缓存等。</p>
<p>可通过开启 Connection： keep-alive 来指定使用 TCP 长连接</p>
<h2 id="HTTP-1-1-（目前普遍使用）"><a href="#HTTP-1-1-（目前普遍使用）" class="headerlink" title="HTTP 1.1 （目前普遍使用）"></a>HTTP 1.1 （目前普遍使用）</h2><p>默认支持持久连接</p>
<p>默认支持长连接（PersistentConnection），即默认开启 Connection： keep-alive。</p>
<p>支持请求的流水线（Pipelining）处理，即在一个 TCP 连接上可以传送多个 HTTP 请求和响应。</p>
<p>增加了 host 请求头字段，通过对 host 解析，就能够允许在同一台物理服务器上运行多个软件服务，极大提高了服务器的使用率。目前的 nginx 反向代理就是根据 HTTP 请求头中的 host 来分辨不同的请求，从而将这些请求代理到同一台服务器不同的软件服务上。</p>
<h2 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP 2.0"></a>HTTP 2.0</h2><p>HTTP1.x 的解析是基于文本，存在解析上的缺陷；而 HTTP2.0 直接使用二进制的解析方式来替代 HTTP 1.X 的字符串解析，更为高效和健壮。</p>
<p>HTTP2.0 所有数据以“帧”的方式进行传输，因此同一个连接中发送的多个请求不再需要按照顺序进行返回处理，可以达到并行的数据传输。</p>
<p>HTTP2.0 压缩头信息进行传输数据量的优化。HTTP1.x 的请求头带有大量信息，而且每次都要重复发送，HTTP2.0 使用 encoder 来减少需要传输的请求头大小，通讯双方各自缓存一份 header fields 表，既避免了重复的传输，又减小了传输信息的大小。</p>
<p>HTTP2.0 新增了 server push（服务端推送） 的概念，服务端可以主动发起一些数据推送。比如，服务端在接收到浏览器发来的 HTML 请求的同时，可以主动推送相关的资源文件（js&#x2F;css）给客户端，并行发送，提高网页的传输和渲染效率。</p>
<p>目前如果要使用 HTTP2 需要首先使用 HTTPS 在这基础上，才能使用 HTTP2</p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>我们经常会在有些网页上看到悬浮的弹窗或者广告，有的时候甚至会在自己编写的上线网页上也看到这些垃圾广告，然而开发者明明没有写过这些东西，可是这种垃圾信息是怎么上去的呢？</p>
<p>究其根本原因就在于各种代理服务，当我们从客户端发起一个 HTTP 请求，并不是直接就能传递到目标服务器的，期间会经过层层的代理服务，我们常用的 nginx ，以及在 DNS 解析过程中要经过的宽带运营商，都是一种代理服务。</p>
<p>由于 HTTP 时使用明文字符串来传递数据的，那么这些数据就能很轻易地被中间服务读取甚至篡改，那么中间服务拿到了原始的 HTML 数据，想插入点小广告进去自然不是难事。</p>
<p>HTTPS 是为了解决 HTTP 明文传输而出现的安全问题而出现的一种解决机制 ———— 对 HTTP 请求中的信息进行加密之后传输，从而有效地防止了中间代理服务截获或篡改信息的问题。</p>
<p>HTTPS 其实就是一个安全加强版的 HTTP 1.1 ，有几点需要注意的是：</p>
<ol>
<li>HTTPS 协议需要到 CA 申请证书，一般免费证书很少，需要交费</li>
<li>HTTP 协议运行在 TCP 之上，所有传输的内容都是明文，HTTPS 运行在 SSL&#x2F;TLS 之上，SSL&#x2F;TLS 运行在 TCP 之上，所有传输的内容都经过加密的。</li>
<li>HTTP 和 HTTPS 使用的是完全不同的连接方式，用的端口也不一样，前者是 80，后者是 443。</li>
<li>HTTPS 可以有效的防止运营商劫持，解决了防劫持的一个大问题。</li>
</ol>
<h1 id="HTTP-的报文组成"><a href="#HTTP-的报文组成" class="headerlink" title="HTTP 的报文组成"></a>HTTP 的报文组成</h1><p>HTTP 是以请求和响应的形式存在的，由于发起方主动发起一个 HTTP 请求，然后由响应方回应，双方按照一定的报文格式进行数据的互传，一个完整的 HTTP 报文通常由 首行、首部 和 主体 构成。</p>
<h2 id="首行"><a href="#首行" class="headerlink" title="首行"></a>首行</h2><p>首行并不属于 Http Headers ，它包含了：</p>
<ol>
<li>HTTP Method（GET、POST、PUT、DELETE 等 ），不同的 HTTP Method 有不同的语意。<table>
<thead>
<tr>
<th>HTTP Method</th>
<th>对应予以</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>一般用于获取服务器资源</td>
</tr>
<tr>
<td>POST</td>
<td>一般用于传输实体主体</td>
</tr>
<tr>
<td>PUT</td>
<td>一般用于传输文件</td>
</tr>
<tr>
<td>DELETE</td>
<td>用于删除文件</td>
</tr>
<tr>
<td>HEAD</td>
<td>用于获取报文首部，不返回报文主体</td>
</tr>
<tr>
<td>OPTIONS</td>
<td>用于预检请求中，询问请求 URI 资源支持的方法</td>
</tr>
</tbody></table>
</li>
</ol>
<blockquote>
<p>HTTP Method 只是 HTTP 协议推崇的一种规范，就像 ESLint，你可以选择遵循，也可以选择不遵循，它们所作的事情实质上没有差别，只是语义化更明确。</p>
</blockquote>
<ol start="2">
<li><p>URL 请求资源的地址，这个地址只会包含请求的路由地址。</p>
</li>
<li><p>协议的版本，HTTP 1.0 &#x2F; HTTP 1.1 &#x2F; HTTP 2。</p>
</li>
<li><p>HTTP 返回状态码（响应报文首行包含）</p>
</li>
</ol>
<blockquote>
<p>HTTP 定义了 40 个标准状态代码，可用于传递客户端请求的结果，状态代码分为以下五类，关于各个分段下的返回状态码信息可以参考 HTTP 响应码：</p>
</blockquote>
<blockquote>
<p>这边需要注意的一点是，一个好的 HTTP 应用服务应该是有完善的 HTTP status code 的返回信息的，即访问者单从 HTTP status &gt; code 上就能得知当前 HTTP 请求的状态信息。</p>
</blockquote>
<p>而目前我们大部分的开发模式下的 HTTP 返回码，只有 200 和 500。服务端的同学会先把 200 返回过来，然后再告诉你出了什么 “没登录” &#x2F; “没认证” &#x2F; “没权限” 这一类的问题。</p>
<p>业界也有一句戏言：又不是不能用，其实这种开发方式是不正确的，不管从代码的维护性还是个人自身发展角度，我们都需要&gt; 尽量避免这种问题。</p>
<h2 id="HTTP-头信息"><a href="#HTTP-头信息" class="headerlink" title="HTTP 头信息"></a>HTTP 头信息</h2><p>HTTP 头信息，即 HTTP Header，首行换行后的信息都是 HTTP Header。HTTP header 里一般存放了客户端和服务端之间交互的非业务信息，例如：本次请求的数据类型、请求日期、字符集支持、自定义头部字段、一些通信凭证和缓存支持等。</p>
<p>HTTP Header 完整字段列表：传送门</p>
<h2 id="主体"><a href="#主体" class="headerlink" title="主体"></a>主体</h2><p>主体，即 HTTP body，HTTP Header 信息和主体信息间以一个空行 + 一个换行来区分。HTTP body 里一般会放置请求的一些具体业务信息</p>
<h1 id="HTTP-数据协商"><a href="#HTTP-数据协商" class="headerlink" title="HTTP 数据协商"></a>HTTP 数据协商</h1><p>在 HTTP 协议中，数据协商是这样一种机制，客户端通过请求头告知服务端本次请求希望获取的数据格式、展现形式、以及数据的压缩方式等。常见的数据协商例如，文档使用的自然语言，图片的格式，或者内容编码形式。</p>
<p>服务端可以对请求头中携带的数据协商字段进行解析，然后在返回客户端数据的时候，也会用相对字段来通知客户端：本次返回的数据格式、压缩方式等信息。这样浏览器就可以使用特定的解析方式，来对这些资源进行解析、处理和渲染。</p>
<p>下面简单列举一些常用的数据协商字段，完整的数据协商信息传送门</p>
<ul>
<li>Accept 请求头字段，指定期望获得的数据类型</li>
<li>Accept-Encoding 请求头字段，指定期望获得的数据需要以什么样的编码方式进行传输，常用于限制服务端对数据的压缩方式，常见的 JS 文件包大小优化的 GZIP 压缩，就使用了这个方法</li>
<li>Accept-Language 请求头字段，指定期望获得的数据语言类型：中文、英语、还是其他语言，这个头信息字段，一般是浏览器自动加上的</li>
<li>User-Agent 请求头字段，指定本次请求的浏览器信息，服务端可根据此信息选择不同兼容性的页面返回给用户，或者是做用户使用浏览器信息、操作系统等数据的统计</li>
<li>Content-Type 响应头字段，请求头里的 Accept 字段可能会指定好几种可以接受的数据格式，服务端最终会返回一种数据格式给客户端</li>
<li>Content-Encoding 响应头字段，对应 Accept-Encoding</li>
<li>Content-Language 响应头字段，对应 Accept-Language</li>
</ul>
<h1 id="HTTP-长连接"><a href="#HTTP-长连接" class="headerlink" title="HTTP 长连接"></a>HTTP 长连接</h1><p>每一个 HTTP 请求都需要在 TCP 连接通道里才能完成发送和接受。在 HTTP 协议的早期版本里，每一条 HTTP 请求发送之前，都会创建一条新的 TCP 连接通道，在这个请求完成以后，该条 TCP 通道就会自动关闭。</p>
<p>这样带来的问题就是，单条 TCP 连接没有办法复用，造成很大的新能浪费。好在这一问题随着 HTTP 协议的逐步完善已经得到解决。</p>
<p>在 HTTP 1.0 中引入的 Connection 头字段，允许对其设置 Keep-Alive 或者是 Close 来决定是否需要复用 TCP 连接，还是说在一次请求完成之后直接关闭。而在 HTTP 1.1 中默认双端都会默认开启这个字段，即默认支持 HTTP 的长连接。</p>
<blockquote>
<p>需要注意的是：Connection: Keep-Alive 需要双端同时开启才能启动 HTTP 长连接，如果任何一段手动设置 Connection 为 Close，长连接都无法位置，因为 TCP 连接的建立和持久保持是一个双端交互的过程。</p>
</blockquote>
<p>那么我们在本地如何看到 TCP 的连接 ID 呢，可以打开 Chrome 的调试工具来查看：</p>
<p><img src="https://s2.ax1x.com/2019/12/05/Q8eLHH.png#alt=Q8eLHH.png"></p>
<p>图上可以看到有不同的 Connection ID，这就代表着本次请求实际上是开启了一个新的 TCP 连接，最下面的请求的 Connection ID 都是相同的，代表着多个 HTTP 请求复用了同一个 TCP 连接。</p>
<blockquote>
<p>Chrome 浏览器所能够支持的最大并发 TCP 连接数是 6 个，并且在 HTTP 2.0 以下的 HTTP 版本中，请求是阻塞的。也就是说，一旦六个连接开满，前面的请求未完成，那么后续请求就会被阻塞，直到前面的请求返回，后续才能继续发送。</p>
</blockquote>
<h1 id="HTTP-缓存"><a href="#HTTP-缓存" class="headerlink" title="HTTP 缓存"></a>HTTP 缓存</h1><blockquote>
<p>虽然 HTTP 缓存不是必须的，但重用缓存的资源通常是必要的。然而常见的 HTTP 缓存只能存储 GET 响应，对于其他类型的响应则无能为力。缓存的关键主要包括 request method 和目标 URI（一般只有 GET 请求才会被缓存）。</p>
</blockquote>
<h2 id="缓存读取策略"><a href="#缓存读取策略" class="headerlink" title="缓存读取策略"></a>缓存读取策略</h2><p>前端环境下的文件缓存，分为几个不同的位置。当我们打开 Chrome 控制台，查看 Network 下每条请求记录的 size 选项，会发现非常丰富的来源信息。</p>
<p><img src="https://s2.ax1x.com/2019/12/05/Q8mhqg.png#alt=Q8mhqg.png"></p>
<p>对于前端浏览器环境来说，缓存读取位置是由先后顺序的，顺序分别是（由上到下寻找，找到即返回；找不到则继续）</p>
<ul>
<li>Service Worker</li>
<li>Memory Cache</li>
<li>Disk Cache</li>
<li>网络请求</li>
</ul>
<h2 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h2><blockquote>
<p>Service Worker 的缓存与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存哪些文件、如何匹配缓存、如何读取缓存，并且缓存是持续性的。</p>
</blockquote>
<p>浏览器优先查找。</p>
<p>持久存储。</p>
<p>可以更加灵活地控制存储的内容，可以选择缓存哪些文件、定义缓存文件的路由匹配规则等。</p>
<p>可以从 Chrome 的 F12 中，Application -&gt; Cache Storage 查看。</p>
<h2 id="Memory-Cache"><a href="#Memory-Cache" class="headerlink" title="Memory Cache"></a>Memory Cache</h2><p>memory cache 是内存中的缓存存储。</p>
<p>读取速度快。</p>
<p>存储空间较小。</p>
<p>存储时间短，当浏览器的 tab 页被关闭，内存资源即被释放。</p>
<p>如果明确指定了 Cache-Control 为 no-store，浏览器则不会使用 memory-cache。</p>
<h2 id="Disk-Cache"><a href="#Disk-Cache" class="headerlink" title="Disk Cache"></a>Disk Cache</h2><p>Disk Cache 是硬盘中的缓存存储。</p>
<p>读取速度慢于 Memory Cache ，快于网络请求。</p>
<p>存储空间较大。</p>
<p>持久存储。</p>
<p>Disk Cache 严格依照 HTTP 头信息中的字段来判断资源是否可缓存、是否要认证等。</p>
<p>经常听到的“强制缓存”，“对比缓存”，以及 Cache-Control 等，归于此类。</p>
<h2 id="网络请求"><a href="#网络请求" class="headerlink" title="网络请求"></a>网络请求</h2><p>如果一个请求的资源文件均未命中上述缓存策略，那么就会发起网络请求。浏览器拿到资源后，会把这个新资源加入缓存。</p>
<h1 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h1><blockquote>
<p>HTTP&#x2F;1.1 定义的 Cache-Control 头用来区分对缓存机制的支持情况， 请求头和响应头都支持这个属性。通过它提供的不同的值来定义缓存策略。需要注意的是，数据变化频率很快的场景并不适合开启 Cache-Control。</p>
</blockquote>
<table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>public</td>
<td>公共缓存：表示该响应可以被任何中间人（比如中间代理、CDN 等）缓存。</td>
</tr>
<tr>
<td>private</td>
<td>私有缓存：表示该响应是专用于某单个用户的，中间人不能缓存此响应，该响应只能应用于浏览器私有缓存中。</td>
</tr>
<tr>
<td>max-age</td>
<td>（单位&#x2F;秒）设置缓存的过期时间，过期需要重新请求，否则就读取本地缓存，并不实际发送请求</td>
</tr>
<tr>
<td>s-maxage</td>
<td>（单位&#x2F;秒）覆盖 max-age，作用一样，只在代理服务器中生效</td>
</tr>
<tr>
<td>max-stale</td>
<td>（单位&#x2F;秒）表示即使缓存过期，也使用这个过期缓存</td>
</tr>
<tr>
<td>no-store</td>
<td>禁止进行缓存</td>
</tr>
<tr>
<td>no-transform</td>
<td>不得对资源进行转换或压缩等操作，Content-Encoding、Content-Range、Content-Type 等 HTTP 头不能由代理修改（有时候资源比较大的情况下，代理服务器可能会自行做压缩处理，这个指令就是为了防止这种情况）。</td>
</tr>
<tr>
<td>no-cache</td>
<td>强制确认缓存：即每次使用本地缓存之前，需要请求服务器，查看缓存是否失效，若未过期（注：实际就是返回 304），则缓存才使用本地缓存副本。</td>
</tr>
<tr>
<td>must-revalidate</td>
<td>缓存验证确认：意味着缓存在考虑使用一个陈旧的资源时，必须先验证它的状态，已过期的缓存将不被使用</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>与 must-revalidate 作用相同，但它仅适用于共享缓存（例如代理），并被私有缓存忽略。</td>
</tr>
</tbody></table>
<p><img src="https://s2.ax1x.com/2019/12/05/Q8uaHe.png#alt=Q8uaHe.png"></p>
<h1 id="缓存校验"><a href="#缓存校验" class="headerlink" title="缓存校验"></a>缓存校验</h1><blockquote>
<p>在浏览器使用缓存的过程中，为了配合 Cache-Control 中 no-cache ，我们还需要一个机制来验证缓存是否有效。比如服务器的资源更新了，客户端需要及时刷新缓存；又或者客户端的资源过了有效期，但服务器上的资源还是旧的，此时并不需要重新发送。</p>
</blockquote>
<p>缓存校验就是用来解决这些问题的，在 http 1.1 中，我们主要关注下 Last-Modified 和 ETag 这两个字段。</p>
<h2 id="Last-Modified"><a href="#Last-Modified" class="headerlink" title="Last-Modified"></a>Last-Modified</h2><p>顾名思义，就是资源的最新一次修改时间。当客户端访问服务端的资源，服务端会将这个 Last-Modified 值返回给客户端，客户端收到之后，下次发送请求就会将服务端返回回来的 Last-Modified 值装在 If-Modified-Since 或者 If-Unmodified-Since 里，发送给服务端进行缓存校验。</p>
<p>这样服务器就可以通过读取 If-Modified-Since （较常用）或 If-UnModified-Since 的值，和本地的 Last-Modified 值做对比校验。如果校验发现这两个值是一样的，就代表本次请求的资源文件没有被修改过，那么服务器就会告诉浏览器，资源有效，可以继续使用，否则就需要使用最新的资源。</p>
<p>来看一下下面的两张图：</p>
<p>当请求服务端的 script.js 的脚本资源时，可以看到服务端返回了 Last-Modified，里面记录了该资源最后一次的修改时间</p>
<p>当客户端下次再次发起请求，会携带上这个过期时间给服务端进行验证</p>
<p>来看下服务端的部分代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line">http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">request, response</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ifModifiedSince = request.<span class="property">headers</span>[<span class="string">&quot;If-Modified-Since&quot;</span>];</span><br><span class="line">  <span class="keyword">const</span> lastModified =</span><br><span class="line">    <span class="string">&quot;Web Aug 19 2019 19:01:15 GMT+0800 (China Standard Time)&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (request.<span class="property">url</span> === <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> html = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;test.html&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    response.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">      <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/html&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    response.<span class="title function_">end</span>(html);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (request.<span class="property">url</span> === <span class="string">&quot;/script.js&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> js = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;script.js&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> status = <span class="number">200</span>;</span><br><span class="line">    <span class="comment">// 如果读取到的 If-Modified-Since 和 lastModified 相同，则设置头部 304 表示可使用缓存</span></span><br><span class="line">    <span class="keyword">if</span> (ifModifiedSince === lastModified) &#123;</span><br><span class="line">      status = <span class="number">304</span>;</span><br><span class="line">      response.<span class="title function_">end</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    response.<span class="title function_">writeHead</span>(status, &#123;</span><br><span class="line">      <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/javascript&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache,max-age=2000&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Last-Modified&quot;</span>: lastModified,</span><br><span class="line">    &#125;);</span><br><span class="line">    response.<span class="title function_">end</span>(js);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="ETag"><a href="#ETag" class="headerlink" title="ETag"></a>ETag</h1><p>Etag 的作用本质上和 Last-Modified 差别不大。相比于 Last-Modified 使用最后修改日期来比较资源是否失效的缓存校验策略，ETag 则是通过数据签名来做一个更加严格的缓存验证。</p>
<p>所谓数据签名，其实就是通过对资源内容进行一个唯一的签名标记，一旦资源内容改变，那么签名必将改变，服务端就以此签名作为暗号，来标记缓存的有效性。典型的做法是针对资源内容进行一个 hash 计算，类似于 webpack 打包线上资源所加的 hash 标识</p>
<p>和 Last-Modified 对应 If-Modified-Since 相同，ETag 也会对应 If-Match 或者 If-None-Match（If-None-Match 比较常用），如果前后的签名相同，则不需要返回新的资源内容。</p>
<h2 id="缓存校验的合理使用"><a href="#缓存校验的合理使用" class="headerlink" title="缓存校验的合理使用"></a>缓存校验的合理使用</h2><blockquote>
<p>Last-Modified 和 ETag 只是给服务端提供了一个控制缓存有效期的手段，并没有任何强制缓存的作用，最终决定是否使用缓存、还是使用新的资源文件，还是需要靠服务端指定对应的 http code 来决定。</p>
</blockquote>
<p>对于保存在服务器上的文件，都有最后修改日期的属性，当使用 Last-Modified 可以利用这个有效的属性进行数据缓存验证；或者在数据库存入一个 updatetime 字段来标识具体的修改日期，从而判断缓存是否有效。</p>
<p>具体如何构建一个能够合理使用缓存的服务器，就比较涉及后端知识了，这里不做具体描述。</p>
<h1 id="浏览器的同源策略"><a href="#浏览器的同源策略" class="headerlink" title="浏览器的同源策略"></a>浏览器的同源策略</h1><blockquote>
<p>浏览器的同源限制：当浏览器访问 URL 地址的协议（schema）&#x2F; 端口（port）&#x2F; 域名（host），三者中有任何一个与当前的 URL 片段信息不匹配的时候，便存在跨域问题。</p>
</blockquote>
<p>对于跨域的几点需要明确：</p>
<ol>
<li>跨域，是浏览器提供的一种保护手段，服务端是不存在跨域这一说的。这也就是为什么现在前后端分离的开发模式下，前端比较依赖 webpack-dev-server 启动代理服务来中转和代理后台接口的原因，因为两个服务器之间相互通信是没有跨域障碍的。</li>
<li>跨域，是对于 XMLHttpRequest 来说的，浏览器获取不同源服务器下的静态资源，是没有跨域限制的，这也是 JSONP 跨域请求得以实现的本质。</li>
<li>不同于 XMLHttpRequest 的是，通过 src 属性加载的脚本资源，浏览器限制了 Javascript 的权限，使其不能读写、返回内容。</li>
<li>对于浏览器来说，除了 DOM 、Cookie、XMLHttpRequest 会收到同源策略限制以外，一些常见的插件，比如 Flash、Java Applet 、Silverlight、Google Gears 等也都有自己的控制策略。</li>
</ol>
<blockquote>
<p>当浏览器向不同域的服务器发送请求时，请求是真能发出去，对方服务端也是真能接收到请求，并且真能给你的浏览器响应，浏览器也真能接收到有效数据。</p>
</blockquote>
<p>但是，如果在跨域的情况下、服务端返回数据的响应头里的 Access-Control-Allow-Origin 字段，没有把当前域名列进白名单，那么浏览器会把服务端返回的数据给藏起来，不告诉你，然后给你抛个 Access-Control-Allow-Origin 的错误。</p>
<blockquote>
<p>至于为什么资源文件不受同源策略限制呢？可以试想一下，如果资源文件也被限制跨域，那么现在大量使用的 CDN 缓存策略基本就没办法用了。而且现在很多网站的资源文件，都会放到云服务器的 OSS 上，OSS 资源对应的 url 地址肯定是不同域的，那这些资源也不能使用了。</p>
</blockquote>
<h1 id="Access-Control-Allow-Origin"><a href="#Access-Control-Allow-Origin" class="headerlink" title="Access-Control-Allow-Origin"></a>Access-Control-Allow-Origin</h1><p>Access-Control-Allow-Origin 标识了服务器允许的跨域白名单，它有以下几种设置方法：</p>
<ol>
<li>直接设置 * 通配符，简单粗暴，但是这么做等于把服务器的所有接口资源对外完全暴露，是不安全的。</li>
<li>设置制定域，比如 Access-Control-Allow-Origin: <a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a> ，这样只会允许指定域的请求进行跨域访问。</li>
<li>由后端动态设置。Access-Control-Allow-Origin 限制只能写一个白名单，但是当我们有多个域都需要跨域请求怎么呢？这个时候，这时可以由服务端自己维护一套白名单列表，在请求进来的时候对请求的源 host 进行白名单比对，如果在白名单中，就将这个 Access-Control-Allow-Origin 动态设置上去，然后返回响应。</li>
</ol>
<h2 id="CORS-的预请求"><a href="#CORS-的预请求" class="headerlink" title="CORS 的预请求"></a>CORS 的预请求</h2><p>如果我们像上面一样，只设置的 Access-Control-Allow-Origin 白名单，是否就可以完全畅通无阻地进行跨域了呢？并不是。</p>
<p>就算对端开启了域名白名单认证，然鹅有一些操作仍然是需要进一步认证的，这种进一步的认证操作，就是 CORS 预请求。</p>
<h2 id="预请求触发过程"><a href="#预请求触发过程" class="headerlink" title="预请求触发过程"></a>预请求触发过程</h2><p>浏览器预请求的触发条件，是判断本次请求是否属于一个简单请求。</p>
<p>如果本次请求属于一个复杂请求，那么在发送正式的跨域请求之前，浏览器会先准备一个名为 OPTIONS 的 HTTP Method ，作为预请求发送。</p>
<p>在服务器通过预请求后，下面浏览器才会发生正式的数据请求。整个请求过程其实是发生了两次请求：一个预检请求，以及后续的实际数据请求。</p>
<h2 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h2><ol>
<li>请求方式只能是 GET POST HEAD</li>
<li>请求头字段只允许：</li>
</ol>
<p>Accept</p>
<p>Accept-Language</p>
<p>Content-Language</p>
<p>Content-Type</p>
<ol start="3">
<li>Content-Type 的值仅限于：</li>
</ol>
<p>text&#x2F;plain</p>
<p>multipart&#x2F;form-data</p>
<p>application&#x2F;x-www-form-urlencoded</p>
<ol start="4">
<li>XMLHttpRequestUpload 对象均没有注册任何事件监听器（了解就好）。</li>
<li>请求中没有使用 ReadableStream 对象（了解就好）。</li>
</ol>
<h2 id="复杂请求"><a href="#复杂请求" class="headerlink" title="复杂请求"></a>复杂请求</h2><p>除了简单请求里定义的，都是复杂请求，统统需要预请求。</p>
<h2 id="预请求的验证"><a href="#预请求的验证" class="headerlink" title="预请求的验证"></a>预请求的验证</h2><p>那么怎样使预检请求成功认证呢？还是需要服务端继续帮忙设置请求头的白名单：</p>
<ol>
<li>ccess-Control-Allow-Headers，设置允许的额外请求头字段。</li>
<li>Access-Control-Allow-Methods，设置允许的额外请求方法。</li>
<li>Access-Control-Max-Age （单位&#x2F;秒），指定了预请求的结果能够被缓存多久，在这个时间范围内，再次发送跨域请求不会被预检。</li>
</ol>
<h1 id="HTTP-性能优化方案"><a href="#HTTP-性能优化方案" class="headerlink" title="HTTP 性能优化方案"></a>HTTP 性能优化方案</h1><p>合理使用 HTTP 的缓存策略，避免同一资源多次请求服务端而导致的额外性能开销</p>
<p>尽量使用 HTTP 长连接，避免每次重建 TCP 连接带来的时间损耗</p>
<p>尽量使用 HTTPS 来保证网络传输的安全性。</p>
<p>可以使用 HTTP2 来大幅提高数据传输的效率，使用 server push 开启 HTTP2 的服务端推送功能</p>
<p>客户端开启 Accept-Encoding 压缩方式的支持，服务端传输压缩后的文件，减少传输数据的大小</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/03/yuque/HTTP%E3%80%81TCP-IP-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/" data-id="cl9xpujsj005jdmophtbt7vvl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端常见跨域解决方案" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/03/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="article-date">
  <time datetime="2019-12-03T04:34:54.000Z" itemprop="datePublished">2019-12-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/HTML/">HTML</a>►<a class="article-category-link" href="/categories/HTML/HTTP%E5%9F%BA%E7%A1%80/">HTTP基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/03/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">前端常见跨域解决方案</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="什么是跨域？"><a href="#什么是跨域？" class="headerlink" title="什么是跨域？"></a>什么是跨域？</h1><p>跨域是指一个域下的文档或脚本试图去请求另一个域下的资源，这里跨域是广义的。</p>
<h1 id="广义的跨域："><a href="#广义的跨域：" class="headerlink" title="广义的跨域："></a>广义的跨域：</h1><p>1.) 资源跳转： A链接、重定向、表单提交<br>2.) 资源嵌入： <code>&lt;link&gt;、&lt;script&gt;、&lt;img&gt;、&lt;frame&gt;</code>等dom标签，还有样式中<code>background:url()</code>、<code>@font-face()</code>等文件外链<br>3.) 脚本请求： js发起的ajax请求、dom和js对象的跨域操作等</p>
<p>其实我们通常所说的跨域是狭义的，是由浏览器同源策略限制的一类请求场景。</p>
<h1 id="跨域建议方案"><a href="#跨域建议方案" class="headerlink" title="跨域建议方案"></a>跨域建议方案</h1><p>简单的跨域请求jsonp即可，复杂的cors，窗口之间JS跨域postMessage，开发环境下接口跨域用nginx反向代理或node中间件比较方便。</p>
<h1 id="什么是同源策略？"><a href="#什么是同源策略？" class="headerlink" title="什么是同源策略？"></a>什么是同源策略？</h1><p>同源策略&#x2F;SOP（Same origin policy）是一种约定，由Netscape公司1995年引入浏览器，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到XSS、CSFR等攻击。所谓同源是指”协议+域名+端口”三者相同，即便两个不同的域名指向同一个ip地址，也非同源。</p>
<h1 id="同源策略限制以下几种行为："><a href="#同源策略限制以下几种行为：" class="headerlink" title="同源策略限制以下几种行为："></a>同源策略限制以下几种行为：</h1><p>1.) Cookie、LocalStorage 和 IndexDB 无法读取<br>2.) DOM 和 Js对象无法获得<br>3.) AJAX 请求不能发送</p>
<h1 id="常见跨域场景"><a href="#常见跨域场景" class="headerlink" title="常见跨域场景"></a>常见跨域场景</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">URL</span>                                      说明                    是否允许通信</span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com/a.js</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com/b.js         同一域名，不同文件或路径           允许</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com/lab/c.js</span></span><br><span class="line"></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com:8000/a.js</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com/b.js         同一域名，不同端口                不允许</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com/a.js</span></span><br><span class="line"><span class="attr">https</span>:<span class="comment">//www.domain.com/b.js        同一域名，不同协议                不允许</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com/a.js</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//192.168.4.12/b.js           域名和域名对应相同ip              不允许</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain.com/a.js</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//x.domain.com/b.js           主域相同，子域不同                不允许</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//domain.com/c.js</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain1.com/a.js</span></span><br><span class="line"><span class="attr">http</span>:<span class="comment">//www.domain2.com/b.js        不同域名                         不允许</span></span><br></pre></td></tr></table></figure>
<h1 id="跨域解决方案"><a href="#跨域解决方案" class="headerlink" title="跨域解决方案"></a>跨域解决方案</h1><p>1、 通过jsonp跨域<br>2、 <code>document.domain</code> + iframe跨域<br>3、 <code>location.hash</code> + iframe<br>4、 <code>window.name</code> + iframe跨域<br>5、 <code>postMessage</code>跨域<br>6、 跨域资源共享（CORS）<br>7、 nginx代理跨域<br>8、 nodejs中间件代理跨域<br>9、 WebSocket协议跨域</p>
<h1 id="一、-通过jsonp跨域"><a href="#一、-通过jsonp跨域" class="headerlink" title="一、 通过jsonp跨域"></a>一、 通过jsonp跨域</h1><p>通常为了减轻web服务器的负载，我们把js、css，img等静态资源分离到另一台独立域名的服务器上，在html页面中再通过相应的标签从不同域名下加载静态资源，而被浏览器允许，基于此原理，我们可以通过动态创建script，再请求一个带参网址实现跨域通信。</p>
<h2 id="1-）原生实现："><a href="#1-）原生实现：" class="headerlink" title="1.）原生实现："></a>1.）原生实现：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">script.<span class="property">type</span> = <span class="string">&#x27;text/javascript&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传参一个回调函数名给后端，方便后端返回时执行这个在前端定义的回调函数</span></span><br><span class="line">script.<span class="property">src</span> = <span class="string">&#x27;http://www.domain2.com:8080/login?user=admin&amp;callback=handleCallback&#x27;</span>;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调执行函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleCallback</span>(<span class="params">res</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(res));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>服务端返回如下（返回时即执行全局函数）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">handleCallback</span>(&#123;<span class="string">&quot;status&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;user&quot;</span>: <span class="string">&quot;admin&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="2-）jquery-ajax："><a href="#2-）jquery-ajax：" class="headerlink" title="2.）jquery ajax："></a>2.）jquery ajax：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;http://www.domain2.com:8080/login&#x27;</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">    <span class="attr">dataType</span>: <span class="string">&#x27;jsonp&#x27;</span>,  <span class="comment">// 请求方式为jsonp</span></span><br><span class="line">    <span class="attr">jsonpCallback</span>: <span class="string">&quot;handleCallback&quot;</span>,    <span class="comment">// 自定义回调函数名</span></span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="3-）vue-js："><a href="#3-）vue-js：" class="headerlink" title="3.）vue.js："></a>3.）vue.js：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$http</span>.<span class="title function_">jsonp</span>(<span class="string">&#x27;http://www.domain2.com:8080/login&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">params</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">jsonp</span>: <span class="string">&#x27;handleCallback&#x27;</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res); </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="后端node-js代码示例："><a href="#后端node-js代码示例：" class="headerlink" title="后端node.js代码示例："></a>后端node.js代码示例：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> querystring = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>();</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> params = qs.<span class="title function_">parse</span>(req.<span class="property">url</span>.<span class="title function_">split</span>(<span class="string">&#x27;?&#x27;</span>)[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">var</span> fn = params.<span class="property">callback</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// jsonp返回设置</span></span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123; <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/javascript&#x27;</span> &#125;);</span><br><span class="line">    res.<span class="title function_">write</span>(fn + <span class="string">&#x27;(&#x27;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params) + <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">end</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="string">&#x27;8080&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running at port 8080...&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>jsonp缺点</strong>：只能实现get一种请求。</p>
<h1 id="二、-document-domain-iframe跨域"><a href="#二、-document-domain-iframe跨域" class="headerlink" title="二、 document.domain + iframe跨域"></a>二、 document.domain + iframe跨域</h1><p>此方案仅限主域相同，子域不同的跨域应用场景。</p>
<p>实现原理：两个页面都通过js强制设置document.domain为基础主域，就实现了同域。</p>
<p>1.）父窗口：<code>(http://www.domain.com/a.html)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id=<span class="string">&quot;iframe&quot;</span> src=<span class="string">&quot;http://child.domain.com/b.html&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">document</span>.<span class="property">domain</span> = <span class="string">&#x27;domain.com&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> user = <span class="string">&#x27;admin&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>2.）子窗口：<code>(http://child.domain.com/b.html)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">domain</span> = <span class="string">&#x27;domain.com&#x27;</span>;</span><br><span class="line">    <span class="comment">// 获取父窗口中变量</span></span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;get js data from parent ---&gt; &#x27;</span> + <span class="variable language_">window</span>.<span class="property">parent</span>.<span class="property">user</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h1 id="三、-location-hash-iframe跨域"><a href="#三、-location-hash-iframe跨域" class="headerlink" title="三、 location.hash + iframe跨域"></a>三、 <code>location.hash</code> + iframe跨域</h1><p>实现原理： a欲与b跨域相互通信，通过中间页c来实现。 三个页面，不同域之间利用iframe的<code>location.hash</code>传值，相同域之间直接js访问来通信。</p>
<p>具体实现：A域：a.html -&gt; B域：b.html -&gt; A域：c.html，a与b不同域只能通过hash值单向通信，b与c也不同域也只能单向通信，但c与a同域，所以c可通过parent.parent访问a页面所有对象。</p>
<p>1.）a.html：(<code>http://www.domain1.com/a.html</code>)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id=<span class="string">&quot;iframe&quot;</span> src=<span class="string">&quot;http://www.domain2.com/b.html&quot;</span> style=<span class="string">&quot;display:none;&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;iframe&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 向b.html传hash值</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        iframe.<span class="property">src</span> = iframe.<span class="property">src</span> + <span class="string">&#x27;#user=admin&#x27;</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;, <span class="number">1000</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    </span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 开放给同域c.html的回调方法</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">function</span> <span class="title function_">onCallback</span>(<span class="params">res</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="title function_">alert</span>(<span class="string">&#x27;data from c.html ---&gt; &#x27;</span> + res);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>2.）b.html：(<code>http://www.domain2.com/b.html</code>)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id=<span class="string">&quot;iframe&quot;</span> src=<span class="string">&quot;http://www.domain1.com/c.html&quot;</span> style=<span class="string">&quot;display:none;&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;iframe&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 监听a.html传来的hash值，再传给c.html</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">window</span>.<span class="property">onhashchange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        iframe.<span class="property">src</span> = iframe.<span class="property">src</span> + location.<span class="property">hash</span>;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>3.）c.html：(<code>http://www.domain1.com/c.html</code>)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 监听b.html传来的hash值</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">onhashchange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 再通过操作同域a.html的js回调，将结果传回</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="property">parent</span>.<span class="property">parent</span>.<span class="title function_">onCallback</span>(<span class="string">&#x27;hello: &#x27;</span> + location.<span class="property">hash</span>.<span class="title function_">replace</span>(<span class="string">&#x27;#user=&#x27;</span>, <span class="string">&#x27;&#x27;</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h1 id="四、-window-name-iframe跨域"><a href="#四、-window-name-iframe跨域" class="headerlink" title="四、 window.name + iframe跨域"></a>四、 <code>window.name</code> + iframe跨域</h1><p><code>window.name</code>属性的独特之处：name值在不同的页面（甚至不同域名）加载后依旧存在，并且可以支持非常长的 name 值（2MB）。</p>
<p>1.）a.html：(<code>http://www.domain1.com/a.html</code>)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> proxy = <span class="keyword">function</span>(<span class="params">url, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> state = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载跨域页面</span></span><br><span class="line">    iframe.<span class="property">src</span> = url;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// onload事件会触发2次，第1次加载跨域页，并留存数据于window.name</span></span><br><span class="line">    iframe.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (state === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 第2次onload(同域proxy页)成功后，读取同域window.name中数据</span></span><br><span class="line">            <span class="title function_">callback</span>(iframe.<span class="property">contentWindow</span>.<span class="property">name</span>);</span><br><span class="line">            <span class="title function_">destoryFrame</span>();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 第1次onload(跨域页)成功后，切换到同域代理页面</span></span><br><span class="line">            iframe.<span class="property">contentWindow</span>.<span class="property">location</span> = <span class="string">&#x27;http://www.domain1.com/proxy.html&#x27;</span>;</span><br><span class="line">            state = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(iframe);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据以后销毁这个iframe，释放内存；这也保证了安全（不被其他域frame js访问）</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">destoryFrame</span>(<span class="params"></span>) &#123;</span><br><span class="line">        iframe.<span class="property">contentWindow</span>.<span class="property">document</span>.<span class="title function_">write</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">        iframe.<span class="property">contentWindow</span>.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(iframe);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求跨域b页面数据</span></span><br><span class="line"><span class="title function_">proxy</span>(<span class="string">&#x27;http://www.domain2.com/b.html&#x27;</span>, <span class="keyword">function</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="title function_">alert</span>(data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>2.）proxy.html：(<code>http://www.domain1.com/proxy....</code>)<br>中间代理页，与a.html同域，内容为空即可。</p>
<p>3.）b.html：(<code>http://www.domain2.com/b.html</code>)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">name</span> = <span class="string">&#x27;This is domain2 data!&#x27;</span>;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>总结：通过iframe的src属性由外域转向本地域，跨域数据即由iframe的<code>window.name</code>从外域传递到本地域。这个就巧妙地绕过了浏览器的跨域访问限制，但同时它又是安全操作。</p>
<h1 id="五、-postMessage跨域"><a href="#五、-postMessage跨域" class="headerlink" title="五、 postMessage跨域"></a>五、 postMessage跨域</h1><p>postMessage是HTML5 XMLHttpRequest Level 2中的API，且是为数不多可以跨域操作的window属性之一，它可用于解决以下方面的问题：<br>a.） 页面和其打开的新窗口的数据传递<br>b.） 多窗口之间消息传递<br>c.） 页面与嵌套的iframe消息传递<br>d.） 上面三个场景的跨域数据传递</p>
<p>用法：<code>postMessage(data,origin)</code>方法接受两个参数<br><code>data：</code> html5规范支持任意基本类型或可复制的对象，但部分浏览器只支持字符串，所以传参时最好用JSON.stringify()序列化。<br><code>origin：</code> 协议+主机+端口号，也可以设置为”*”，表示可以传递给任意窗口，如果要指定和当前窗口同源的话设置为”&#x2F;“。</p>
<p>1.）a.html：<code>(http://www.domain1.com/a.html)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id=<span class="string">&quot;iframe&quot;</span> src=<span class="string">&quot;http://www.domain2.com/b.html&quot;</span> style=<span class="string">&quot;display:none;&quot;</span>&gt;&lt;/iframe&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">       </span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> iframe = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;iframe&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    iframe.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">var</span> data = &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="attr">name</span>: <span class="string">&#x27;aym&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="comment">// 向domain2传送跨域数据</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        iframe.<span class="property">contentWindow</span>.<span class="title function_">postMessage</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data), <span class="string">&#x27;http://www.domain2.com&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 接受domain2返回数据</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="title function_">alert</span>(<span class="string">&#x27;data from domain2 ---&gt; &#x27;</span> + e.<span class="property">data</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;, <span class="literal">false</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>2.）b.html：(<code>http://www.domain2.com/b.html</code>)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="comment">// 接收domain1的数据</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;data from domain1 ---&gt; &#x27;</span> + e.<span class="property">data</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">data</span>);</span><br><span class="line">        <span class="keyword">if</span> (data) &#123;</span><br><span class="line">            data.<span class="property">number</span> = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理后再发回domain1</span></span><br><span class="line">            <span class="variable language_">window</span>.<span class="property">parent</span>.<span class="title function_">postMessage</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data), <span class="string">&#x27;http://www.domain1.com&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="literal">false</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h1 id="六、-跨域资源共享（CORS）"><a href="#六、-跨域资源共享（CORS）" class="headerlink" title="六、 跨域资源共享（CORS）"></a>六、 跨域资源共享（CORS）</h1><p>普通跨域请求：只服务端设置Access-Control-Allow-Origin即可，前端无须设置，若要带cookie请求：前后端都需要设置。</p>
<p>需注意的是：由于同源策略的限制，所读取的cookie为跨域请求接口所在域的cookie，而非当前页。如果想实现当前页cookie的写入，可参考下文：七、nginx反向代理中设置<code>proxy_cookie_domain</code> 和 八、NodeJs中间件代理中cookieDomainRewrite参数的设置。</p>
<p>目前，所有浏览器都支持该功能(IE8+：IE8&#x2F;9需要使用XDomainRequest对象来支持CORS）)，CORS也已经成为主流的跨域解决方案。</p>
<h2 id="1、-前端设置："><a href="#1、-前端设置：" class="headerlink" title="1、 前端设置："></a>1、 前端设置：</h2><h3 id="1-）原生ajax"><a href="#1-）原生ajax" class="headerlink" title="1.）原生ajax"></a>1.）原生ajax</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前端设置是否带cookie</span></span><br><span class="line">xhr.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>(); <span class="comment">// IE8/9需用window.XDomainRequest兼容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 前端设置是否带cookie</span></span><br><span class="line">xhr.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;http://www.domain2.com:8080/login&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>);</span><br><span class="line">xhr.<span class="title function_">send</span>(<span class="string">&#x27;user=admin&#x27;</span>);</span><br><span class="line"></span><br><span class="line">xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (xhr.<span class="property">readyState</span> == <span class="number">4</span> &amp;&amp; xhr.<span class="property">status</span> == <span class="number">200</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(xhr.<span class="property">responseText</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="2-）jQuery-ajax"><a href="#2-）jQuery-ajax" class="headerlink" title="2.）jQuery ajax"></a>2.）jQuery ajax</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">    ...</span><br><span class="line">   <span class="attr">xhrFields</span>: &#123;</span><br><span class="line">       <span class="attr">withCredentials</span>: <span class="literal">true</span>    <span class="comment">// 前端设置是否带cookie</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">crossDomain</span>: <span class="literal">true</span>,   <span class="comment">// 会让请求头中包含跨域的额外信息，但不会含cookie</span></span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="3-）vue框架"><a href="#3-）vue框架" class="headerlink" title="3.）vue框架"></a>3.）vue框架</h3><p>a.) axios设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="property">defaults</span>.<span class="property">withCredentials</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>b.) vue-resource设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property">http</span>.<span class="property">options</span>.<span class="property">credentials</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="2、-服务端设置："><a href="#2、-服务端设置：" class="headerlink" title="2、 服务端设置："></a>2、 服务端设置：</h2><p>若后端设置成功，前端浏览器控制台则不会出现跨域报错信息，反之，说明没设成功。</p>
<h3 id="1-）Java后台："><a href="#1-）Java后台：" class="headerlink" title="1.）Java后台："></a>1.）Java后台：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 导入包：import javax.servlet.http.HttpServletResponse;</span></span><br><span class="line"><span class="comment"> * 接口参数中定义：HttpServletResponse response</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 允许跨域访问的域名：若有端口需写全（协议+域名+端口），若没有端口末尾不用加&#x27;/&#x27;</span></span><br><span class="line">response.<span class="title function_">setHeader</span>(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;http://www.domain1.com&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 允许前端带认证cookie：启用此项后，上面的域名不能为&#x27;*&#x27;，必须指定具体的域名，否则浏览器会提示</span></span><br><span class="line">response.<span class="title function_">setHeader</span>(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// 提示OPTIONS预检时，后端需要设置的两个常用自定义头</span></span><br><span class="line">response.<span class="title function_">setHeader</span>(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;Content-Type,X-Requested-With&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="2-）Nodejs后台示例："><a href="#2-）Nodejs后台示例：" class="headerlink" title="2.）Nodejs后台示例："></a>2.）Nodejs后台示例：</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>();</span><br><span class="line"><span class="keyword">var</span> qs = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> postData = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据块接收中</span></span><br><span class="line">    req.<span class="title function_">addListener</span>(<span class="string">&#x27;data&#x27;</span>, <span class="keyword">function</span>(<span class="params">chunk</span>) &#123;</span><br><span class="line">        postData += chunk;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据接收完毕</span></span><br><span class="line">    req.<span class="title function_">addListener</span>(<span class="string">&#x27;end&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        postData = qs.<span class="title function_">parse</span>(postData);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 跨域后台设置</span></span><br><span class="line">        res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">            <span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span>: <span class="string">&#x27;true&#x27;</span>,     <span class="comment">// 后端允许发送Cookie</span></span><br><span class="line">            <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;http://www.domain1.com&#x27;</span>,    <span class="comment">// 允许访问的域（协议+域名+端口）</span></span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">             * 此处设置的cookie还是domain2的而非domain1，因为后端也不能跨域写cookie(nginx反向代理可以实现)，</span></span><br><span class="line"><span class="comment">             * 但只要domain2中写入一次cookie认证，后面的跨域接口都能从domain2中获取cookie，从而实现所有的接口都能跨域访问</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="string">&#x27;Set-Cookie&#x27;</span>: <span class="string">&#x27;l=a123456;Path=/;Domain=www.domain2.com;HttpOnly&#x27;</span>  <span class="comment">// HttpOnly的作用是让js无法读取cookie</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        res.<span class="title function_">write</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(postData));</span><br><span class="line">        res.<span class="title function_">end</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="string">&#x27;8080&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running at port 8080...&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h1 id="七、-nginx代理跨域"><a href="#七、-nginx代理跨域" class="headerlink" title="七、 nginx代理跨域"></a>七、 nginx代理跨域</h1><h2 id="1、-nginx配置解决iconfont跨域"><a href="#1、-nginx配置解决iconfont跨域" class="headerlink" title="1、 nginx配置解决iconfont跨域"></a>1、 nginx配置解决iconfont跨域</h2><p>浏览器跨域访问js、css、img等常规静态资源被同源策略许可，但iconfont字体文件(eot|otf|ttf|woff|svg)例外，此时可在nginx的静态资源服务器中加入以下配置。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">  add_header <span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Origin</span> *;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2、-nginx反向代理接口跨域"><a href="#2、-nginx反向代理接口跨域" class="headerlink" title="2、 nginx反向代理接口跨域"></a>2、 nginx反向代理接口跨域</h2><p>跨域原理： 同源策略是浏览器的安全策略，不是HTTP协议的一部分。服务器端调用HTTP接口只是使用HTTP协议，不会执行JS脚本，不需要同源策略，也就不存在跨越问题。</p>
<p>实现思路：通过nginx配置一个代理服务器（域名与domain1相同，端口不同）做跳板机，反向代理访问domain2接口，并且可以顺便修改cookie中domain信息，方便当前域cookie写入，实现跨域登录。</p>
<p>nginx具体配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#proxy服务器</span><br><span class="line">server &#123;</span><br><span class="line">    listen       <span class="number">81</span>;</span><br><span class="line">    server_name  www.<span class="property">domain1</span>.<span class="property">com</span>;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass   <span class="attr">http</span>:<span class="comment">//www.domain2.com:8080;  #反向代理</span></span><br><span class="line">        proxy_cookie_domain www.<span class="property">domain2</span>.<span class="property">com</span> www.<span class="property">domain1</span>.<span class="property">com</span>; #修改cookie里域名</span><br><span class="line">        index  index.<span class="property">html</span> index.<span class="property">htm</span>;</span><br><span class="line"></span><br><span class="line">        # 当用webpack-dev-server等中间件代理接口访问nignx时，此时无浏览器参与，故没有同源限制，下面的跨域配置可不启用</span><br><span class="line">        add_header <span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Origin</span> <span class="attr">http</span>:<span class="comment">//www.domain1.com;  #当前端只跨域不带cookie时，可为*</span></span><br><span class="line">        add_header <span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Credentials</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-前端代码示例："><a href="#1-前端代码示例：" class="headerlink" title="1.) 前端代码示例："></a>1.) 前端代码示例：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前端开关：浏览器是否读写cookie</span></span><br><span class="line">xhr.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问nginx中的代理服务器</span></span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;http://www.domain1.com:81/?user=admin&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">xhr.<span class="title function_">send</span>();</span><br></pre></td></tr></table></figure>
<h2 id="2-Nodejs后台示例："><a href="#2-Nodejs后台示例：" class="headerlink" title="2.) Nodejs后台示例："></a>2.) Nodejs后台示例：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>();</span><br><span class="line"><span class="keyword">var</span> qs = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;request&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> params = qs.<span class="title function_">parse</span>(req.<span class="property">url</span>.<span class="title function_">substring</span>(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向前台写cookie</span></span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">&#x27;Set-Cookie&#x27;</span>: <span class="string">&#x27;l=a123456;Path=/;Domain=www.domain2.com;HttpOnly&#x27;</span>   <span class="comment">// HttpOnly:脚本无法读取</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">write</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(params));</span><br><span class="line">    res.<span class="title function_">end</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="string">&#x27;8080&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running at port 8080...&#x27;</span>);</span><br></pre></td></tr></table></figure>
<h1 id="八、-Nodejs中间件代理跨域"><a href="#八、-Nodejs中间件代理跨域" class="headerlink" title="八、 Nodejs中间件代理跨域"></a>八、 Nodejs中间件代理跨域</h1><p>node中间件实现跨域代理，原理大致与nginx相同，都是通过启一个代理服务器，实现数据的转发，也可以通过设置cookieDomainRewrite参数修改响应头中cookie中域名，实现当前域的cookie写入，方便接口登录认证。</p>
<h2 id="1、-非vue框架的跨域（2次跨域）"><a href="#1、-非vue框架的跨域（2次跨域）" class="headerlink" title="1、 非vue框架的跨域（2次跨域）"></a>1、 非vue框架的跨域（2次跨域）</h2><p>利用node + express + http-proxy-middleware搭建一个proxy服务器。</p>
<p>1.）前端代码示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前端开关：浏览器是否读写cookie</span></span><br><span class="line">xhr.<span class="property">withCredentials</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问http-proxy-middleware代理服务器</span></span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;http://www.domain1.com:3000/login?user=admin&#x27;</span>, <span class="literal">true</span>);</span><br><span class="line">xhr.<span class="title function_">send</span>();</span><br></pre></td></tr></table></figure>
<p>2.）中间件服务器：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> proxy = <span class="built_in">require</span>(<span class="string">&#x27;http-proxy-middleware&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&#x27;/&#x27;</span>, <span class="title function_">proxy</span>(&#123;</span><br><span class="line">    <span class="comment">// 代理跨域目标接口</span></span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;http://www.domain2.com:8080&#x27;</span>,</span><br><span class="line">    <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改响应头信息，实现跨域并允许带cookie</span></span><br><span class="line">    <span class="attr">onProxyRes</span>: <span class="keyword">function</span>(<span class="params">proxyRes, req, res</span>) &#123;</span><br><span class="line">        res.<span class="title function_">header</span>(<span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="string">&#x27;http://www.domain1.com&#x27;</span>);</span><br><span class="line">        res.<span class="title function_">header</span>(<span class="string">&#x27;Access-Control-Allow-Credentials&#x27;</span>, <span class="string">&#x27;true&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改响应信息中的cookie域名</span></span><br><span class="line">    <span class="attr">cookieDomainRewrite</span>: <span class="string">&#x27;www.domain1.com&#x27;</span>  <span class="comment">// 可以为false，表示不修改</span></span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Proxy server is listen at port 3000...&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>3.）Nodejs后台同（六：nginx）</p>
<h2 id="2、-vue框架Vue-cli2-0的跨域（1次跨域）"><a href="#2、-vue框架Vue-cli2-0的跨域（1次跨域）" class="headerlink" title="2、 vue框架Vue-cli2.0的跨域（1次跨域）"></a>2、 vue框架Vue-cli2.0的跨域（1次跨域）</h2><p>利用node + webpack + webpack-dev-server代理接口跨域。在开发环境下，由于vue渲染服务和接口代理服务都是<code>webpack-dev-server</code>同一个，所以页面与代理接口之间不再跨域，无须设置headers跨域信息了。</p>
<p>webpack.config.js部分配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">entry</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">module</span>: &#123;&#125;,</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">devServer</span>: &#123;</span><br><span class="line">        <span class="attr">historyApiFallback</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">proxy</span>: [&#123;</span><br><span class="line">            <span class="attr">context</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">            <span class="attr">target</span>: <span class="string">&#x27;http://www.domain2.com:8080&#x27;</span>,  <span class="comment">// 代理跨域目标接口</span></span><br><span class="line">            <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">secure</span>: <span class="literal">false</span>,  <span class="comment">// 当代理某些https服务报错时用</span></span><br><span class="line">            <span class="attr">cookieDomainRewrite</span>: <span class="string">&#x27;www.domain1.com&#x27;</span>  <span class="comment">// 可以为false，表示不修改</span></span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="attr">noInfo</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-vue-cli3-0的跨域"><a href="#3-vue-cli3-0的跨域" class="headerlink" title="3. vue-cli3.0的跨域"></a>3. vue-cli3.0的跨域</h2><p>在根目录新建<code>vue.config.js</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//vue.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">devServer</span>:&#123;</span><br><span class="line">    <span class="attr">open</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">host</span>:<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>:<span class="number">8080</span>,</span><br><span class="line">    <span class="attr">https</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="attr">hotOnly</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="attr">proxy</span>:&#123;</span><br><span class="line">      <span class="comment">//配置跨域</span></span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>:&#123;</span><br><span class="line">        <span class="attr">target</span>:<span class="string">&#x27;http://localhost:5000/api&#x27;</span>,</span><br><span class="line">        <span class="attr">ws</span>:<span class="literal">true</span>, <span class="comment">//websockets</span></span><br><span class="line">        <span class="attr">changOrigin</span>:<span class="literal">true</span>,</span><br><span class="line">        <span class="attr">pathRewrite</span>:&#123;</span><br><span class="line">          <span class="string">&#x27;^/api&#x27;</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="九、-WebSocket协议跨域"><a href="#九、-WebSocket协议跨域" class="headerlink" title="九、 WebSocket协议跨域"></a>九、 WebSocket协议跨域</h1><p>WebSocket protocol是HTML5一种新的协议。它实现了浏览器与服务器全双工通信，同时允许跨域通讯，是server push技术的一种很好的实现。<br>原生WebSocket API使用起来不太方便，我们使用Socket.io，它很好地封装了webSocket接口，提供了更简单、灵活的接口，也对不支持webSocket的浏览器提供了向下兼容。</p>
<h2 id="1-）前端代码："><a href="#1-）前端代码：" class="headerlink" title="1.）前端代码："></a>1.）前端代码：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;user input：&lt;input type=<span class="string">&quot;text&quot;</span>&gt;&lt;/div&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/socket.io/2.2.0/socket.io.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">var</span> socket = <span class="title function_">io</span>(<span class="string">&#x27;http://www.domain2.com:8080&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// 连接成功处理</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">socket.<span class="title function_">on</span>(<span class="string">&#x27;connect&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 监听服务端消息</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    socket.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">msg</span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data from server: ---&gt; &#x27;</span> + msg); </span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 监听服务端关闭</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    socket.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123; </span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server socket has closed.&#x27;</span>); </span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;input&#x27;</span>)[<span class="number">0</span>].<span class="property">onblur</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    socket.<span class="title function_">send</span>(<span class="variable language_">this</span>.<span class="property">value</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h2 id="2-）Nodejs-socket后台："><a href="#2-）Nodejs-socket后台：" class="headerlink" title="2.）Nodejs socket后台："></a>2.）Nodejs socket后台：</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> socket = <span class="built_in">require</span>(<span class="string">&#x27;socket.io&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启http服务</span></span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">    res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">&#x27;Content-type&#x27;</span>: <span class="string">&#x27;text/html&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.<span class="title function_">end</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="string">&#x27;8080&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Server is running at port 8080...&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听socket连接</span></span><br><span class="line">socket.<span class="title function_">listen</span>(server).<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="keyword">function</span>(<span class="params">client</span>) &#123;</span><br><span class="line">    <span class="comment">// 接收信息</span></span><br><span class="line">    client.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="keyword">function</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">        client.<span class="title function_">send</span>(<span class="string">&#x27;hello：&#x27;</span> + msg);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;data from client: ---&gt; &#x27;</span> + msg);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 断开处理</span></span><br><span class="line">    client.<span class="title function_">on</span>(<span class="string">&#x27;disconnect&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Client socket has closed.&#x27;</span>); </span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/03/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E8%B7%A8%E5%9F%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" data-id="cl9xpujru0041dmopbuhbfhdc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-虚拟dom" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/28/%E8%99%9A%E6%8B%9Fdom/" class="article-date">
  <time datetime="2019-11-28T11:21:32.000Z" itemprop="datePublished">2019-11-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/28/%E8%99%9A%E6%8B%9Fdom/">虚拟dom</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一、真实DOM和其解析流程<br>本节我们主要介绍真实 DOM 的解析过程，通过介绍其解析过程以及存在的问题，从而引出为什么需要虚拟DOM。一图胜千言，如下图为 webkit 渲染引擎工作流程图<br><img src="https://s2.ax1x.com/2019/11/28/QFFJz9.png" alt="QFFJz9.png"><br>所有的浏览器渲染引擎工作流程大致分为5步：创建 DOM 树 —&gt; 创建 Style Rules -&gt; 构建 Render 树 —&gt; 布局 Layout -—&gt; 绘制 Painting。</p>
<p>第一步，构建 DOM 树：用 HTML 分析器，分析 HTML 元素，构建一棵 DOM 树；</p>
<p>第二步，生成样式表：用 CSS 分析器，分析 CSS 文件和元素上的 inline 样式，生成页面的样式表；</p>
<p>第三步，构建 Render 树：将 DOM 树和样式表关联起来，构建一棵 Render 树（Attachment）。每个 DOM 节点都有 attach 方法，接受样式信息，返回一个 render 对象（又名 renderer），这些 render 对象最终会被构建成一棵 Render 树；</p>
<p>第四步，确定节点坐标：根据 Render 树结构，为每个 Render 树上的节点确定一个在显示屏上出现的精确坐标；</p>
<p>第五步，绘制页面：根据 Render 树和节点显示坐标，然后调用每个节点的 paint 方法，将它们绘制出来。</p>
<h4 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a>注意点：</h4><p>1、DOM 树的构建是文档加载完成开始的？ 构建 DOM 树是一个渐进过程，为达到更好的用户体验，渲染引擎会尽快将内容显示在屏幕上，它不必等到整个 HTML 文档解析完成之后才开始构建 render 树和布局。</p>
<p>2、Render 树是 DOM 树和 CSS 样式表构建完毕后才开始构建的？ 这三个过程在实际进行的时候并不是完全独立的，而是会有交叉，会一边加载，一边解析，以及一边渲染。</p>
<p>3、CSS 的解析注意点？ CSS 的解析是从右往左逆向解析的，嵌套标签越多，解析越慢。</p>
<p>4、JS 操作真实 DOM 的代价？ 用我们传统的开发模式，原生 JS 或 JQ 操作 DOM 时，浏览器会从构建 DOM 树开始从头到尾执行一遍流程。在一次操作中，我需要更新 10 个 DOM 节点，浏览器收到第一个 DOM 请求后并不知道还有 9 次更新操作，因此会马上执行流程，最终执行10 次。例如，第一次计算完，紧接着下一个 DOM 更新请求，这个节点的坐标值就变了，前一次计算为无用功。计算 DOM 节点坐标值等都是白白浪费的性能。即使计算机硬件一直在迭代更新，操作 DOM 的代价仍旧是昂贵的，频繁操作还是会出现页面卡顿，影响用户体验</p>
<h1 id="二、Virtual-DOM-基础"><a href="#二、Virtual-DOM-基础" class="headerlink" title="二、Virtual-DOM 基础"></a>二、Virtual-DOM 基础</h1><h2 id="2-1、虚拟-DOM-的好处"><a href="#2-1、虚拟-DOM-的好处" class="headerlink" title="2.1、虚拟 DOM 的好处"></a>2.1、虚拟 DOM 的好处</h2><p>​ 虚拟 DOM 就是为了解决浏览器性能问题而被设计出来的。如前，若一次操作中有 10 次更新 DOM 的动作，虚拟 DOM 不会立即操作 DOM，而是将这 10 次更新的 diff 内容保存到本地一个 JS 对象中，最终将这个 JS 对象一次性 attch 到 DOM 树上，再进行后续操作，避免大量无谓的计算量。所以，用 JS 对象模拟 DOM 节点的好处是，页面的更新可以先全部反映在 JS 对象(虚拟 DOM )上，操作内存中的 JS 对象的速度显然要更快，等更新完成后，再将最终的 JS 对象映射成真实的 DOM，交由浏览器去绘制。</p>
<h2 id="2-2、算法实现"><a href="#2-2、算法实现" class="headerlink" title="2.2、算法实现"></a>2.2、算法实现</h2><h3 id="2-2-1、用-JS-对象模拟-DOM-树"><a href="#2-2-1、用-JS-对象模拟-DOM-树" class="headerlink" title="2.2.1、用 JS 对象模拟 DOM 树"></a>2.2.1、用 JS 对象模拟 DOM 树</h3><h4 id="（1）如何用-JS-对象模拟-DOM-树"><a href="#（1）如何用-JS-对象模拟-DOM-树" class="headerlink" title="（1）如何用 JS 对象模拟 DOM 树"></a>（1）如何用 JS 对象模拟 DOM 树</h4><p>例如一个真实的 DOM 节点如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;virtual-dom&quot;</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Virtual DOM<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt; </span><br></pre></td></tr></table></figure>
<p>我们用 JavaScript 对象来表示 DOM 节点，使用对象的属性记录节点的类型、属性、子节点等。</p>
<p>element.js 中表示节点对象代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Element virdual-dom 对象定义</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; <span class="variable">tagName</span> - dom 元素名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">props</span> - dom 属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array&lt;Element|String&gt;</span>&#125; - 子节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Element</span>(<span class="params">tagName, props, children</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tagName</span> = tagName</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span> = props</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="comment">// dom 元素的 key 值，用作唯一标识符</span></span><br><span class="line">    <span class="keyword">if</span>(props.<span class="property">key</span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">key</span> = props.<span class="property">key</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span></span><br><span class="line">    children.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">child, i</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (child <span class="keyword">instanceof</span> <span class="title class_">Element</span>) &#123;</span><br><span class="line">            count += child.<span class="property">count</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            children[i] = <span class="string">&#x27;&#x27;</span> + child</span><br><span class="line">        &#125;</span><br><span class="line">        count++</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 子元素个数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">count</span> = count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">tagName, props, children</span>)&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Element</span>(tagName, props, children);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = createElement;</span><br></pre></td></tr></table></figure>
<p>根据 element 对象的设定，则上面的 DOM 结构就可以简单表示为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> el = <span class="built_in">require</span>(<span class="string">&quot;./element.js&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> ul = <span class="title function_">el</span>(<span class="string">&#x27;div&#x27;</span>,&#123;<span class="attr">id</span>:<span class="string">&#x27;virtual-dom&#x27;</span>&#125;,[</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;p&#x27;</span>,&#123;&#125;,[<span class="string">&#x27;Virtual DOM&#x27;</span>]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;ul&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;list&#x27;</span> &#125;, [</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 1&#x27;</span>]),</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 2&#x27;</span>]),</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 3&#x27;</span>])</span><br><span class="line">  ]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;div&#x27;</span>,&#123;&#125;,[<span class="string">&#x27;Hello World&#x27;</span>])</span><br><span class="line">]) </span><br></pre></td></tr></table></figure>
<p>现在 ul 就是我们用 JavaScript 对象表示的 DOM 结构，我们输出查看 ul 对应的数据结构如下：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFE3i8.png" alt="QFE3i8.png"></p>
<h4 id="（2）渲染用-JS-表示的-DOM-对象"><a href="#（2）渲染用-JS-表示的-DOM-对象" class="headerlink" title="（2）渲染用 JS 表示的 DOM 对象"></a>（2）渲染用 JS 表示的 DOM 对象</h4><p>但是页面上并没有这个结构，下一步我们介绍如何将 ul 渲染成页面上真实的 DOM 结构，相关渲染函数如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * render 将virdual-dom 对象渲染为实际 DOM 元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Element</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">render</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="variable language_">this</span>.<span class="property">tagName</span>)</span><br><span class="line">    <span class="keyword">var</span> props = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">    <span class="comment">// 设置节点的DOM属性</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> propName <span class="keyword">in</span> props) &#123;</span><br><span class="line">        <span class="keyword">var</span> propValue = props[propName]</span><br><span class="line">        el.<span class="title function_">setAttribute</span>(propName, propValue)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> children = <span class="variable language_">this</span>.<span class="property">children</span> || []</span><br><span class="line">    children.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">child</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> childEl = (child <span class="keyword">instanceof</span> <span class="title class_">Element</span>)</span><br><span class="line">            ? child.<span class="title function_">render</span>() <span class="comment">// 如果子节点也是虚拟DOM，递归构建DOM节点</span></span><br><span class="line">            : <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(child) <span class="comment">// 如果字符串，只构建文本节点</span></span><br><span class="line">        el.<span class="title function_">appendChild</span>(childEl)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>我们通过查看以上 render 方法，会根据 tagName 构建一个真正的 DOM 节点，然后设置这个节点的属性，最后递归地把自己的子节点也构建起来。</p>
<p>我们将构建好的 DOM 结构添加到页面 body 上面，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulRoot = ul.<span class="title function_">render</span>();</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ulRoot); </span><br></pre></td></tr></table></figure>
<p>这样，页面 body 里面就有真正的 DOM 结构，效果如下图所示：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFSQaQ.png" alt="QFSQaQ.png"></p>
<h3 id="2-2-2、比较两棵虚拟-DOM-树的差异-—-diff-算法"><a href="#2-2-2、比较两棵虚拟-DOM-树的差异-—-diff-算法" class="headerlink" title="2.2.2、比较两棵虚拟 DOM 树的差异 — diff 算法"></a>2.2.2、比较两棵虚拟 DOM 树的差异 — diff 算法</h3><p>diff 算法用来比较两棵 Virtual DOM 树的差异，如果需要两棵树的完全比较，那么 diff 算法的时间复杂度为O(n^3)。但是在前端当中，你很少会跨越层级地移动 DOM 元素，所以 Virtual DOM 只会对同一个层级的元素进行对比，如下图所示， div 只会和同一层级的 div 对比，第二层级的只会跟第二层级对比，这样算法复杂度就可以达到 O(n)。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFSwa4.png" alt="QFSwa4.png"></p>
<p>####（1）深度优先遍历，记录差异</p>
<p>在实际的代码中，会对新旧两棵树进行一个深度优先的遍历，这样每个节点都会有一个唯一的标记：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFScM6.png" alt="QFScM6.png"></p>
<p>在深度优先遍历的时候，每遍历到一个节点就把该节点和新的的树进行对比。如果有差异的话就记录到一个对象里面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// diff 函数，对比两棵树</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">diff</span>(<span class="params">oldTree, newTree</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">0</span> <span class="comment">// 当前节点的标志</span></span><br><span class="line">  <span class="keyword">var</span> patches = &#123;&#125; <span class="comment">// 用来记录每个节点差异的对象</span></span><br><span class="line">  <span class="title function_">dfsWalk</span>(oldTree, newTree, index, patches)</span><br><span class="line">  <span class="keyword">return</span> patches</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对两棵树进行深度优先遍历</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dfsWalk</span>(<span class="params">oldNode, newNode, index, patches</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> currentPatch = []</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> (oldNode) === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> (newNode) === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 文本内容改变</span></span><br><span class="line">    <span class="keyword">if</span> (newNode !== oldNode) &#123;</span><br><span class="line">      currentPatch.<span class="title function_">push</span>(&#123; <span class="attr">type</span>: patch.<span class="property">TEXT</span>, <span class="attr">content</span>: newNode &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newNode!=<span class="literal">null</span> &amp;&amp; oldNode.<span class="property">tagName</span> === newNode.<span class="property">tagName</span> &amp;&amp; oldNode.<span class="property">key</span> === newNode.<span class="property">key</span>) &#123;</span><br><span class="line">    <span class="comment">// 节点相同，比较属性</span></span><br><span class="line">    <span class="keyword">var</span> propsPatches = <span class="title function_">diffProps</span>(oldNode, newNode)</span><br><span class="line">    <span class="keyword">if</span> (propsPatches) &#123;</span><br><span class="line">      currentPatch.<span class="title function_">push</span>(&#123; <span class="attr">type</span>: patch.<span class="property">PROPS</span>, <span class="attr">props</span>: propsPatches &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 比较子节点，如果子节点有&#x27;ignore&#x27;属性，则不需要比较</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isIgnoreChildren</span>(newNode)) &#123;</span><br><span class="line">      <span class="title function_">diffChildren</span>(</span><br><span class="line">        oldNode.<span class="property">children</span>,</span><br><span class="line">        newNode.<span class="property">children</span>,</span><br><span class="line">        index,</span><br><span class="line">        patches,</span><br><span class="line">        currentPatch</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(newNode !== <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="comment">// 新节点和旧节点不同，用 replace 替换</span></span><br><span class="line">    currentPatch.<span class="title function_">push</span>(&#123; <span class="attr">type</span>: patch.<span class="property">REPLACE</span>, <span class="attr">node</span>: newNode &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (currentPatch.<span class="property">length</span>) &#123;</span><br><span class="line">    patches[index] = currentPatch</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>从以上可以得出，patches[1] 表示 p ，patches[3] 表示 ul ，以此类推。</p>
<h4 id="（2）差异类型"><a href="#（2）差异类型" class="headerlink" title="（2）差异类型"></a>（2）差异类型</h4><p>DOM 操作导致的差异类型包括以下几种：</p>
<p>节点替换：节点改变了，例如将上面的 div 换成 h1;<br>顺序互换：移动、删除、新增子节点，例如上面 div 的子节点，把 p 和 ul 顺序互换；<br>属性更改：修改了节点的属性，例如把上面 li 的 class 样式类删除；<br>文本改变：改变文本节点的文本内容，例如将上面 p 节点的文本内容更改为 “Real Dom”；<br>以上描述的几种差异类型在代码中定义如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">REPLACE</span> = <span class="number">0</span> <span class="comment">// 替换原先的节点</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">REORDER</span> = <span class="number">1</span> <span class="comment">// 重新排序</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">PROPS</span> = <span class="number">2</span> <span class="comment">// 修改了节点的属性</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TEXT</span> = <span class="number">3</span> <span class="comment">// 文本内容改变 </span></span><br></pre></td></tr></table></figure>
<p>####（3）列表对比算法</p>
<p>​ 子节点的对比算法，例如 p, ul, div 的顺序换成了 div, p, ul。这个该怎么对比？如果按照同层级进行顺序对比的话，它们都会被替换掉。如 p 和 div 的 tagName 不同，p 会被 div 所替代。最终，三个节点都会被替换，这样 DOM 开销就非常大。而实际上是不需要替换节点，而只需要经过节点移动就可以达到，我们只需知道怎么进行移动。</p>
<p>​ 将这个问题抽象出来其实就是字符串的最小编辑距离问题（Edition Distance），最常见的解决方法是 Levenshtein Distance , Levenshtein Distance 是一个度量两个字符序列之间差异的字符串度量标准，两个单词之间的 Levenshtein Distance 是将一个单词转换为另一个单词所需的单字符编辑（插入、删除或替换）的最小数量。Levenshtein Distance 是1965年由苏联数学家 Vladimir Levenshtein 发明的。Levenshtein Distance 也被称为编辑距离（Edit Distance），通过动态规划求解，时间复杂度为 O(M*N)。</p>
<p>定义：对于两个字符串 a、b，则他们的 Levenshtein Distance 为：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFp50U.png" alt="QFp50U.png"></p>
<p>示例：字符串 a 和 b，a&#x3D;“abcde” ，b&#x3D;“cabef”，根据上面给出的计算公式，则他们的 Levenshtein Distance 的计算过程如下：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFpTk4.png" alt="QFpTk4.png"><br>本文的 demo 使用插件 list-diff2 算法进行比较，该算法的时间复杂度伟 O(n*m)，虽然该算法并非最优的算法，但是用于对于 dom 元素的常规操作是足够的。该算法具体的实现过程这里不再详细介绍，该算法的具体介绍可以参照：<a target="_blank" rel="noopener" href="https://github.com/livoras/list-diff">https://github.com/livoras/list-diff</a></p>
<p>（4）实例输出</p>
<p>两个虚拟 DOM 对象如下图所示，其中 ul1 表示原有的虚拟 DOM 树，ul2 表示改变后的虚拟 DOM 树</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ul1 = <span class="title function_">el</span>(<span class="string">&#x27;div&#x27;</span>,&#123;<span class="attr">id</span>:<span class="string">&#x27;virtual-dom&#x27;</span>&#125;,[</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;p&#x27;</span>,&#123;&#125;,[<span class="string">&#x27;Virtual DOM&#x27;</span>]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;ul&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;list&#x27;</span> &#125;, [</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 1&#x27;</span>]),</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 2&#x27;</span>]),</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 3&#x27;</span>])</span><br><span class="line">  ]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;div&#x27;</span>,&#123;&#125;,[<span class="string">&#x27;Hello World&#x27;</span>])</span><br><span class="line">]) </span><br><span class="line"><span class="keyword">var</span> ul2 = <span class="title function_">el</span>(<span class="string">&#x27;div&#x27;</span>,&#123;<span class="attr">id</span>:<span class="string">&#x27;virtual-dom&#x27;</span>&#125;,[</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;p&#x27;</span>,&#123;&#125;,[<span class="string">&#x27;Virtual DOM&#x27;</span>]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;ul&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;list&#x27;</span> &#125;, [</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 21&#x27;</span>]),</span><br><span class="line">	<span class="title function_">el</span>(<span class="string">&#x27;li&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;item&#x27;</span> &#125;, [<span class="string">&#x27;Item 23&#x27;</span>])</span><br><span class="line">  ]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&#x27;p&#x27;</span>,&#123;&#125;,[<span class="string">&#x27;Hello World&#x27;</span>])</span><br><span class="line">]) </span><br><span class="line"><span class="keyword">var</span> patches = <span class="title function_">diff</span>(ul1,ul2);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;patches:&#x27;</span>,patches);</span><br></pre></td></tr></table></figure>
<p>我们查看输出的两个虚拟 DOM 对象之间的差异对象如下图所示，我们能通过差异对象得到，两个虚拟 DOM 对象之间进行了哪些变化，从而根据这个差异对象（patches）更改原先的真实 DOM 结构，从而将页面的 DOM 结构进行更改。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFp7tJ.png" alt="QFp7tJ.png"></p>
<h3 id="2-2-3、将两个虚拟-DOM-对象的差异应用到真正的-DOM-树"><a href="#2-2-3、将两个虚拟-DOM-对象的差异应用到真正的-DOM-树" class="headerlink" title="2.2.3、将两个虚拟 DOM 对象的差异应用到真正的 DOM 树"></a>2.2.3、将两个虚拟 DOM 对象的差异应用到真正的 DOM 树</h3><h4 id="（1）深度优先遍历-DOM-树"><a href="#（1）深度优先遍历-DOM-树" class="headerlink" title="（1）深度优先遍历 DOM 树"></a>（1）深度优先遍历 DOM 树</h4><p>​ 因为步骤一所构建的 JavaScript 对象树和 render 出来真正的 DOM 树的信息、结构是一样的。所以我们可以对那棵 DOM 树也进行深度优先的遍历，遍历的时候从步骤二生成的 patches 对象中找出当前遍历的节点差异，如下相关代码所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span> (node, patches) &#123;</span><br><span class="line">  <span class="keyword">var</span> walker = &#123;<span class="attr">index</span>: <span class="number">0</span>&#125;</span><br><span class="line">  <span class="title function_">dfsWalk</span>(node, walker, patches)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dfsWalk</span> (node, walker, patches) &#123;</span><br><span class="line">  <span class="comment">// 从patches拿出当前节点的差异</span></span><br><span class="line">  <span class="keyword">var</span> currentPatches = patches[walker.<span class="property">index</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> len = node.<span class="property">childNodes</span></span><br><span class="line">    ? node.<span class="property">childNodes</span>.<span class="property">length</span></span><br><span class="line">    : <span class="number">0</span></span><br><span class="line">  <span class="comment">// 深度遍历子节点</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> child = node.<span class="property">childNodes</span>[i]</span><br><span class="line">    walker.<span class="property">index</span>++</span><br><span class="line">    <span class="title function_">dfsWalk</span>(child, walker, patches)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 对当前节点进行DOM操作</span></span><br><span class="line">  <span class="keyword">if</span> (currentPatches) &#123;</span><br><span class="line">    <span class="title function_">applyPatches</span>(node, currentPatches)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h4 id="（2）对原有-DOM-树进行-DOM-操作"><a href="#（2）对原有-DOM-树进行-DOM-操作" class="headerlink" title="（2）对原有 DOM 树进行 DOM 操作"></a>（2）对原有 DOM 树进行 DOM 操作</h4><p>我们根据不同类型的差异对当前节点进行不同的 DOM 操作 ，例如如果进行了节点替换，就进行节点替换 DOM 操作；如果节点文本发生了改变，则进行文本替换的 DOM 操作；以及子节点重排、属性改变等 DOM 操作，相关代码如 applyPatches 所示 ：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">applyPatches</span> (node, currentPatches) &#123;</span><br><span class="line">  currentPatches.<span class="title function_">forEach</span>(<span class="function"><span class="params">currentPatch</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (currentPatch.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REPLACE</span>:</span><br><span class="line">        <span class="keyword">var</span> newNode = (<span class="keyword">typeof</span> currentPatch.<span class="property">node</span> === <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">          ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(currentPatch.<span class="property">node</span>)</span><br><span class="line">          : currentPatch.<span class="property">node</span>.<span class="title function_">render</span>()</span><br><span class="line">        node.<span class="property">parentNode</span>.<span class="title function_">replaceChild</span>(newNode, node)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REORDER</span>:</span><br><span class="line">        <span class="title function_">reorderChildren</span>(node, currentPatch.<span class="property">moves</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">PROPS</span>:</span><br><span class="line">        <span class="title function_">setProps</span>(node, currentPatch.<span class="property">props</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">TEXT</span>:</span><br><span class="line">        node.<span class="property">textContent</span> = currentPatch.<span class="property">content</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Unknown patch type &#x27;</span> + currentPatch.<span class="property">type</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h4 id="（3）DOM结构改变"><a href="#（3）DOM结构改变" class="headerlink" title="（3）DOM结构改变"></a>（3）DOM结构改变</h4><p>通过将第 2.2.2 得到的两个 DOM 对象之间的差异，应用到第一个（原先）DOM 结构中，我们可以看到 DOM 结构进行了预期的变化，如下图所示：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFpI7F.png" alt="QFpI7F.png"></p>
<h2 id="2-3、结语"><a href="#2-3、结语" class="headerlink" title="2.3、结语"></a>2.3、结语</h2><p>Virtual DOM 算法主要实现上面三个步骤来实现：</p>
<p>用 JS 对象模拟 DOM 树 — element.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;virtual-dom&quot;</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Virtual DOM<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt; </span><br></pre></td></tr></table></figure>
<p>比较两棵虚拟 DOM 树的差异 — diff.js</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9XCj.png" alt="QF9XCj.png"></p>
<p>将两个虚拟 DOM 对象的差异应用到真正的 DOM 树 — patch.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">applyPatches</span> (node, currentPatches) &#123;</span><br><span class="line">  currentPatches.<span class="title function_">forEach</span>(<span class="function"><span class="params">currentPatch</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (currentPatch.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REPLACE</span>:</span><br><span class="line">        <span class="keyword">var</span> newNode = (<span class="keyword">typeof</span> currentPatch.<span class="property">node</span> === <span class="string">&#x27;string&#x27;</span>)</span><br><span class="line">          ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(currentPatch.<span class="property">node</span>)</span><br><span class="line">          : currentPatch.<span class="property">node</span>.<span class="title function_">render</span>()</span><br><span class="line">        node.<span class="property">parentNode</span>.<span class="title function_">replaceChild</span>(newNode, node)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REORDER</span>:</span><br><span class="line">        <span class="title function_">reorderChildren</span>(node, currentPatch.<span class="property">moves</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">PROPS</span>:</span><br><span class="line">        <span class="title function_">setProps</span>(node, currentPatch.<span class="property">props</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="attr">TEXT</span>:</span><br><span class="line">        node.<span class="property">textContent</span> = currentPatch.<span class="property">content</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Unknown patch type &#x27;</span> + currentPatch.<span class="property">type</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h1 id="三、Vue-源码-Virtual-DOM-简析"><a href="#三、Vue-源码-Virtual-DOM-简析" class="headerlink" title="三、Vue 源码 Virtual-DOM 简析"></a>三、Vue 源码 Virtual-DOM 简析</h1><p>我们从第二章节（Virtual-DOM 基础）中已经掌握 Virtual DOM 渲染成真实的 DOM 实际上要经历 VNode 的定义、diff、patch 等过程，所以本章节 Vue 源码的解析也按这几个过程来简析。</p>
<h2 id="3-1、VNode-模拟-DOM-树"><a href="#3-1、VNode-模拟-DOM-树" class="headerlink" title="3.1、VNode 模拟 DOM 树"></a>3.1、VNode 模拟 DOM 树</h2><h3 id="3-1-1、VNode-类简析"><a href="#3-1-1、VNode-类简析" class="headerlink" title="3.1.1、VNode 类简析"></a>3.1.1、VNode 类简析</h3><p>在 Vue.js 中，Virtual DOM 是用 VNode 这个 Class 去描述，它定义在 src&#x2F;core&#x2F;vdom&#x2F;vnode.js 中 ，从以下代码块中可以看到 Vue.js 中的 Virtual DOM 的定义较为复杂一些，因为它这里包含了很多 Vue.js 的特性。实际上 Vue.js 中 Virtual DOM 是借鉴了一个开源库  snabbdom 的实现，然后加入了一些 Vue.js 的一些特性。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;;</span><br><span class="line">  <span class="attr">text</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">ns</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// rendered in this component&#x27;s scope</span></span><br><span class="line">  <span class="attr">key</span>: string | number | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="keyword">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  <span class="attr">raw</span>: boolean; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  <span class="attr">isStatic</span>: boolean; <span class="comment">// hoisted static node</span></span><br><span class="line">  <span class="attr">isRootInsert</span>: boolean; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  <span class="attr">isComment</span>: boolean; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  <span class="attr">isCloned</span>: boolean; <span class="comment">// is a cloned node?</span></span><br><span class="line">  <span class="attr">isOnce</span>: boolean; <span class="comment">// is a v-once node?</span></span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="keyword">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: boolean;</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span>; <span class="comment">// for SSR caching</span></span><br><span class="line">  <span class="attr">devtoolsMeta</span>: ?<span class="title class_">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?string; <span class="comment">// functional scope id support</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (</span><br><span class="line">    tag?: string,</span><br><span class="line">    data?: <span class="title class_">VNodeData</span>,</span><br><span class="line">    children?: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;,</span><br><span class="line">    text?: string,</span><br><span class="line">    elm?: <span class="title class_">Node</span>,</span><br><span class="line">    context?: <span class="title class_">Component</span>,</span><br><span class="line">    componentOptions?: <span class="title class_">VNodeComponentOptions</span>,</span><br><span class="line">    asyncFactory?: <span class="title class_">Function</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里千万不要因为 VNode 的这么属性而被吓到，或者咬紧牙去摸清楚每个属性的意义，其实，我们主要了解其几个核心的关键属性就差不多了，例如：</p>
<ul>
<li><code>tag</code> 属性即这个vnode的标签属性</li>
<li><code>data</code> 属性包含了最后渲染成真实dom节点后，节点上的class，attribute，style以及绑定的事件</li>
<li><code>children</code> 属性是vnode的子节点</li>
<li><code>text</code> 属性是文本属性</li>
<li><code>elm</code> 属性为这个vnode对应的真实dom节点</li>
<li><code>key</code> 属性是vnode的标记，在diff过程中可以提高diff的效率</li>
</ul>
<h3 id="3-1-2、源码创建-VNode-过程"><a href="#3-1-2、源码创建-VNode-过程" class="headerlink" title="3.1.2、源码创建 VNode 过程"></a>3.1.2、源码创建 VNode 过程</h3><h4 id="（1）初始化-vue"><a href="#（1）初始化-vue" class="headerlink" title="（1）初始化 vue"></a>（1）初始化 vue</h4><p>我们在实例化一个 vue 实例，也即 new Vue( ) 时，实际上是执行 src&#x2F;core&#x2F;instance&#x2F;index.js 中定义的 Function 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (options) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过查看 Vue 的 function，我们知道 Vue 只能通过 new 关键字初始化，然后调用 this._init 方法，该方法在 src&#x2F;core&#x2F;instance&#x2F;init.js 中定义。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 省略一系列其它初始化的代码</span></span><br><span class="line">    </span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;vm.$options.el:&#x27;</span>,vm.<span class="property">$options</span>.<span class="property">el</span>);</span><br><span class="line">    vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="（2）Vue-实例挂载"><a href="#（2）Vue-实例挂载" class="headerlink" title="（2）Vue 实例挂载"></a>（2）Vue 实例挂载</h4><p>Vue 中是通过 $mount 实例方法去挂载 dom 的，下面我们通过分析 compiler 版本的 mount 实现，相关源码在目录 src&#x2F;platforms&#x2F;web&#x2F;entry-runtime-with-compiler.js 文件中定义：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mount = <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el)</span><br><span class="line">  </span><br><span class="line">   <span class="comment">// 省略一系列初始化以及逻辑判断代码  </span></span><br><span class="line"> </span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现最终还是调用用原先原型上的 $mount 方法挂载 ，原先原型上的 $mount 方法在 src&#x2F;platforms&#x2F;web&#x2F;runtime&#x2F;index.js 中定义 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现$mount 方法实际上会去调用 mountComponent 方法，这个方法定义在 src&#x2F;core&#x2F;instance&#x2F;lifecycle.js 文件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">el</span>: ?<span class="title class_">Element</span>,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): <span class="title class_">Component</span> &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el</span><br><span class="line">  <span class="comment">// 省略一系列其它代码</span></span><br><span class="line">  <span class="keyword">let</span> updateComponent</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 生成虚拟 vnode   </span></span><br><span class="line">      <span class="keyword">const</span> vnode = vm.<span class="title function_">_render</span>()</span><br><span class="line">      <span class="comment">// 更新 DOM</span></span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating)</span><br><span class="line">     </span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例化一个渲染Watcher，在它的回调函数中会调用 updateComponent 方法  </span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, &#123;</span><br><span class="line">    before () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</span><br><span class="line">  hydrating = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看到，mountComponent 核心就是先实例化一个渲染Watcher，在它的回调函数中会调用 updateComponent 方法，在此方法中调用 vm._render 方法先生成虚拟 Node，最终调用 vm._update 更新 DOM。</p>
<h4 id="（3）创建虚拟-Node"><a href="#（3）创建虚拟-Node" class="headerlink" title="（3）创建虚拟 Node"></a>（3）创建虚拟 Node</h4><p>Vue 的 _render 方法是实例的一个私有方法，它用来把实例渲染成一个虚拟 Node。它的定义在 src&#x2F;core&#x2F;instance&#x2F;render.js 文件中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">   <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line">   <span class="keyword">let</span> vnode</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// 省略一系列代码  </span></span><br><span class="line">     currentRenderingInstance = vm</span><br><span class="line">     <span class="comment">// 调用 createElement 方法来返回 vnode</span></span><br><span class="line">     vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">   &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">     <span class="title function_">handleError</span>(<span class="params">e, vm, <span class="string">`render`</span></span>)&#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// set parent</span></span><br><span class="line">   vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;vnode...:&quot;</span>,vnode);</span><br><span class="line">   <span class="keyword">return</span> vnode</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>Vue.js 利用 _createElement 方法创建 VNode，它定义在 src&#x2F;core&#x2F;vdom&#x2F;create-elemenet.js 中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">_createElement</span> (</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span>,</span><br><span class="line">  tag?: string | <span class="title class_">Class</span>&lt;<span class="title class_">Component</span>&gt; | <span class="title class_">Function</span> | <span class="title class_">Object</span>,</span><br><span class="line">  data?: <span class="title class_">VNodeData</span>,</span><br><span class="line">  children?: any,</span><br><span class="line">  normalizationType?: number</span><br><span class="line">): <span class="title class_">VNode</span> | <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#123;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 省略一系列非主线代码</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (normalizationType === <span class="variable constant_">ALWAYS_NORMALIZE</span>) &#123;</span><br><span class="line">    <span class="comment">// 场景是 render 函数不是编译生成的</span></span><br><span class="line">    children = <span class="title function_">normalizeChildren</span>(children)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (normalizationType === <span class="variable constant_">SIMPLE_NORMALIZE</span>) &#123;</span><br><span class="line">    <span class="comment">// 场景是 render 函数是编译生成的</span></span><br><span class="line">    children = <span class="title function_">simpleNormalizeChildren</span>(children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> vnode, ns</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Ctor</span></span><br><span class="line">    ns = (context.<span class="property">$vnode</span> &amp;&amp; context.<span class="property">$vnode</span>.<span class="property">ns</span>) || config.<span class="title function_">getTagNamespace</span>(tag)</span><br><span class="line">    <span class="keyword">if</span> (config.<span class="title function_">isReservedTag</span>(tag)) &#123;</span><br><span class="line">      <span class="comment">// 创建虚拟 vnode</span></span><br><span class="line">      vnode = <span class="keyword">new</span> <span class="title class_">VNode</span>(</span><br><span class="line">        config.<span class="title function_">parsePlatformTagName</span>(tag), data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((!data || !data.<span class="property">pre</span>) &amp;&amp; <span class="title function_">isDef</span>(<span class="title class_">Ctor</span> = <span class="title function_">resolveAsset</span>(context.<span class="property">$options</span>, <span class="string">&#x27;components&#x27;</span>, tag))) &#123;</span><br><span class="line">      <span class="comment">// component</span></span><br><span class="line">      vnode = <span class="title function_">createComponent</span>(<span class="title class_">Ctor</span>, data, context, children, tag)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode = <span class="keyword">new</span> <span class="title class_">VNode</span>(</span><br><span class="line">        tag, data, children,</span><br><span class="line">        <span class="literal">undefined</span>, <span class="literal">undefined</span>, context</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vnode = <span class="title function_">createComponent</span>(tag, data, context, children)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(ns)) <span class="title function_">applyNS</span>(vnode, ns)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(data)) <span class="title function_">registerDeepBindings</span>(data)</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createEmptyVNode</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_createElement 方法有 5 个参数，context 表示 VNode 的上下文环境，它是 Component 类型；tag表示标签，它可以是一个字符串，也可以是一个 Component；data 表示 VNode 的数据，它是一个 VNodeData 类型，可以在 flow&#x2F;vnode.js 中找到它的定义；children 表示当前 VNode 的子节点，它是任意类型的，需要被规范为标准的 VNode 数组；</p>
<h3 id="3-1-3、实例查看"><a href="#3-1-3、实例查看" class="headerlink" title="3.1.3、实例查看"></a>3.1.3、实例查看</h3><p>为了更直观查看我们平时写的 Vue 代码如何用 VNode 类来表示，我们通过一个实例的转换进行更深刻了解。</p>
<p>例如，实例化一个 Vue 实例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="attr">render</span>: <span class="keyword">function</span> (<span class="params">createElement</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">attrs</span>: &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;app&#x27;</span>,</span><br><span class="line">        <span class="attr">class</span>: <span class="string">&quot;class_box&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;, <span class="variable language_">this</span>.<span class="property">message</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;Hello Vue!&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>我们打印出其对应的 VNode 表示：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9L5Q.png" alt="QF9L5Q.png"></p>
<h2 id="3-2、diff-过程"><a href="#3-2、diff-过程" class="headerlink" title="3.2、diff 过程"></a>3.2、diff 过程</h2><h3 id="3-2-1、Vue-js-源码的-diff-调用逻辑"><a href="#3-2-1、Vue-js-源码的-diff-调用逻辑" class="headerlink" title="3.2.1、Vue.js 源码的 diff 调用逻辑"></a>3.2.1、Vue.js 源码的 diff 调用逻辑</h3><p>Vue.js 源码实例化了一个 watcher，这个 ~ 被添加到了在模板当中所绑定变量的依赖当中，一旦 model 中的响应式的数据发生了变化，这些响应式的数据所维护的 dep 数组便会调用 dep.notify() 方法完成所有依赖遍历执行的工作，这包括视图的更新，即 updateComponent 方法的调用。watcher 和 updateComponent 方法定义在  src&#x2F;core&#x2F;instance&#x2F;lifecycle.js 文件中 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span> (</span><br><span class="line">  <span class="attr">vm</span>: <span class="title class_">Component</span>,</span><br><span class="line">  <span class="attr">el</span>: ?<span class="title class_">Element</span>,</span><br><span class="line">  hydrating?: boolean</span><br><span class="line">): <span class="title class_">Component</span> &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el</span><br><span class="line">  <span class="comment">// 省略一系列其它代码</span></span><br><span class="line">  <span class="keyword">let</span> updateComponent</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 生成虚拟 vnode   </span></span><br><span class="line">      <span class="keyword">const</span> vnode = vm.<span class="title function_">_render</span>()</span><br><span class="line">      <span class="comment">// 更新 DOM</span></span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating)</span><br><span class="line">     </span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例化一个渲染Watcher，在它的回调函数中会调用 updateComponent 方法  </span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, &#123;</span><br><span class="line">    before () &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>)</span><br><span class="line">  hydrating = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成视图的更新工作事实上就是调用了vm._update方法，这个方法接收的第一个参数是刚生成的Vnode，调用的vm._update方法定义在 src&#x2F;core&#x2F;instance&#x2F;lifecycle.js中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">  <span class="keyword">const</span> prevEl = vm.<span class="property">$el</span></span><br><span class="line">  <span class="keyword">const</span> prevVnode = vm.<span class="property">_vnode</span></span><br><span class="line">  <span class="keyword">const</span> restoreActiveInstance = <span class="title function_">setActiveInstance</span>(vm)</span><br><span class="line">  vm.<span class="property">_vnode</span> = vnode</span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// 第一个参数为真实的node节点，则为初始化</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果需要diff的prevVnode存在，那么对prevVnode和vnode进行diff</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">restoreActiveInstance</span>()</span><br><span class="line">  <span class="comment">// update __vue__ reference</span></span><br><span class="line">  <span class="keyword">if</span> (prevEl) &#123;</span><br><span class="line">    prevEl.<span class="property">__vue__</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$el</span>) &#123;</span><br><span class="line">    vm.<span class="property">$el</span>.<span class="property">__vue__</span> = vm</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if parent is an HOC, update its $el as well</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> &amp;&amp; vm.<span class="property">$parent</span> &amp;&amp; vm.<span class="property">$vnode</span> === vm.<span class="property">$parent</span>.<span class="property">_vnode</span>) &#123;</span><br><span class="line">    vm.<span class="property">$parent</span>.<span class="property">$el</span> = vm.<span class="property">$el</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法当中最为关键的就是 <code>vm.__patch__</code> 方法，这也是整个 virtual-dom 当中最为核心的方法，主要完成了prevVnode 和 vnode 的 diff 过程并根据需要操作的 vdom 节点打 patch，最后生成新的真实 dom 节点并完成视图的更新工作。</p>
<p>接下来，让我们看下 <code>vm.__patch__</code> 的逻辑过程， <code>vm.__patch__</code> 方法定义在 src&#x2F;core&#x2F;vdom&#x2F;patch.js 中。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span> (oldVnode, vnode, hydrating, removeOnly) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">      <span class="comment">// 当oldVnode不存在时，创建新的节点</span></span><br><span class="line">      isInitialPatch = <span class="literal">true</span></span><br><span class="line">      <span class="title function_">createElm</span>(vnode, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对oldVnode和vnode进行diff，并对oldVnode打patch  </span></span><br><span class="line">      <span class="keyword">const</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>)</span><br><span class="line">      <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">        <span class="comment">// patch existing root node</span></span><br><span class="line">        <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="literal">null</span>, <span class="literal">null</span>, removeOnly)</span><br><span class="line">      &#125; </span><br><span class="line">	......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 patch 方法中，我们看到会分为两种情况，一种是当 oldVnode 不存在时，会创建新的节点；另一种则是已经存在 oldVnode ，那么会对 oldVnode 和 vnode 进行 diff 及 patch 的过程。其中 patch 过程中会调用 sameVnode 方法来对对传入的2个 vnode 进行基本属性的比较，只有当基本属性相同的情况下才认为这个2个vnode 只是局部发生了更新，然后才会对这2个 vnode 进行 diff，如果2个 vnode 的基本属性存在不一致的情况，那么就会直接跳过 diff 的过程，进而依据 vnode 新建一个真实的 dom，同时删除老的 dom 节点。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sameVnode</span> (a, b) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    a.<span class="property">key</span> === b.<span class="property">key</span> &amp;&amp;</span><br><span class="line">    a.<span class="property">tag</span> === b.<span class="property">tag</span> &amp;&amp;</span><br><span class="line">    a.<span class="property">isComment</span> === b.<span class="property">isComment</span> &amp;&amp;</span><br><span class="line">    <span class="title function_">isDef</span>(a.<span class="property">data</span>) === <span class="title function_">isDef</span>(b.<span class="property">data</span>) &amp;&amp;</span><br><span class="line">    <span class="title function_">sameInputType</span>(a, b)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>diff 过程中主要是通过调用 patchVnode 方法进行的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchVnode</span> (oldVnode, vnode, insertedVnodeQueue, ownerArray, index, removeOnly) &#123;</span><br><span class="line">...... </span><br><span class="line"><span class="keyword">const</span> elm = vnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span></span><br><span class="line"><span class="keyword">const</span> oldCh = oldVnode.<span class="property">children</span></span><br><span class="line"><span class="keyword">const</span> ch = vnode.<span class="property">children</span></span><br><span class="line"><span class="comment">// 如果vnode没有文本节点</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">    <span class="comment">// 如果oldVnode的children属性存在且vnode的children属性也存在  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh) &amp;&amp; <span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">    <span class="comment">// updateChildren，对子节点进行diff  </span></span><br><span class="line">    <span class="keyword">if</span> (oldCh !== ch) <span class="title function_">updateChildren</span>(elm, oldCh, ch, insertedVnodeQueue, removeOnly)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">checkDuplicateKeys</span>(ch)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果oldVnode的text存在，那么首先清空text的内容,然后将vnode的children添加进去  </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="title function_">addVnodes</span>(elm, <span class="literal">null</span>, ch, <span class="number">0</span>, ch.<span class="property">length</span> - <span class="number">1</span>, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh)) &#123;</span><br><span class="line">    <span class="comment">// 删除elm下的oldchildren</span></span><br><span class="line">    <span class="title function_">removeVnodes</span>(elm, oldCh, <span class="number">0</span>, oldCh.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123;</span><br><span class="line">    <span class="comment">// oldVnode有子节点，而vnode没有，那么就清空这个节点  </span></span><br><span class="line">    nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== vnode.<span class="property">text</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果oldVnode和vnode文本属性不同，那么直接更新真是dom节点的文本元素</span></span><br><span class="line">    nodeOps.<span class="title function_">setTextContent</span>(elm, vnode.<span class="property">text</span>)</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从以上代码得知，</p>
<p>diff 过程中又分了好几种情况，oldCh 为 oldVnode的子节点，ch 为 Vnode 的子节点：</p>
<p>首先进行文本节点的判断，若 oldVnode.text !&#x3D;&#x3D; vnode.text，那么就会直接进行文本节点的替换；<br>在vnode 没有文本节点的情况下，进入子节点的 diff；<br>当 oldCh 和 ch 都存在且不相同的情况下，调用 updateChildren 对子节点进行 diff；<br>若 oldCh 不存在，ch 存在，首先清空 oldVnode 的文本节点，同时调用 addVnodes 方法将 ch 添加到elm 真实 dom 节点当中；<br>若 oldCh 存在，ch 不存在，则删除 elm 真实节点下的 oldCh 子节点；<br>若 oldVnode 有文本节点，而 vnode 没有，那么就清空这个文本节点。</p>
<h3 id="3-2-2、子节点-diff-流程分析"><a href="#3-2-2、子节点-diff-流程分析" class="headerlink" title="3.2.2、子节点 diff 流程分析"></a>3.2.2、子节点 diff 流程分析</h3><h4 id="（1）Vue-js-源码"><a href="#（1）Vue-js-源码" class="headerlink" title="（1）Vue.js 源码"></a>（1）Vue.js 源码</h4><p>​ 这里着重分析下 updateChildren方法，它也是整个 diff 过程中最重要的环节，以下为 Vue.js 的源码过程，为了更形象理解 diff 过程，我们给出相关的示意图来讲解。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateChildren</span> (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) &#123;</span><br><span class="line"><span class="comment">// 为oldCh和newCh分别建立索引，为之后遍历的依据</span></span><br><span class="line"><span class="keyword">let</span> oldStartIdx = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> newStartIdx = <span class="number">0</span></span><br><span class="line"><span class="keyword">let</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> oldStartVnode = oldCh[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">let</span> oldEndVnode = oldCh[oldEndIdx]</span><br><span class="line"><span class="keyword">let</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line"><span class="keyword">let</span> newStartVnode = newCh[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">let</span> newEndVnode = newCh[newEndIdx]</span><br><span class="line"><span class="keyword">let</span> oldKeyToIdx, idxInOld, vnodeToMove, refElm</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直到oldCh或者newCh被遍历完后跳出循环</span></span><br><span class="line"><span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldStartVnode)) &#123;</span><br><span class="line">    oldStartVnode = oldCh[++oldStartIdx] <span class="comment">// Vnode has been moved left</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldEndVnode)) &#123;</span><br><span class="line">    oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">    <span class="title function_">patchVnode</span>(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">    oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">    newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">    <span class="title function_">patchVnode</span>(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)</span><br><span class="line">    oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">    newEndVnode = newCh[--newEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123; <span class="comment">// Vnode moved right</span></span><br><span class="line">    <span class="title function_">patchVnode</span>(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)</span><br><span class="line">    canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldStartVnode.<span class="property">elm</span>, nodeOps.<span class="title function_">nextSibling</span>(oldEndVnode.<span class="property">elm</span>))</span><br><span class="line">    oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">    newEndVnode = newCh[--newEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123; <span class="comment">// Vnode moved left</span></span><br><span class="line">    <span class="title function_">patchVnode</span>(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">    canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldEndVnode.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">    oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">    newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldKeyToIdx)) oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">    idxInOld = <span class="title function_">isDef</span>(newStartVnode.<span class="property">key</span>)</span><br><span class="line">        ? oldKeyToIdx[newStartVnode.<span class="property">key</span>]</span><br><span class="line">        : <span class="title function_">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">        <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vnodeToMove = oldCh[idxInOld]</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">        <span class="title function_">patchVnode</span>(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">        oldCh[idxInOld] = <span class="literal">undefined</span></span><br><span class="line">        canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, vnodeToMove.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// same key but different element. treat as new element</span></span><br><span class="line">        <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">    refElm = <span class="title function_">isUndef</span>(newCh[newEndIdx + <span class="number">1</span>]) ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].<span class="property">elm</span></span><br><span class="line">    <span class="title function_">addVnodes</span>(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">    <span class="title function_">removeVnodes</span>(parentElm, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在开始遍历 diff 前，首先给 oldCh 和 newCh 分别分配一个 startIndex 和 endIndex 来作为遍历的索引，当oldCh 或者 newCh 遍历完后(遍历完的条件就是 oldCh 或者 newCh 的 startIndex &gt;&#x3D; endIndex )，就停止oldCh 和 newCh 的 diff 过程。接下来通过实例来看下整个 diff 的过程(节点属性中不带 key 的情况)。</p>
<h4 id="（2）无-key-的-diff-过程"><a href="#（2）无-key-的-diff-过程" class="headerlink" title="（2）无 key 的 diff 过程"></a>（2）无 key 的 diff 过程</h4><p>我们通过以下示意图对以上代码过程进行讲解：</p>
<p>####（2.1）首先从第一个节点开始比较，不管是 oldCh 还是 newCh 的起始或者终止节点都不存在 sameVnode ，同时节点属性中是不带 key 标记的，因此第一轮的 diff 完后，newCh 的 startVnode 被添加到 oldStartVnode的前面，同时 newStartIndex 前移一位；<br><img src="https://s2.ax1x.com/2019/11/28/QF9qUg.jpg" alt="QF9qUg.jpg"><br>（2.2）第二轮的 diff 中，满足 sameVnode(oldStartVnode, newStartVnode)，因此对这2个 vnode 进行diff，最后将 patch 打到 oldStartVnode 上，同时 oldStartVnode 和 newStartIndex 都向前移动一位 ；<br><img src="https://s2.ax1x.com/2019/11/28/QF9bVS.jpg" alt="QF9bVS.jpg"><br>（2.3）第三轮的 diff 中，满足 sameVnode(oldEndVnode, newStartVnode)，那么首先对 oldEndVnode和newStartVnode 进行 diff，并对 oldEndVnode 进行 patch，并完成 oldEndVnode 移位的操作，最后newStartIndex 前移一位，oldStartVnode 后移一位；<br><img src="https://s2.ax1x.com/2019/11/28/QF9v2n.jpg" alt="QF9v2n.jpg"><br>（2.4）第四轮的 diff 中，过程同步骤3；<br><img src="https://s2.ax1x.com/2019/11/28/QF9xvq.jpg" alt="QF9xvq.jpg"><br>（2.5）第五轮的 diff 中，同过程1；<br><img src="https://s2.ax1x.com/2019/11/28/QFCSK0.jpg" alt="QFCSK0.jpg"><br>（2.6）遍历的过程结束后，newStartIdx &gt; newEndIdx，说明此时 oldCh 存在多余的节点，那么最后就需要将这些多余的节点删除。<br><img src="https://s2.ax1x.com/2019/11/28/QFCprV.jpg" alt="QFCprV.jpg"></p>
<h4 id="（3）有-key-的-diff-流程"><a href="#（3）有-key-的-diff-流程" class="headerlink" title="（3）有 key 的 diff 流程"></a>（3）有 key 的 diff 流程</h4><p>在 vnode 不带 key 的情况下，每一轮的 diff 过程当中都是起始和结束节点进行比较，直到 oldCh 或者newCh 被遍历完。而当为 vnode 引入 key 属性后，在每一轮的 diff 过程中，当起始和结束节点都没有找到sameVnode 时，然后再判断在 newStartVnode 的属性中是否有 key，且是否在 oldKeyToIndx 中找到对应的节点 ：</p>
<p>如果不存在这个 key，那么就将这个 newStartVnode 作为新的节点创建且插入到原有的 root 的子节点中；<br>如果存在这个 key，那么就取出 oldCh 中的存在这个 key 的 vnode，然后再进行 diff 的过；<br>通过以上分析，给vdom上添加 key 属性后，遍历 diff 的过程中，当起始点，结束点的搜寻及 diff 出现还是无法匹配的情况下时，就会用 key 来作为唯一标识，来进行 diff，这样就可以提高 diff 效率。</p>
<p>带有 Key 属性的 vnode的 diff 过程可见下图：</p>
<p>（3.1）首先从第一个节点开始比较，不管是 oldCh 还是 newCh 的起始或者终止节点都不存在 sameVnode，但节点属性中是带 key 标记的， 然后在 oldKeyToIndx 中找到对应的节点，这样第一轮 diff 过后 oldCh 上的B节点被删除了，但是 newCh 上的B节点上 elm 属性保持对 oldCh 上 B节点 的elm引用。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFC9bT.jpg" alt="QFC9bT.jpg"></p>
<p>（3.2）第二轮的 diff 中，满足 sameVnode(oldStartVnode, newStartVnode)，因此对这2个 vnode 进行diff，最后将 patch 打到 oldStartVnode上，同时 oldStartVnode 和 newStartIndex 都向前移动一位 ；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCiaF.jpg" alt="QFCiaF.jpg"></p>
<p>（3.3）第三轮的 diff 中，满足 sameVnode(oldEndVnode, newStartVnode)，那么首先对 oldEndVnode 和newStartVnode 进行 diff，并对 oldEndVnode 进行 patch，并完成 oldEndVnode 移位的操作，最后newStartIndex 前移一位，oldStartVnode 后移一位；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCF54.jpg" alt="QFCF54.jpg"></p>
<p>（3.4）第四轮的diff中，过程同步骤2；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCAPJ.jpg" alt="QFCAPJ.jpg"></p>
<p>（3.5）第五轮的diff中，因为此时 oldStartIndex 已经大于 oldEndIndex，所以将剩余的 Vnode 队列插入队列最后。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCEG9.jpg" alt="QFCEG9.jpg"></p>
<p>3.3、patch 过程<br>通过3.2章节介绍的 diff 过程中，我们会看到 nodeOps 相关的方法对真实 DOM 结构进行操作，nodeOps 定义在 src&#x2F;platforms&#x2F;web&#x2F;runtime&#x2F;node-ops.js 中，其为基本 DOM 操作，这里就不在详细介绍。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createElementNS</span> (<span class="attr">namespace</span>: string, <span class="attr">tagName</span>: string): <span class="title class_">Element</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElementNS</span>(namespaceMap[namespace], tagName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createTextNode</span> (<span class="attr">text</span>: string): <span class="title class_">Text</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createComment</span> (<span class="attr">text</span>: string): <span class="title class_">Comment</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createComment</span>(text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">insertBefore</span> (<span class="attr">parentNode</span>: <span class="title class_">Node</span>, <span class="attr">newNode</span>: <span class="title class_">Node</span>, <span class="attr">referenceNode</span>: <span class="title class_">Node</span>) &#123;</span><br><span class="line">  parentNode.<span class="title function_">insertBefore</span>(newNode, referenceNode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">removeChild</span> (<span class="attr">node</span>: <span class="title class_">Node</span>, <span class="attr">child</span>: <span class="title class_">Node</span>) &#123;</span><br><span class="line">  node.<span class="title function_">removeChild</span>(child)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.4、总结<br>通过前三小节简析，我们从主线上把模板和数据如何渲染成最终的 DOM 的过程分析完毕了，我们可以通过下图更直观地看到从初始化 Vue 到最终渲染的整个过程。<br><img src="https://s2.ax1x.com/2019/11/28/QFCV2R.png" alt="QFCV2R.png"></p>
<h1 id="转载"><a href="#转载" class="headerlink" title="转载"></a>转载</h1><p>本文转载自<a target="_blank" rel="noopener" href="https://github.com/fengshi123/blog/issues/10">https://github.com/fengshi123/blog/issues/10</a><br>感谢作者@fengshi123</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/28/%E8%99%9A%E6%8B%9Fdom/" data-id="cl9xpujs4004pdmopayu80xq1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS%E8%BF%9B%E9%98%B6/" rel="tag">JS进阶</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-yuque/虚拟dom" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/28/yuque/%E8%99%9A%E6%8B%9Fdom/" class="article-date">
  <time datetime="2019-11-28T11:21:32.000Z" itemprop="datePublished">2019-11-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/28/yuque/%E8%99%9A%E6%8B%9Fdom/">虚拟dom</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一、真实 DOM 和其解析流程</p>
<p>本节我们主要介绍真实 DOM 的解析过程，通过介绍其解析过程以及存在的问题，从而引出为什么需要虚拟 DOM。一图胜千言，如下图为 webkit 渲染引擎工作流程图</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFFJz9.png#alt=QFFJz9.png"></p>
<p>所有的浏览器渲染引擎工作流程大致分为 5 步：创建 DOM 树 —&gt; 创建 Style Rules -&gt; 构建 Render 树 —&gt; 布局 Layout -—&gt; 绘制 Painting。</p>
<p>第一步，构建 DOM 树：用 HTML 分析器，分析 HTML 元素，构建一棵 DOM 树；</p>
<p>第二步，生成样式表：用 CSS 分析器，分析 CSS 文件和元素上的 inline 样式，生成页面的样式表；</p>
<p>第三步，构建 Render 树：将 DOM 树和样式表关联起来，构建一棵 Render 树（Attachment）。每个 DOM 节点都有 attach 方法，接受样式信息，返回一个 render 对象（又名 renderer），这些 render 对象最终会被构建成一棵 Render 树；</p>
<p>第四步，确定节点坐标：根据 Render 树结构，为每个 Render 树上的节点确定一个在显示屏上出现的精确坐标；</p>
<p>第五步，绘制页面：根据 Render 树和节点显示坐标，然后调用每个节点的 paint 方法，将它们绘制出来。</p>
<h4 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a>注意点：</h4><p>1、DOM 树的构建是文档加载完成开始的？ 构建 DOM 树是一个渐进过程，为达到更好的用户体验，渲染引擎会尽快将内容显示在屏幕上，它不必等到整个 HTML 文档解析完成之后才开始构建 render 树和布局。</p>
<p>2、Render 树是 DOM 树和 CSS 样式表构建完毕后才开始构建的？ 这三个过程在实际进行的时候并不是完全独立的，而是会有交叉，会一边加载，一边解析，以及一边渲染。</p>
<p>3、CSS 的解析注意点？ CSS 的解析是从右往左逆向解析的，嵌套标签越多，解析越慢。</p>
<p>4、JS 操作真实 DOM 的代价？ 用我们传统的开发模式，原生 JS 或 JQ 操作 DOM 时，浏览器会从构建 DOM 树开始从头到尾执行一遍流程。在一次操作中，我需要更新 10 个 DOM 节点，浏览器收到第一个 DOM 请求后并不知道还有 9 次更新操作，因此会马上执行流程，最终执行 10 次。例如，第一次计算完，紧接着下一个 DOM 更新请求，这个节点的坐标值就变了，前一次计算为无用功。计算 DOM 节点坐标值等都是白白浪费的性能。即使计算机硬件一直在迭代更新，操作 DOM 的代价仍旧是昂贵的，频繁操作还是会出现页面卡顿，影响用户体验</p>
<h1 id="二、Virtual-DOM-基础"><a href="#二、Virtual-DOM-基础" class="headerlink" title="二、Virtual-DOM 基础"></a>二、Virtual-DOM 基础</h1><h2 id="2-1、虚拟-DOM-的好处"><a href="#2-1、虚拟-DOM-的好处" class="headerlink" title="2.1、虚拟 DOM 的好处"></a>2.1、虚拟 DOM 的好处</h2><p>虚拟 DOM 就是为了解决浏览器性能问题而被设计出来的。如前，若一次操作中有 10 次更新 DOM 的动作，虚拟 DOM 不会立即操作 DOM，而是将这 10 次更新的 diff 内容保存到本地一个 JS 对象中，最终将这个 JS 对象一次性 attch 到 DOM 树上，再进行后续操作，避免大量无谓的计算量。所以，用 JS 对象模拟 DOM 节点的好处是，页面的更新可以先全部反映在 JS 对象(虚拟 DOM )上，操作内存中的 JS 对象的速度显然要更快，等更新完成后，再将最终的 JS 对象映射成真实的 DOM，交由浏览器去绘制。</p>
<h2 id="2-2、算法实现"><a href="#2-2、算法实现" class="headerlink" title="2.2、算法实现"></a>2.2、算法实现</h2><h3 id="2-2-1、用-JS-对象模拟-DOM-树"><a href="#2-2-1、用-JS-对象模拟-DOM-树" class="headerlink" title="2.2.1、用 JS 对象模拟 DOM 树"></a>2.2.1、用 JS 对象模拟 DOM 树</h3><h4 id="（1）如何用-JS-对象模拟-DOM-树"><a href="#（1）如何用-JS-对象模拟-DOM-树" class="headerlink" title="（1）如何用 JS 对象模拟 DOM 树"></a>（1）如何用 JS 对象模拟 DOM 树</h4><p>例如一个真实的 DOM 节点如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;virtual-dom&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Virtual DOM<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>我们用 JavaScript 对象来表示 DOM 节点，使用对象的属性记录节点的类型、属性、子节点等。</p>
<p>element.js 中表示节点对象代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Element virdual-dom 对象定义</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">String</span>&#125; <span class="variable">tagName</span> - dom 元素名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">props</span> - dom 属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Array&lt;Element|String&gt;</span>&#125; - 子节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Element</span>(<span class="params">tagName, props, children</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">tagName</span> = tagName;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">props</span> = props;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">children</span> = children;</span><br><span class="line">  <span class="comment">// dom 元素的 key 值，用作唯一标识符</span></span><br><span class="line">  <span class="keyword">if</span> (props.<span class="property">key</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = props.<span class="property">key</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">  children.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">child, i</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (child <span class="keyword">instanceof</span> <span class="title class_">Element</span>) &#123;</span><br><span class="line">      count += child.<span class="property">count</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      children[i] = <span class="string">&quot;&quot;</span> + child;</span><br><span class="line">    &#125;</span><br><span class="line">    count++;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 子元素个数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">count</span> = count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">tagName, props, children</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Element</span>(tagName, props, children);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = createElement;</span><br></pre></td></tr></table></figure>

<p>根据 element 对象的设定，则上面的 DOM 结构就可以简单表示为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> el = <span class="built_in">require</span>(<span class="string">&quot;./element.js&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> ul = <span class="title function_">el</span>(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">id</span>: <span class="string">&quot;virtual-dom&quot;</span> &#125;, [</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;p&quot;</span>, &#123;&#125;, [<span class="string">&quot;Virtual DOM&quot;</span>]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;ul&quot;</span>, &#123; <span class="attr">id</span>: <span class="string">&quot;list&quot;</span> &#125;, [</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 1&quot;</span>]),</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 2&quot;</span>]),</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 3&quot;</span>]),</span><br><span class="line">  ]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, [<span class="string">&quot;Hello World&quot;</span>]),</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>现在 ul 就是我们用 JavaScript 对象表示的 DOM 结构，我们输出查看 ul 对应的数据结构如下：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFE3i8.png#alt=QFE3i8.png"></p>
<h4 id="（2）渲染用-JS-表示的-DOM-对象"><a href="#（2）渲染用-JS-表示的-DOM-对象" class="headerlink" title="（2）渲染用 JS 表示的 DOM 对象"></a>（2）渲染用 JS 表示的 DOM 对象</h4><p>但是页面上并没有这个结构，下一步我们介绍如何将 ul 渲染成页面上真实的 DOM 结构，相关渲染函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * render 将virdual-dom 对象渲染为实际 DOM 元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Element</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">render</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> el = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="variable language_">this</span>.<span class="property">tagName</span>);</span><br><span class="line">  <span class="keyword">var</span> props = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">  <span class="comment">// 设置节点的DOM属性</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> propName <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">var</span> propValue = props[propName];</span><br><span class="line">    el.<span class="title function_">setAttribute</span>(propName, propValue);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> children = <span class="variable language_">this</span>.<span class="property">children</span> || [];</span><br><span class="line">  children.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">child</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> childEl =</span><br><span class="line">      child <span class="keyword">instanceof</span> <span class="title class_">Element</span></span><br><span class="line">        ? child.<span class="title function_">render</span>() <span class="comment">// 如果子节点也是虚拟DOM，递归构建DOM节点</span></span><br><span class="line">        : <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(child); <span class="comment">// 如果字符串，只构建文本节点</span></span><br><span class="line">    el.<span class="title function_">appendChild</span>(childEl);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> el;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们通过查看以上 render 方法，会根据 tagName 构建一个真正的 DOM 节点，然后设置这个节点的属性，最后递归地把自己的子节点也构建起来。</p>
<p>我们将构建好的 DOM 结构添加到页面 body 上面，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulRoot = ul.<span class="title function_">render</span>();</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(ulRoot);</span><br></pre></td></tr></table></figure>

<p>这样，页面 body 里面就有真正的 DOM 结构，效果如下图所示：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFSQaQ.png#alt=QFSQaQ.png"></p>
<h3 id="2-2-2、比较两棵虚拟-DOM-树的差异-—-diff-算法"><a href="#2-2-2、比较两棵虚拟-DOM-树的差异-—-diff-算法" class="headerlink" title="2.2.2、比较两棵虚拟 DOM 树的差异 — diff 算法"></a>2.2.2、比较两棵虚拟 DOM 树的差异 — diff 算法</h3><p>diff 算法用来比较两棵 Virtual DOM 树的差异，如果需要两棵树的完全比较，那么 diff 算法的时间复杂度为 O(n^3)。但是在前端当中，你很少会跨越层级地移动 DOM 元素，所以 Virtual DOM 只会对同一个层级的元素进行对比，如下图所示， div 只会和同一层级的 div 对比，第二层级的只会跟第二层级对比，这样算法复杂度就可以达到 O(n)。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFSwa4.png#alt=QFSwa4.png"></p>
<p>####（1）深度优先遍历，记录差异</p>
<p>在实际的代码中，会对新旧两棵树进行一个深度优先的遍历，这样每个节点都会有一个唯一的标记：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFScM6.png#alt=QFScM6.png"></p>
<p>在深度优先遍历的时候，每遍历到一个节点就把该节点和新的的树进行对比。如果有差异的话就记录到一个对象里面。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// diff 函数，对比两棵树</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">diff</span>(<span class="params">oldTree, newTree</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> index = <span class="number">0</span>; <span class="comment">// 当前节点的标志</span></span><br><span class="line">  <span class="keyword">var</span> patches = &#123;&#125;; <span class="comment">// 用来记录每个节点差异的对象</span></span><br><span class="line">  <span class="title function_">dfsWalk</span>(oldTree, newTree, index, patches);</span><br><span class="line">  <span class="keyword">return</span> patches;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对两棵树进行深度优先遍历</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dfsWalk</span>(<span class="params">oldNode, newNode, index, patches</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> currentPatch = [];</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> oldNode === <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span> newNode === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 文本内容改变</span></span><br><span class="line">    <span class="keyword">if</span> (newNode !== oldNode) &#123;</span><br><span class="line">      currentPatch.<span class="title function_">push</span>(&#123; <span class="attr">type</span>: patch.<span class="property">TEXT</span>, <span class="attr">content</span>: newNode &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    newNode != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    oldNode.<span class="property">tagName</span> === newNode.<span class="property">tagName</span> &amp;&amp;</span><br><span class="line">    oldNode.<span class="property">key</span> === newNode.<span class="property">key</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 节点相同，比较属性</span></span><br><span class="line">    <span class="keyword">var</span> propsPatches = <span class="title function_">diffProps</span>(oldNode, newNode);</span><br><span class="line">    <span class="keyword">if</span> (propsPatches) &#123;</span><br><span class="line">      currentPatch.<span class="title function_">push</span>(&#123; <span class="attr">type</span>: patch.<span class="property">PROPS</span>, <span class="attr">props</span>: propsPatches &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 比较子节点，如果子节点有&#x27;ignore&#x27;属性，则不需要比较</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isIgnoreChildren</span>(newNode)) &#123;</span><br><span class="line">      <span class="title function_">diffChildren</span>(</span><br><span class="line">        oldNode.<span class="property">children</span>,</span><br><span class="line">        newNode.<span class="property">children</span>,</span><br><span class="line">        index,</span><br><span class="line">        patches,</span><br><span class="line">        currentPatch</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 新节点和旧节点不同，用 replace 替换</span></span><br><span class="line">    currentPatch.<span class="title function_">push</span>(&#123; <span class="attr">type</span>: patch.<span class="property">REPLACE</span>, <span class="attr">node</span>: newNode &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (currentPatch.<span class="property">length</span>) &#123;</span><br><span class="line">    patches[index] = currentPatch;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上可以得出，patches[1] 表示 p ，patches[3] 表示 ul ，以此类推。</p>
<h4 id="（2）差异类型"><a href="#（2）差异类型" class="headerlink" title="（2）差异类型"></a>（2）差异类型</h4><p>DOM 操作导致的差异类型包括以下几种：</p>
<p>节点替换：节点改变了，例如将上面的 div 换成 h1;</p>
<p>顺序互换：移动、删除、新增子节点，例如上面 div 的子节点，把 p 和 ul 顺序互换；</p>
<p>属性更改：修改了节点的属性，例如把上面 li 的 class 样式类删除；</p>
<p>文本改变：改变文本节点的文本内容，例如将上面 p 节点的文本内容更改为 “Real Dom”；</p>
<p>以上描述的几种差异类型在代码中定义如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">REPLACE</span> = <span class="number">0</span>; <span class="comment">// 替换原先的节点</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">REORDER</span> = <span class="number">1</span>; <span class="comment">// 重新排序</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">PROPS</span> = <span class="number">2</span>; <span class="comment">// 修改了节点的属性</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">TEXT</span> = <span class="number">3</span>; <span class="comment">// 文本内容改变</span></span><br></pre></td></tr></table></figure>

<p>####（3）列表对比算法</p>
<p>子节点的对比算法，例如 p, ul, div 的顺序换成了 div, p, ul。这个该怎么对比？如果按照同层级进行顺序对比的话，它们都会被替换掉。如 p 和 div 的 tagName 不同，p 会被 div 所替代。最终，三个节点都会被替换，这样 DOM 开销就非常大。而实际上是不需要替换节点，而只需要经过节点移动就可以达到，我们只需知道怎么进行移动。</p>
<p>将这个问题抽象出来其实就是字符串的最小编辑距离问题（Edition Distance），最常见的解决方法是 Levenshtein Distance , Levenshtein Distance 是一个度量两个字符序列之间差异的字符串度量标准，两个单词之间的 Levenshtein Distance 是将一个单词转换为另一个单词所需的单字符编辑（插入、删除或替换）的最小数量。Levenshtein Distance 是 1965 年由苏联数学家 Vladimir Levenshtein 发明的。Levenshtein Distance 也被称为编辑距离（Edit Distance），通过动态规划求解，时间复杂度为 O(M*N)。</p>
<p>定义：对于两个字符串 a、b，则他们的 Levenshtein Distance 为：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFp50U.png#alt=QFp50U.png"></p>
<p>示例：字符串 a 和 b，a&#x3D;“abcde” ，b&#x3D;“cabef”，根据上面给出的计算公式，则他们的 Levenshtein Distance 的计算过程如下：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFpTk4.png#alt=QFpTk4.png"></p>
<p>本文的 demo 使用插件 list-diff2 算法进行比较，该算法的时间复杂度伟 O(n*m)，虽然该算法并非最优的算法，但是用于对于 dom 元素的常规操作是足够的。该算法具体的实现过程这里不再详细介绍，该算法的具体介绍可以参照：<a target="_blank" rel="noopener" href="https://github.com/livoras/list-diff">https://github.com/livoras/list-diff</a></p>
<p>（4）实例输出</p>
<p>两个虚拟 DOM 对象如下图所示，其中 ul1 表示原有的虚拟 DOM 树，ul2 表示改变后的虚拟 DOM 树</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ul1 = <span class="title function_">el</span>(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">id</span>: <span class="string">&quot;virtual-dom&quot;</span> &#125;, [</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;p&quot;</span>, &#123;&#125;, [<span class="string">&quot;Virtual DOM&quot;</span>]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;ul&quot;</span>, &#123; <span class="attr">id</span>: <span class="string">&quot;list&quot;</span> &#125;, [</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 1&quot;</span>]),</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 2&quot;</span>]),</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 3&quot;</span>]),</span><br><span class="line">  ]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;div&quot;</span>, &#123;&#125;, [<span class="string">&quot;Hello World&quot;</span>]),</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">var</span> ul2 = <span class="title function_">el</span>(<span class="string">&quot;div&quot;</span>, &#123; <span class="attr">id</span>: <span class="string">&quot;virtual-dom&quot;</span> &#125;, [</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;p&quot;</span>, &#123;&#125;, [<span class="string">&quot;Virtual DOM&quot;</span>]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;ul&quot;</span>, &#123; <span class="attr">id</span>: <span class="string">&quot;list&quot;</span> &#125;, [</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 21&quot;</span>]),</span><br><span class="line">    <span class="title function_">el</span>(<span class="string">&quot;li&quot;</span>, &#123; <span class="attr">class</span>: <span class="string">&quot;item&quot;</span> &#125;, [<span class="string">&quot;Item 23&quot;</span>]),</span><br><span class="line">  ]),</span><br><span class="line">  <span class="title function_">el</span>(<span class="string">&quot;p&quot;</span>, &#123;&#125;, [<span class="string">&quot;Hello World&quot;</span>]),</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">var</span> patches = <span class="title function_">diff</span>(ul1, ul2);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;patches:&quot;</span>, patches);</span><br></pre></td></tr></table></figure>

<p>我们查看输出的两个虚拟 DOM 对象之间的差异对象如下图所示，我们能通过差异对象得到，两个虚拟 DOM 对象之间进行了哪些变化，从而根据这个差异对象（patches）更改原先的真实 DOM 结构，从而将页面的 DOM 结构进行更改。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFp7tJ.png#alt=QFp7tJ.png"></p>
<h3 id="2-2-3、将两个虚拟-DOM-对象的差异应用到真正的-DOM-树"><a href="#2-2-3、将两个虚拟-DOM-对象的差异应用到真正的-DOM-树" class="headerlink" title="2.2.3、将两个虚拟 DOM 对象的差异应用到真正的 DOM 树"></a>2.2.3、将两个虚拟 DOM 对象的差异应用到真正的 DOM 树</h3><h4 id="（1）深度优先遍历-DOM-树"><a href="#（1）深度优先遍历-DOM-树" class="headerlink" title="（1）深度优先遍历 DOM 树"></a>（1）深度优先遍历 DOM 树</h4><p>因为步骤一所构建的 JavaScript 对象树和 render 出来真正的 DOM 树的信息、结构是一样的。所以我们可以对那棵 DOM 树也进行深度优先的遍历，遍历的时候从步骤二生成的 patches 对象中找出当前遍历的节点差异，如下相关代码所示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span>(<span class="params">node, patches</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> walker = &#123; <span class="attr">index</span>: <span class="number">0</span> &#125;;</span><br><span class="line">  <span class="title function_">dfsWalk</span>(node, walker, patches);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dfsWalk</span>(<span class="params">node, walker, patches</span>) &#123;</span><br><span class="line">  <span class="comment">// 从patches拿出当前节点的差异</span></span><br><span class="line">  <span class="keyword">var</span> currentPatches = patches[walker.<span class="property">index</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> len = node.<span class="property">childNodes</span> ? node.<span class="property">childNodes</span>.<span class="property">length</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 深度遍历子节点</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> child = node.<span class="property">childNodes</span>[i];</span><br><span class="line">    walker.<span class="property">index</span>++;</span><br><span class="line">    <span class="title function_">dfsWalk</span>(child, walker, patches);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 对当前节点进行DOM操作</span></span><br><span class="line">  <span class="keyword">if</span> (currentPatches) &#123;</span><br><span class="line">    <span class="title function_">applyPatches</span>(node, currentPatches);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（2）对原有-DOM-树进行-DOM-操作"><a href="#（2）对原有-DOM-树进行-DOM-操作" class="headerlink" title="（2）对原有 DOM 树进行 DOM 操作"></a>（2）对原有 DOM 树进行 DOM 操作</h4><p>我们根据不同类型的差异对当前节点进行不同的 DOM 操作 ，例如如果进行了节点替换，就进行节点替换 DOM 操作；如果节点文本发生了改变，则进行文本替换的 DOM 操作；以及子节点重排、属性改变等 DOM 操作，相关代码如 applyPatches 所示 ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">applyPatches</span>(<span class="params">node, currentPatches</span>) &#123;</span><br><span class="line">  currentPatches.<span class="title function_">forEach</span>(<span class="function">(<span class="params">currentPatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (currentPatch.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REPLACE</span>:</span><br><span class="line">        <span class="keyword">var</span> newNode =</span><br><span class="line">          <span class="keyword">typeof</span> currentPatch.<span class="property">node</span> === <span class="string">&quot;string&quot;</span></span><br><span class="line">            ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(currentPatch.<span class="property">node</span>)</span><br><span class="line">            : currentPatch.<span class="property">node</span>.<span class="title function_">render</span>();</span><br><span class="line">        node.<span class="property">parentNode</span>.<span class="title function_">replaceChild</span>(newNode, node);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REORDER</span>:</span><br><span class="line">        <span class="title function_">reorderChildren</span>(node, currentPatch.<span class="property">moves</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">PROPS</span>:</span><br><span class="line">        <span class="title function_">setProps</span>(node, currentPatch.<span class="property">props</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">TEXT</span>:</span><br><span class="line">        node.<span class="property">textContent</span> = currentPatch.<span class="property">content</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Unknown patch type &quot;</span> + currentPatch.<span class="property">type</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="（3）DOM-结构改变"><a href="#（3）DOM-结构改变" class="headerlink" title="（3）DOM 结构改变"></a>（3）DOM 结构改变</h4><p>通过将第 2.2.2 得到的两个 DOM 对象之间的差异，应用到第一个（原先）DOM 结构中，我们可以看到 DOM 结构进行了预期的变化，如下图所示：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFpI7F.png#alt=QFpI7F.png"></p>
<h2 id="2-3、结语"><a href="#2-3、结语" class="headerlink" title="2.3、结语"></a>2.3、结语</h2><p>Virtual DOM 算法主要实现上面三个步骤来实现：</p>
<p>用 JS 对象模拟 DOM 树 — element.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;virtual-dom&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Virtual DOM<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span>Item 3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>比较两棵虚拟 DOM 树的差异 — diff.js</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9XCj.png#alt=QF9XCj.png"></p>
<p>将两个虚拟 DOM 对象的差异应用到真正的 DOM 树 — patch.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">applyPatches</span>(<span class="params">node, currentPatches</span>) &#123;</span><br><span class="line">  currentPatches.<span class="title function_">forEach</span>(<span class="function">(<span class="params">currentPatch</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (currentPatch.<span class="property">type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REPLACE</span>:</span><br><span class="line">        <span class="keyword">var</span> newNode =</span><br><span class="line">          <span class="keyword">typeof</span> currentPatch.<span class="property">node</span> === <span class="string">&quot;string&quot;</span></span><br><span class="line">            ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(currentPatch.<span class="property">node</span>)</span><br><span class="line">            : currentPatch.<span class="property">node</span>.<span class="title function_">render</span>();</span><br><span class="line">        node.<span class="property">parentNode</span>.<span class="title function_">replaceChild</span>(newNode, node);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">REORDER</span>:</span><br><span class="line">        <span class="title function_">reorderChildren</span>(node, currentPatch.<span class="property">moves</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">PROPS</span>:</span><br><span class="line">        <span class="title function_">setProps</span>(node, currentPatch.<span class="property">props</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="attr">TEXT</span>:</span><br><span class="line">        node.<span class="property">textContent</span> = currentPatch.<span class="property">content</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Unknown patch type &quot;</span> + currentPatch.<span class="property">type</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三、Vue-源码-Virtual-DOM-简析"><a href="#三、Vue-源码-Virtual-DOM-简析" class="headerlink" title="三、Vue 源码 Virtual-DOM 简析"></a>三、Vue 源码 Virtual-DOM 简析</h1><p>我们从第二章节（Virtual-DOM 基础）中已经掌握 Virtual DOM 渲染成真实的 DOM 实际上要经历 VNode 的定义、diff、patch 等过程，所以本章节 Vue 源码的解析也按这几个过程来简析。</p>
<h2 id="3-1、VNode-模拟-DOM-树"><a href="#3-1、VNode-模拟-DOM-树" class="headerlink" title="3.1、VNode 模拟 DOM 树"></a>3.1、VNode 模拟 DOM 树</h2><h3 id="3-1-1、VNode-类简析"><a href="#3-1-1、VNode-类简析" class="headerlink" title="3.1.1、VNode 类简析"></a>3.1.1、VNode 类简析</h3><p>在 Vue.js 中，Virtual DOM 是用 VNode 这个 Class 去描述，它定义在 src&#x2F;core&#x2F;vdom&#x2F;vnode.js 中 ，从以下代码块中可以看到 Vue.js 中的 Virtual DOM 的定义较为复杂一些，因为它这里包含了很多 Vue.js 的特性。实际上 Vue.js 中 Virtual DOM 是借鉴了一个开源库  snabbdom 的实现，然后加入了一些 Vue.js 的一些特性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;;</span><br><span class="line">  <span class="attr">text</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">ns</span>: string | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// rendered in this component&#x27;s scope</span></span><br><span class="line">  <span class="attr">key</span>: string | number | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// component instance</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="keyword">void</span>; <span class="comment">// component placeholder node</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// strictly internal</span></span><br><span class="line">  <span class="attr">raw</span>: boolean; <span class="comment">// contains raw HTML? (server only)</span></span><br><span class="line">  <span class="attr">isStatic</span>: boolean; <span class="comment">// hoisted static node</span></span><br><span class="line">  <span class="attr">isRootInsert</span>: boolean; <span class="comment">// necessary for enter transition check</span></span><br><span class="line">  <span class="attr">isComment</span>: boolean; <span class="comment">// empty comment placeholder?</span></span><br><span class="line">  <span class="attr">isCloned</span>: boolean; <span class="comment">// is a cloned node?</span></span><br><span class="line">  <span class="attr">isOnce</span>: boolean; <span class="comment">// is a v-once node?</span></span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="keyword">void</span>; <span class="comment">// async component factory function</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: boolean;</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="keyword">void</span>;</span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="keyword">void</span>; <span class="comment">// real context vm for functional nodes</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span>; <span class="comment">// for SSR caching</span></span><br><span class="line">  <span class="attr">devtoolsMeta</span>: ?<span class="title class_">Object</span>; <span class="comment">// used to store functional render context for devtools</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?string; <span class="comment">// functional scope id support</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    tag?: string,</span></span><br><span class="line"><span class="params">    data?: VNodeData,</span></span><br><span class="line"><span class="params">    children?: ?<span class="built_in">Array</span>&lt;VNode&gt;,</span></span><br><span class="line"><span class="params">    text?: string,</span></span><br><span class="line"><span class="params">    elm?: Node,</span></span><br><span class="line"><span class="params">    context?: Component,</span></span><br><span class="line"><span class="params">    componentOptions?: VNodeComponentOptions,</span></span><br><span class="line"><span class="params">    asyncFactory?: <span class="built_in">Function</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里千万不要因为 VNode 的这么属性而被吓到，或者咬紧牙去摸清楚每个属性的意义，其实，我们主要了解其几个核心的关键属性就差不多了，例如：</p>
<ul>
<li><code>tag</code> 属性即这个 vnode 的标签属性</li>
<li><code>data</code> 属性包含了最后渲染成真实 dom 节点后，节点上的 class，attribute，style 以及绑定的事件</li>
<li><code>children</code> 属性是 vnode 的子节点</li>
<li><code>text</code> 属性是文本属性</li>
<li><code>elm</code> 属性为这个 vnode 对应的真实 dom 节点</li>
<li><code>key</code> 属性是 vnode 的标记，在 diff 过程中可以提高 diff 的效率</li>
</ul>
<h3 id="3-1-2、源码创建-VNode-过程"><a href="#3-1-2、源码创建-VNode-过程" class="headerlink" title="3.1.2、源码创建 VNode 过程"></a>3.1.2、源码创建 VNode 过程</h3><h4 id="（1）初始化-vue"><a href="#（1）初始化-vue" class="headerlink" title="（1）初始化 vue"></a>（1）初始化 vue</h4><p>我们在实例化一个 vue 实例，也即 new Vue( ) 时，实际上是执行 src&#x2F;core&#x2F;instance&#x2F;index.js 中定义的 Function 函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span>(<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span> &amp;&amp; !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&quot;Vue is a constructor and should be called with the `new` keyword&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过查看 Vue 的 function，我们知道 Vue 只能通过 new 关键字初始化，然后调用 this._init 方法，该方法在 src&#x2F;core&#x2F;instance&#x2F;init.js 中定义。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options?: <span class="built_in">Object</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略一系列其它初始化的代码</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;vm.$options.el:&quot;</span>, vm.<span class="property">$options</span>.<span class="property">el</span>);</span><br><span class="line">    vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="（2）Vue-实例挂载"><a href="#（2）Vue-实例挂载" class="headerlink" title="（2）Vue 实例挂载"></a>（2）Vue 实例挂载</h4><p>Vue 中是通过 $mount 实例方法去挂载 dom 的，下面我们通过分析 compiler 版本的 mount 实现，相关源码在目录 src&#x2F;platforms&#x2F;web&#x2F;entry-runtime-with-compiler.js 文件中定义：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mount = <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略一系列初始化以及逻辑判断代码</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们发现最终还是调用用原先原型上的 $mount 方法挂载 ，原先原型上的 $mount 方法在 src&#x2F;platforms&#x2F;web&#x2F;runtime&#x2F;index.js 中定义 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el?: string | Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们发现$mount 方法实际上会去调用 mountComponent 方法，这个方法定义在 src&#x2F;core&#x2F;instance&#x2F;lifecycle.js 文件中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  vm: Component,</span></span><br><span class="line"><span class="params">  el: ?Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el;</span><br><span class="line">  <span class="comment">// 省略一系列其它代码</span></span><br><span class="line">  <span class="keyword">let</span> updateComponent;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 生成虚拟 vnode</span></span><br><span class="line">      <span class="keyword">const</span> vnode = vm.<span class="title function_">_render</span>();</span><br><span class="line">      <span class="comment">// 更新 DOM</span></span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例化一个渲染Watcher，在它的回调函数中会调用 updateComponent 方法</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">    vm,</span><br><span class="line">    updateComponent,</span><br><span class="line">    noop,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title function_">before</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">          <span class="title function_">callHook</span>(vm, <span class="string">&quot;beforeUpdate&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span></span><br><span class="line">  );</span><br><span class="line">  hydrating = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看到，mountComponent 核心就是先实例化一个渲染 Watcher，在它的回调函数中会调用 updateComponent 方法，在此方法中调用 vm._render 方法先生成虚拟 Node，最终调用 vm._update 更新 DOM。</p>
<h4 id="（3）创建虚拟-Node"><a href="#（3）创建虚拟-Node" class="headerlink" title="（3）创建虚拟 Node"></a>（3）创建虚拟 Node</h4><p>Vue 的 _render 方法是实例的一个私有方法，它用来把实例渲染成一个虚拟 Node。它的定义在 src&#x2F;core&#x2F;instance&#x2F;render.js 文件中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span></span><br><span class="line">   <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line">   <span class="keyword">let</span> vnode</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// 省略一系列代码</span></span><br><span class="line">     currentRenderingInstance = vm</span><br><span class="line">     <span class="comment">// 调用 createElement 方法来返回 vnode</span></span><br><span class="line">     vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">   &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">     <span class="title function_">handleError</span>(<span class="params">e, vm, <span class="string">`render`</span></span>)&#123;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// set parent</span></span><br><span class="line">   vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;vnode...:&quot;</span>,vnode);</span><br><span class="line">   <span class="keyword">return</span> vnode</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>Vue.js 利用 _createElement 方法创建 VNode，它定义在 src&#x2F;core&#x2F;vdom&#x2F;create-elemenet.js 中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">_createElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">  context: Component,</span></span><br><span class="line"><span class="params">  tag?: string | Class&lt;Component&gt; | <span class="built_in">Function</span> | <span class="built_in">Object</span>,</span></span><br><span class="line"><span class="params">  data?: VNodeData,</span></span><br><span class="line"><span class="params">  children?: any,</span></span><br><span class="line"><span class="params">  normalizationType?: number</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">VNode</span> | <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 省略一系列非主线代码</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (normalizationType === <span class="variable constant_">ALWAYS_NORMALIZE</span>) &#123;</span><br><span class="line">    <span class="comment">// 场景是 render 函数不是编译生成的</span></span><br><span class="line">    children = <span class="title function_">normalizeChildren</span>(children);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (normalizationType === <span class="variable constant_">SIMPLE_NORMALIZE</span>) &#123;</span><br><span class="line">    <span class="comment">// 场景是 render 函数是编译生成的</span></span><br><span class="line">    children = <span class="title function_">simpleNormalizeChildren</span>(children);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> vnode, ns;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> tag === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="title class_">Ctor</span>;</span><br><span class="line">    ns = (context.<span class="property">$vnode</span> &amp;&amp; context.<span class="property">$vnode</span>.<span class="property">ns</span>) || config.<span class="title function_">getTagNamespace</span>(tag);</span><br><span class="line">    <span class="keyword">if</span> (config.<span class="title function_">isReservedTag</span>(tag)) &#123;</span><br><span class="line">      <span class="comment">// 创建虚拟 vnode</span></span><br><span class="line">      vnode = <span class="keyword">new</span> <span class="title class_">VNode</span>(</span><br><span class="line">        config.<span class="title function_">parsePlatformTagName</span>(tag),</span><br><span class="line">        data,</span><br><span class="line">        children,</span><br><span class="line">        <span class="literal">undefined</span>,</span><br><span class="line">        <span class="literal">undefined</span>,</span><br><span class="line">        context</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      (!data || !data.<span class="property">pre</span>) &amp;&amp;</span><br><span class="line">      <span class="title function_">isDef</span>((<span class="title class_">Ctor</span> = <span class="title function_">resolveAsset</span>(context.<span class="property">$options</span>, <span class="string">&quot;components&quot;</span>, tag)))</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// component</span></span><br><span class="line">      vnode = <span class="title function_">createComponent</span>(<span class="title class_">Ctor</span>, data, context, children, tag);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode = <span class="keyword">new</span> <span class="title class_">VNode</span>(tag, data, children, <span class="literal">undefined</span>, <span class="literal">undefined</span>, context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vnode = <span class="title function_">createComponent</span>(tag, data, context, children);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">return</span> vnode;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(ns)) <span class="title function_">applyNS</span>(vnode, ns);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(data)) <span class="title function_">registerDeepBindings</span>(data);</span><br><span class="line">    <span class="keyword">return</span> vnode;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createEmptyVNode</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>_createElement 方法有 5 个参数，context 表示 VNode 的上下文环境，它是 Component 类型；tag 表示标签，它可以是一个字符串，也可以是一个 Component；data 表示 VNode 的数据，它是一个 VNodeData 类型，可以在 flow&#x2F;vnode.js 中找到它的定义；children 表示当前 VNode 的子节点，它是任意类型的，需要被规范为标准的 VNode 数组；</p>
<h3 id="3-1-3、实例查看"><a href="#3-1-3、实例查看" class="headerlink" title="3.1.3、实例查看"></a>3.1.3、实例查看</h3><p>为了更直观查看我们平时写的 Vue 代码如何用 VNode 类来表示，我们通过一个实例的转换进行更深刻了解。</p>
<p>例如，实例化一个 Vue 实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&quot;#app&quot;</span>,</span><br><span class="line">  <span class="attr">render</span>: <span class="keyword">function</span> (<span class="params">createElement</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createElement</span>(</span><br><span class="line">      <span class="string">&quot;div&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">attrs</span>: &#123;</span><br><span class="line">          <span class="attr">id</span>: <span class="string">&quot;app&quot;</span>,</span><br><span class="line">          <span class="attr">class</span>: <span class="string">&quot;class_box&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">message</span></span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&quot;Hello Vue!&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们打印出其对应的 VNode 表示：</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9L5Q.png#alt=QF9L5Q.png"></p>
<h2 id="3-2、diff-过程"><a href="#3-2、diff-过程" class="headerlink" title="3.2、diff 过程"></a>3.2、diff 过程</h2><h3 id="3-2-1、Vue-js-源码的-diff-调用逻辑"><a href="#3-2-1、Vue-js-源码的-diff-调用逻辑" class="headerlink" title="3.2.1、Vue.js 源码的 diff 调用逻辑"></a>3.2.1、Vue.js 源码的 diff 调用逻辑</h3><p>Vue.js 源码实例化了一个 watcher，这个 ~ 被添加到了在模板当中所绑定变量的依赖当中，一旦 model 中的响应式的数据发生了变化，这些响应式的数据所维护的 dep 数组便会调用 dep.notify() 方法完成所有依赖遍历执行的工作，这包括视图的更新，即 updateComponent 方法的调用。watcher 和 updateComponent 方法定义在  src&#x2F;core&#x2F;instance&#x2F;lifecycle.js 文件中 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">mountComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  vm: Component,</span></span><br><span class="line"><span class="params">  el: ?Element,</span></span><br><span class="line"><span class="params">  hydrating?: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Component</span> &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el;</span><br><span class="line">  <span class="comment">// 省略一系列其它代码</span></span><br><span class="line">  <span class="keyword">let</span> updateComponent;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 生成虚拟 vnode</span></span><br><span class="line">      <span class="keyword">const</span> vnode = vm.<span class="title function_">_render</span>();</span><br><span class="line">      <span class="comment">// 更新 DOM</span></span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实例化一个渲染Watcher，在它的回调函数中会调用 updateComponent 方法</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(</span><br><span class="line">    vm,</span><br><span class="line">    updateComponent,</span><br><span class="line">    noop,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title function_">before</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (vm.<span class="property">_isMounted</span> &amp;&amp; !vm.<span class="property">_isDestroyed</span>) &#123;</span><br><span class="line">          <span class="title function_">callHook</span>(vm, <span class="string">&quot;beforeUpdate&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span></span><br><span class="line">  );</span><br><span class="line">  hydrating = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> vm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成视图的更新工作事实上就是调用了 vm._update 方法，这个方法接收的第一个参数是刚生成的 Vnode，调用的 vm._update 方法定义在 src&#x2F;core&#x2F;instance&#x2F;lifecycle.js 中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode: VNode, hydrating?: boolean</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">vm</span>: <span class="title class_">Component</span> = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">const</span> prevEl = vm.<span class="property">$el</span>;</span><br><span class="line">  <span class="keyword">const</span> prevVnode = vm.<span class="property">_vnode</span>;</span><br><span class="line">  <span class="keyword">const</span> restoreActiveInstance = <span class="title function_">setActiveInstance</span>(vm);</span><br><span class="line">  vm.<span class="property">_vnode</span> = vnode;</span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// 第一个参数为真实的node节点，则为初始化</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果需要diff的prevVnode存在，那么对prevVnode和vnode进行diff</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">restoreActiveInstance</span>();</span><br><span class="line">  <span class="comment">// update __vue__ reference</span></span><br><span class="line">  <span class="keyword">if</span> (prevEl) &#123;</span><br><span class="line">    prevEl.<span class="property">__vue__</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$el</span>) &#123;</span><br><span class="line">    vm.<span class="property">$el</span>.<span class="property">__vue__</span> = vm;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if parent is an HOC, update its $el as well</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> &amp;&amp; vm.<span class="property">$parent</span> &amp;&amp; vm.<span class="property">$vnode</span> === vm.<span class="property">$parent</span>.<span class="property">_vnode</span>) &#123;</span><br><span class="line">    vm.<span class="property">$parent</span>.<span class="property">$el</span> = vm.<span class="property">$el</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在这个方法当中最为关键的就是 <code>vm.__patch__</code> 方法，这也是整个 virtual-dom 当中最为核心的方法，主要完成了 prevVnode 和 vnode 的 diff 过程并根据需要操作的 vdom 节点打 patch，最后生成新的真实 dom 节点并完成视图的更新工作。</p>
<p>接下来，让我们看下 <code>vm.__patch__</code> 的逻辑过程， <code>vm.__patch__</code> 方法定义在 src&#x2F;core&#x2F;vdom&#x2F;patch.js 中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span> (oldVnode, vnode, hydrating, removeOnly) &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">      <span class="comment">// 当oldVnode不存在时，创建新的节点</span></span><br><span class="line">      isInitialPatch = <span class="literal">true</span></span><br><span class="line">      <span class="title function_">createElm</span>(vnode, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对oldVnode和vnode进行diff，并对oldVnode打patch</span></span><br><span class="line">      <span class="keyword">const</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>)</span><br><span class="line">      <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">        <span class="comment">// patch existing root node</span></span><br><span class="line">        <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="literal">null</span>, <span class="literal">null</span>, removeOnly)</span><br><span class="line">      &#125;</span><br><span class="line">	......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 patch 方法中，我们看到会分为两种情况，一种是当 oldVnode 不存在时，会创建新的节点；另一种则是已经存在 oldVnode ，那么会对 oldVnode 和 vnode 进行 diff 及 patch 的过程。其中 patch 过程中会调用 sameVnode 方法来对对传入的 2 个 vnode 进行基本属性的比较，只有当基本属性相同的情况下才认为这个 2 个 vnode 只是局部发生了更新，然后才会对这 2 个 vnode 进行 diff，如果 2 个 vnode 的基本属性存在不一致的情况，那么就会直接跳过 diff 的过程，进而依据 vnode 新建一个真实的 dom，同时删除老的 dom 节点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sameVnode</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    a.<span class="property">key</span> === b.<span class="property">key</span> &amp;&amp;</span><br><span class="line">    a.<span class="property">tag</span> === b.<span class="property">tag</span> &amp;&amp;</span><br><span class="line">    a.<span class="property">isComment</span> === b.<span class="property">isComment</span> &amp;&amp;</span><br><span class="line">    <span class="title function_">isDef</span>(a.<span class="property">data</span>) === <span class="title function_">isDef</span>(b.<span class="property">data</span>) &amp;&amp;</span><br><span class="line">    <span class="title function_">sameInputType</span>(a, b)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>diff 过程中主要是通过调用 patchVnode 方法进行的:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchVnode</span> (oldVnode, vnode, insertedVnodeQueue, ownerArray, index, removeOnly) &#123;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">const</span> elm = vnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span></span><br><span class="line"><span class="keyword">const</span> oldCh = oldVnode.<span class="property">children</span></span><br><span class="line"><span class="keyword">const</span> ch = vnode.<span class="property">children</span></span><br><span class="line"><span class="comment">// 如果vnode没有文本节点</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">    <span class="comment">// 如果oldVnode的children属性存在且vnode的children属性也存在</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh) &amp;&amp; <span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">    <span class="comment">// updateChildren，对子节点进行diff</span></span><br><span class="line">    <span class="keyword">if</span> (oldCh !== ch) <span class="title function_">updateChildren</span>(elm, oldCh, ch, insertedVnodeQueue, removeOnly)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">checkDuplicateKeys</span>(ch)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果oldVnode的text存在，那么首先清空text的内容,然后将vnode的children添加进去</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="title function_">addVnodes</span>(elm, <span class="literal">null</span>, ch, <span class="number">0</span>, ch.<span class="property">length</span> - <span class="number">1</span>, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh)) &#123;</span><br><span class="line">    <span class="comment">// 删除elm下的oldchildren</span></span><br><span class="line">    <span class="title function_">removeVnodes</span>(elm, oldCh, <span class="number">0</span>, oldCh.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123;</span><br><span class="line">    <span class="comment">// oldVnode有子节点，而vnode没有，那么就清空这个节点</span></span><br><span class="line">    nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== vnode.<span class="property">text</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果oldVnode和vnode文本属性不同，那么直接更新真是dom节点的文本元素</span></span><br><span class="line">    nodeOps.<span class="title function_">setTextContent</span>(elm, vnode.<span class="property">text</span>)</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从以上代码得知，</p>
<p>diff 过程中又分了好几种情况，oldCh 为 oldVnode 的子节点，ch 为 Vnode 的子节点：</p>
<p>首先进行文本节点的判断，若 oldVnode.text !&#x3D;&#x3D; vnode.text，那么就会直接进行文本节点的替换；</p>
<p>在 vnode 没有文本节点的情况下，进入子节点的 diff；</p>
<p>当 oldCh 和 ch 都存在且不相同的情况下，调用 updateChildren 对子节点进行 diff；</p>
<p>若 oldCh 不存在，ch 存在，首先清空 oldVnode 的文本节点，同时调用 addVnodes 方法将 ch 添加到 elm 真实 dom 节点当中；</p>
<p>若 oldCh 存在，ch 不存在，则删除 elm 真实节点下的 oldCh 子节点；</p>
<p>若 oldVnode 有文本节点，而 vnode 没有，那么就清空这个文本节点。</p>
<h3 id="3-2-2、子节点-diff-流程分析"><a href="#3-2-2、子节点-diff-流程分析" class="headerlink" title="3.2.2、子节点 diff 流程分析"></a>3.2.2、子节点 diff 流程分析</h3><h4 id="（1）Vue-js-源码"><a href="#（1）Vue-js-源码" class="headerlink" title="（1）Vue.js 源码"></a>（1）Vue.js 源码</h4><p>这里着重分析下 updateChildren 方法，它也是整个 diff 过程中最重要的环节，以下为 Vue.js 的源码过程，为了更形象理解 diff 过程，我们给出相关的示意图来讲解。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateChildren</span>(<span class="params"></span></span><br><span class="line"><span class="params">  parentElm,</span></span><br><span class="line"><span class="params">  oldCh,</span></span><br><span class="line"><span class="params">  newCh,</span></span><br><span class="line"><span class="params">  insertedVnodeQueue,</span></span><br><span class="line"><span class="params">  removeOnly</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 为oldCh和newCh分别建立索引，为之后遍历的依据</span></span><br><span class="line">  <span class="keyword">let</span> oldStartIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> newStartIdx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> oldStartVnode = oldCh[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">let</span> oldEndVnode = oldCh[oldEndIdx];</span><br><span class="line">  <span class="keyword">let</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> newStartVnode = newCh[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">let</span> newEndVnode = newCh[newEndIdx];</span><br><span class="line">  <span class="keyword">let</span> oldKeyToIdx, idxInOld, vnodeToMove, refElm;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 直到oldCh或者newCh被遍历完后跳出循环</span></span><br><span class="line">  <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldStartVnode)) &#123;</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]; <span class="comment">// Vnode has been moved left</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldEndVnode)) &#123;</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="title function_">patchVnode</span>(</span><br><span class="line">        oldStartVnode,</span><br><span class="line">        newStartVnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        newCh,</span><br><span class="line">        newStartIdx</span><br><span class="line">      );</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="title function_">patchVnode</span>(</span><br><span class="line">        oldEndVnode,</span><br><span class="line">        newEndVnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        newCh,</span><br><span class="line">        newEndIdx</span><br><span class="line">      );</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      newEndVnode = newCh[--newEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="comment">// Vnode moved right</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(</span><br><span class="line">        oldStartVnode,</span><br><span class="line">        newEndVnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        newCh,</span><br><span class="line">        newEndIdx</span><br><span class="line">      );</span><br><span class="line">      canMove &amp;&amp;</span><br><span class="line">        nodeOps.<span class="title function_">insertBefore</span>(</span><br><span class="line">          parentElm,</span><br><span class="line">          oldStartVnode.<span class="property">elm</span>,</span><br><span class="line">          nodeOps.<span class="title function_">nextSibling</span>(oldEndVnode.<span class="property">elm</span>)</span><br><span class="line">        );</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx];</span><br><span class="line">      newEndVnode = newCh[--newEndIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="comment">// Vnode moved left</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(</span><br><span class="line">        oldEndVnode,</span><br><span class="line">        newStartVnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        newCh,</span><br><span class="line">        newStartIdx</span><br><span class="line">      );</span><br><span class="line">      canMove &amp;&amp;</span><br><span class="line">        nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldEndVnode.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx];</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldKeyToIdx))</span><br><span class="line">        oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">      idxInOld = <span class="title function_">isDef</span>(newStartVnode.<span class="property">key</span>)</span><br><span class="line">        ? oldKeyToIdx[newStartVnode.<span class="property">key</span>]</span><br><span class="line">        : <span class="title function_">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123;</span><br><span class="line">        <span class="comment">// New element</span></span><br><span class="line">        <span class="title function_">createElm</span>(</span><br><span class="line">          newStartVnode,</span><br><span class="line">          insertedVnodeQueue,</span><br><span class="line">          parentElm,</span><br><span class="line">          oldStartVnode.<span class="property">elm</span>,</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          newCh,</span><br><span class="line">          newStartIdx</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        vnodeToMove = oldCh[idxInOld];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">          <span class="title function_">patchVnode</span>(</span><br><span class="line">            vnodeToMove,</span><br><span class="line">            newStartVnode,</span><br><span class="line">            insertedVnodeQueue,</span><br><span class="line">            newCh,</span><br><span class="line">            newStartIdx</span><br><span class="line">          );</span><br><span class="line">          oldCh[idxInOld] = <span class="literal">undefined</span>;</span><br><span class="line">          canMove &amp;&amp;</span><br><span class="line">            nodeOps.<span class="title function_">insertBefore</span>(parentElm, vnodeToMove.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// same key but different element. treat as new element</span></span><br><span class="line">          <span class="title function_">createElm</span>(</span><br><span class="line">            newStartVnode,</span><br><span class="line">            insertedVnodeQueue,</span><br><span class="line">            parentElm,</span><br><span class="line">            oldStartVnode.<span class="property">elm</span>,</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            newCh,</span><br><span class="line">            newStartIdx</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      newStartVnode = newCh[++newStartIdx];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">    refElm = <span class="title function_">isUndef</span>(newCh[newEndIdx + <span class="number">1</span>]) ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].<span class="property">elm</span>;</span><br><span class="line">    <span class="title function_">addVnodes</span>(</span><br><span class="line">      parentElm,</span><br><span class="line">      refElm,</span><br><span class="line">      newCh,</span><br><span class="line">      newStartIdx,</span><br><span class="line">      newEndIdx,</span><br><span class="line">      insertedVnodeQueue</span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">    <span class="title function_">removeVnodes</span>(parentElm, oldCh, oldStartIdx, oldEndIdx);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在开始遍历 diff 前，首先给 oldCh 和 newCh 分别分配一个 startIndex 和 endIndex 来作为遍历的索引，当 oldCh 或者 newCh 遍历完后(遍历完的条件就是 oldCh 或者 newCh 的 startIndex &gt;&#x3D; endIndex )，就停止 oldCh 和 newCh 的 diff 过程。接下来通过实例来看下整个 diff 的过程(节点属性中不带 key 的情况)。</p>
<h4 id="（2）无-key-的-diff-过程"><a href="#（2）无-key-的-diff-过程" class="headerlink" title="（2）无 key 的 diff 过程"></a>（2）无 key 的 diff 过程</h4><p>我们通过以下示意图对以上代码过程进行讲解：</p>
<p>####（2.1）首先从第一个节点开始比较，不管是 oldCh 还是 newCh 的起始或者终止节点都不存在 sameVnode ，同时节点属性中是不带 key 标记的，因此第一轮的 diff 完后，newCh 的 startVnode 被添加到 oldStartVnode 的前面，同时 newStartIndex 前移一位；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9qUg.jpg#alt=QF9qUg.jpg"></p>
<p>（2.2）第二轮的 diff 中，满足 sameVnode(oldStartVnode, newStartVnode)，因此对这 2 个 vnode 进行 diff，最后将 patch 打到 oldStartVnode 上，同时 oldStartVnode 和 newStartIndex 都向前移动一位 ；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9bVS.jpg#alt=QF9bVS.jpg"></p>
<p>（2.3）第三轮的 diff 中，满足 sameVnode(oldEndVnode, newStartVnode)，那么首先对 oldEndVnode 和 newStartVnode 进行 diff，并对 oldEndVnode 进行 patch，并完成 oldEndVnode 移位的操作，最后 newStartIndex 前移一位，oldStartVnode 后移一位；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9v2n.jpg#alt=QF9v2n.jpg"></p>
<p>（2.4）第四轮的 diff 中，过程同步骤 3；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QF9xvq.jpg#alt=QF9xvq.jpg"></p>
<p>（2.5）第五轮的 diff 中，同过程 1；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCSK0.jpg#alt=QFCSK0.jpg"></p>
<p>（2.6）遍历的过程结束后，newStartIdx &gt; newEndIdx，说明此时 oldCh 存在多余的节点，那么最后就需要将这些多余的节点删除。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCprV.jpg#alt=QFCprV.jpg"></p>
<h4 id="（3）有-key-的-diff-流程"><a href="#（3）有-key-的-diff-流程" class="headerlink" title="（3）有 key 的 diff 流程"></a>（3）有 key 的 diff 流程</h4><p>在 vnode 不带 key 的情况下，每一轮的 diff 过程当中都是起始和结束节点进行比较，直到 oldCh 或者 newCh 被遍历完。而当为 vnode 引入 key 属性后，在每一轮的 diff 过程中，当起始和结束节点都没有找到 sameVnode 时，然后再判断在 newStartVnode 的属性中是否有 key，且是否在 oldKeyToIndx 中找到对应的节点 ：</p>
<p>如果不存在这个 key，那么就将这个 newStartVnode 作为新的节点创建且插入到原有的 root 的子节点中；</p>
<p>如果存在这个 key，那么就取出 oldCh 中的存在这个 key 的 vnode，然后再进行 diff 的过；</p>
<p>通过以上分析，给 vdom 上添加 key 属性后，遍历 diff 的过程中，当起始点，结束点的搜寻及 diff 出现还是无法匹配的情况下时，就会用 key 来作为唯一标识，来进行 diff，这样就可以提高 diff 效率。</p>
<p>带有 Key 属性的 vnode 的 diff 过程可见下图：</p>
<p>（3.1）首先从第一个节点开始比较，不管是 oldCh 还是 newCh 的起始或者终止节点都不存在 sameVnode，但节点属性中是带 key 标记的， 然后在 oldKeyToIndx 中找到对应的节点，这样第一轮 diff 过后 oldCh 上的 B 节点被删除了，但是 newCh 上的 B 节点上 elm 属性保持对 oldCh 上 B 节点 的 elm 引用。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFC9bT.jpg#alt=QFC9bT.jpg"></p>
<p>（3.2）第二轮的 diff 中，满足 sameVnode(oldStartVnode, newStartVnode)，因此对这 2 个 vnode 进行 diff，最后将 patch 打到 oldStartVnode 上，同时 oldStartVnode 和 newStartIndex 都向前移动一位 ；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCiaF.jpg#alt=QFCiaF.jpg"></p>
<p>（3.3）第三轮的 diff 中，满足 sameVnode(oldEndVnode, newStartVnode)，那么首先对 oldEndVnode 和 newStartVnode 进行 diff，并对 oldEndVnode 进行 patch，并完成 oldEndVnode 移位的操作，最后 newStartIndex 前移一位，oldStartVnode 后移一位；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCF54.jpg#alt=QFCF54.jpg"></p>
<p>（3.4）第四轮的 diff 中，过程同步骤 2；</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCAPJ.jpg#alt=QFCAPJ.jpg"></p>
<p>（3.5）第五轮的 diff 中，因为此时 oldStartIndex 已经大于 oldEndIndex，所以将剩余的 Vnode 队列插入队列最后。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCEG9.jpg#alt=QFCEG9.jpg"></p>
<p>3.3、patch 过程</p>
<p>通过 3.2 章节介绍的 diff 过程中，我们会看到 nodeOps 相关的方法对真实 DOM 结构进行操作，nodeOps 定义在 src&#x2F;platforms&#x2F;web&#x2F;runtime&#x2F;node-ops.js 中，其为基本 DOM 操作，这里就不在详细介绍。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createElementNS</span>(<span class="params">namespace: string, tagName: string</span>): <span class="title class_">Element</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createElementNS</span>(namespaceMap[namespace], tagName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createTextNode</span>(<span class="params">text: string</span>): <span class="title class_">Text</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createComment</span>(<span class="params">text: string</span>): <span class="title class_">Comment</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">document</span>.<span class="title function_">createComment</span>(text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">insertBefore</span>(<span class="params"></span></span><br><span class="line"><span class="params">  parentNode: Node,</span></span><br><span class="line"><span class="params">  newNode: Node,</span></span><br><span class="line"><span class="params">  referenceNode: Node</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  parentNode.<span class="title function_">insertBefore</span>(newNode, referenceNode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">removeChild</span>(<span class="params">node: Node, child: Node</span>) &#123;</span><br><span class="line">  node.<span class="title function_">removeChild</span>(child);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.4、总结</p>
<p>通过前三小节简析，我们从主线上把模板和数据如何渲染成最终的 DOM 的过程分析完毕了，我们可以通过下图更直观地看到从初始化 Vue 到最终渲染的整个过程。</p>
<p><img src="https://s2.ax1x.com/2019/11/28/QFCV2R.png#alt=QFCV2R.png"></p>
<h1 id="转载"><a href="#转载" class="headerlink" title="转载"></a>转载</h1><p>本文转载自<a target="_blank" rel="noopener" href="https://github.com/fengshi123/blog/issues/10">https://github.com/fengshi123/blog/issues/10</a></p>
<p>感谢作者<a href="/fengshi123">@fengshi123 </a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/28/yuque/%E8%99%9A%E6%8B%9Fdom/" data-id="cl9xpujuk009odmop7l0fedn2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS%E8%BF%9B%E9%98%B6/" rel="tag">JS进阶</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-全栈开发后台资金管理系统项目" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/27/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91%E5%90%8E%E5%8F%B0%E8%B5%84%E9%87%91%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time datetime="2019-11-27T07:58:28.000Z" itemprop="datePublished">2019-11-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/27/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91%E5%90%8E%E5%8F%B0%E8%B5%84%E9%87%91%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE/">全栈开发后台资金管理系统项目</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="后端部分"><a href="#后端部分" class="headerlink" title="后端部分"></a>后端部分</h1><h4 id="1-nodemon-使用"><a href="#1-nodemon-使用" class="headerlink" title="1. nodemon 使用"></a>1. nodemon 使用</h4><p>当我们做服务器的时候，每次变更都要重启才能生效。<br>如：我们创建了一个名为 server.js 的文件，作为服务器<br>使用<code>node ./server.js</code>即可启动，但我们对其修改后，要看效果就要关闭之前的再启动。<br>而 nodemon 帮我们解决这个问题。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install nodemon -g <span class="comment">//全局安装nodemon</span></span><br></pre></td></tr></table></figure>

<p>然后就可以使用 nodemon 运行我们的服务器了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodemon ./server.<span class="property">js</span></span><br></pre></td></tr></table></figure>

<p>这时，修改文件，服务器会自动重启。<br>将命令设置到 package.json。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在package.json中修改</span></span><br><span class="line"><span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;start&quot;</span>: <span class="string">&quot;node server.js&quot;</span>,</span><br><span class="line">    <span class="string">&quot;server&quot;</span>: <span class="string">&quot;nodemon server.js&quot;</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>这样在就可以使用<code>npm run start</code>或<code>npm run server</code>来运行服务器</p>
<h4 id="2-连接数据库"><a href="#2-连接数据库" class="headerlink" title="2.连接数据库"></a>2.连接数据库</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//node-app下执行</span></span><br><span class="line">npm install mongoose</span><br></pre></td></tr></table></figure>

<p>为方便修改配置，新建文件 &#x2F;config&#x2F;keys.js, 内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mongoURI</span>:</span><br><span class="line">    <span class="string">&quot;mongodb://&lt;username&gt;:&lt;password&gt;@cluster0-shard-00-00-oqdfe.mongodb.net:27017,cluster0-shard-00-01-oqdfe.mongodb.net:27017,cluster0-shard-00-02-oqdfe.mongodb.net:27017/test?ssl=true&amp;replicaSet=Cluster0-shard-0&amp;authSource=admin&amp;retryWrites=true&amp;w=majority&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>该链接需要到 mongoDB 官网注册账户，获取 500M 免费空间，创建一个 Preject 再创建 Clusters，之后点击”Connect”,选择”Connect your Application”进入下一步，域名选择默认确定即可.DRIVER 选择“node.js”, VERSION 选择”2.2.12 or later”,然后 copy 下面的链接即可，注意修改&lt;username&gt;:&lt;password&gt;为对应的用户名和密码。可以在”Database Access”中添加和修改用户。<br>在 server.js 中引用</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DB config</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">&quot;./config/keys&quot;</span>).<span class="property">mongoURI</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接数据库</span></span><br><span class="line"><span class="comment">//Connect to mongodb</span></span><br><span class="line">mongoose.<span class="title function_">connect</span>(db, &#123;</span><br><span class="line">  <span class="comment">//第一个参数db是在线数据库的地址,也可以直接将地址写入这里,美观起见,另写一个文件存储</span></span><br><span class="line">    <span class="attr">useNewUrlParser</span>: <span class="literal">true</span>,<span class="comment">//防止弃用警告</span></span><br><span class="line">    <span class="attr">useUnifiedTopology</span>: <span class="literal">true</span>,<span class="comment">//防止弃用警告</span></span><br><span class="line">    <span class="attr">useFindAndModify</span>: <span class="literal">false</span> <span class="comment">//防止弃用警告</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">//提供promise调用</span></span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;mongoDB Connected&quot;</span>)) <span class="comment">//成功</span></span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err)); <span class="comment">//失败</span></span><br></pre></td></tr></table></figure>

<h4 id="3-配置路由和接口"><a href="#3-配置路由和接口" class="headerlink" title="3.配置路由和接口"></a>3.配置路由和接口</h4><p>在 node-app 下创建 &#x2F;route&#x2F;api&#x2F;users.js,内容:<br>用于登录和注册</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//users.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//引入express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="comment">//实例化路由</span></span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// $route GET api/users/test</span></span><br><span class="line"><span class="comment">//@desc 返回请求的json数据</span></span><br><span class="line"><span class="comment">//@access public(公有接口)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//验证路由，访问/test，将返回`msg:&quot;login works&quot;`</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/test&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//返回json数据</span></span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&quot;login works&quot;</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//导出router</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<p>在 server.js 中引用和使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="comment">//引入users.js</span></span><br><span class="line"><span class="keyword">const</span> users = <span class="built_in">require</span>(<span class="string">&quot;./route/api/users&quot;</span>);</span><br><span class="line"><span class="comment">//路由访问这个地址时,就会访问users</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/api/users&quot;</span>, users);</span><br></pre></td></tr></table></figure>

<p>这时 使用浏览器访问 <code>http://localhost:5000/api/users/test</code>即可看到返回的<code>msg:&quot;login works&quot;</code></p>
<h4 id="4-创建模型"><a href="#4-创建模型" class="headerlink" title="4.创建模型"></a>4.创建模型</h4><p>新建 &#x2F;models&#x2F;User.js,</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//User.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//引入mongoose.可以将数据存储到mongoose</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"><span class="comment">//创建Schema模型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Schema</span> = mongoose.<span class="property">Schema</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//create Schema</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">UserSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">email</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">password</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">avatar</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">date</span>: &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">Date</span>,</span><br><span class="line">    <span class="attr">default</span>: <span class="title class_">Date</span>.<span class="property">now</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">User</span> = mongoose.<span class="title function_">model</span>(<span class="string">&quot;users&quot;</span>, <span class="title class_">UserSchema</span>);</span><br></pre></td></tr></table></figure>

<h4 id="4-5-下载postman-安装"><a href="#4-5-下载postman-安装" class="headerlink" title="4.5 下载postman,安装"></a>4.5 下载postman,安装</h4><p>可以用来测试接口是否通.</p>
<h4 id="4-6-创建register接口"><a href="#4-6-创建register接口" class="headerlink" title="4.6 创建register接口"></a>4.6 创建register接口</h4><p>首先需要安装body-parser.</p>
<h4 id="5-配置注册"><a href="#5-配置注册" class="headerlink" title="5.配置注册"></a>5.配置注册</h4><p>安装 body-parser，方便发送 POST 请求</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install <span class="keyword">body</span>-parser</span><br></pre></td></tr></table></figure>

<p>在 server.js 中引用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&quot;body-parser&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用body-parser中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>());</span><br></pre></td></tr></table></figure>

<p>在 users.js 中配置接口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route POST api/uers/register</span></span><br><span class="line"><span class="comment">//@desc 返回请求的JSON数据</span></span><br><span class="line"><span class="comment">//@access public （公有接口）</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/register&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">body</span>); <span class="comment">//用来测试是否连接</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>&#x2F;&#x2F;此处如果连接不上mongoDB,可能是白名单失效.再添加一个白名单在mongoDB即可.</p>
<p>功能</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.是否有邮箱</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/register&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//查询数据库中是否拥有邮箱</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">email</span>: req.<span class="property">body</span>.<span class="property">email</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (user) &#123;</span><br><span class="line">      <span class="comment">//如果存在</span></span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; <span class="attr">email</span>: <span class="string">&quot;邮箱已被注册！&quot;</span> &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//否则不存在</span></span><br><span class="line">      <span class="keyword">const</span> newUser = <span class="keyword">new</span> <span class="title class_">User</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: req.<span class="property">body</span>.<span class="property">name</span>,</span><br><span class="line">        <span class="attr">email</span>: req.<span class="property">body</span>.<span class="property">email</span>,</span><br><span class="line">        <span class="attr">password</span>: req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="密码加密"><a href="#密码加密" class="headerlink" title="密码加密"></a>密码加密</h5><p>安装 bcrypt</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> bcrypt</span><br></pre></td></tr></table></figure>

<p>在 users.js 中引入，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&quot;bcrypt&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>官方详细说明<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcrypt">链接</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bcrypt.<span class="title function_">genSalt</span>(<span class="number">10</span>, <span class="keyword">function</span>(<span class="params">err, salt</span>) &#123;</span><br><span class="line">  <span class="comment">//10是加密的一种模式</span></span><br><span class="line">  bcrypt.<span class="title function_">hash</span>(newUser.<span class="property">password</span>, salt, <span class="function">(<span class="params">err, hash</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//newUser.password 是加密对象，salt是回调函数，最后是加密结果</span></span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err; <span class="comment">//如果存在错误，则抛出。 throw是js语法，抛出</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有错误，则把加密过的密码hash赋值给password</span></span><br><span class="line">    newUser.<span class="property">password</span> = hash;</span><br><span class="line">    <span class="comment">//将newUser存储</span></span><br><span class="line">    newUser</span><br><span class="line">      .<span class="title function_">save</span>()</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> res.<span class="title function_">json</span>(user))</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="头像-avatar"><a href="#头像-avatar" class="headerlink" title="头像 avatar"></a>头像 avatar</h4><p>gravatar 官方说明<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/gravatar">链接</a><br>安装</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">npm</span> i gravatar</span><br></pre></td></tr></table></figure>

<p>user.js 中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> gravatar = <span class="built_in">require</span>(<span class="string">&quot;gravatar&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>在接口位置使用(user.js)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user) &#123;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; <span class="attr">email</span>: <span class="string">&quot;邮箱已被注册！&quot;</span> &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> avatar = gravatar.<span class="title function_">url</span>(req.<span class="property">body</span>.<span class="property">email</span>, &#123; <span class="attr">s</span>: <span class="string">&quot;200&quot;</span>, <span class="attr">r</span>: <span class="string">&quot;pg&quot;</span>, <span class="attr">d</span>: <span class="string">&quot;mm&quot;</span> &#125;); <span class="comment">//s是大小。r是头像格式。mm是灰色的头像</span></span><br><span class="line">  <span class="keyword">const</span> newUser = <span class="keyword">new</span> <span class="title class_">User</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: req.<span class="property">body</span>.<span class="property">name</span>,</span><br><span class="line">    <span class="attr">email</span>: req.<span class="property">body</span>.<span class="property">email</span>,</span><br><span class="line">    avatar, <span class="comment">//引入头像</span></span><br><span class="line">    <span class="attr">password</span>: req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何得到头像？</p>
<ol>
<li>打开 <a target="_blank" rel="noopener" href="https://cn.gravatar.com/">gravatar 网址</a></li>
<li>注册 gravatar，其注册实际是注册了 wordpress.com 网站的账户，然后登录 gravatar，任意格式的邮箱均可申请成功，但无法收到邮件，则无法验证并修改头像。因此要使用可以收到验证的邮箱。</li>
<li>上传头像。上传图片时，最后会选择图片会有<code>Choose a rating for your Gravatar</code> ，有四个选项，G、PG、R、X,这里我们选择 pg，我们在使用时也是<code>r: &#39;pg&#39;</code>，需要保持一致。</li>
</ol>
<p>这时，我们使用 postman 向 <a target="_blank" rel="noopener" href="http://localhost:5000/api/users/register">http://localhost:5000/api/users/register</a> 发送 post 请求，使用(application&#x2F;x-www-form-urlencoded)(key:email value:<a href="mailto:&#x75;&#115;&#x65;&#x72;&#x40;&#117;&#x73;&#101;&#x72;&#x74;&#101;&#x73;&#x74;&#46;&#99;&#111;&#109;">&#x75;&#115;&#x65;&#x72;&#x40;&#117;&#x73;&#101;&#x72;&#x74;&#101;&#x73;&#x74;&#46;&#99;&#111;&#109;</a>) 就能得到设置的头像了。</p>
<h4 id="7-登录接口"><a href="#7-登录接口" class="headerlink" title="7.登录接口"></a>7.登录接口</h4><p>users.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route POST api/users/login</span></span><br><span class="line"><span class="comment">//@desc 返回taken jwt passport</span></span><br><span class="line"><span class="comment">//@access public （公有接口）</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/login&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> email = req.<span class="property">body</span>.<span class="property">email</span>;</span><br><span class="line">  <span class="keyword">const</span> password = req.<span class="property">body</span>.<span class="property">password</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//查询数据库,看email是否存在</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; email &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(&#123; <span class="attr">email</span>: <span class="string">&quot;用户不存在&quot;</span> &#125;); <span class="comment">//如果用户不存在</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果email存在</span></span><br><span class="line">    <span class="comment">//密码匹配</span></span><br><span class="line">    <span class="comment">//第一个password是前端传入密码，user.password是系统内密码</span></span><br><span class="line">    bcrypt.<span class="title function_">compare</span>(password, user.<span class="property">password</span>).<span class="title function_">then</span>(<span class="function"><span class="params">isMatch</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isMatch) &#123;</span><br><span class="line">        res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&quot;success&quot;</span> &#125;); <span class="comment">//如果密码对比正确,(实际这里返回token,但暂时先返回msg)</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123; <span class="attr">password</span>: <span class="string">&quot;密码错误！&quot;</span> &#125;); <span class="comment">//如果密码对比不正确</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="返回-token"><a href="#返回-token" class="headerlink" title="返回 token"></a>返回 token</h4><p>安装 jsonwebtoken (jwt)</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> jsonwebtoken</span><br></pre></td></tr></table></figure>

<p>在 users.js 引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&quot;jsonwebtoken&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>在密码验证成功处插入</p>
<blockquote>
<p>我们在 config&#x2F;keys.js 导出的对象中，加入了 secretOrKey:”secret” 属性和值，再引入到 users.js 以方便统一管理配置。<br>过期时间的 3600 单位为秒<br>token 前必须是 “Bearer ”(送信人的意思)，<strong>末尾空格</strong>也不可缺少。<br>如果 success 为 true，就应该得到 token 值</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//替换上面的res.json(&#123; msg: &quot;success&quot; &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//jwt.sign(&quot;规则&quot;,&quot;加密名字&quot;,&quot;过期时间&quot;,&quot;箭头函数&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rule = &#123; <span class="attr">id</span>: user.<span class="property">id</span>, <span class="attr">name</span>: user.<span class="property">name</span> &#125;; <span class="comment">//可以更多</span></span><br><span class="line"><span class="comment">//sign签名</span></span><br><span class="line">jwt.<span class="title function_">sign</span>(rule, keys.<span class="property">secretOrKey</span>, &#123; <span class="attr">expiresIn</span>: <span class="number">3600</span> &#125;, <span class="function">(<span class="params">err, token</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">//&quot;Bearer &quot;前缀是固定的,意思是送信者.后面有个空格</span></span><br><span class="line">    <span class="attr">token</span>: <span class="string">&quot;Bearer &quot;</span> + token </span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// res.json(&#123;msg:&quot;success&quot;&#125;);</span></span><br></pre></td></tr></table></figure>

<h4 id="验证-token"><a href="#验证-token" class="headerlink" title="验证 token"></a>验证 token</h4><p>token相当于一个令牌或者钥匙.<br>使用passport-jwt进行token验证.</p>
<p><code>users.js</code> 加入接口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route GET api/users/current</span></span><br><span class="line"><span class="comment">//@desc return current user</span></span><br><span class="line"><span class="comment">//@access Privates</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//router.get(&quot;/current&quot;, &quot;验证token&quot;,(req, res) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//在中间验证token,但是需要passport,还没装,会报错,暂时删掉</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/current&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">msg</span>: <span class="string">&quot;success&quot;</span> &#125;); <span class="comment">//测试使用，后期有修改</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="安装-passport-jwt-和-passport"><a href="#安装-passport-jwt-和-passport" class="headerlink" title="安装 passport-jwt 和 passport"></a>安装 passport-jwt 和 passport</h5><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">npm</span> install pass<span class="keyword">port</span>-jwt passport</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/passport">passport 网址</a><br><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/passport-jwt">passport-jwt 网址</a><br>在 <code>server.js</code> 中引入,并初始化</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> passport = <span class="built_in">require</span>(<span class="string">&quot;passport&quot;</span>);</span><br><span class="line"><span class="comment">//passport初始化</span></span><br><span class="line">app.<span class="title function_">use</span>(passport.<span class="title function_">initialize</span>());</span><br></pre></td></tr></table></figure>

<p>新建文件 <code>/config/passport.js</code>,内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">JwtStrategy</span> = <span class="built_in">require</span>(<span class="string">&quot;passport-jwt&quot;</span>).<span class="property">Strategy</span>,</span><br><span class="line">  <span class="title class_">ExtractJwt</span> = <span class="built_in">require</span>(<span class="string">&quot;passport-jwt&quot;</span>).<span class="property">ExtractJwt</span>;</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = mongoose.<span class="title function_">model</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> keys = <span class="built_in">require</span>(<span class="string">&quot;../config/keys&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> opts = &#123;&#125;;</span><br><span class="line">opts.<span class="property">jwtFromRequest</span> = <span class="title class_">ExtractJwt</span>.<span class="title function_">fromAuthHeaderAsBearerToken</span>();</span><br><span class="line">opts.<span class="property">secretOrKey</span> = keys.<span class="property">secretOrKey</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">passport</span> =&gt;</span> &#123;</span><br><span class="line">  passport.<span class="title function_">use</span>(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">JwtStrategy</span>(opts, <span class="function">(<span class="params">jwt_payload, done</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//console.log(jwt_payload);</span></span><br><span class="line">      <span class="comment">//通过id获取用户</span></span><br><span class="line">      <span class="title class_">User</span>.<span class="title function_">findById</span>(jwt_payload.<span class="property">id</span>)</span><br><span class="line">        <span class="comment">//获取成功</span></span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">user</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">//如果用户存在</span></span><br><span class="line">          <span class="keyword">if</span> (user) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">done</span>(<span class="literal">null</span>, user);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//如果用户不存在</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">done</span>(<span class="literal">null</span>, <span class="literal">false</span>); </span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//获取失败</span></span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(err));</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在 server.js 中引入 passport.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(passport.<span class="title function_">initialize</span>());</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;./config/passport&quot;</span>)(passport); <span class="comment">//这样代码就不需要在当前server.js中写了</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里使用了一个技巧，<code>require(&quot;xxx.js&quot;)（对象）</code> 将对象传入xxx.js,同时将该js引入当前文件中。这样就可以在<code>xxx.js</code>中编写代码，实现分离，而且在xxx.js可以使用传入的对象。</p>
</blockquote>
<p>在 users.js 中引入 passport，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//users.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> passport = <span class="built_in">require</span>(<span class="string">&quot;passport&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//完成token验证，返回部分信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//$route GET api/users/current</span></span><br><span class="line"><span class="comment">//@desc return current user</span></span><br><span class="line"><span class="comment">//@access Privates</span></span><br><span class="line">router.<span class="title function_">get</span>(</span><br><span class="line">  <span class="string">&quot;/current&quot;</span>,</span><br><span class="line">  passport.<span class="title function_">authenticate</span>(<span class="string">&quot;jwt&quot;</span>, &#123; <span class="attr">session</span>: <span class="literal">false</span> &#125;),</span><br><span class="line">  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">id</span>: req.<span class="property">user</span>.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">name</span>: req.<span class="property">user</span>.<span class="property">name</span>,</span><br><span class="line">      <span class="attr">email</span>: req.<span class="property">user</span>.<span class="property">email</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<blockquote>
<p>这里调整了一些输出的内容，将输出对象改为了字符串，可能造成代码实际和上面有些出入。</p>
</blockquote>
<hr>
<h4 id="添加身份"><a href="#添加身份" class="headerlink" title="添加身份"></a>添加身份</h4><p>如果想在 user 中添加其他信息(比如添加管理员)可参考此内容<br>在 <code>models/User.js</code> 的 UserSchema 中添加身份字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">identity</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>在 <code>api/users.js</code> 中加入信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// newUser中</span></span><br><span class="line"><span class="keyword">const</span> newUser = <span class="keyword">new</span> <span class="title class_">User</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: req.<span class="property">body</span>.<span class="property">name</span>,</span><br><span class="line">  <span class="attr">email</span>: req.<span class="property">body</span>.<span class="property">email</span>,</span><br><span class="line">  avatar,</span><br><span class="line">  <span class="attr">password</span>: req.<span class="property">body</span>.<span class="property">password</span>,</span><br><span class="line">  <span class="attr">identity</span>: req.<span class="property">body</span>.<span class="property">identity</span> <span class="comment">//添加的信息</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码匹配规则中</span></span><br><span class="line"><span class="keyword">const</span> rule = &#123;</span><br><span class="line">  <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">  <span class="attr">name</span>: user.<span class="property">name</span>,</span><br><span class="line">  <span class="attr">avatar</span>: user.<span class="property">avatar</span>,</span><br><span class="line">  <span class="attr">identity</span>: user.<span class="property">identity</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//验证token输出信息时</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/current&quot;</span>,passport.<span class="title function_">authenticate</span>(<span class="string">&quot;jwt&quot;</span>,&#123;<span class="attr">session</span>:<span class="literal">false</span>&#125;), <span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">id</span>:req.<span class="property">user</span>.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">name</span>:req.<span class="property">user</span>.<span class="property">name</span>,</span><br><span class="line">    <span class="attr">email</span>:req.<span class="property">user</span>.<span class="property">email</span>,</span><br><span class="line">    <span class="attr">identity</span>:req.<span class="property">user</span>.<span class="property">identity</span> <span class="comment">//添加的内容</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="配置信息接口"><a href="#配置信息接口" class="headerlink" title="配置信息接口"></a>配置信息接口</h4><p>新建 models&#x2F;Profile.js 建立ProfileSchema，内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Schema</span> = mongoose.<span class="property">Schema</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//create Schema</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ProfileSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">type</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">describe</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">income</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">expend</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">cash</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">required</span>:<span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">remark</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">date</span>:&#123;</span><br><span class="line">    <span class="attr">type</span>:<span class="title class_">Date</span>,</span><br><span class="line">    <span class="attr">default</span>:<span class="title class_">Date</span>.<span class="property">now</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Profile</span> = mongoose.<span class="title function_">model</span>(<span class="string">&quot;profile&quot;</span>,<span class="title class_">ProfileSchema</span>);</span><br></pre></td></tr></table></figure>
<p>新建 api&#x2F;profiles.js 暂不写内容，将其在server.js中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js</span></span><br><span class="line"><span class="keyword">const</span> profiles = <span class="built_in">require</span>(<span class="string">&quot;./route/api/profiles&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用route</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="string">&quot;/api/profiles&quot;</span>, profiles);</span><br></pre></td></tr></table></figure>
<p>在 api&#x2F;profiles.js 配置信息进行测试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@login &amp; register </span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&quot;express&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">const</span> passport = <span class="built_in">require</span>(<span class="string">&quot;passport&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Profile</span> = <span class="built_in">require</span>(<span class="string">&quot;../../models/Profile&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//$route GET api/profile/test</span></span><br><span class="line"><span class="comment">//@desc 返回请求的JSON数据</span></span><br><span class="line"><span class="comment">//@access public （公有接口）</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/test&quot;</span>,<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;<span class="attr">msg</span>:<span class="string">&quot;Profile works&quot;</span>&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<p>postman 发送到 <a target="_blank" rel="noopener" href="http://localhost:5000/api/profiles/test">http://localhost:5000/api/profiles/test</a> 返回 Profile works 即链接成功。</p>
<h4 id="更改数据库接口"><a href="#更改数据库接口" class="headerlink" title="更改数据库接口"></a>更改数据库接口</h4><p>如果要更改数据库接口，可以<code>/config/keys.js</code>中的<code>mongoURI</code>的值，该值的获取方法，参考上述创建时的内容。</p>
<h4 id="创建添加信息的接口"><a href="#创建添加信息的接口" class="headerlink" title="创建添加信息的接口"></a>创建添加信息的接口</h4><p>profiles.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route POST api/profile/add</span></span><br><span class="line"><span class="comment">//@desc 创建信息接口</span></span><br><span class="line"><span class="comment">//@access Private</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/add&quot;</span>,passport.<span class="title function_">authenticate</span>(<span class="string">&quot;jwt&quot;</span>,&#123;<span class="attr">session</span>:<span class="literal">false</span>&#125;),<span class="function">(<span class="params">req,res</span>)=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> profileFields = &#123;&#125;;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">type</span>) profileFields.<span class="property">type</span> = req.<span class="property">body</span>.<span class="property">type</span>;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">describe</span>) profileFields.<span class="property">describe</span> = req.<span class="property">body</span>.<span class="property">describe</span>;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">income</span>) profileFields.<span class="property">income</span> = req.<span class="property">body</span>.<span class="property">income</span>;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">expend</span>) profileFields.<span class="property">expend</span> = req.<span class="property">body</span>.<span class="property">expend</span>;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">cash</span>) profileFields.<span class="property">cash</span> = req.<span class="property">body</span>.<span class="property">cash</span>;</span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">remark</span>) profileFields.<span class="property">remark</span> = req.<span class="property">body</span>.<span class="property">remark</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Profile</span>(profileFields).<span class="title function_">save</span>().<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">res.<span class="title function_">json</span>(profile);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="获取所有信息"><a href="#获取所有信息" class="headerlink" title="获取所有信息"></a>获取所有信息</h4><p>profiles.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route GET api/profile</span></span><br><span class="line"><span class="comment">//@desc 获取所有信息</span></span><br><span class="line"><span class="comment">//@access Private</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(</span><br><span class="line">  <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  passport.<span class="title function_">authenticate</span>(<span class="string">&quot;jwt&quot;</span>, &#123; <span class="attr">session</span>: <span class="literal">false</span> &#125;),</span><br><span class="line">  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Profile</span>.<span class="title function_">find</span>()</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!profile) &#123;</span><br><span class="line">          <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(<span class="string">&quot;没有任何内容&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">json</span>(profile);</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(<span class="string">&quot;err&quot;</span>));</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="获取单个信息"><a href="#获取单个信息" class="headerlink" title="获取单个信息"></a>获取单个信息</h4><p>  profiles.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route GET api/profile/:id</span></span><br><span class="line"><span class="comment">//@desc 获取单个信息</span></span><br><span class="line"><span class="comment">//@access Private</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(</span><br><span class="line">  <span class="string">&quot;/:id&quot;</span>,</span><br><span class="line">  passport.<span class="title function_">authenticate</span>(<span class="string">&quot;jwt&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">session</span>: <span class="literal">false</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Profile</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">_id</span>: req.<span class="property">params</span>.<span class="property">id</span> &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!profile) &#123;</span><br><span class="line">          <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(<span class="string">&quot;没有任何内容&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">json</span>(profile);</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(err));</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="编辑信息"><a href="#编辑信息" class="headerlink" title="编辑信息"></a>编辑信息</h4><p>profiles.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route POST api/profile/edit</span></span><br><span class="line"><span class="comment">//@desc 编辑信息接口</span></span><br><span class="line"><span class="comment">//@access Private</span></span><br><span class="line">router.<span class="title function_">post</span>(</span><br><span class="line">  <span class="string">&quot;/edit/:id&quot;</span>,</span><br><span class="line">  passport.<span class="title function_">authenticate</span>(<span class="string">&quot;jwt&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">session</span>: <span class="literal">false</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> profileFields = &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">type</span>) profileFields.<span class="property">type</span> = req.<span class="property">body</span>.<span class="property">type</span>;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">describe</span>) profileFields.<span class="property">describe</span> = req.<span class="property">body</span>.<span class="property">describe</span>;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">income</span>) profileFields.<span class="property">income</span> = req.<span class="property">body</span>.<span class="property">income</span>;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">expend</span>) profileFields.<span class="property">expend</span> = req.<span class="property">body</span>.<span class="property">expend</span>;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">cash</span>) profileFields.<span class="property">cash</span> = req.<span class="property">body</span>.<span class="property">cash</span>;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">remark</span>) profileFields.<span class="property">remark</span> = req.<span class="property">body</span>.<span class="property">remark</span>;</span><br><span class="line">    <span class="title class_">Profile</span>.<span class="title function_">findOneAndUpdate</span>(</span><br><span class="line">      &#123; <span class="attr">_id</span>: req.<span class="property">params</span>.<span class="property">id</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">$set</span>: profileFields &#125;,</span><br><span class="line">      &#123; <span class="attr">new</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    ).<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> res.<span class="title function_">json</span>(profile))</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>
<h4 id="删除信息"><a href="#删除信息" class="headerlink" title="删除信息"></a>删除信息</h4><p>profiles.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//$route delete api/profile/delete/:id</span></span><br><span class="line"><span class="comment">//@desc 删除信息接口</span></span><br><span class="line"><span class="comment">//@access Private</span></span><br><span class="line">router.<span class="title function_">delete</span>(</span><br><span class="line">  <span class="string">&quot;/delete/:id&quot;</span>,</span><br><span class="line">  passport.<span class="title function_">authenticate</span>(<span class="string">&quot;jwt&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">session</span>: <span class="literal">false</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Profile</span>.<span class="title function_">findOneAndRemove</span>(&#123; <span class="attr">_id</span>: req.<span class="property">params</span>.<span class="property">id</span> &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> &#123;</span><br><span class="line">        profile.<span class="title function_">save</span>().<span class="title function_">then</span>(<span class="function"><span class="params">profile</span> =&gt;</span> res.<span class="title function_">json</span>(profile));</span><br><span class="line">      &#125;</span><br><span class="line">      ).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(<span class="string">&quot;删除失败&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>至此，信息的增删改查均已实现。要创建其他 schema 可以参考此方式</p>
</blockquote>
<h4 id="前后端连载"><a href="#前后端连载" class="headerlink" title="前后端连载"></a>前后端连载</h4><p>查看vue版本，是否在3.0.0以上，我们要求是在3.0.0以上。</p>
<blockquote>
<p>vue-cli的安装见 <a target="_blank" rel="noopener" href="https://cn.vuejs.org/">vue官网</a> ，这里就不说了</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//终端中执行</span></span><br><span class="line">vue -V <span class="comment">//查看vue-cli版本 本案例要求3.0.0以上</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//创建项目 client是自己起的名字，意为&quot;客户端&quot;</span></span><br><span class="line">vue create client</span><br><span class="line"></span><br><span class="line">接下来进入选择流程，后面 √ 为我们作出的选择项，-----表示回车到下一选项页</span><br><span class="line">? <span class="title class_">Please</span> pick a <span class="attr">preset</span>: </span><br><span class="line">❯ <span class="keyword">default</span> (babel, eslint)   (默认配置)</span><br><span class="line">  <span class="title class_">Manually</span> select features （手动选择) √</span><br><span class="line">-----</span><br><span class="line">按键盘a表示全选，i表示反选，空格键 表示切换选中，如果你需要什么就选什么就可以了，这里选择<span class="title class_">Babel</span>、<span class="title class_">Router</span>、<span class="title class_">Vuex</span>。</span><br><span class="line">? <span class="title class_">Please</span> pick a <span class="attr">preset</span>: <span class="title class_">Manually</span> select features</span><br><span class="line">? <span class="title class_">Check</span> the features needed <span class="keyword">for</span> your <span class="attr">project</span>: (<span class="title class_">Press</span> &lt;space&gt; to select, &lt;a&gt; to toggle all, &lt;i&gt; to invert selection)</span><br><span class="line">❯◯ <span class="title class_">Babel</span>    √</span><br><span class="line"> ◯ <span class="title class_">TypeScript</span></span><br><span class="line"> ◯ <span class="title class_">Progressive</span> <span class="title class_">Web</span> <span class="title class_">App</span> (<span class="variable constant_">PWA</span>) <span class="title class_">Support</span>   </span><br><span class="line"> ◯ <span class="title class_">Router</span>   √</span><br><span class="line"> ◯ <span class="title class_">Vuex</span>     √ </span><br><span class="line"> ◯ <span class="variable constant_">CSS</span> <span class="title class_">Pre</span>-processors</span><br><span class="line"> ◯ <span class="title class_">Linter</span> / <span class="title class_">Formatter</span></span><br><span class="line"> ◯ <span class="title class_">Unit</span> <span class="title class_">Testing</span></span><br><span class="line"> ◯ <span class="variable constant_">E2E</span> <span class="title class_">Testing</span></span><br><span class="line"> -----</span><br><span class="line"> 是否使用history ，我们输入y，回车，会继续显示其他问题。</span><br><span class="line"> ? <span class="title class_">Please</span> pick a <span class="attr">preset</span>: <span class="title class_">Manually</span> select features</span><br><span class="line">? <span class="title class_">Check</span> the features needed <span class="keyword">for</span> your <span class="attr">project</span>: <span class="title class_">Babel</span>, <span class="title class_">Router</span>, <span class="title class_">Vuex</span></span><br><span class="line">? <span class="title class_">Use</span> history mode <span class="keyword">for</span> router? (<span class="title class_">Requires</span> proper server setup <span class="keyword">for</span> index fallback <span class="keyword">in</span> production) (Y/n) </span><br><span class="line"></span><br><span class="line"><span class="title class_">In</span> dedicated config files </span><br><span class="line"><span class="title class_">In</span> package.<span class="property">json</span>    √ </span><br><span class="line"></span><br><span class="line"> <span class="title class_">Save</span> <span class="variable language_">this</span> <span class="keyword">as</span> a preset <span class="keyword">for</span> future projects? (y/N) (是否要保存你当前预制模板) N （第一次时可以保存一次方便之后用）</span><br><span class="line"> -----</span><br><span class="line"> 接下来就是等待安装成功。 会产生一个 client的文件夹</span><br><span class="line"></span><br><span class="line"> <span class="comment">//启动项目 </span></span><br><span class="line"> cd client</span><br><span class="line"> npm run serve  <span class="comment">//注意，是serve 不是server</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时使用 <code>http://localhost:8080/</code> 就可以打开前端了,再新建终端，执行 <code>nodemon</code>就打开了后台。<br>这需要两个终端打开，较为繁琐，因此采用前后端连载，借助concurrently将多个终端启动的项目绑在一起<br>安装 concurrently </p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install <span class="keyword">concurrently</span></span><br></pre></td></tr></table></figure>
<p>打开 &#x2F;client&#x2F;package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;serve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service serve&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vue-cli-service build&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run serve&quot;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时，我们在client中 使用 <code>npm run start </code>即可启动前端     </p>
</blockquote>
<p>在根目录的 package.json 中配置<code>client-stall</code>、<code>client</code>和<code>dev</code>。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;client-install&quot;</span><span class="punctuation">:</span><span class="string">&quot;npm install --prefix client&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;client&quot;</span><span class="punctuation">:</span><span class="string">&quot;npm start --prefix client&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node server.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nodemon server.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span><span class="string">&quot;concurrently \&quot;npm run server\&quot; \&quot;npm run client\&quot;&quot;</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时我们可以在根目录的终端下执行<code>npm run dev</code>即可同时启动 前端和后台 </p>
</blockquote>
<h1 id="前端部分"><a href="#前端部分" class="headerlink" title="前端部分"></a>前端部分</h1><p>接后端部分，此文档为 前端部分 内容。</p>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><p>为使内容整洁，我们将vue-cli创建项目时生成的我们不需要的文件进行整理<br>我们接下来更多的是在client这个文件夹下工作，非强调指明，则以client视为根目录。</p>
<ul>
<li>删除 &#x2F;src&#x2F;assets&#x2F;logo.png  （vue的logo图片）</li>
<li>删除 &#x2F;src&#x2F;components&#x2F;HelloWorld.vue</li>
<li>删除 &#x2F;src&#x2F;views&#x2F; 中的About.vue 和Home.vue </li>
<li>新建 &#x2F;src&#x2F;views&#x2F;Index.vue,内容为<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;index&quot;&gt;</span><br><span class="line">    初始化页面</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name:&quot;index&quot;,</span><br><span class="line">  components:&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
<li>打开 &#x2F;src&#x2F;router.js,重新整理为:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Index</span> <span class="keyword">from</span> <span class="string">&#x27;./views/Index.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Router</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;history&#x27;</span>,</span><br><span class="line">  <span class="attr">base</span>: process.<span class="property">env</span>.<span class="property">BASE_URL</span>,</span><br><span class="line">  <span class="attr">routes</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">redirect</span>:<span class="string">&#x27;/index&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/index&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>:<span class="string">&#x27;index&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">Index</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>打开 &#x2F;src&#x2F;App.vue,重新整理为<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div id=&quot;app&quot;&gt;</span><br><span class="line">    &lt;router-view/&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">html,</span><br><span class="line">body,</span><br><span class="line">#app &#123;</span><br><span class="line">  width: 100%;</span><br><span class="line">  height: 100%;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure></li>
<li>新建 &#x2F;public&#x2F;css&#x2F;reset.css ,在 &#x2F;public&#x2F;index.html 中引入该css文件<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;css/reset.css&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
reset.css内容可以访问 <a target="_blank" rel="noopener" href="http://meyerweb.com/eric/tools/css/reset/">CSS reset</a>得到，也可在下面设置自己需要的初始样式<br>本案例中，我们在reset.css中追加了el中加载相关的样式</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-class">.el-loading</span>&#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">2000</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, .<span class="number">7</span>);</span><br><span class="line">  <span class="attribute">margin</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">top</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">  -webkit-<span class="attribute">transition</span>:opacity .<span class="number">3s</span>;</span><br><span class="line">  <span class="attribute">transition</span>: opacity .<span class="number">3s</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.el-loading-spinner</span>&#123;</span><br><span class="line">  <span class="attribute">top</span>:<span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">margin-top</span>:-<span class="number">21px</span>;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="注册页和404"><a href="#注册页和404" class="headerlink" title="注册页和404"></a>注册页和404</h4><p>  安装elementUI<br>  <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>此时目录在client中</span><br><span class="line">npm i element-ui -S</span><br></pre></td></tr></table></figure><br>在&#x2F;src&#x2F;main.js中引入 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ElementUI</span> <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-ui/lib/theme-chalk/index.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">ElementUI</span>);</span><br></pre></td></tr></table></figure>
<p>将 图片文件 放在 &#x2F;src&#x2F;asset&#x2F; 文件夹下面<br>分别是404.gif,bg.jpg,logo.png,showcase.png</p>
<p>初始注册，新建 &#x2F;src&#x2F;views&#x2F;Register.vue,内容 (只是简单布局，还未设置表单内容)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;register&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;form_container&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;manage_tip&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>万事屋在线后台管理系统<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>:<span class="string">&quot;register&quot;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">components</span>:&#123;&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.register</span>&#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">position</span>: relative;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">width</span>: <span class="number">100%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">height</span>: <span class="number">100%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">../assets/bg.jpg</span>) no-repeat center center;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">background-size</span>: <span class="number">100%</span> <span class="number">100%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.form_container</span>&#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">width</span>: <span class="number">370px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">height</span>: <span class="number">210px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">position</span>: absolute;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">top</span>:<span class="number">10%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">left</span>:<span class="number">34%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">padding</span>:<span class="number">25px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">border-radius</span>: <span class="number">5px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">text-align</span>: center;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.form_container</span> <span class="selector-class">.manage_tip</span> <span class="selector-class">.title</span>&#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">font-family</span>: <span class="string">&#x27;Microsooft YaHei&#x27;</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">font-weight</span>: bold;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">font-size</span>: <span class="number">26px</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">  <span class="attribute">color</span>: <span class="number">#fff</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>在 router.js中设置路由</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引入组件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Register</span> <span class="keyword">from</span> <span class="string">&#x27;./views/Register.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//添加路由</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>:<span class="string">&#x27;register&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">Register</span></span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<p>设置 404 页面</p>
<ol>
<li>新建 &#x2F;src&#x2F;views&#x2F;404.vue 组件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;notfound&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;../assets/404.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;页面没找到&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.notfound</span>&#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="attribute">width</span>: <span class="number">100%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="attribute">height</span>:<span class="number">100%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="attribute">overflow</span>: hidden;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.notfound</span> <span class="selector-tag">img</span>&#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="attribute">width</span>: <span class="number">100%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="attribute">height</span>:<span class="number">100%</span>;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>在 router.js中设置路由</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//router.js</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>:<span class="string">&#x27;/404&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">NotFound</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="注册表单"><a href="#注册表单" class="headerlink" title="注册表单"></a>注册表单</h4><p>此后大量使用 element 的代码，为避免过长，仅提一些重要的点，其他请结合原文件阅读笔记</p>
<h4 id="密码规则与验证"><a href="#密码规则与验证" class="headerlink" title="密码规则与验证"></a>密码规则与验证</h4><h4 id="加载动画和消息提示"><a href="#加载动画和消息提示" class="headerlink" title="加载动画和消息提示"></a>加载动画和消息提示</h4><p>安装 axios</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>client目录下</span><br><span class="line">npm install axios</span><br></pre></td></tr></table></figure>
<p>新建 &#x2F;src&#x2F;http.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Message</span>,<span class="title class_">Loading</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> loading;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">startLoading</span>(<span class="params"></span>)&#123;</span><br><span class="line">  loading = <span class="title class_">Loading</span>.<span class="title function_">service</span>(&#123;</span><br><span class="line">    <span class="attr">lock</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">text</span>:<span class="string">&quot;拼命加载中...&quot;</span>,</span><br><span class="line">    <span class="attr">background</span>:<span class="string">&#x27;rgba(0,0,0,0.7)&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">endLoading</span>(<span class="params"></span>)&#123;</span><br><span class="line">  loading.<span class="title function_">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//请求拦截</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//加载动画</span></span><br><span class="line">  <span class="title function_">startLoading</span>();</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//响应拦截</span></span><br><span class="line"></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//结束加载动画</span></span><br><span class="line">  <span class="title function_">endLoading</span>();</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//错误提醒</span></span><br><span class="line">  <span class="title function_">endLoading</span>();</span><br><span class="line">  <span class="title class_">Message</span>.<span class="title function_">error</span>(error.<span class="property">response</span>.<span class="property">data</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> axios;</span><br></pre></td></tr></table></figure>

<p>在main.js中引用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;./http&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$axios</span> = axios;</span><br></pre></td></tr></table></figure>

<p>http.js内容(后会变动)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Message</span>,<span class="title class_">Loading</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> loading;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">startLoading</span>(<span class="params"></span>)&#123;</span><br><span class="line">  loading = <span class="title class_">Loading</span>.<span class="title function_">service</span>(&#123;</span><br><span class="line">    <span class="attr">lock</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">text</span>:<span class="string">&quot;拼命加载中...&quot;</span>,</span><br><span class="line">    <span class="attr">background</span>:<span class="string">&#x27;rgba(0,0,0,0.7)&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">endLoading</span>(<span class="params"></span>)&#123;</span><br><span class="line">  loading.<span class="title function_">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//请求拦截</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//加载动画</span></span><br><span class="line">  <span class="title function_">startLoading</span>();</span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//响应拦截</span></span><br><span class="line"></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//结束加载动画</span></span><br><span class="line">  <span class="title function_">endLoading</span>();</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//错误提醒</span></span><br><span class="line">  <span class="title function_">endLoading</span>();</span><br><span class="line">  <span class="title class_">Message</span>.<span class="title function_">error</span>(error.<span class="property">response</span>.<span class="property">data</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> axios;</span><br></pre></td></tr></table></figure>

<h4 id="配置前端跨域请求-使用vue-cli项目"><a href="#配置前端跨域请求-使用vue-cli项目" class="headerlink" title="配置前端跨域请求(使用vue-cli项目)"></a>配置前端跨域请求(使用vue-cli项目)</h4><p>新建 vue.config.js ，在client目录下,内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> debug = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">baseUrl</span>:<span class="string">&#x27;/&#x27;</span>, <span class="comment">//根域上下文目录</span></span><br><span class="line">  <span class="attr">outputDir</span>:<span class="string">&#x27;dist&#x27;</span>, <span class="comment">//构建输出目录</span></span><br><span class="line">  <span class="attr">assetsDir</span>: <span class="string">&#x27;assets&#x27;</span>, <span class="comment">//静态资源目录（js,css,img,fonts）</span></span><br><span class="line">  <span class="attr">lintOnSave</span>:<span class="literal">false</span>, <span class="comment">//是否开启eslint保存检测，有效值：true|false|&#x27;error&#x27;</span></span><br><span class="line">  <span class="attr">runtimeCompiler</span>:<span class="literal">true</span>, <span class="comment">//运行时版本是否需要编译</span></span><br><span class="line">  <span class="attr">transpileDependencies</span>:[], <span class="comment">//默认babel-loader忽略node_modules,这里可增加例外的依赖包名</span></span><br><span class="line">  <span class="attr">productionSourceMap</span>:<span class="literal">true</span>, <span class="comment">//是否在构建生产包时生产 sourceMap 文件，false将提高构建速度</span></span><br><span class="line">  <span class="attr">configureWebpack</span>:<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//webpack 配置，值为对象时会合并配置，为方法时会改写配置</span></span><br><span class="line">    <span class="keyword">if</span>(debug)&#123;</span><br><span class="line">      <span class="comment">//开发环境配置</span></span><br><span class="line">      config.<span class="property">devtool</span> = <span class="string">&#x27;cheap-module-eval-source-map&#x27;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//生产环境配置</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Object.assign(config,&#123; //开发生产共同配置</span></span><br><span class="line">    <span class="comment">//   resolve:&#123;</span></span><br><span class="line">    <span class="comment">//     alias:&#123;</span></span><br><span class="line">    <span class="comment">//       &#x27;@&#x27;:path.resolve(__dirname,&#x27;./src&#x27;),</span></span><br><span class="line">    <span class="comment">//       &#x27;@c&#x27;:path.resolve(__dirname,&#x27;./src/components&#x27;),</span></span><br><span class="line">    <span class="comment">//       &#x27;vue$&#x27;:&#x27;vue/dist/vue.esm.js&#x27;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//   &#125;</span></span><br><span class="line">    <span class="comment">// &#125;)</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">chainWebpack</span>:<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//webpack链接API，用于生成和修改webpack配置，</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/vue-cli/blob/dev/docs/webpack.md</span></span><br><span class="line">    <span class="keyword">if</span>(debug)&#123;</span><br><span class="line">      <span class="comment">//本地开发配置</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="comment">//生产开发配置</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">parallel</span>:<span class="built_in">require</span>(<span class="string">&#x27;os&#x27;</span>).<span class="title function_">cpus</span>().<span class="property">length</span> &gt; <span class="number">1</span>, <span class="comment">//构建时开启多进程处理babel编译</span></span><br><span class="line">  <span class="attr">pluginOptions</span>:&#123;</span><br><span class="line">    <span class="comment">//第三方插件配置</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">pwa</span>:&#123;</span><br><span class="line">    <span class="comment">//单页插件相关配置</span></span><br><span class="line">    <span class="comment">// https://github.com/vuejs/vue-cli/tree/dev/packages/%40vue/cli-plugin-pwa</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">devServer</span>:&#123;</span><br><span class="line">    <span class="attr">open</span>:<span class="literal">true</span>,</span><br><span class="line">    <span class="attr">host</span>:<span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>:<span class="number">8080</span>,</span><br><span class="line">    <span class="attr">https</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="attr">hotOnly</span>:<span class="literal">false</span>,</span><br><span class="line">    <span class="attr">proxy</span>:&#123;<span class="comment">//配置跨域</span></span><br><span class="line">      <span class="string">&#x27;/api&#x27;</span>:&#123;</span><br><span class="line">        <span class="attr">target</span>:<span class="string">&#x27;http://localhost:5000/api&#x27;</span>,</span><br><span class="line">        <span class="attr">ws</span>:<span class="literal">true</span>,</span><br><span class="line">        <span class="attr">changOrigin</span>:<span class="literal">true</span>,</span><br><span class="line">        <span class="attr">pathRewrite</span>:&#123;</span><br><span class="line">          <span class="string">&#x27;^/api&#x27;</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">before</span>:<span class="function"><span class="params">app</span> =&gt;</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样就可以访问我们的后台了</p>
</blockquote>
<p>在register.vue中配置跳转,这样就可以注册用户了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">submitForm</span>(<span class="params">formName</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$refs</span>[formName].<span class="title function_">validate</span>(<span class="function"><span class="params">valid</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$axios</span></span><br><span class="line">            .<span class="title function_">post</span>(<span class="string">&quot;/api/users/register&quot;</span>, <span class="variable language_">this</span>.<span class="property">registerUser</span>)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="comment">//注册成功</span></span><br><span class="line">              <span class="variable language_">this</span>.$message(&#123;</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&quot;账号注册成功！&quot;</span>,</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&quot;success&quot;</span></span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&quot;/login&quot;</span>); </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="登录逻辑"><a href="#登录逻辑" class="headerlink" title="登录逻辑"></a>登录逻辑</h4><p>新建组件和添加路由参考注册，这里讲下登录逻辑. Login.vue</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">submitForm</span>(<span class="params">formName</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$refs</span>[formName].<span class="title function_">validate</span>(<span class="function"><span class="params">valid</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">$axios</span>.<span class="title function_">post</span>(<span class="string">&quot;/api/users/login&quot;</span>, <span class="variable language_">this</span>.<span class="property">loginUser</span>).<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">//拿到token</span></span><br><span class="line">            <span class="keyword">const</span> &#123; token &#125; = res.<span class="property">data</span>;</span><br><span class="line">            <span class="comment">// 存储到localStorage</span></span><br><span class="line">             <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;eleToken&quot;</span>, token);</span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&#x27;/index&#x27;</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="路由守卫"><a href="#路由守卫" class="headerlink" title="路由守卫"></a>路由守卫</h4><p>router.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//路由守卫</span></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//如果token存在返回boolean值true,否则false</span></span><br><span class="line">  <span class="keyword">const</span> isLogin = <span class="variable language_">localStorage</span>.<span class="property">eleToken</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span>(to.<span class="property">path</span> == <span class="string">&quot;/login&quot;</span> || to.<span class="property">path</span> == <span class="string">&quot;/register&quot;</span>)&#123;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//如果有token,为true,就正常跳转;为false,就跳转到登录页</span></span><br><span class="line">    isLogin ? <span class="title function_">next</span>() : <span class="title function_">next</span>(<span class="string">&quot;login&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="设置token和token-过期"><a href="#设置token和token-过期" class="headerlink" title="设置token和token 过期"></a>设置token和token 过期</h4><p>在请求拦截中,如果存在token,就把token设置到请求头中.<br>在响应拦截里的error里,如果状态码是401未授权,表示token过期.就在error返回函数里清除token,并跳转到登录页.</p>
<p>http.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//请求拦截</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//加载动画</span></span><br><span class="line">  <span class="title function_">startLoading</span>();</span><br><span class="line">  <span class="comment">//如果有token</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable language_">localStorage</span>.<span class="property">eleToken</span>)&#123;</span><br><span class="line">  <span class="comment">//设置统一的请求头header</span></span><br><span class="line">  config.<span class="property">headers</span>.<span class="property">Authorization</span> = <span class="variable language_">localStorage</span>.<span class="property">eleToken</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> config;</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//响应拦截</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//结束加载动画</span></span><br><span class="line">  <span class="title function_">endLoading</span>();</span><br><span class="line">  <span class="keyword">return</span> response;</span><br><span class="line">&#125;,<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//错误提醒</span></span><br><span class="line">  <span class="title function_">endLoading</span>();</span><br><span class="line">  <span class="title class_">Message</span>.<span class="title function_">error</span>(error.<span class="property">response</span>.<span class="property">data</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//获取错误状态码</span></span><br><span class="line">  <span class="keyword">const</span> &#123; status &#125; = error.<span class="property">response</span>;</span><br><span class="line">  <span class="comment">//401未授权,表示token过期</span></span><br><span class="line">  <span class="keyword">if</span> (status == <span class="number">401</span>)&#123;</span><br><span class="line">    <span class="title class_">Message</span>.<span class="title function_">error</span>(<span class="string">&#x27;token失效，请重新登录！&#x27;</span>);</span><br><span class="line">    <span class="comment">//清除token</span></span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&quot;eleToken&quot;</span>);</span><br><span class="line">    <span class="comment">//跳转到登录页面</span></span><br><span class="line">    router.<span class="title function_">push</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<h4 id="解析token存储到Vuex中"><a href="#解析token存储到Vuex中" class="headerlink" title="解析token存储到Vuex中"></a>解析token存储到Vuex中</h4><p>安装解析token的模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install jwt-decode</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Login.vue</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//引入解析模块</span></span><br><span class="line"><span class="keyword">import</span> jwt_decode <span class="keyword">from</span> <span class="string">&#x27;jwt_decode&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析token</span></span><br><span class="line"><span class="keyword">const</span> decoded = <span class="title function_">jwt_decode</span>(token)</span><br><span class="line"></span><br><span class="line"><span class="comment">//token存储到vuex中</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&quot;setAuthenticated&quot;</span>, !<span class="variable language_">this</span>.<span class="title function_">isEmpty</span>(decoded));</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&quot;setUser&quot;</span>, decoded);</span><br></pre></td></tr></table></figure>
<h4 id="设置Vuex"><a href="#设置Vuex" class="headerlink" title="设置Vuex"></a>设置Vuex</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//store.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//登录成功后将数据存储到Vuex中</span></span><br><span class="line"><span class="comment">//判断是否认证通过</span></span><br><span class="line"><span class="keyword">const</span> types = &#123;</span><br><span class="line">  <span class="attr">SET_AUTHENTICATED</span>: <span class="string">&quot;SET_AUTHENTICATED&quot;</span>,</span><br><span class="line">  <span class="attr">SET_USER</span>: <span class="string">&quot;SET_USER&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">isAuthenticated</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">user</span>: &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">  <span class="attr">isAuthenticated</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">isAuthenticated</span>,</span><br><span class="line">  <span class="attr">user</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">user</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">  [types.<span class="property">SET_AUTHENTICATED</span>](state, isAuthenticated) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isAuthenticated) state.<span class="property">isAuthenticated</span> = isAuthenticated;</span><br><span class="line">    <span class="keyword">else</span> state.<span class="property">isAuthenticated</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  [types.<span class="property">SET_USER</span>](state, user) &#123;</span><br><span class="line">    <span class="keyword">if</span> (user) state.<span class="property">user</span> = user;</span><br><span class="line">    <span class="keyword">else</span> state.<span class="property">user</span> = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">  <span class="attr">setAuthenticated</span>: <span class="function">(<span class="params">&#123; commit &#125;, isAuthenticated</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">commit</span>(types.<span class="property">SET_AUTHENTICATED</span>, isAuthenticated);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">setUser</span>: <span class="function">(<span class="params">&#123; commit &#125;, user</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">commit</span>(types.<span class="property">SET_USER</span>, user);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//清除当前的状态</span></span><br><span class="line">  <span class="attr">clearCurrentState</span>: <span class="function">(<span class="params">&#123; commit &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">commit</span>(types.<span class="property">SET_AUTHENTICATED</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="title function_">commit</span>(types.<span class="property">SET_USER</span>, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">  state,</span><br><span class="line">  getters,</span><br><span class="line">  mutations,</span><br><span class="line">  actions</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<p>方法: 判断是否为空</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">isEmpty</span>(<span class="params">value</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    value === <span class="literal">undefined</span> ||</span><br><span class="line">    value === <span class="literal">null</span> ||</span><br><span class="line">    (<span class="keyword">typeof</span> value === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">keys</span>(value).<span class="property">length</span> === <span class="number">0</span>) ||</span><br><span class="line">    (<span class="keyword">typeof</span> value === <span class="string">&quot;string&quot;</span> &amp;&amp; value.<span class="title function_">trim</span>().<span class="property">length</span> === <span class="number">0</span>)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h4 id="在根组件App-vue中判断token"><a href="#在根组件App-vue中判断token" class="headerlink" title="在根组件App.vue中判断token"></a>在根组件App.vue中判断token</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">localStorage</span>.<span class="property">eleToken</span>) &#123;</span><br><span class="line">    <span class="comment">//解析token</span></span><br><span class="line">    <span class="keyword">const</span> decoded = <span class="title function_">jwt_decode</span>(<span class="variable language_">localStorage</span>.<span class="property">eleToken</span>);</span><br><span class="line">    <span class="comment">//token存储到vuex中</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&quot;setAuthenticated&quot;</span>, !<span class="variable language_">this</span>.<span class="title function_">isEmpty</span>(decoded));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&quot;setUser&quot;</span>, decoded);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h4><p>新建&#x2F;component&#x2F;HeadNav.vue</p>
<p>将HeadNav.vue引入到Index.vue,并注册,然后template中调用</p>
<p>在HeadNav.vue中布局</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//看代码</span></span><br></pre></td></tr></table></figure>

<p>写向下箭头的方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">setDialogInfo</span>(<span class="params">cmdItem</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (cmdItem) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;info&quot;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">showInfoList</span>();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;logout&quot;</span>:</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">logout</span>();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">showInfoList</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;个人信息&quot;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">//清除token</span></span><br><span class="line">      <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&quot;eleToken&quot;</span>);</span><br><span class="line">      <span class="comment">//设置Vuex store</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="title function_">dispatch</span>(<span class="string">&quot;clearCurrentState&quot;</span>);</span><br><span class="line">      <span class="comment">//跳转到login</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//vuex中记得在actions中添加clearCurrentState</span></span><br></pre></td></tr></table></figure>

<h4 id="个人信息"><a href="#个人信息" class="headerlink" title="个人信息"></a>个人信息</h4><p>新建views&#x2F;Home.vue</p>
<p>在router.js中设置二级路由</p>
<p>新建views&#x2F;InfoShow.vue</p>
<h4 id="侧面导航栏"><a href="#侧面导航栏" class="headerlink" title="侧面导航栏"></a>侧面导航栏</h4><p>新建assets&#x2F;component&#x2F;LeftMenu.vue</p>
<p>编辑收支类型</p>
<h4 id="创建资金列表"><a href="#创建资金列表" class="headerlink" title="创建资金列表"></a>创建资金列表</h4><p>新建views&#x2F;FundList.vue</p>
<p>添加各个按钮,事件<br>设置添加按钮,新增对话框component&#x2F;Dialog.vue组件</p>
<h4 id="编辑和添加"><a href="#编辑和添加" class="headerlink" title="编辑和添加"></a>编辑和添加</h4><p>编辑和添加功能雷同,把formData放到父级fundlist中,并用props传递<br>修改父级中dialog的属性,新增title,options,方便切换弹窗的标题和选项</p>
<p>在handleEdit中修改dialog的title,当点击编辑时title就切换成’编辑’<br>编辑时已经拿到数据了.this.formData的值也就是传入值了<br>同样,添加的也可以新增this.formData.但是添加的数据默认是空的</p>
<p>在onSubmit中判断提交的类型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="variable language_">this</span>.<span class="property">dialog</span>.<span class="property">option</span> == <span class="string">&quot;add&quot;</span> ? <span class="string">&quot;add&quot;</span> : <span class="string">`edit/<span class="subst">$&#123;<span class="variable language_">this</span>.formData.id&#125;</span>`</span></span><br></pre></td></tr></table></figure>
<h4 id="删除按钮"><a href="#删除按钮" class="headerlink" title="删除按钮"></a>删除按钮</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$axios</span>.<span class="title function_">delete</span>(<span class="string">`/api/profiles/delete/<span class="subst">$&#123;row._id&#125;</span>`</span>)</span><br><span class="line"><span class="comment">//之后可以then调用$message弹出删除成功的提示</span></span><br></pre></td></tr></table></figure>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p>elementUI布局整行分为24列.<br>使用标准分页</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-pagination</span><br><span class="line">  @size-change=<span class="string">&quot;handleSizeChange&quot;</span></span><br><span class="line">  @current-change=<span class="string">&quot;handleCurrentChange&quot;</span></span><br><span class="line">  :current-page=<span class="string">&quot;currentPage4&quot;</span></span><br><span class="line">  :page-sizes=<span class="string">&quot;[100, 200, 300, 400]&quot;</span></span><br><span class="line">  :page-size=<span class="string">&quot;100&quot;</span></span><br><span class="line">  layout=<span class="string">&quot;total, sizes, prev, pager, next, jumper&quot;</span></span><br><span class="line">  :total=<span class="string">&quot;400&quot;</span>&gt;</span><br><span class="line">&lt;/el-pagination&gt;</span><br></pre></td></tr></table></figure>
<p>  &#x2F;&#x2F;修改绑定数据</p>
<p>  &#x2F;&#x2F;设置全部数据容器(数组)<br>  allTableData: []</p>
<p>  &#x2F;&#x2F;在获取数据时就开始设置分页数据<br>  this.setPaginations()</p>
<p>  在setPaginations中设置默认属性</p>
<h4 id="筛选和权限"><a href="#筛选和权限" class="headerlink" title="筛选和权限"></a>筛选和权限</h4><p>定义筛选组件<el-form-item label="按照时间筛选"><br>复制elementUI的时间选择器.<br>添加筛选按钮,绑定筛选事件handleSearch()<br>绑定开始时间,结束时间.在data中定义开始时间startTime,结束时间endTime</p>
<p>添加过滤容器filterTableData:{},在getProfile()时也存储一次.</p>
<h5 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h5><p>使用计算属性computed获取此时用户的身份</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">computed</span>: &#123;</span><br><span class="line">    <span class="title function_">user</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">$store</span>.<span class="property">getters</span>.<span class="property">user</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>使用v-if决定是否可以使用添加,编辑,删除操作.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v-<span class="keyword">if</span>=<span class="string">&quot;user.indentity == &#x27;manager&#x27;&quot;</span></span><br><span class="line"><span class="comment">//将此判断加到添加事件之前和label=&#x27;操作&#x27;后</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/27/%E5%85%A8%E6%A0%88%E5%BC%80%E5%8F%91%E5%90%8E%E5%8F%B0%E8%B5%84%E9%87%91%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%E9%A1%B9%E7%9B%AE/" data-id="cl9xpujrp003qdmopcku8ffx1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-cNode社区项目" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/27/cNode%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time datetime="2019-11-27T07:57:45.000Z" itemprop="datePublished">2019-11-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/27/cNode%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE/">cNode社区项目</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>实战项目: 高仿CNODE社区<br>使用Vue-cli2搭建,包含webpack配置.</p>
<p>项目模块组件：<br>Header模块<br>PostList模块<br>Article模块<br>Slider侧边栏模块<br>UserInfo用户个人中心模块<br>Pagination分页组件的开发</p>
<p>主要用到的技术栈有：<br>vue.js计算属性<br>vue.js的内置指令和事件的绑定<br>vue.js的自定义事件和触发<br>vue-router路由的跳转和监听<br>父子组件之间的数据传递</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/27/cNode%E7%A4%BE%E5%8C%BA%E9%A1%B9%E7%9B%AE/" data-id="cl9xpujr6002ddmopauq71kxt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-多人博客项目" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/27/%E5%A4%9A%E4%BA%BA%E5%8D%9A%E5%AE%A2%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time datetime="2019-11-27T07:53:44.000Z" itemprop="datePublished">2019-11-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/27/%E5%A4%9A%E4%BA%BA%E5%8D%9A%E5%AE%A2%E9%A1%B9%E7%9B%AE/">多人博客项目</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="blog3"><a href="#blog3" class="headerlink" title="blog3"></a>blog3</h1><h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>使用Vue-cli3搭建,高度集成webpack,不暴露webpack配置,相应插件需要自行创建vue.config.js,在其中配置.</p>
<h1 id="前后端接口约定"><a href="#前后端接口约定" class="headerlink" title="前后端接口约定"></a>前后端接口约定</h1><h2 id="后端接口规范"><a href="#后端接口规范" class="headerlink" title="后端接口规范"></a>后端接口规范</h2><ol>
<li>当前接口路径</li>
<li>当前接口提交数据类型,如:</li>
</ol>
<p>GET: 获取数据</p>
<p>POST: 提交或者创建</p>
<p>PUT: 修改数据</p>
<p>DELETE: 删除数据</p>
<p>PATCH: 修改数据,部分修改</p>
<ol start="3">
<li>参数类型格式: json或者application&#x2F;x-www-form-urlencoded的数据</li>
<li>参数字段及限制条件</li>
<li>返回成功的数据格式</li>
<li>返回失败的数据格式</li>
</ol>
<p>下面和后端做以下接口约定,开发阶段使用postman或者curl命令测试接口</p>
<p>认证相关</p>
<h3 id="POST-x2F-auth-x2F-register"><a href="#POST-x2F-auth-x2F-register" class="headerlink" title="POST &#x2F;auth&#x2F;register"></a>POST &#x2F;auth&#x2F;register</h3><p>功能: 用户注册</p>
<p>提交参数</p>
<p>参数类型: Content-type: application&#x2F;x-www-form-urlencoded;chratset&#x3D;utf-8</p>
<p>参数字段:</p>
<p>username: 用户名,长度1-15个字符,只能是字母数字下划线</p>
<p>password: 密码,长度6-16位任意字符</p>
<p>返回数据</p>
<p>失败: </p>
<p>返回格式: <code>&#123;&quot;status&quot;: &quot;fail&quot;, &quot;msg&quot;: &quot;错误原因&quot;&#125;</code></p>
<p>成功:</p>
<p>返回格式:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;注册成功&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>:  &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">        <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;http://avatar.com/1.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试命令</p>
<p><code># -d用来传递数据</code></p>
<p><code># 对于POST和PUT可以: -X POST,对于GET,不加-X</code></p>
<p><code>curl -d &quot;usernme=Tom&amp;password=123456&quot; -X POST &quot;http://localhost:3000/auth/regitster&quot;</code></p>
<h3 id="GET-x2F-auth-x2F-login"><a href="#GET-x2F-auth-x2F-login" class="headerlink" title="GET &#x2F;auth&#x2F;login"></a>GET &#x2F;auth&#x2F;login</h3><p>功能: 用户登录</p>
<p>提交参数</p>
<p>参数类型: Content-type: application&#x2F;x-www-form-urlencoded;chratset&#x3D;utf-8</p>
<p>参数字段: </p>
<pre><code>username: 用户名,长度1-15个字符,只能是字母数字下划线
password: 密码,长度6-16位任意字符
</code></pre>
<p>返回数据</p>
<p>失败: </p>
<pre><code>返回格式: `&#123;&quot;status&quot;: &quot;fail&quot;, &quot;msg&quot;: &quot;用户不存在&quot;&#125;或者 &#123;&quot;status&quot;: &quot;fail&quot;, &quot;msg&quot;: &quot;密码不正确&quot;&#125;`
</code></pre>
<p>成功:</p>
<p>返回格式:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;注册成功&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>:  &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">        <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;http://avatar.com/1.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试命令</p>
<p><code># -d用来传递数据</code></p>
<p><code># -i 可以显示响应头</code></p>
<p><code># 会发现响应头里有setCookie信息,得到cookie</code></p>
<p><code>curl -d &quot;usernme=Tom&amp;password=123456&quot;  &quot;http://localhost:3000/auth/login&quot; -i</code></p>
<h3 id="GET-x2F-auth"><a href="#GET-x2F-auth" class="headerlink" title="GET &#x2F;auth"></a>GET &#x2F;auth</h3><p>功能: 判断用户是否登录</p>
<p>提交参数: 无</p>
<p>返回数据:<br>已经登录的情况</p>
<p>返回格式:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    <span class="string">&quot;isLogin&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">    <span class="string">&quot;data&quot;</span>:  &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;Tom&quot;</span>,</span><br><span class="line">        <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有登录的情况</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line"><span class="attr">&quot;isLogin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>测试命令</p>
<p><code>#先通过登录接口获取 cookie，带上 cookie 就能测试登录</code></p>
<p><code>curl &quot;http://localhost:3000/auth&quot; -b &quot;connect.sid=s%3AmeDbrn03UtTM8fqChaPQ20wmWlnKeHiu.e3uMtu7j1zQ1iNeaajCmxkYYGQ%2FyHV1ZsozMvZYWC6s&quot;</code></p>
<h3 id="GET-x2F-auth-x2F-logout"><a href="#GET-x2F-auth-x2F-logout" class="headerlink" title="GET &#x2F;auth&#x2F;logout"></a>GET &#x2F;auth&#x2F;logout</h3><p>功能: 注销登录</p>
<p>提交参数:无</p>
<p>返回数据: </p>
<pre><code>失败:
返回格式: `&#123; &quot;status&quot;: &quot;fail&quot;, &quot;msg&quot;: &quot;用户尚未登录&quot;&#125;`

成功:
返回格式: `&#123; &quot;status&quot;: &quot;success&quot;, &quot;msg&quot;: &quot;注销成功&quot;&#125;`
</code></pre>
<p>测试命令</p>
<p><code>curl &quot;http://localhost:3000/auth/logout&quot; -b &quot;connect.sid=s%3AmeDbrn03UtTM8fqChaPQ20wmWlnKeHiu.e3uMtu7j1zQ1iNeaajCmxkYYGQ%2FyHV11ZsozMvZYWC6s&quot;</code></p>
<h1 id="博客相关"><a href="#博客相关" class="headerlink" title="博客相关"></a>博客相关</h1><h3 id="GET-x2F-blog"><a href="#GET-x2F-blog" class="headerlink" title="GET &#x2F;blog"></a>GET &#x2F;blog</h3><p>功能: 获取博客列表</p>
<p>提交参数:</p>
<pre><code>page: 页码,不传默认为1.
userId: 用户ID,不传获取全部用户ID
atIndex: 是否展示在首页.true只得到展示到首页的博客列表,false得到不展示到首页的列表,不传得到全部类型的博客列表
</code></pre>
<p>如 &#x2F;blog?page&#x3D;2&amp;userId&#x3D;1 获取属于用户1的第二页博客列表</p>
<p>返回数据: </p>
<pre><code>失败: &#123; &quot;status&quot;: &quot;系统异常&quot;&#125;
</code></pre>
<p>成功:<br>返回格式:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;获取成功&quot;</span>,</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: <span class="number">200</span>,<span class="comment">//全部博客总数</span></span><br><span class="line">    <span class="string">&quot;page&quot;</span>: <span class="number">2</span>,<span class="comment">//当前页数</span></span><br><span class="line">    <span class="string">&quot;totalPage&quot;</span>: <span class="number">10</span>, <span class="comment">//总页数</span></span><br><span class="line">    <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">&quot;博客标题&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;博客内容简要描述&quot;</span>,</span><br><span class="line">        <span class="string">&quot;user&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="number">100</span>, <span class="comment">//博客所属用户id</span></span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">&quot;博客所属用户username&quot;</span>,</span><br><span class="line">            <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;头像&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span>, <span class="comment">//创建时间</span></span><br><span class="line">        <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span>, <span class="comment">//更新时间</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试命令</p>
<p><code>curl &quot;http://localhost:3000/blog?page=1&amp;userId=1&quot;</code></p>
<p><code>curl &quot;http://localhost:3000/blog?page=1&quot;</code></p>
<p><code>curl &quot;http://localhost:3000/blog&quot;</code></p>
<h3 id="GET-x2F-blog-x2F-blogId"><a href="#GET-x2F-blog-x2F-blogId" class="headerlink" title="GET &#x2F;blog&#x2F;:blogId"></a>GET &#x2F;blog&#x2F;:blogId</h3><p>功能: 获取id为blogId的博客详情,如 &#x2F;blog&#x2F;1</p>
<p>提交参数: 无</p>
<p>返回数据:<br>    失败: <code>&#123; &quot;status&quot;: &quot;fail&quot;, &quot;msg&quot;: &quot;系统异常&quot;&#125;</code></p>
<p>成功: </p>
<p>返回格式:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line"><span class="string">&quot;msg&quot;</span>: <span class="string">&quot;获取成功&quot;</span>,</span><br><span class="line"><span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;博客标题&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;博客内容简要描述&quot;</span>,</span><br><span class="line">    <span class="string">&quot;content&quot;</span>: <span class="string">&quot;博客内容&quot;</span>,</span><br><span class="line">    <span class="string">&quot;user&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">100</span>, <span class="comment">//博客所属用户id</span></span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;博客所属用户username&quot;</span>,</span><br><span class="line">        <span class="string">&quot;avatar&quot;</span>: <span class="string">&quot;头像&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span>, <span class="comment">//创建时间</span></span><br><span class="line">    <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2019-10-19T15:15:33.343Z&quot;</span>, <span class="comment">//更新时间</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="POST-x2F-blog"><a href="#POST-x2F-blog" class="headerlink" title="POST &#x2F;blog"></a>POST &#x2F;blog</h3><p>功能: 创建博客</p>
<p>提交参数:</p>
<pre><code>参数类型: Content-type: application/x-www-form-urlencoded; charset=utf-8;
参数字段:
    title : 博客标题, 博客标题不能为空，且不超过100个字符
    content : 博客内容, 博客内容不能为空，且不超过10000个字符
    description: 博客内容简要描述,可为空，如果为空则后台自动从content 中提取
</code></pre>
<p>返回数据: </p>
<pre><code>失败: &#123; &quot;status&quot;: &quot;fail&quot;, &quot;msg&quot;: &quot;登录后才能操作&quot;&#125;
</code></pre>
<p>成功: </p>
<p>返回格式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;status&quot;: &quot;ok&quot;,</span><br><span class="line">&quot;msg&quot;: 创建成功&quot;,</span><br><span class="line">&quot;data&quot;: &#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;title&quot;: &quot;博客标题&quot;,</span><br><span class="line">    &quot;description&quot;: &quot;博客内容简要描述&quot;,</span><br><span class="line">    &quot;content&quot;: &quot;博客内容&quot;,</span><br><span class="line">    &quot;user&quot;: &#123;</span><br><span class="line">        &quot;id&quot;: 100, //博客所属用户id</span><br><span class="line">        &quot;username&quot;: &quot;博客所属用户username&quot;,</span><br><span class="line">        &quot;avatar&quot;: &quot;头像&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;createdAt&quot;: &quot;2019-10-19T15:15:33.343Z&quot;, //创建时间</span><br><span class="line">    &quot;updatedAt&quot;: &quot;2019-10-19T15:15:33.343Z&quot;, //更新时间</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试命令<br><code>curl -d &quot;title=hello&amp;content=world&amp;description=jirengu&quot; -X POST &quot;http://localhost:3000/blog&quot; -b &quot;connect.sid=s%3AdyZh-z5fqPU_ThG9Qn8nGD6euI0UI75e.8uso0k4P6WzqWv02iQCUwxbUML2RdlOCnpKp7RSJpj0&quot;</code></p>
<h3 id="PATCH-x2F-blog-x2F-blogid"><a href="#PATCH-x2F-blog-x2F-blogid" class="headerlink" title="PATCH &#x2F;blog&#x2F;:blogid"></a>PATCH &#x2F;blog&#x2F;:blogid</h3><p>功能: 修改博客id为:blogid的博客</p>
<p>范例: &#x2F;blog&#x2F;1</p>
<p>提交参数</p>
<p>参数类型: Content-Type: application&#x2F;x-www-form-urlencoded; charset&#x3D;utf-8</p>
<p>参数字段:</p>
<pre><code>    title: 博客标题
    content : 博客内容, 博客内容不能为空，且不超过10000个字符
    description: 博客内容简要描述,可为空，如果为空则后台自动从content 中提取
    atIndex: true/false， 展示到首页/从首页异常, 可选
</code></pre>
<p>返回数据</p>
<p>失败</p>
<p>返回格式:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;登录后才能操作&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;博客不存在&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;无法修改别人的博客&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>成功</p>
<p>返回格式:</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line"><span class="string">&quot;msg&quot;</span>: 修改成功<span class="string">&quot;,</span></span><br><span class="line"><span class="string">&quot;d</span>ata<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;</span>id<span class="string">&quot;: 1,</span></span><br><span class="line"><span class="string">    &quot;</span>title<span class="string">&quot;: &quot;</span>博客标题<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;d</span>escription<span class="string">&quot;: &quot;</span>博客内容简要描述<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;c</span>ontent<span class="string">&quot;: &quot;</span>博客内容<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>use<span class="string">r&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;</span>id<span class="string">&quot;: 100, //博客所属用户id</span></span><br><span class="line"><span class="string">        &quot;</span>username<span class="string">&quot;: &quot;</span>博客所属用户username<span class="string">&quot;,</span></span><br><span class="line"><span class="string">        &quot;</span>avata<span class="string">r&quot;: &quot;</span>头像<span class="string">&quot;</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;c</span>reatedAt<span class="string">&quot;: &quot;</span><span class="number">2019</span>-<span class="number">10</span>-<span class="number">19</span>T15:<span class="number">15</span>:<span class="number">33.343</span>Z<span class="string">&quot;, //创建时间</span></span><br><span class="line"><span class="string">    &quot;</span>updatedAt<span class="string">&quot;: &quot;</span><span class="number">2019</span>-<span class="number">10</span>-<span class="number">19</span>T15:<span class="number">15</span>:<span class="number">33.343</span>Z<span class="string">&quot;, //更新时间</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>测试命令</p>
<p><code>curl -d &quot;title=hello100&amp;content=world1&amp;description=jirengu2234444444&amp;atIndex=true&quot; -X PATCH &quot;http://localhost:3000/blog/12&quot; -b &quot;connect.sid=s%3At_9V2bMXA7U9oSAmr1dhRXpdRPAsNM2B.jlpWgkwiWdpgTjexeTHGNydt8gvc%2F%2BEkJpQ9yaAmTg0&quot;</code></p>
<h3 id="DELETE-x2F-bog-x2F-blogid"><a href="#DELETE-x2F-bog-x2F-blogid" class="headerlink" title="DELETE &#x2F;bog&#x2F;:blogid"></a>DELETE &#x2F;bog&#x2F;:blogid</h3><p>功能: 删除id为:blogid的博客</p>
<p>提交参数：无</p>
<p>返回数据</p>
<p>失败</p>
<p>返回格式范例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;登录后才能操作&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;博客不存在&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;status&quot;</span>: <span class="string">&quot;fail&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;无法删除别人的博客&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>成功</p>
<p>返回格式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line"><span class="string">&quot;msg&quot;</span>: <span class="string">&quot;删除成功&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试命令</p>
<p><code>curl -X DELETE &quot;http://localhost:3000/blog/12&quot; -b &quot;connect.sid=s%3AG_Chytg2F0RLWh2wTSCdLWVxpNg1MWWb.nPuMcgyMN6zxuxjSkyu8qSqM1boruol1Nce7egaXrPw&quot;</code></p>
<h1 id="文件介绍"><a href="#文件介绍" class="headerlink" title="文件介绍"></a>文件介绍</h1><h2 id="main-js"><a href="#main-js" class="headerlink" title="main.js"></a>main.js</h2><p>项目入口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span>,app,router <span class="keyword">from</span> ...</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">    <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>,</span><br><span class="line">    router,</span><br><span class="line">    <span class="attr">component</span>: &#123; <span class="title class_">App</span> &#125;,</span><br><span class="line">    <span class="attr">template</span>: <span class="string">&#x27;&lt;App /&gt;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br></pre></td></tr></table></figure>
<h2 id="App-vue"><a href="#App-vue" class="headerlink" title="App.vue"></a>App.vue</h2><p>当前整个项目的模板</p>
<p><code>tempalte,js,style</code></p>
<h2 id="component-x2F-xxx-vue"><a href="#component-x2F-xxx-vue" class="headerlink" title="component&#x2F;xxx.vue"></a>component&#x2F;xxx.vue</h2><p>各个组件,也可以同名的文件夹,包含vue,css,js</p>
<h2 id="router-js"><a href="#router-js" class="headerlink" title="router.js"></a>router.js</h2><p>路由组件</p>
<h1 id="请求接口封装"><a href="#请求接口封装" class="headerlink" title="请求接口封装"></a>请求接口封装</h1><h2 id="helpers-x2F-request-js"><a href="#helpers-x2F-request-js" class="headerlink" title="helpers&#x2F;request.js"></a>helpers&#x2F;request.js</h2><p>请求组件</p>
<p>import axios</p>
<p>&#x2F;&#x2F;约定请求文件格式</p>
<p><code>axios.defaults.headers.post[&#39;Content-Type&#39;] = &#39;application/x-www-form-urlencoded&#39;</code></p>
<p>&#x2F;&#x2F;接口路径</p>
<p><code>axios.defaults.baseURL = &#39;http://blog-server.hunger-valley.com&#39;</code></p>
<p>&#x2F;&#x2F;前后端分离,即使异步请求也带上cookie</p>
<p><code>axios.defaults.withCredentials = true</code></p>
<p>&#x2F;&#x2F;函数导出</p>
<p><code>export default function request()&#123;     ... &#125;</code></p>
<h2 id="api接口封装"><a href="#api接口封装" class="headerlink" title="api接口封装"></a>api接口封装</h2><h3 id="x2F-api-x2F-auth-js"><a href="#x2F-api-x2F-auth-js" class="headerlink" title="@&#x2F;api&#x2F;auth.js"></a>@&#x2F;api&#x2F;auth.js</h3><p>&#x2F;&#x2F;引入请求接口</p>
<p><code>import request from &#39;@/helpers/request&#39;</code></p>
<p>把各个接口进行封装,便于后续调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">URL</span> = &#123;</span><br><span class="line">    <span class="attr">REGISTER</span>: <span class="string">&#x27;/auth/register&#x27;</span>,</span><br><span class="line">    <span class="attr">LOGIN</span>: <span class="string">&#x27;/auth/login&#x27;</span>,</span><br><span class="line">    <span class="attr">LOGOUT</span>: <span class="string">&#x27;/auth/logout&#x27;</span>,</span><br><span class="line">    <span class="attr">GET_INFO</span>: <span class="string">&#x27;/auth&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="title function_">register</span>(<span class="params">&#123;username, password&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">REGISTER</span>, <span class="string">&#x27;POST&#x27;</span>, &#123; username, password &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">login</span>(<span class="params">&#123; username, password&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">LOGIN</span>, <span class="string">&#x27;POST&#x27;</span>, &#123; username, password &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">logout</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">LOGOUT</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">getInfo</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">GET_INFO</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="封装blog接口"><a href="#封装blog接口" class="headerlink" title="封装blog接口"></a>封装blog接口</h2><p>同样引入请求接口<br><code>import request from &#39;@/helpers/request&#39;</code></p>
<p>封装blog的各个接口</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">URL</span> = &#123;</span><br><span class="line">    <span class="attr">GET_LIST</span>: <span class="string">&#x27;/blog&#x27;</span>,</span><br><span class="line">    <span class="attr">GET_DETAIL</span>: <span class="string">&#x27;/blog/:blogId&#x27;</span>,</span><br><span class="line">    <span class="attr">CREATE</span>: <span class="string">&#x27;/blog&#x27;</span>,</span><br><span class="line">    <span class="attr">UPDATE</span>: <span class="string">&#x27;/blog/:blogId&#x27;</span>,</span><br><span class="line">    <span class="attr">DELETE</span>: <span class="string">&#x27;/blog/:blogId&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="title function_">getBlogs</span>(<span class="params">&#123; page=<span class="number">1</span>, userId, atIndex &#125; = &#123; page:<span class="number">1</span> &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">GET_LIST</span>, <span class="string">&#x27;GET&#x27;</span>, &#123; page, userId, atIndex &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">getIndexBlogs</span>(<span class="params">&#123; page=<span class="number">1</span> &#125; = &#123; page: <span class="number">1</span> &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getBlogs</span>(&#123; userId, page, atIndex &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">getDetail</span>(<span class="params">&#123; blogId &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="title function_">reuqest</span>(<span class="variable constant_">URL</span>.<span class="property">GET_DETAIL</span>, <span class="title function_">replace</span>(<span class="string">&#x27;:blogId&#x27;</span>, blogId))</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateBlog</span>(<span class="params">&#123; blogId &#125;, &#123; title, content, description, atIndex &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">UPDATE</span>, <span class="title function_">replace</span>(<span class="string">&#x27;:blogId&#x27;</span>, blogId), <span class="string">&#x27;PATCH&#x27;</span>, &#123; title, content, description, atIndex &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">deleteBlog</span>(<span class="params">&#123; blogId &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">DELETE</span>, <span class="title function_">replace</span>(<span class="string">&#x27;:blogId&#x27;</span>,blogId), <span class="string">&#x27;DELETE&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">createBlog</span>(<span class="params">&#123; title = <span class="string">&#x27;&#x27;</span>, content = <span class="string">&#x27;&#x27;</span>, description = <span class="string">&#x27;&#x27;</span>,atIndex = <span class="literal">false</span> &#125; = &#123; title = <span class="string">&#x27;&#x27;</span>, content = <span class="string">&#x27;&#x27;</span>&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">request</span>(<span class="variable constant_">URL</span>.<span class="property">CREATE</span>, <span class="string">&#x27;POST&#x27;</span>, &#123; title, content, description &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="首页布局"><a href="#首页布局" class="headerlink" title="首页布局"></a>首页布局</h1><p>…</p>
<h1 id="状态管理"><a href="#状态管理" class="headerlink" title="状态管理"></a>状态管理</h1><p>store.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @/assets/moudles/auth.js</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">    <span class="attr">user</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">isLogin</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getters = &#123;</span><br><span class="line">    <span class="attr">user</span>:<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">user</span>,</span><br><span class="line">    <span class="attr">isLogin</span>:<span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">isLogin</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mutations = &#123;</span><br><span class="line">    <span class="title function_">setUser</span>(<span class="params">state, payload</span>)&#123;</span><br><span class="line">        state.<span class="property">user</span> = payloag.<span class="property">user</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">setLogin</span>(<span class="params">state, payload</span>)&#123;</span><br><span class="line">        state.<span class="property">isLogin</span> = payload.<span class="property">isLogin</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">&#123; commit &#125;, &#123; username, password &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> auth.<span class="title function_">login</span>(&#123; username, password &#125;)</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setUser&#x27;</span>, &#123; <span class="attr">user</span>: res.<span class="property">data</span>&#125;)</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setLogin&#x27;</span>, &#123; <span class="attr">isLogin</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">data</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">&#123; commit &#125;, &#123; username, password &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> auth.<span class="title function_">register</span>(&#123; username, password&#125;)</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setUser&#x27;</span>, &#123; <span class="attr">user</span>: res.<span class="property">data</span>&#125;)</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setLogin&#x27;</span>, &#123; <span class="attr">isLogin</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">data</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">logout</span>(<span class="params">&#123; commit &#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">await</span> auth.<span class="title function_">logout</span>()</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setUser&#x27;</span>, &#123; <span class="attr">user</span>: <span class="literal">null</span> &#125;)</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setLogin&#x27;</span>, &#123; <span class="attr">isLogin</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">checkLogin</span>(<span class="params">&#123; commit, state &#125;</span>)&#123;</span><br><span class="line">        <span class="comment">//判断state中是否有登录状态,有返回true</span></span><br><span class="line">        <span class="keyword">if</span>(state.<span class="property">isLogin</span>) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment">//如果state中没有,调用res</span></span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> auth.<span class="title function_">getInfo</span>()</span><br><span class="line">        <span class="comment">//从res中获取isLogin状态设置Login</span></span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setLogin&#x27;</span>, &#123; <span class="attr">isLogin</span>: res.<span class="property">isLogin</span> &#125;) </span><br><span class="line">        <span class="comment">//如果res中未登录,返回false</span></span><br><span class="line">        <span class="keyword">if</span>(!res.<span class="property">isLogin</span>) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="comment">//如果res中已登录,设置user并返回true</span></span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;setUser&#x27;</span>, &#123; <span class="attr">user</span>: res.<span class="property">data</span> &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    state,</span><br><span class="line">    getters,</span><br><span class="line">    mutations,</span><br><span class="line">    actions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="在header-vue中调用vuex中的参数"><a href="#在header-vue中调用vuex中的参数" class="headerlink" title="在header.vue中调用vuex中的参数"></a>在header.vue中调用vuex中的参数</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//header.vue</span></span><br><span class="line"><span class="keyword">import</span> &#123; mapState, mapActions &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">computed</span>(<span class="params"></span>)&#123;</span><br><span class="line">        ...<span class="title function_">mapGetters</span>([</span><br><span class="line">            <span class="string">&#x27;isLogin&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;user&#x27;</span></span><br><span class="line">        ])</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">created</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//在生命周期created调用methods的方法</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">checkLogin</span>()</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">methods</span>: &#123;</span><br><span class="line">        <span class="comment">//将state中的方法映射进来</span></span><br><span class="line">        ...<span class="title function_">mapActions</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;checkLogin&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="登录和注册"><a href="#登录和注册" class="headerlink" title="登录和注册"></a>登录和注册</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Login/template.vue</span></span><br><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;login&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h4</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;用户名&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h4</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">v-model</span>=<span class="string">&quot;password&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;密码&quot;</span> @<span class="attr">key.enter</span>=<span class="string">&quot;onLogin&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">size</span>=<span class="string">&quot;medium&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;onLogin&quot;</span>&gt;</span>立即登录<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;notice&quot;</span>&gt;</span>没有账号?<span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">&quot;/register&quot;</span>&gt;</span>注册新用户<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Login/template.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; mapActions &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="title function_">data</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="attr">password</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">methods</span>: &#123;</span><br><span class="line">        <span class="comment">//把login从vuex中拿出来</span></span><br><span class="line">        ...<span class="title function_">mapActions</span>([<span class="string">&#x27;login&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        <span class="title function_">onLogin</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="comment">//test</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">username</span> + <span class="variable language_">this</span>.<span class="property">password</span>)</span><br><span class="line">            <span class="comment">//执行登录,把用户名密码传递</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">login</span>(&#123;<span class="attr">username</span>: <span class="variable language_">this</span>.<span class="property">username</span>, <span class="attr">password</span>: <span class="variable language_">this</span>.<span class="property">password</span>&#125;)</span><br><span class="line">            <span class="comment">//调用then下一步操作,跳转到首页或者定向页面</span></span><br><span class="line">                .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(&#123;<span class="attr">path</span>: <span class="variable language_">this</span>.<span class="property">$route</span>.<span class="property">query</span>.<span class="property">redirect</span> || <span class="string">&#x27;/&#x27;</span>&#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><p>注册类似于登录<br>将login换成register即可.</p>
<h1 id="路由组件router-js"><a href="#路由组件router-js" class="headerlink" title="路由组件router.js"></a>路由组件router.js</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//引入store为了checkin</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./src/store.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Router</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//先声明,最后再导出</span></span><br><span class="line"><span class="keyword">const</span> router =  <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;</span><br><span class="line">  <span class="attr">routes</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="comment">//使用匿名函数import方式实现异步懒加载</span></span><br><span class="line">      <span class="comment">//当需要跳转该模块时才会引入相关路径</span></span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/Index/template.vue&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/Login/template.vue&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/detail/:blogId&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/Detail/template.vue&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/edit/:blogId&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/Edit/template.vue&#x27;</span>),</span><br><span class="line">      <span class="attr">meta</span>: &#123; <span class="attr">requiresAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/create&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/Create/template.vue&#x27;</span>),</span><br><span class="line">      <span class="attr">meta</span>: &#123; <span class="attr">requiresAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/user/:userId&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/User/template.vue&#x27;</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/my&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/My/template.vue&#x27;</span>),</span><br><span class="line">      <span class="attr">meta</span>: &#123; <span class="attr">requiresAuth</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/pages/Register/template.vue&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//判断是否有元信息meta</span></span><br><span class="line">    <span class="keyword">if</span>(to.<span class="property">matched</span>.<span class="title function_">some</span>(<span class="function"><span class="params">record</span> =&gt;</span> record.<span class="property">meta</span>.<span class="property">requiresAuth</span>))&#123;</span><br><span class="line">        <span class="comment">//如果有就触发checkLogin检查登录状态</span></span><br><span class="line">        store.<span class="title function_">dispatch</span>(<span class="string">&#x27;checkLogin&#x27;</span>).<span class="title function_">then</span>(<span class="function"><span class="params">isLogin</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!isLogin)&#123;</span><br><span class="line">                <span class="title function_">next</span>(&#123;</span><br><span class="line">                    <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">                    <span class="attr">query</span>: &#123; <span class="attr">redirect</span>: to.<span class="property">fullPath</span> &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">next</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="创建博客页面"><a href="#创建博客页面" class="headerlink" title="创建博客页面"></a>创建博客页面</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;edit&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 创建博客 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>创建文章<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>文章标题<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">v-model</span>=<span class="string">&quot;title&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;msg&quot;</span>&gt;</span>限30个字<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>内容简介<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">type</span>=<span class="string">&quot;textarea&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;description&quot;</span> <span class="attr">:autosize</span>=<span class="string">&quot;&#123; minRow: 2, maxRows: 4 &#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;msg&quot;</span>&gt;</span>限30个字<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>文章内容<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">type</span>=<span class="string">&quot;textarea&quot;</span> <span class="attr">v-model</span>=<span class="string">&quot;content&quot;</span> <span class="attr">:autosize</span>=<span class="string">&quot;&#123; minRow: 4, maxRows: 30 &#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;msg&quot;</span>&gt;</span>限30个字<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>是否展示到首页<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">el-switch</span> <span class="attr">v-model</span>=<span class="string">&quot;atIndex&quot;</span> <span class="attr">active-color</span>=<span class="string">&quot;#13ce66&quot;</span> <span class="attr">inactive-color</span>=<span class="string">&quot;#fff&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">el-switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">el-button</span> @<span class="attr">click</span>=<span class="string">&quot;onCreate&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> blog <span class="keyword">from</span> <span class="string">&#x27;@/api/blog&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="title function_">data</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="attr">description</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="attr">content</span>: <span class="string">&#x27;&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            <span class="attr">atIndex</span>: <span class="literal">false</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="attr">methods</span>: &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        <span class="title function_">onCreate</span>(<span class="params"></span>)&#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">            blog.<span class="title function_">createBlog</span>(&#123; <span class="attr">title</span>: <span class="variable language_">this</span>.<span class="property">title</span>, <span class="attr">content</span>: <span class="variable language_">this</span>.<span class="property">content</span>, <span class="attr">description</span>: <span class="variable language_">this</span>.<span class="property">description</span>, <span class="attr">atIndex</span>: <span class="variable language_">this</span>.<span class="property">atIndex</span>&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="variable language_">this</span>.<span class="property">$message</span>.<span class="title function_">success</span>(res.<span class="property">msg</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                    <span class="variable language_">this</span>.<span class="property">$router</span>.<span class="title function_">push</span>(&#123; <span class="attr">path</span>: <span class="string">`/detail/<span class="subst">$&#123;res.data.id&#125;</span>`</span>&#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">                &#125;)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">        &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h1 id="完善首页"><a href="#完善首页" class="headerlink" title="完善首页"></a>完善首页</h1><h1 id="详情页"><a href="#详情页" class="headerlink" title="详情页"></a>详情页</h1><h1 id="时间插件"><a href="#时间插件" class="headerlink" title="时间插件"></a>时间插件</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">friendlyDate</span>(<span class="params">datsStr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> dateObj = <span class="keyword">typeof</span> datsStr === <span class="string">&#x27;object&#x27;</span> ? datsStr : <span class="keyword">new</span> <span class="title class_">Date</span>(datsStr)</span><br><span class="line">    <span class="keyword">let</span> time = dateObj.<span class="title function_">getTime</span>()</span><br><span class="line">    <span class="keyword">let</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    <span class="keyword">let</span> space = now - time</span><br><span class="line">    <span class="keyword">let</span> str = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">switch</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">case</span> space &lt; <span class="number">60000</span>:</span><br><span class="line">            str = <span class="string">&#x27;刚刚&#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> space &lt; <span class="number">1000</span>*<span class="number">3600</span>:</span><br><span class="line">            str = <span class="title class_">Math</span>.<span class="title function_">floor</span>(space/<span class="number">60000</span>) + <span class="string">&#x27;分钟前&#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> space &lt; <span class="number">1000</span>*<span class="number">3600</span>*<span class="number">24</span>:</span><br><span class="line">            str = <span class="title class_">Math</span>.<span class="title function_">floor</span>(space/(<span class="number">1000</span>*<span class="number">3600</span>)) + <span class="string">&#x27;小时前&#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            str = <span class="title class_">Math</span>.<span class="title function_">floor</span>(space/(<span class="number">1000</span>*<span class="number">3600</span>*<span class="number">24</span>)) + <span class="string">&#x27;天前&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="title function_">install</span>(<span class="params">Vue, options</span>) &#123;</span><br><span class="line">        <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">friendlyDate</span> = friendlyDate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="个人页面user"><a href="#个人页面user" class="headerlink" title="个人页面user"></a>个人页面user</h1><p>有点东西</p>
<h1 id="登陆者的个人页面my"><a href="#登陆者的个人页面my" class="headerlink" title="登陆者的个人页面my"></a>登陆者的个人页面my</h1><h1 id="遇到过的问题"><a href="#遇到过的问题" class="headerlink" title="遇到过的问题"></a>遇到过的问题</h1><ol>
<li>vuex中actions错误(原因: modules拼错了)</li>
<li>登录时enter无法使用.(解决方法: 加.native)</li>
<li>文章内容应有一定区域(原因: 没写palceholder)</li>
<li>编辑时少一个设置为首页的按钮(原因:按钮初始颜色透明)</li>
<li>my页面无法显示(原因: 因为错误6)</li>
<li>过滤器getMouth错误,(原因: mouth单词拼错)</li>
<li>my页面编辑删除两个按钮靠的太近</li>
<li>header布局错误(原因: h1标签没有把router-link包裹,如果包裹,less有设置h1下a标签的颜色为白色.<br>没有包裹的时候,a标签的颜色是common.less设置的黑色,会覆盖)<br>标题颜色错误,把标题文本和普通文本颜色算在一起了.</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/27/%E5%A4%9A%E4%BA%BA%E5%8D%9A%E5%AE%A2%E9%A1%B9%E7%9B%AE/" data-id="cl9xpujrx0044dmopa0k9763n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/10/">&amp;laquo; 上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/12/">下一页 &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/HTML%E5%9F%BA%E7%A1%80/">HTML基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/HTTP%E5%9F%BA%E7%A1%80/">HTTP基础</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTML5/">HTML5</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/HTML5/canvas/">canvas</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/">JS</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JS/ES6/">ES6</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/JS%E5%9F%BA%E7%A1%80/">JS基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/JS%E8%BF%9B%E9%98%B6/">JS进阶</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/jQuery/">jQuery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JS/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/">前端工程化</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/css/css3/">css3</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/">后端</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%90%8E%E7%AB%AF/Node-js/">Node.js</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP%E5%AE%89%E5%85%A8/" rel="tag">HTTP安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP%E8%BF%9B%E9%98%B6/" rel="tag">HTTP进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS%E6%B7%B1%E5%85%A5/" rel="tag">JS深入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS%E8%BF%9B%E9%98%B6/" rel="tag">JS进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-SSR/" rel="tag">Vue-SSR</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-js/" rel="tag">Vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-js%E5%9F%BA%E7%A1%80/" rel="tag">Vue.js基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-js%E8%BF%9B%E9%98%B6/" rel="tag">Vue.js进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css3/" rel="tag">css3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/html5/" rel="tag">html5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8E%E7%AB%AF/" rel="tag">后端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/" rel="tag">移动端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%A1%B9%E7%9B%AE/" rel="tag">项目</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/HTML/" style="font-size: 18.57px;">HTML</a> <a href="/tags/HTTP%E5%AE%89%E5%85%A8/" style="font-size: 10px;">HTTP安全</a> <a href="/tags/HTTP%E8%BF%9B%E9%98%B6/" style="font-size: 10px;">HTTP进阶</a> <a href="/tags/JS/" style="font-size: 12.86px;">JS</a> <a href="/tags/JS%E6%B7%B1%E5%85%A5/" style="font-size: 10px;">JS深入</a> <a href="/tags/JS%E8%BF%9B%E9%98%B6/" style="font-size: 11.43px;">JS进阶</a> <a href="/tags/React/" style="font-size: 17.14px;">React</a> <a href="/tags/Vue-SSR/" style="font-size: 15.71px;">Vue-SSR</a> <a href="/tags/Vue-js/" style="font-size: 20px;">Vue.js</a> <a href="/tags/Vue-js%E5%9F%BA%E7%A1%80/" style="font-size: 11.43px;">Vue.js基础</a> <a href="/tags/Vue-js%E8%BF%9B%E9%98%B6/" style="font-size: 17.14px;">Vue.js进阶</a> <a href="/tags/android/" style="font-size: 11.43px;">android</a> <a href="/tags/css/" style="font-size: 14.29px;">css</a> <a href="/tags/css3/" style="font-size: 11.43px;">css3</a> <a href="/tags/html5/" style="font-size: 12.86px;">html5</a> <a href="/tags/javascript/" style="font-size: 15.71px;">javascript</a> <a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 11.43px;">后端</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 11.43px;">基础</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 11.43px;">小程序</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF/" style="font-size: 10px;">移动端</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 14.29px;">面试题</a> <a href="/tags/%E9%A1%B9%E7%9B%AE/" style="font-size: 12.86px;">项目</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/11/01/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2022/10/25/yuque/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/">自动化构建工具</a>
          </li>
        
          <li>
            <a href="/2022/10/25/yuque/%E8%84%9A%E6%89%8B%E6%9E%B6/">脚手架</a>
          </li>
        
          <li>
            <a href="/2022/10/24/yuque/React%20Query/">React Query</a>
          </li>
        
          <li>
            <a href="/2022/10/19/yuque/%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6/">常用组件</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Zax Tseng<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>