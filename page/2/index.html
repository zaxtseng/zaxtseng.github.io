<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="ZAX">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="ZAX">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zax Tseng">
<meta property="article:tag" content="javascript, React, Vue, HTML5">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ZAX</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ZAX</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zax Tseng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">123</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/18/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/18/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">性能优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-18 14:11:17" itemprop="dateCreated datePublished" datetime="2022-11-18T14:11:17+08:00">2022-11-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:13" itemprop="dateModified" datetime="2023-03-19T18:57:13+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这是一个比较大的话题.包含了很多部分.总体来讲就是尽量快的加载页面,使用资源又尽量少.</p>
<h1 id="从输入网址到页面渲染-发生了啥"><a href="#从输入网址到页面渲染-发生了啥" class="headerlink" title="从输入网址到页面渲染,发生了啥"></a>从输入网址到页面渲染,发生了啥</h1><p>这道面试题就比较宽范的触及到性能优化的各个点.需要比较系统的去理解.</p>
<h1 id="阻塞渲染"><a href="#阻塞渲染" class="headerlink" title="阻塞渲染"></a>阻塞渲染</h1><p>想要首屏优化,就得先把页面渲染出来,什么会阻塞渲染呢?<br>HTML 和 CSS 会,因为他们要合成渲染树.所以就要降低要渲染的文件大小,扁平层级,优化选择器.<br>还有一个问题,<code>script</code>会暂停 DOM 渲染.所以一般<code>script</code>会放在 body 后面.<br>不想放底部就可以使用<code>defer</code>和<code>async</code>属性.两个都是异步下载,和 dom 并行.区别就是执行了.<br>下载是没区别的.<br><code>defer</code>:要等到 DOM 执行完,再按照顺序执行.<br><code>async</code>: 下载完就执行,不按顺序,谁先完事谁先跑.</p>
<h2 id="为什么操作-DOM-慢"><a href="#为什么操作-DOM-慢" class="headerlink" title="为什么操作 DOM 慢"></a>为什么操作 DOM 慢</h2><p>dom 属于渲染引擎,js 属于 js 引擎,通过 js 操作 dom 就涉及到两个线程之间的通信,就会带来性能损耗.还有可能带来回流重绘的情况,导致性能问题.</p>
<h2 id="插入几万个-DOM-如何实现页面不卡顿"><a href="#插入几万个-DOM-如何实现页面不卡顿" class="headerlink" title="插入几万个 DOM,如何实现页面不卡顿"></a>插入几万个 DOM,如何实现页面不卡顿</h2><p>肯定不能一次性加载,需要分批次加载.<br>方法一: 通过<code>requestAnimationFrame</code>的方式循环插入 DOM.<br>方法二: 虚拟滚动.只渲染可视区域的内容.当用户滚动,实时替换渲染的内容.避免空白记得加上预渲染.</p>
<h1 id="HTML-优化"><a href="#HTML-优化" class="headerlink" title="HTML 优化"></a>HTML 优化</h1><p>就是在不考虑,网络和缓存的情况下,如何加快渲染?</p>
<ul>
<li>从文件大小考虑</li>
<li>从 script 标签使用上来考虑</li>
<li>从 CSS、HTML 的代码书写上来考虑</li>
<li>从需要下载的内容是否需要在首屏使用上来考虑</li>
</ul>
<h1 id="JS-性能优化"><a href="#JS-性能优化" class="headerlink" title="JS 性能优化"></a>JS 性能优化</h1><h1 id="CSS-性能优化"><a href="#CSS-性能优化" class="headerlink" title="CSS 性能优化"></a>CSS 性能优化</h1><p>问题: css 层级设置过多导致性能减弱</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">div</span>&gt;</span><br><span class="line">  &lt;<span class="selector-tag">a</span>&gt; &lt;<span class="selector-tag">span</span>&gt;&lt;/<span class="selector-tag">span</span>&gt; &lt;/<span class="selector-tag">a</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">  <span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-tag">div</span> &gt; <span class="selector-tag">a</span> &gt; <span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>明显第一种要比第二种效率高得多.减少了因查找递归的过程带来的性能损失.<br>防范: 尽量避免写过于具体的 CSS 选择器,对 HTML 尽量减少无意义的标签.</p>
<h2 id="回流-reflow-和重绘-repaint"><a href="#回流-reflow-和重绘-repaint" class="headerlink" title="回流(reflow)和重绘(repaint)"></a>回流(reflow)和重绘(repaint)</h2><ul>
<li>回流: 回的是文档流,都要快加载好了,又倒回去了.就是回流.布局或者几何属性发生的变化.</li>
<li>重绘: 重新绘画,就是上色.就是外观发生的变化.</li>
<li>回流肯定重绘,重绘不一定回流.</li>
</ul>
<p>1、添加、删除元素(回流+重绘)<br>2、隐藏元素，display:none(回流+重绘)，visibility:hidden(只重绘，不回流)<br>3、移动元素，如改变 top、left 或移动元素到另外 1 个父元素中(重绘+回流)<br>4、改变浏览器大小(回流+重绘)<br>5、改变浏览器的字体大小(回流+重绘)<br>6、改变元素的 padding、border、margin(回流+重绘)<br>7、改变浏览器的字体颜色（只重绘，不回流）<br>8、改变元素的背景颜色（只重绘，不回流）</p>
<h3 id="减少"><a href="#减少" class="headerlink" title="减少"></a>减少</h3><ul>
<li>CSS 选择符从右往左匹配查找，避免节点层级过多</li>
<li>不要使用 table 布局</li>
<li>不要把节点的属性值放在一个循环里当成循环里的变量</li>
<li>使用 <code>visibility</code> 替换 <code>display: none</code></li>
</ul>
<h1 id="网络性能优化"><a href="#网络性能优化" class="headerlink" title="网络性能优化"></a>网络性能优化</h1><h1 id="框架性能优化"><a href="#框架性能优化" class="headerlink" title="框架性能优化"></a>框架性能优化</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/10/mongoose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/10/mongoose/" class="post-title-link" itemprop="url">mongoose</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-10 20:20:41" itemprop="dateCreated datePublished" datetime="2022-11-10T20:20:41+08:00">2022-11-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:13" itemprop="dateModified" datetime="2023-03-19T18:57:13+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="连接-mongo"><a href="#连接-mongo" class="headerlink" title="连接 mongo"></a>连接 mongo</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @ use 数据库连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&quot;../../config/common&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dbConfig = config[process.<span class="property">env</span>.<span class="property">NODE_ENV</span> || <span class="string">&quot;development&quot;</span>];</span><br><span class="line"></span><br><span class="line">mongoose.<span class="title function_">connect</span>(dbConfig.<span class="property">mongo</span>.<span class="property">url</span>, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">mongoose.<span class="title function_">set</span>(<span class="string">&quot;useCreateIndex&quot;</span>, <span class="literal">true</span>); <span class="comment">//加上这个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接成功</span></span><br><span class="line">mongoose.<span class="property">connection</span>.<span class="title function_">on</span>(<span class="string">&quot;connected&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//console.log(&#x27;连接成功 &#x27; + dbConfig.mongo.url);</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接失败</span></span><br><span class="line">mongoose.<span class="property">connection</span>.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接失败 &quot;</span> + err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 断开连接</span></span><br><span class="line">mongoose.<span class="property">connection</span>.<span class="title function_">on</span>(<span class="string">&quot;disconnected&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;断开连接&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="定义-Schema"><a href="#定义-Schema" class="headerlink" title="定义 Schema"></a>定义 Schema</h3><h4 id="Schema-Type"><a href="#Schema-Type" class="headerlink" title="#Schema.Type"></a><a target="_blank" rel="noopener" href="http://file.jing999.cn/workspace/Server/sql/mongoose.html#schema-type">#</a>Schema.Type</h4><ul>
<li>String</li>
<li>Number</li>
<li>Date</li>
<li>Buffer</li>
<li>Boolean</li>
<li>Mixed</li>
<li>Objectid</li>
<li>Array</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Schema</span>   = mongoose.<span class="property">Schema</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">UserSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">    name  : &#123; <span class="attr">type</span>: <span class="title class_">String</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    posts : [&#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;Post&#x27;</span> &#125;]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">User</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>, <span class="title class_">UserSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">PostSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">    poster   : &#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;User&#x27;</span> &#125;,</span><br><span class="line">    comments : [&#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;Comment&#x27;</span> &#125;],</span><br><span class="line">    title    : <span class="title class_">String</span>,</span><br><span class="line">    content  : <span class="title class_">String</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Post</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>, <span class="title class_">PostSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">CommentSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">    post      : &#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&quot;Post&quot;</span> &#125;,</span><br><span class="line">    commenter : &#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;User&#x27;</span> &#125;,</span><br><span class="line">    content   : &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title class_">String</span>,</span><br><span class="line">        <span class="attr">label</span>: <span class="title class_">String</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">points</span>: [</span><br><span class="line">        <span class="attr">point</span>: [&#123;<span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;Point&#x27;</span>&#125;]</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Comment</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>, <span class="title class_">CommentSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">PointSchema</span> = <span class="keyword">new</span> mongoose.<span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">parent</span>: &#123;<span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;point&#x27;</span>&#125;,</span><br><span class="line">  <span class="attr">children</span>: [&#123;<span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;point&#x27;</span>&#125;]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Point</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Point&#x27;</span>, <span class="title class_">PointSchema</span>);</span><br></pre></td></tr></table></figure>

<h1 id="查询条件"><a href="#查询条件" class="headerlink" title="查询条件"></a>查询条件</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$or　　　　或关系</span><br><span class="line">$nor　　　 或关系取反</span><br><span class="line">$gt　　　　大于</span><br><span class="line">$gte　　　 大于等于</span><br><span class="line">$lt　　　　 小于</span><br><span class="line">$lte　　　  小于等于</span><br><span class="line">$ne            不等于</span><br><span class="line">$in             在多个值范围内</span><br><span class="line">$nin           不在多个值范围内</span><br><span class="line">$all            匹配数组中多个值</span><br><span class="line">$regex　　正则，用于模糊查询</span><br><span class="line">$size　　　匹配数组大小</span><br><span class="line">$maxDistance　　范围查询，距离（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$mod　　   取模运算</span><br><span class="line">$near　　　邻域查询，查询附近的位置（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$exists　　  字段是否存在</span><br><span class="line">$elemMatch　　匹配内数组内的元素</span><br><span class="line">$within　　范围查询（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$box　　　 范围查询，矩形范围（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$center       范围醒询，圆形范围（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$centerSphere　　范围查询，球形范围（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$slice　　　　查询字段集合中的元素（比如从第几个之后，第N到第M个元素）</span><br></pre></td></tr></table></figure>

<h3 id="mongodb-对数组中的所有元素进行一次性修改方法"><a href="#mongodb-对数组中的所有元素进行一次性修改方法" class="headerlink" title="mongodb 对数组中的所有元素进行一次性修改方法"></a>mongodb 对数组中的所有元素进行一次性修改方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">list</span>: [&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">        <span class="attr">date</span>: <span class="number">1504195200000</span>,</span><br><span class="line">        <span class="attr">other</span>: <span class="string">&quot;c&quot;</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&quot;b&quot;</span>,</span><br><span class="line">        <span class="attr">date</span>: <span class="number">1504195200000</span>,</span><br><span class="line">        <span class="attr">other</span>: <span class="string">&quot;c&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 现在要把other全部更新为&quot;a&quot;,方法如下</span></span><br><span class="line">db.<span class="title function_">getCollection</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">  .<span class="title function_">update</span>(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="number">4</span>&#125;, &#123;<span class="attr">$set</span>: &#123;<span class="string">&#x27;list.$[].other&#x27;</span>: <span class="string">&#x27;a&#x27;</span>&#125;&#125;, &#123;<span class="attr">multi</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/GraphQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/GraphQL/" class="post-title-link" itemprop="url">GraphQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:08:54" itemprop="dateCreated datePublished" datetime="2022-11-08T17:08:54+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:13" itemprop="dateModified" datetime="2023-03-19T18:57:13+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>暂无</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/Egg.js/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/Egg.js/" class="post-title-link" itemprop="url">Egg.js</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:08:35" itemprop="dateCreated datePublished" datetime="2022-11-08T17:08:35+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:14" itemprop="dateModified" datetime="2023-03-19T18:57:14+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">核心思想: 约定大于配置</div>

<h1 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h1><p>建议直接去这里: <a target="_blank" rel="noopener" href="https://www.eggjs.org/zh-CN/intro/quickstart">官方快速入门</a></p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">egg-project</span><br><span class="line">├── package.json</span><br><span class="line">├── app.js (可选)</span><br><span class="line">├── agent.js (可选)</span><br><span class="line">├── app</span><br><span class="line">|   ├── router.js</span><br><span class="line">│   ├── controller</span><br><span class="line">│   |   └── home.js</span><br><span class="line">│   ├── service (可选)</span><br><span class="line">│   |   └── user.js</span><br><span class="line">│   ├── middleware (可选)</span><br><span class="line">│   |   └── response_time.js</span><br><span class="line">│   ├── schedule (可选)</span><br><span class="line">│   |   └── my_task.js</span><br><span class="line">│   ├── public (可选)</span><br><span class="line">│   |   └── reset.css</span><br><span class="line">│   ├── view (可选)</span><br><span class="line">│   |   └── home.tpl</span><br><span class="line">│   └── extend (可选)</span><br><span class="line">│       ├── helper.js (可选)</span><br><span class="line">│       ├── request.js (可选)</span><br><span class="line">│       ├── response.js (可选)</span><br><span class="line">│       ├── context.js (可选)</span><br><span class="line">│       ├── application.js (可选)</span><br><span class="line">│       └── agent.js (可选)</span><br><span class="line">├── config</span><br><span class="line">|   ├── plugin.js</span><br><span class="line">|   ├── config.default.js</span><br><span class="line">│   ├── config.prod.js</span><br><span class="line">|   ├── config.test.js (可选)</span><br><span class="line">|   ├── config.local.js (可选)</span><br><span class="line">|   └── config.unittest.js (可选)</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── middleware</span><br><span class="line">    |   └── response_time.test.js</span><br><span class="line">    └── controller</span><br><span class="line">        └── home.test.js</span><br></pre></td></tr></table></figure>

<h1 id="初始化脚本"><a href="#初始化脚本" class="headerlink" title="初始化脚本"></a>初始化脚本</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm create egg --type=simple -r=https://registry.npmmirror.com/</span><br></pre></td></tr></table></figure>

<h1 id="模块设计"><a href="#模块设计" class="headerlink" title="模块设计"></a>模块设计</h1><p>model 层: 放置一些要往数据库中存储的数据类型的模型.主要是<code>Schema</code>的实例.<br>service 层: 对 model 层中对应数据库的数据的操作,增删改查之类.<br>controller 层: 设计的业务逻辑,通过调用 service 的一些方法实现,返回给前端.<br>middleware: 在多处使用的方法可以抽离出,比如<code>auth</code>,<code>error</code>等模块.<br>config: 配置基础参数.<br>extend: 扩展方法,主要是一些和业务逻辑关联性不大的方法.比如<code>md5</code>加密.<br>schedule: 定时任务.</p>
<h1 id="内置基础对象"><a href="#内置基础对象" class="headerlink" title="内置基础对象"></a>内置基础对象</h1><p>Application,Context,Request,Response,Controller,Service,Helper,Config,Logger,Subscription.<br>其中前 4 个是从 Koa 继承而来.其他是框架自身的.</p>
<h1 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h1><p>Application 是全局应用对象。在一个应用中，每个进程只会实例化一个 Application 实例。在它上面我们可以挂载一些全局的方法和对象。</p>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><p>框架提供了一个 Controller 基类，并推荐所有的 Controller 都继承于该基类实现。这个 Controller 基类有下列属性：</p>
<ul>
<li><code>ctx</code> - 当前请求的 Context 实例。</li>
<li><code>app</code> - 应用的 Application 实例。</li>
<li><code>config</code> - 应用的配置。</li>
<li><code>service</code> - 应用所有的 service。</li>
<li><code>logger</code> - 为当前 controller 封装的 logger 对象。</li>
</ul>
<h1 id="路由相关"><a href="#路由相关" class="headerlink" title="路由相关"></a>路由相关</h1><h2 id="1-get-传值"><a href="#1-get-传值" class="headerlink" title="1. get 传值"></a>1. get 传值</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/admin/:id&#x27;</span>, controller.<span class="property">admin</span>.<span class="property">index</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// controller</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取路由get传值参数（路由:id）</span></span><br><span class="line">    ctx.<span class="property">params</span>;</span><br><span class="line">    <span class="comment">// 获取url的问号get传值参数</span></span><br><span class="line">    ctx.<span class="property">query</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-种配置方法"><a href="#2-4-种配置方法" class="headerlink" title="2. 4 种配置方法"></a>2. 4 种配置方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;path-match&#x27;</span>, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;router-name&#x27;</span>, <span class="string">&#x27;path-match&#x27;</span>, app.<span class="property">controller</span>.<span class="property">action</span>);<span class="comment">// 第一个参数可以给name</span></span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;path-match&#x27;</span>, middleware1, ..., middlewareN, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;router-name&#x27;</span>, <span class="string">&#x27;path-match&#x27;</span>, middleware1, ..., middlewareN, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br></pre></td></tr></table></figure>

<h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><h2 id="1-ctx"><a href="#1-ctx" class="headerlink" title="1. ctx"></a>1. ctx</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">status</span> = <span class="number">301</span>; <span class="comment">// 把重定向改为301</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">redirect</span>(<span class="string">&#x27;/admin/add&#x27;</span>); <span class="comment">// 默认临时重定向 302</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-路由重定向"><a href="#2-路由重定向" class="headerlink" title="2. 路由重定向"></a>2. 路由重定向</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="property">router</span>.<span class="title function_">redirect</span>(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/home/index&quot;</span>, <span class="number">302</span>);</span><br></pre></td></tr></table></figure>

<h2 id="3-路由分组"><a href="#3-路由分组" class="headerlink" title="3.路由分组"></a>3.路由分组</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./router/news&quot;</span>)(app);</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./router/admin&quot;</span>)(app);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/news.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/news/list&quot;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">list</span>);</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/news/detail&quot;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">detail</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/admin.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/admin/user&quot;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">user</span>);</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/admin/log&quot;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">log</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h1><h2 id="自定义-Controller-基类"><a href="#自定义-Controller-基类" class="headerlink" title="自定义 Controller 基类"></a>自定义 Controller 基类</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/core/base_controller.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Controller</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">user</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">session</span>.<span class="property">user</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">success</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">      data,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">notFound</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">    msg = msg || <span class="string">&quot;not found&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="keyword">throw</span>(<span class="number">404</span>, msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">BaseController</span>;</span><br></pre></td></tr></table></figure>

<p>此时在编写应用的 Controller 时，可以继承 BaseController，直接使用基类上的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app/controller/post.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Controller</span> = <span class="built_in">require</span>(<span class="string">&quot;../core/base_controller&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PostController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> posts = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">service</span>.<span class="title function_">listByUser</span>(<span class="variable language_">this</span>.<span class="property">user</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">success</span>(posts);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h1><h2 id="1-安装和使用-ejs"><a href="#1-安装和使用-ejs" class="headerlink" title="1. 安装和使用 ejs"></a>1. 安装和使用 ejs</h2><h3 id="（1）安装："><a href="#（1）安装：" class="headerlink" title="（1）安装："></a>（1）安装：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-view-ejs --save</span><br></pre></td></tr></table></figure>

<h3 id="（2）配置：-x2F-config"><a href="#（2）配置：-x2F-config" class="headerlink" title="（2）配置：&#x2F;config"></a>（2）配置：&#x2F;config</h3><p>config&#x2F;config.default.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">appInfo</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    config.<span class="property">view</span> = &#123;</span><br><span class="line">        <span class="attr">mapping</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;.html&#x27;</span>: <span class="string">&#x27;ejs&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>config&#x2F;plugin.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 配置ejs</span></span><br><span class="line">  <span class="attr">ejs</span>: &#123;</span><br><span class="line">    <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">package</span>: <span class="string">&quot;egg-view-ejs&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="（3）使用"><a href="#（3）使用" class="headerlink" title="（3）使用"></a>（3）使用</h3><p>app&#x2F;controller</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 渲染变量</span></span><br><span class="line">    <span class="keyword">let</span> msg = <span class="string">&quot;测试内容&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line">    <span class="comment">// 渲染模板（render需要加await）</span></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;</span><br><span class="line">        msg,</span><br><span class="line">        list</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app&#x2F;view&#x2F;index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--渲染变量--&gt;</span></span><br><span class="line">    &lt;%=msg%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      &lt;% for(var i=0; i &lt; list.length; i++)&#123; %&gt;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%=list[i]%&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载 app/public 下的资源文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/public/images/find.png&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="模型和数据库"><a href="#模型和数据库" class="headerlink" title="模型和数据库"></a>模型和数据库</h1><h2 id="配置和创建迁移文件"><a href="#配置和创建迁移文件" class="headerlink" title="配置和创建迁移文件"></a>配置和创建迁移文件</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><strong>文档地址：</strong><a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/blob/v5/migrations.md"><strong>https://github.com/demopark/sequelize-docs-Zh-CN/blob/v5/migrations.md</strong></a></p>
<ol>
<li>安装并配置<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg-sequelize">egg-sequelize</a>插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和<a target="_blank" rel="noopener" href="https://github.com/sidorares/node-mysql2">mysql2</a>模块：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在<code>config/plugin.js</code>中引入 egg-sequelize 插件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exports.sequelize = &#123;</span><br><span class="line">  enable: true,</span><br><span class="line">  package: &#x27;egg-sequelize&#x27;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在<code>config/config.default.js</code></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">config.<span class="property">sequelize</span> = &#123;</span><br><span class="line">  <span class="attr">dialect</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">  <span class="attr">username</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&quot;friends&quot;</span>,</span><br><span class="line">  <span class="comment">// 中国时区</span></span><br><span class="line">  <span class="attr">timezone</span>: <span class="string">&quot;+08:00&quot;</span>,</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// 取消数据表名复数</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 自动写入时间戳 created_at updated_at</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 字段生成软删除时间戳 deleted_at</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">createdAt</span>: <span class="string">&quot;created_at&quot;</span>,</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;updated_at&quot;</span>,</span><br><span class="line">    <span class="attr">deletedAt</span>: <span class="string">&quot;deleted_at&quot;</span>,</span><br><span class="line">    <span class="comment">// 所有驼峰命名格式化</span></span><br><span class="line">    <span class="attr">underscored</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>sequelize 提供了<a target="_blank" rel="noopener" href="https://github.com/sequelize/cli">sequelize-cli</a>工具来实现<a target="_blank" rel="noopener" href="http://docs.sequelizejs.com/manual/tutorial/migrations.html">Migrations</a>，我们也可以在 egg 项目中引入 sequelize-cli。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev sequelize-cli</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在<code>database</code>目录下，所以我们在项目根目录下新建一个<code>.sequelizerc</code>配置文件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">config</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/config.json&quot;</span>),</span><br><span class="line">  <span class="string">&quot;migrations-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/migrations&quot;</span>),</span><br><span class="line">  <span class="string">&quot;seeders-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/seeders&quot;</span>),</span><br><span class="line">  <span class="string">&quot;models-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;app/model&quot;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>初始化 Migrations 配置文件和目录</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">init</span>:config</span><br><span class="line">npx sequelize <span class="attr">init</span>:migrations</span><br><span class="line"><span class="comment">// npx sequelize init:models</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>行完后会生成<code>database/config.json</code>文件和<code>database/migrations</code>目录，我们修改一下<code>database/config.json</code>中的内容，将其改成我们项目中使用的数据库配置：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;development&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dialect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timezone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+08:00&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="8">
<li>创建数据库</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">db</span>:create</span><br></pre></td></tr></table></figure>

<h3 id="创建数据迁移表"><a href="#创建数据迁移表" class="headerlink" title="创建数据迁移表"></a>创建数据迁移表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">migration</span>:generate --name=init-users</span><br></pre></td></tr></table></figure>

<p>1.执行完命令后，会在 database &#x2F; migrations &#x2F; 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="keyword">async</span> (queryInterface, <span class="title class_">Sequelize</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="comment">// 创建表</span></span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">createTable</span>(</span><br><span class="line">      <span class="string">&quot;users&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>).<span class="property">UNSIGNED</span>,</span><br><span class="line">          <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">username</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户名称&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">email</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">160</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户邮箱&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">avatar_url</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">mobile</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">20</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户手机&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">prifix</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">32</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">abstract</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">255</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">role_id</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">          <span class="comment">//  定义外键（重要）</span></span><br><span class="line">          <span class="attr">references</span>: &#123;</span><br><span class="line">            <span class="attr">model</span>: <span class="string">&quot;users&quot;</span>, <span class="comment">// 对应表名称（数据表名称）</span></span><br><span class="line">            <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>, <span class="comment">// 对应表的主键</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">          <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>, <span class="comment">// 删除时操作</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">gender</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="variable constant_">ENUM</span>,</span><br><span class="line">          <span class="attr">values</span>: [<span class="string">&quot;男&quot;</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;保密&quot;</span>],</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户性别&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">        <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; <span class="attr">engine</span>: <span class="string">&quot;MYISAM&quot;</span> &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 添加索引</span></span><br><span class="line">    queryInterface.<span class="title function_">addIndex</span>(<span class="string">&quot;users&quot;</span>, [<span class="string">&quot;gender&quot;</span>]);</span><br><span class="line">    <span class="comment">// 添加唯一索引</span></span><br><span class="line">    queryInterface.<span class="title function_">addIndex</span>(<span class="string">&quot;users&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>, <span class="comment">// 索引名称</span></span><br><span class="line">      <span class="attr">unique</span>: <span class="literal">true</span>, <span class="comment">// 唯一索引</span></span><br><span class="line">      <span class="attr">fields</span>: [<span class="string">&quot;name&quot;</span>], <span class="comment">// 索引对应字段</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="keyword">async</span> (queryInterface) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行 migrate 进行数据库变更</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级数据库</span></span><br><span class="line">npx sequelize db:migrate</span><br><span class="line"><span class="comment"># 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo</span></span><br><span class="line"><span class="comment"># 可以通过 `db:migrate:undo:all` 回退到初始状态</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo:all</span></span><br></pre></td></tr></table></figure>

<h3 id="已创建新增字段"><a href="#已创建新增字段" class="headerlink" title="已创建新增字段"></a>已创建新增字段</h3><p>1.创建迁移文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=user-addcolumn</span><br></pre></td></tr></table></figure>

<p>2.执行完命令后，会在 database &#x2F; migrations &#x2F; 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="property">sequelize</span>.<span class="title function_">transaction</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">        queryInterface.<span class="title function_">addColumn</span>(</span><br><span class="line">          <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="string">&quot;role_id&quot;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="property">INTEGER</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">transaction</span>: t &#125;</span><br><span class="line">        ),</span><br><span class="line">        queryInterface.<span class="title function_">addColumn</span>(</span><br><span class="line">          <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ceshi&quot;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">transaction</span>: t &#125;</span><br><span class="line">        ),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="property">sequelize</span>.<span class="title function_">transaction</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">        queryInterface.<span class="title function_">removeColumn</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;role_id&quot;</span>, &#123; <span class="attr">transaction</span>: t &#125;),</span><br><span class="line">        queryInterface.<span class="title function_">removeColumn</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;ceshi&quot;</span>, &#123; <span class="attr">transaction</span>: t &#125;),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>3.执行 migrate 进行数据库变更</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:migrate</span><br></pre></td></tr></table></figure>

<h3 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app / model / user.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line">  <span class="comment">// 配置（重要：一定要配置详细，一定要！！！）</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">    <span class="string">&quot;user&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">      <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">timestamps</span>: <span class="literal">true</span>, <span class="comment">// 是否自动写入时间戳</span></span><br><span class="line">      <span class="attr">tableName</span>: <span class="string">&quot;users&quot;</span>, <span class="comment">// 自定义数据表名称</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个 Model 就可以在 Controller 和 Service 中通过 <code>app.model.User</code> 或者 <code>ctx.model.User</code> 访问到了，例如我们编写 <code>app/controller/users.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/users.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Controller</span> = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>).<span class="property">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toInt</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> str === <span class="string">&quot;number&quot;</span>) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">if</span> (!str) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">parseInt</span>(str, <span class="number">10</span>) || <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> query = &#123;</span><br><span class="line">      <span class="attr">limit</span>: <span class="title function_">toInt</span>(ctx.<span class="property">query</span>.<span class="property">limit</span>),</span><br><span class="line">      <span class="attr">offset</span>: <span class="title function_">toInt</span>(ctx.<span class="property">query</span>.<span class="property">offset</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findAll</span>(query);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123; name, age &#125;);</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">201</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">update</span>(&#123; name, age &#125;);</span><br><span class="line">    ctx.<span class="property">body</span> = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">destroy</span>();</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">UserController</span>;</span><br></pre></td></tr></table></figure>

<p>最后我们将这个 controller 挂载到路由上：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">  router.<span class="title function_">resources</span>(<span class="string">&quot;users&quot;</span>, <span class="string">&quot;/users&quot;</span>, controller.<span class="property">users</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>针对 <code>users</code> 表的 CURD 操作的接口就开发完了</p>
<h3 id="模型其他参数"><a href="#模型其他参数" class="headerlink" title="模型其他参数"></a>模型其他参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置（重要）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">  <span class="string">&quot;user&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">    <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 自定义表名</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">tableName</span>: <span class="string">&quot;xyz_users&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否需要增加createdAt、updatedAt、deletedAt字段</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不需要createdAt字段</span></span><br><span class="line">    <span class="attr">createdAt</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将updatedAt字段改个名</span></span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;utime&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将deletedAt字段改名</span></span><br><span class="line">    <span class="comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span></span><br><span class="line">    <span class="attr">deletedAt</span>: <span class="string">&quot;dtime&quot;</span>,</span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="sequelize-命令"><a href="#sequelize-命令" class="headerlink" title="sequelize 命令"></a>sequelize 命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>sequelize db:migrate</td>
<td>运行迁移文件</td>
</tr>
<tr>
<td>sequelize db:migrate:status</td>
<td>列出所有迁移的状态</td>
</tr>
<tr>
<td>sequelize db:migrate:undo</td>
<td>隔离数据库：迁移：撤消</td>
</tr>
<tr>
<td>sequelize db:migrate:undo:all</td>
<td>还原所有运行的迁移</td>
</tr>
<tr>
<td>sequelize db:create</td>
<td>创建由配置指定的数据库</td>
</tr>
<tr>
<td>sequelize db:drop</td>
<td>删除由配置指定的数据库</td>
</tr>
</tbody></table>
<h3 id="外键约束（重要）"><a href="#外键约束（重要）" class="headerlink" title="外键约束（重要）"></a>外键约束（重要）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 迁移文件</span></span><br><span class="line">queryInterface.<span class="title function_">addConstraint</span>(<span class="string">&quot;tableName&quot;</span>, [<span class="string">&quot;user_id&quot;</span>], &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;foreign key&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;user_id&quot;</span>,</span><br><span class="line">  <span class="attr">references</span>: &#123;</span><br><span class="line">    <span class="comment">//Required field</span></span><br><span class="line">    <span class="attr">table</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">    <span class="attr">field</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">  <span class="attr">onUpdate</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="创建第一个种子"><a href="#创建第一个种子" class="headerlink" title="创建第一个种子"></a>创建第一个种子</h3><p>假设我们希望在默认情况下将一些数据插入到几个表中. 如果我们跟进前面的例子,我们可以考虑为 <code>User</code> 表创建演示用户.</p>
<p>要管理所有数据迁移,你可以使用 <code>seeders</code>. 种子文件是数据的一些变化,可用于使用样本数据或测试数据填充数据库表.</p>
<p>让我们创建一个种子文件,它会将一个演示用户添加到我们的 <code>User</code> 表中.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize seed:generate --name demo-user</span><br></pre></td></tr></table></figure>

<p>这个命令将会在 <code>seeders</code> 文件夹中创建一个种子文件.文件名看起来像是 <code>XXXXXXXXXXXXXX-demo-user.js</code>,它遵循相同的 <code>up/down</code> 语义,如迁移文件.</p>
<p>现在我们应该编辑这个文件,将演示用户插入<code>User</code>表.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">bulkInsert</span>(</span><br><span class="line">      <span class="string">&quot;Users&quot;</span>,</span><br><span class="line">      [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">firstName</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">          <span class="attr">lastName</span>: <span class="string">&quot;Doe&quot;</span>,</span><br><span class="line">          <span class="attr">email</span>: <span class="string">&quot;demo@demo.com&quot;</span>,</span><br><span class="line">          <span class="attr">createdAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">          <span class="attr">updatedAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">      &#123;&#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">bulkDelete</span>(<span class="string">&quot;Users&quot;</span>, <span class="literal">null</span>, &#123;&#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="运行种子"><a href="#运行种子" class="headerlink" title="运行种子"></a>运行种子</h3><p>在上一步中,你创建了一个种子文件. 但它还没有保存到数据库. 为此,我们需要运行一个简单的命令.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:all</span><br></pre></td></tr></table></figure>

<p>这将执行该种子文件,你将有一个演示用户插入 <code>User</code> 表.</p>
<p><strong>注意:</strong> _ <em><code>\_seeders_</code></em> 执行不会存储在任何使用 <em><code>_SequelizeMeta_</code></em> 表的迁移的地方. 如果你想覆盖这个,请阅读 <em><code>_存储_</code></em> 部分_</p>
<h3 id="撤销种子"><a href="#撤销种子" class="headerlink" title="撤销种子"></a>撤销种子</h3><p>Seeders 如果使用了任何存储那么就可以被撤消. 有两个可用的命令</p>
<p>如果你想撤消最近的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo</span><br></pre></td></tr></table></figure>

<p>如果你想撤消特定的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo --seed name-of-seed-as-in-data</span><br></pre></td></tr></table></figure>

<p>如果你想撤消所有的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo:all</span><br></pre></td></tr></table></figure>

<h2 id="关联操作"><a href="#关联操作" class="headerlink" title="关联操作"></a>关联操作</h2><h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>模型层：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个用户对应一个用户资料</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app/model/user.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;user&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">    <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联用户资料 一对一</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">hasOne</span>(app.<span class="property">model</span>.<span class="property">Userinfo</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/model/userinfo.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line">  <span class="keyword">const</span> userinfo = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">    <span class="string">&quot;userinfo&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">nickname</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">user_id</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 关联用户表</span></span><br><span class="line">  userinfo.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    app.<span class="property">model</span>.<span class="property">Userinfo</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> userinfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制器调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/users.js</span></span><br><span class="line"><span class="comment">// 显示单条</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根据主键查询 查询一条用findOne</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="comment">// 主表查询字段限制</span></span><br><span class="line">        <span class="attr">attributes</span>:[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">        <span class="comment">// 关联查询</span></span><br><span class="line">        <span class="attr">include</span>: [&#123;</span><br><span class="line">            <span class="comment">// 需要查询的模型</span></span><br><span class="line">            <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">Userinfo</span>,</span><br><span class="line">            <span class="comment">// 副表查询的字段</span></span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;nickname&#x27;</span>]</span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="comment">// 主表条件</span></span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">City</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">City</span>.<span class="title function_">init</span>(&#123; <span class="attr">countryCode</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;city&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Country</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Country</span>.<span class="title function_">init</span>(</span><br><span class="line">  &#123; <span class="attr">isoCode</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;,</span><br><span class="line">  &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;country&quot;</span> &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里,我们可以根据国家代码连接国家和城市</span></span><br><span class="line"><span class="title class_">Country</span>.<span class="title function_">hasMany</span>(<span class="title class_">City</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;countryCode&quot;</span>, <span class="attr">sourceKey</span>: <span class="string">&quot;isoCode&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">City</span>.<span class="title function_">belongsTo</span>(<span class="title class_">Country</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;countryCode&quot;</span>, <span class="attr">targetKey</span>: <span class="string">&quot;isoCode&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">belongsToMany</span>(<span class="title class_">Project</span>, &#123;</span><br><span class="line">  <span class="attr">as</span>: <span class="string">&quot;Tasks&quot;</span>,</span><br><span class="line">  <span class="attr">through</span>: <span class="string">&quot;worker_tasks&quot;</span>,</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;userId&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">belongsToMany</span>(<span class="title class_">User</span>, &#123;</span><br><span class="line">  <span class="attr">as</span>: <span class="string">&quot;Workers&quot;</span>,</span><br><span class="line">  <span class="attr">through</span>: <span class="string">&quot;worker_tasks&quot;</span>,</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;projectId&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="关联常用操作"><a href="#关联常用操作" class="headerlink" title="关联常用操作"></a>关联常用操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取关联模型对象，n对一不需要加s</span></span><br><span class="line"><span class="keyword">let</span> userinfo = <span class="keyword">await</span> user.<span class="title function_">getUserinfo</span>();</span><br><span class="line"><span class="comment">// n对多需要加s</span></span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;title&quot;</span>],</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 关联操作</span></span><br><span class="line"><span class="comment">// 1：用户创建文章（一对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&quot;第一篇文章&quot;</span>,</span><br><span class="line">  <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.获取当前用户所有文章</span></span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>();</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;id&quot;</span>],</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;测试&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3：用户删除文章（一对多）</span></span><br><span class="line"><span class="comment">// (1) 获取当前用户的所有文章</span></span><br><span class="line"><span class="keyword">let</span> posts = <span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;id&quot;</span>],</span><br><span class="line">&#125;);</span><br><span class="line">posts = posts.<span class="title function_">map</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="property">id</span>);</span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: posts,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景三：用户关注话题（多对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">bulkCreate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户关注话题（多对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="获取器和修改器"><a href="#获取器和修改器" class="headerlink" title="获取器和修改器"></a>获取器和修改器</h2><p>模型层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/model/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;user&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">      <span class="comment">// 单独字段的getter，查询时都会调用</span></span><br><span class="line">      <span class="comment">// this.getDataValue(&#x27;name&#x27;) 获取原始值</span></span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> age = <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;name&quot;</span>) + <span class="string">&quot;年龄：&quot;</span> + age;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="comment">// 单独字段的setter，新增和更新时调用</span></span><br><span class="line">      <span class="comment">// this.setDataValue(&#x27;name&#x27;) 设置原始值</span></span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setDataValue</span>(<span class="string">&quot;age&quot;</span>, val * <span class="number">10</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联用户资料</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">hasOne</span>(app.<span class="property">model</span>.<span class="property">Userinfo</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制器层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根据主键查询</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 获取原始值 user.getDataValue(&#x27;name&#x27;)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = user.<span class="title function_">getDataValue</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="模型钩子"><a href="#模型钩子" class="headerlink" title="模型钩子"></a>模型钩子</h2><p>模型层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 钩子</span></span><br><span class="line">    <span class="comment">// 查询前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeFind</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 查询后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterFind</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 新增前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeCreate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新增前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 新增后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterCreate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新增后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 修改前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeUpdate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;修改前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 修改后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterUpdate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;修改后&#x27;</span>); <span class="comment">// 真正修改才会触发，数据相同不会触发</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 删除前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 删除后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量删除前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeBulkDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;批量删除前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 批量删除后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterBulkDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;批量删除后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="主键查询"><a href="#主键查询" class="headerlink" title="主键查询"></a>主键查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findByPk</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="查找不存在则创建"><a href="#查找不存在则创建" class="headerlink" title="查找不存在则创建"></a>查找不存在则创建</h3><p>方法 <code>findOrCreate</code> 可用于检查数据库中是否已存在某个元素. 如果是这种情况,则该方法将生成相应的实例. 如果元素不存在,将会被创建.</p>
<p>如果是这种情况,则该方法将导致相应的实例. 如果元素不存在,将会被创建.</p>
<p>假设我们有一个空的数据库,一个 <code>User</code> 模型有一个 <code>username</code> 和 <code>job</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findOrCreate</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&quot;sdepold&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">defaults</span>: &#123;</span><br><span class="line">    <span class="attr">job</span>: <span class="string">&quot;Technical Lead JavaScript&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">[user, created]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    user.<span class="title function_">get</span>(&#123;</span><br><span class="line">      <span class="attr">plain</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(created);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    findOrCreate 返回一个包含已找到或创建的对象的数组,找到或创建的对象和一个布尔值,如果创建一个新对象将为true,否则为false,像这样:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [ &#123;</span></span><br><span class="line"><span class="comment">        username: &#x27;sdepold&#x27;,</span></span><br><span class="line"><span class="comment">        job: &#x27;Technical Lead JavaScript&#x27;,</span></span><br><span class="line"><span class="comment">        id: 1,</span></span><br><span class="line"><span class="comment">        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),</span></span><br><span class="line"><span class="comment">        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      true ]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">在上面的例子中,第三行的数组将分成2部分,并将它们作为参数传递给回调函数,在这种情况下将它们视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;true&quot;.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码创建了一个新的实例. 所以当我们已经有一个实例了 …</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">create</span>(&#123; <span class="attr">username</span>: <span class="string">&quot;fnord&quot;</span>, <span class="attr">job</span>: <span class="string">&quot;omnomnom&quot;</span> &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">findOrCreate</span>(&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;fnord&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">defaults</span>: &#123;</span><br><span class="line">        <span class="attr">job</span>: <span class="string">&quot;something else&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">[user, created]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">      user.<span class="title function_">get</span>(&#123;</span><br><span class="line">        <span class="attr">plain</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(created);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在这个例子中,findOrCreate 返回一个如下的数组:</span></span><br><span class="line"><span class="comment">    [ &#123;</span></span><br><span class="line"><span class="comment">        username: &#x27;fnord&#x27;,</span></span><br><span class="line"><span class="comment">        job: &#x27;omnomnom&#x27;,</span></span><br><span class="line"><span class="comment">        id: 2,</span></span><br><span class="line"><span class="comment">        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),</span></span><br><span class="line"><span class="comment">        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      false</span></span><br><span class="line"><span class="comment">    ]</span></span><br><span class="line"><span class="comment">    由findOrCreate返回的数组通过第三行的数组扩展为两部分,并且这些部分将作为2个参数传递给回调函数,在这种情况下将其视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;false&quot;.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>…现有条目将不会更改. 看到第二个用户的 “job”,并且实际上创建操作是假的.</p>
<h3 id="查找并计数"><a href="#查找并计数" class="headerlink" title="查找并计数"></a>查找并计数</h3><p><code>findAndCountAll</code> - 在数据库中搜索多个元素,返回数据和总计数</p>
<p>这是一个方便的方法,它结合了 <code>findAll</code> 和 <code>count</code>(见下文),当处理与分页相关的查询时,这是有用的,你想用 <code>limit</code> 和 <code>offset</code> 检索数据,但也需要知道总数与查询匹配的记录数:</p>
<p>处理程序成功将始终接收具有两个属性的对象:</p>
<ul>
<li><code>count</code> - 一个整数,总数记录匹配 where 语句和关联的其它过滤器</li>
<li><code>rows</code> - 一个数组对象,记录在 limit 和 offset 范围内匹配 where 语句和关联的其它过滤器,</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;foo%&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">offset</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">count</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">rows</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>它支持 include. 只有标记为 <code>required</code> 的 include 将被添加到计数部分:</p>
<p>假设你想查找附有个人资料的所有用户:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Profile</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;],</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">3</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>因为 <code>Profile</code> 的 include 有 <code>required</code> 设置,这将导致内部连接,并且只有具有 profile 的用户将被计数. 如果我们从 include 中删除<code>required</code>,那么有和没有 profile 的用户都将被计数. 在 include 中添加一个 <code>where</code> 语句会自动使它成为 required:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Profile</span>, <span class="attr">where</span>: &#123; <span class="attr">active</span>: <span class="literal">true</span> &#125; &#125;],</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">3</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的查询只会对具有 active profile 的用户进行计数,因为在将 where 语句添加到 include 时,<code>required</code> 被隐式设置为 true.</p>
<p>传递给 <code>findAndCountAll</code> 的 options 对象与 <code>findAll</code> 相同(如下所述).</p>
<h3 id="查询多个（常用）"><a href="#查询多个（常用）" class="headerlink" title="查询多个（常用）"></a>查询多个（常用）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到多个条目</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects 将是所有 Project 实例的数组</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索特定属性 - 使用哈希</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;A Project&quot;</span> &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects将是一个具有指定 name 的 Project 实例数组</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在特定范围内进行搜索</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects将是一系列具有 id 1,2 或 3 的项目</span></span><br><span class="line">  <span class="comment">// 这实际上是在做一个 IN 查询</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">and</span>]: &#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, <span class="comment">// 且 (a = 5)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">a</span>: <span class="number">6</span> &#125;], <span class="comment">// (a = 5 或 a = 6)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">6</span>, <span class="comment">// id &gt; 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gte</span>]: <span class="number">6</span>, <span class="comment">// id &gt;= 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">10</span>, <span class="comment">// id &lt; 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lte</span>]: <span class="number">10</span>, <span class="comment">// id &lt;= 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="number">20</span>, <span class="comment">// id != 20</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">between</span>]: [<span class="number">6</span>, <span class="number">10</span>], <span class="comment">// 在 6 和 10 之间</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notBetween</span>]: [<span class="number">11</span>, <span class="number">15</span>], <span class="comment">// 不在 11 和 15 之间</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">in</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// 在 [1, 2] 之中</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notIn</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// 不在 [1, 2] 之中</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 包含 &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notLike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 不包含 &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 包含 &#x27;%hat&#x27; (不区分大小写)  (仅限 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notILike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 不包含 &#x27;%hat&#x27;  (仅限 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// @&gt; [1, 2] (PG数组包含运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="number">2</span>, <span class="number">3</span>], <span class="comment">// 任何数组[2, 3]::INTEGER (仅限 PG)</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">status</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">not</span>]: <span class="literal">false</span>, <span class="comment">// status 不为 FALSE</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="复合过滤-x2F-OR-x2F-NOT-查询"><a href="#复合过滤-x2F-OR-x2F-NOT-查询" class="headerlink" title="复合过滤 &#x2F; OR &#x2F; NOT 查询"></a>复合过滤 &#x2F; OR &#x2F; NOT 查询</h3><p>你可以使用多层嵌套的 AND,OR 和 NOT 条件进行一个复合的 where 查询. 为了做到这一点,你可以使用 <code>or</code> , <code>and</code> 或 <code>not</code> <code>运算符</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;, &#123; <span class="attr">id</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">10</span> &#125; &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">10</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这两段代码将生成以下内容:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> *</span><br><span class="line"><span class="variable constant_">FROM</span> <span class="string">`Projects`</span></span><br><span class="line"><span class="variable constant_">WHERE</span> (</span><br><span class="line">  <span class="string">`Projects`</span>.<span class="string">`name`</span> = <span class="string">&#x27;a project&#x27;</span></span><br><span class="line">   <span class="variable constant_">AND</span> (<span class="string">`Projects`</span>.<span class="string">`id`</span> <span class="variable constant_">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>) <span class="variable constant_">OR</span> <span class="string">`Projects`</span>.<span class="string">`id`</span> &gt; <span class="number">10</span>)</span><br><span class="line">)</span><br><span class="line"><span class="variable constant_">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><code>not</code> 示例:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">not</span>]: [&#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;, &#123; <span class="attr">array</span>: &#123; [<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] &#125; &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将生成:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> *</span><br><span class="line"><span class="variable constant_">FROM</span> <span class="string">`Projects`</span></span><br><span class="line"><span class="variable constant_">WHERE</span> (</span><br><span class="line">  <span class="string">`Projects`</span>.<span class="string">`name`</span> = <span class="string">&#x27;a project&#x27;</span></span><br><span class="line">   <span class="variable constant_">AND</span> <span class="variable constant_">NOT</span> (<span class="string">`Projects`</span>.<span class="string">`id`</span> <span class="variable constant_">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>) <span class="variable constant_">OR</span> <span class="string">`Projects`</span>.<span class="string">`array`</span> @&gt; <span class="variable constant_">ARRAY</span>[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]::<span class="variable constant_">INTEGER</span>[])</span><br><span class="line">)</span><br><span class="line"><span class="variable constant_">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="用限制-偏移-顺序和分组操作数据集"><a href="#用限制-偏移-顺序和分组操作数据集" class="headerlink" title="用限制,偏移,顺序和分组操作数据集"></a>用限制,偏移,顺序和分组操作数据集</h3><p>要获取更多相关数据,可以使用限制,偏移,顺序和分组:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限制查询的结果</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">limit</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过前10个元素</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过前10个元素,并获取2个</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">10</span>, <span class="attr">limit</span>: <span class="number">2</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>分组和排序的语法是相同的,所以下面只用一个单独的例子来解释分组,而其余的则是排序. 你下面看到的所有内容也可以对分组进行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">order</span>: [[<span class="string">&quot;title&quot;</span>, <span class="string">&quot;DESC&quot;</span>]] &#125;);</span><br><span class="line"><span class="comment">// 生成 ORDER BY title DESC</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">group</span>: <span class="string">&quot;name&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// 生成 GROUP BY name</span></span><br></pre></td></tr></table></figure>

<p>请注意,在上述两个示例中,提供的字符串逐字插入到查询中,所以不会转义列名称. 当你向 order &#x2F; group 提供字符串时,将始终如此. 如果要转义列名,你应该提供一个参数数组,即使你只想通过单个列进行 order &#x2F; group</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">something.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">order</span>: [</span><br><span class="line">    <span class="comment">// 将返回 `name`</span></span><br><span class="line">    [<span class="string">&quot;name&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 `username` DESC</span></span><br><span class="line">    [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;DESC&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 max(`age`)</span></span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&quot;max&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;age&quot;</span>)),</span><br><span class="line">    <span class="comment">// 将返回 max(`age`) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&quot;max&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;age&quot;</span>)), <span class="string">&quot;DESC&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 otherfunction(`col1`, 12, &#x27;lalala&#x27;) DESC</span></span><br><span class="line">    [</span><br><span class="line">      sequelize.<span class="title function_">fn</span>(<span class="string">&quot;otherfunction&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;col1&quot;</span>), <span class="number">12</span>, <span class="string">&quot;lalala&quot;</span>),</span><br><span class="line">      <span class="string">&quot;DESC&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// 将返回 otherfunction(awesomefunction(`col`)) DESC,这个嵌套是可以无限的！</span></span><br><span class="line">    [</span><br><span class="line">      sequelize.<span class="title function_">fn</span>(</span><br><span class="line">        <span class="string">&quot;otherfunction&quot;</span>,</span><br><span class="line">        sequelize.<span class="title function_">fn</span>(<span class="string">&quot;awesomefunction&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;col&quot;</span>))</span><br><span class="line">      ),</span><br><span class="line">      <span class="string">&quot;DESC&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>回顾一下,order &#x2F; group 数组的元素可以是以下内容:</p>
<ul>
<li>String - 将被引用</li>
<li>Array - 第一个元素将被引用,第二个将被逐字地追加</li>
<li>Object -<ul>
<li>raw 将被添加逐字引用</li>
<li>如果未设置 raw,一切都被忽略,查询将失败</li>
</ul>
</li>
<li>Sequelize.fn 和 Sequelize.col 返回函数和引用的列名</li>
</ul>
<h3 id="字段过滤"><a href="#字段过滤" class="headerlink" title="字段过滤"></a>字段过滤</h3><p>想要只选择某些属性,可以使用 <code>attributes</code> 选项. 通常是传递一个数组:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT foo, bar …</p>
</blockquote>
<p>属性可以使用嵌套数组来重命名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;foo&quot;</span>, [<span class="string">&quot;bar&quot;</span>, <span class="string">&quot;baz&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT foo, bar AS baz …</p>
</blockquote>
<p>也可以使用 <code>sequelize.fn</code> 来进行聚合:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [[sequelize.<span class="title function_">fn</span>(<span class="string">&quot;COUNT&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;hats&quot;</span>)), <span class="string">&quot;no_hats&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT COUNT(hats) AS no_hats …</p>
</blockquote>
<p>使用聚合功能时,必须给它一个别名,以便能够从模型中访问它. 在上面的例子中,你可以使用 <code>instance.get(&#39;no_hats&#39;)</code> 获得帽子数量.</p>
<p>有时,如果你只想添加聚合,则列出模型的所有属性可能令人厌烦:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is a tiresome way of getting the number of hats...</span></span><br><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>, <span class="string">&#x27;baz&#x27;</span>, <span class="string">&#x27;quz&#x27;</span>, [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;COUNT&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;hats&#x27;</span>)), <span class="string">&#x27;no_hats&#x27;</span>]]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is shorter, and less error prone because it still works if you add / remove attributes</span></span><br><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: &#123; <span class="attr">include</span>: [[sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;COUNT&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;hats&#x27;</span>)), <span class="string">&#x27;no_hats&#x27;</span>]] &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable constant_">SELECT</span> id, foo, bar, baz, quz, <span class="title function_">COUNT</span>(hats) <span class="variable constant_">AS</span> no_hats ...</span><br></pre></td></tr></table></figure>

<p>同样,它也可以排除一些指定的表字段:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: &#123; <span class="attr">exclude</span>: [<span class="string">&#x27;baz&#x27;</span>] &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable constant_">SELECT</span> id, foo, bar, quz ...</span><br></pre></td></tr></table></figure>

<h3 id="Where"><a href="#Where" class="headerlink" title="Where"></a>Where</h3><p>无论你是通过 findAll&#x2F;find 或批量 updates&#x2F;destroys 进行查询,都可以传递一个 <code>where</code> 对象来过滤查询.</p>
<p><code>where</code> 通常用 attribute:value 键值对获取一个对象,其中 value 可以是匹配等式的数据或其他运算符的键值对象.</p>
<p>也可以通过嵌套 <code>or</code> 和 <code>and</code> <code>运算符</code> 的集合来生成复杂的 AND&#x2F;OR 条件.</p>
<h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Op</span> = <span class="title class_">Sequelize</span>.<span class="property">Op</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 2</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;active&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 AND status = &#x27;active&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">authorId</span>: <span class="number">12</span> &#125;, &#123; <span class="attr">authorId</span>: <span class="number">13</span> &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [<span class="number">12</span>, <span class="number">13</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;inactive&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// DELETE FROM post WHERE status = &#x27;inactive&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">update</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">deletedAt</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// UPDATE post SET updatedAt = null WHERE deletedAt NOT NULL;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: sequelize.<span class="title function_">where</span>(</span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&quot;char_length&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;status&quot;</span>)),</span><br><span class="line">    <span class="number">6</span></span><br><span class="line">  ),</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE char_length(status) = 6;</span></span><br></pre></td></tr></table></figure>

<h4 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h4><p>Sequelize 可用于创建更复杂比较的符号运算符 -</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Op</span> = <span class="title class_">Sequelize</span>.<span class="property">Op</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">and</span>]: &#123;<span class="attr">a</span>: <span class="number">5</span>&#125;           <span class="comment">// 且 (a = 5)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123;<span class="attr">a</span>: <span class="number">5</span>&#125;, &#123;<span class="attr">a</span>: <span class="number">6</span>&#125;]  <span class="comment">// (a = 5 或 a = 6)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">6</span>,                <span class="comment">// id &gt; 6</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">gte</span>]: <span class="number">6</span>,               <span class="comment">// id &gt;= 6</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">10</span>,               <span class="comment">// id &lt; 10</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">lte</span>]: <span class="number">10</span>,              <span class="comment">// id &lt;= 10</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="number">20</span>,               <span class="comment">// id != 20</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">eq</span>]: <span class="number">3</span>,                <span class="comment">// = 3</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">not</span>]: <span class="literal">true</span>,            <span class="comment">// 不是 TRUE</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">between</span>]: [<span class="number">6</span>, <span class="number">10</span>],     <span class="comment">// 在 6 和 10 之间</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notBetween</span>]: [<span class="number">11</span>, <span class="number">15</span>], <span class="comment">// 不在 11 和 15 之间</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">in</span>]: [<span class="number">1</span>, <span class="number">2</span>],           <span class="comment">// 在 [1, 2] 之中</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notIn</span>]: [<span class="number">1</span>, <span class="number">2</span>],        <span class="comment">// 不在 [1, 2] 之中</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;%hat&#x27;</span>,         <span class="comment">// 包含 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notLike</span>]: <span class="string">&#x27;%hat&#x27;</span>       <span class="comment">// 不包含 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&#x27;%hat&#x27;</span>         <span class="comment">// 包含 &#x27;%hat&#x27; (不区分大小写)  (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notILike</span>]: <span class="string">&#x27;%hat&#x27;</span>      <span class="comment">// 不包含 &#x27;%hat&#x27;  (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">startsWith</span>]: <span class="string">&#x27;hat&#x27;</span>     <span class="comment">// 类似 &#x27;hat%&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">endsWith</span>]: <span class="string">&#x27;hat&#x27;</span>       <span class="comment">// 类似 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">substring</span>]: <span class="string">&#x27;hat&#x27;</span>      <span class="comment">// 类似 &#x27;%hat%&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">regexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>    <span class="comment">// 匹配正则表达式/~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span> <span class="comment">// 不匹配正则表达式/!~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">iRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>    <span class="comment">// ~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notIRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span> <span class="comment">// !~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">like</span>]: &#123; [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;hat&#x27;</span>]&#125; <span class="comment">// 包含任何数组[&#x27;cat&#x27;, &#x27;hat&#x27;] - 同样适用于 iLike 和 notLike</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>]       <span class="comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// @&gt; [1, 2] (PG数组包含运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>]     <span class="comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="number">2</span>,<span class="number">3</span>]            <span class="comment">// 任何数组[2, 3]::INTEGER (仅限PG)</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">col</span>]: <span class="string">&#x27;user.organization_id&#x27;</span> <span class="comment">// = &#x27;user&#x27;.&#x27;organization_id&#x27;, 使用数据库语言特定的列标识符, 本例使用 PG</span></span><br></pre></td></tr></table></figure>

<h4 id="范围选项"><a href="#范围选项" class="headerlink" title="范围选项"></a>范围选项</h4><p>所有操作符都支持支持的范围类型查询.</p>
<p>请记住,提供的范围值也可以<a target="_blank" rel="noopener" href="https://itfun.tv/documents/266#range-types">定义绑定的 inclusion&#x2F;exclusion</a>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有上述相等和不相等的操作符加上以下内容:</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: <span class="number">2</span>           <span class="comment">// @&gt; &#x27;2&#x27;::integer (PG range contains element operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// @&gt; [1, 2) (PG range contains range operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>]     <span class="comment">// &lt;@ [1, 2) (PG range is contained by operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>]       <span class="comment">// &amp;&amp; [1, 2) (PG range overlap (have points in common) operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">adjacent</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// -|- [1, 2) (PG range is adjacent to operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">strictLeft</span>]: [<span class="number">1</span>, <span class="number">2</span>]    <span class="comment">// &lt;&lt; [1, 2) (PG range strictly left of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">strictRight</span>]: [<span class="number">1</span>, <span class="number">2</span>]   <span class="comment">// &gt;&gt; [1, 2) (PG range strictly right of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">noExtendRight</span>]: [<span class="number">1</span>, <span class="number">2</span>] <span class="comment">// &amp;&lt; [1, 2) (PG range does not extend to the right of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">noExtendLeft</span>]: [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment">// &amp;&gt; [1, 2) (PG range does not extend to the left of operator)</span></span><br></pre></td></tr></table></figure>

<h4 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">rank</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">1000</span>,</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">eq</span>]: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// rank &lt; 1000 OR rank IS NULL</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">createdAt</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>() - <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// createdAt &lt; [timestamp] AND createdAt &gt; [timestamp]</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="title class_">Op</span>.<span class="property">or</span>]: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;Boat%&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">description</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;%boat%&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// title LIKE &#x27;Boat%&#x27; OR description LIKE &#x27;%boat%&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="关系-x2F-关联"><a href="#关系-x2F-关联" class="headerlink" title="关系 &#x2F; 关联"></a>关系 &#x2F; 关联</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到所有具有至少一个 task 的  project,其中 task.state === project.state</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Task</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">state</span>: <span class="title class_">Sequelize</span>.<span class="title function_">col</span>(<span class="string">&quot;project.state&quot;</span>) &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="分页-x2F-限制"><a href="#分页-x2F-限制" class="headerlink" title="分页 &#x2F; 限制"></a>分页 &#x2F; 限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取10个实例/行</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">limit</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过8个实例/行</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">8</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过5个实例,然后取5个</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">5</span>, <span class="attr">limit</span>: <span class="number">5</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p><code>order</code> 需要一个条目的数组来排序查询或者一个 sequelize 方法.一般来说,你将要使用任一属性的 tuple&#x2F;array,并确定排序的正反方向.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Subtask</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">order</span>: [</span><br><span class="line">    <span class="comment">// 将转义标题,并根据有效的方向参数列表验证DESC</span></span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按最大值排序(age)</span></span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按最大顺序(age) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)), <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按 otherfunction 排序(`col1`, 12, &#x27;lalala&#x27;) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;otherfunction&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;col1&#x27;</span>), <span class="number">12</span>, <span class="string">&#x27;lalala&#x27;</span>), <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将使用模型名称作为关联的名称排序关联模型的 created_at.</span></span><br><span class="line">    [<span class="title class_">Task</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order through an associated model&#x27;s created_at using the model names as the associations&#x27; names.</span></span><br><span class="line">    [<span class="title class_">Task</span>, <span class="title class_">Project</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将使用关联的名称由关联模型的created_at排序.</span></span><br><span class="line">    [<span class="string">&#x27;Task&#x27;</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by a nested associated model&#x27;s created_at using the names of the associations.</span></span><br><span class="line">    [<span class="string">&#x27;Task&#x27;</span>, <span class="string">&#x27;Project&#x27;</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by an associated model&#x27;s created_at using an association object. (优选方法)</span></span><br><span class="line">    [<span class="title class_">Subtask</span>.<span class="property">associations</span>.<span class="property">Task</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by a nested associated model&#x27;s created_at using association objects. (优选方法)</span></span><br><span class="line">    [<span class="title class_">Subtask</span>.<span class="property">associations</span>.<span class="property">Task</span>, <span class="title class_">Task</span>.<span class="property">associations</span>.<span class="property">Project</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by an associated model&#x27;s created_at using a simple association object.</span></span><br><span class="line">    [&#123;<span class="attr">model</span>: <span class="title class_">Task</span>, <span class="attr">as</span>: <span class="string">&#x27;Task&#x27;</span>&#125;, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 嵌套关联模型的 created_at 简单关联对象排序</span></span><br><span class="line">    [&#123;<span class="attr">model</span>: <span class="title class_">Task</span>, <span class="attr">as</span>: <span class="string">&#x27;Task&#x27;</span>&#125;, &#123;<span class="attr">model</span>: <span class="title class_">Project</span>, <span class="attr">as</span>: <span class="string">&#x27;Project&#x27;</span>&#125;, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将按年龄最大值降序排列</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">literal</span>(<span class="string">&#x27;max(age) DESC&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按最年龄大值升序排列,当省略排序条件时默认是升序排列</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按升序排列是省略排序条件的默认顺序</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将根据方言随机排序 (而不是 fn(&#x27;RAND&#x27;) 或 fn(&#x27;RANDOM&#x27;))</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">random</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="count-计算数据库中元素的出现次数"><a href="#count-计算数据库中元素的出现次数" class="headerlink" title="count - 计算数据库中元素的出现次数"></a><code>count</code> - 计算数据库中元素的出现次数</h3><p>还有一种数据库对象计数的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">count</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;There are &quot;</span> + c + <span class="string">&quot; projects!&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">count</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">25</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;There are &quot;</span> + c + <span class="string">&quot; projects with an id greater than 25.&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="max-获取特定表中特定属性的最大值"><a href="#max-获取特定表中特定属性的最大值" class="headerlink" title="max - 获取特定表中特定属性的最大值"></a><code>max</code> - 获取特定表中特定属性的最大值</h3><p>这里是获取属性的最大值的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">max</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">max</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 40</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">max</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">20</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">max</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 10</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="min-获取特定表中特定属性的最小值"><a href="#min-获取特定表中特定属性的最小值" class="headerlink" title="min - 获取特定表中特定属性的最小值"></a><code>min</code> - 获取特定表中特定属性的最小值</h3><p>这里是获取属性的最小值的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">min</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">min</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 5</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">min</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">5</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">min</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 10</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="sum-特定属性的值求和"><a href="#sum-特定属性的值求和" class="headerlink" title="sum - 特定属性的值求和"></a><code>sum</code> - 特定属性的值求和</h3><p>为了计算表的特定列的总和,可以使用“sum”方法.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">sum</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">sum</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 55</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">sum</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">5</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">sum</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 50</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="预加载"><a href="#预加载" class="headerlink" title="预加载"></a>预加载</h2><p>当你从数据库检索数据时,也想同时获得与之相关联的查询,这被称为预加载.这个基本思路就是当你调用 <code>find</code> 或 <code>findAll</code> 时使用 <code>include</code> 属性.让我们假设以下设置:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;user&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Task</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;task&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Tool</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;tool&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Task</span>.<span class="title function_">belongsTo</span>(<span class="title class_">User</span>);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Task</span>);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Tool</span>, &#123; <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">sequelize.<span class="title function_">sync</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这是我们继续的地方 ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>首先,让我们用它们的关联 user 加载所有的 task.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Task</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">User</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">tasks</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(tasks));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;A Task&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;</span></span><br><span class="line"><span class="comment">      &#125;</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请注意,访问者(结果实例中的 <code>User</code> 属性)是单数形式,因为关联是一对一的.</p>
<p>接下来的事情:用多对一的关联加载数据！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Task</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;tasks&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;A Task&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请注意,访问者(结果实例中的 <code>Tasks</code> 属性)是复数形式,因为关联是多对一的.</p>
<p>如果关联是别名的(使用 <code>as</code> 参数),则在包含模型时必须指定此别名. 注意用户的 <code>Tool</code> 如何被别名为 <code>Instruments</code>. 为了获得正确的权限,你必须指定要加载的模型以及别名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Tool</span>, <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span> &#125;] &#125;).<span class="title function_">then</span>(</span><br><span class="line">  <span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>你还可以通过指定与关联别名匹配的字符串来包含别名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="string">&quot;Instruments&quot;</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">association</span>: <span class="string">&quot;Instruments&quot;</span> &#125;] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当预加载时,我们也可以使用 <code>where</code> 过滤关联的模型. 这将返回 <code>Tool</code> 模型中所有与 <code>where</code> 语句匹配的行的<code>User</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">name</span>: &#123; [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%ooth%&quot;</span> &#125; &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Smith&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 2,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当使用 <code>include.where</code> 过滤一个预加载的模型时,<code>include.required</code> 被隐式设置为 <code>true</code>. 这意味着内部联接完成返回具有任何匹配子项的父模型.</p>
<h3 id="使用预加载模型的顶层-WHERE"><a href="#使用预加载模型的顶层-WHERE" class="headerlink" title="使用预加载模型的顶层 WHERE"></a>使用预加载模型的顶层 WHERE</h3><p>将模型的 <code>WHERE</code> 条件从 <code>ON</code> 条件的 include 模式移动到顶层,你可以使用 <code>&#39;$nested.column$&#39;</code> 语法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;$Instruments.name$&#x27;</span>: &#123; [<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&#x27;%ooth%&#x27;</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">        <span class="attr">as</span>: <span class="string">&#x27;Instruments&#x27;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Smith&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 2,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment">    */</span></span><br></pre></td></tr></table></figure>

<h3 id="包括所有"><a href="#包括所有" class="headerlink" title="包括所有"></a>包括所有</h3><p>要包含所有属性,你可以使用 <code>all:true</code> 传递单个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">all</span>: <span class="literal">true</span> &#125;] &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="包括软删除的记录"><a href="#包括软删除的记录" class="headerlink" title="包括软删除的记录"></a>包括软删除的记录</h3><p>如果想要加载软删除的记录,可以通过将 <code>include.paranoid</code> 设置为 <code>false</code> 来实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">name</span>: &#123; [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%ooth%&quot;</span> &#125; &#125;,</span><br><span class="line">      <span class="attr">paranoid</span>: <span class="literal">false</span>, <span class="comment">// query and loads the soft deleted records</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="排序预加载关联"><a href="#排序预加载关联" class="headerlink" title="排序预加载关联"></a>排序预加载关联</h3><p>在一对多关系的情况下.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Division</span>], <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="string">&quot;name&quot;</span>]] &#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Division</span>], <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;DESC&quot;</span>]] &#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;DESC&quot;</span>]],</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">include</span>: [<span class="title class_">Department</span>] &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="title class_">Department</span>, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在多对多关系的情况下,你还可以通过表中的属性进行排序.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">include</span>: [<span class="title class_">Department</span>] &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="title class_">DepartmentDivision</span>, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="嵌套预加载"><a href="#嵌套预加载" class="headerlink" title="嵌套预加载"></a>嵌套预加载</h3><p>你可以使用嵌套的预加载来加载相关模型的所有相关模型:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="title class_">Teacher</span>,</span><br><span class="line">          <span class="attr">include</span>: [</span><br><span class="line">            <span class="comment">/* etc */</span></span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123; // 1:M and N:M association</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;Teacher&quot;: &#123; // 1:1 association</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Jimi Hendrix&quot;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这将产生一个外连接. 但是,相关模型上的 <code>where</code> 语句将创建一个内部连接,并仅返回具有匹配子模型的实例. 要返回所有父实例,你应该添加 <code>required: false</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="title class_">Teacher</span>,</span><br><span class="line">          <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">school</span>: <span class="string">&quot;Woodstock Music School&quot;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">required</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上查询将返回所有用户及其所有乐器,但只会返回与 <code>Woodstock Music School</code> 相关的老师.</p>
<p>包括所有也支持嵌套加载:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">all</span>: <span class="literal">true</span>, <span class="attr">nested</span>: <span class="literal">true</span> &#125;] &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h2><h3 id="字段限制"><a href="#字段限制" class="headerlink" title="字段限制"></a>字段限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(</span><br><span class="line">  &#123; <span class="attr">username</span>: <span class="string">&quot;barfooz&quot;</span>, <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">fields</span>: [<span class="string">&quot;username&quot;</span>] &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 只有username有效</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">bulkCreate</span>([&#123; <span class="attr">username</span>: <span class="string">&quot;foo&quot;</span> &#125;, &#123; <span class="attr">username</span>: <span class="string">&quot;bar&quot;</span>, <span class="attr">admin</span>: <span class="literal">true</span> &#125;], &#123;</span><br><span class="line">  <span class="attr">fields</span>: [<span class="string">&quot;username&quot;</span>],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// admin 将不会被构建</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="新增单个"><a href="#新增单个" class="headerlink" title="新增单个"></a>新增单个</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;哈哈哈&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">12</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量新增"><a href="#批量新增" class="headerlink" title="批量新增"></a>批量新增</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量新增 bulkCreate</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">bulkCreate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第一个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第二个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第三个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><h3 id="字段限制-1"><a href="#字段限制-1" class="headerlink" title="字段限制"></a>字段限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task.<span class="property">title</span> = <span class="string">&quot;foooo&quot;</span>;</span><br><span class="line">task.<span class="property">description</span> = <span class="string">&quot;baaaaaar&quot;</span>;</span><br><span class="line"><span class="keyword">await</span> task.<span class="title function_">save</span>(&#123; <span class="attr">fields</span>: [<span class="string">&quot;title&quot;</span>] &#125;);</span><br><span class="line"><span class="comment">// title 现在将是 “foooo”,而 description 与以前一样</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用等效的 update 调用如下所示:</span></span><br><span class="line"><span class="keyword">await</span> task.<span class="title function_">update</span>(</span><br><span class="line">  &#123; <span class="attr">title</span>: <span class="string">&quot;foooo&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;baaaaaar&quot;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">fields</span>: [<span class="string">&quot;title&quot;</span>] &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">//  title 现在将是 “foooo”,而 description 与以前一样</span></span><br></pre></td></tr></table></figure>

<h3 id="单个修改"><a href="#单个修改" class="headerlink" title="单个修改"></a>单个修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">update</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;我被修改了&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">30</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量修改"><a href="#批量修改" class="headerlink" title="批量修改"></a>批量修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量修改</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">update</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;批量修改&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 条件</span></span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;第一个&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="递增"><a href="#递增" class="headerlink" title="递增"></a>递增</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录 increment</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> user.<span class="title function_">increment</span>(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">3</span>, <span class="comment">// age每次递增3</span></span><br><span class="line">  <span class="attr">other</span>: <span class="number">2</span>, <span class="comment">// other每次递增2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="递减"><a href="#递减" class="headerlink" title="递减"></a>递减</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录 decrement</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> user.<span class="title function_">decrement</span>(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">3</span>, <span class="comment">// age每次递减3</span></span><br><span class="line">  <span class="attr">other</span>: <span class="number">2</span>, <span class="comment">// other每次递减2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><h3 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h3><p>模型中配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置（重要）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">  <span class="string">&quot;user&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* bla */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="查询包括软删除内容"><a href="#查询包括软删除内容" class="headerlink" title="查询包括软删除内容"></a>查询包括软删除内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: &#123;</span><br><span class="line">    <span class="attr">model</span>: ctx.<span class="property">model</span>.<span class="property">Video</span>,</span><br><span class="line">    <span class="comment">// 包括软删除</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">33</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 包括软删除</span></span><br><span class="line">  <span class="attr">paranoid</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="彻底删除"><a href="#彻底删除" class="headerlink" title="彻底删除"></a>彻底删除</h3><p>如果 <code>paranoid</code> 选项为 true,则不会删除该对象,而将 <code>deletedAt</code> 列设置为当前时间戳. 要强制删除,可以将 <code>force: true</code> 传递给 destroy 调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task.<span class="title function_">destroy</span>(&#123; <span class="attr">force</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>在 <code>paranoid</code> 模式下对象被软删除后,在强制删除旧实例之前,你将无法使用相同的主键创建新实例.</p>
<h3 id="恢复软删除的实例"><a href="#恢复软删除的实例" class="headerlink" title="恢复软删除的实例"></a>恢复软删除的实例</h3><p>如果你使用 <code>paranoid:true</code> 软删除了模型的实例,之后想要撤消删除,请使用 <code>restore</code> 方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行软删除...</span></span><br><span class="line">task.<span class="title function_">destroy</span>();</span><br><span class="line"><span class="comment">// 恢复软删除...</span></span><br><span class="line">task.<span class="title function_">restore</span>();</span><br></pre></td></tr></table></figure>

<h3 id="条件删除"><a href="#条件删除" class="headerlink" title="条件删除"></a>条件删除</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;批量修改&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: posts,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="重载实例"><a href="#重载实例" class="headerlink" title="重载实例"></a>重载实例</h2><p>如果你需要让你的实例同步,你可以使用 <code>reload</code> 方法. 它将从数据库中获取当前数据,并覆盖调用该方法的模型的属性.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Person</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;john&quot;</span> &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">person</span>) =&gt;</span> &#123;</span><br><span class="line">  person.<span class="property">name</span> = <span class="string">&quot;jane&quot;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>); <span class="comment">// &#x27;jane&#x27;</span></span><br><span class="line"></span><br><span class="line">  person.<span class="title function_">reload</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>); <span class="comment">// &#x27;john&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="模型自定义方法"><a href="#模型自定义方法" class="headerlink" title="模型自定义方法"></a>模型自定义方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型</span></span><br><span class="line"><span class="comment">// 模型自定义方法</span></span><br><span class="line">topic_user.<span class="property">ceshi</span> = <span class="function">(<span class="params">param</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;模型自定义方法&quot;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(param);</span><br><span class="line">  <span class="keyword">return</span> param;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制器</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">ceshi</span>(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Scopes-作用域（重点）"><a href="#Scopes-作用域（重点）" class="headerlink" title="Scopes - 作用域（重点）"></a>Scopes - 作用域（重点）</h2><p>作用域允许你定义常用查询,以便以后轻松使用. 作用域可以包括与常规查找器 <code>where</code>, <code>include</code>, <code>limit</code> 等所有相同的属性.</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>作用域在模型定义中定义,可以是 finder 对象或返回 finder 对象的函数,除了默认作用域,该作用域只能是一个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Project</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">  <span class="comment">// 属性</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">defaultScope</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scopes</span>: &#123;</span><br><span class="line">    <span class="attr">deleted</span>: &#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">deleted</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">activeUsers</span>: &#123;</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123; <span class="attr">model</span>: <span class="title class_">User</span>, <span class="attr">where</span>: &#123; <span class="attr">active</span>: <span class="literal">true</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    random () &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">          <span class="attr">someNumber</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    accessLevel (value) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">          <span class="attr">accessLevel</span>: &#123;</span><br><span class="line">            [<span class="title class_">Op</span>.<span class="property">gte</span>]: value</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sequelize,</span><br><span class="line">    <span class="attr">modelName</span>: <span class="string">&#x27;project&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过调用 <code>addScope</code> 定义模型后,还可以添加作用域. 这对于具有包含的作用域特别有用,其中在定义其他模型时可能不会定义 include 中的模型.</p>
<p>始终应用默认作用域. 这意味着,通过上面的模型定义,<code>Project.findAll()</code> 将创建以下查询:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> active = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>可以通过调用 <code>.unscoped()</code>, <code>.scope(null)</code> 或通过调用另一个作用域来删除默认作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>(); <span class="comment">// 删除默认作用域</span></span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> deleted = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>还可以在作用域定义中包含作用域模型. 这让你避免重复 <code>include</code>,<code>attributes</code> 或 <code>where</code> 定义.</p>
<p>使用上面的例子,并在包含的用户模型中调用 <code>active</code> 作用域(而不是直接在该 include 对象中指定条件):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">activeUsers</span>: &#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">User</span>.<span class="title function_">scope</span>(<span class="string">&quot;active&quot;</span>) &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>通过在模型定义上调用 <code>.scope</code> 来应用作用域,传递一个或多个作用域的名称. <code>.scope</code> 返回一个全功能的模型实例,它具有所有常规的方法:<code>.findAll</code>,<code>.update</code>,<code>.count</code>,<code>.destroy</code>等等.你可以保存这个模型实例并稍后再次使用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">DeletedProjects</span> = <span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&quot;deleted&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">DeletedProjects</span>.<span class="title function_">findAll</span>();</span><br><span class="line"><span class="comment">// 过一段时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 让我们再次寻找被删除的项目！</span></span><br><span class="line"><span class="title class_">DeletedProjects</span>.<span class="title function_">findAll</span>();</span><br></pre></td></tr></table></figure>

<p>作用域适用于 <code>.find</code>, <code>.findAll</code>, <code>.count</code>, <code>.update</code>, <code>.increment</code> 和 <code>.destroy</code>.</p>
<p>可以通过两种方式调用作为函数的作用域. 如果作用域没有任何参数,它可以正常调用. 如果作用域采用参数,则传递一个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;random&#x27;</span>, &#123; <span class="attr">method</span>: [<span class="string">&#x27;accessLevel&#x27;</span>, <span class="number">19</span>]&#125;).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> someNumber = <span class="number">42</span> <span class="variable constant_">AND</span> accessLevel &gt;= <span class="number">19</span></span><br></pre></td></tr></table></figure>

<h3 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h3><p>通过将作用域数组传递到 <code>.scope</code> 或通过将作用域作为连续参数传递,可以同时应用多个作用域.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这两个是等价的</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>, <span class="string">&#x27;activeUsers&#x27;</span>).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>([<span class="string">&#x27;deleted&#x27;</span>, <span class="string">&#x27;activeUsers&#x27;</span>]).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects</span><br><span class="line"><span class="variable constant_">INNER</span> <span class="variable constant_">JOIN</span> users <span class="variable constant_">ON</span> projects.<span class="property">userId</span> = users.<span class="property">id</span></span><br><span class="line"><span class="variable constant_">WHERE</span> projects.<span class="property">deleted</span> = <span class="literal">true</span></span><br><span class="line"><span class="variable constant_">AND</span> users.<span class="property">active</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>如果要将其他作用域与默认作用域一起应用,请将键 <code>defaultScope</code> 传递给 <code>.scope</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;defaultScope&#x27;</span>, <span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> active = <span class="literal">true</span> <span class="variable constant_">AND</span> deleted = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>当调用多个作用域时,后续作用域的键将覆盖以前的作用域(类似于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a>),除了<code>where</code>和<code>include</code>,它们将被合并. 考虑两个作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">scope1</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">firstName</span>: <span class="string">&#x27;bob&#x27;</span>,</span><br><span class="line">      <span class="attr">age</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scope2</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">age</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">30</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">10</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <code>.scope(&#39;scope1&#39;, &#39;scope2&#39;)</code> 将产生以下查询</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">WHERE</span> firstName = <span class="string">&#x27;bob&#x27;</span> <span class="variable constant_">AND</span> age &gt; <span class="number">30</span> <span class="variable constant_">LIMIT</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>注意 <code>scope2</code> 将覆盖 <code>limit</code> 和 <code>age</code>,而 <code>firstName</code> 被保留. <code>limit</code>,<code>offset</code>,<code>order</code>,<code>paranoid</code>,<code>lock</code>和<code>raw</code>字段被覆盖,而<code>where</code>被浅层合并(意味着相同的键将被覆盖). <code>include</code> 的合并策略将在后面讨论.</p>
<p>请注意,多个应用作用域的 <code>attributes</code> 键以这样的方式合并,即始终保留 <code>attributes.exclude</code>. 这允许合并多个作用域,并且永远不会泄漏最终作用域内的敏感字段.</p>
<p>将查找对象直接传递给作用域模型上的<code>findAll</code>(和类似的查找程序)时,适用相同的合并逻辑:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">firstName</span>: <span class="string">&#x27;john&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable constant_">WHERE</span> deleted = <span class="literal">true</span> <span class="variable constant_">AND</span> firstName = <span class="string">&#x27;john&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里的 <code>deleted</code> 作用域与 finder 合并. 如果我们要将 <code>where: &#123; firstName: &#39;john&#39;, deleted: false &#125;</code> 传递给 finder,那么 <code>deleted</code> 作用域将被覆盖.</p>
<h4 id="合并-include"><a href="#合并-include" class="headerlink" title="合并 include"></a>合并 include</h4><p>Include 是根据包含的模型递归合并的. 这是一个非常强大的合并,在 v5 上添加,并通过示例更好地理解.</p>
<p>考虑四种模型:Foo,Bar,Baz 和 Qux,具有如下多种关联:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Baz</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Qux</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Foo</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Bar</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Baz</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Qux</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Foo</span>.<span class="title function_">hasMany</span>(<span class="title class_">Bar</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;fooId&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">Bar</span>.<span class="title function_">hasMany</span>(<span class="title class_">Baz</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;barId&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">Baz</span>.<span class="title function_">hasMany</span>(<span class="title class_">Qux</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;bazId&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>现在,考虑 Foo 上定义的以下四个作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">includeEverything</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">include</span>: <span class="variable language_">this</span>.<span class="property">Qux</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">limitedBars</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">limitedBazs</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">excludeBazName</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">exclude</span>: [<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这四个作用域可以很容易地深度合并,例如通过调用 <code>Foo.scope(&#39;includeEverything&#39;, &#39;limitedBars&#39;, &#39;limitedBazs&#39;, &#39;excludeBazName&#39;).findAll()</code>,这完全等同于调用以下内容:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Foo</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: &#123;</span><br><span class="line">    <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">include</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">exclude</span>: [<span class="string">&quot;name&quot;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">include</span>: <span class="variable language_">this</span>.<span class="property">Qux</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>观察四个作用域如何合并为一个. 根据所包含的模型合并作用域的 include. 如果一个作用域包括模型 A 而另一个作用域包括模型 B,则合并结果将包括模型 A 和 B.另一方面,如果两个作用域包括相同的模型 A,但具有不同的参数(例如嵌套 include 或其他属性) ,这些将以递归方式合并,如上所示.</p>
<p>无论应用于作用域的顺序如何,上面说明的合并都以完全相同的方式工作. 如果某个参数由两个不同的作用域设置,那么只会该顺序产生差异 - 这不是上述示例的情况,因为每个作用域都做了不同的事情.</p>
<p>这种合并策略的工作方式与传递给<code>.findAll</code>,<code>.findOne</code>等的参数完全相同.</p>
<h3 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h3><p>Sequelize 与关联有两个不同但相关的作用域概念. 差异是微妙但重要的:</p>
<ul>
<li><strong>关联作用域</strong> 允许你在获取和设置关联时指定默认属性 - 在实现多态关联时很有用. 当使用<code>get</code>,<code>set</code>,<code>add</code>和<code>create</code>相关联的模型函数时,这个作用域仅在两个模型之间的关联上被调用</li>
<li><strong>关联模型上的作用域</strong> 允许你在获取关联时应用默认和其他作用域,并允许你在创建关联时传递作用域模型. 这些作用域都适用于模型上的常规查找和通过关联查找.</li>
</ul>
<p>举个例子,思考模型 Post 和 Comment. Comment 与其他几个模型(图像,视频等)相关联,Comment 和其他模型之间的关联是多态的,这意味着除了外键 <code>commentable_id</code> 之外,注释还存储一个<code>commentable</code>列.</p>
<p>可以使用 association scope 来实现多态关联:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">Post</span>.<span class="title function_">hasMany</span>(<span class="variable language_">this</span>.<span class="property">Comment</span>, &#123;</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;commentable_id&quot;</span>,</span><br><span class="line">  <span class="attr">scope</span>: &#123;</span><br><span class="line">    <span class="attr">commentable</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当调用 <code>post.getComments()</code> 时,这将自动添加 <code>WHERE commentable = &#39;post&#39;</code>. 类似地,当向帖子添加新的注释时,<code>commentable</code> 会自动设置为 <code>&#39;post&#39;</code>. 关联作用域是为了存活于后台,没有程序员不必担心 - 它不能被禁用. 有关更完整的多态性示例,请参阅 <a target="_blank" rel="noopener" href="https://itfun.tv/documents/272#scopes">关联作用域</a></p>
<p>那么考虑那个 Post 的默认作用域只显示活动的帖子:<code>where: &#123; active: true &#125;</code>. 该作用域存在于相关联的模型(Post)上,而不是像<code>commentable</code> 作用域那样在关联上. 就像在调用<code>Post.findAll()</code> 时一样应用默认作用域,当调用 <code>User.getPosts()</code> 时,它也会被应用 - 这只会返回该用户的活动帖子.</p>
<p>要禁用默认作用域,将 <code>scope: null</code> 传递给 getter: <code>User.getPosts(&#123; scope: null &#125;)</code>. 同样,如果要应用其他作用域,请像这样:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">getPosts</span>(&#123; <span class="attr">scope</span>: [<span class="string">&quot;scope1&quot;</span>, <span class="string">&quot;scope2&quot;</span>] &#125;);</span><br></pre></td></tr></table></figure>

<p>如果要为关联模型上的作用域创建快捷方式,可以将作用域模型传递给关联. 考虑一个快捷方式来获取用户所有已删除的帖子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Post</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">init</span>(attributes, &#123;</span><br><span class="line">  <span class="attr">defaultScope</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scopes</span>: &#123;</span><br><span class="line">    <span class="attr">deleted</span>: &#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">deleted</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  sequelize,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Post</span>); <span class="comment">// 常规 getPosts 关联</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Post</span>.<span class="title function_">scope</span>(<span class="string">&quot;deleted&quot;</span>), &#123; <span class="attr">as</span>: <span class="string">&quot;deletedPosts&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">getPosts</span>(); <span class="comment">// WHERE active = true</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">getDeletedPosts</span>(); <span class="comment">// WHERE deleted = true</span></span><br></pre></td></tr></table></figure>

<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><p>extend&#x2F;helper.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/helper.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 扩展一个格式日期的方法</span></span><br><span class="line">  <span class="title function_">formatTime</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(val * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> d.<span class="title function_">getFullYear</span>();</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>模板中调用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=helper.formatTime(dateline)%&gt;</span><br></pre></td></tr></table></figure>

<p>其他地方调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">helper</span>.<span class="title function_">formatTime</span>(dateline);</span><br></pre></td></tr></table></figure>

<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p>app&#x2F;middleware&#x2F;getIp.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">options: 中间件的配置项，框架会将 app.config[$&#123;middlewareName&#125;] 传递进来。</span></span><br><span class="line"><span class="comment">app: 当前应用 Application 的实例。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 返回一个异步的方法</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 通过option传入额外参数</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(option);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">ip</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h2><p>config&#x2F;config.default.js（配置全局中间件，所有路由都会调用）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">appInfo</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置全局中间件</span></span><br><span class="line">    config.<span class="property">middleware</span> = [<span class="string">&#x27;getIp&#x27;</span>]; <span class="comment">// 注意驼峰式写法，如果中间件是a_bc.js，则要写成aBc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置中间件参数</span></span><br><span class="line">    config.<span class="property">getIp</span> = &#123;</span><br><span class="line">        <span class="attr">ceshi</span>: <span class="number">123</span>,</span><br><span class="line">        <span class="comment">// 通用配置（以下是重点）</span></span><br><span class="line">        <span class="attr">enable</span>:<span class="literal">true</span>, <span class="comment">// 控制中间件是否开启。</span></span><br><span class="line">        <span class="attr">match</span>:<span class="string">&#x27;/news&#x27;</span>, <span class="comment">// 设置只有符合某些规则的请求才会经过这个中间件（匹配路由）</span></span><br><span class="line">        <span class="attr">ignore</span>:<span class="string">&#x27;/shop&#x27;</span> <span class="comment">// 设置符合某些规则的请求不经过这个中间件。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        注意：</span></span><br><span class="line"><span class="comment">        1. match 和 ignore 不允许同时配置</span></span><br><span class="line"><span class="comment">        2. 例如：match:&#x27;/news&#x27;，只要包含/news的任何页面都生效</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// match 和 ignore 支持多种类型的配置方式：字符串、正则、函数（推荐）</span></span><br><span class="line">        <span class="title function_">match</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">          <span class="comment">// 只有 ios 设备才开启</span></span><br><span class="line">          <span class="keyword">const</span> reg = <span class="regexp">/iphone|ipad|ipod/i</span>;</span><br><span class="line">          <span class="keyword">return</span> reg.<span class="title function_">test</span>(ctx.<span class="title function_">get</span>(<span class="string">&#x27;user-agent&#x27;</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h2><h3 id="路由中使用"><a href="#路由中使用" class="headerlink" title="路由中使用"></a>路由中使用</h3><p>app&#x2F;router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 局部中间件（如果只需要局部调用，则不需要在config.default.js中配置）</span></span><br><span class="line">  router.<span class="title function_">get</span>(</span><br><span class="line">    <span class="string">&quot;/admin/:id&quot;</span>,</span><br><span class="line">    app.<span class="property">middleware</span>.<span class="title function_">getIp</span>(&#123;</span><br><span class="line">      <span class="attr">ceshi</span>: <span class="string">&quot;我是admin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    controller.<span class="property">admin</span>.<span class="property">index</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Koa-的中间件（gzip-压缩）"><a href="#使用-Koa-的中间件（gzip-压缩）" class="headerlink" title="使用 Koa 的中间件（gzip 压缩）"></a>使用 Koa 的中间件（gzip 压缩）</h3><p>大大提高网站的访问速度（非常有效）</p>
<p>以 <a target="_blank" rel="noopener" href="https://github.com/koajs/compress">koa-compress</a> 为例，在 Koa 中使用时：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> compress = <span class="built_in">require</span>(<span class="string">&quot;koa-compress&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123; <span class="attr">threshold</span>: <span class="number">2048</span> &#125;;</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">compress</span>(options));</span><br></pre></td></tr></table></figure>

<p>我们按照框架的规范来在应用中加载这个 Koa 的中间件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/compress.js</span></span><br><span class="line"><span class="comment">// koa-compress 暴露的接口(`(options) =&gt; middleware`)和框架对中间件要求一致</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-compress&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">middleware</span>: [<span class="string">&quot;compress&quot;</span>],</span><br><span class="line">  <span class="attr">compress</span>: &#123;</span><br><span class="line">    <span class="attr">threshold</span>: <span class="number">2048</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="表单提交"><a href="#表单提交" class="headerlink" title="表单提交"></a>表单提交</h1><h2 id="post"><a href="#post" class="headerlink" title="post"></a>post</h2><p>app&#x2F;controller&#x2F;home.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">addInput</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;post&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">add</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="comment">// 通过ctx.request.body获取post提交数据</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">body</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app&#x2F;view&#x2F;post.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">需要定义：?_csrf=&lt;%=ctx.csrf%&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/add?_csrf=&lt;%=ctx.csrf%&gt;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>app&#x2F;router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/post&quot;</span>, controller.<span class="property">home</span>.<span class="property">addInput</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/add&quot;</span>, controller.<span class="property">home</span>.<span class="property">add</span>);</span><br></pre></td></tr></table></figure>

<h1 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.设置</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;ceshi&quot;</span>);</span><br><span class="line"><span class="comment">// 2.获取</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.设置中文(加密操作 encrypt: true)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.设置（其他参数配置）</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;ceshi&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">3600</span> * <span class="number">24</span>, <span class="comment">// 存储24小时，单位毫秒，关闭浏览器cookie还存在</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span></span><br><span class="line">  <span class="attr">signed</span>: <span class="literal">true</span>, <span class="comment">// 签名，防止用户前台修改</span></span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>, <span class="comment">// 加密，注意：get获取时需要解密</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 5.获取时解密</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.清除cookie</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h1 id="session"><a href="#session" class="headerlink" title="session"></a>session</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.设置</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="string">&quot;测试&quot;</span>;</span><br><span class="line"><span class="comment">// 2.获取</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span>;</span><br><span class="line"><span class="comment">// 3.默认配置（全局配置，config/config.default.js）</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">session</span> = &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;EGG_SESS&quot;</span>, <span class="comment">// 设置cookies的key值</span></span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>, <span class="comment">// 1 天，过期时间</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span></span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>, <span class="comment">// 加密</span></span><br><span class="line">  <span class="attr">renew</span>: <span class="literal">true</span>, <span class="comment">// 每次刷新页面都会被延期</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 4.动态配置</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">maxAge</span> = <span class="number">5000</span>; <span class="comment">// 5秒的过期时间</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="string">&quot;测试&quot;</span>;</span><br><span class="line"><span class="comment">// 5.清空session</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h1 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/schedule/ceshi.js</span></span><br><span class="line"><span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 设置定时任务的执行间隔等配置</span></span><br><span class="line">  <span class="attr">schedule</span>: &#123;</span><br><span class="line">    <span class="attr">interval</span>: <span class="string">&quot;5s&quot;</span>, <span class="comment">// 每5秒执行一次</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;all&quot;</span>, <span class="comment">// 指定所有的 worker 都需要执行</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 任务</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">task</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    ++i;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><h2 id="1-context"><a href="#1-context" class="headerlink" title="1. context"></a>1. context</h2><h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">ceshi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 通过ctx中的curl方法获取数据</span></span><br><span class="line">    <span class="keyword">let</span> r = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">curl</span>(<span class="string">&#x27;http://www.phonegap100.com/appapi.php?a=getPortalList&amp;catid=20&amp;page=1&#x27;</span>);</span><br><span class="line">    <span class="comment">// 将buffer类型数据转为json类型</span></span><br><span class="line">    <span class="keyword">let</span> &#123; result &#125; = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(r.<span class="property">data</span>)</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h1><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-cache">https://www.npmjs.com/package/egg-cache</a><br><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-redis">https://www.npmjs.com/package/egg-redis</a></p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p><a target="_blank" rel="noopener" href="https://github.com/temool/egg-validate-plus">https://github.com/temool/egg-validate-plus</a></p>
<h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-jwt">https://www.npmjs.com/package/egg-jwt</a></p>
<p>前端访问：header 头添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authorization:&quot;Bearer token值&quot;</span></span><br><span class="line"><span class="title class_">Authorization</span>: <span class="string">&quot;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6MTIzLCJpYXQiOjE1NzkxOTQxNTN9.Ml5B02ZPfYo78QwJic-Jdp2LUi2_AU0RGNgPhhJH--o&quot;</span>;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/Koa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/Koa/" class="post-title-link" itemprop="url">Koa</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:08:25" itemprop="dateCreated datePublished" datetime="2022-11-08T17:08:25+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:14" itemprop="dateModified" datetime="2023-03-19T18:57:14+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>通过利用 async 函数，Koa 帮你丢弃回调函数，并有力地增强错误处理。 Koa 并没有捆绑任何中间件， 而是提供了一套优雅的方法，帮助您快速而愉快地编写服务端应用程序。</p>
<h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><ul>
<li>需先建对象与 express 不同：const app &#x3D; new Koa()</li>
<li>ctx(context)封装了 res 和 req<ul>
<li>返回使用 ctx.body，可使用 async 和 await<ul>
<li>ctx.body 最终会转换为 res.end</li>
<li>执行时机：洋葱模型的最外层，第一个中间件 promise 有结果后，将 ctx.body 转换为 res.end()</li>
<li>异步使用时，不可放置异步函数中，需放置在 await 的 promise 中</li>
</ul>
</li>
<li>也可直接使用 ctx.res 和 ctx.req</li>
<li>常用属性：req、res、request、response</li>
</ul>
</li>
<li>ctx 属性：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>); <span class="comment">// ⼀个类</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件，可以使⽤async await</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="comment">// throw new Error(&#x27;出错了&#x27;)</span></span><br><span class="line">  <span class="comment">// ctx封装了req和res的功能，这⾥相当于res.end</span></span><br><span class="line">  <span class="comment">// 1、有输出，ctx.body在promise结果后</span></span><br><span class="line">  ctx.<span class="property">body</span> = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;zhuwa&quot;</span>);</span><br><span class="line">  <span class="comment">// 2、无输出</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&quot;zhuwa&quot;</span>;</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误事件</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="keyword">function</span> (<span class="params">err, ctx</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  ctx.<span class="property">res</span>.<span class="title function_">end</span>(<span class="string">`500 错误`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3002</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;koa server started at 3002&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// req request res response的区别</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">req</span>.<span class="property">path</span>); <span class="comment">// 原⽣的req</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">path</span>); <span class="comment">// koa封装的request</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">req</span>.<span class="property">path</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">path</span>); <span class="comment">// 代理到request</span></span><br><span class="line">  ctx.<span class="property">body</span> = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;zhuwa&quot;</span>); <span class="comment">// ctx封装了req和res的功能，这⾥相当于res.end</span></span><br><span class="line">  <span class="comment">//ctx.throw(401, &quot;err msg&quot;);</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="中间件-洋葱模型"><a href="#中间件-洋葱模型" class="headerlink" title="中间件(洋葱模型)"></a>中间件(洋葱模型)</h2><p>使用 app.use，回调函数只能传一个，多个需多次注册<br>异步流程会等待后续中间件有结果时返回<br>在 koa 中，中间件被 next() 方法分成了两部分。next() 方法上面部分会先执行，下面部门会在后续中间件执行全部结束之后再执行。</p>
<ul>
<li>多个中间件会形成一个栈结构（middlestack），以＂先进后出＂（first-in-last- out）的顺序执行。</li>
<li>最外层的中间件首先执行。</li>
<li>调用 next 函数，把执行权交给下一个中间件。</li>
<li>最内层的中间件最后执行。</li>
<li>执行结束后，把执行权交回上一层的中间件。</li>
<li>最外层的中间件收回执行权之后，执行 next 函数后面的代码.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1-1&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1-2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2-1&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2-2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3-1&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3-2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//输出：1-1、2-1、3-1、3-2、2-2、1-2</span></span><br></pre></td></tr></table></figure>

<h2 id="与-express-比较"><a href="#与-express-比较" class="headerlink" title="与 express 比较"></a>与 express 比较</h2><table>
<thead>
<tr>
<th>框架</th>
<th>express</th>
<th>koa</th>
</tr>
</thead>
<tbody><tr>
<td>模型</td>
<td>线性模型</td>
<td>洋葱模型</td>
</tr>
<tr>
<td>表现</td>
<td>同步表现为洋葱模型，但遇到异步，即使使⽤了 await next()也不会等待，会继续向下执⾏，因为 next()返回 undefined</td>
<td>⽆论同步，还是异步，都是洋葱模型，可以使⽤ await 和 next() 来等待下⼀个中间件执⾏完成</td>
</tr>
<tr>
<td>原理</td>
<td>使⽤回调, next()，返回 undefined</td>
<td>next()，返回 promise，会把中间件⽤ promise 包裹起来</td>
</tr>
<tr>
<td>错误</td>
<td>错误处理是在⼀个特殊签名的中间件中完成的，它必须被添加到链的后⾯才能捕获到前⾯的错误</td>
<td>可以使⽤ try catch 捕获中间件错误</td>
</tr>
<tr>
<td>注意</td>
<td>await next() 也不会等待下⼀个中间件异步完成</td>
<td>要使⽤ await 来等待异步操作；注意 res.end 的时机，等最外层的中间件（也就是第⼀个中间件）的 promise 有结果后，响应就会被返回 ctx.body -&gt;res.end(ctx.body)</td>
</tr>
</tbody></table>
<h2 id="中间件编写"><a href="#中间件编写" class="headerlink" title="中间件编写"></a>中间件编写</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//编写⼀个计算请求的时⻓的中间件</span></span><br><span class="line"><span class="comment">// koa 中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&quot;serviceTime&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&quot;serviceTime&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// express 中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">  res.<span class="title function_">once</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">在最顶层捕获未处理的错误</div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以使⽤try catch 捕获中间件错误</span></span><br><span class="line"><span class="comment">// 在最顶层捕获未处理的错误</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// await 可以让异步函数的错误得到捕获</span></span><br><span class="line">   		<span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">   		<span class="keyword">const</span> status = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">   		ctx.<span class="property">status</span> = status;</span><br><span class="line">   		ctx.<span class="property">type</span> = <span class="string">&quot;html&quot;</span>;</span><br><span class="line">   		ctx.<span class="property">body</span> = <span class="string">`</span></span><br><span class="line"><span class="string">   			&lt;b&gt;<span class="subst">$&#123;status&#125;</span>&lt;/b&gt; <span class="subst">$&#123;err&#125;</span></span></span><br><span class="line"><span class="string">   		`</span>;</span><br><span class="line">   		<span class="comment">// emmit</span></span><br><span class="line">   		ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, err, ctx);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">ctx.<span class="property">body</span> = <span class="string">`Uh-oh: <span class="subst">$&#123;err.message&#125;</span>`</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error handler:&#x27;</span>, err.<span class="property">message</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (ctx.<span class="property">query</span>.<span class="property">greet</span> !== <span class="string">&#x27;world&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;can only greet &quot;world&quot;&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Sending response&#x27;</span>)</span><br><span class="line">ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">ctx.<span class="property">body</span> = <span class="string">`Hello <span class="subst">$&#123;ctx.query.greet&#125;</span> from Koa`</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以使⽤总的错误事件来统⼀处理</span></span><br><span class="line"><span class="comment">// 错误事件</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span>(<span class="params">err</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">``</span></span><br><span class="line"></span><br><span class="line">## 常用中间件</span><br><span class="line"></span><br><span class="line">- koa-router：路由</span><br><span class="line">- koa-<span class="keyword">static</span>：静态资源</span><br><span class="line">- koa-mounut：子路由</span><br><span class="line">- koa-body：body解析</span><br><span class="line">- koa-parameter：参数校验</span><br><span class="line"><span class="string">``</span><span class="string">`javascript</span></span><br><span class="line"><span class="string">//1、koa-router</span></span><br><span class="line"><span class="string">const KoaRouter = require(&#x27;koa-router&#x27;)</span></span><br><span class="line"><span class="string">router.get(&#x27;/page&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string"> 		ctx.body = await new Promise((resolve, reject) =&gt; &#123;</span></span><br><span class="line"><span class="string"> 				resolve(&#x27;ok&#x27;)</span></span><br><span class="line"><span class="string"> 		&#125;)</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">// 注册中间件</span></span><br><span class="line"><span class="string">app.use(router.routes())</span></span><br><span class="line"><span class="string">// 添加前缀</span></span><br><span class="line"><span class="string">const router = new Router(&#123; prefix: &#x27;/user&#x27; &#125;)</span></span><br><span class="line"><span class="string">// 重定向</span></span><br><span class="line"><span class="string">router.get(&#x27;/home&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string"> 	ctx.redirect(&#x27;http://baidu.com&#x27;);</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">// 路由参数</span></span><br><span class="line"><span class="string">router.get(&#x27;/:id&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   ctx.body = &#123;</span></span><br><span class="line"><span class="string">     msg: &#x27;index page&#x27;,</span></span><br><span class="line"><span class="string">     params: ctx.params.id // 通过 ctx.params.id 获取到的是 1</span></span><br><span class="line"><span class="string">   &#125;;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">router.get(&#x27;/&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   ctx.body = &#123;</span></span><br><span class="line"><span class="string">     msg: &#x27;index page&#x27;,</span></span><br><span class="line"><span class="string">     query: ctx.query // ctx.query会获取url后⾯携带的参数对象</span></span><br><span class="line"><span class="string">   &#125;;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">// allowedMethod</span></span><br><span class="line"><span class="string">// 如果没有这⼀⾏, 当使⽤其他请求⽅式请求user时, 会提示404</span></span><br><span class="line"><span class="string">// 如果有这⼀⾏, 当使⽤其他请求⽅式请求user时, 提示405 method not allowed</span></span><br><span class="line"><span class="string">app.use(router.allowedMethod());</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//2、koa-static</span></span><br><span class="line"><span class="string">const KoaStatic = require(&#x27;koa-static&#x27;)</span></span><br><span class="line"><span class="string">// 动态加载静态资源</span></span><br><span class="line"><span class="string">app.use(KoaStatic(path.resolve(__dirname, &#x27;../dist/assets&#x27;)))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//3、koa-mounut</span></span><br><span class="line"><span class="string">const KoaMount = require(&#x27;koa-mount&#x27;)</span></span><br><span class="line"><span class="string">// 添加前缀</span></span><br><span class="line"><span class="string">app.use(KoaMount(&#x27;/assets&#x27;, KoaStatic(path.resolve(__dirname, &#x27;../dist/assets&#x27;))))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//4、koa-body</span></span><br><span class="line"><span class="string">const bodyparser = require(&#x27;koa-body&#x27;);</span></span><br><span class="line"><span class="string">// 在注册此中间件之后, 会在 ctx 上下⽂注⼊ ctx.request.body 属性 ⽤于获取客户端传递来的数据</span></span><br><span class="line"><span class="string">app.use(bodyparser());</span></span><br><span class="line"><span class="string">router.post(&#x27;/&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   ctx.body = &#123;</span></span><br><span class="line"><span class="string">   code: 200,</span></span><br><span class="line"><span class="string">   		//body 可以获取form表单数据, json数据</span></span><br><span class="line"><span class="string">   		msg: ctx.request.body</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//5、koa-parameter</span></span><br><span class="line"><span class="string">const parameter = require(&#x27;koa-parameter&#x27;);</span></span><br><span class="line"><span class="string">parameter(app);</span></span><br><span class="line"><span class="string">router.post(&#x27;/&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   //接收⼀个对象</span></span><br><span class="line"><span class="string">   ctx.verifyParams(&#123;</span></span><br><span class="line"><span class="string">     // 校验的简写形式</span></span><br><span class="line"><span class="string">     username: &#x27;string&#x27;,</span></span><br><span class="line"><span class="string">     password: &#123; type: &#x27;string&#x27;, required: true &#125; // 或者也可以这样</span></span><br><span class="line"><span class="string">   &#125;)</span></span><br><span class="line"><span class="string">   ctx.body = &#123; code: 1 &#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## koa-compose</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">中间件合并处理</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"><span class="title function_">compose</span>(stack)(&#123;&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>stack 是数组，收集了多个 async 函数，即返回值是 promise，内部有异步，总之就是收集了所有的异步操作；</li>
<li>compose 是核心代码，函数接收 stack 数组返回一个匿名函数（这里采用了闭包）；</li>
<li>核心代码就是执行这个匿名函数；</li>
</ul>
<p>我们来看下 compose 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compose</span>(<span class="params">middleware</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(middleware))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot;Middleware stack must be an array!&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> fn <span class="keyword">of</span> middleware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">&quot;function&quot;</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot;Middleware must be composed of functions!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">context</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type">Promise</span>&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@api</span> <span class="variable">public</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 核心匿名函数：接收上下文对象context和自定义next函数；</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">context, next</span>) &#123;</span><br><span class="line">    <span class="comment">// last called middleware #</span></span><br><span class="line">    <span class="keyword">let</span> index = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatch</span>(<span class="number">0</span>); <span class="comment">//调用第一个元素函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">i</span>) &#123;</span><br><span class="line">      <span class="comment">// 防止连续执行两次next</span></span><br><span class="line">      <span class="keyword">if</span> (i &lt;= index)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;next() called multiple times&quot;</span>));</span><br><span class="line">      index = i;</span><br><span class="line">      <span class="keyword">let</span> fn = middleware[i];</span><br><span class="line">      <span class="keyword">if</span> (i === middleware.<span class="property">length</span>) fn = next; <span class="comment">//此处i对应的fn是undefined，也支持自定义next</span></span><br><span class="line">      <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(); <span class="comment">// 最后一个直接返回</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 递归去执行dispatch，本质是获取下一个fn元素</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title function_">fn</span>(context, dispatch.<span class="title function_">bind</span>(<span class="literal">null</span>, i + <span class="number">1</span>)));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Context-上下文"><a href="#Context-上下文" class="headerlink" title="Context(上下文)"></a>Context(上下文)</h1><p>Koa Context 将 node 的 request 和 response 对象封装到单个对象中，为编写 Web 应用程序和 API 提供了许多有用的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx; <span class="comment">// 这是 Context</span></span><br><span class="line">  ctx.<span class="property">request</span>; <span class="comment">// 这是 koa Request</span></span><br><span class="line">  ctx.<span class="property">response</span>; <span class="comment">// 这是 koa Response</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>为方便起见许多上下文的访问器和方法直接委托给它们的 ctx.request 或 ctx.response ，不然的话它们是相同的。 例如 ctx.type 和 ctx.length 委托给 response 对象，ctx.path 和 ctx.method 委托给 request。</p>
<h2 id="ctx-req"><a href="#ctx-req" class="headerlink" title="ctx.req"></a>ctx.req</h2><p>Node 的 request 对象.</p>
<h2 id="ctx-res"><a href="#ctx-res" class="headerlink" title="ctx.res"></a>ctx.res</h2><p>Node 的 response 对象.<br>绕过 Koa 的 response 处理是 <strong>不被支持的</strong>. 应避免使用以下 node 属性：</p>
<ul>
<li>res.statusCode</li>
<li>res.writeHead()</li>
<li>res.write()</li>
<li>res.end()</li>
</ul>
<h1 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h1><h2 id="Request-别名"><a href="#Request-别名" class="headerlink" title="Request 别名"></a>Request 别名</h2><p>以下访问器和 <a target="_blank" rel="noopener" href="https://koa.bootcss.com/#request">Request</a> 别名等效：</p>
<ul>
<li>ctx.header</li>
<li>ctx.headers</li>
<li>ctx.method</li>
<li>ctx.method&#x3D;</li>
<li>ctx.url</li>
<li>ctx.url&#x3D;</li>
<li>ctx.originalUrl</li>
<li>ctx.origin</li>
<li>ctx.href</li>
<li>ctx.path</li>
<li>ctx.path&#x3D;</li>
<li>ctx.query</li>
<li>ctx.query&#x3D;</li>
<li>ctx.querystring</li>
<li>ctx.querystring&#x3D;</li>
<li>ctx.host</li>
<li>ctx.hostname</li>
<li>ctx.fresh</li>
<li>ctx.stale</li>
<li>ctx.socket</li>
<li>ctx.protocol</li>
<li>ctx.secure</li>
<li>ctx.ip</li>
<li>ctx.ips</li>
<li>ctx.subdomains</li>
<li>ctx.is()</li>
<li>ctx.accepts()</li>
<li>ctx.acceptsEncodings()</li>
<li>ctx.acceptsCharsets()</li>
<li>ctx.acceptsLanguages()</li>
<li>ctx.get()</li>
</ul>
<h2 id="Response-别名"><a href="#Response-别名" class="headerlink" title="Response 别名"></a>Response 别名</h2><p>以下访问器和 <a target="_blank" rel="noopener" href="https://koa.bootcss.com/#response">Response</a> 别名等效：</p>
<ul>
<li>ctx.body</li>
<li>ctx.body&#x3D;</li>
<li>ctx.status</li>
<li>ctx.status&#x3D;</li>
<li>ctx.message</li>
<li>ctx.message&#x3D;</li>
<li>ctx.length&#x3D;</li>
<li>ctx.length</li>
<li>ctx.type&#x3D;</li>
<li>ctx.type</li>
<li>ctx.headerSent</li>
<li>ctx.redirect()</li>
<li>ctx.attachment()</li>
<li>ctx.set()</li>
<li>ctx.append()</li>
<li>ctx.remove()</li>
<li>ctx.lastModified&#x3D;</li>
<li>ctx.etag&#x3D;</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/Redis/" class="post-title-link" itemprop="url">Redis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:07:57" itemprop="dateCreated datePublished" datetime="2022-11-08T17:07:57+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:14" itemprop="dateModified" datetime="2023-03-19T18:57:14+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Redis 是使用 c 语言开发的一个高性能键值数据库。<br>Redis 可以通过一些键值类型来存储数据。<br>键值类型：</p>
<ul>
<li>String 字符类型</li>
<li>map 散列类型</li>
<li>list 列表类型</li>
<li>set 集合类型</li>
<li>sortedset 有序集合类型</li>
</ul>
<p>Redis 使用起来就像是 JS 中的 Map 数据结构（但 key 只能是字符串，value 要符合支持的数据结构）。在业务中，我们可以用 Redis 来存储用户的鉴权 token，用户带着 token 访问时，可以快速从 redis 取出并对比。</p>
<h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><ul>
<li>缓存（数据查询、短连接、新闻内容、商品内容等等）。（最多使用）</li>
<li>分布式集群架构中的 session 分离。</li>
<li>聊天室的在线好友列表。</li>
<li>任务队列。（秒杀、抢购、12306 等等）</li>
<li>应用排行榜。</li>
<li>网站访问统计。</li>
<li>数据过期处理（可以精确到毫秒）</li>
</ul>
<h1 id="安装-macOS"><a href="#安装-macOS" class="headerlink" title="安装(macOS)"></a>安装(macOS)</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install redis</span><br></pre></td></tr></table></figure>

<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前台启动redis服务器</span></span><br><span class="line">redis-server</span><br><span class="line"><span class="comment">// server后台启动</span></span><br><span class="line">redis-server --daemonize yes</span><br><span class="line"><span class="comment">// launch后台启动</span></span><br><span class="line">brew services start redis</span><br><span class="line"><span class="comment">// 关闭后台启动</span></span><br><span class="line">brew services stop redis</span><br><span class="line"><span class="comment">// 查看信息</span></span><br><span class="line">brew services info redis</span><br></pre></td></tr></table></figure>

<h1 id="连接-Redis"><a href="#连接-Redis" class="headerlink" title="连接 Redis"></a>连接 Redis</h1><p>启动 Redis 服务后,连接 redis 数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Redis命令行客户端</span><br><span class="line">redis-cli</span><br><span class="line">// 连接远程服务</span><br><span class="line">redis-cli -h host -p port -a password</span><br></pre></td></tr></table></figure>

<h1 id="查看-Redis-状态"><a href="#查看-Redis-状态" class="headerlink" title="查看 Redis 状态"></a>查看 Redis 状态</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep -i redis</span><br></pre></td></tr></table></figure>

<h1 id="停止-Redis"><a href="#停止-Redis" class="headerlink" title="停止 Redis"></a>停止 Redis</h1><p>防止中止进程导致数据丢失,应该使用<code>shutdown</code>命令停止 Redis.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 此方法关闭 redis-server启动的进程</span><br><span class="line">redis-cli shutdown</span><br></pre></td></tr></table></figure>

<p>另一种方法是杀进程,进程号通过查看 Redis 状态得知.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 进程号</span><br></pre></td></tr></table></figure>

<h1 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回所有KEY</span></span><br><span class="line">KEYS *</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取key的类型</span></span><br><span class="line">TYPE my*</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询某个key是否存在</span></span><br><span class="line">EXISTS key [key...]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将key改名为newkey</span></span><br><span class="line">RENAME key newkey</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从当前数据库随机返回(非删除)一个key</span></span><br><span class="line">RANDOMKEY</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空当前数据库内容</span></span><br><span class="line">FLUSHDB</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空所有数据库内容</span></span><br><span class="line">FLUSHALL</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将当前数据库的key移动的指定db</span></span><br><span class="line">MOVE key db</span><br></pre></td></tr></table></figure>

<h2 id="设置过期时间"><a href="#设置过期时间" class="headerlink" title="设置过期时间"></a>设置过期时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为指定key设置过期时间,当key过期就删除</span></span><br><span class="line">EXPIRE key seconds</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以毫秒为单位</span></span><br><span class="line">PEXPIRE key milliseconds</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过时间戳设置</span></span><br><span class="line">EXPIREAT key timessamp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以毫秒为单位</span></span><br><span class="line">PEXPIREAT key milliseconds-timessamp</span><br></pre></td></tr></table></figure>

<h2 id="获取过期时间"><a href="#获取过期时间" class="headerlink" title="获取过期时间"></a>获取过期时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回指定key的剩余时间(秒)</span></span><br><span class="line">TTL key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">毫秒单位</span></span><br><span class="line">PTTL key</span><br></pre></td></tr></table></figure>

<h1 id="多数据库"><a href="#多数据库" class="headerlink" title="多数据库"></a>多数据库</h1><p>默认分配 16 个数据库,数字 0-15.默认使用 0 数据库.数据库相对独立,可以配置参数<code>databases</code>修改个数.</p>
<h2 id="切换数据库-SELECT"><a href="#切换数据库-SELECT" class="headerlink" title="切换数据库[SELECT]"></a>切换数据库[SELECT]</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="知识体系"><a href="#知识体系" class="headerlink" title="知识体系"></a>知识体系</h1><p>多个数据库并不是完全独立.如果要不同应用存储建议开多个 Redis 实例.<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046045649-ac030646-fb19-4dee-b71a-5e40bbaf3e18.png#averageHue=%23fcfcfc&clientId=u429e2987-0087-4&from=paste&height=1694&id=u9cbd2945&name=image.png&originHeight=1694&originWidth=2650&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=329193&status=done&style=none&taskId=u36381aa8-c655-4117-8c4c-26305d9a989&title=&width=2650" alt="image.png"></p>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>Redis 数据库支持五种数据类型。</p>
<ul>
<li>字符串（string）</li>
<li>哈希（hash）</li>
<li>列表（list）</li>
<li>集合（set）</li>
<li>有序集合（sorted set）</li>
<li>位图 ( Bitmaps )</li>
<li>基数统计 ( HyperLogLogs )</li>
</ul>
<h1 id="5-种基础数据类型"><a href="#5-种基础数据类型" class="headerlink" title="5 种基础数据类型"></a>5 种基础数据类型</h1><h2 id="String-字符串"><a href="#String-字符串" class="headerlink" title="String 字符串"></a>String 字符串</h2><p>String 是一组字节。在 Redis 数据库中，字符串是二进制安全的。<br>这意味着它们具有已知长度，并且不受任何特殊终止字符的影响。<br>redis 的 string 可以包含任何数据。如数字，字符串，jpg 图片或者序列化的对象。<br>可以在一个字符串中存储最多 512 M 的内容。<br>使用 <code>SET</code> 命令在 <code>name</code> 键中存储字符串 redis.com.cn，然后使用 <code>GET</code> 命令查询 name。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SET</span> name <span class="string">&quot;redis.com.cn&quot;</span></span><br><span class="line"><span class="variable constant_">OK</span></span><br><span class="line"><span class="variable constant_">GET</span> name</span><br><span class="line"><span class="string">&quot;redis.com.cn&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="命令使用"><a href="#命令使用" class="headerlink" title="命令使用"></a>命令使用</h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>获取存储在给定键中的值</td>
<td>GET name</td>
</tr>
<tr>
<td>SET</td>
<td>设置存储在给定键中的值</td>
<td>SET name value</td>
</tr>
<tr>
<td>DEL</td>
<td>删除存储在给定键中的值</td>
<td>DEL name</td>
</tr>
<tr>
<td>INCR</td>
<td>将键存储的值加 1</td>
<td>INCR key</td>
</tr>
<tr>
<td>DECR</td>
<td>将键存储的值减 1</td>
<td>DECR key</td>
</tr>
<tr>
<td>INCRBY</td>
<td>将键存储的值加上整数</td>
<td>INCRBY key amount</td>
</tr>
<tr>
<td>DECRBY</td>
<td>将键存储的值减去整数</td>
<td>DECRBY key amount</td>
</tr>
</tbody></table>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; set hello world</span><br><span class="line"><span class="variable constant_">OK</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get hello</span><br><span class="line"><span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; del hello</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get hello</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; set counter <span class="number">2</span></span><br><span class="line"><span class="variable constant_">OK</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; incr counter</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; incrby counter <span class="number">100</span></span><br><span class="line">(integer) <span class="number">103</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;103&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; decr counter</span><br><span class="line">(integer) <span class="number">102</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;102&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="实战场景"><a href="#实战场景" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>缓存</strong>： 经典使用场景，把常用信息，字符串，图片或者视频等信息放到 redis 中，redis 作为缓存层，mysql 做持久化层，降低 mysql 的读写压力。</li>
<li><strong>计数器</strong>：redis 是单线程模型，一个命令执行完才会执行下一个，同时数据可以一步落地到其他的数据源。</li>
<li><strong>session</strong>：常见方案 spring session + redis 实现 session 共享，</li>
</ul>
<h2 id="List-列表"><a href="#List-列表" class="headerlink" title="List 列表"></a>List 列表</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis中的List其实就是链表（Redis用双端链表实现List）。</div>
使用List结构，我们可以轻松地实现最新消息排队功能（比如新浪微博的TimeLine）。
List的另一个应用就是消息队列，可以利用List的 PUSH 操作，将任务存放在List中，然后工作线程再用 POP 操作将任务取出进行执行。

<h3 id="命令使用-1"><a href="#命令使用-1" class="headerlink" title="命令使用"></a>命令使用</h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>RPUSH</td>
<td>将给定值推入到列表右端</td>
<td>RPUSH key value</td>
</tr>
<tr>
<td>LPUSH</td>
<td>将给定值推入到列表左端</td>
<td>LPUSH key value</td>
</tr>
<tr>
<td>RPOP</td>
<td>从列表的右端弹出一个值，并返回被弹出的值</td>
<td>RPOP key</td>
</tr>
<tr>
<td>LPOP</td>
<td>从列表的左端弹出一个值，并返回被弹出的值</td>
<td>LPOP key</td>
</tr>
<tr>
<td>LRANGE</td>
<td>获取列表在给定范围上的所有值</td>
<td>LRANGE key 0 -1</td>
</tr>
<tr>
<td>LINDEX</td>
<td>通过索引获取列表中的元素。你也可以使用负数下标，以 -1 表示列表的最后一个元素， -2 表示列表的倒数第二个元素，以此类推。</td>
<td>LINDEX key index</td>
</tr>
</tbody></table>
<h3 id="使用列表的技巧"><a href="#使用列表的技巧" class="headerlink" title="使用列表的技巧"></a>使用列表的技巧</h3><ul>
<li>lpush+lpop&#x3D;Stack(栈)</li>
<li>lpush+rpop&#x3D;Queue（队列）</li>
<li>lpush+ltrim&#x3D;Capped Collection（有限集合）</li>
<li>lpush+brpop&#x3D;Message Queue（消息队列）</li>
</ul>
<h3 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush mylist 1 2 ll ls mem</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) &quot;mem&quot;</span><br><span class="line">2) &quot;ls&quot;</span><br><span class="line">3) &quot;ll&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;1&quot;</span><br><span class="line">127.0.0.1:6379&gt; lindex mylist -1</span><br><span class="line">&quot;1&quot;</span><br><span class="line">127.0.0.1:6379&gt; lindex mylist 10        # index不在 mylist 的区间范围内</span><br><span class="line">(nil)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="实战场景-1"><a href="#实战场景-1" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>微博 TimeLine</strong>: 有人发布微博，用 lpush 加入时间轴，展示新的列表信息。</li>
<li><strong>消息队列</strong></li>
</ul>
<h2 id="Set-集合"><a href="#Set-集合" class="headerlink" title="Set 集合"></a>Set 集合</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。</div>
Redis 中集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是 O(1)。

<ul>
<li><strong>图例</strong></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046794639-85a5122f-003f-44fc-91ee-86f558d484ea.png#averageHue=%23f4f4f4&clientId=u429e2987-0087-4&from=paste&height=264&id=ucff4cff4&name=image.png&originHeight=544&originWidth=776&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=84607&status=done&style=none&taskId=u38c54c41-b5d6-410b-a6f3-c338680a070&title=&width=376" alt="image.png"></p>
<h3 id="命令使用-2"><a href="#命令使用-2" class="headerlink" title="命令使用"></a><strong>命令使用</strong></h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>SADD</td>
<td>向集合添加一个或多个成员</td>
<td>SADD key value</td>
</tr>
<tr>
<td>SCARD</td>
<td>获取集合的成员数</td>
<td>SCARD key</td>
</tr>
<tr>
<td>SMEMBERS</td>
<td>返回集合中的所有成员</td>
<td>SMEMBERS key member</td>
</tr>
<tr>
<td>SISMEMBER</td>
<td>判断 member 元素是否是集合 key 的成员</td>
<td>SISMEMBER key member</td>
</tr>
</tbody></table>
<p>其它一些集合操作，请参考这里<a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-sets.html">https://www.runoob.com/redis/redis-sets.html</a></p>
<h3 id="命令执行-2"><a href="#命令执行-2" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd myset hao hao1 xiaohao hao</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) &quot;xiaohao&quot;</span><br><span class="line">2) &quot;hao1&quot;</span><br><span class="line">3) &quot;hao&quot;</span><br><span class="line">127.0.0.1:6379&gt; sismember myset hao</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="实战场景-2"><a href="#实战场景-2" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>标签</strong>（tag）,给用户添加标签，或者用户给消息添加标签，这样有同一标签或者类似标签的可以给推荐关注的事或者关注的人。</li>
<li><strong>点赞，或点踩，收藏等</strong>，可以放到 set 中实现</li>
</ul>
<h2 id="Hash-散列"><a href="#Hash-散列" class="headerlink" title="Hash 散列"></a>Hash 散列</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis hash 是一个 string 类型的 field（字段） 和 value（值） 的映射表，hash 特别适合用于存储对象。</div>
哈希是键值对的集合。在 Redis 中，哈希是字符串字段和字符串值之间的映射。因此，它们适合表示对象。

<ul>
<li><strong>图例</strong></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046794744-59fa1954-a3fb-4f6b-b9db-2ad186213ecb.png#averageHue=%23f1f1f1&clientId=u429e2987-0087-4&from=paste&height=314&id=ue8a23193&name=image.png&originHeight=582&originWidth=742&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=110423&status=done&style=none&taskId=ub674fa52-35d2-45ae-8524-6dbbc3ae697&title=&width=400" alt="image.png"></p>
<h3 id="命令使用-3"><a href="#命令使用-3" class="headerlink" title="命令使用"></a><strong>命令使用</strong></h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>HSET</td>
<td>添加键值对</td>
<td>HSET hash-key sub-key1 value1</td>
</tr>
<tr>
<td>HGET</td>
<td>获取指定散列键的值</td>
<td>HGET hash-key key1</td>
</tr>
<tr>
<td>HGETALL</td>
<td>获取散列中包含的所有键值对</td>
<td>HGETALL hash-key</td>
</tr>
<tr>
<td>HDEL</td>
<td>如果给定键存在于散列中，那么就移除这个键</td>
<td>HDEL hash-key sub-key1</td>
</tr>
</tbody></table>
<h3 id="命令执行-3"><a href="#命令执行-3" class="headerlink" title="命令执行"></a><strong>命令执行</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset user name1 hao</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hset user email1 hao@163.com</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user</span><br><span class="line">1) &quot;name1&quot;</span><br><span class="line">2) &quot;hao&quot;</span><br><span class="line">3) &quot;email1&quot;</span><br><span class="line">4) &quot;hao@163.com&quot;</span><br><span class="line">127.0.0.1:6379&gt; hget user user</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; hget user name1</span><br><span class="line">&quot;hao&quot;</span><br><span class="line">127.0.0.1:6379&gt; hset user name2 xiaohao</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hset user email2 xiaohao@163.com</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user</span><br><span class="line">1) &quot;name1&quot;</span><br><span class="line">2) &quot;hao&quot;</span><br><span class="line">3) &quot;email1&quot;</span><br><span class="line">4) &quot;hao@163.com&quot;</span><br><span class="line">5) &quot;name2&quot;</span><br><span class="line">6) &quot;xiaohao&quot;</span><br><span class="line">7) &quot;email2&quot;</span><br><span class="line">8) &quot;xiaohao@163.com&quot;</span><br></pre></td></tr></table></figure>

<h3 id="实战场景-3"><a href="#实战场景-3" class="headerlink" title="实战场景"></a><strong>实战场景</strong></h3><ul>
<li><strong>缓存</strong>： 能直观，相比 string 更节省空间，的维护缓存信息，如用户信息，视频信息等。</li>
</ul>
<h2 id="Zset-有序集合"><a href="#Zset-有序集合" class="headerlink" title="Zset 有序集合"></a>Zset 有序集合</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 有序集合和集合一样也是 string 类型元素的集合,且不允许重复的成员。不同的是每个元素都会关联一个 double 类型的分数。redis 正是通过分数来为集合中的成员进行从小到大的排序。</div>
有序集合的成员是唯一的, 但分数(score)却可以重复。有序集合是通过两种数据结构实现：

<ol>
<li><strong>压缩列表(ziplist)</strong>: ziplist 是为了提高存储效率而设计的一种特殊编码的双向链表。它可以存储字符串或者整数，存储整数时是采用整数的二进制而不是字符串形式存储。它能在 O(1)的时间复杂度下完成 list 两端的 push 和 pop 操作。但是因为每次操作都需要重新分配 ziplist 的内存，所以实际复杂度和 ziplist 的内存使用量相关</li>
<li><strong>跳跃表（zSkiplist)</strong>: 跳跃表的性能可以保证在查找，删除，添加等操作的时候在对数期望时间内完成，这个性能是可以和平衡树来相比较的，而且在实现方面比平衡树要优雅，这是采用跳跃表的主要原因。跳跃表的复杂度是 O(log(n))。</li>
</ol>
<ul>
<li><strong>图例</strong></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046795662-27f20f36-efd9-477c-89e8-7c313a70203d.png#averageHue=%23efefef&clientId=u429e2987-0087-4&from=paste&height=271&id=ucd440152&name=image.png&originHeight=542&originWidth=730&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=112382&status=done&style=none&taskId=ua48b7096-4a6b-42d1-9e90-c5b381a661a&title=&width=365" alt="image.png"></p>
<h3 id="命令使用-4"><a href="#命令使用-4" class="headerlink" title="命令使用"></a><strong>命令使用</strong></h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>ZADD</td>
<td>将一个带有给定分值的成员添加到有序集合里面</td>
<td>ZADD zset-key 178 member1</td>
</tr>
<tr>
<td>ZRANGE</td>
<td>根据元素在有序集合中所处的位置，从有序集合中获取多个元素</td>
<td>ZRANGE zset-key 0-1 withccores</td>
</tr>
<tr>
<td>ZREM</td>
<td>如果给定元素成员存在于有序集合中，那么就移除这个元素</td>
<td>ZREM zset-key member1</td>
</tr>
</tbody></table>
<p>更多命令请参考这里 <a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-sorted-sets.html">https://www.runoob.com/redis/redis-sorted-sets.html</a></p>
<h3 id="命令执行-4"><a href="#命令执行-4" class="headerlink" title="命令执行"></a><strong>命令执行</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd myscoreset 100 hao 90 xiaohao</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; ZRANGE myscoreset 0 -1</span><br><span class="line">1) &quot;xiaohao&quot;</span><br><span class="line">2) &quot;hao&quot;</span><br><span class="line">127.0.0.1:6379&gt; ZSCORE myscoreset hao</span><br><span class="line">&quot;100&quot;</span><br></pre></td></tr></table></figure>

<h3 id="实战场景-4"><a href="#实战场景-4" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>排行榜</strong>：有序集合经典使用场景。例如小说视频等网站需要对用户上传的小说视频做排行榜，榜单可以按照用户关注数，更新时间，字数等打分，做排行。</li>
</ul>
<h1 id="3-种特殊类型"><a href="#3-种特殊类型" class="headerlink" title="3 种特殊类型"></a>3 种特殊类型</h1><h2 id="HyperLogLogs（基数统计）"><a href="#HyperLogLogs（基数统计）" class="headerlink" title="HyperLogLogs（基数统计）"></a>HyperLogLogs（基数统计）</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 2.8.9 版本更新了 Hyperloglog 数据结构！</div>

<ul>
<li><strong>什么是基数？</strong></li>
</ul>
<p>举个例子，A &#x3D; {1, 2, 3, 4, 5}， B &#x3D; {3, 5, 6, 7, 9}；那么基数（不重复的元素）&#x3D; 1, 2, 4, 6, 7, 9； （允许容错，即可以接受一定误差）</p>
<ul>
<li><strong>HyperLogLogs 基数统计用来解决什么问题</strong>？</li>
</ul>
<p>这个结构可以非常省内存的去统计各种计数，比如注册 IP 数、每日访问 IP 数、页面实时 UV、在线用户数，共同好友数等。</p>
<ul>
<li><strong>它的优势体现在哪</strong>？</li>
</ul>
<p>一个大型的网站，每天 IP 比如有 100 万，粗算一个 IP 消耗 15 字节，那么 100 万个 IP 就是 15M。而 HyperLogLog 在 Redis 中每个键占用的内容都是 12K，理论存储近似接近 2^64 个值，不管存储的内容是什么，它一个基于基数估算的算法，只能比较准确的估算出基数，可以使用少量固定的内存去存储并识别集合中的唯一元素。而且这个估算的基数并不一定准确，是一个带有 0.81% 标准错误的近似值（对于可以接受一定容错的业务场景，比如 IP 数统计，UV 等，是可以忽略不计的）。</p>
<ul>
<li><strong>相关命令使用</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd key1 a b c d e f g h i	# 创建第一组元素</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount key1					# 统计元素的基数数量</span><br><span class="line">(integer) 9</span><br><span class="line">127.0.0.1:6379&gt; pfadd key2 c j k l m e g a		# 创建第二组元素</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount key2</span><br><span class="line">(integer) 8</span><br><span class="line">127.0.0.1:6379&gt; pfmerge key3 key1 key2			# 合并两组：key1 key2 -&gt; key3 并集</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; pfcount key3</span><br><span class="line">(integer) 13</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Bitmap-（位存储）"><a href="#Bitmap-（位存储）" class="headerlink" title="Bitmap （位存储）"></a>Bitmap （位存储）</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Bitmap 即位图数据结构，都是操作二进制位来进行记录，只有0 和 1 两个状态。</div>

<ul>
<li><strong>用来解决什么问题</strong>？</li>
</ul>
<p>比如：统计用户信息，活跃，不活跃！ 登录，未登录！ 打卡，不打卡！ <strong>两个状态的，都可以使用 Bitmaps</strong>！<br>如果存储一年的打卡状态需要多少内存呢？ 365 天 &#x3D; 365 bit 1 字节 &#x3D; 8bit 46 个字节左右！</p>
<ul>
<li><strong>相关命令使用</strong></li>
</ul>
<p>使用 bitmap 来记录 周一到周日的打卡！ 周一：1 周二：0 周三：0 周四：1 ……</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit sign 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 2 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 4 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 5 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 6 1</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>查看某一天是否有打卡！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getbit sign 3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit sign 5</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>统计操作，统计 打卡的天数！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitcount sign # 统计这周的打卡记录，就可以看到是否有全勤！</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<h2 id="geospatial-地理位置"><a href="#geospatial-地理位置" class="headerlink" title="geospatial (地理位置)"></a>geospatial (地理位置)</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 的 Geo 在 Redis 3.2 版本就推出了! 这个功能可以推算地理位置的信息: 两地之间的距离, 方圆几里的人</div>

<h3 id="geoadd-添加地理位置"><a href="#geoadd-添加地理位置" class="headerlink" title="geoadd(添加地理位置)"></a>geoadd(添加地理位置)</h3><p><strong>规则</strong><br>两级无法直接添加，我们一般会下载城市数据(这个网址可以查询 GEO： <a target="_blank" rel="noopener" href="http://www.jsons.cn/lngcode)%EF%BC%81">http://www.jsons.cn/lngcode)！</a></p>
<ul>
<li>有效的经度从-180 度到 180 度。</li>
<li>有效的纬度从-85.05112878 度到 85.05112878 度。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当坐标位置超出上述指定范围时，该命令将会返回一个错误。</span></span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 39.90 116.40 beijin</span><br><span class="line">(error) ERR invalid longitude,latitude pair 39.900000,116.400000</span><br></pre></td></tr></table></figure>

<h3 id="geopos-获取指定的成员的经度和纬度"><a href="#geopos-获取指定的成员的经度和纬度" class="headerlink" title="geopos(获取指定的成员的经度和纬度)"></a>geopos(获取指定的成员的经度和纬度)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:city taiyuan manjing</span><br><span class="line">1) 1) &quot;112.54999905824661255&quot;</span><br><span class="line">   1) &quot;37.86000073876942196&quot;</span><br><span class="line">2) 1) &quot;118.75999957323074341&quot;</span><br><span class="line">   1) &quot;32.03999960287850968&quot;</span><br></pre></td></tr></table></figure>

<p>获得当前定位, 一定是一个坐标值!</p>
<h3 id="geodist"><a href="#geodist" class="headerlink" title="geodist"></a>geodist</h3><blockquote>
<p>如果不存在, 返回空</p>
</blockquote>
<p>单位如下</p>
<ul>
<li>m</li>
<li>km</li>
<li>mi 英里</li>
<li>ft 英尺</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist china:city taiyuan shenyang m</span><br><span class="line">&quot;1026439.1070&quot;</span><br><span class="line">127.0.0.1:6379&gt; geodist china:city taiyuan shenyang km</span><br><span class="line">&quot;1026.4391&quot;</span><br></pre></td></tr></table></figure>

<h3 id="georadius"><a href="#georadius" class="headerlink" title="georadius"></a>georadius</h3><blockquote>
<p>附近的人 &#x3D;&#x3D;&gt; 获得所有附近的人的地址, 定位, 通过半径来查询</p>
</blockquote>
<p>获得指定数量的人</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km			以 100,30 这个坐标为中心, 寻找半径为1000km的城市</span><br><span class="line">1) &quot;xian&quot;</span><br><span class="line">2) &quot;hangzhou&quot;</span><br><span class="line">3) &quot;manjing&quot;</span><br><span class="line">4) &quot;taiyuan&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 500 km</span><br><span class="line">1) &quot;xian&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 500 km withdist</span><br><span class="line">1) 1) &quot;xian&quot;</span><br><span class="line">   2) &quot;483.8340&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withcoord withdist count 2</span><br><span class="line">1) 1) &quot;xian&quot;</span><br><span class="line">   2) &quot;483.8340&quot;</span><br><span class="line">   3) 1) &quot;108.96000176668167114&quot;</span><br><span class="line">      2) &quot;34.25999964418929977&quot;</span><br><span class="line">2) 1) &quot;manjing&quot;</span><br><span class="line">   2) &quot;864.9816&quot;</span><br><span class="line">   3) 1) &quot;118.75999957323074341&quot;</span><br><span class="line">      2) &quot;32.03999960287850968&quot;</span><br></pre></td></tr></table></figure>

<p>参数 key 经度 纬度 半径 单位 [显示结果的经度和纬度] [显示结果的距离] [显示的结果的数量]</p>
<h3 id="georadiusbymember"><a href="#georadiusbymember" class="headerlink" title="georadiusbymember"></a>georadiusbymember</h3><blockquote>
<p>显示与指定成员一定半径范围内的其他成员</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city taiyuan 1000 km</span><br><span class="line">1) &quot;manjing&quot;</span><br><span class="line">2) &quot;taiyuan&quot;</span><br><span class="line">3) &quot;xian&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city taiyuan 1000 km withcoord withdist count 2</span><br><span class="line">1) 1) &quot;taiyuan&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) 1) &quot;112.54999905824661255&quot;</span><br><span class="line">      2) &quot;37.86000073876942196&quot;</span><br><span class="line">2) 1) &quot;xian&quot;</span><br><span class="line">   2) &quot;514.2264&quot;</span><br><span class="line">   3) 1) &quot;108.96000176668167114&quot;</span><br><span class="line">      2) &quot;34.25999964418929977&quot;</span><br></pre></td></tr></table></figure>

<p>参数与 georadius 一样</p>
<h3 id="geohash-较少使用"><a href="#geohash-较少使用" class="headerlink" title="geohash(较少使用)"></a>geohash(较少使用)</h3><blockquote>
<p>该命令返回 11 个字符的 hash 字符串</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash china:city taiyuan shenyang</span><br><span class="line">1) &quot;ww8p3hhqmp0&quot;</span><br><span class="line">2) &quot;wxrvb9qyxk0&quot;</span><br></pre></td></tr></table></figure>

<p>将二维的经纬度转换为一维的字符串, 如果两个字符串越接近, 则距离越近</p>
<h3 id="底层"><a href="#底层" class="headerlink" title="底层"></a>底层</h3><blockquote>
<p>geo 底层的实现原理实际上就是 Zset, 我们可以通过 Zset 命令来操作 geo</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; type china:city</span><br><span class="line">zset</span><br></pre></td></tr></table></figure>

<p>查看全部元素 删除指定的元素</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1 withscores</span><br><span class="line"> 1) &quot;xian&quot;</span><br><span class="line"> 2) &quot;4040115445396757&quot;</span><br><span class="line"> 3) &quot;hangzhou&quot;</span><br><span class="line"> 4) &quot;4054133997236782&quot;</span><br><span class="line"> 5) &quot;manjing&quot;</span><br><span class="line"> 6) &quot;4066006694128997&quot;</span><br><span class="line"> 7) &quot;taiyuan&quot;</span><br><span class="line"> 8) &quot;4068216047500484&quot;</span><br><span class="line"> 9) &quot;shenyang&quot;</span><br><span class="line">1)  &quot;4072519231994779&quot;</span><br><span class="line">2)  &quot;shengzhen&quot;</span><br><span class="line">3)  &quot;4154606886655324&quot;</span><br><span class="line">127.0.0.1:6379&gt; zrem china:city manjing</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1</span><br><span class="line">1) &quot;xian&quot;</span><br><span class="line">2) &quot;hangzhou&quot;</span><br><span class="line">3) &quot;taiyuan&quot;</span><br><span class="line">4) &quot;shenyang&quot;</span><br><span class="line">5) &quot;shengzhen&quot;</span><br></pre></td></tr></table></figure>

<h1 id="Stream-消息队列"><a href="#Stream-消息队列" class="headerlink" title="Stream 消息队列"></a>Stream 消息队列</h1><h2 id="为什么会设计-Stream"><a href="#为什么会设计-Stream" class="headerlink" title="为什么会设计 Stream"></a>为什么会设计 Stream</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis5.0 中还增加了一个数据结构Stream，从字面上看是流类型，但其实从功能上看，应该是Redis对消息队列（MQ，Message Queue）的完善实现。</div>
用过Redis做消息队列的都了解，基于Reids的消息队列实现有很多种，例如：

<ul>
<li><strong>PUB&#x2F;SUB，订阅&#x2F;发布模式</strong><ul>
<li>但是发布订阅模式是无法持久化的，如果出现网络断开、Redis 宕机等，消息就会被丢弃；</li>
</ul>
</li>
<li>基于<strong>List LPUSH+BRPOP</strong> 或者 <strong>基于 Sorted-Set</strong>的实现<ul>
<li>支持了持久化，但是不支持多播，分组消费等</li>
</ul>
</li>
</ul>
<p>为什么上面的结构无法满足广泛的 MQ 场景？ 这里便引出一个核心的问题：如果我们期望设计一种数据结构来实现消息队列，最重要的就是要理解<strong>设计一个消息队列需要考虑什么</strong>？初步的我们很容易想到</p>
<ul>
<li>消息的生产</li>
<li>消息的消费<ul>
<li>单播和多播（多对多）</li>
<li>阻塞和非阻塞读取</li>
</ul>
</li>
<li>消息有序性</li>
<li>消息的持久化</li>
</ul>
<p>其它还要考虑啥嗯？借助美团技术团队的一篇文章，<a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/07/01/mq-design.html">消息队列设计精要(opens new window)</a> 中的图<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668048056883-714411f5-c41c-4e46-8ae4-143657cf13a0.png#averageHue=%23ece7e0&clientId=u429e2987-0087-4&from=paste&id=u8cfe1626&name=image.png&originHeight=461&originWidth=490&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=53767&status=done&style=none&taskId=u2a46a21b-4487-4474-be01-a94c1391f8b&title=" alt="image.png"><br><strong>我们不妨看看 Redis 考虑了哪些设计</strong>？</p>
<ul>
<li>消息 ID 的序列化生成</li>
<li>消息遍历</li>
<li>消息的阻塞和非阻塞读取</li>
<li>消息的分组消费</li>
<li>未完成消息的处理</li>
<li>消息队列监控</li>
<li>…<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">这也是我们需要理解Stream的点，但是结合上面的图，我们也应该理解Redis Stream也是一种超轻量MQ并没有完全实现消息队列所有设计要点，这决定着它适用的场景。</div>
详细内容建议看这篇[Stream详细用法](https://pdai.tech/md/db/nosql-redis/db-redis-data-type-stream.html)</li>
</ul>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>Redis 事务的本质是一组命令的集合。事务支持一次执行多个命令，一个事务中所有命令都会被序列化。在事务执行过程，会按照顺序串行化执行队列中的命令，其他客户端提交的命令请求不会插入到事务执行命令序列中。</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">总结说：redis事务就是一次性、顺序性、排他性的执行一个队列中的一系列命令。</div>

<h2 id="Redis-事务相关命令和使用"><a href="#Redis-事务相关命令和使用" class="headerlink" title="Redis 事务相关命令和使用"></a>Redis 事务相关命令和使用</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">MULTI 、 EXEC 、 DISCARD 和 WATCH 是 Redis 事务相关的命令。</div>

<ul>
<li><strong>MULTI</strong> ：开启事务，redis 会将后续的命令逐个放入队列中，然后使用 EXEC 命令来原子化执行这个命令系列。</li>
<li><strong>EXEC</strong>：执行事务中的所有操作命令。</li>
<li><strong>DISCARD</strong>：取消事务，放弃执行事务块中的所有命令。</li>
<li><strong>WATCH</strong>：监视一个或多个 key,如果事务在执行前，这个 key(或多个 key)被其他命令修改，则事务被中断，不会执行事务中的任何命令。</li>
<li><strong>UNWATCH</strong>：取消 WATCH 对所有 key 的监视。</li>
</ul>
<h3 id="标准的事务执行"><a href="#标准的事务执行" class="headerlink" title="标准的事务执行"></a>标准的事务执行</h3><p>给 k1、k2 分别赋值，在事务中修改 k1、k2，执行事务后，查看 k1、k2 值都被修改。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;11&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;22&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h3 id="事务取消"><a href="#事务取消" class="headerlink" title="事务取消"></a>事务取消</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 33</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 34</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; DISCARD</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h3 id="事务出现错误的处理"><a href="#事务出现错误的处理" class="headerlink" title="事务出现错误的处理"></a>事务出现错误的处理</h3><ul>
<li><strong>语法错误（编译器错误）</strong></li>
</ul>
<p>在开启事务后，修改 k1 值为 11，k2 值为 22，但 k2 语法错误，最终导致事务提交失败，k1、k2 保留原值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; sets k2 22</span><br><span class="line">(error) ERR unknown command `sets`, with args beginning with: `k2`, `22`,</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Redis 类型错误（运行时错误）</strong></li>
</ul>
<p>在开启事务后，修改 k1 值为 11，k2 值为 22，但将 k2 的类型作为 List，在运行时检测类型错误，最终导致事务提交失败，此时事务并没有回滚，而是跳过错误命令继续执行， 结果 k1 值改变、k2 保留原值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; lpush k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) (error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;11&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="WATCH-命令"><a href="#WATCH-命令" class="headerlink" title="WATCH 命令"></a>WATCH 命令</h2><p>WATCH 命令可以为 Redis 事务提供 check-and-set （CAS）行为。</p>
<ul>
<li><strong>CAS? 乐观锁</strong>？Redis 官方的例子帮你理解</li>
</ul>
<p>被 WATCH 的键会被监视，并会发觉这些键是否被改动过了。 如果有至少一个被监视的键在 EXEC 执行之前被修改了， 那么整个事务都会被取消， EXEC 返回 nil-reply 来表示事务已经失败。<br>举个例子， 假设我们需要原子性地为某个值进行增 1 操作（假设 INCR 不存在）。<br>首先我们可能会这样做：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val = GET mykey</span><br><span class="line">val = val + 1</span><br><span class="line">SET mykey $val</span><br></pre></td></tr></table></figure>

<p>上面的这个实现在只有一个客户端的时候可以执行得很好。 但是， 当多个客户端同时对同一个键进行这样的操作时， 就会产生竞争条件。举个例子， 如果客户端 A 和 B 都读取了键原来的值， 比如 10 ， 那么两个客户端都会将键的值设为 11 ， 但正确的结果应该是 12 才对。<br>有了 WATCH ，我们就可以轻松地解决这类问题了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WATCH mykey</span><br><span class="line">val = GET mykey</span><br><span class="line">val = val + 1</span><br><span class="line">MULTI</span><br><span class="line">SET mykey $val</span><br><span class="line">EXEC</span><br></pre></td></tr></table></figure>

<p>使用上面的代码， 如果在 WATCH 执行之后， EXEC 执行之前， 有其他客户端修改了 mykey 的值， 那么当前客户端的事务就会失败。 程序需要做的， 就是不断重试这个操作， 直到没有发生碰撞为止。<br>这种形式的锁被称作乐观锁， 它是一种非常强大的锁机制。 并且因为大多数情况下， 不同的客户端会访问不同的键， 碰撞的情况一般都很少， 所以通常并不需要进行重试。</p>
<ul>
<li><strong>watch 是如何监视实现的呢</strong>？</li>
</ul>
<p>Redis 使用 WATCH 命令来决定事务是继续执行还是回滚，那就需要在 MULTI 之前使用 WATCH 来监控某些键值对，然后使用 MULTI 命令来开启事务，执行对数据结构操作的各种命令，此时这些命令入队列。<br>当使用 EXEC 执行事务时，首先会比对 WATCH 所监控的键值对，如果没发生改变，它会执行事务队列中的命令，提交事务；如果发生变化，将不会执行事务中的任何命令，同时事务回滚。当然无论是否回滚，Redis 都会取消执行事务前的 WATCH 命令。</p>
<ul>
<li><strong>watch 命令实现监视</strong></li>
</ul>
<p>在事务开始前用 WATCH 监控 k1，之后修改 k1 为 11，说明事务开始前 k1 值被改变，MULTI 开始事务，修改 k1 值为 12，k2 为 22，执行 EXEC，发回 nil，说明事务回滚；查看下 k1、k2 的值都没有被事务中的命令所改变。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; WATCH k1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 12</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;11&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>unwatch 取消监视</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; WATCH k1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; UNWATCH</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 12</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;12&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;22&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="为什么-Redis-不支持回滚？"><a href="#为什么-Redis-不支持回滚？" class="headerlink" title="为什么 Redis 不支持回滚？"></a>为什么 Redis 不支持回滚？</h2><p>如果你有使用关系式数据库的经验， 那么 “<strong>Redis 在事务失败时不进行回滚，而是继续执行余下的命令</strong>”这种做法可能会让你觉得有点奇怪。<br>以下是这种做法的优点：</p>
<ul>
<li>Redis 命令只会因为错误的语法而失败（并且这些问题不能在入队时发现），或是命令用在了错误类型的键上面：这也就是说，从实用性的角度来说，失败的命令是由编程错误造成的，而这些错误应该在开发的过程中被发现，而不应该出现在生产环境中。</li>
<li>因为不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速。</li>
</ul>
<p>有种观点认为 Redis 处理事务的做法会产生 bug ， 然而需要注意的是， 在通常情况下， <strong>回滚并不能解决编程错误带来的问题</strong>。 举个例子， 如果你本来想通过 INCR 命令将键的值加上 1 ， 却不小心加上了 2 ， 又或者对错误类型的键执行了 INCR ， 回滚是没有办法处理这些情况的。</p>
<h2 id="如何理解-Redis-与事务的-ACID？"><a href="#如何理解-Redis-与事务的-ACID？" class="headerlink" title="如何理解 Redis 与事务的 ACID？"></a>如何理解 Redis 与事务的 ACID？</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">一般来说，事务有四个性质称为ACID，分别是原子性，一致性，隔离性和持久性。</div>

<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><ul>
<li><strong>为什么需要持久化</strong>？</li>
</ul>
<p>Redis 是个基于内存的数据库。那服务一旦宕机，内存中的数据将全部丢失。通常的解决方案是从后端数据库恢复这些数据，但后端数据库有性能瓶颈，如果是大数据量的恢复，1、会对数据库带来巨大的压力，2、数据库的性能不如 Redis。导致程序响应慢。所以对 Redis 来说，实现数据的持久化，避免从后端数据库中恢复数据，是至关重要的。</p>
<h2 id="RDB-持久化"><a href="#RDB-持久化" class="headerlink" title="RDB 持久化"></a>RDB 持久化</h2><p>RDB 就是 Redis DataBase 的缩写，中文名为快照&#x2F;内存快照，RDB 持久化是把当前进程数据生成快照保存到磁盘上的过程，由于是某一时刻的快照，那么快照中的值要早于或者等于内存中的值。</p>
<h3 id="触发方式"><a href="#触发方式" class="headerlink" title="触发方式"></a>触发方式</h3><p>触发 rdb 持久化的方式有 2 种，分别是<strong>手动触发</strong>和<strong>自动触发</strong>。</p>
<h4 id="手动触发"><a href="#手动触发" class="headerlink" title="手动触发"></a>手动触发</h4><p>手动触发分别对应 save 和 bgsave 命令</p>
<h4 id="自动触发"><a href="#自动触发" class="headerlink" title="自动触发"></a>自动触发</h4><p>在以下 4 种情况时会自动触发</p>
<ul>
<li>redis.conf 中配置 save m n，即在 m 秒内有 n 次修改时，自动触发 bgsave 生成 rdb 文件；</li>
<li>主从复制时，从节点要从主节点进行全量复制时也会触发 bgsave 操作，生成当时的快照发送到从节点；</li>
<li>执行 debug reload 命令重新加载 redis 时也会触发 bgsave 操作；</li>
<li>默认情况下执行 shutdown 命令时，如果没有开启 aof 持久化，那么也会触发 bgsave 操作；</li>
</ul>
<h3 id="redis-conf-中配置-RDB"><a href="#redis-conf-中配置-RDB" class="headerlink" title="redis.conf 中配置 RDB"></a>redis.conf 中配置 RDB</h3><p><strong>快照周期</strong>：内存快照虽然可以通过技术人员手动执行 SAVE 或 BGSAVE 命令来进行，但生产环境下多数情况都会设置其周期性执行条件。</p>
<ul>
<li><strong>Redis 中默认的周期新设置</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">周期性执行条件的设置格式为</span></span><br><span class="line">save &lt;seconds&gt; &lt;changes&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认的设置为：</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下设置方式为关闭RDB快照功能</span></span><br><span class="line">save &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>以上三项默认信息设置代表的意义是：</p>
<ul>
<li>如果 900 秒内有 1 条 Key 信息发生变化，则进行快照；</li>
<li>如果 300 秒内有 10 条 Key 信息发生变化，则进行快照；</li>
<li>如果 60 秒内有 10000 条 Key 信息发生变化，则进行快照。读者可以按照这个规则，根据自己的实际请求压力进行设置调整。</li>
<li><strong>其它相关配置</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件名称</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件保存路径</span></span><br><span class="line">dir /home/work/app/redis/data/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果持久化出错，主进程是否停止写入</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否压缩</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入时是否检查</span></span><br><span class="line">rdbchecksum yes</span><br></pre></td></tr></table></figure>

<p><strong>dbfilename</strong>: RDB 文件在磁盘上的名称。<br><strong>dir</strong>: RDB 文件的存储路径。默认设置为“.&#x2F;”，也就是 Redis 服务的主目录。<br><strong>stop-writes-on-bgsave-error</strong>：上文提到的在快照进行过程中，主进程照样可以接受客户端的任何写操作的特性，是指在快照操作正常的情况下。如果快照操作出现异常（例如操作系统用户权限不够、磁盘空间写满等等）时，Redis 就会禁止写操作。这个特性的主要目的是使运维人员在第一时间就发现 Redis 的运行错误，并进行解决。一些特定的场景下，您可能需要对这个特性进行配置，这时就可以调整这个参数项。该参数项默认情况下值为 yes，如果要关闭这个特性，指定即使出现快照错误 Redis 一样允许写操作，则可以将该值更改为 no。<br><strong>rdbcompression</strong>：该属性将在字符串类型的数据被快照到磁盘文件时，启用 LZF 压缩算法。Redis 官方的建议是请保持该选项设置为 yes，因为“it’s almost always a win”。<br><strong>rdbchecksum</strong>：从 RDB 快照功能的 version 5 版本开始，一个 64 位的 CRC 冗余校验编码会被放置在 RDB 文件的末尾，以便对整个 RDB 文件的完整性进行验证。这个功能大概会多损失 10%左右的性能，但获得了更高的数据可靠性。所以如果您的 Redis 服务需要追求极致的性能，就可以将这个选项设置为 no。</p>
<h3 id="RDB-优缺点"><a href="#RDB-优缺点" class="headerlink" title="RDB 优缺点"></a>RDB 优缺点</h3><ul>
<li><strong>优点</strong><ul>
<li>RDB 文件是某个时间节点的快照，默认使用 LZF 算法进行压缩，压缩后的文件体积远远小于内存大小，适用于备份、全量复制等场景；</li>
<li>Redis 加载 RDB 文件恢复数据要远远快于 AOF 方式；</li>
</ul>
</li>
<li><strong>缺点</strong><ul>
<li>RDB 方式实时性不够，无法做到秒级的持久化；</li>
<li>每次调用 bgsave 都需要 fork 子进程，fork 子进程属于重量级操作，频繁执行成本较高；</li>
<li>RDB 文件是二进制的，没有可读性，AOF 文件在了解其结构的情况下可以手动修改或者补全；</li>
<li>版本兼容 RDB 文件问题；</li>
</ul>
</li>
</ul>
<p>针对 RDB 不适合实时持久化的问题，Redis 提供了 AOF 持久化方式来解决</p>
<h2 id="AOF-持久化"><a href="#AOF-持久化" class="headerlink" title="AOF 持久化"></a>AOF 持久化</h2><p>Redis 是“写后”日志，Redis 先执行命令，把数据写入内存，然后才记录日志。日志里记录的是 Redis 收到的每一条命令，这些命令是以文本形式保存。PS: 大多数的数据库采用的是写前日志（WAL），例如 MySQL，通过写前日志和两阶段提交，实现数据和逻辑的一致性。<br>而 AOF 日志采用写后日志，即<strong>先写内存，后写日志</strong>。<br><strong>为什么采用写后日志</strong>？<br>Redis 要求高性能，采用写日志有两方面好处：</p>
<ul>
<li><strong>避免额外的检查开销</strong>：Redis 在向 AOF 里面记录日志的时候，并不会先去对这些命令进行语法检查。所以，如果先记日志再执行命令的话，日志中就有可能记录了错误的命令，Redis 在使用日志恢复数据时，就可能会出错。</li>
<li>不会阻塞当前的写操作</li>
</ul>
<p>但这种方式存在潜在风险：</p>
<ul>
<li>如果命令执行完成，写日志之前宕机了，会丢失数据。</li>
<li>主线程写磁盘压力大，导致写盘慢，阻塞后续操作。</li>
</ul>
<h3 id="如何实现-AOF"><a href="#如何实现-AOF" class="headerlink" title="如何实现 AOF"></a>如何实现 AOF</h3><p>AOF 日志记录 Redis 的每个写命令，步骤分为：命令追加（append）、文件写入（write）和文件同步（sync）。</p>
<ul>
<li><strong>命令追加</strong> 当 AOF 持久化功能打开了，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器的 aof_buf 缓冲区。</li>
<li><strong>文件写入和同步</strong> 关于何时将 aof_buf 缓冲区的内容写入 AOF 文件中，Redis 提供了三种写回策略</li>
</ul>
<p>Always，同步写回：每个写命令执行完，立马同步地将日志写回磁盘；<br>Everysec，每秒写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘；<br>No，操作系统控制的写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘。</p>
<ul>
<li><strong>三种写回策略的优缺点</strong></li>
</ul>
<p>上面的三种写回策略体现了一个重要原则：<strong>trade-off</strong>，取舍，指在性能和可靠性保证之间做取舍。</p>
<h3 id="redis-conf-中配置-AOF"><a href="#redis-conf-中配置-AOF" class="headerlink" title="redis.conf 中配置 AOF"></a>redis.conf 中配置 AOF</h3><p>默认情况下，Redis 是没有开启 AOF 的，可以通过配置 redis.conf 文件来开启 AOF 持久化，关于 AOF 的配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendonly参数开启AOF持久化</span></span><br><span class="line">appendonly no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF持久化的文件名，默认是appendonly.aof</span></span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF文件的保存位置和RDB文件的位置相同，都是通过<span class="built_in">dir</span>参数设置的</span></span><br><span class="line">dir ./</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同步策略</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync no</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aof重写期间是否同步</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重写触发配置</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载aof出错如何处理</span></span><br><span class="line">aof-load-truncated yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件重写策略</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>

<p>以下是 Redis 中关于 AOF 的主要配置信息：<br><strong>appendonly</strong>：默认情况下 AOF 功能是关闭的，将该选项改为 yes 以便打开 Redis 的 AOF 功能。<br><strong>appendfilename</strong>：这个参数项很好理解了，就是 AOF 文件的名字。<br><strong>appendfsync</strong>：这个参数项是 AOF 功能最重要的设置项之一，主要用于设置“真正执行”操作命令向 AOF 文件中同步的策略。<br>什么叫“真正执行”呢？还记得 Linux 操作系统对磁盘设备的操作方式吗？ 为了保证操作系统中 I&#x2F;O 队列的操作效率，应用程序提交的 I&#x2F;O 操作请求一般是被放置在 linux Page Cache 中的，然后再由 Linux 操作系统中的策略自行决定正在写到磁盘上的时机。而 Redis 中有一个 fsync()函数，可以将 Page Cache 中待写的数据真正写入到物理设备上，而缺点是频繁调用这个 fsync()函数干预操作系统的既定策略，可能导致 I&#x2F;O 卡顿的现象频繁 。</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">与上节对应，appendfsync参数项可以设置三个值，分别是：always、everysec、no，默认的值为everysec。</div>
**no-appendfsync-on-rewrite**：always和everysec的设置会使真正的I/O操作高频度的出现，甚至会出现长时间的卡顿情况，这个问题出现在操作系统层面上，所有靠工作在操作系统之上的Redis是没法解决的。为了尽量缓解这个情况，Redis提供了这个设置项，保证在完成fsync函数调用时，不会将这段时间内发生的命令操作放入操作系统的Page Cache（这段时间Redis还在接受客户端的各种写操作命令）。
**auto-aof-rewrite-percentage**：上文说到在生产环境下，技术人员不可能随时随地使用“BGREWRITEAOF”命令去重写AOF文件。所以更多时候我们需要依靠Redis中对AOF文件的自动重写策略。Redis中对触发自动重写AOF文件的操作提供了两个设置：auto-aof-rewrite-percentage表示如果当前AOF文件的大小超过了上次重写后AOF文件的百分之多少后，就再次开始重写AOF文件。例如该参数值的默认设置值为100，意思就是如果AOF文件的大小超过上次AOF文件重写后的1倍，就启动重写操作。
**auto-aof-rewrite-min-size**：参考auto-aof-rewrite-percentage选项的介绍，auto-aof-rewrite-min-size设置项表示启动AOF文件重写操作的AOF文件最小大小。如果AOF文件大小低于这个值，则不会触发重写操作。注意，auto-aof-rewrite-percentage和auto-aof-rewrite-min-size只是用来控制Redis中自动对AOF文件进行重写的情况，如果是技术人员手动调用“BGREWRITEAOF”命令，则不受这两个限制条件左右.

<h2 id="从持久化中恢复数据"><a href="#从持久化中恢复数据" class="headerlink" title="从持久化中恢复数据"></a>从持久化中恢复数据</h2><p>其实想要从这些文件中恢复数据，只需要重新启动 Redis 即可.</p>
<h3 id="加载步骤"><a href="#加载步骤" class="headerlink" title="加载步骤"></a>加载步骤</h3><ul>
<li>redis 重启时判断是否开启 aof，如果开启了 aof，那么就优先加载 aof 文件；</li>
<li>如果 aof 存在，那么就去加载 aof 文件，加载成功的话 redis 重启成功，如果 aof 文件加载失败，那么会打印日志表示启动失败，此时可以去修复 aof 文件后重新启动；</li>
<li>若 aof 文件不存在，那么 redis 就会转而去加载 rdb 文件，如果 rdb 文件不存在，redis 直接启动成功；</li>
<li>如果 rdb 文件存在就会去加载 rdb 文件恢复数据，如加载失败则打印日志提示启动失败，如加载成功，那么 redis 重启成功，且使用 rdb 文件恢复数据；</li>
</ul>
<p>那么为什么会优先加载 AOF 呢？因为 AOF 保存的数据更完整，通过上面的分析我们知道 AOF 基本上最多损失 1s 的数据。</p>
<h1 id="Node-中使用-Redis"><a href="#Node-中使用-Redis" class="headerlink" title="Node 中使用 Redis"></a>Node 中使用 Redis</h1><p>推荐模块<code>ioredis</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ioredis = <span class="built_in">require</span>(<span class="string">&quot;ioredis&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line"><span class="keyword">const</span> redis = <span class="keyword">new</span> <span class="title function_">ioredis</span>(&#123;</span><br><span class="line">  <span class="attr">port</span>: <span class="number">6379</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 操作Redis数据库</span></span><br><span class="line"><span class="comment">// redis.set(&#x27;far&#x27;, &#x27;bar&#x27;, (err, ret) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     if(err) &#123;</span></span><br><span class="line"><span class="comment">//         console.log(&#x27;写入失败&#x27;, err);</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;写入成功&#x27;, ret);</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持promise</span></span><br><span class="line">redis</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&quot;far&quot;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">ret</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ret);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取失败&quot;</span>, err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="使用-pipeline-管道"><a href="#使用-pipeline-管道" class="headerlink" title="使用 pipeline 管道"></a>使用 pipeline 管道</h2><p>存在多条命令时,使用<code>pipeline</code>可以提高效率.使用<code>exec</code>结束 pipeline 就会给数据库发送请求.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pipeline = redis.<span class="title function_">pipeline</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">      pipeline.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;i&#125;</span>-foo`</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 结束命令就执行</span></span><br><span class="line">    <span class="keyword">await</span> pipeline.<span class="title function_">exec</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 甚至能够链式调用命令</span></span><br><span class="line">redis</span><br><span class="line">  .<span class="title function_">pipeline</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>)</span><br><span class="line">  .<span class="title function_">del</span>(<span class="string">&quot;cc&quot;</span>)</span><br><span class="line">  .<span class="title function_">exec</span>(<span class="keyword">function</span> (<span class="params">err, results</span>) &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// `exec` 也是返回的promise</span></span><br><span class="line"><span class="keyword">var</span> promise = redis.<span class="title function_">pipeline</span>().<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>).<span class="title function_">get</span>(<span class="string">&quot;foo&quot;</span>).<span class="title function_">exec</span>();</span><br><span class="line">promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">  <span class="comment">// result === [[null, &#x27;OK&#x27;], [null, &#x27;bar&#x27;]]</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>每个链式命令也可以有一个回调，当命令得到回复时将调用它</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">  .<span class="title function_">pipeline</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&quot;foo&quot;</span>, <span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">    <span class="comment">// result === &#x27;bar&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">exec</span>(<span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">    <span class="comment">// result[1][1] === &#x27;bar&#x27;</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>除了单独向管道队列添加命令外，还可以将一组命令和参数传递给构造函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">  .<span class="title function_">pipeline</span>([</span><br><span class="line">    [<span class="string">&quot;set&quot;</span>, <span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;foo&quot;</span>],</span><br><span class="line">  ])</span><br><span class="line">  .<span class="title function_">exec</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>查看管道中有多少命令</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="title function_">pipeline</span>().<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>).<span class="title function_">get</span>(<span class="string">&quot;foo&quot;</span>).<span class="property">length</span>; <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<h2 id="事务-1"><a href="#事务-1" class="headerlink" title="事务"></a>事务</h2><p>调用<code>multi</code>时会自动创建<code>pipeline</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ret = <span class="keyword">await</span> redis.<span class="title function_">multi</span>().<span class="title function_">set</span>(<span class="string">&quot;Jack&quot;</span>, <span class="number">100</span>).<span class="title function_">set</span>(<span class="string">&quot;Tom&quot;</span>, <span class="number">200</span>).<span class="title function_">exec</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ret);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="错误调试"><a href="#错误调试" class="headerlink" title="错误调试"></a>错误调试</h2><p><code>showFriendlyErrorStack</code>: 设置为 true 会在报错时提供错误信息.建议只在调试时开启.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/mangoDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/mangoDB/" class="post-title-link" itemprop="url">mangoDB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:07:43" itemprop="dateCreated datePublished" datetime="2022-11-08T17:07:43+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:14" itemprop="dateModified" datetime="2023-03-19T18:57:14+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h1><p>不仅仅是 SQL,即非关系型数据库.</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><ol>
<li>键值数据库(Redis,Flare)</li>
</ol>
<p>拥有极高的读写性能,用于处理大量数据的高访问负载,例如日志系统.</p>
<ol start="2">
<li>文档型数据库(mangoDB,CouchDB)</li>
</ol>
<p>满足海量的访问和存储,同时对字段要求不严格,可以随意增删改,适用于网络应用.</p>
<ol start="3">
<li>列存储型数据库(Cassandra,Hbase)</li>
</ol>
<p>查找快,扩展性强,适合用作分布式文件存储系统.(大数据)</p>
<ol start="4">
<li>图存储型数据库(InfoGrid,Heo4J)</li>
</ol>
<p>利用图结构的相关算法来存储实体之间的关系信息,适用于构建社交网络和推荐系统的关系图谱.</p>
<h2 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h2><p>既然 NoSQL 数据库有这么多的优势，那它是否可以直接取代天系型数据库？<br>NoSQL 并不能完全取代关系型数据库，NoSQL 主要被用来处理大量且多元数据的存储及运算问题。在这样的特性差异下，我们该如何选择合适的数据库以解决数据存储与处理问题呢？这里提供以下几点作为判断依据。</p>
<ol>
<li>数据模型的关联性要求</li>
</ol>
<p>NoSQL 适合模型关联性比较低的应用。因此：<br>·如果需要多表关联，则更适合用 RDB<br>·如果对象实体关联少，则更适合用 NoSQL 数据库.<br>其中 MongoDB 可以支持复杂度相对高的数据结构，能够将相关联的数据以文档的方式嵌入，从而减少数据之间的关联操作</p>
<ol start="2">
<li>数据库的性能要求</li>
</ol>
<p>如果数据量多切访问速度至关重要，那么使用 NoSQL 数据库可能是比较合适的。NoSQL 数据库能通过数据的分布存储大幅地提供存储性能。</p>
<ol start="3">
<li>数据的一致性要求</li>
</ol>
<p>NoSQL 数据库有一个缺点：其在事务处理与一致性方面无法与 RDB 相提并论。<br>因此，NoSQL 数据库很难同时满足强一致性与高并发性。如果应用对性能有高要求，则 NoSQL 数据库只能做到数据最终一致。</p>
<ol start="4">
<li>数据的可用性要求</li>
</ol>
<p>考虑到数据不可用可能会造成风险，NoSQL 数据库提供了强大的数据可用性（在一些需要快速反馈信息给使用者的应用中，响应延迟也算某种程度的高可用）。<br><strong>一个项目并非只选择一种数据库，可以将其拆开设计，将需要 RDB 特性的放到 RDB 中管理，而其它数据放到 NoSQL 中管理。</strong></p>
<h1 id="安装-MongoDB"><a href="#安装-MongoDB" class="headerlink" title="安装 MongoDB"></a>安装 MongoDB</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap mongodb/brew</span><br><span class="line">brew install mongodb-community@4.4</span><br></pre></td></tr></table></figure>

<p>然后按照提示修改环境变量,使用<code>source</code>命令重启.</p>
<table>
<thead>
<tr>
<th></th>
<th>英特尔处理器</th>
<th>苹果 M1 处理器</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://link.juejin.cn/?target=https://docs.mongodb.com/v4.4/reference/configuration-options/">配置文件</a></td>
<td>&#x2F;usr&#x2F;local&#x2F;etc&#x2F;mongod.conf</td>
<td>&#x2F;opt&#x2F;homebrew&#x2F;etc&#x2F;mongod.conf</td>
</tr>
<tr>
<td><a href="https://link.juejin.cn/?target=https://docs.mongodb.com/v4.4/reference/configuration-options/%23mongodb-setting-systemLog.path">log directory</a>(log 目录)</td>
<td>&#x2F;usr&#x2F;local&#x2F;var&#x2F;log&#x2F;mongodb</td>
<td>&#x2F;opt&#x2F;homebrew&#x2F;var&#x2F;log&#x2F;mongodb</td>
</tr>
<tr>
<td><a href="https://link.juejin.cn/?target=https://docs.mongodb.com/v4.4/reference/configuration-options/%23mongodb-setting-storage.dbPath">data directory</a>(data 目录)</td>
<td>&#x2F;usr&#x2F;local&#x2F;var&#x2F;mongodb</td>
<td>&#x2F;opt&#x2F;homebrew&#x2F;var&#x2F;mongodb</td>
</tr>
</tbody></table>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brew services start mongodb-community@4.4</span><br><span class="line">// 停止</span><br><span class="line">brew services stop mongodb-community@4.4</span><br><span class="line">// 查看后台服务列表</span><br><span class="line">brew services list</span><br></pre></td></tr></table></figure>

<h1 id="mongo-shell"><a href="#mongo-shell" class="headerlink" title="mongo shell"></a>mongo shell</h1><p>mongoDB 退出的 shell 命令,进入方法,先启动 MongoDB 服务,再输入<code>mongo</code>.<br>shell 中支持基本的 js 语法.</p>
<h2 id="端口号"><a href="#端口号" class="headerlink" title="端口号"></a>端口号</h2><p>默认链接 27017 端口,如果要修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongo --prot 27018</span><br><span class="line">// 连接远程主机</span><br><span class="line">mongo --host mongodb0.example.com:28015</span><br></pre></td></tr></table></figure>

<h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><p>查看数据库: <code>show dbs</code><br>当前数据库: <code>db</code><br>切换&#x2F;创建数据库: <code>use &lt;name&gt;</code><br>查看集合: <code>show collections</code><br>清空数据库: <code>db dropDatabase()</code><br>创建集合: <code>db.xxx.insert(&#123;&#125;)</code><br>查询集合: <code>db.xxx.find()</code><br>删除集合: <code>db.xxx.drop()</code></p>
<h1 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h1><p>MongoDB 将数据存储为 BSON 文档.</p>
<h2 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h2><p>文档对字段名称有以下限制：</p>
<ul>
<li>字段名称＿id 保留用作主键；它的值在集合中必须是唯一的，不可变的，并且可以是数组以外的任何类型.</li>
<li>字段名称不能包含空字符。</li>
</ul>
<h3 id="id-字段"><a href="#id-字段" class="headerlink" title="_id 字段"></a>_id 字段</h3><p>在 MongoDB 中，存储在集合中的每个文档都需要一个唯一的<code>_id</code>字段作为主键。如果插入的文档省略<code>_id</code>字段，则 MongoDB 驱动程序会自动为<code>_id</code>字段生成 Objectld。<br>id 字段具有以下行为和约束：</p>
<ul>
<li>默认情况下，MongoDB 在创建集合时会在<code>_id</code>字段上创建唯一索引。</li>
<li><code>_id</code>字段始终是文档中的第一个字段</li>
<li><code>_id</code>字段可以包含任何 BSON 数据类型的值，而不是数组。</li>
</ul>
<h2 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h2><ul>
<li><code>db.xxx.insertOne()</code>: 插入一个,返回 id</li>
<li><code>db.xxx.insertMany()</code>: 插入多个,返回 id</li>
<li><code>db.xxx.insert()</code>: 插入任意个,返回是否成功</li>
</ul>
<h2 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h2><ul>
<li><code>db.xxx.find(query, projection)</code><ul>
<li>query,可选,指定查询条件</li>
<li>projection,可选,使用投影操作符指定返回的键.</li>
<li><code>$or</code>或查询,匹配一个或多个条件</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件查询</span></span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="attr">status</span>: <span class="string">&quot;A&quot;</span>, <span class="comment">//查询条件为A的所有</span></span><br><span class="line">&#125;);</span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(</span><br><span class="line">  &#123;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="number">1</span>, <span class="comment">//1 表示查询item,0表示不包括item</span></span><br><span class="line">    <span class="attr">qty</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 或查询</span></span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="attr">$or</span>: [</span><br><span class="line">    (<span class="attr">status</span>: <span class="string">&quot;A&quot;</span>),</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">qty</span>: &#123; <span class="attr">$lt</span>: <span class="number">30</span> &#125;, <span class="comment">// qty小于30</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>db.xxx.findOne()</code></li>
</ul>
<h3 id="类型检查"><a href="#类型检查" class="headerlink" title="类型检查"></a>类型检查</h3><p>BSON 类型为 Nul(类型编号 10):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123; <span class="attr">item</span>: &#123; <span class="attr">$type</span>: <span class="number">10</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="存在检查"><a href="#存在检查" class="headerlink" title="存在检查"></a>存在检查</h3><p>查询匹配不包含 item 的文档:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123; <span class="attr">item</span>: &#123; <span class="attr">$exists</span>: <span class="literal">false</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><ul>
<li><code>db.xxx.updateOne(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></li>
<li><code>db.xxx.updateMany(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></li>
<li><code>db.xxx.replaceOne(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></li>
</ul>
<p>可以指定更新文档的条件或过滤器.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将age小于18 的文档中status更新为reject</span></span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">updateMany</span>(&#123;</span><br><span class="line">  &#123;<span class="attr">age</span>: &#123; <span class="attr">$lt</span>: <span class="number">18</span> &#125;,</span><br><span class="line">  &#123;<span class="attr">$set</span>: &#123;<span class="attr">stastus</span>: <span class="string">&#x27;reject&#x27;</span>&#125;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="替换文档"><a href="#替换文档" class="headerlink" title="替换文档"></a>替换文档</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">xxx</span>.<span class="title function_">replaceOne</span>(</span><br><span class="line">  &#123;<span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span>, <span class="attr">instock</span>: &#123;<span class="attr">qty</span>: <span class="number">60</span>&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><ul>
<li><code>db.xxx.deleteMany()</code></li>
<li><code>db.xxx.deleteOne()</code>: 仅删除一个符合条件的文档</li>
</ul>
<h1 id="数据库的操作"><a href="#数据库的操作" class="headerlink" title="数据库的操作"></a>数据库的操作</h1><ul>
<li>导出数据库 .&#x2F;mongoexport –port [port] –db test –collection users –out export.json</li>
<li>导入数据库 .&#x2F;mongoimport -h 120.79.229.197:27-17 -d test -c scenics –file&#x3D;.&#x2F;export.json</li>
</ul>
<h1 id="Node-中使用-MongoDB"><a href="#Node-中使用-MongoDB" class="headerlink" title="Node 中使用 MongoDB"></a>Node 中使用 MongoDB</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//安装mongo,这是项目中使用的为node准备的工具</span><br><span class="line">npm i mongo -D</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">MongoClient</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;mongodb&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">MongoClient</span>(<span class="string">&quot;mongodb://127.0.0.1:27017&quot;</span>); <span class="comment">// 连接本地mongo客户端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 开始连接</span></span><br><span class="line">    <span class="keyword">await</span> client.<span class="title function_">connect</span>();</span><br><span class="line">    <span class="comment">// 操作数据库</span></span><br><span class="line">    <span class="keyword">const</span> testDB = client.<span class="title function_">db</span>(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    <span class="comment">// 通过数据库获取集合</span></span><br><span class="line">    <span class="keyword">const</span> userCollection = testDB.<span class="title function_">collection</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">    <span class="comment">// 增加</span></span><br><span class="line">    <span class="comment">// const ret = await userCollection.insertOne(&#123;</span></span><br><span class="line">    <span class="comment">// name: &#x27;Jim&#x27;,</span></span><br><span class="line">    <span class="comment">// age: 12</span></span><br><span class="line">    <span class="comment">// &#125;)</span></span><br><span class="line">    <span class="comment">// console.log(ret);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询参数</span></span><br><span class="line">    <span class="keyword">const</span> ret = <span class="keyword">await</span> userCollection.<span class="title function_">find</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ret: &quot;</span>, <span class="keyword">await</span> ret.<span class="title function_">toArray</span>()); <span class="comment">// ret.toArray()返回promise所以await</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接失败&quot;</span>, err);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 断开连接</span></span><br><span class="line">    <span class="keyword">await</span> client.<span class="title function_">close</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">run</span>();</span><br></pre></td></tr></table></figure>

<h2 id="删除-id-的文档"><a href="#删除-id-的文档" class="headerlink" title="删除_id 的文档"></a>删除_id 的文档</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">ObjectId</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;mongodb&quot;</span>);</span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> userCollection.<span class="title function_">deleteOne</span>(&#123;</span><br><span class="line">  <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&quot;636b5886e7de417db38a5610&quot;</span>),</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ret);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">网络通信基本原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 12:24:42" itemprop="dateCreated datePublished" datetime="2022-11-08T12:24:42+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:14" itemprop="dateModified" datetime="2023-03-19T18:57:14+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="网络通信方式"><a href="#网络通信方式" class="headerlink" title="网络通信方式"></a>网络通信方式</h1><ul>
<li>交换机</li>
<li>路由器</li>
</ul>
<h1 id="网络层次模型"><a href="#网络层次模型" class="headerlink" title="网络层次模型"></a>网络层次模型</h1><h2 id="OSI-七层模型"><a href="#OSI-七层模型" class="headerlink" title="OSI 七层模型"></a>OSI 七层模型</h2><ul>
<li>应用层: 用户与网络的接口</li>
<li>表示层: 数据加密,转换,压缩</li>
<li>会话层: 控制网络连接建立与中止</li>
<li>传输层: 控制数据传输可靠性</li>
<li>网络层: 确定目标网络</li>
<li>数据链路层: 确定目标主机</li>
<li>物理层: 各种网络屋里设备</li>
</ul>
<h2 id="TCP-四层模型"><a href="#TCP-四层模型" class="headerlink" title="TCP 四层模型"></a>TCP 四层模型</h2><h1 id="数据封装与解封装"><a href="#数据封装与解封装" class="headerlink" title="数据封装与解封装"></a>数据封装与解封装</h1><h1 id="TCP-三次握手与四次挥手"><a href="#TCP-三次握手与四次挥手" class="headerlink" title="TCP 三次握手与四次挥手"></a>TCP 三次握手与四次挥手</h1><h2 id="TCP-协议"><a href="#TCP-协议" class="headerlink" title="TCP 协议"></a>TCP 协议</h2><ul>
<li>TCP 属于传输层协议</li>
<li>TCP 是面向连接的协议</li>
<li>TCP 用于处理实时通信</li>
</ul>
<p>本质上请求连接或请求断开都是四次连接,但是请求断开中服务端请求不能合并成一条.</p>
<h2 id="常见控制字段"><a href="#常见控制字段" class="headerlink" title="常见控制字段"></a>常见控制字段</h2><ul>
<li>SYN&#x3D;1: 请求建立连接</li>
<li>FIN&#x3D;1: 请求断开连接</li>
<li>ACK&#x3D;1: 数据信息的确认</li>
</ul>
<p>本来应该是两次一来一回,共四次,但是服务端这里可以将请求和确认合并发送,就是三次握手连接.<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1667888331598-3e677377-8421-492c-8c03-64bf00f877b1.png#averageHue=%233b3c4a&clientId=ua85c5b97-f94c-4&from=paste&height=326&id=uaa64939c&name=image.png&originHeight=375&originWidth=640&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=72198&status=done&style=none&taskId=u3dcd730a-8cdd-47ea-9161-615e10d6bd6&title=&width=556" alt="image.png"><br>断开连接:<br>变成四次是因为确保服务端已经将数据全部传输完毕,所以不能进行合并.</p>
<h1 id="创建-TCP-通信"><a href="#创建-TCP-通信" class="headerlink" title="创建 TCP 通信"></a>创建 TCP 通信</h1><h2 id="通信过程"><a href="#通信过程" class="headerlink" title="通信过程"></a>通信过程</h2><ul>
<li>创建服务端: 接收和诙谐客户端数据</li>
<li>创建客户端: 发送接收服务端数据</li>
<li>数据传输: 内置服务事件和方法读写数据</li>
</ul>
<h2 id="通信事件"><a href="#通信事件" class="headerlink" title="通信事件"></a>通信事件</h2><ul>
<li>listening 事件: 调用 server.listen 方法后触发</li>
<li>connection 事件: 新的连接建立时触发</li>
<li>close 事件: 当 server 关闭时触发</li>
<li>error 事件: 当错误出现时触发</li>
</ul>
<h2 id="通信事件-amp-方法"><a href="#通信事件-amp-方法" class="headerlink" title="通信事件&amp;方法"></a>通信事件&amp;方法</h2><ul>
<li>data 事件: 当接收到数据时触发</li>
<li>write 方法: 在 socket 上发送数据,默认 UTF-8</li>
<li>end 操作: 当 socket 的一端发送 FIN 包时触发,结束可读端</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&quot;net&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建服务端实例</span></span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="number">1234</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HOST</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="variable constant_">HOST</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用listen后触发listening事件</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&quot;listening&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`服务端已开启在 <span class="subst">$&#123;HOST&#125;</span>: <span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收消息 回写消息</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> msg = chunk.<span class="title function_">toString</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(msg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//回数据</span></span><br><span class="line">    socket.<span class="title function_">write</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;您好&quot;</span> + msg));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;服务端关闭&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err.<span class="property">code</span> === <span class="string">&quot;EADDRINUSE&quot;</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;地址占用&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&quot;net&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = net.<span class="title function_">createConnection</span>(&#123;</span><br><span class="line">  <span class="attr">port</span>: <span class="number">1234</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.<span class="title function_">on</span>(<span class="string">&quot;connect&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  client.<span class="title function_">write</span>(<span class="string">&quot;edu&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(chunk.<span class="title function_">toString</span>());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">client.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;客户端断开连接&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">client.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="TCP-数据粘包"><a href="#TCP-数据粘包" class="headerlink" title="TCP 数据粘包"></a>TCP 数据粘包</h1><p>发送端和接收端都是等待缓冲数据之后再消费.<br>出现问题的原因: 发送间隔太短导致数据堆积.</p>
<h2 id="数据的封包和拆包"><a href="#数据的封包和拆包" class="headerlink" title="数据的封包和拆包"></a>数据的封包和拆包</h2><p>将消息头拆分为序列号和消息长度</p>
<h2 id="数据传输过程"><a href="#数据传输过程" class="headerlink" title="数据传输过程"></a>数据传输过程</h2><ul>
<li>进行数据编码,获取二进制数据包</li>
<li>按规则拆解数据,获取指定长度数据</li>
</ul>
<h2 id="Buffer-数据读写"><a href="#Buffer-数据读写" class="headerlink" title="Buffer 数据读写"></a>Buffer 数据读写</h2><ul>
<li>writeInt16BE: 将 value 从指定位置写入</li>
<li>readInt16BE: 从指定位置开始读取数据</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编码解码</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">myTransform</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 固定header总长度4字节</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">packageHeaderLen</span> = <span class="number">4</span>;</span><br><span class="line">    <span class="comment">// 当前包的编号</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serialNum</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">serialLen</span> = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编码</span></span><br><span class="line">  <span class="title function_">encode</span>(<span class="params">data, serialNum</span>) &#123;</span><br><span class="line">    <span class="comment">//把传入数据变为二进制</span></span><br><span class="line">    <span class="keyword">const</span> body = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(data);</span><br><span class="line">    <span class="comment">// 01 先按照指定长度申请内存空间作为header使用</span></span><br><span class="line">    <span class="keyword">const</span> headerBuf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="variable language_">this</span>.<span class="property">packageHeaderLen</span>);</span><br><span class="line">    <span class="comment">// 02 写操作</span></span><br><span class="line">    headerBuf.<span class="title function_">writeInt16BE</span>(serialNum || <span class="variable language_">this</span>.<span class="property">serialNum</span>);</span><br><span class="line">    <span class="comment">// 数据的长度作为消息体的总长度写入另一空间</span></span><br><span class="line">    headerBuf.<span class="title function_">writeInt16BE</span>(body.<span class="property">length</span>, <span class="variable language_">this</span>.<span class="property">serialLen</span>); <span class="comment">// 跳过前面占用的位置</span></span><br><span class="line">    <span class="comment">// 设置编号</span></span><br><span class="line">    <span class="keyword">if</span> (serialNum === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">serialNum</span>++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Buffer</span>.<span class="title function_">concat</span>(headerBuf, body);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 解码</span></span><br><span class="line">  <span class="title function_">decode</span>(<span class="params">buffer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> headerBuf = buffer.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">packageHeaderLen</span>);</span><br><span class="line">    <span class="keyword">const</span> bodyBuf = buffer.<span class="title function_">slice</span>(<span class="variable language_">this</span>.<span class="property">packageHeaderLen</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">serialNum</span>: headerBuf.<span class="title function_">readInt16BE</span>(),</span><br><span class="line">      <span class="attr">bodyLength</span>: headerBuf.<span class="title function_">readInt16BE</span>(<span class="variable language_">this</span>.<span class="property">serialLen</span>),</span><br><span class="line">      <span class="attr">body</span>: bodyBuf.<span class="title function_">toString</span>(),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取数据包长度,用于判断是否还有数据</span></span><br><span class="line">  <span class="title function_">getPackageLen</span>(<span class="params">buffer</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer.<span class="property">length</span> &lt; <span class="variable language_">this</span>.<span class="property">packageHeaderLen</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">packageHeaderLen</span> + buffer.<span class="title function_">readInt16BE</span>(<span class="variable language_">this</span>.<span class="property">serialLen</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = myTransform;</span><br></pre></td></tr></table></figure>

<h2 id="数据粘包解决"><a href="#数据粘包解决" class="headerlink" title="数据粘包解决"></a>数据粘包解决</h2><p>利用上面的编解码工具类</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> myTransform = <span class="built_in">require</span>(<span class="string">&quot;./myTransform.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> overageBuffer = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> ts = <span class="keyword">new</span> <span class="title function_">myTransform</span>();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 接收消息 回写消息</span></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">socket</span>) =&gt;</span> &#123;</span><br><span class="line">  socket.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="function">(<span class="params">chunk</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果有未使用完的buffer</span></span><br><span class="line">    <span class="keyword">if</span> (overageBuffer) &#123;</span><br><span class="line">      <span class="comment">//将数据拼接</span></span><br><span class="line">      chunk = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([overageBuffer, chunk]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> packageLen = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果数据为0,则说明不足以读取,否则就是可读取</span></span><br><span class="line">    <span class="keyword">while</span> ((packageLen = ts.<span class="title function_">getPackageLen</span>(chunk))) &#123;</span><br><span class="line">      <span class="comment">// 把包的内容截取出来</span></span><br><span class="line">      <span class="keyword">const</span> packageCon = chunk.<span class="title function_">slice</span>(<span class="number">0</span>, packageLen);</span><br><span class="line">      <span class="comment">// 更新chunk,将已读取的截掉</span></span><br><span class="line">      chunk = chunk.<span class="title function_">slice</span>(packageLen);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> ret = ts.<span class="title function_">decode</span>(packageCon);</span><br><span class="line">      <span class="comment">//回数据</span></span><br><span class="line">      socket.<span class="title function_">write</span>(ret.<span class="property">body</span>, ret.<span class="property">serialNum</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将剩余的chunk交给overageBuffer下一次处理</span></span><br><span class="line">    overageBuffer = chunk;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="Http-协议"><a href="#Http-协议" class="headerlink" title="Http 协议"></a>Http 协议</h1><h2 id="获取-http-请求信息"><a href="#获取-http-请求信息" class="headerlink" title="获取 http 请求信息"></a>获取 http 请求信息</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; pathname, query &#125; = url.<span class="title function_">parse</span>(req.<span class="property">url</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="comment">// 请求方式</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">method</span>);</span><br><span class="line">  <span class="comment">// http版本号</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">httpVersion</span>);</span><br><span class="line">  <span class="comment">// 请求头</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">headers</span>);</span><br><span class="line">  <span class="comment">// 请求体数据获取</span></span><br><span class="line">  <span class="keyword">let</span> arr = [];</span><br><span class="line">  <span class="comment">// req是个可读流</span></span><br><span class="line">  req.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    arr.<span class="title function_">push</span>(data);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  req.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">concat</span>(arr).<span class="title function_">toString</span>());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">1234</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;server start ...&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="设置-http-响应"><a href="#设置-http-响应" class="headerlink" title="设置 http 响应"></a>设置 http 响应</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// res就是可写流</span></span><br><span class="line">  <span class="comment">// res.write(&#x27;ok&#x27;)</span></span><br><span class="line">  <span class="comment">// 使用end结束写入操作,或者直接在里面写入</span></span><br><span class="line">  <span class="comment">// res.end()</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置响应头</span></span><br><span class="line">  res.<span class="property">statusCode</span> = <span class="number">200</span>;</span><br><span class="line">  res.<span class="title function_">setHeader</span>(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&quot;你好&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">1234</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;server start ...&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="客户端代理"><a href="#客户端代理" class="headerlink" title="客户端代理"></a>客户端代理</h2><p>相当于服务端,客户端与不同端口域名协议的服务端通信有跨域,那就采用客户端代理,它与服务端就不存在跨域.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/05/Node/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/05/Node/" class="post-title-link" itemprop="url">Node</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-05 15:08:16" itemprop="dateCreated datePublished" datetime="2022-11-05T15:08:16+08:00">2022-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:15" itemprop="dateModified" datetime="2023-03-19T18:57:15+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>根据 Node.js 官网的定义：Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。 Node.js 使用了一个事件驱动、非阻塞式 I&#x2F;O 的模型，使其轻量又高效。</p>
<p>Node.js 是基于 Chrome V8 引擎构建的.由事件循环分发 I&#x2F;O 任务,最终工作线程将任务丢进线程池中去执行,而事件循环只要等待执行结果就可以了.</p>
<h1 id="异步-IO"><a href="#异步-IO" class="headerlink" title="异步 IO"></a>异步 IO</h1><p>重复调用 IO 操作,判断是否完成,称为轮询.包括<code>read</code>,<code>select</code>,<code>poll</code>,<code>kqueue</code>,<code>event ports</code>.<br>期望实现无须主动判断的非阻塞 I&#x2F;O.</p>
<h2 id="异步-IO-优点"><a href="#异步-IO-优点" class="headerlink" title="异步 IO 优点"></a>异步 IO 优点</h2><ul>
<li>前端通过异步 IO 可以消除阻塞。</li>
<li>请求耗时少，假如有两个请求 A 和 B，那么异步 IO 用时为：Max（A+B）。同步则为 A+B，请求越多差距越大。</li>
<li>IO 是昂贵的，分布式 IO 是更昂贵的。</li>
<li>Node.js 适用于 IO 密集型，而不适用于 CPU 密集型。</li>
<li>并不是所有都用异步任务好，遵循一个公式： s&#x3D; (Ws+Wp)&#x2F;(Ws+Wp&#x2F;p) Ws 表示同步任务，Wp 表示异步任务，p 表示处理器的数量。</li>
</ul>
<h2 id="异步-IO-实现"><a href="#异步-IO-实现" class="headerlink" title="异步 IO 实现"></a>异步 IO 实现</h2><ul>
<li>应用程序先将 JS 代码经 V8 转换为机器码。</li>
<li>通过 Node.js Bindings 层，向操作系统 Libuv 的事件队列中添加一个任务。</li>
<li>Libuv 将事件推送到线程池中执行。</li>
<li>线程池执行完事件，返回数据给 Libuv。</li>
<li>Libuv 将返回结果通过 Node.js Bindings 返回给 V8。</li>
<li>V8 再将结果返回给应用程序。</li>
</ul>
<h2 id="libuv"><a href="#libuv" class="headerlink" title="libuv"></a>libuv</h2><p>多种异步 IO 实现的抽象封装层.<br>libuv 实现了 Node.js 中 Eventloop,主要分为以下几个阶段:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   ┌───────────────────────────┐</span><br><span class="line">┌─&gt;│           timers          │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │     pending callbacks     │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │       idle, prepare       │</span><br><span class="line">│  └─────────────┬─────────────┘      ┌───────────────┐</span><br><span class="line">│  ┌─────────────┴─────────────┐      │   <span class="attr">incoming</span>:   │</span><br><span class="line">│  │           poll            │&lt;─────┤  connections, │</span><br><span class="line">│  └─────────────┬─────────────┘      │   data, etc.  │</span><br><span class="line">│  ┌─────────────┴─────────────┐      └───────────────┘</span><br><span class="line">│  │           check           │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">└──┤      close callbacks      │</span><br><span class="line">   └───────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>上图中每一个阶段都有一个先进先出的回调队列，只有当队列内的事件执行完成之后，才会进入下一个阶段。</p>
<ul>
<li>timers：执行 <code>setTimeout</code> 和 <code>setInterval</code> 中到期的 callback。</li>
<li>pending callbacks：上一轮循环中有少数的 I&#x2F;O callback 会被延迟到这一轮的这一阶段执行。<ul>
<li>执行一些系统操作的回调，例如 tcp 连接发生错误。</li>
</ul>
</li>
<li>idle, prepare：仅内部使用。</li>
<li>poll：最为重要的阶段，执行 I&#x2F;O callback(node 异步 api 的回调，事件订阅回调等)，在适当的条件下会阻塞在这个阶段。<ul>
<li>如果 poll 队列不为空，直接执行队列内的事件，直到队列清空。</li>
<li>如果 poll 队列为空。<ul>
<li>如果有设置 <code>setImmediate</code>，则直接进入 check 阶段。</li>
<li>如果没有设置 <code>setImmediate</code>，则会检查是否有 timers 事件到期。<ul>
<li>如果有 timers 事件到期，则执行 timers 阶段。</li>
<li>如果没有 timers 事件到期，则会阻塞在当前阶段，等待事件加入。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>check：执行 <code>setImmediate</code> 的 callback。</li>
<li>close callbacks：执行 close 事件的 callback，例如 <code>socket.on(&quot;close&quot;,func)</code>。</li>
</ul>
<p><strong>除此之外，Node.js 提供了 process.nextTick(微任务，promise 也一样) 方法，在以上的任意阶段开始执行的时候都会触发。</strong></p>
<blockquote>
<ul>
<li>Event Loop 是一个很重要的概念，指的是计算机系统的一种运行机制。</li>
<li>Libuv 在 Linux 下基于 Custom Threadpool 实现。</li>
<li>Libuv 在 Windows 下基于 IOCP 实现。</li>
</ul>
</blockquote>
<h2 id="常见的异步-IO-使用方式"><a href="#常见的异步-IO-使用方式" class="headerlink" title="常见的异步 IO 使用方式"></a>常见的异步 IO 使用方式</h2><ul>
<li>使用 step，q，async 等异步控制库。</li>
<li>使用 Promise 处理异步。</li>
<li>使用 EventEmitter，实现“发布&#x2F;订阅”模式处理异步。</li>
<li>Node.js 暂不支持协程，可使用 Generator 代替。</li>
<li>终极解决方案：async、await。</li>
</ul>
<h1 id="事件驱动架构"><a href="#事件驱动架构" class="headerlink" title="事件驱动架构"></a>事件驱动架构</h1><h1 id="commonjs-模块"><a href="#commonjs-模块" class="headerlink" title="commonjs 模块"></a>commonjs 模块</h1><h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><ul>
<li>引入模块：require(“.&#x2F;index.js”)</li>
<li>导出模块：module.exports&#x3D;{…} 或者 exports.key&#x3D;{}<ul>
<li>注意：exports 为 module.exports 的引用，不可使用 exports 直接赋值，模块无法导出，eg：exports&#x3D;{}</li>
</ul>
</li>
<li>缓存：require 值会缓存，通过 require 引用文件时，会将文件执行一遍后，将结果通过浅克隆的方式，写入全局内存，后续 require 该路径，直接从内存获取，无需重新执行文件</li>
<li>值拷贝：模块输出是值的拷贝，一但输出，模块内部变化后，无法影响之前的引用，而 ESModule 是引用拷贝。commonJS 运行时加载，ESModule 编译阶段引用<ul>
<li>CommonJS 在引入时是加载整个模块，生成一个对象，然后再从这个生成的对象上读取方法和属性</li>
<li>ESModule 不是对象，而是通过 export 暴露出要输出的代码块，在 import 时使用静态命令的方法引用制定的输出代码块，并在 import 语句处执行这个要输出的代码，而不是直接加载整个模块<blockquote>
<p>面试题：为何直接使用 exports 导出 commonjs 模块，eg：exports &#x3D; “hello”<br>解析：commonjs 模块是通过 module.exports 导出模块，exports 为 module.exports 的引用，使用 exports 直接赋值导出模块，只会改变 exports 的引用不会导出 commonjs 模块。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cjs正确导出用法</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">key</span> = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="comment">//错误导出</span></span><br><span class="line"><span class="built_in">exports</span> = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//无法输出</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//解析：</span></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">key</span>: &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">obj.<span class="property">key</span> = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//可改变obj</span></span><br><span class="line"><span class="keyword">const</span> key = obj.<span class="property">key</span>;</span><br><span class="line">key.<span class="property">key1</span> = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//可改变obj</span></span><br><span class="line">key = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//无法改变obj，改变了key的引用</span></span><br></pre></td></tr></table></figure>

<h2 id="module-属性"><a href="#module-属性" class="headerlink" title="module 属性"></a>module 属性</h2><ul>
<li>任意 js 文件就是一个模块.可以直接使用 module 属性.</li>
<li>id: 返回模块标识符,一般是一个绝对路径</li>
<li>filename: 返回绝对路径</li>
<li>loaded: 返回布尔值,表示模块是否加载完成</li>
<li>parent: 返回对象存放调用当前模块的模块</li>
<li>children: 返回数组,存放当前模块调用的其他模块</li>
<li>exports;返回当前模块需要暴露的内容</li>
<li>paths: 返回数组,存放不同目录下的 node_modules 位置</li>
</ul>
<h2 id="原理实现"><a href="#原理实现" class="headerlink" title="原理实现"></a>原理实现</h2><p>使用 fs、vm、path 内置模块，以及函数包裹形式实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * commonjs的require函数：引入module</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; filename module的名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">customRequire</span>(<span class="params">filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> pathToFile = path.<span class="title function_">resolve</span>(__dirname, filename);</span><br><span class="line">  <span class="keyword">const</span> content = fs.<span class="title function_">readFileSync</span>(pathToFile, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  <span class="comment">//使用函数包裹模块，执行函数</span></span><br><span class="line">  <span class="comment">//注入形参：require、module、exports、__dirname、__filename</span></span><br><span class="line">  <span class="keyword">const</span> wrapper = [</span><br><span class="line">    <span class="string">&quot;(function(require, module, exports, __dirname, __filename)&#123;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&#125;)&quot;</span>,</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">const</span> wrappedContent = wrapper[<span class="number">0</span>] + content + wrapper[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(wrappedContent, &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">module</span> = &#123;</span><br><span class="line">    <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//转换为函数，类似eval，(funcion(require, module, exports)&#123; xxx &#125;)</span></span><br><span class="line">  <span class="keyword">const</span> result = script.<span class="title function_">runInThisContext</span>();</span><br><span class="line">  <span class="comment">//函数执行，引入模块，若内部有require继续递归</span></span><br><span class="line">  <span class="comment">//exports为module.exports的引用</span></span><br><span class="line">  <span class="title function_">result</span>(customRequire, <span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">global</span>.<span class="property">customRequire</span> = customRequire;</span><br></pre></td></tr></table></figure>

<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><ul>
<li>源码路径：&#x2F;lib&#x2F;internal&#x2F;modules&#x2F;cjs&#x2F;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//loader.js</span></span><br><span class="line"><span class="comment">//require函数定义</span></span><br><span class="line"><span class="number">1</span>、<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">require</span>：调用__load函数</span><br><span class="line"><span class="number">2</span>、<span class="title class_">Module</span>.<span class="property">__load</span>：_cache处理，调用load函数</span><br><span class="line"><span class="number">3</span>、<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">load</span>函数：调用<span class="title class_">Module</span>.<span class="property">_extensions</span>[extension](<span class="variable language_">this</span>, filename);</span><br><span class="line"><span class="comment">//不同的后缀通过定义不同的函数指定解析规则：以Module._extensions[&#x27;.js&#x27;]为例</span></span><br><span class="line"><span class="number">4</span>、<span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&#x27;.js&#x27;</span>] = <span class="keyword">function</span>(<span class="params"><span class="variable language_">module</span>, filename</span>) &#123;</span><br><span class="line">  <span class="comment">//读取缓存或者通过readFileSync读取内容</span></span><br><span class="line">  <span class="keyword">if</span> (cached?.<span class="property">source</span>) &#123;</span><br><span class="line">    content = cached.<span class="property">source</span>;</span><br><span class="line">    cached.<span class="property">source</span> = <span class="literal">undefined</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    content = fs.<span class="title function_">readFileSync</span>(filename, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">//调用compile解析</span></span><br><span class="line">  <span class="variable language_">module</span>.<span class="title function_">_compile</span>(content, filename);</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">5</span>、<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_compile</span> = <span class="keyword">function</span>(<span class="params">content, filename</span>)&#123;</span><br><span class="line">  <span class="comment">//生成包裹函数：warpSafe获取函数字符串并使用vm执行生成执行函数</span></span><br><span class="line">  <span class="keyword">const</span> compiledWrapper = <span class="title function_">wrapSafe</span>(filename, content, <span class="variable language_">this</span>);</span><br><span class="line">  <span class="comment">//执行函数</span></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">exports</span> = <span class="variable language_">this</span>.<span class="property">exports</span>;</span><br><span class="line">  <span class="keyword">const</span> thisValue = <span class="built_in">exports</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (inspectorWrapper) &#123;</span><br><span class="line">    result = <span class="title function_">inspectorWrapper</span>(compiledWrapper, thisValue, <span class="built_in">exports</span>,</span><br><span class="line">                              <span class="built_in">require</span>, <span class="variable language_">module</span>, filename, dirname);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//静态方法Reflect.apply(target, thisArgument, argumentsList)</span></span><br><span class="line">    <span class="comment">//通过指定的参数列表发起对目标(target)函数的调用</span></span><br><span class="line">    result = <span class="title class_">ReflectApply</span>(compiledWrapper, thisValue,</span><br><span class="line">                          [<span class="built_in">exports</span>, <span class="built_in">require</span>, <span class="variable language_">module</span>, filename, dirname]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">6</span>、<span class="keyword">function</span> <span class="title function_">wrapSafe</span>(<span class="params">filename, content, cjsModuleInstance</span>) &#123;</span><br><span class="line">    <span class="comment">/* 生成包裹函数字符：</span></span><br><span class="line"><span class="comment">    let wrap = function(script) &#123;</span></span><br><span class="line"><span class="comment">       return Module.wrapper[0] + script + Module.wrapper[1];</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    const wrapper = [</span></span><br><span class="line"><span class="comment">      &#x27;(function (exports, require, module, __filename, __dirname) &#123; &#x27;,</span></span><br><span class="line"><span class="comment">      &#x27;\n&#125;);&#x27;,</span></span><br><span class="line"><span class="comment">    ]；*/</span></span><br><span class="line">  	<span class="keyword">const</span> wrapper = <span class="title class_">Module</span>.<span class="title function_">wrap</span>(content);</span><br><span class="line">    <span class="comment">//获取包裹函数</span></span><br><span class="line">    <span class="keyword">return</span> vm.<span class="title function_">runInThisContext</span>(wrapper, &#123;</span><br><span class="line">      filename,</span><br><span class="line">      <span class="attr">lineOffset</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">displayErrors</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">importModuleDynamically</span>: <span class="keyword">async</span> (specifier) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> loader = asyncESM.<span class="property">ESMLoader</span>;</span><br><span class="line">        <span class="keyword">return</span> loader.<span class="keyword">import</span>(specifier, <span class="title function_">normalizeReferrerURL</span>(filename));</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Module</span> = <span class="built_in">require</span>(<span class="string">&quot;module&quot;</span>);</span><br><span class="line"><span class="comment">//后缀解析扩展：.test后缀同.js后缀</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.test&quot;</span>] = <span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.js&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//切面编程：解析js模块前做打印处理</span></span><br><span class="line"><span class="keyword">const</span> prevFunc = <span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.js&quot;</span>];</span><br><span class="line"><span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.js&quot;</span>] = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;load script&quot;</span>);</span><br><span class="line">  prevFunc.<span class="title function_">apply</span>(prevFunc, args);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h1><ul>
<li>同步代码</li>
<li>process.nextTick(优先级高于 promise)和 promise.then() ，之后进入事件循环</li>
<li>timers 阶段：这个阶段执行 timer（setTimeout、setInterval）的回调</li>
<li>I&#x2F;O callbacks 阶段 ：处理一些上一轮循环中的少数未执行的 I&#x2F;O 回调</li>
<li>idle, prepare 阶段 ：仅 node 内部使用</li>
<li>poll 阶段 ：获取新的 I&#x2F;O 事件, 适当的条件下 node 将阻塞在这里</li>
<li>check 阶段 ：执行 setImmediate() 的回调</li>
<li>close callbacks 阶段：执行 socket 的 close 事件回调</li>
</ul>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><ul>
<li>执行同步代码</li>
<li>查看是否有满足条件的微任务,执行</li>
<li>执行 timer 中满足条件的宏任务</li>
<li>timer 中宏任务全部执行完毕切换队列</li>
<li>切换前会清空微任务</li>
<li>之后按照 timer &#x3D;&gt; poll &#x3D;&gt; check 检查是否有任务执行</li>
</ul>
<h3 id="和浏览器-eventloop-区别"><a href="#和浏览器-eventloop-区别" class="headerlink" title="和浏览器 eventloop 区别:"></a>和浏览器 eventloop 区别:</h3><p>浏览器执行宏任务就会把本次循环生成的微任务清空,而 node 是在切换队列前清空,所以要将 timer 中宏任务全部执行完毕,再执行微任务.<br>习题解析：</p>
<ul>
<li>new Promise(()&#x3D;&gt;{&#x2F;&#x2F;同步执行}).then(()&#x3D;&gt;{&#x2F;&#x2F;异步执行})</li>
<li>async function test(){console.log() &#x2F;&#x2F;同步 -&gt; await test(0) &#x2F;&#x2F;同步 -&gt; console.log()&#x2F;&#x2F;异步}</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//习题1:</span></span><br><span class="line"><span class="comment">// 顺序不确定，只有两个语句，执行环境有差异</span></span><br><span class="line"><span class="comment">// 场景1: setTimeout 0 最少1ms，未推入timers队列中，执行结果为：setImmediate、setTimeout</span></span><br><span class="line"><span class="comment">// 场景2: setTimeout 0 已推入timers队列中，执行结果为：setTimeout、setImmediate</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setImmediate&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//习题2: 都在回调函数中，内容确定</span></span><br><span class="line"><span class="comment">//首轮事件循环setTimeout1的timers清空，执行至check阶段，先输出setImmediate</span></span><br><span class="line"><span class="comment">//第二轮事件循环setTimeout2</span></span><br><span class="line"><span class="comment">//最终输出：setTimeout1、setImmediate、setTimeout2</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout2&quot;</span>);</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setImmediate&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout1&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//习题3: 混合题</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;immediate&quot;</span>);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;immediate1&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">77</span>);</span><br><span class="line">    <span class="title function_">resolve</span>();</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">88</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;nextTick1&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">7</span>);</span><br><span class="line">  <span class="title function_">resolve</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">8</span>);</span><br><span class="line">&#125;);</span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;nextTick2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一轮：7 start -  timeout | immediate 77 | 8 ｜ nextTick2</span></span><br><span class="line"><span class="comment">// 第二轮：7 start nextTick2  8 timeout immediate 77 - immediate1 ｜ 88 ｜ nextTick1</span></span><br><span class="line"><span class="comment">// 第三轮：7 start nextTick2  8 timeout immediate 77 nextTick1 88 immediate1</span></span><br></pre></td></tr></table></figure>

<h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><h2 id="全局对象"><a href="#全局对象" class="headerlink" title="全局对象"></a>全局对象</h2><p>Node 中全局对象是<code>global</code>,如果直接在模块中获取 this 指向的是<code>&#123;&#125;</code>.<br>而模块最终会封装进自执行函数中,指向的是<code>global</code>.</p>
<ul>
<li>全局对象：global，下挂如下对象和函数，使用时无需模块引入<ul>
<li>global</li>
<li>Buffer、process、console、queueMicrotask</li>
<li>setTimeout、clearTimeout、setInterval、setImmediate、clearInterval</li>
</ul>
</li>
<li>模块中使用注入变量：<ul>
<li><code>__filename</code>：当前文件名称带路径，eg：&#x2F;Users&#x2F;jian&#x2F;workspace&#x2F;cjs&#x2F;index.js</li>
<li><code>__dirname</code>：当前文件夹路径，eg：&#x2F;Users&#x2F;jian&#x2F;workspace&#x2F;cjs&#x2F;</li>
<li><code>cjs</code>：require, module, exports</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局this指向global</span></span><br><span class="line"><span class="comment">//模块文件中this指向：module.exports的对象</span></span><br><span class="line"><span class="comment">/* 模块中才可以使用的变量：commonjs模块注入，非模块中使用报错</span></span><br><span class="line"><span class="comment">__dirname、__filename、exports、module、require */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//node命令行中</span></span><br><span class="line">&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(__dirname)</span><br><span class="line"><span class="comment">// Uncaught ReferenceError: __dirname is not defined</span></span><br><span class="line">&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line"><span class="comment">/* &lt;ref *1&gt; Object [global] &#123;</span></span><br><span class="line"><span class="comment">  global: [Circular *1],</span></span><br><span class="line"><span class="comment">  clearInterval: [Function: clearInterval],</span></span><br><span class="line"><span class="comment">  clearTimeout: [Function: clearTimeout],</span></span><br><span class="line"><span class="comment">  setInterval: [Function: setInterval],</span></span><br><span class="line"><span class="comment">  setTimeout: [Function: setTimeout] &#123;</span></span><br><span class="line"><span class="comment">    [Symbol(nodejs.util.promisify.custom)]: [Getter]</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  queueMicrotask: [Function: queueMicrotask],</span></span><br><span class="line"><span class="comment">  clearImmediate: [Function: clearImmediate],</span></span><br><span class="line"><span class="comment">  setImmediate: [Function: setImmediate] &#123;</span></span><br><span class="line"><span class="comment">    [Symbol(nodejs.util.promisify.custom)]: [Getter]</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//node模块中执行</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(__filename)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(__dirname)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123;&#125;</span></span><br><span class="line"><span class="comment">/Users/jian/workspace/cjs/index.js</span></span><br><span class="line"><span class="comment">/Users/jian/workspace/cjs</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="process"><a href="#process" class="headerlink" title="process"></a>process</h3><ul>
<li>argv：返回一个数组，由命令行执行脚本时的各个参数组成。它的第一个成员总是 node，第二个成员是脚本文件名，其余成员是脚本文件的参数</li>
<li>env：返回一个对象，成员为当前 shell 的环境变量</li>
<li>stdin：标准输入流</li>
<li>stdout：标准输出流</li>
<li>cwd()：返回当前进程的工作目录</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">argv</span>);</span><br><span class="line"><span class="comment">//[ &#x27;/usr/local/bin/node&#x27;, &#x27;/Users/jian/workspace/cjs/index.js&#x27; ]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="title function_">cwd</span>()); <span class="comment">////Users/jian/workspace/cjs</span></span><br><span class="line">process.<span class="property">stdout</span>.<span class="title function_">write</span>(<span class="string">&quot;Hello World!&quot;</span>); <span class="comment">//Hello World!</span></span><br></pre></td></tr></table></figure>

<h2 id="底层依赖模块"><a href="#底层依赖模块" class="headerlink" title="底层依赖模块"></a>底层依赖模块</h2><ul>
<li>V8 引擎：主要是 JS 语法的解析，有了它才能识别 JS 语法</li>
<li>libuv：C 语⾔实现的⼀个⾼性能异步⾮阻塞 IO 库，⽤来实现 node.js 的事件循环</li>
<li>http-parser&#x2F;llhttp：底层处理 http 请求，处理报⽂，解析请求包等内容</li>
<li>openssl：处理加密算法，各种框架运⽤⼴泛，底层依赖，无需 js 实现</li>
<li>zlib：处理压缩等内容</li>
</ul>
<h3 id="Eventmitter"><a href="#Eventmitter" class="headerlink" title="Eventmitter"></a>Eventmitter</h3><ul>
<li>大多数时候我们不会直接使用 EventEmitter，而是在对象中继承它，包括 fs、net、 http 在内的，只要是支持事件响应的核心模块都是 EventEmitter 的子类。</li>
<li>EventEmitter 会按照监听器注册的顺序同步地调用所有监听器，所以必须确保事件的排序正确，且避免竞态条件。</li>
<li>常见 api<ul>
<li>addListener(event, listener)添加监听器</li>
<li>removeListener(event, listener)移除监听器</li>
<li>removeAllListeners([event])移除所有监听器</li>
<li>on(event, listener)注册监听器</li>
<li>off(eventName, listener)移除监听器</li>
<li>once(event, listener)为指定事件注册一个单次监听器</li>
<li>emit(event, [arg1], [arg2], […])按监听器的顺序执行执行每个监听器，如果事件有注册监听返回 true，否则返回 false</li>
</ul>
</li>
<li>错误处理：当 EventEmitter 实例出错时，应该触发 ‘error’ 事件。 这些在 Node 中被视为特殊情况。如果没有为 ‘error’ 事件注册监听器，则当 ‘error’ 事件触发时，会抛出错误、打印堆栈跟踪、并退出 Node.js 进程。作为最佳，应该始终为 ‘error’ 事件注册监听器</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&quot;events&quot;</span>).<span class="property">EventEmitter</span>;</span><br><span class="line"><span class="keyword">var</span> eventEmitter = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>();</span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&quot;event&quot;</span>, <span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, <span class="variable language_">this</span>, <span class="variable language_">this</span> === eventEmitter);</span><br><span class="line">  <span class="comment">// 打印: 普通函数，this指向eventEmitter实例</span></span><br><span class="line">  <span class="comment">//   a b MyEmitter &#123;</span></span><br><span class="line">  <span class="comment">//     domain: null,</span></span><br><span class="line">  <span class="comment">//     _events: &#123; event: [Function] &#125;,</span></span><br><span class="line">  <span class="comment">//     _eventsCount: 1,</span></span><br><span class="line">  <span class="comment">//     _maxListeners: undefined &#125; true</span></span><br><span class="line">&#125;);</span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&quot;event&quot;</span>, <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//箭头函数，this指向module.exports</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, <span class="variable language_">this</span>, <span class="variable language_">this</span> === <span class="variable language_">module</span>.<span class="property">exports</span>);</span><br><span class="line">  <span class="comment">// 打印: a b &#123;&#125; true</span></span><br><span class="line">&#125;);</span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>事件模型设计（使用：发布订阅模式）</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventEmitter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">maxListeners</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span> = &#123;&#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxListeners</span> = maxListners || <span class="title class_">Infinity</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">on</span>(<span class="params">event, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>[event]) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">maxListener</span> != <span class="title class_">Infinity</span> &amp;&amp;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event].<span class="property">length</span> &gt; <span class="variable language_">this</span>.<span class="property">maxListeners</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;event&#125;</span> has reached max listeners.`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>[event].<span class="title function_">push</span>(listener);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">off</span>(<span class="params">event, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event] = <span class="literal">null</span>; <span class="comment">//无listener全部移除</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event] = <span class="variable language_">this</span>.<span class="property">events</span>[event].<span class="title function_">filter</span>(</span><br><span class="line">        <span class="function">(<span class="params">item</span>) =&gt;</span> item !== listener</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>; <span class="comment">//链式调用</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">once</span>(<span class="params">event, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">func</span> = (<span class="params">...args</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">off</span>(event, listener);</span><br><span class="line">      listener.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">on</span>(event, func);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">event, ...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="variable language_">this</span>.<span class="property">events</span>[event];</span><br><span class="line">    <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;no listeners&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listeners.<span class="title function_">forEach</span>(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">      cb.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h1><ul>
<li>fs：⽂件系统，能够读取写⼊当前安装系统环境中硬盘的数据</li>
<li>path：路径系统，能够处理路径之间的问题</li>
<li>crypto：加密相关模块，能够以标准的加密⽅式对我们的内容进⾏加解密</li>
<li>dns：处理 dns 相关内容，例如我们可以设置 dns 服务器等等</li>
<li>http: 设置⼀个 http 服务器，发送 http 请求，监听响应等等</li>
<li>readline: 读取 stdin 的⼀⾏内容，可以读取、增加、删除我们命令⾏中的内容</li>
<li>os：操作系统层⾯的⼀些 api，例如告诉你当前系统类型及⼀些参数</li>
<li>vm: ⼀个专⻔处理沙箱的虚拟机模块，底层主要来调⽤ v8 相关 api 进⾏代码解析</li>
<li>promisify：可以把异步函数回调形式改为 promise 形式。</li>
</ul>
<h2 id="fs"><a href="#fs" class="headerlink" title="fs"></a>fs</h2><ul>
<li>文件常识<ul>
<li>权限位 mode：文件所有者&#x2F;文件所属组&#x2F;其他用户的 rwx，eg：默认 0o666，对应十进制 438</li>
<li>标志位 flag：文件的操作方式，r、w、s 同步、+增加相反操作、x 排他方式</li>
<li>文件描述符 fd：识别和追踪文件</li>
</ul>
</li>
<li>完整性读写文件操作<ul>
<li>fs.readFile(filename,[encoding],[callback(error,data)]</li>
<li>fs.writeFile(filename,data,[options],callback)<ul>
<li>options：可选，为对象，{encoding, mode, flag}</li>
<li>默认编码为 utf8，模式为 0666（可读可写可操作），flag 为 ‘w’</li>
</ul>
</li>
<li>fs.unlink(filename, callback)</li>
</ul>
</li>
<li>指定位置读写文件操作(高级文件操作)<ul>
<li>fs.open(path,flags,[mode],callback)</li>
<li>fs.read(fd, buffer, offset, length, position, callback);</li>
<li>fs.write(fd, buffer, offset, length, position, callback);</li>
<li>fs.close(fd,callback)</li>
</ul>
</li>
</ul>
<ol>
<li>fd：文件描述符，需要先使用 open 打开，使用 fs.open 打开成功后返回的文件描述符；</li>
<li>buffer：一个 Buffer 对象，v8 引擎分配的一段内存，要将内容读取到的 Buffer；</li>
<li>offset：整数，向 Buffer 缓存区写入的初始位置，以字节为单位；</li>
<li>length：整数，读取文件的长度；</li>
<li>position：整数，读取文件初始位置；文件大小以字节为单位</li>
<li>callback：回调函数，有三个参数 err（错误），bytesRead（实际读取的字节数），buffer（被写入的缓存区对象），读取执行完成后执行。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//nodejs中最好使用绝对路径</span></span><br><span class="line"><span class="keyword">const</span> pathToFile = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./text&quot;</span>);</span><br><span class="line"><span class="comment">//err first, 异步</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(pathTofile, <span class="string">&quot;utf-8&quot;</span>, <span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;e&quot;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result&quot;</span>, result);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//同步文件</span></span><br><span class="line">fs.<span class="title function_">readFileSync</span>(pathToFile, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//耦合promise封装</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">    fs.<span class="title function_">readFile</span>(path, &#123; <span class="attr">flag</span>: <span class="string">&quot;r&quot;</span>, <span class="attr">encoding</span>: <span class="string">&quot;utf-8&quot;</span> &#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">// 失败执行的内容</span></span><br><span class="line">        <span class="title function_">reject</span>(err);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 成功执行的内容</span></span><br><span class="line">        <span class="title function_">resolve</span>(data);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通用promise封装，高版本已内置该库</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">promisify</span>(<span class="params">func</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      args.<span class="title function_">push</span>(<span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">reject</span>(err);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(result);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> func.<span class="title function_">apply</span>(func, args);</span><br><span class="line">      <span class="comment">/* 等价于</span></span><br><span class="line"><span class="comment">      fs.readFile(path, &#123; flag: &#x27;r&#x27;, encoding: &#x27;utf-8&#x27; &#125;, function (err, data) &#123;</span></span><br><span class="line"><span class="comment">      	if (err) &#123;</span></span><br><span class="line"><span class="comment">        	// 失败执行的内容</span></span><br><span class="line"><span class="comment">        	reject(err)</span></span><br><span class="line"><span class="comment">      	&#125; else &#123;</span></span><br><span class="line"><span class="comment">        	// 成功执行的内容</span></span><br><span class="line"><span class="comment">        	resolve(data)</span></span><br><span class="line"><span class="comment">      	&#125;</span></span><br><span class="line"><span class="comment">    	&#125;) */</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> creadFileAsync = <span class="title function_">promisify</span>(fs.<span class="property">readFile</span>);</span><br><span class="line"><span class="title function_">creadFileAsync</span>(pathToFile, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">content</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(content);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;e&quot;</span>, e);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="大文件拷贝"><a href="#大文件拷贝" class="headerlink" title="大文件拷贝"></a>大文件拷贝</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// copy 方法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">src, dest, size = <span class="number">16</span> * <span class="number">1024</span>, callback</span>) &#123;</span><br><span class="line">  <span class="comment">// 打开源文件</span></span><br><span class="line">  fs.<span class="title function_">open</span>(src, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, readFd</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 打开目标文件</span></span><br><span class="line">    fs.<span class="title function_">open</span>(dest, <span class="string">&#x27;w&#x27;</span>, <span class="function">(<span class="params">err, writeFd</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(size);</span><br><span class="line">      <span class="keyword">let</span> readed = <span class="number">0</span>; <span class="comment">// 下次读取文件的位置</span></span><br><span class="line">      <span class="keyword">let</span> writed = <span class="number">0</span>; <span class="comment">// 下次写入文件的位置</span></span><br><span class="line"></span><br><span class="line">      (<span class="keyword">function</span> <span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 读取</span></span><br><span class="line">        fs.<span class="title function_">read</span>(readFd, buf, <span class="number">0</span>, size, readed, <span class="function">(<span class="params">err, bytesRead</span>) =&gt;</span> &#123;</span><br><span class="line">          readed += bytesRead;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 如果都不到内容关闭文件</span></span><br><span class="line">          <span class="keyword">if</span> (!bytesRead) fs.<span class="title function_">close</span>(readFd, <span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;关闭源文件&#x27;</span>));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 写入</span></span><br><span class="line">          fs.<span class="title function_">write</span>(writeFd, buf, <span class="number">0</span>, bytesRead, writed, <span class="function">(<span class="params">err, bytesWritten</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 如果没有内容了同步缓存，并关闭文件后执行回调</span></span><br><span class="line">            <span class="keyword">if</span> (!bytesWritten) &#123;</span><br><span class="line">              fs.<span class="title function_">fsync</span>(writeFd, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                fs.<span class="title function_">close</span>(writeFd, <span class="function"><span class="params">err</span> =&gt;</span> <span class="keyword">return</span> !err &amp;&amp; <span class="title function_">callback</span>());</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            writed += bytesWritten;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 继续读取、写入</span></span><br><span class="line">            <span class="title function_">next</span>();</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="目录-文件夹-操作"><a href="#目录-文件夹-操作" class="headerlink" title="目录(文件夹)操作"></a>目录(文件夹)操作</h4><ul>
<li>fs.mkdir: 创建目录</li>
<li>fs.rmdir: 删除目录</li>
<li>fs.access: 判断文件或目录是否有操作权限</li>
<li>fs.stat: 获取目录及文件信息</li>
<li>fs.readdir: 读取目录中内容</li>
<li>fs.unlink: 删除指定文件</li>
</ul>
<h2 id="path"><a href="#path" class="headerlink" title="path"></a>path</h2><ul>
<li>path.join([path1][, path2][, …])：连接路径，主要用途在于，会正确使用当前系统的路径分隔符</li>
<li>path.resolve([from …], to)：用于返回绝对路径，类似于多次 cd 处理</li>
<li>path.dirname(p)：返回文件夹</li>
<li>path.extname(p)：返回后缀名</li>
<li>path.basename(p)：返回路径中的最后一部分,也就是名称</li>
<li>path.parse(): 解析路径,返回数组</li>
<li>path.format(): 序列化路径,将上面的数组重组成路径.</li>
<li>path.normalize(): 规范化路径</li>
<li>path.isAbsolute(): 判断传入路径是否是绝对路径</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接路径：/test/test1/2slashes/1slash</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;join path : &#x27;</span> + path.<span class="title function_">join</span>(<span class="string">&#x27;/test&#x27;</span>, <span class="string">&#x27;test1&#x27;</span>, <span class="string">&#x27;2slashes/1slash&#x27;</span>, <span class="string">&#x27;tab&#x27;</span>, <span class="string">&#x27;..&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换为绝对路径：/Users/jian/workspace/cjs/main.js</span></span><br><span class="line"><span class="keyword">const</span> mainPath = path.<span class="title function_">resolve</span>(<span class="string">&#x27;main.js&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;resolve : &#x27;</span> + mainPath);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>()) <span class="comment">// 什么都不传,返回绝对路径,不包含文件名.</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>)) <span class="comment">//返回绝对路径拼接/a/b</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;a&#x27;</span>,<span class="regexp">/b&#x27;)) /</span><span class="regexp">/ 返回`/</span>b<span class="string">`</span></span><br><span class="line"><span class="string">// resolve接收两部分参数,如果to的部分有路径(包含/),就返回&#x27;/xxx&#x27;,</span></span><br><span class="line"><span class="string">// 如果不含路径,就将当前目录的绝对路径拼接上</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 路径中文件的后缀名：.js</span></span><br><span class="line"><span class="string">console.log(&#x27;ext name : &#x27; + path.extname(mainPath));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 路径最后名字：main.js</span></span><br><span class="line"><span class="string">console.log(&#x27;ext name : &#x27; + path.basename(mainPath));</span></span><br></pre></td></tr></table></figure>

<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建服务器</span></span><br><span class="line">http</span><br><span class="line">  .<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">request, response</span>) &#123;</span><br><span class="line">    <span class="comment">// 解析请求，包括文件名</span></span><br><span class="line">    <span class="keyword">var</span> pathname = url.<span class="title function_">parse</span>(request.<span class="property">url</span>).<span class="property">pathname</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出请求的文件名</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Request for &quot;</span> + pathname + <span class="string">&quot; received.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文件系统中读取请求的文件内容</span></span><br><span class="line">    fs.<span class="title function_">readFile</span>(pathname.<span class="title function_">substr</span>(<span class="number">1</span>), <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">        <span class="comment">// HTTP 状态码: 404 : NOT FOUND</span></span><br><span class="line">        <span class="comment">// Content Type: text/html</span></span><br><span class="line">        response.<span class="title function_">writeHead</span>(<span class="number">404</span>, &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/html&quot;</span> &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// HTTP 状态码: 200 : OK</span></span><br><span class="line">        <span class="comment">// Content Type: text/html</span></span><br><span class="line">        response.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/html&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 响应文件内容</span></span><br><span class="line">        response.<span class="title function_">write</span>(data.<span class="title function_">toString</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//  发送响应数据</span></span><br><span class="line">      response.<span class="title function_">end</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台会输出以下信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Server running at http://127.0.0.1:8080/&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h2><p>Buffer 用于读取或操作二进制数据流，做为 Node.js API 的一部分使用时无需 require，用于操作网络协议、数据库、图片和文件 I&#x2F;O 等一些需要大量二进制数据的场景。Buffer 在创建时大小已经被确定且是无法调整的.<br>Buffer 是单独创建的,不占用 V8 的内存空间.</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p><strong>Buffer 的创建</strong><br>在此之前我们需要去简单的学习依一下 Buffer 的两个 API</p>
<ul>
<li>Buffer.from(): 根据现有的数据结构去创建 buffer 数据</li>
<li>Buffer.alloc(): 指定 buffer 数据的长度来创建 buffer 数据</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个长度为 10、且用零填充的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf1 = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">10</span>); <span class="comment">// &lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个长度为 10、且用 0x1 填充的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf2 = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">10</span>, <span class="number">1</span>); <span class="comment">// &lt;Buffer 01 01 01 01 01 01 01 01 01 01&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个长度为 10、且未初始化的 Buffer。</span></span><br><span class="line"><span class="comment">// 这个方法比调用 Buffer.alloc() 更快，</span></span><br><span class="line"><span class="comment">// 但返回的 Buffer 实例可能包含旧数据，</span></span><br><span class="line"><span class="comment">// 因此需要使用 fill() 或 write() 重写。</span></span><br><span class="line"><span class="keyword">const</span> buf3 = <span class="title class_">Buffer</span>.<span class="title function_">allocUnsafe</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含 [0x1, 0x2, 0x3] 的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf4 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]); <span class="comment">// &lt;Buffer 01 02 03&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含 UTF-8 字节 [0x74, 0xc3, 0xa9, 0x73, 0x74] 的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf5 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;tést&quot;</span>); <span class="comment">// &lt;Buffer 74 c3 a9 73 74&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含 Latin-1 字节 [0x74, 0xe9, 0x73, 0x74] 的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf6 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;tést&quot;</span>, <span class="string">&quot;latin1&quot;</span>); <span class="comment">// &lt;Buffer 74 e9 73 74&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Buffer 的读写</strong><br>关于 Buffer 的数据读取在官网上有很多方法：如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">buf.<span class="title function_">readBigInt64BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readBigInt64LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readBigUInt64BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readBigUInt64LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readDoubleBE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readDoubleLE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readFloatBE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readFloatLE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt8</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt16BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt16LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt32BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt32LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readIntBE</span>(offset, byteLength);</span><br><span class="line">buf.<span class="title function_">readIntLE</span>(offset, byteLength);</span><br><span class="line">buf.<span class="title function_">readUInt8</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt16BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt16LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt32BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt32LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUIntBE</span>(offset, byteLength);</span><br><span class="line">buf.<span class="title function_">readUIntLE</span>(offset, byteLength);</span><br></pre></td></tr></table></figure>

<p>这些方法名称有 BE 和 LE 的区别，这个大段和小段的意思，说白了就是方向的问题，而 Int8 是没有 BE 和 LE 的区别的，我们用代码来演示一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">buffer2.<span class="title function_">writeInt8</span>(<span class="number">12</span>, <span class="number">1</span>); <span class="comment">// 在buffer2的第二位写入一个int8 的数字12</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer2); <span class="comment">// &lt;Buffer 01 0c 03 04&gt;</span></span><br><span class="line"></span><br><span class="line">buffer2.<span class="title function_">writeInt16BE</span>(<span class="number">512</span>, <span class="number">2</span>); <span class="comment">// 在buffer2的第三位开始写一个 int16的数字 512</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer2); <span class="comment">// &lt;Buffer 01 0c 02 00&gt;</span></span><br><span class="line"></span><br><span class="line">buffer2.<span class="title function_">writeInt16LE</span>(<span class="number">512</span>, <span class="number">2</span>); <span class="comment">// 在buffer2的第三位开始写一个 int16的数字 512</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer2); <span class="comment">// &lt;Buffer 01 0c 00 02&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以你看到了，因为 int8 类型的数字只占一位，所以不存在方向不方向的问题，而 int16 类型的数字要占两位，比如 512 用 16 进制表示就是 [02 00],所以使用 BE 表示正方向，而 LE 表示反方向。具体使用什么样的表示方法要和被人协商议定</p>
<h3 id="实例属性"><a href="#实例属性" class="headerlink" title="实例属性"></a>实例属性</h3><ul>
<li>buf.length:返回内存中分配给 buf 的字节数。 不一定反映 buf 中可用数据的字节量。</li>
<li>buf.toString:根据 encoding 指定的字符编码将 buf 解码成字符串</li>
<li>buf.fill:用指定的 value 填充 buf。 如果没有指定 offset 与 end，则填充整个 buf</li>
<li>buf.equals:如果 buf 与参数具有完全相同的字节，则返回 true，否则返回 false</li>
<li>buf.indexOf:是否包含参数，包含则返回所在下标，不包含返回-1</li>
<li>buf.slice: 截取 buffer</li>
<li>buf.copy: 拷贝 buffer 中的数据</li>
</ul>
<h3 id="常用静态属性"><a href="#常用静态属性" class="headerlink" title="常用静态属性"></a>常用静态属性</h3><h4 id="Buffer-byteLength"><a href="#Buffer-byteLength" class="headerlink" title="Buffer.byteLength"></a>Buffer.byteLength</h4><p>这个表示整个 buffer 实际所占的字节数，因为不同的语言可能有不同的问题，比如英文字母在表达的时候一个字母就是一个字节，而中文用三个字节来表达汉字</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">byteLength</span>(<span class="string">&quot;test&quot;</span>)); <span class="comment">// 4</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">byteLength</span>(<span class="string">&quot;测试&quot;</span>)); <span class="comment">// 6</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;test&quot;</span>).<span class="property">length</span>); <span class="comment">// 4</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;测试&quot;</span>).<span class="property">length</span>); <span class="comment">// 6</span></span><br></pre></td></tr></table></figure>

<h4 id="Buffer-isBuffer"><a href="#Buffer-isBuffer" class="headerlink" title="Buffer.isBuffer"></a>Buffer.isBuffer</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(&#123;&#125;)); <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;test&quot;</span>))); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]))); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="Buffer-concat"><a href="#Buffer-concat" class="headerlink" title="Buffer.concat"></a>Buffer.concat</h4><p>拼接 Buffer，注意的是里面不是传入多个 Buffer 对象，而是一个 Buffer 的数组</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> buf1 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;This &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;is &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf3 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;buffer &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf4 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;test &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf5 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;demo &quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bufConcat = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([buf1, buf2, buf3, buf4, buf5]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bufConcat.<span class="title function_">toString</span>()); <span class="comment">// This is buffer test demo</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义-Buffer-split-拆分"><a href="#自定义-Buffer-split-拆分" class="headerlink" title="自定义 Buffer: split 拆分"></a>自定义 Buffer: split 拆分</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ArrayBuffer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">split</span> = <span class="keyword">function</span> (<span class="params">sep</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> len = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(sep).<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">let</span> ret = [];</span><br><span class="line">  <span class="keyword">let</span> start = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ((offset = <span class="variable language_">this</span>.<span class="title function_">indexOf</span>(sep, start) !== -<span class="number">1</span>)) &#123;</span><br><span class="line">    ret.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">slice</span>(start, offset));</span><br><span class="line">    start = offset + len;</span><br><span class="line">  &#125;</span><br><span class="line">  ret.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">slice</span>(start));</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="string">&quot;吃馒头, 吃面条, 吃所有&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> bufArr = buf.<span class="title function_">split</span>(<span class="string">&quot;吃&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="乱码问题"><a href="#乱码问题" class="headerlink" title="乱码问题"></a>乱码问题</h3><p>乱码的出现因为是汉字是三个字节的，现在 11 个字节不是三个倍数，没有办法正确按照每 3 个字节解析汉字，我们的解决方法是：使用内置的 string_decoder（字符串解码器）来解析 Buffer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">StringDecoder</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;string_decoder&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> decoder = <span class="keyword">new</span> <span class="title class_">StringDecoder</span>(<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;我正在学习&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf1); <span class="comment">// &lt;Buffer e6 88 91 e6 ad a3 e5 9c a8 e5 ad a6 e4 b9 a0&gt;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; buf1.<span class="property">length</span>; i += <span class="number">5</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> buf2 = <span class="title class_">Buffer</span>.<span class="title function_">allocUnsafe</span>(<span class="number">5</span>);</span><br><span class="line">  buf1.<span class="title function_">copy</span>(buf2, <span class="number">0</span>, i);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(decoder.<span class="title function_">write</span>(buf2));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &lt;Buffer e6 88 91 e6 ad a3 e5 9c a8 e5 ad a6 e4 b9 a0&gt;</span></span><br><span class="line"><span class="comment">//我</span></span><br><span class="line"><span class="comment">//正在</span></span><br><span class="line"><span class="comment">//学习</span></span><br></pre></td></tr></table></figure>

<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><h4 id="I-x2F-O-操作"><a href="#I-x2F-O-操作" class="headerlink" title="I&#x2F;O 操作"></a>I&#x2F;O 操作</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> inputStream = fs.<span class="title function_">createReadStream</span>(<span class="string">&quot;input.txt&quot;</span>); <span class="comment">// 创建可读流</span></span><br><span class="line"><span class="keyword">const</span> outputStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&quot;output.txt&quot;</span>); <span class="comment">// 创建可写流</span></span><br><span class="line"></span><br><span class="line">inputStream.<span class="title function_">pipe</span>(outputStream); <span class="comment">// 管道读写</span></span><br></pre></td></tr></table></figure>

<p>在 Stream 中我们是不需要手动去创建自己的缓冲区，在 Node.js 的流中将会自动创建。</p>
<h4 id="加密解密"><a href="#加密解密" class="headerlink" title="加密解密"></a>加密解密</h4><p>在一些加解密算法中会遇到使用 Buffer，例如 crypto.createCipheriv 的第二个参数 key 为 String 或 Buffer 类型，如果是 Buffer 类型，就用到了本篇我们讲解的内容，以下做了一个简单的加密示例，重点使用了 Buffer.alloc()初始化一个实例（这个上面有介绍），之后使用了 fill 方法做了填充，这里重点在看下这个方法的使用。 <strong>buf.fill(value[, offset[, end]][, encoding])</strong></p>
<ul>
<li>value: 第一个参数为要填充的内容</li>
<li>offset: 偏移量，填充的起始位置</li>
<li>end: 结束填充 buf 的偏移量</li>
<li>encoding: 编码集</li>
</ul>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p><strong>Buffer 和 Cache 的区别</strong></p>
<ul>
<li>缓冲（Buffer）是用于处理二进制流数据，将数据缓冲起来，它是临时性的，对于流式数据，会采用缓冲区将数据临时存储起来，等缓冲到一定的大小之后在存入硬盘中。视频播放器就是一个经典的例子，有时你会看到一个缓冲的图标，这意味着此时这一组缓冲区并未填满，当数据到达填满缓冲区并且被处理之后，此时缓冲图标消失，你可以看到一些图像数据。</li>
<li>缓存（Cache）我们可以看作是一个中间层，它可以是永久性的将热点数据进行缓存，使得访问速度更快，例如我们通过 Memory、Redis 等将数据从硬盘或其它第三方接口中请求过来进行缓存，目的就是将数据存于内存的缓存区中，这样对同一个资源进行访问，速度会更快，也是性能优化一个重要的点。</li>
</ul>
<p><strong>Buffer 与 String 比较</strong><br>在 HTTP 传输中传输的是二进制数据，那么如果使用 Buffer 和 String 情况如下：</p>
<ul>
<li>接口如果直接返回的字符串，这时候 HTTP 在传输之前会先将字符串转换为 Buffer 类型，以二进制数据传输，通过流（Stream）的方式一点点返回到客户端。</li>
<li>但是直接返回 Buffer 类型，则少了每次的转换操作，对于性能也是有提升的。</li>
</ul>
<p>所以在一些 Web 应用中，对于静态数据可以预先转为 Buffer 进行传输，可以有效减少 CPU 的重复使用（重复的字符串转 Buffer 操作）</p>
<h2 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>在 node 当中 stream 是一种处理流数据的抽象接口，stream 模块提供了一系列实现流的 API,在 node 当中提供了很多关于流的对象，比如 http 服务器的请求和 process.stdout 标准输出都是流的实例，流是可读的，可写的，同时也可以是可读写的，所有的流都是 EventEmitter 的实例。</p>
<blockquote>
<p>之所以用 stream ，是因为一次性读取、操作大文件，内存和网络是“吃不消”的，因此要让数据流动起来，一点一点的进行操作,这其实也符合算法中一个很重要的思想 —— 分而治之</p>
</blockquote>
<h3 id="流转和应用"><a href="#流转和应用" class="headerlink" title="流转和应用"></a>流转和应用</h3><ul>
<li>data 事件: 用来监听 stream 数据的流入</li>
<li>end 事件：用来监听 stream 数据输入的完成</li>
<li>pipe 方法: 用来做数据流转</li>
</ul>
<p><strong>① stream 从哪里来-soucre</strong><br>stream 的常见来源方式有三种：</p>
<ul>
<li>从控制台输入</li>
<li>http 请求中的 request</li>
<li>读取文件</li>
</ul>
<p>这里先说一下从控制台输入这种方式，看一段 process.stdin 的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">process.<span class="property">stdin</span>.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stream by stdin&quot;</span>, chunk); <span class="comment">// stream by stdin &lt;Buffer 6b 6f 61 6c 61 6b 6f 61 6c 61 0a&gt;</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stream by stdin&quot;</span>, chunk.<span class="title function_">toString</span>()); <span class="comment">// stream by stdin koalakoala</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后从控制台输入任何内容都会被 data 事件监听到，process.stdin 就是一个 stream 对象,data 是 stream 对象用来监听数据传入的一个自定义函数， (说明： stream 对象可以监听”data”,”end”,”opne”,”close”,”error”等事件。node.js 中监听自定义事件使用.on 方法，例如 process.stdin.on(‘data’,…), req.on(‘data’,…),通过这种方式，能很直观的监听到 stream 数据的传入和结束)<br><strong>② 连接水桶的管道-pipe</strong><br>从水桶管道流转图中可以看到，在 source 和 dest 之间有一个连接的管道 pipe,它的基本语法是 source.pipe(dest) ，source 和 dest 就是通过 pipe 连接，让数据从 source 流向了 dest。<br><strong>③ stream 到哪里去-dest</strong><br>stream 的常见输出方式有三种：</p>
<ul>
<li>输出控制台</li>
<li>http 请求中的 response</li>
<li>写入文件</li>
</ul>
<p>我们上面借助控制台输入输出来讲解了 stream 的流转过程，可是在实际应用场景中，http 请求和文件操作当中使用 stream 的频率异常的频繁。原因是这样：<br>http 请求和文件操作都属于 IO ，即 stream 主要的应用场景就是处理 IO ，这就又回到了 stream 的本质 —— 由于一次性 IO 操作过大，硬件开销太多，影响软件运行效率，因此将 IO 分批分段操作，让数据一点一点的流动起来，直到操作完成 。</p>
<h3 id="http-中的-steam"><a href="#http-中的-steam" class="headerlink" title="http 中的 steam"></a>http 中的 steam</h3><h4 id="get-请求"><a href="#get-请求" class="headerlink" title="get 请求"></a>get 请求</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// get 请求</span></span><br><span class="line">    <span class="keyword">const</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> stream = fs.<span class="title function_">createReadStream</span>(fileName);</span><br><span class="line">    stream.<span class="title function_">pipe</span>(res); <span class="comment">// 将 res 作为 stream 的 dest</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他method暂时忽略</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>从上面例子可以看出，对 response 使用 stream 特性能提高性能。因此，在 nodejs 中如果要返回的数据是经过 IO 操作得来的，例如上面例子中读取文件内容，可以直接使用 stream.pipe(res) ,毕竟 response 也是一个 stream 对象，可以作为参数传入 pipe 当中，而不要再用 res.end(data)了。<br>这种应用的实例应该比较多，主要有两种场景：</p>
<ul>
<li>使用 node.js 作为服务代理，即客户端通过 node.js 服务作为跳板去请求其他服务，返回请求的内容</li>
<li>使用 node.js 做静态文件服务器，直接返回静态文件</li>
</ul>
<h4 id="post-请求"><a href="#post-请求" class="headerlink" title="post 请求"></a>post 请求</h4><p>web server 接收 http 请求肯定是通过 request，而 request 接收数据的本质其实就是 stream。所以 看似是 request 接收数据，但是在服务端的角度来说，request 就是产生数据的 source,那么 soucre 类型的 stream 对象都能监听 data,end 事件。分别触发数据接收和数据接收完成的通知，所以代码可以如下进行改造：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 暂只关注 post 请求</span></span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">      <span class="comment">// 接收到部分数据</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;chunk&quot;</span>, chunk.<span class="title function_">toString</span>().<span class="property">length</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 接收数据完成</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他请求方法暂不关心</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>总结一下，request 和 response 一样，本身也是一个 stream 对象，可以用 stream 的特性，那肯定也能提高性能。两者的区别就在于，request 是 source 类型的、是 stream 的源头，而 response 是 dest 类型的、是 stream 的目的地。<br>这里再多举个例子，比如我们现在要将 node.js 接收到的 post 请求的数据写入文件，一般的小伙伴会这样写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 暂只关注 post 请求</span></span><br><span class="line">    <span class="keyword">var</span> dataStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">      <span class="comment">// 接收到数据，先存储起来</span></span><br><span class="line">      <span class="keyword">var</span> chunkStr = chunk.<span class="title function_">toString</span>();</span><br><span class="line">      dataStr += chunkStr;</span><br><span class="line">    &#125;);</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 接收数据完成，将数据写入文件</span></span><br><span class="line">      <span class="keyword">var</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;post.txt&quot;</span>);</span><br><span class="line">      fs.<span class="title function_">writeFile</span>(fileName, dataStr);</span><br><span class="line"></span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他请求方法暂不关心</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>这种写法也是对的，但是还没有真正理解 stream，当我们学习了文件操作中的 stream，你可能就 hi 写出更简单的代码，比如说下面这种：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 暂只关注 post 请求</span></span><br><span class="line">    <span class="keyword">var</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;post.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> writeStream = fs.<span class="title function_">createWriteStream</span>(fileName);</span><br><span class="line">    req.<span class="title function_">pipe</span>(writeStream);</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 接收数据完成</span></span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他请求方法暂不关心</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>和 get 请求使用 stream 的场景类似，post 请求使用 stream 的场景，主要是用于将接收的数据直接进行 IO 操作，例如：</p>
<ul>
<li>将接受的数据直接存储为文件</li>
<li>将接受的数据直接 post 给其他的 web server</li>
</ul>
<h3 id="fs-中的-stream"><a href="#fs-中的-stream" class="headerlink" title="fs 中的 stream"></a>fs 中的 stream</h3><p>用 stream 读写文件其实前面章节都有多处用到，这里在统一整理一下：</p>
<ul>
<li>可以使用 fs.createReadStream(fileName)来创建读取文件的 stream 对象</li>
<li>可以使用 fs.createWriteStream(fileName)来创建写入文件的 stream 对象</li>
</ul>
<p>读取文件的 stream 对象，对应的就是 source，即数据的来源。写入文件的 steram 对象对应的就是 dest ，即数据的目的地。下面我们分别用普通的读写和使用 stream 实现一个文件拷贝的功能，并通过监控工具 memeye 来监控 node.js 内存占用的情况</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> memeye = <span class="built_in">require</span>(<span class="string">&quot;memeye&quot;</span>);</span><br><span class="line"><span class="title function_">memeye</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">num</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> fileName1 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>); <span class="comment">// 42kb左右</span></span><br><span class="line">  fs.<span class="title function_">readFile</span>(fileName1, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;读取出错&quot;</span>, err.<span class="property">message</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dataStr = data.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName2 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data-bak.txt&quot;</span>);</span><br><span class="line">    fs.<span class="title function_">writeFile</span>(fileName2, dataStr, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;写入出错&quot;</span>, err.<span class="property">message</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`拷贝第<span class="subst">$&#123;num&#125;</span>次成功`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">copy</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<p>启动文件，在浏览器打开 localhost:23333&#x2F;,可以看到 heapUsed 在 13.26M 左右，heapTotal 在 30M 左右，rss 在 40M 左右</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> memeye = <span class="built_in">require</span>(<span class="string">&quot;memeye&quot;</span>);</span><br><span class="line"><span class="title function_">memeye</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">num</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> fileName1 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>); <span class="comment">// 42KB左右</span></span><br><span class="line">  <span class="keyword">var</span> fileName2 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data-bak.txt&quot;</span>);</span><br><span class="line">  <span class="comment">// 读取文件的stream对象</span></span><br><span class="line">  <span class="keyword">var</span> readStream = fs.<span class="title function_">createReadStream</span>(fileName1);</span><br><span class="line">  <span class="comment">// 写入文件的stream对象</span></span><br><span class="line">  <span class="keyword">var</span> writeStream = fs.<span class="title function_">createWriteStream</span>(fileName2);</span><br><span class="line">  <span class="comment">// 通过pipe实现数据的流转</span></span><br><span class="line">  readStream.<span class="title function_">pipe</span>(writeStream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听数据完成的情况</span></span><br><span class="line">  readStream.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;拷贝完成&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">copy</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<p>启动文件，在浏览器打开 localhost:23333&#x2F;,可以看到 heapUsed 在 6.4M 左右，heapTotal 在 9.23M 左右，rss 在 30M 左右</p>
<p>总结：所有执行文件操作的场景，都应该尝试使用 stream ，例如文件的读写、拷贝、压缩、解压、格式转换等。除非是体积很小的文件，而且读写次数很少，性能上被忽略。如果是体积很大或者读写次数很多的情况下，建议使用 stream 来优化性能</p>
<h3 id="逐行读取-readline"><a href="#逐行读取-readline" class="headerlink" title="逐行读取 readline"></a>逐行读取 readline</h3><p>用 stream 操作文件，会来带很大的性能提升。但是原生的 stream 却对“行”无能为力，它只是把文件当做一个数据流、简单粗暴的流动。很多文件格式都是分行的，例如 csv 文件、日志文件，以及其他一些自定义的文件格式。</p>
<p>node.js 提供了非常简单的按行读取的 API —— readline，它本质上也是 stream，只不过是以“行”作为数据流动的单位。本节将结合一个分析日志文件的案例，讲解 readline 的使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> readline = <span class="built_in">require</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> readStream = fs.<span class="title function_">createReadStream</span>(fileName);</span><br><span class="line"><span class="comment">// 创建readline对象</span></span><br><span class="line"><span class="keyword">var</span> readlineObj = readline.<span class="title function_">createInterface</span>(&#123;</span><br><span class="line">  <span class="attr">input</span>: readStream,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">readlineObj.<span class="title function_">on</span>(<span class="string">&quot;line&quot;</span>, <span class="function">(<span class="params">lineDate</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(lineDate);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;---- line ----&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">readlineObj.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>对 readline 最常见的使用应该是日志的逐行分析了，比如我们要从一个 10 万行的日志中去找一个 2018-10-23 14:00 这一分钟，对 user.html 的访问次数，我们就应该这样做</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line"><span class="comment">// 逐行读取日志内容，如果有包含`2018-10-23 14:00`和`user.html`的字符串就表示</span></span><br><span class="line"><span class="comment">// 在这一分钟有人访问了user.html,我们就记录一次</span></span><br><span class="line">readlineObj.<span class="title function_">on</span>(<span class="string">&#x27;line&#x27;</span>，<span class="keyword">function</span>(<span class="params">lineData</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(lineData.<span class="title function_">indexOf</span>(<span class="string">&#x27;2018-10-23 14:00&#x27;</span>)&gt;=<span class="number">0</span> &amp;&amp; lineData.<span class="title function_">indexOf</span>(<span class="string">&#x27;user.html&#x27;</span>) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">        num++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听读取完成</span></span><br><span class="line">readline.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>,<span class="function">()=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;num&#x27;</span>,num)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>借用这个简单的例子来演示 readline 的使用以及使用场景，其实日常工作中情况会更加复杂，不过再复杂的场景选择 readline 做逐行分析一定是不会错的。方向选对了很重要，选择大于努力.</p>
<h3 id="stream-的种类"><a href="#stream-的种类" class="headerlink" title="stream 的种类"></a>stream 的种类</h3><h4 id="readable-stream"><a href="#readable-stream" class="headerlink" title="readable stream"></a>readable stream</h4><p>可读流是对提供数据的来源的一种抽象。<br>可读流的例子包括：客户端的 HTTP 响应、服务器的 HTTP 请求、fs 的读取流、zilb 流、crypto 流、TCP socket、子进程 stdout 与 stderr、process.stdin，因为这些可读流都实现了 stream.Readable 类定义的接口</p>
<ul>
<li>readable 事件: 当流中存在可读取数据时触发</li>
<li>data 事件: 当流中数据块传给消费者时触发</li>
</ul>
<h4 id="writeable-stream"><a href="#writeable-stream" class="headerlink" title="writeable stream"></a>writeable stream</h4><p>可写流是对数据要被写入的目的地的一种抽象.<br>可写流内部可写入的数据只支持 Buffer 和字符串.<br>可写流的例子包括：客户端的 HTTP 响应、服务器的 HTTP 请求、fs 的读取流、zilb 流、crypto 流、TCP socket、子进程 stdout 与 stderr、process.stdin，因为这些可写流都实现了 stream.Writable 类定义的接口</p>
<ul>
<li>pipe 事件: 可读流调用 pipe()方法时触发</li>
<li>unpipe 事件: 可读流调用 unpipe()方法时触发</li>
</ul>
<h4 id="duplex-stream"><a href="#duplex-stream" class="headerlink" title="duplex stream"></a>duplex stream</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> zlib = <span class="built_in">require</span>(<span class="string">&quot;zlib&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> readStream = fs.<span class="title function_">createReadStream</span>(<span class="string">&quot;./data.txt&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> writeStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&quot;./data-bak.txt&quot;</span>);</span><br><span class="line">readStream.<span class="title function_">pipe</span>(zlib.<span class="title function_">createGzip</span>()).<span class="title function_">pipe</span>(writeStream);</span><br></pre></td></tr></table></figure>

<p>pipe 的严谨用法要遵循下面三个原则：</p>
<ul>
<li>调用 pipe 的对象必须是 readable stream 或者 duplex stream 这样的具有读取数据的功能的流对象</li>
<li>pipe 中的参数对象必须是 writeable stream 或者 duplex stream 这样的具有写入数据的功能的流对象</li>
<li>pipe 支持链式调用</li>
</ul>
<h4 id="transform-stream"><a href="#transform-stream" class="headerlink" title="transform stream"></a>transform stream</h4><p>转换流（Transform）是一种 Duplex 流，但它的输出与输入是相关联的,而且一般只有触发了写入操作时才会进入_transform 方法中。 与 Duplex 流一样， Transform 流也同时实现了 Readable 和 Writable 接口。</p>
<h3 id="写入流程"><a href="#写入流程" class="headerlink" title="写入流程"></a>写入流程</h3><ol>
<li>第一次调用 write 方法时是将数据直接写入到文件中</li>
<li>第二次开始 write 方法就是将数据写入至缓存中</li>
<li>生产速度 和消费速度是不一样的，一般情况下生产速度要比消费速度快很多</li>
<li>当 flag 为 false 之后并不意味着当前次的数据不能被写入了.但是我们应该告之数据的生产者，当前的消费速度已经跟不上生产速度了，所以这个时候，一般我们会将可读流的模块修改为暂停模式。</li>
<li>当数据生产者暂停之后，消费者会慢慢的消化它内部缓存中的数据，直到可以再次被执行写入操作</li>
<li>当缓冲区可以继续写入事件如何让生产者知道? 使用 drain 事件.</li>
</ol>
<h3 id="背压机制"><a href="#背压机制" class="headerlink" title="背压机制"></a>背压机制</h3><p>因为流的读取操作中,读的速度大于写的速度,为了控制,防止内存溢出,GC 频繁调用.</p>
<h3 id="stream-有什么弊端"><a href="#stream-有什么弊端" class="headerlink" title="stream 有什么弊端"></a>stream 有什么弊端</h3><ul>
<li>用 <code>rs.pipe(ws)</code> 的方式来写文件并不是把 rs 的内容 append 到 ws 后面，而是直接用 rs 的内容覆盖 ws 原有的内容</li>
<li>已结束&#x2F;关闭的流不能重复使用，必须重新创建数据流</li>
<li>pipe 方法返回的是目标数据流，如 <code>a.pipe(b)</code> 返回的是 b，因此监听事件的时候请注意你监听的对象是否正确</li>
<li>如果你要监听多个数据流，同时你又使用了 pipe 方法来串联数据流的话，你就要写成：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data</span><br><span class="line">  .<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data end&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">pipe</span>(a)</span><br><span class="line">  .<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a end&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">pipe</span>(b)</span><br><span class="line">  .<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b end&quot;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h1 id="promisify"><a href="#promisify" class="headerlink" title="promisify"></a>promisify</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; readFile &#125; <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; promisify &#125; <span class="keyword">from</span> <span class="string">&quot;uitl&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该方法可以将read变为返回promise形式的异步函数</span></span><br><span class="line"><span class="keyword">const</span> read = <span class="title function_">promisify</span>(readFile);</span><br></pre></td></tr></table></figure>

<h1 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h1><p>可理解为一种存储数据的结构.<br>链表是一组节点组成的集合，每个节点都使用一个对象的引用来指向它的后一个节点。指向另一节点的引用讲做链。</p>
<h2 id="链表结构图"><a href="#链表结构图" class="headerlink" title="链表结构图"></a>链表结构图</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data1|<span class="function"><span class="params">next</span> =&gt;</span> data2|<span class="function"><span class="params">next</span> =&gt;</span> data3|<span class="function"><span class="params">next</span> =&gt;</span> <span class="title class_">Null</span></span><br></pre></td></tr></table></figure>

<p>data 中保存着数据，next 保存着下一个链表的引用。上图中，我们说 data2 跟在 data1 后面，而不是说 data2 是链表中的第二个元素。上图，值得注意的是，我们将链表的尾元素指向了 null 节点，表示链接结束的位置。</p>
<h2 id="有头节点的链表"><a href="#有头节点的链表" class="headerlink" title="有头节点的链表"></a>有头节点的链表</h2><p>由于链表的起始点的确定比较麻烦，因此很多链表的实现都会在链表的最前面添加一个特殊的节点，称为 <strong>头节点</strong>，表示链表的头部。进过改造，链表就成了如下的样子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Header</span>|<span class="function"><span class="params">next</span> =&gt;</span> data1|<span class="function"><span class="params">next</span> =&gt;</span> data2|<span class="function"><span class="params">next</span> =&gt;</span> data3|<span class="function"><span class="params">next</span> =&gt;</span> <span class="title class_">Null</span></span><br></pre></td></tr></table></figure>

<h2 id="插入节点"><a href="#插入节点" class="headerlink" title="插入节点"></a>插入节点</h2><p>向链表中<strong>插入一个节点</strong>的效率很高，需要修改它前面的节点(前驱)，使其指向新加入的节点，而将新节点指向原来前驱节点指向的节点即可。下面我将用图片演示如何在 data2 节点 后面插入 data4 节点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Header</span>|<span class="function"><span class="params">next</span> =&gt;</span> data1|<span class="function"><span class="params">next</span> =&gt;</span> data2|<span class="function"><span class="params">next</span> =&gt;</span> data3|<span class="function"><span class="params">next</span> =&gt;</span> <span class="title class_">Null</span></span><br><span class="line">                                  	|					∧</span><br><span class="line">  																	∨					|</span><br><span class="line">                                    data4 | next</span><br></pre></td></tr></table></figure>

<h2 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h2><p>同样，从链表中删除一个节点，也很简单。只需将待删节点的前驱节点指向待删节点的，同时将待删节点指向 null，那么节点就删除成功了。下面我们用图片演示如何从链表中删除 data4 节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Header</span>|<span class="function"><span class="params">next</span> =&gt;</span> data1|<span class="function"><span class="params">next</span> =&gt;</span> data2|<span class="function"><span class="params">next</span> =&gt;</span> data3|next  data4|next   <span class="title class_">Null</span></span><br><span class="line">                                  								|										∧</span><br><span class="line">  																								∨	----------------- |</span><br></pre></td></tr></table></figure>

<h2 id="单向链表"><a href="#单向链表" class="headerlink" title="单向链表"></a>单向链表</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">element, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">element</span> = element</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">next</span> = next</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LinkedList</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">head, size</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">head</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">size</span> = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// 获取节点</span></span><br><span class="line">  <span class="title function_">_getNode</span>(<span class="params">index</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(index&lt;<span class="number">0</span> || index &gt;= <span class="variable language_">this</span>.<span class="property">size</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;越界&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过循环链表获取prevNode</span></span><br><span class="line">    <span class="keyword">let</span> currentNode = <span class="variable language_">this</span>.<span class="property">head</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i &lt; index; i++) &#123;</span><br><span class="line">      currentNode = currentNode.<span class="property">next</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> currentNode</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 增</span></span><br><span class="line">  <span class="title function_">add</span>(<span class="params">index, element</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(argument.<span class="property">length</span> ===<span class="number">1</span>)&#123;</span><br><span class="line">      element = index</span><br><span class="line">      index = <span class="variable language_">this</span>.<span class="property">size</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断边界</span></span><br><span class="line">    <span class="keyword">if</span>(index &lt; <span class="number">0</span> || index &gt; <span class="variable language_">this</span>.<span class="property">size</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;越界</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    // 判断位置</span></span><br><span class="line"><span class="string">    if(index === 0) &#123;</span></span><br><span class="line"><span class="string">      let head = this.head // 保存原有head的指向</span></span><br><span class="line"><span class="string">      this.head = new Node(element, head) // 现在的head指向newNode</span></span><br><span class="line"><span class="string">    &#125;else &#123;</span></span><br><span class="line"><span class="string">      // 如果不在第一个位置,获取上一个节点</span></span><br><span class="line"><span class="string">      let prevNode = this._getNode(index-1)</span></span><br><span class="line"><span class="string">      // 上一Node 的next指向新节点</span></span><br><span class="line"><span class="string">      prevNode.next = new Node(element, prevNode.next)</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    // add后注意size变化</span></span><br><span class="line"><span class="string">    this.size++</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  // 删</span></span><br><span class="line"><span class="string">  remove(index)&#123;</span></span><br><span class="line"><span class="string">    let rmNode = null</span></span><br><span class="line"><span class="string">    if(index === 0) &#123;</span></span><br><span class="line"><span class="string">      //如果删的是第一个</span></span><br><span class="line"><span class="string">      rmNode = this.head</span></span><br><span class="line"><span class="string">      if(!rmNode) &#123;</span></span><br><span class="line"><span class="string">        return undefined</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      this.head = head.next</span></span><br><span class="line"><span class="string">    &#125; else &#123;</span></span><br><span class="line"><span class="string">      let prevNode = _getNode(index -1)</span></span><br><span class="line"><span class="string">      rmNode = prevNode.next</span></span><br><span class="line"><span class="string">      prevNode.next = rmNode.next</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    this.size--</span></span><br><span class="line"><span class="string">    return rmNode</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  // 改</span></span><br><span class="line"><span class="string">  set(index, element) &#123;</span></span><br><span class="line"><span class="string">    let node = _getNode(index)</span></span><br><span class="line"><span class="string">    node.element = element</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  // 查</span></span><br><span class="line"><span class="string">  get(index) &#123;</span></span><br><span class="line"><span class="string">    return this._getNode(index)</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  // 清空</span></span><br><span class="line"><span class="string">  clear()&#123;</span></span><br><span class="line"><span class="string">    this.head = null</span></span><br><span class="line"><span class="string">    this.size = 0</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">const l1 = new LinkedList()</span></span><br><span class="line"><span class="string">li.add(&#x27;</span>node1<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h3 id="单向链表队列"><a href="#单向链表队列" class="headerlink" title="单向链表队列"></a>单向链表队列</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">linkedList</span> = <span class="keyword">new</span> <span class="title class_">LinkedList</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 进队列</span></span><br><span class="line">  <span class="title function_">enqueue</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">linkedList</span>.<span class="title function_">add</span>(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 出队列</span></span><br><span class="line">  <span class="title function_">dequeue</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">linkedList</span>.<span class="title function_">remove</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> q = <span class="keyword">new</span> <span class="title class_">Queue</span>();</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/03/npm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/03/npm/" class="post-title-link" itemprop="url">npm</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-03 13:56:47" itemprop="dateCreated datePublished" datetime="2022-11-03T13:56:47+08:00">2022-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-03-19 18:57:15" itemprop="dateModified" datetime="2023-03-19T18:57:15+08:00">2023-03-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="nvm"><a href="#nvm" class="headerlink" title="nvm"></a>nvm</h1><p>切换不同 node 版本.安装之前建议删除之前的 node 版本.</p>
<h2 id="删除之前-node"><a href="#删除之前-node" class="headerlink" title="删除之前 node"></a>删除之前 node</h2><p>打开 <code>/usr/local/lib</code>，删除 node 和 node_modules 相关的文件和文件夹<br>打开<code> /usr/local/include</code>，删除 node 和 node_modules 相关的文件和文件夹<br>如果你是使用的 <code>brew install node</code> 安装的 NodeJS，那么你还需要在终端中执行 <code>brew uninstall node</code> 命令来卸载<br>检查你的个人主文件夹下面的所有的 local、lib 以及 include 文件夹，并且删除所有与 node 和 node_modules 相关的文件以及文件夹<br>打开 <code>/usr/local/bin</code> 并删除 node 可执行文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /usr/local/bin/npm</span><br><span class="line">sudo rm /usr/local/share/man/man1/node.1</span><br><span class="line">sudo rm /usr/local/lib/dtrace/node.d</span><br><span class="line">sudo rm -rf ~/.npm</span><br><span class="line">sudo rm -rf ~/.node-gyp</span><br><span class="line">sudo rm /opt/local/bin/node</span><br><span class="line">sudo rm /opt/local/include/node</span><br><span class="line">sudo rm -rf /opt/local/lib/node_modules</span><br></pre></td></tr></table></figure>

<h2 id="安装-nvm"><a href="#安装-nvm" class="headerlink" title="安装 nvm"></a>安装 nvm</h2><p>mac 安装: <code>$ brew install nvm</code><br>命令安装:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash</span><br><span class="line">或</span><br><span class="line">$ wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash</span><br></pre></td></tr></table></figure>

<p>安装的时候可以需要配置解释器,按照当时反馈的描述写就行.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建 zsh 配置文件,一遍安装了zsh就不用创建</span></span><br><span class="line">$ <span class="built_in">touch</span> ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></table></figure>

<p>比如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、这是本地不存在配置文件的时候提示需要添加的配置</span></span><br><span class="line"><span class="built_in">export</span> NVM_DIR=<span class="string">&quot;<span class="variable">$HOME</span>/.nvm&quot;</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="comment"># This loads nvm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、这是本地存在配置文件的时候提示需要添加的配置（推荐）</span></span><br><span class="line"><span class="built_in">export</span> NVM_DIR=<span class="string">&quot;<span class="variable">$HOME</span>/.nvm&quot;</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="comment"># This loads nvm</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span>  <span class="comment"># This loads nvm bash_completion</span></span><br></pre></td></tr></table></figure>

<p>之后重新加载一遍</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure>

<h2 id="安装-node"><a href="#安装-node" class="headerlink" title="安装 node"></a>安装 node</h2><p>列出所有远程版本<code>$ nvm ls-remote</code><br>显示当前版本<code>$ nvm current</code><br>列出所有已安装版本<code>$ nvm ls</code><br>切换指定版本 node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 临时版本 - 只在当前窗口生效指定版本</span><br><span class="line">$ nvm use &lt;version&gt;</span><br><span class="line"></span><br><span class="line">// 永久版本 - 所有窗口生效指定版本</span><br><span class="line">$ nvm <span class="built_in">alias</span> default &lt;version&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：在任意一个命令行窗口进行切换之后，其他的窗口或其他命令行工具窗口 需要关掉工具，重启才能生效。（例如 VSCode 内或外部命令切换之后，需要重启 VSCode，才能正常生效，否则或处于 临时生效状态，也就是在 VSCode 中重新打开一个命令行查看版本还会是旧版本，所以必须要重启。）<br>这里的 重启 不是简单的关掉窗口重启，没有退出后台进程，而是完全退出杀死工具进程，重新启动。</p>
</blockquote>
<blockquote>
<p>本来用 nvm use &lt;版本号&gt; 切换到需要的版本号上，然后用 npm install -g taro 安装是没问题的，但切换了其它命令行后，发现 taro 提示 command not found 。后来细查之后才发现，nvm use &lt;版本号&gt; 只是在当前命令行环境下切换，并不是全局切换。如果想要全局切换，要用 nvm alias default &lt;版本号&gt;</p>
</blockquote>
<h1 id="pnpm"><a href="#pnpm" class="headerlink" title="pnpm"></a>pnpm</h1><h2 id="全局安装"><a href="#全局安装" class="headerlink" title="全局安装"></a>全局安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g pnpm</span><br><span class="line">// brew</span><br><span class="line">brew install pnpm</span><br></pre></td></tr></table></figure>

<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>如果要全局安装其他,比如 typescript,还是用 npm,不然和上面 nvm 有冲突.</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>pnpm add sax</td>
<td>保存到 dependencies 配置项下</td>
</tr>
<tr>
<td>pnpm add -D sax</td>
<td>保存到 devDependencies 配置项下</td>
</tr>
<tr>
<td>pnpm add -O sax</td>
<td>保存到 optionalDependencies 配置项下</td>
</tr>
<tr>
<td>pnpm add -g sax</td>
<td>安装软件包到全局环境中</td>
</tr>
<tr>
<td>pnpm add sax@next</td>
<td>安装标记为 next 的版本</td>
</tr>
<tr>
<td>pnpm add <a href="mailto:&#115;&#97;&#120;&#x40;&#51;&#x2e;&#x30;&#x2e;&#x30;">&#115;&#97;&#120;&#x40;&#51;&#x2e;&#x30;&#x2e;&#x30;</a></td>
<td>安装指定版本 3.0.0</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zax Tseng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
