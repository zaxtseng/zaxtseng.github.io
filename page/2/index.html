<!DOCTYPE html>





<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.3.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    save_scroll: false,
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>

  <meta name="description" content="Zax&apos;s BLOG">
<meta name="keywords" content="javascript, Vue, HTML5">
<meta property="og:type" content="website">
<meta property="og:title" content="Zax&#39;s BLOG">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Zax&#39;s BLOG">
<meta property="og:description" content="Zax&apos;s BLOG">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zax&#39;s BLOG">
<meta name="twitter:description" content="Zax&apos;s BLOG">
  <link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Zax's BLOG</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zax's BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
  </ul>

    

</nav>
</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content page-home">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/16/上海公司面试题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/11/16/上海公司面试题/" class="post-title-link" itemprop="url">上海公司面试题</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-11-16 16:28:19" itemprop="dateCreated datePublished" datetime="2019-11-16T16:28:19+08:00">2019-11-16</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-24 12:02:34" itemprop="dateModified" datetime="2019-11-24T12:02:34+08:00">2019-11-24</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="云印-以-vue-为主"><a href="#云印-以-vue-为主" class="headerlink" title="云印(以 vue 为主)"></a>云印(以 vue 为主)</h1><p>1.页面初始化一般放在哪个生命周期里,为什么?<br>2.vue 组件之间如何传递参数<br>3.同步组件和异步组件之间的区别,优缺点<br>4.vue-router 实现原理<br>5.微信小程序的跳转方式有哪几种</p>
<ol start="6">
<li>ajax 的同步和异步有什么区别</li>
<li>css 那些属性是默认继承的?</li>
<li>canvas和style怎么进行绑定?</li>
<li>v-for中in和of的区别</li>
<li>watch如何使用</li>
<li>如何存储localstorage</li>
<li>router如何传值,如何取值</li>
<li>vuex如何存储值</li>
<li>分页组件的实现</li>
<li>如何监听物理返回键</li>
</ol>
<h1 id="报关-以-http-为主"><a href="#报关-以-http-为主" class="headerlink" title="报关(以 http 为主)"></a>报关(以 http 为主)</h1><ol>
<li>http 请求原理</li>
<li>http 请求的几种方式,有什么区别</li>
<li>如何进行登录验证,token 失效如何处理</li>
<li>如何调换数组中两个元素的位置.例如:[1,2,3,4,5]中调换3和4的位置,变成[1,2,4,3,5].</li>
<li>向后端发送文件的格式?</li>
</ol>
<h1 id="外包公司-1"><a href="#外包公司-1" class="headerlink" title="外包公司 1"></a>外包公司 1</h1><ol>
<li>js 中如何检测一个变量是 String 类型.请写出函数具体实现</li>
<li>写出下面函数输出什么(tips:闭包)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> count = <span class="number">10</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(count);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> s = add();</span><br><span class="line">s();</span><br><span class="line">s();</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察闭包</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>如何阻止事件冒泡和默认事件</li>
<li>下面的问题打印什么</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str = <span class="string">"我是MT"</span>;</span><br><span class="line">test();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(str);</span><br><span class="line">  <span class="keyword">var</span> str = <span class="string">"哈哈哈"</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(str);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(str);</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察变量声明和作用域</span></span><br><span class="line"><span class="literal">undefined</span> <span class="comment">//因为打印str时,首先从str所在的作用域找变量str,</span></span><br><span class="line"><span class="comment">//因为有声明前置,var str,但是未赋值,是undefined.所以不再从外部找str</span></span><br><span class="line">哈哈哈</span><br><span class="line">我是MT</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>什么是盒子模型</li>
<li>sessionStorage,localStorage 和 cookie 的区别</li>
<li>px 和 em 的区别</li>
<li>列举不同的清除浮动的技巧</li>
<li><code>display: none</code>和<code>visibility: hidden</code>的区别</li>
<li>组件中<code>&lt;style scoped&gt;</code>的<code>scoped</code>的作用.</li>
<li>v-show 和 v-if 的共同点和区别</li>
<li>vue 注册组件使用什么关键字</li>
<li>vue 如何实现父子组件通信</li>
<li>vue 的双向数据绑定原理是什么?</li>
</ol>
<h1 id="外包公司-2"><a href="#外包公司-2" class="headerlink" title="外包公司 2"></a>外包公司 2</h1><ol>
<li>使用 js 将数组: <code>[{ name: &quot;king&quot;, age: 18}, {name: &quot;bob&quot;, age: 22}]</code>变成[18,22],并且筛选出大于 20 的值.</li>
<li>使用 js 获取页面一个 id 为 myP 的<code>&lt;p&gt;</code>标签,并为其增加点击事件,并说明一下 addEventLister 方法的第三个可选参数的冒泡和捕获.</li>
<li>控制台运行一下代码:</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i);</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(i);</span><br></pre></td></tr></table></figure>

<p>输出什么</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span> <span class="comment">//先执行for循环,i=1,有异步代码,封存数据,console.log(i).</span></span><br><span class="line"><span class="comment">//i=2,console.log(i)</span></span><br><span class="line"><span class="comment">//i=3,console.log(i)</span></span><br><span class="line"><span class="comment">//此时i的最终形态是3,执行最后一行的console.log(i),是3</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>个<span class="number">3</span> <span class="comment">//同步代码执行完,看任务队列中排着3个console.log(i),i=3,连续输出3个3</span></span><br></pre></td></tr></table></figure>

<h1 id="大钱"><a href="#大钱" class="headerlink" title="大钱"></a>大钱</h1><ol>
<li>写一个原生 ajax 请求</li>
<li>写几个常用的数组,字符串,对象的方法</li>
<li><code>npm install --save</code>和<code>npm install --save --dev</code>的区别</li>
<li>IE 与火狐的事件机制有什么区别?如何阻止冒泡?</li>
<li>什么是闭包? 闭包的用途</li>
<li>css3 动画最后一帧如何恢复到原样?</li>
<li>sessionStorage,localStorage 和 cookie 的区别?分别在什么时候用?</li>
<li>HTML5 新特性?移除那些?如何处理 HTML5 新标签的浏览器兼容问题?做过的项目中,那些 CSS 样式需要单独写兼容样式?</li>
<li>ES6 运算符…是用来做什么的?用 ES6 语法遍历一个数组.</li>
<li>px,em,rem 的区别</li>
<li>prototype 是什么?什么时候用</li>
<li>js 添加,移除,替换,删除,创建,查找节点的方法是什么</li>
<li>如何优化网站性能(js)</li>
<li>编写一个方法,去掉以下数组的重复元素</li>
<li>vue 如何监听一个对象的变化,写个例子</li>
<li>setTimeout,promise,async/await 的区别</li>
<li>intercepter用在什么地方</li>
<li>路由拦截在什么地方</li>
<li>切换用户如何处理</li>
<li>用户不是提交验证进来而是输入url进来如何处理</li>
<li>组件里name的作用</li>
</ol>
<h1 id="外包公司-3"><a href="#外包公司-3" class="headerlink" title="外包公司 3"></a>外包公司 3</h1><ol>
<li>js 有哪些基本数据类型</li>
<li>var let const 的区别</li>
<li>数字计算: 在 js 中,0.1+0.2 的结果是?</li>
<li>下面代码有什么问题?(tips:闭包)</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">    &lt;li&gt;test1&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">    &lt;li&gt;test2&lt;/</span>li&gt;</span><br><span class="line">    &lt;li&gt;test3&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">&lt;/u</span>l&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"> <span class="keyword">var</span> lis = <span class="built_in">document</span>.querySelectorAll(<span class="string">'ul li'</span>);</span><br><span class="line"> <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;lis.length; i++)&#123;</span><br><span class="line">     lis[i].addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">         <span class="built_in">console</span>.log(i)</span><br><span class="line">     &#125;,<span class="literal">false</span>)</span><br><span class="line"> &#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<p>无论点击哪个都会输出3<br>解决方法:<br>1.将var换成let</p>
<ol start="2">
<li><p>for循环改造</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;lis.length; i++)&#123;</span><br><span class="line">    (<span class="function"><span class="keyword">function</span>(<span class="params">i</span>)</span>&#123;lis[i].addEventListener(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(i)</span><br><span class="line">    &#125;,<span class="literal">false</span>)&#125;)(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>请写出下面输出结果,</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;&#125;,arr = [];</span><br><span class="line">(&#123; <span class="attr">foo</span>: obj.prop, <span class="attr">bar</span>: arr[<span class="number">0</span>] &#125; = &#123; <span class="attr">foo</span>: <span class="number">123</span>, <span class="attr">bar</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"><span class="built_in">console</span>.log(obj, arr);</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  prop: <span class="number">123</span>;</span><br><span class="line">&#125;</span><br><span class="line">[<span class="literal">true</span>];</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>promise 有几种状态,什么时候会进入 catch?</li>
<li>在 8*8 的国际象棋摆放八个皇后,使其不同相互攻击,即任意两个皇后不能处在同一行,同一列,同一对角线.总共有多少种摆法.</li>
<li>git 命令有哪些?</li>
</ol>
<h1 id="外包公司-4-才匠"><a href="#外包公司-4-才匠" class="headerlink" title="外包公司 4 才匠"></a>外包公司 4 才匠</h1><ol>
<li>下面代码的输出是什么?</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> shape = &#123;</span><br><span class="line">  radius: <span class="number">10</span>,</span><br><span class="line">  diameter() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.radius * <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  perimeter: <span class="function"><span class="params">()</span> =&gt;</span> <span class="number">2</span> * <span class="built_in">Math</span>.PI * <span class="keyword">this</span>.radius</span><br><span class="line">&#125;;</span><br><span class="line">shape.diameter();</span><br><span class="line">shape.perimeter();</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span></span><br><span class="line"><span class="literal">NaN</span> <span class="comment">//考察箭头函数的this</span></span><br></pre></td></tr></table></figure>

<p>2.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> c = &#123; <span class="attr">greeting</span>: <span class="string">"hey"</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> d;</span><br><span class="line">d = c;</span><br><span class="line">c.greeting = <span class="string">"hello"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(d.greeting);</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello <span class="comment">//考察引用类型的指针,或者说堆内存</span></span><br></pre></td></tr></table></figure>

<p>3.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chameleon</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> colorChange(newColor) &#123;</span><br><span class="line">    <span class="keyword">this</span>.newColor = newColor;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">constructor</span>(&#123; newColor = <span class="string">"green"</span> &#125; = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">this</span>.newColor = newColor;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> freddie = <span class="keyword">new</span> Chameleon(&#123; <span class="attr">newColor</span>: <span class="string">"purple"</span> &#125;);</span><br><span class="line">freddie.colorChange(<span class="string">"orange"</span>);</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察class中static的方法</span></span><br><span class="line"><span class="string">"freddie.colorChange is not a function"</span></span><br><span class="line"><span class="comment">//static不能在类的实例上调用</span></span><br></pre></td></tr></table></figure>

<p>4.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">firstName, lastName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">  <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> member = <span class="keyword">new</span> Person(<span class="string">"Lydia"</span>, <span class="string">"Hallie"</span>);</span><br><span class="line">Person.getFullName = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.firstName + <span class="keyword">this</span>.lastName;</span><br><span class="line"><span class="built_in">console</span>.log(member.getFullName());</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察ES6中的class</span></span><br><span class="line"><span class="string">"member.getFullName is not a function"</span></span><br><span class="line"><span class="comment">//getFullName并没有写到Person的原型上,member并不能调用该函数</span></span><br><span class="line">解决办法:</span><br><span class="line">ES6:</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(firstName, lastName)&#123;</span><br><span class="line">    <span class="keyword">this</span>.firstName = firstName</span><br><span class="line">    <span class="keyword">this</span>.lastName = lastName</span><br><span class="line">  &#125;</span><br><span class="line">  getFullName = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.firstName + <span class="keyword">this</span>.lastName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> member = <span class="keyword">new</span> Person(<span class="string">"Lydia"</span>,<span class="string">"Hallie"</span>)</span><br><span class="line"><span class="built_in">console</span>.log(member.getFullName())</span><br><span class="line">ES5原型法:</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">firstName, lastName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">  <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">&#125;</span><br><span class="line">Person.prototype.getFullName = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="keyword">this</span>.lastName;</span><br><span class="line">  &#125; <span class="comment">//这里不能用箭头函数,否则this指向window</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> member = <span class="keyword">new</span> Person(<span class="string">"Lydia"</span>, <span class="string">"Hallie"</span>);</span><br><span class="line"><span class="built_in">console</span>.log(member.getFullName());</span><br></pre></td></tr></table></figure>

<p>5.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkAge</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (data === &#123; <span class="attr">age</span>: <span class="number">18</span> &#125;) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"you are an adult!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"hh"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">checkAge(&#123; <span class="attr">age</span>: <span class="number">18</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//考察引用类型</span></span><br><span class="line">hh <span class="comment">//考点在&#123;age: 18&#125; === &#123;age: 18&#125;是否相等,</span></span><br><span class="line"><span class="comment">//两个不同的地址,所以不相等</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/16/头条面试题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/11/16/头条面试题/" class="post-title-link" itemprop="url">头条面试题</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-11-16 16:26:56 / 修改时间：16:32:40" itemprop="dateCreated datePublished" datetime="2019-11-16T16:26:56+08:00">2019-11-16</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="第一套"><a href="#第一套" class="headerlink" title="第一套"></a>第一套</h1><ol>
<li>替换元素与非替换元素,差异?</li>
<li>offsetWidth,clientWidth,scrollwidth区别</li>
<li>Dom标准事件模型是什么?是否所有的事件都支持冒泡?如果不是,举例说明.</li>
<li>css选择器的优先级</li>
<li>简述什么是IFC,作用</li>
<li>用CSS实现自适应正方形</li>
<li><code>Http://toutiao.com</code>往<code>http://mp.toutiao.com</code>发<code>ajax</code>请求,跨域了吗?<code>mp.toutiao.com</code>的服务器可以收到请求吗,是怎样的请求?</li>
<li>XSS和CRSF分别是什么?有什么联系?如何防御?</li>
<li>关于js Bridge<ol>
<li>是什么?</li>
<li>实现原理</li>
<li>优化方案</li>
</ol>
</li>
<li>TCP/UDP是什么?有什么区别?如何进行拥塞控制?</li>
<li>请用算法实现.从给定的无序,不重复的数组A中,取出N个数,使其相加和为M.并给出算法的时间空间复杂度.<h1 id="第二套"><a href="#第二套" class="headerlink" title="第二套"></a>第二套</h1></li>
<li>ES5和ES6的继承有什么区别?</li>
<li>Web动画的几种常见方式</li>
<li>POST提交数据的几种常见content-type</li>
<li>如何定义一个方法,通过调用把视频的一帧生产预览图</li>
<li>什么是重放攻击,列举几个防御手段.</li>
</ol>
<h2 id="编程题"><a href="#编程题" class="headerlink" title="编程题"></a>编程题</h2><ol>
<li><p>实现一个函数sum,运算结果满足如下预期结果:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>	sum(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>).valueof(); <span class="comment">//6</span></span><br><span class="line"><span class="number">2.</span>	sum(<span class="number">2</span>,<span class="number">3</span>)(<span class="number">2</span>).valueof(); <span class="comment">//7</span></span><br><span class="line"><span class="number">3.</span>	sum(<span class="number">1</span>)(<span class="number">2</span>)(<span class="number">3</span>)(<span class="number">4</span>).valueof(); <span class="comment">//10</span></span><br><span class="line"><span class="number">4.</span>	sum(<span class="number">2</span>)(<span class="number">4</span>,<span class="number">1</span>)(<span class="number">2</span>).valueof(); <span class="comment">//9</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>实现一个优先队列,使得可以这样使用.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>	Const priorityQuene = <span class="keyword">new</span> PriorityQuene()</span><br><span class="line"><span class="number">2.</span>	priorityQuene.enquene(‘优先级<span class="number">2</span><span class="number">-1</span>’,<span class="number">2</span>)’</span><br><span class="line"><span class="number">3.</span>	priorityQuene.enquene(‘优先级<span class="number">1</span><span class="number">-1</span>’,<span class="number">1</span>)’</span><br><span class="line"><span class="number">4.</span>	priorityQuene.enquene(‘优先级<span class="number">1</span><span class="number">-2</span>’,<span class="number">1</span>)’</span><br><span class="line"><span class="number">5.</span>	priorityQuene.enquene(‘优先级<span class="number">3</span><span class="number">-1</span>’,<span class="number">3</span>)’</span><br><span class="line"><span class="number">6.</span>	priorityQuene.enquene(‘优先级<span class="number">2</span><span class="number">-2</span>’,<span class="number">2</span>)’</span><br><span class="line"><span class="number">7.</span>	priorityQuene.enquene(‘优先级<span class="number">1</span><span class="number">-3</span>’,<span class="number">1</span>)’</span><br><span class="line"><span class="number">8.</span>	priorityQuene..print(); <span class="comment">//按优先级顺序输出</span></span><br><span class="line"><span class="number">9.</span>	priorityQuene.dequene(); <span class="comment">//出队</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>硬币找零问题:<br>有面额为d1…dn的硬币,和要找零的钱数,找出所需最小硬币个数的方案,<br>例如,美国有以下面额的硬币: d1=1,d2=5,d3=10,d4=25.如果要找36美分.,所需最少硬币是[1,10,25],即满足如下输出:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> miniCoinChange = <span class="keyword">new</span> MinCoinChange(<span class="number">1</span>,<span class="number">5</span>,<span class="number">10</span>,<span class="number">25</span>));</span><br><span class="line"><span class="built_in">console</span>.log(minCoinChange.makeChange(<span class="number">36</span>)) <span class="comment">//[1,10,25]</span></span><br><span class="line"><span class="keyword">const</span> minCoinChange2 = <span class="keyword">new</span> MinCoinChange([<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"><span class="built_in">console</span>.log(minCoinChange2.makeChange(<span class="number">6</span>); <span class="comment">//[3,3]</span></span><br></pre></td></tr></table></figure>

</li>
</ol>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/27/photoshop切图/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/27/photoshop切图/" class="post-title-link" itemprop="url">photoshop切图</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-27 16:08:59" itemprop="dateCreated datePublished" datetime="2019-10-27T16:08:59+08:00">2019-10-27</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-03 18:01:49" itemprop="dateModified" datetime="2019-11-03T18:01:49+08:00">2019-11-03</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="新建图层"><a href="#新建图层" class="headerlink" title="新建图层"></a>新建图层</h1><p>建议背景图层透明.<br>移动工具: 快捷键<code>V</code><br>按住<code>Ctrl</code>,自动选择图层.<br>放大缩小: <code>Alt+滚轮</code></p>
<h1 id="界面设置"><a href="#界面设置" class="headerlink" title="界面设置"></a>界面设置</h1><p>视图设置:</p>
<ol>
<li>智能参考线</li>
<li>标尺(<code>ctrl+R</code>)</li>
</ol>
<p>##窗口设置</p>
<ol>
<li>信息</li>
<li>字符</li>
<li>历史记录</li>
</ol>
<p>修改信息-面板选项<br>        |-鼠标坐标单位-像素<br>        |-第一颜色信息-RGB颜色<br>        |-第二颜色信息-RGB颜色<br>        |-状态信息-文档尺寸</p>
<h2 id="编辑设置"><a href="#编辑设置" class="headerlink" title="编辑设置"></a>编辑设置</h2><p>首选项-单位与标尺-标尺,文字改为像素</p>
<h2 id="格局"><a href="#格局" class="headerlink" title="格局"></a>格局</h2><ol>
<li>图层和历史记录</li>
<li>信息和字符</li>
</ol>
<h2 id="保存为web切图"><a href="#保存为web切图" class="headerlink" title="保存为web切图"></a>保存为web切图</h2><p>窗口-工作区-新建工作区-web切图</p>
<h1 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h1><h2 id="套索工具L"><a href="#套索工具L" class="headerlink" title="套索工具L"></a>套索工具<code>L</code></h2><p>放大<code>Ctrl+ +</code><br>缩小<code>Ctrl+ -</code><br>按住空格键拖动<br>按住<code>shift</code>键: 增加选区<br>按住<code>alt</code>键: 删除选区</p>
<h3 id="磁性套索工具L"><a href="#磁性套索工具L" class="headerlink" title="磁性套索工具L"></a>磁性套索工具<code>L</code></h3><p>可以吸附到同颜色区域边界.<br>多余地方可以按住<code>shfit</code>或者<code>alt</code>进行增删</p>
<h2 id="快速选择工具W"><a href="#快速选择工具W" class="headerlink" title="快速选择工具W"></a>快速选择工具<code>W</code></h2><p>可以快速选择相同颜色区块<br>画笔大小快捷键:<code>[]</code></p>
<h2 id="魔棒工具W"><a href="#魔棒工具W" class="headerlink" title="魔棒工具W"></a>魔棒工具<code>W</code></h2><p>类似于快速选择工具</p>
<h2 id="裁剪工具C"><a href="#裁剪工具C" class="headerlink" title="裁剪工具C"></a>裁剪工具<code>C</code></h2><p>使用魔棒工具或快速选择工具选取一块区域,直接按裁剪工具,然后回车,可快速裁剪出所选区域.<br>此时,按住Alt,点击当前图层的眼睛图标,可隐藏其他图层,只保留当前图层.即显影模式.<br>裁剪工具时,按住<code>Alt</code>,点击所选图案,可以让图案成为中心.</p>
<h2 id="吸管工具I"><a href="#吸管工具I" class="headerlink" title="吸管工具I"></a>吸管工具I</h2><p>选取当前颜色,<br>前景色填充<code>Alt+Delete</code><br>背景色填充<code>Ctrl+Delete</code></p>
<h1 id="污点修复画笔工具J"><a href="#污点修复画笔工具J" class="headerlink" title="污点修复画笔工具J"></a>污点修复画笔工具J</h1><p>选取周围的颜色覆盖选取区域的颜色.比如照片中黑点会被抹除.</p>
<h2 id="修复画笔工具"><a href="#修复画笔工具" class="headerlink" title="修复画笔工具"></a>修复画笔工具</h2><p>按住<code>Alt</code>键单击左键选取要复制的区域,在其他区域就可以复制过去.</p>
<h2 id="修补工具"><a href="#修补工具" class="headerlink" title="修补工具"></a>修补工具</h2><p>画出一个选取,将选取拖动到想要使用修补的地方进行替换修补.</p>
<h1 id="仿制图章工具"><a href="#仿制图章工具" class="headerlink" title="仿制图章工具"></a>仿制图章工具</h1><p>类似于修复画笔工具,双击选取要复制的点,在其他地方可以复制出来.与 修复画笔工具区别是,修复画笔工具复制出来的有羽化效果.</p>
<h2 id="图案图章工具"><a href="#图案图章工具" class="headerlink" title="图案图章工具"></a>图案图章工具</h2><p>有可选择的备用图案,作用类似于打马赛克.</p>
<h1 id="历史记录画笔工具Y"><a href="#历史记录画笔工具Y" class="headerlink" title="历史记录画笔工具Y"></a>历史记录画笔工具Y</h1><p>作用类似于祛斑.先用高斯模糊将照片模糊到没有斑点.再将画笔圆记录到历史记录的高斯模糊这一步,再回到原图,使用该画笔圆进行处理.</p>
<h1 id="渐变"><a href="#渐变" class="headerlink" title="渐变"></a>渐变</h1><p>渐变颜色方向是顺时针</p>
<h1 id="文字"><a href="#文字" class="headerlink" title="文字"></a>文字</h1><p>双击空白区域,即可写字.按住Ctrl可以拖动区域大小,Alt也可以拖动.</p>
<h1 id="抓手工具H"><a href="#抓手工具H" class="headerlink" title="抓手工具H"></a>抓手工具H</h1><p>按住<code>Alt</code>缩小,按住<code>shift</code>放大.</p>
<h1 id="图层"><a href="#图层" class="headerlink" title="图层"></a>图层</h1><h2 id="奥运五环"><a href="#奥运五环" class="headerlink" title="奥运五环"></a>奥运五环</h2><ol>
<li>新建文件,背景色为白色.</li>
<li>右下角新建图层.</li>
<li>使用椭圆选区工具<code>M</code>,按住<code>shift</code>(有的是<code>alt</code>),拉出一个标准圆.</li>
<li>使用吸管工具<code>I</code>,点击拾色器,选择颜色,确定.使用快捷键<code>Alt+Delete</code>填充圆形选区的颜色.</li>
<li>使用选区工具<code>M</code>,右键变化选区,按住<code>Alt</code>进行同心圆的缩小.右上角对号确定.按下<code>delete</code>删除内圆,得到圆环.</li>
<li><code>Ctrl+ T</code>自由变换,进行调整.</li>
<li>使用移动工具<code>V</code>,按住<code>Alt</code>进行拖动,即复制一张图层.</li>
<li>在右下角图层菜单中,双击图层名,进行重命名.</li>
<li>选取复制图层,按住<code>Ctrl</code>单击图层菜单中缩略图.选择颜色,<code>Alt+Delete</code>填充颜色.</li>
<li>按<code>M</code>使用选区后,单击空白就结束选区了.</li>
<li>删除覆盖在黄色上的蓝色,按住<code>Ctrl</code>,单击蓝色图层的缩略图,选中蓝色选区,</li>
<li>使用选区工具<code>M</code>,点击黄色图层,按住<code>Alt</code>选取要排除的区块(因为此时要删掉黄色图层上的两小块区域,而选区是蓝色选区,排除掉保留的蓝色,剩下的就是要真正删除的蓝色小块了),按<code>Delete</code>删除,就出现交叉效果了.</li>
</ol>
<h1 id="参考线"><a href="#参考线" class="headerlink" title="参考线"></a>参考线</h1><ol>
<li>视图-新建参考线(按住<code>Alt</code>,依次按<code>V+E</code>)</li>
<li><code>Ctrl+R</code>调出标尺,切换到移动工具<code>V</code>,然后从标尺处拖出参考线.</li>
</ol>
<p>参考线切换: 拉动参考线,按住<code>Alt</code>.</p>
<h2 id="参考线初始化"><a href="#参考线初始化" class="headerlink" title="参考线初始化"></a>参考线初始化</h2><p>通用页面像素一般是1920*1080,页面内容一般占1200,两侧留白共720px<br>起始左侧线可设置为360px,右侧线设置为1560px.</p>
<h2 id="隐藏参考线"><a href="#隐藏参考线" class="headerlink" title="隐藏参考线"></a>隐藏参考线</h2><p>快捷键: <code>Ctrl+ ;</code></p>
<h1 id="切图"><a href="#切图" class="headerlink" title="切图"></a>切图</h1><h2 id="传统切图"><a href="#传统切图" class="headerlink" title="传统切图"></a>传统切图</h2><p>裁剪工具<code>C</code>-切片工具</p>
<h2 id="参考线辅助切图"><a href="#参考线辅助切图" class="headerlink" title="参考线辅助切图"></a>参考线辅助切图</h2><p>先设置参考线,再点击切片工具<code>C</code>,上面菜单基于参考线切片.<br>通过删除多余切片将零碎切片合并为一个切片.<br>文件-存储为web所用格式,一般格式为PNG-24.</p>
<blockquote>
<p>建议将大图裁剪成多份,然后使用参考线切片.</p>
</blockquote>
<h2 id="精准切图"><a href="#精准切图" class="headerlink" title="精准切图"></a>精准切图</h2><p>文件-脚本-将图层导出到文件-文件类型-PNG24-全部打√<br>文件-导出-将图层导出导出到文件-文件类型-PNG24-全部打√<br>(因为软件版本不同,可能命令不在上述中,上述是同一命令的两个位置)<br>选择导出目录,运行</p>
<h1 id="扩展知识"><a href="#扩展知识" class="headerlink" title="扩展知识"></a>扩展知识</h1><p>将整个图层切成一个图<br>编辑-首选项-增效工具-启动生成器打√<br>文件-生成-图像资源</p>
<h1 id="抠图"><a href="#抠图" class="headerlink" title="抠图"></a>抠图</h1><p>先打开图片,<br>图层-新建图层-新建图层背景<br>图像-画布大小<br><code>Ctrl+T</code>选中图片,<code>Alt</code>进行比例放大<br><code>Ctrl+ X</code>可以把选取内不需要的内容删掉<br>导出-快速导出PNG即可.</p>
<h1 id="描白边"><a href="#描白边" class="headerlink" title="描白边"></a>描白边</h1><p>使用魔棒选取大部分边缘,使用选区工具进行修补.<br>编辑-描边-白色-5px左右,外部<br>使用魔棒点击外部区域,选择反向,就选中了包含白边的区域.<br>此时可以使用编辑-填充-黑色,就出现纯黑背景的白边图片了.</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/25/滚动阅读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/25/滚动阅读/" class="post-title-link" itemprop="url">滚动阅读</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-25 20:04:22" itemprop="dateCreated datePublished" datetime="2019-10-25T20:04:22+08:00">2019-10-25</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-30 11:30:56" itemprop="dateModified" datetime="2019-10-30T11:30:56+08:00">2019-10-30</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="初步构思"><a href="#初步构思" class="headerlink" title="初步构思"></a>初步构思</h1><ol>
<li>定时任务启动</li>
<li>滑到面板桌面(从常规桌面上滑)</li>
<li>点击礼盒图标(右上角,测量位置)</li>
<li>点击完成相关任务(位置)</li>
<li>自动唤醒京东读书app</li>
<li>点击图书(位置)</li>
<li>自动翻页(swipe)</li>
<li>完成后返回打卡页面</li>
<li>点击完成打卡(位置)</li>
</ol>
<p>新增: </p>
<ol>
<li>时间统计(共阅读了多久)</li>
<li>页数统计(共阅读了多少页)</li>
</ol>
<h1 id="防检测"><a href="#防检测" class="headerlink" title="防检测"></a>防检测</h1><p>自动翻页位置</p>
<ol>
<li>滑动翻页(swipe) Math.random</li>
<li>点击翻页(touch),时间和位置都随机</li>
<li>映射音量键翻页</li>
</ol>
<p>该机分辨率为1440*720<br>下一页触摸区域在x(480-720),y(0-1440)</p>
<p>规则:<br>30分钟阅读300页,则每分钟阅读10页,至少6秒阅读完一页.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">6000</span> * (<span class="built_in">Math</span>.random() + <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>每页最少6秒,最多12秒不到.<br>每300页最少30分钟.最多60分钟不到.</p>
<h1 id="随机时间"><a href="#随机时间" class="headerlink" title="随机时间"></a>随机时间</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> initTime = <span class="number">6000</span> * (<span class="built_in">Math</span>.random() + <span class="number">0.33333</span>)</span><br><span class="line"><span class="keyword">if</span>(initTime &lt; <span class="number">6000</span>)&#123;</span><br><span class="line">    initTime += <span class="number">4000</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iTime</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> initTime = <span class="number">6000</span> * ( <span class="built_in">Math</span>.random()+ <span class="number">0.33333</span>)</span><br><span class="line"><span class="keyword">if</span>(initTime &lt; <span class="number">6000</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> initTime += <span class="number">4000</span></span><br><span class="line">&#125;</span><br><span class="line">  <span class="keyword">return</span> initTime</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">iTime()</span><br></pre></td></tr></table></figure>

<p>每页最少2秒,最多8秒不到.<br>每300页最少不到16分钟.最多40分钟不到.</p>
<h1 id="定时运行脚本"><a href="#定时运行脚本" class="headerlink" title="定时运行脚本"></a>定时运行脚本</h1><p>点击脚本右边的菜单按钮-&gt;更多-&gt;定时任务设置定时运行脚本.注意<strong>必须保持Auto.js后台运行(自启动白名单、电源管理白名单等),不可加锁屏密码</strong>.</p>
<p>脚本的开头使用device.wakeUp()来唤醒屏幕</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//# 启动app</span></span><br><span class="line">app.launchApp(<span class="string">"京东读书"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//暂停运行5秒</span></span><br><span class="line">sleep(<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<h1 id="气泡信息toast-message"><a href="#气泡信息toast-message" class="headerlink" title="气泡信息toast(message)"></a>气泡信息<code>toast(message)</code></h1><p>注意，信息的显示是”异步”执行的，并且，不会等待信息消失程序才继续执行。如果在循环中执行该命令，可能出现脚本停止运行后仍然有不断的气泡信息出现的情况</p>
<p>官方貌似说了会实时显示进度,那么下面的统计就不需要了.<br>这里可以显示已经看了几页(估计得写个函数),看具体是怎么翻页了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果触发一次,就次数<span class="string">`total += 1`</span></span><br><span class="line"><span class="keyword">if</span>(total == <span class="number">300</span>)&#123;</span><br><span class="line">    <span class="comment">//toast('看完300页了,准备打卡去')</span></span><br><span class="line">    <span class="comment">//建议此时不停,不知道时间够不够,继续刷一会</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(total &gt;=<span class="number">300</span> &amp;&amp; totalTime &gt;= <span class="number">30</span>*<span class="number">6000</span>)&#123;</span><br><span class="line">    <span class="comment">//条件满足,停止刷页</span></span><br><span class="line">    stop()</span><br><span class="line">    <span class="comment">//跳转打卡页面</span></span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//继续刷页</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="立即停止exit"><a href="#立即停止exit" class="headerlink" title="立即停止exit()"></a>立即停止<code>exit()</code></h1><h1 id="console-show"><a href="#console-show" class="headerlink" title="console.show()"></a><code>console.show()</code></h1><p>显示控制台。这会显示一个控制台的悬浮窗(需要悬浮窗权限)。</p>
<h2 id="print-text"><a href="#print-text" class="headerlink" title="print(text)"></a><code>print(text)</code></h2><p><code>text {string} | {Object}</code>要打印到控制台的信息,相当于log(text)。</p>
<h1 id="基于坐标的触摸模拟"><a href="#基于坐标的触摸模拟" class="headerlink" title="基于坐标的触摸模拟"></a>基于坐标的触摸模拟</h1><p>要获取要点击的位置的坐标，可以在开发者选项中开启”指针位置”。</p>
<h2 id="setScreenMetrics-width-height"><a href="#setScreenMetrics-width-height" class="headerlink" title="setScreenMetrics(width, height)"></a>setScreenMetrics(width, height)</h2><p>设置脚本坐标点击所适合的屏幕宽高.<br>如果脚本运行时，屏幕宽度不一致会自动放缩坐标.</p>
<h1 id="安卓7-0以上的触摸和手势模拟"><a href="#安卓7-0以上的触摸和手势模拟" class="headerlink" title="安卓7.0以上的触摸和手势模拟"></a>安卓7.0以上的触摸和手势模拟</h1><h2 id="click-x-y"><a href="#click-x-y" class="headerlink" title="click(x, y)"></a>click(x, y)</h2><p>模拟点击坐标(x, y)，并返回是否点击成功。只有在点击执行完成后脚本才继续执行。<br>使用该函数模拟连续点击时可能有点击速度过慢的问题，这时可以用<code>press()</code>函数代替。</p>
<h2 id="press-x-y-duration"><a href="#press-x-y-duration" class="headerlink" title="press(x, y, duration)"></a>press(x, y, duration)</h2><p><code>duration: {number}</code> 按住时长，单位毫秒<br>模拟按住坐标(x, y), 并返回是否成功。只有按住操作执行完成时脚本才会继续执行。<br>如果按住时间过短，那么会被系统认为是点击；如果时长超过500毫秒，则认为是长按。</p>
<h2 id="swipe-x1-y1-x2-y2-duration"><a href="#swipe-x1-y1-x2-y2-duration" class="headerlink" title="swipe(x1, y1, x2, y2, duration)"></a>swipe(x1, y1, x2, y2, duration)</h2><p><code>x1</code> {number} 滑动的起始坐标的x值<br><code>y1</code> {number} 滑动的起始坐标的y值<br><code>x2</code> {number} 滑动的结束坐标的x值<br><code>y2</code> {number} 滑动的结束坐标的y值<br><code>duration</code> {number} 滑动时长，单位毫秒<br>模拟从坐标(x1, y1)滑动到坐标(x2, y2)，并返回是否成功。只有滑动操作执行完成时脚本才会继续执行。</p>
<h1 id="随机数random"><a href="#随机数random" class="headerlink" title="随机数random"></a>随机数random</h1><h1 id="random-min-max"><a href="#random-min-max" class="headerlink" title="random(min, max)"></a>random(min, max)</h1><p><code>min</code> {number} 随机数产生的区间下界<br><code>max</code> {number} 随机数产生的区间上界<br>返回 {number}<br>返回一个在<code>[min...max]</code>之间的随机数(正整数)。例如<code>random(0, 2)</code>可能产生0, 1, 2。</p>
<h2 id="random"><a href="#random" class="headerlink" title="random()"></a>random()</h2><p>返回 {number}<br>返回在[0, 1)的随机浮点数。</p>
<h1 id="device-wakeUp"><a href="#device-wakeUp" class="headerlink" title="device.wakeUp()"></a>device.wakeUp()</h1><p>唤醒设备。包括唤醒设备CPU、屏幕等。可以用来点亮屏幕。</p>
<h2 id="device-wakeUpIfNeeded"><a href="#device-wakeUpIfNeeded" class="headerlink" title="device.wakeUpIfNeeded()"></a>device.wakeUpIfNeeded()</h2><p>如果屏幕没有点亮，则唤醒设备。</p>
<h1 id="按键模拟"><a href="#按键模拟" class="headerlink" title="按键模拟"></a>按键模拟</h1><p>实体按键模拟依赖root权限,故放弃.</p>
<h1 id="基于控件的操作"><a href="#基于控件的操作" class="headerlink" title="基于控件的操作"></a>基于控件的操作</h1><p>推荐使用<code>auto()</code>函数来确保无障碍服务已启用.</p>
<h1 id="auto-mode"><a href="#auto-mode" class="headerlink" title="auto([mode])"></a>auto([mode])</h1><p>检查无障碍服务是否已经启用，如果没有启用则抛出异常并跳转到无障碍服务启用界面；同时设置无障碍模式为mode。<br>如果不加mode参数，则为正常模式。<br>建议使用<code>auto.waitFor()</code>和<code>auto.setMode()</code>代替该函数，因为<code>auto()</code>函数如果无障碍服务未启动会停止脚本；而<code>auto.waitFor()</code>则会在在无障碍服务启动后继续运行。</p>
<h2 id="auto-waitFor"><a href="#auto-waitFor" class="headerlink" title="auto.waitFor()"></a>auto.waitFor()</h2><p>检查无障碍服务是否已经启用，如果没有启用则跳转到无障碍服务启用界面，并等待无障碍服务启动；当无障碍服务启动后脚本会继续运行。</p>
<h1 id="点击文本click-text-i"><a href="#点击文本click-text-i" class="headerlink" title="点击文本click(text[, i])"></a>点击文本<code>click(text[, i])</code></h1><p><code>text</code> {string} 要点击的文本<br><code>i</code> {number} 如果相同的文本在屏幕中出现多次，则i表示要点击第几个文本, i从0开始计算<br>该函数可以点击大部分包含文字的按钮。例如微信主界面下方的”微信”, “联系人”, “发现”, “我”的按钮。<br>通常与while同时使用以便点击按钮直至成功。例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(!click(<span class="string">"扫一扫"</span>));</span><br></pre></td></tr></table></figure>

<h1 id="UiSelector-exists"><a href="#UiSelector-exists" class="headerlink" title="UiSelector.exists()"></a>UiSelector.exists()</h1><p>返回 {Boolean}<br>判断屏幕上是否存在控件符合选择器所确定的条件。<br>例如要判断某个文本出现就执行某个动作，可以用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(text(<span class="string">"某个文本"</span>).exists())&#123;</span><br><span class="line">    <span class="comment">//要支持的动作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="暂停sleep"><a href="#暂停sleep" class="headerlink" title="暂停sleep()"></a>暂停sleep()</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//暂停1秒</span></span><br><span class="line">sleep(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<h1 id="选取控件"><a href="#选取控件" class="headerlink" title="选取控件"></a>选取控件</h1><p>一般软件的界面是由一个个控件构成的，例如图片部分是一个图片控件(ImageView)，文字部分是一个文字控件(TextView)；同时，通过各种布局来决定各个控件的位置，例如，线性布局(LinearLayout)里面的控件都是按水平或垂直一次叠放的，列表布局(AbsListView)则是以列表的形式显示控件。<br>控件有各种属性，包括文本(text), 描述(desc), 类名(className), id等等。我们通常用一个控件的属性来找到这个控件，例如，想要点击QQ聊天窗口的”发送”按钮，我们就可以通过他的文本属性为”发送”来找到这个控件并点击他，具体代码为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sendButton = text(<span class="string">"发送"</span>).findOne();</span><br><span class="line">sendButton.click();</span><br></pre></td></tr></table></figure>

<p>在这个例子中, text(“发送”)表示一个条件(文本属性为”发送”)，findOne()表示基于这个条件找到一个符合条件的控件，从而我们可以得到发送按钮sendButton，再执行sendButton.click()即可点击”发送”按钮。</p>
<p>果一个控件是图片控件.我们注意到这个图标的desc(描述)属性为”搜索”，那么我们就可以通过desc属性来定位这个控件，得到点击搜索图标的代码为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc(<span class="string">"搜索"</span>).findOne().click();</span><br></pre></td></tr></table></figure>

<p>另外，对于这个搜索图标而言，id属性也是唯一的，我们也可以用id(“action_search”).findOne().click()来点击这个控件。如果一个控件有id属性，那么这个属性很可能是唯一的.</p>
<p>i_reader_folder</p>
<h1 id="定时器Timers"><a href="#定时器Timers" class="headerlink" title="定时器Timers"></a>定时器Timers</h1><h2 id="setTimeout"><a href="#setTimeout" class="headerlink" title="setTimeout()"></a>setTimeout()</h2><p>与web端用法一致.但是使用了一个不同的内部实现，它是基于 Android Looper-Handler消息循环机制构建的。其实现机制与Node.js比较相似.</p>
<h2 id="setInterval-callback-delay-…args"><a href="#setInterval-callback-delay-…args" class="headerlink" title="setInterval(callback, delay[,…args])"></a>setInterval(callback, delay[,…args])</h2><p>callback {Function} 当定时器到点时要调用的函数。<br>delay {number} 调用 callback 之前要等待的毫秒数。<br>…args {any} 当调用 callback 时要传入的可选参数。</p>
<p>因为定时器是异步执行,另外delay只能是number,那么不采用这种方案.</p>
<h1 id="刷页函数"><a href="#刷页函数" class="headerlink" title="刷页函数"></a>刷页函数</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">turnPage</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>先打开京东读书,登录账号<br>点击书城-免费-点击一本书-加入书架-(多加几本)</p>
<h1 id="方案一-点击翻页"><a href="#方案一-点击翻页" class="headerlink" title="方案一: 点击翻页"></a>方案一: 点击翻页</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检查无障碍服务开启情况</span></span><br><span class="line">auto.waitFor()</span><br><span class="line"><span class="comment">//显示控制台</span></span><br><span class="line"><span class="built_in">console</span>.show()</span><br><span class="line"><span class="comment">//设置脚本适合的宽高</span></span><br><span class="line">setScreenMetrics(<span class="number">720</span>, <span class="number">1440</span>)</span><br><span class="line"><span class="comment">//打开京东读书app</span></span><br><span class="line">app.launchApp(<span class="string">"京东读书"</span>)</span><br><span class="line">toast(<span class="string">"开始打卡"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待启动</span></span><br><span class="line">sleep(<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//跳过</span></span><br><span class="line"><span class="keyword">if</span>(text(<span class="string">"跳过"</span>).exists())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    text(<span class="string">"跳过"</span>).findOne().click()</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测升级</span></span><br><span class="line"><span class="keyword">if</span>(text(<span class="string">"下次再说"</span>).exists())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    text(<span class="string">"下次再说"</span>).findOne().click()</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//点击控件,跳转书架</span></span><br><span class="line">id(<span class="string">"main_tab_bookshelf"</span>).findOne().click()</span><br><span class="line">sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//准备开始图书</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//随机时间</span></span><br><span class="line"><span class="keyword">var</span> initTime = <span class="number">6000</span> * (<span class="built_in">Math</span>.random() + <span class="number">0.33333</span>)</span><br><span class="line"><span class="keyword">if</span>(initTime &lt; <span class="number">6000</span>)&#123;</span><br><span class="line">    initTime += <span class="number">4000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="这里有问题"><a href="#这里有问题" class="headerlink" title="这里有问题"></a>这里有问题</h1><p>应该阅读到末尾结束,出现关闭阅读.点击关闭阅读.删除第一本.重新打开一本,开始阅读.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//已读完时,左上角出现关闭阅读</span></span><br><span class="line"><span class="keyword">if</span>(text(<span class="string">"关闭阅读"</span>).exists())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    text(<span class="string">"关闭阅读"</span>).findOne().click()</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    <span class="comment">//长按第一本书,左下角删除,弹出确认删除,点击第二个删除.sleep(2000),右上角完成,继续阅读()</span></span><br><span class="line">    <span class="keyword">let</span> index</span><br><span class="line">    deleteBook()</span><br><span class="line">    <span class="comment">//继续阅读</span></span><br><span class="line">    <span class="comment">//删掉之后,加上已阅读200页,重新开始,又会阅读300页.</span></span><br><span class="line">    <span class="keyword">this</span>.index = index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    readBook()</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//执行自动阅读</span></span><br><span class="line">    readBook()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开始阅读-阅读完-跳出阅读-删除-重新开始阅读</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行阅读主步骤</span></span><br><span class="line">mianStep()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mianStep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    readeBook()</span><br><span class="line">    <span class="keyword">if</span>(text(<span class="string">"关闭阅读"</span>).exists())&#123;</span><br><span class="line">    <span class="comment">//点击控件</span></span><br><span class="line">    text(<span class="string">"关闭阅读"</span>).findOne().click()</span><br><span class="line">    sleep(<span class="number">2000</span>)</span><br><span class="line">    <span class="comment">//长按第一本书,左下角删除,弹出确认删除,点击第二个删除.sleep(2000),右上角完成,继续阅读()</span></span><br><span class="line">    <span class="keyword">let</span> index</span><br><span class="line">    deleteBook()</span><br><span class="line">    <span class="comment">//继续阅读</span></span><br><span class="line">    <span class="comment">//删掉之后,加上已阅读200页,重新开始,又会阅读300页.</span></span><br><span class="line">    <span class="keyword">this</span>.index = i</span><br><span class="line">    mianStep()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动阅读</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readBook</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    toast(<span class="string">"开始阅读"</span>)</span><br><span class="line">    <span class="comment">//选择第一本</span></span><br><span class="line">    id(<span class="string">"i_reader_folder"</span>).indexInParent(<span class="number">0</span>).findOne().click()</span><br><span class="line">    sleep(<span class="number">3000</span>)</span><br><span class="line">    <span class="comment">//执行点击</span></span><br><span class="line">    clickPage()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//点击阅读</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clickPages</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//点击300页</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> &#123;i=<span class="number">0</span>&#125;=index; i&lt;<span class="number">300</span>; i++)&#123;</span><br><span class="line">    randomClick()</span><br><span class="line">    <span class="comment">//间隔时间</span></span><br><span class="line">    sleep(initTime)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器版</span></span><br><span class="line"><span class="comment">// for(var i=0; i&lt;5; i++)&#123;</span></span><br><span class="line"><span class="comment">//     setTimeout(randomClick(),initTime)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//随机点坐标</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randomClick</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">//随机坐标,各缩减20px,防止误触</span></span><br><span class="line">x = random(<span class="number">500</span>, <span class="number">700</span>)</span><br><span class="line">y = random(<span class="number">20</span>, <span class="number">1420</span>)</span><br><span class="line"><span class="comment">//点击随机坐标区域翻页</span></span><br><span class="line">click(x, y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//删除已读数目</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteBook</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//长按图书,坐标就是第一本书的位置</span></span><br><span class="line">    <span class="comment">//press(x, y, 1500)</span></span><br><span class="line">    id(<span class="string">"i_reader_folder"</span>).indexInParent(<span class="number">0</span>).findOne().longClick()</span><br><span class="line">    <span class="comment">//删除图书</span></span><br><span class="line">    text(<span class="string">"删除"</span>).findOne().click()</span><br><span class="line">    <span class="comment">//要确认删除了</span></span><br><span class="line">    id(<span class="string">"confirm"</span>).findOne().click()</span><br><span class="line">    <span class="comment">//右上角完成</span></span><br><span class="line">    text(<span class="string">"完成"</span>).findOne().click()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//点击打卡文本</span></span><br><span class="line">click(text[<span class="string">"立即打卡"</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印结束</span></span><br><span class="line">toast(<span class="string">"打卡结束"</span>)</span><br></pre></td></tr></table></figure>

<h1 id="方案二-滑动翻页"><a href="#方案二-滑动翻页" class="headerlink" title="方案二: 滑动翻页"></a>方案二: 滑动翻页</h1><pre><code class="js"></code></pre>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/17/vue-hackernews-2-0-源码解读-适合入门-二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/17/vue-hackernews-2-0-源码解读-适合入门-二/" class="post-title-link" itemprop="url">vue-hackernews-2.0 源码解读(适合入门)(二)</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-17 19:07:51 / 修改时间：19:39:55" itemprop="dateCreated datePublished" datetime="2019-10-17T19:07:51+08:00">2019-10-17</time>
            </span>
          
            

            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <p>书接上回</p>
<p>我们看下entry-server.js主要做了什么</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isDev = process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//此导出的函数将由`bundleRenderer`调用。</span></span><br><span class="line"><span class="comment">//这是我们执行数据预取以确定</span></span><br><span class="line"><span class="comment">//实际渲染应用程序之前的状态。</span></span><br><span class="line"><span class="comment">//由于数据获取是异步的，因此该函数有望</span></span><br><span class="line"><span class="comment">//返回解析为应用实例的Promise。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This exported function will be called by `bundleRenderer`.</span></span><br><span class="line"><span class="comment">// This is where we perform data-prefetching to determine the</span></span><br><span class="line"><span class="comment">// state of our application before actually rendering it.</span></span><br><span class="line"><span class="comment">// Since data fetching is async, this function is expected to</span></span><br><span class="line"><span class="comment">// return a Promise that resolves to the app instance.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> context =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> s = isDev &amp;&amp; <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="keyword">const</span> &#123; app, router, store &#125; = createApp()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; url &#125; = context</span><br><span class="line">    <span class="keyword">const</span> &#123; fullPath &#125; = router.resolve(url).route</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fullPath !== url) &#123;</span><br><span class="line">      <span class="keyword">return</span> reject(&#123; <span class="attr">url</span>: fullPath &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置路由位置</span></span><br><span class="line">    <span class="comment">// set router's location</span></span><br><span class="line">    router.push(url)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待路由可能的异步钩子</span></span><br><span class="line">    <span class="comment">// wait until router has resolved possible async hooks</span></span><br><span class="line">    router.onReady(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> matchedComponents = router.getMatchedComponents()</span><br><span class="line">      <span class="comment">// no matched routes</span></span><br><span class="line">      <span class="keyword">if</span> (!matchedComponents.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> reject(&#123; <span class="attr">code</span>: <span class="number">404</span> &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//路由上匹配的组件唤醒fetchData钩子</span></span><br><span class="line">      <span class="comment">//一个预置钩子匹配一个状态返回promise</span></span><br><span class="line">      <span class="comment">//当解析完成且状态更新</span></span><br><span class="line">      <span class="comment">// Call fetchData hooks on components matched by the route.</span></span><br><span class="line">      <span class="comment">// A preFetch hook dispatches a store action and returns a Promise,</span></span><br><span class="line">      <span class="comment">// which is resolved when the action is complete and store state has been</span></span><br><span class="line">      <span class="comment">// updated.</span></span><br><span class="line">      <span class="comment">// 使用Promise.all执行匹配到的Component的asyncData方法，即预取数据</span></span><br><span class="line">      <span class="built_in">Promise</span>.all(matchedComponents.map(<span class="function">(<span class="params">&#123; asyncData &#125;</span>) =&gt;</span> asyncData &amp;&amp; asyncData(&#123;</span><br><span class="line">        store,</span><br><span class="line">        route: router.currentRoute</span><br><span class="line">      &#125;))).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        isDev &amp;&amp; <span class="built_in">console</span>.log(<span class="string">`data pre-fetch: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - s&#125;</span>ms`</span>)</span><br><span class="line">        <span class="comment">//解析了所有prefetch钩子后,渲染app所需要的state充满了store,</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//在渲染上下文中公开状态，并让请求处理程序</span></span><br><span class="line">        <span class="comment">//内联HTML响应中的状态。这允许客户端</span></span><br><span class="line">        <span class="comment">//存储以获取服务器端状态，而不必重复</span></span><br><span class="line">        <span class="comment">//在客户端上获取初始数据。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// After all preFetch hooks are resolved, our store is now</span></span><br><span class="line">        <span class="comment">// filled with the state needed to render the app.</span></span><br><span class="line">        <span class="comment">// Expose the state on the render context, and let the request handler</span></span><br><span class="line">        <span class="comment">// inline the state in the HTML response. This allows the client-side</span></span><br><span class="line">        <span class="comment">// store to pick-up the server-side state without having to duplicate</span></span><br><span class="line">        <span class="comment">// the initial data fetching on the client.</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">// 把vuex的state设置到传入的context.initialState上</span></span><br><span class="line">        context.state = store.state</span><br><span class="line">         <span class="comment">// 返回state, router已经设置好的Vue实例app</span></span><br><span class="line">        resolve(app)</span><br><span class="line">      &#125;).catch(reject)</span><br><span class="line">    &#125;, reject)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>entry-server.js的主要工作：<br>0.返回一个函数，该函数接受一个从服务端传递过来的 context 的参数，<br>将 vue 实例通过 Promise 返回。 context 一般包含 当前页面的url。<br>1.手动路由切换到请求的url，即’/‘<br>2.找到该路由对应要渲染的组件，并调用组件的asyncData方法来预取数据<br>3.同步vuex的state数据至传入的context.initialState上，<br>后面会把这些数据直接发送到浏览器端与客户端的vue 实例进行数据(状态)同步，<br>以避免客户端首屏重新加载数据（在客户端入口文件entry-client.js）</p>
<p>还记得index.template.html被设置到template属性中吗？<br>此时Vue渲染器内部就会将Vue实例渲染进我们传入的这个html模板，那么Vue render内部是如何知道把Vue实例插入到模板的什么位置呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;!--vue-ssr-outlet--&gt;</span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br></pre></td></tr></table></figure>

<p>就是这里，这个<code>&lt;!--vue-ssr-outlet--&gt;</code>Vue渲染器就是根据这个自动替换插入，所以这是个固定的placeholder。<br>如果改动，服务端渲染时会有错误提示：Error: Content placeholder not found in template.</p>
<p>接下来，Vue渲染器会回调callback方法，我们回到server.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">  ···</span><br><span class="line">  renderer.renderToString(context, (err, html) =&gt; &#123;</span><br><span class="line">    res.end(html)</span><br><span class="line">    ···</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时只需要将渲染好的html写入http响应体就结束了，浏览器客户端就可以看到页面了。</p>
<p>接下来我们看看服务端数据预取的实现</p>
<h1 id="服务端渲染时的数据预取流程"><a href="#服务端渲染时的数据预取流程" class="headerlink" title="服务端渲染时的数据预取流程"></a>服务端渲染时的数据预取流程</h1><p>上文提到，服务端渲染时，会手动将路由导航到请求地址即’/‘下，然后调用该路由组件的asyncData方法来预取数据</p>
<p>那么我们看看路由配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/router/index.js</span></span><br><span class="line">Vue.use(Router)</span><br><span class="line"><span class="comment">// route-level code splitting</span></span><br><span class="line"><span class="keyword">const</span> createListView = <span class="function"><span class="params">id</span> =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span> System.import(<span class="string">'../views/CreateListView'</span>).then(<span class="function"><span class="params">m</span> =&gt;</span> m.default(id))</span><br><span class="line"><span class="keyword">const</span> ItemView = <span class="function"><span class="params">()</span> =&gt;</span> System.import(<span class="string">'../views/ItemView.vue'</span>)</span><br><span class="line"><span class="keyword">const</span> UserView = <span class="function"><span class="params">()</span> =&gt;</span> System.import(<span class="string">'../views/UserView.vue'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createRouter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Router(&#123;</span><br><span class="line">    mode: <span class="string">'history'</span>,</span><br><span class="line">    scrollBehavior: <span class="function"><span class="params">()</span> =&gt;</span> (&#123; <span class="attr">y</span>: <span class="number">0</span> &#125;),</span><br><span class="line">    routes: [</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/top/:page(\\d+)?'</span>, <span class="attr">component</span>: createListView(<span class="string">'top'</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/new/:page(\\d+)?'</span>, <span class="attr">component</span>: createListView(<span class="string">'new'</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/show/:page(\\d+)?'</span>, <span class="attr">component</span>: createListView(<span class="string">'show'</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/ask/:page(\\d+)?'</span>, <span class="attr">component</span>: createListView(<span class="string">'ask'</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/job/:page(\\d+)?'</span>, <span class="attr">component</span>: createListView(<span class="string">'job'</span>) &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/item/:id(\\d+)'</span>, <span class="attr">component</span>: ItemView &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/user/:id'</span>, <span class="attr">component</span>: UserView &#125;,</span><br><span class="line">      &#123; <span class="attr">path</span>: <span class="string">'/'</span>, <span class="attr">redirect</span>: <span class="string">'/top'</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>地址’/‘是做了redirect到’/top’,其实就是默认地址就是到top页面，在看第一条路由配置，’/top’路由对应的组件是createListView(‘top’)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/CreateListView.js</span></span><br><span class="line"><span class="keyword">import</span> ItemList <span class="keyword">from</span> <span class="string">'./ItemList.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> camelize = <span class="function"><span class="params">str</span> =&gt;</span> str.charAt(<span class="number">0</span>).toUpperCase() + str.slice(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is a factory function for dynamically creating root-level list views,</span></span><br><span class="line"><span class="comment">// since they share most of the logic except for the type of items to display.</span></span><br><span class="line"><span class="comment">// They are essentially higher order components wrapping ItemList.vue.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createListView</span> (<span class="params">type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    name: <span class="string">`<span class="subst">$&#123;type&#125;</span>-stories-view`</span>,</span><br><span class="line">    <span class="comment">//从store中取值</span></span><br><span class="line">    asyncData (&#123; store &#125;) &#123;</span><br><span class="line">      <span class="keyword">return</span> store.dispatch(<span class="string">'FETCH_LIST_DATA'</span>, &#123; type &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    title: camelize(type),</span><br><span class="line">    <span class="comment">//创建itemlist的节点,渲染节点</span></span><br><span class="line">    render (h) &#123;</span><br><span class="line">      <span class="keyword">return</span> h(ItemList, &#123; <span class="attr">props</span>: &#123; type &#125;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Vuex-state状态变更流程"><a href="#Vuex-state状态变更流程" class="headerlink" title="Vuex state状态变更流程"></a>Vuex state状态变更流程</h1><p><img src="https://s2.ax1x.com/2019/10/17/KEZjTP.jpg" alt="KEZjTP.jpg"><br>asyncData方法被调用，通过store.dispatch分发了一个数据预取的事件，接下来我们可以看到通过FireBase的API获取到Top分类的数据，然后又做了一系列的内部事件分发，保存数据状态到Vuex store，获取Top页面的List子项数据，最后处理并保存数据到store.</p>
<p>最后数据就都保存在store这里了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"><span class="keyword">import</span> actions <span class="keyword">from</span> <span class="string">'./actions'</span></span><br><span class="line"><span class="keyword">import</span> mutations <span class="keyword">from</span> <span class="string">'./mutations'</span></span><br><span class="line"><span class="keyword">import</span> getters <span class="keyword">from</span> <span class="string">'./getters'</span></span><br><span class="line"></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">    state: &#123;</span><br><span class="line">      activeType: <span class="literal">null</span>,</span><br><span class="line">      itemsPerPage: <span class="number">20</span>,</span><br><span class="line">      items: &#123;<span class="comment">/* [id: number]: Item */</span>&#125;,</span><br><span class="line">      users: &#123;<span class="comment">/* [id: string]: User */</span>&#125;,</span><br><span class="line">      lists: &#123;</span><br><span class="line">        top: [<span class="comment">/* number */</span>],</span><br><span class="line">        <span class="keyword">new</span>: [],</span><br><span class="line">        show: [],</span><br><span class="line">        ask: [],</span><br><span class="line">        job: []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    actions,</span><br><span class="line">    mutations,</span><br><span class="line">    getters</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将开始通过Render 函数创建HTML</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/CreateListView.js</span></span><br><span class="line">render (h) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`createListView render`</span>)</span><br><span class="line">      <span class="keyword">return</span> h(ItemList, &#123; <span class="attr">props</span>: &#123; type &#125;&#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/views/ItemList.vue</span></span><br><span class="line">···</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"news-view"</span>&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"news-list-nav"</span>&gt;</span><br><span class="line">      &lt;router-link v-<span class="keyword">if</span>=<span class="string">"page &gt; 1"</span> :to=<span class="string">"'/' + type + '/' + (page - 1)"</span>&gt;&amp;lt; prev&lt;<span class="regexp">/router-link&gt;</span></span><br><span class="line"><span class="regexp">      &lt;a v-else class="disabled"&gt;&amp;lt; prev&lt;/</span>a&gt;</span><br><span class="line">      &lt;span&gt;&#123;&#123; page &#125;&#125;/&#123;&#123; maxPage &#125;&#125;&lt;<span class="regexp">/span&gt;</span></span><br><span class="line"><span class="regexp">      &lt;router-link v-if="hasMore" :to="'/</span><span class="string">' + type + '</span>/<span class="string">' + (page + 1)"&gt;more &amp;gt;&lt;/router-link&gt;</span></span><br><span class="line"><span class="string">      &lt;a v-else class="disabled"&gt;more &amp;gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;transition :name="transition"&gt;</span></span><br><span class="line"><span class="string">      &lt;div class="news-list" :key="displayedPage" v-if="displayedPage &gt; 0"&gt;</span></span><br><span class="line"><span class="string">        &lt;transition-group tag="ul" name="item"&gt;</span></span><br><span class="line"><span class="string">          &lt;item v-for="item in displayedItems" :key="item.id" :item="item"&gt;</span></span><br><span class="line"><span class="string">          &lt;/item&gt;</span></span><br><span class="line"><span class="string">        &lt;/transition-group&gt;</span></span><br><span class="line"><span class="string">      &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/transition&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/template&gt;</span></span><br><span class="line"><span class="string">···</span></span><br></pre></td></tr></table></figure>

<p>这样创建完HTML Body部分，前面提到的Vue渲染器会自动把这部分内容插入index.template.html中，替换对应的<!--vue-ssr-outlet-->,然后就又回到前面的流程了，server.js将整个html写入http响应体，浏览器就得到了整个html页面，整个首次访问过程完成。<br>暂时先这样</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/16/vue-hackernews-2-0-源码解读-适合入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/16/vue-hackernews-2-0-源码解读-适合入门/" class="post-title-link" itemprop="url">vue-hackernews-2.0 源码解读(适合入门)(一)</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-16 11:17:57" itemprop="dateCreated datePublished" datetime="2019-10-16T11:17:57+08:00">2019-10-16</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-19 09:10:50" itemprop="dateModified" datetime="2019-10-19T09:10:50+08:00">2019-10-19</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <blockquote>
<p>HackerNews 是基于 HN 的官方 firebase API 、Vue 2.0 、vue-router 和 vuex 来构建的，使用服务器端渲染。<br>vue-hackernews 项目，是尤大神在 Vue-SSR 官方文档所展示的范例 DEMO.涉及知识点及技术栈非常全面，对于初学者来说，直接阅读该项目，极具挑战。那么我就来一句一句的解析,看看到底都是啥.<br>本文借鉴了 osan 的文章(<a href="https://wangfuda.github.io/2017/05/14/vue-hackernews-2.0-code-explain/),加上本人自己的理解,从菜鸡的角度来看,添加一些理解" target="_blank" rel="noopener">https://wangfuda.github.io/2017/05/14/vue-hackernews-2.0-code-explain/),加上本人自己的理解,从菜鸡的角度来看,添加一些理解</a>.</p>
</blockquote>
<h1 id="牢骚"><a href="#牢骚" class="headerlink" title="牢骚"></a>牢骚</h1><p>去了一家公司面试,问了半天技术,答基础不错(因为我没有工作经验).回复说我司非常依赖 SSR,对 SEO 要求很高,搜索引擎排名必须第一,要求我必须尽快做出一份 demo 出来满足他们的最低要求.那么问题来了,我对 SSR 基本只是一知半解,怎么用完全属于白板啊.当时周五,那么只剩周六日两天了,也就是说,两天从不知 SSR 为何物到搞出一个 demo.压力好大.回去路上就开始上网查文档.我一看,这是啥,这又是啥.完全不知所云啊.<br>无奈看看有没有入门教程吧,一搜,好少啊,看看掘金,挺多的,挨个看一遍,为什么都在 copy 官方文档啊,把各个组件,方法讲讲都是干嘛的也行啊,根本没讲,copy 完官方文档,直接甩一个 demo.我:what?<br>这真是应验了官方指南的话,</p>
<blockquote>
<p>本指南将会非常深入，并且假设你已经熟悉 Vue.js 本身，并且具有 Node.js 和 webpack 的相当不错的应用经验。<br>我这完全不熟悉 node 和 webpack 的人完全就是抓瞎啊.<br>好吧,经过不断努(bao)力(gan),终于搞出了一个 demo,人家说技术不过关,期待下次合作.wtf?<br>也在意料之中了,有老手为什么还要菜鸡呢?<br>不过这技术不能扔了,我得记下来,以警示后人…</p>
</blockquote>
<h1 id="结构概览"><a href="#结构概览" class="headerlink" title="结构概览"></a>结构概览</h1><p><img src="https://s2.ax1x.com/2019/10/17/KESW6K.png" alt="KESW6K.png"><br>项目结构图上显示，有两个入口文件，entry-server.js 和 entry-client.js， 分别是服务端渲染和客户端渲染的实现入口，webpack 将两个入口文件分别打包成给服务端用的 server bundle 和给客户端用的 client bundle.</p>
<p>服务端：当 Node Server 收到来自 Browser 的请求后，会创建一个 Vue 渲染器 BundleRenderer，这个 bundleRenderer 会读取上面生成的 server bundle 文件（即 entry-server.js），并且执行它，而 server bundle 实现了数据预取并返回已填充数据的 Vue 实例，接下来 Vue 渲染器内部就会将 Vue 实例渲染进 html 模板，最后把这个完整的 html 发送到浏览器。</p>
<p>客户端：Browser 收到 HTML 后，客户端加载了client bundle(即 entry-client.js) ，通过 app.$mount(‘#app’)挂载 Vue 实例到服务端渲染的 DOM 上,并会和服务端渲染的HTML进行 Hydration（合并）.</p>
<h1 id="大体操作"><a href="#大体操作" class="headerlink" title="大体操作"></a>大体操作</h1><p><img src="https://s2.ax1x.com/2019/10/17/KEeeYT.png" alt="KEeeYT.png"></p>
<h1 id="目录概览"><a href="#目录概览" class="headerlink" title="目录概览"></a>目录概览</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">│  manifest.json				# progressive web apps配置文件</span><br><span class="line">│  package.json					# 项目配置文件</span><br><span class="line">│  server.js					# 服务端渲染</span><br><span class="line">│</span><br><span class="line">├─public                                    	# 静态资源</span><br><span class="line">│      logo<span class="number">-120.</span>png</span><br><span class="line">│      logo<span class="number">-144.</span>png</span><br><span class="line">│      logo<span class="number">-152.</span>png</span><br><span class="line">│      logo<span class="number">-192.</span>png</span><br><span class="line">│      logo<span class="number">-384.</span>png</span><br><span class="line">│      logo<span class="number">-48.</span>png</span><br><span class="line">│</span><br><span class="line">└─src</span><br><span class="line">    │  app.js					# 整合 router,filters,vuex 的入口文件</span><br><span class="line">    │  App.vue					# 根 vue 组件</span><br><span class="line">    │  entry-client.js				# client 的入口文件</span><br><span class="line">    │  entry-server.js				# server 的入口文件</span><br><span class="line">    │  index.template.html			# html 模板</span><br><span class="line">    │</span><br><span class="line">    ├─api</span><br><span class="line">    │      create-api-client.js			# Client数据源配置</span><br><span class="line">    │      create-api-server.js			# server数据源配置</span><br><span class="line">    │      index.js				# 数据请求API</span><br><span class="line">    │</span><br><span class="line">    ├─components</span><br><span class="line">    │      Comment.vue				# 评论组件</span><br><span class="line">    │      Item.vue				#</span><br><span class="line">    │      ProgressBar.vue			# 进度条组件</span><br><span class="line">    │      Spinner.vue				# 加载提示组件</span><br><span class="line">    │</span><br><span class="line">    ├─router</span><br><span class="line">    │      index.js				# router配置</span><br><span class="line">    │</span><br><span class="line">    ├─store					# Vue store模块</span><br><span class="line">    │      actions.js				# 根级别的 action</span><br><span class="line">    │      getters.js				# 属性接口</span><br><span class="line">    │      index.js				# 我们组装模块并导出 store 的地方</span><br><span class="line">    │      mutations.js				# 根级别的 mutation</span><br><span class="line">    │</span><br><span class="line">    ├─util</span><br><span class="line">    │      filters.js				# 过滤器</span><br><span class="line">    │      title.js				# 工具类</span><br><span class="line">    │</span><br><span class="line">    └─views</span><br><span class="line">            CreateListView.js			# 动态生成列表界面的工厂方法</span><br><span class="line">            ItemList.vue			# List界面组件</span><br><span class="line">            ItemView.vue			# 单List项组件</span><br><span class="line">            UserView.vue			# 用户界面组件</span><br></pre></td></tr></table></figure>

<h1 id="开发环境的服务端渲染流程"><a href="#开发环境的服务端渲染流程" class="headerlink" title="开发环境的服务端渲染流程"></a>开发环境的服务端渲染流程</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># serve in dev mode, with hot reload at localhost:8080</span><br><span class="line">$npm run dev</span><br></pre></td></tr></table></figure>

<p>看看发生了什么<br><img src="https://s2.ax1x.com/2019/10/17/KEpF10.png" alt="KEpF10.png"><br>上述执行 dev 属性对应的脚本：node server 即 node server.js，即执行 server.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//server.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> LRU = <span class="built_in">require</span>(<span class="string">"lru-cache"</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> favicon = <span class="built_in">require</span>(<span class="string">"serve-favicon"</span>);</span><br><span class="line"><span class="keyword">const</span> compression = <span class="built_in">require</span>(<span class="string">"compression"</span>);</span><br><span class="line"><span class="keyword">const</span> microcache = <span class="built_in">require</span>(<span class="string">"route-cache"</span>);</span><br><span class="line"><span class="keyword">const</span> resolve = <span class="function"><span class="params">file</span> =&gt;</span> path.resolve(__dirname, file);</span><br><span class="line"><span class="keyword">const</span> &#123; createBundleRenderer &#125; = <span class="built_in">require</span>(<span class="string">"vue-server-renderer"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置生产环境</span></span><br><span class="line"><span class="keyword">const</span> isProd = process.env.NODE_ENV === <span class="string">"production"</span>;</span><br><span class="line"><span class="comment">//使用微缓存</span></span><br><span class="line"><span class="keyword">const</span> useMicroCache = process.env.MICRO_CACHE !== <span class="string">"false"</span>;</span><br><span class="line"><span class="comment">//服务端信息</span></span><br><span class="line"><span class="keyword">const</span> serverInfo =</span><br><span class="line">  <span class="string">`express/<span class="subst">$&#123;<span class="built_in">require</span>(<span class="string">"express/package.json"</span>).version&#125;</span> `</span> +</span><br><span class="line">  <span class="string">`vue-server-renderer/<span class="subst">$&#123;<span class="built_in">require</span>(<span class="string">"vue-server-renderer/package.json"</span>).version&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用expess</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建渲染器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRenderer</span>(<span class="params">bundle, options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 调用vue-server-renderer的createBundleRenderer方法创建渲染器，</span></span><br><span class="line">  <span class="comment">//并设置HTML模板，以后后续将服务端预取的数据填充至模板中</span></span><br><span class="line">  <span class="keyword">return</span> createBundleRenderer(</span><br><span class="line">    bundle,</span><br><span class="line">    <span class="built_in">Object</span>.assign(options, &#123;</span><br><span class="line">      <span class="comment">// for component caching</span></span><br><span class="line">      <span class="comment">//设置一个缓存</span></span><br><span class="line">      cache: LRU(&#123;</span><br><span class="line">        max: <span class="number">1000</span>,</span><br><span class="line">        maxAge: <span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span></span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="comment">// this is only needed when vue-server-renderer is npm-linked</span></span><br><span class="line">      basedir: resolve(<span class="string">"./dist"</span>),</span><br><span class="line">      <span class="comment">// recommended for performance</span></span><br><span class="line">      runInNewContext: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> renderer;</span><br><span class="line"><span class="keyword">let</span> readyPromise;</span><br><span class="line"><span class="comment">//模板路径</span></span><br><span class="line"><span class="keyword">const</span> templatePath = resolve(<span class="string">"./src/index.template.html"</span>);</span><br><span class="line"><span class="keyword">if</span> (isProd) &#123;</span><br><span class="line">  <span class="comment">//生产环境:</span></span><br><span class="line">  <span class="comment">//webpack结合vue-ssr-webpack-plugin插件生成的server bundle</span></span><br><span class="line">  <span class="comment">//服务端渲染的HTML模板</span></span><br><span class="line">  <span class="keyword">const</span> template = fs.readFileSync(templatePath, <span class="string">"utf-8"</span>);</span><br><span class="line">  <span class="comment">//生产环境的时候这里已经打包好了这个json文件可以直接调用</span></span><br><span class="line">  <span class="keyword">const</span> bundle = <span class="built_in">require</span>(<span class="string">"./dist/vue-ssr-server-bundle.json"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//client manifests是可选项,允许渲染器自动预加载,渲染添加&lt;script&gt;标签</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The client manifests are optional, but it allows the renderer</span></span><br><span class="line">  <span class="comment">// to automatically infer preload/prefetch links and directly add &lt;script&gt;</span></span><br><span class="line">  <span class="comment">// tags for any async chunks used during render, avoiding waterfall requests.</span></span><br><span class="line">  <span class="keyword">const</span> clientManifest = <span class="built_in">require</span>(<span class="string">"./dist/vue-ssr-client-manifest.json"</span>);</span><br><span class="line">  <span class="comment">//vue-server-renderer创建bundle渲染器并绑定server bundle</span></span><br><span class="line">  renderer = createRenderer(bundle, &#123;</span><br><span class="line">    template,</span><br><span class="line">    clientManifest</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 开发环境下，使用dev-server来通过回调把生成在内存中的bundle文件传回</span></span><br><span class="line">  <span class="comment">// 通过dev server的webpack-dev-middleware和webpack-hot-middleware实现客户端代码的热更新</span></span><br><span class="line">  <span class="comment">//以及通过webpack的watch功能实现服务端代码的热更新</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// In development: setup the dev server with watch and hot-reload,</span></span><br><span class="line">  <span class="comment">// and create a new renderer on bundle / index template update.</span></span><br><span class="line">  readyPromise = <span class="built_in">require</span>(<span class="string">"./build/setup-dev-server"</span>)(</span><br><span class="line">    app,</span><br><span class="line">    templatePath,</span><br><span class="line">    (bundle, options) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 基于热更新，回调生成最新的bundle渲染器</span></span><br><span class="line">      renderer = createRenderer(bundle, options);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态缓存时间</span></span><br><span class="line"><span class="keyword">const</span> serve = <span class="function">(<span class="params">path, cache</span>) =&gt;</span></span><br><span class="line">  express.static(resolve(path), &#123;</span><br><span class="line">    maxAge: cache &amp;&amp; isProd ? <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span> : <span class="number">0</span></span><br><span class="line">  &#125;);</span><br><span class="line"><span class="comment">//依次装载一系列Express中间件，用来处理静态资源，数据压缩等</span></span><br><span class="line">app.use(compression(&#123; <span class="attr">threshold</span>: <span class="number">0</span> &#125;));</span><br><span class="line">app.use(favicon(<span class="string">"./public/logo-48.png"</span>));</span><br><span class="line">app.use(<span class="string">"/dist"</span>, serve(<span class="string">"./dist"</span>, <span class="literal">true</span>));</span><br><span class="line">app.use(<span class="string">"/public"</span>, serve(<span class="string">"./public"</span>, <span class="literal">true</span>));</span><br><span class="line">app.use(<span class="string">"/manifest.json"</span>, serve(<span class="string">"./manifest.json"</span>, <span class="literal">true</span>));</span><br><span class="line">app.use(<span class="string">"/service-worker.js"</span>, serve(<span class="string">"./dist/service-worker.js"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// since this app has no user-specific content, every page is micro-cacheable.</span></span><br><span class="line"><span class="comment">// if your app involves user-specific content, you need to implement custom</span></span><br><span class="line"><span class="comment">// logic to determine whether a request is cacheable based on its url and</span></span><br><span class="line"><span class="comment">// headers.</span></span><br><span class="line"><span class="comment">// 1-second microcache.</span></span><br><span class="line"><span class="comment">// https://www.nginx.com/blog/benefits-of-microcaching-nginx/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//设置微缓存</span></span><br><span class="line">app.use(microcache.cacheSeconds(<span class="number">1</span>, req =&gt; useMicroCache &amp;&amp; req.originalUrl));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> s = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">  res.setHeader(<span class="string">"Content-Type"</span>, <span class="string">"text/html"</span>);</span><br><span class="line">  res.setHeader(<span class="string">"Server"</span>, serverInfo);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> handleError = <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.url) &#123;</span><br><span class="line">      res.redirect(err.url);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (err.code === <span class="number">404</span>) &#123;</span><br><span class="line">      res.status(<span class="number">404</span>).send(<span class="string">"404 | Page Not Found"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Render Error Page or Redirect</span></span><br><span class="line">      res.status(<span class="number">500</span>).send(<span class="string">"500 | Internal Server Error"</span>);</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">`error during render : <span class="subst">$&#123;req.url&#125;</span>`</span>);</span><br><span class="line">      <span class="built_in">console</span>.error(err.stack);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 设置请求的url</span></span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    title: <span class="string">"Vue HN 2.0"</span>, <span class="comment">// default title</span></span><br><span class="line">    url: req.url</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为渲染器绑定的server bundle（即entry-server.js）设置入参context</span></span><br><span class="line">  renderer.renderToString(context, (err, html) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> handleError(err);</span><br><span class="line">    &#125;</span><br><span class="line">    res.send(html);</span><br><span class="line">    <span class="keyword">if</span> (!isProd) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`whole request: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - s&#125;</span>ms`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//启动一个服务并监听从 8080 端口进入的所有连接请求。</span></span><br><span class="line">app.get(</span><br><span class="line">  <span class="string">"*"</span>,</span><br><span class="line">  isProd</span><br><span class="line">    ? render</span><br><span class="line">    : <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">        readyPromise.then(<span class="function"><span class="params">()</span> =&gt;</span> render(req, res));</span><br><span class="line">      &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">8080</span>;</span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`server started at localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>server.js 最终监听 8080 端口等待处理客户端请求，此时在浏览器访问 localhost:8080<br>请求经由 express 路由接收后，执行处理逻辑:readyPromise.then(() =&gt; render(req, res))<br>沿着 Promise 的调用链处理：<br>开发环境下 1.调用 setup-dev-server.js 模块，根据上图中 webpack config 文件实现入口文件打包，热替换功能实现。<br>最终通过回调把生成在内存中的 server bundle 传回。 2.创建渲染器，绑定 server bundle，设置渲染模板，缓存等 3.依次装载一系列 Express 中间件，用来处理静态资源，数据压缩等 4.最后将渲染好的 HTML 写入 http 响应体，传回浏览器。</p>
<h1 id="setup-dev-server"><a href="#setup-dev-server" class="headerlink" title="setup-dev-server"></a>setup-dev-server</h1><p>server.js 的模块依赖关系图<br><img src="https://s2.ax1x.com/2019/10/17/KEpxv6.png" alt="KEpxv6.png"></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setup-dev-server.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> MFS = <span class="built_in">require</span>(<span class="string">"memory-fs"</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="keyword">const</span> chokidar = <span class="built_in">require</span>(<span class="string">"chokidar"</span>);</span><br><span class="line"><span class="keyword">const</span> clientConfig = <span class="built_in">require</span>(<span class="string">"./webpack.client.config"</span>);</span><br><span class="line"><span class="keyword">const</span> serverConfig = <span class="built_in">require</span>(<span class="string">"./webpack.server.config"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取文件</span></span><br><span class="line"><span class="keyword">const</span> readFile = <span class="function">(<span class="params">fs, file</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//fs读取客户端输出路径</span></span><br><span class="line">    <span class="keyword">return</span> fs.readFileSync(path.join(clientConfig.output.path, file), <span class="string">"utf-8"</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出模块,创建开发服务</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">setupDevServer</span>(<span class="params">app, templatePath, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> bundle;</span><br><span class="line">  <span class="keyword">let</span> template;</span><br><span class="line">  <span class="keyword">let</span> clientManifest;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ready;</span><br><span class="line">  <span class="keyword">const</span> readyPromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">    ready = r;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">//设定更新</span></span><br><span class="line">  <span class="keyword">const</span> update = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (bundle &amp;&amp; clientManifest) &#123;</span><br><span class="line">      ready();</span><br><span class="line">      cb(bundle, &#123;</span><br><span class="line">        template,</span><br><span class="line">        clientManifest</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//读取本地模板并观测</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// read template from disk and watch</span></span><br><span class="line">  template = fs.readFileSync(templatePath, <span class="string">"utf-8"</span>);</span><br><span class="line">  chokidar.watch(templatePath).on(<span class="string">"change"</span>, () =&gt; &#123;</span><br><span class="line">    template = fs.readFileSync(templatePath, <span class="string">"utf-8"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"index.html template updated."</span>);</span><br><span class="line">    update();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//客户端热加载服务</span></span><br><span class="line">  <span class="comment">// modify client config to work with hot middleware</span></span><br><span class="line">  clientConfig.entry.app = [</span><br><span class="line">    <span class="string">"webpack-hot-middleware/client"</span>,</span><br><span class="line">    clientConfig.entry.app</span><br><span class="line">  ];</span><br><span class="line">  clientConfig.output.filename = <span class="string">"[name].js"</span>;</span><br><span class="line">  clientConfig.plugins.push(</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">    <span class="keyword">new</span> webpack.NoEmitOnErrorsPlugin()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//开发中间件</span></span><br><span class="line">  <span class="comment">// dev middleware</span></span><br><span class="line">  <span class="keyword">const</span> clientCompiler = webpack(clientConfig);</span><br><span class="line">  <span class="keyword">const</span> devMiddleware = <span class="built_in">require</span>(<span class="string">"webpack-dev-middleware"</span>)(clientCompiler, &#123;</span><br><span class="line">    publicPath: clientConfig.output.publicPath,</span><br><span class="line">    noInfo: <span class="literal">true</span></span><br><span class="line">  &#125;);</span><br><span class="line">  app.use(devMiddleware);</span><br><span class="line">  <span class="comment">// 在client webpack结合vue-ssr-webpack-plugin完成编译后，获取devMiddleware的fileSystem</span></span><br><span class="line">  <span class="comment">// 读取内存中的bundle 并通过传入的回调更新server.js中的bundle</span></span><br><span class="line">  clientCompiler.plugin(<span class="string">"done"</span>, stats =&gt; &#123;</span><br><span class="line">    stats = stats.toJson();</span><br><span class="line">    stats.errors.forEach(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err));</span><br><span class="line">    stats.warnings.forEach(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.warn(err));</span><br><span class="line">    <span class="keyword">if</span> (stats.errors.length) <span class="keyword">return</span>;</span><br><span class="line">    clientManifest = <span class="built_in">JSON</span>.parse(</span><br><span class="line">      readFile(devMiddleware.fileSystem, <span class="string">"vue-ssr-client-manifest.json"</span>)</span><br><span class="line">    );</span><br><span class="line">    update();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//中间件热加载</span></span><br><span class="line">  <span class="comment">// hot middleware</span></span><br><span class="line">  app.use(</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">"webpack-hot-middleware"</span>)(clientCompiler, &#123; <span class="attr">heartbeat</span>: <span class="number">5000</span> &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//观测更新服务渲染</span></span><br><span class="line">  <span class="comment">// watch and update server renderer</span></span><br><span class="line">  <span class="keyword">const</span> serverCompiler = webpack(serverConfig);</span><br><span class="line">  <span class="comment">// 获取基于memory-fs创建的内存文件系统对象</span></span><br><span class="line">  <span class="keyword">const</span> mfs = <span class="keyword">new</span> MFS();</span><br><span class="line">  serverCompiler.outputFileSystem = mfs;</span><br><span class="line">  <span class="comment">// 设置文件重新编译监听并通过传入的回调更新server.js中的bundle</span></span><br><span class="line">  serverCompiler.watch(&#123;&#125;, (err, stats) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    stats = stats.toJson();</span><br><span class="line">    <span class="keyword">if</span> (stats.errors.length) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//读取bundle文件</span></span><br><span class="line">    <span class="comment">// read bundle generated by vue-ssr-webpack-plugin</span></span><br><span class="line">    bundle = <span class="built_in">JSON</span>.parse(readFile(mfs, <span class="string">"vue-ssr-server-bundle.json"</span>));</span><br><span class="line">    update();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> readyPromise;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// build/webpack.base.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="keyword">const</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">"extract-text-webpack-plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> FriendlyErrorsPlugin = <span class="built_in">require</span>(<span class="string">"friendly-errors-webpack-plugin"</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; VueLoaderPlugin &#125; = <span class="built_in">require</span>(<span class="string">"vue-loader"</span>);</span><br><span class="line"><span class="comment">//生产环境</span></span><br><span class="line"><span class="keyword">const</span> isProd = process.env.NODE_ENV === <span class="string">"production"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">//开发环境搞这些</span></span><br><span class="line">  <span class="comment">// 开发环境下，开启代码调试map，方便调试断点时代码寻址，推荐模式选择：cheap-module-source-map</span></span><br><span class="line">  devtool: isProd ? <span class="literal">false</span> : <span class="string">"#cheap-module-source-map"</span>,</span><br><span class="line">  <span class="comment">// 打包输出配置</span></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">"../dist"</span>),</span><br><span class="line">    publicPath: <span class="string">"/dist/"</span>,</span><br><span class="line">    filename: <span class="string">"[name].[chunkhash].js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    alias: &#123;</span><br><span class="line">      public: path.resolve(__dirname, <span class="string">"../public"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//解析模块,各种加载器</span></span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    noParse: <span class="regexp">/es6-promise\.js$/</span>, <span class="comment">// avoid webpack shimming process</span></span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.vue$/</span>,</span><br><span class="line">        loader: <span class="string">"vue-loader"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          compilerOptions: &#123;</span><br><span class="line">            preserveWhitespace: <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">        exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(png|jpg|gif|svg)$/</span>,</span><br><span class="line">        loader: <span class="string">"url-loader"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          limit: <span class="number">10000</span>,</span><br><span class="line">          name: <span class="string">"[name].[ext]?[hash]"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.styl(us)?$/</span>,</span><br><span class="line">        use: isProd</span><br><span class="line">          ? ExtractTextPlugin.extract(&#123;</span><br><span class="line">              use: [</span><br><span class="line">                &#123;</span><br><span class="line">                  loader: <span class="string">"css-loader"</span>,</span><br><span class="line">                  options: &#123; <span class="attr">minimize</span>: <span class="literal">true</span> &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"stylus-loader"</span></span><br><span class="line">              ],</span><br><span class="line">              fallback: <span class="string">"vue-style-loader"</span></span><br><span class="line">            &#125;)</span><br><span class="line">          : [<span class="string">"vue-style-loader"</span>, <span class="string">"css-loader"</span>, <span class="string">"stylus-loader"</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  performance: &#123;</span><br><span class="line">    hints: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//生产环境搞这些</span></span><br><span class="line">  plugins: isProd</span><br><span class="line">    ? [</span><br><span class="line">        <span class="keyword">new</span> VueLoaderPlugin(),</span><br><span class="line">        <span class="comment">// 压缩js的插件</span></span><br><span class="line">        <span class="keyword">new</span> webpack.optimize.UglifyJsPlugin(&#123;</span><br><span class="line">          compress: &#123; <span class="attr">warnings</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> webpack.optimize.ModuleConcatenationPlugin(),</span><br><span class="line">        <span class="comment">// 从bundle中提取出特定的text到一个文件中,可以把css从js中独立抽离出来</span></span><br><span class="line">        <span class="keyword">new</span> ExtractTextPlugin(&#123;</span><br><span class="line">          filename: <span class="string">"common.[chunkhash].css"</span></span><br><span class="line">        &#125;)</span><br><span class="line">      ]</span><br><span class="line">    : [<span class="keyword">new</span> VueLoaderPlugin(), <span class="keyword">new</span> FriendlyErrorsPlugin()]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="创建渲染器"><a href="#创建渲染器" class="headerlink" title="创建渲染器"></a>创建渲染器</h1><p>就是server.js里这一步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRenderer</span> (<span class="params">bundle, options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// https://github.com/vuejs/vue/blob/dev/packages/vue-server-renderer/README.md#why-use-bundlerenderer</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`createRenderer`</span>)</span><br><span class="line">  <span class="keyword">return</span> createBundleRenderer(bundle, <span class="built_in">Object</span>.assign(options, &#123;</span><br><span class="line">    template,</span><br><span class="line">   </span><br><span class="line">	···</span><br><span class="line">  &#125;))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建渲染器时重点两件事：<br>1.绑定渲染用的server bundle至渲染器，这个bundle是在setup-dev-server.js中将服务端入口文件entry-server.js打包生成的。<br>当渲染器调用renderer.renderToString开始渲染时，会执行该入口文件的默认方法。<br>2.传入了一个html模板index.template.html，这个模板稍后在服务端渲染时就会动态填充预取数据到模板中。</p>
<p>顺着readyPromise.then的调用链，接下来调用render方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">···</span><br><span class="line">  renderer.renderToString(context, (err, html) =&gt; &#123;</span><br><span class="line">    res.end(html)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>renderer.renderToString方法内部会先调用入口模块entry-server.js的默认方法.<br>下节再叙</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/vue可复用性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/14/vue可复用性/" class="post-title-link" itemprop="url">vue可复用性&组合</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-14 15:08:18" itemprop="dateCreated datePublished" datetime="2019-10-14T15:08:18+08:00">2019-10-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-26 16:12:13" itemprop="dateModified" datetime="2019-10-26T16:12:13+08:00">2019-10-26</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="混入mixin"><a href="#混入mixin" class="headerlink" title="混入mixin"></a>混入mixin</h1><p>一个混入对象可以包含任意组件选项.当组件使用混入对象时,所有混入对象的选项将被”混合”进组件本身的选项.<br>例子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义一个混入对象</span></span><br><span class="line"><span class="keyword">var</span> myMixin = &#123;</span><br><span class="line">    created: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.hello()</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        hello: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'hello from mixin")</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//定义一个使用混入对象的组件</span></span><br><span class="line"><span class="string">var Component = Vue.extend(&#123;</span></span><br><span class="line"><span class="string">    mixins: [myMixin]</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">var component = new Component() //=&gt; '</span>hello <span class="keyword">from</span> mixin<span class="string">'</span></span><br></pre></td></tr></table></figure>

<h2 id="选项合并"><a href="#选项合并" class="headerlink" title="选项合并"></a>选项合并</h2><p>当组件和混入对象含有同名选项时,这些选项将以恰当的方式进行”合并”.<br>比如,数据对象在内部会进行递归合并,并在发生冲突时以组件数据优先.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mixin = &#123;</span><br><span class="line">    data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            message: <span class="string">'hello'</span>,</span><br><span class="line">            foo: <span class="string">'abc'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    mixins: [mixin],</span><br><span class="line">    data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            message: <span class="string">'goodbye'</span>,</span><br><span class="line">            bar: <span class="string">'def'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    created: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.$data)</span><br><span class="line">        <span class="comment">// =&gt; &#123; message: 'goodbye', foo:'abc', bar: 'def'&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>同名钩子函数将合并成一个数组,因此都将被调用.另外,混入对象的钩子将在组件自身钩子之前调用.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mixin = &#123;</span><br><span class="line">    created: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'混入对象钩子被调用'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    mixins: [mixin],</span><br><span class="line">    created: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'组件钩子被调用'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//=&gt; '混入对象钩子被调用'</span></span><br><span class="line"><span class="comment">//=&gt; '组件钩子被调用'</span></span><br></pre></td></tr></table></figure>

<p>值为对象的选项，例如 methods、components 和 directives，将被合并为同一个对象。两个对象键名冲突时，取组件对象的键值对。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mixin = &#123;</span><br><span class="line">    methods: &#123;</span><br><span class="line">        foo: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'foo'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        conficting: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'from mixin'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    mixins: [mixin],</span><br><span class="line">    methods: &#123;</span><br><span class="line">        bar: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'bar'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        conficting: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'from self'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">vm.foo() <span class="comment">// =&gt; "foo"</span></span><br><span class="line">vm.bar() <span class="comment">// =&gt; "bar"</span></span><br><span class="line">vm.conflicting() <span class="comment">// =&gt; "from self"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：<code>Vue.extend()</code> 也使用同样的策略进行合并。</p>
</blockquote>
<h2 id="全局混入"><a href="#全局混入" class="headerlink" title="全局混入"></a>全局混入</h2><p>混入也可以进行全局注册,使用时需要小心.一但使用全局混入,他将影响每一个之后创建的Vue实例.<br>使用恰当时还可以用来为自定义选项注入处理逻辑.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为自定义的选项 'myOption' 注入一个处理器。</span></span><br><span class="line">Vue.mixin(&#123;</span><br><span class="line">  created: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> myOption = <span class="keyword">this</span>.$options.myOption</span><br><span class="line">    <span class="keyword">if</span> (myOption) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(myOption)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  myOption: <span class="string">'hello!'</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// =&gt; "hello!"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>请谨慎使用全局混入，因为它会影响每个单独创建的 Vue 实例 (包括第三方组件)。大多数情况下，只应当应用于自定义选项，就像上面示例一样。推荐将其作为插件发布，以避免重复应用混入。</p>
</blockquote>
<h2 id="自定义选项合并策略"><a href="#自定义选项合并策略" class="headerlink" title="自定义选项合并策略"></a>自定义选项合并策略</h2><p>自定义选项将使用默认策略，即简单地覆盖已有值。如果想让自定义选项以自定义逻辑合并，可以向 Vue.config.optionMergeStrategies 添加一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vue.config.optionMergeStrategies.myOption = <span class="function"><span class="keyword">function</span> (<span class="params">toVal, fromVal</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 返回合并后的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于多数值为对象的选项，可以使用与 methods 相同的合并策略：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> strategies = Vue.config.optionMergeStrategies</span><br><span class="line">strategies.myOption = strategies.methods</span><br></pre></td></tr></table></figure>

<p>可以在 Vuex 1.x 的混入策略里找到一个更高级的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> merge = Vue.config.optionMergeStrategies.computed</span><br><span class="line">Vue.config.optionMergeStrategies.vuex = <span class="function"><span class="keyword">function</span> (<span class="params">toVal, fromVal</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!toVal) <span class="keyword">return</span> fromVal</span><br><span class="line">  <span class="keyword">if</span> (!fromVal) <span class="keyword">return</span> toVal</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    getters: merge(toVal.getters, fromVal.getters),</span><br><span class="line">    state: merge(toVal.state, fromVal.state),</span><br><span class="line">    actions: merge(toVal.actions, fromVal.actions)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="自定义指令"><a href="#自定义指令" class="headerlink" title="自定义指令"></a>自定义指令</h1><p>输入框聚焦<br>当页面加载时，该元素将获得焦点 (注意：autofocus 在移动版 Safari 上不工作)。事实上，只要你在打开这个页面后还没点击过任何内容，这个输入框就应当还是处于聚焦状态。现在让我们用指令来实现这个功能：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注册一个全局自定义指令v-focus</span></span><br><span class="line">Vue.directive(<span class="string">'focus'</span>, &#123;</span><br><span class="line"><span class="comment">//当被绑定的元素插入到DOM中时...</span></span><br><span class="line">inserted: <span class="function"><span class="keyword">function</span>(<span class="params">el</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//聚焦元素</span></span><br><span class="line">    el.focus()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>局部指令注册,组件中接受<code>directive</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">directives: &#123;</span><br><span class="line">    focus: &#123;</span><br><span class="line">        <span class="comment">//指令的定义</span></span><br><span class="line">        inserted: <span class="function"><span class="keyword">function</span>(<span class="params">el</span>)</span>&#123;</span><br><span class="line">            el.focus()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在模板中任何元素上使用<code>v-focus</code>属性,例如:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input v-focus&gt;</span><br></pre></td></tr></table></figure>

<h1 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h1><p>一个指令对象可以提供以下几个钩子函数:</p>
<ol>
<li><code>bind</code>: 只调用一次,指令第一次绑定到元素时调用.在这里进行一次性的初始化设置.</li>
<li><code>inserted</code>: 被绑定元素插入到父节点时调用.</li>
<li><code>update</code>: 所在组件的VNode更新时调用,但是可能发生在其子VNode更新之前.指令的值可能发生改变,也可能没有.</li>
<li><code>componentUpdated</code>: 指令所在组件的VNode及其子VNode全部更新后调用.</li>
<li><code>unbind</code>: 只调用一次,指令与元素解绑时调用.</li>
</ol>
<h2 id="钩子函数的参数"><a href="#钩子函数的参数" class="headerlink" title="钩子函数的参数"></a>钩子函数的参数</h2><p>指令钩子会被传入以下参数:</p>
<ul>
<li><code>el</code>: 指令所绑定的元素,可以直接操作DOM.</li>
<li><code>binding</code>: 一个对象,包含以下属性:<ul>
<li><code>name</code>: 指令名,不包括<code>v-</code>前缀.</li>
<li><code>value</code>: 指令的绑定值.例如：<code>v-my-directive=&quot;1 + 1&quot;</code>中，绑定值为2。</li>
<li><code>oldValue</code>: 指令绑定的上一个值.仅在update和componentUpdated钩子中可用.无论值是否改变都可用.</li>
<li><code>expression</code>: 字符串形式的指令表达式.例如 <code>v-my-directive=&quot;1 + 1&quot;</code>中，表达式为 <code>&quot;1 + 1&quot;</code>。</li>
<li><code>arg</code>: 传给指令的参数.可选.例如 <code>v-my-directive:foo</code> 中，参数为 “foo”。</li>
<li><code>modifiers</code>: 一个包含修饰符的对象.例如：<code>v-my-directive.foo.bar</code> 中，修饰符对象为 <code>{ foo: true, bar: true }</code>。</li>
</ul>
</li>
<li><code>vnode</code>: Vue编译生成的虚拟节点.</li>
<li><code>oldVNode</code>: 上一个虚拟节点.</li>
</ul>
<blockquote>
<p>除了 <code>el</code> 之外，其它参数都应该是只读的，切勿进行修改。如果需要在钩子之间共享数据，建议通过元素的 <code>dataset</code> 来进行。</p>
</blockquote>
<p>范例:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//html</span></span><br><span class="line">&lt;div id=<span class="string">"hook-arguments-example"</span> v-demo:foo.a.b=<span class="string">"message"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//js</span></span><br><span class="line">Vue.directive(<span class="string">'demo'</span>, &#123;</span><br><span class="line">  bind: <span class="function"><span class="keyword">function</span> (<span class="params">el, binding, vnode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> s = <span class="built_in">JSON</span>.stringify</span><br><span class="line">    el.innerHTML =</span><br><span class="line">      <span class="string">'name: '</span>       + s(binding.name) + <span class="string">'&lt;br&gt;'</span> +</span><br><span class="line">      <span class="string">'value: '</span>      + s(binding.value) + <span class="string">'&lt;br&gt;'</span> +</span><br><span class="line">      <span class="string">'expression: '</span> + s(binding.expression) + <span class="string">'&lt;br&gt;'</span> +</span><br><span class="line">      <span class="string">'argument: '</span>   + s(binding.arg) + <span class="string">'&lt;br&gt;'</span> +</span><br><span class="line">      <span class="string">'modifiers: '</span>  + s(binding.modifiers) + <span class="string">'&lt;br&gt;'</span> +</span><br><span class="line">      <span class="string">'vnode keys: '</span> + <span class="built_in">Object</span>.keys(vnode).join(<span class="string">', '</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#hook-arguments-example'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    message: <span class="string">'hello!'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="动态指令参数"><a href="#动态指令参数" class="headerlink" title="动态指令参数"></a>动态指令参数</h1><p>在 <code>v-mydirective:[argument]=&quot;value&quot;</code> 中，argument 参数可以根据组件实例数据进行更新！<br>例如创建一个自定义指令,通过固定布局将元素固定在页面上.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"baseexample"</span>&gt;</span><br><span class="line">    &lt;p&gt;Scroll down <span class="keyword">this</span> page&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;p v-pin="200"&gt;Stick me 200px from the top of the page&lt;p&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br></pre></td></tr></table></figure>

<p>自定义事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Vue.directive(<span class="string">'pin'</span>, &#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span>(<span class="params">el, bingding, vnode</span>)</span>&#123;</span><br><span class="line">        el.style.position = <span class="string">'fixed'</span></span><br><span class="line">        el.style.top = binding.value + <span class="string">'px'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#baseexample"</span></span><br><span class="line"><span class="string">&#125;)</span></span><br></pre></td></tr></table></figure>

<p>这会把元素固定在距离页面顶部200px的位置.<br>如果需要将元素固定在左侧呢?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">"dynamicexample"</span>&gt;</span><br><span class="line">    &lt;p&gt;Scroll down <span class="keyword">this</span> page&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">    &lt;p v-pin:[direction]="200"&gt;I am pinned onto the page at 200px to the left.&lt;p&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Vue.directive(<span class="string">'pin'</span>,&#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span>(<span class="params">el, binding, vnode</span>)</span>&#123;</span><br><span class="line">        el.style.position = <span class="string">'fixed'</span></span><br><span class="line">        <span class="keyword">var</span> s = (binding.arg == <span class="string">'left'</span> ? <span class="string">'left'</span> : <span class="string">'top'</span>)</span><br><span class="line">        el.style[s] = binding.value + <span class="string">'px'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#dynamicexample'</span>,</span><br><span class="line">    data: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            direction: <span class="string">'left'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="函数简写"><a href="#函数简写" class="headerlink" title="函数简写"></a>函数简写</h2><p>在很多时候，你可能想在 bind 和 update 时触发相同行为，而不关心其它的钩子。比如这样写:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vue.directive(<span class="string">'color-swatch'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">el, binding</span>) </span>&#123;</span><br><span class="line">  el.style.backgroundColor = binding.value</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="对象字面量"><a href="#对象字面量" class="headerlink" title="对象字面量"></a>对象字面量</h2><p>如果指令需要多个值，可以传入一个 JavaScript 对象字面量。记住，指令函数能够接受所有合法的 JavaScript 表达式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//html</span></span><br><span class="line">&lt;div v-demo=<span class="string">"&#123; color: 'white', text: 'hello!' &#125;"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="comment">//js</span></span><br><span class="line">Vue.directive(<span class="string">'demo'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">el, binding</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(binding.value.color) <span class="comment">// =&gt; "white"</span></span><br><span class="line">  <span class="built_in">console</span>.log(binding.value.text)  <span class="comment">// =&gt; "hello!"</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="渲染函数-amp-JSX"><a href="#渲染函数-amp-JSX" class="headerlink" title="渲染函数&amp;JSX"></a>渲染函数&amp;JSX</h1><p>渲染函数在Vue.js进阶里有讲到,JSX先不看了.</p>
<h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><p>插件用来为Vue添加全局功能.<br>插件常用功能:</p>
<ol>
<li>添加全局方法或属性.</li>
<li>添加全局资源: 指令,过滤器,过渡</li>
<li>通过全局混入来添加一些组件选项.</li>
<li>添加Vue实例方法,通过把他们添加到Vue.prototype上实现.</li>
<li>一个库,提供自己的API,同时提供上面提到的一个或多个功能.如Vue-router</li>
</ol>
<h2 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h2><p>通过全局方法<code>Vue.use()</code>使用插件.需要在<code>new Vue()</code>之前调用.<br>也可以传入一个可选的对象.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vue.use(MyPlugin, &#123; <span class="attr">someOption</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>Vue.use 会自动阻止多次注册相同插件，届时即使多次调用也只会注册一次该插件。</p>
<p>Vue.js 官方提供的一些插件 (例如 vue-router) 在检测到 Vue 是可访问的全局变量时会自动调用 <code>Vue.use()</code>。然而在像 CommonJS 这样的模块环境中，你应该始终显式地调用 <code>Vue.use()</code></p>
<h2 id="开发插件"><a href="#开发插件" class="headerlink" title="开发插件"></a>开发插件</h2><p>Vue.js的插件暴露一个install的方法.这个方法的第一个参数是Vue构造器,第二个参数是可选的选项对象:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MyPlugin.install = <span class="function"><span class="keyword">function</span>(<span class="params">Vue, options</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//1. 添加全局方法或属性</span></span><br><span class="line">    Vue.myGlobalMethod = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//逻辑..</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.添加全局资源</span></span><br><span class="line">    Vue.directive(<span class="string">'my-directive'</span>,&#123;</span><br><span class="line">        bind(el, binding, vnode, oldVnode)&#123;</span><br><span class="line">            <span class="comment">//逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 注入组件选项</span></span><br><span class="line">    Vue.mixin(&#123;</span><br><span class="line">        created: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//逻辑...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 添加实例方法</span></span><br><span class="line">    Vue.prototype.$myMethod = <span class="function"><span class="keyword">function</span>(<span class="params">methodOptions</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//逻辑...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h1><p>过滤器可以用在：双花括号插值和 v-bind 表达式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 在双花括号中 --&gt;</span><br><span class="line">&#123;&#123; message | capitalize &#125;&#125;</span><br><span class="line"></span><br><span class="line">&lt;!-- 在 <span class="string">`v-bind`</span> 中 --&gt;</span><br><span class="line">&lt;div v-bind:id=<span class="string">"rawId | formatId"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>在组件的选项中定义本地的过滤器</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filters: &#123;</span><br><span class="line">  capitalize: <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    value = value.toString()</span><br><span class="line">    <span class="keyword">return</span> value.charAt(<span class="number">0</span>).toUpperCase() + value.slice(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者在创建Vue实例之前全局定义过滤器:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Vue.filter(<span class="string">'capitalize'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!value) <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">  value = value.toString()</span><br><span class="line">  <span class="keyword">return</span> value.charAt(<span class="number">0</span>).toUpperCase() + value.slice(<span class="number">1</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当全局过滤器和局部过滤器重名时，会采用局部过滤器。<br>过滤器可以串联</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; message | filterA | filterB &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>在这个例子中，filterA 被定义为接收单个参数的过滤器函数，表达式 message 的值将作为参数传入到函数中。然后继续调用同样被定义为接收单个参数的过滤器函数 filterB，将 filterA 的结果传递到 filterB 中。</p>
<p>过滤器可以接收参数:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; message | filterA(<span class="string">'arg1'</span>, arg2) &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>这里，filterA 被定义为接收三个参数的过滤器函数。其中 message 的值作为第一个参数，普通字符串 ‘arg1’ 作为第二个参数，表达式 arg2 的值作为第三个参数。</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/vue过渡和动画/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/14/vue过渡和动画/" class="post-title-link" itemprop="url">vue过渡和动画</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-14 12:08:18" itemprop="dateCreated datePublished" datetime="2019-10-14T12:08:18+08:00">2019-10-14</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-25 12:09:29" itemprop="dateModified" datetime="2019-10-25T12:09:29+08:00">2019-10-25</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            
          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/10/微信小程序入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/10/微信小程序入门/" class="post-title-link" itemprop="url">微信小程序入门</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-10 19:22:41" itemprop="dateCreated datePublished" datetime="2019-10-10T19:22:41+08:00">2019-10-10</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-11-06 20:31:15" itemprop="dateModified" datetime="2019-11-06T20:31:15+08:00">2019-11-06</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="小程序的文件结构"><a href="#小程序的文件结构" class="headerlink" title="小程序的文件结构"></a>小程序的文件结构</h1><p><code>app.js</code>: 设置一些项目的全局变量<br><code>app.json</code>: 每一个新页面都必须在这个页面注册<br><code>app.wxss</code>: 项目全局样式<br><code>project.config.json</code>: 项目配置文件</p>
<p>一个页面主要是包含以下四个文件，这四个文件的名字应该都是一样的，最好以页面所在的文件夹名字为标准：<br><code>xxx.wxml</code>: 页面结构<br><code>xxx.wxss</code>: 页面样式<br><code>xxx.json</code>: 页面配置文件<br><code>xxx.js</code>: 页面脚本文件<br>页面可以嵌套,但不能超过5个层级.</p>
<blockquote>
<p>小技巧: 在<code>app.json</code>中的<code>pages</code>里写入新建的路径,<code>Ctrl+R</code>刷新,就会自动创建好以该文件名为基础的4个通用文件.</p>
</blockquote>
<h1 id="设备分辨率和RPX"><a href="#设备分辨率和RPX" class="headerlink" title="设备分辨率和RPX"></a>设备分辨率和RPX</h1><p>pt: 视觉单位.与屏幕的物理尺寸有关系,也叫做逻辑分辨率,与移动端的栅格渲染有关.<br>px: 像素点,物理分辨率.随着屏幕变化不会变化.一般设计稿以px为单位.iphone6的分辨率是375,设计稿一般是750,那么<br>    rpx : px = 2:1.<br>rpx 是响应式像素,可以根据屏幕宽度进行自适应。规定屏幕宽为750rpx.</p>
<p>当需要的元素大小适应屏幕尺寸，就选择rpx作为单位，否则使用px作为单位。</p>
<h1 id="小程序的事件"><a href="#小程序的事件" class="headerlink" title="小程序的事件"></a>小程序的事件</h1><p>冒泡事件: 当一个组件上的事件被触发,该事件会向父节点传递.<br>非冒泡事件: 与之相反,不向父节点传递.</p>
<h2 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h2><p>key以bind或者catch开头,然后跟上事件的类型,如<code>bindtap</code>,<code>catchtouchstart</code>.<br>value是一个字符串,需要在对应的page中定义同名的函数,不然当触发时会报错.<br><strong>区别</strong>: bind事件绑定不会阻止冒泡事件向上冒泡,catch事件绑定可以阻止.</p>
<h2 id="下拉刷新"><a href="#下拉刷新" class="headerlink" title="下拉刷新"></a>下拉刷新</h2><p>监听用户下拉刷新事件</p>
<ol>
<li>在app.json的window选项或者页面配置中开启<code>enablePullDownRefresh</code>.</li>
<li>可以通过<code>wx.startPullDownRefresh</code>触发下拉刷新,调用后触发下拉刷新动画.</li>
<li>当处理完数据刷新后,<code>wx.stopPullDownRefresh</code>可以停止当前页面的下拉刷新.</li>
</ol>
<h2 id="小程序更新数据的值"><a href="#小程序更新数据的值" class="headerlink" title="小程序更新数据的值"></a>小程序更新数据的值</h2><p>函数用于将数据从逻辑层更新到视图层(异步)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.setData(object data, <span class="function"><span class="keyword">function</span> <span class="title">callback</span>)</span></span><br></pre></td></tr></table></figure>

<p><code>data</code>: 传一个object,是这次要改变的数据<br><code>callback</code>: 传一个function,是setData引起页面更新渲染完毕后的回调函数</p>
<p>//赋值的方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.setData(&#123; <span class="attr">arr</span>: <span class="keyword">this</span>.data.arr&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小程序中push方法基本失效.</p>
</blockquote>
<h2 id="改变object中的值"><a href="#改变object中的值" class="headerlink" title="改变object中的值"></a>改变object中的值</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.setData(&#123; <span class="string">"obj.text"</span>: <span class="string">"message2"</span> &#125;)</span><br></pre></td></tr></table></figure>

<h1 id="小程序的路由方式"><a href="#小程序的路由方式" class="headerlink" title="小程序的路由方式"></a>小程序的路由方式</h1><p>打开新页面: <code>wx.navigateTo</code> 或使用组件<code>&lt;navigator open-type=&quot;navigateTo&quot; /&gt;</code><br>页面重定向: <code>wx.redirectTo</code> 或使用组件<code>&lt;navigator open-type=&quot;redirectTo&quot;/&gt;</code><br>压面返回: <code>wx.navigateBack</code> 或使用组件<code>&lt;navigator open-type=&quot;navigateBack&quot;/&gt;</code><br>Tab切换: <code>wx.switchTab</code>或使用组件<code>&lt;navigator open-type=&quot;switchTab&quot;/&gt;</code><br>重启动: <code>wx.reLauch</code>或使用组件<code>&lt;navigator open-type=&quot;reLauch&quot;/&gt;</code></p>
<h1 id="小程序请求接口方式"><a href="#小程序请求接口方式" class="headerlink" title="小程序请求接口方式"></a>小程序请求接口方式</h1><p>HTTPS请求: <code>wx.request</code><br>上传文件: <code>wx.uploadFile</code><br>下载文件: <code>wx.downloadFile</code><br>webSocket通信: <code>wx.connectSocket</code></p>
<h1 id="小程序的生命周期"><a href="#小程序的生命周期" class="headerlink" title="小程序的生命周期"></a>小程序的生命周期</h1><p><code>onLoad</code>: 页面加载时触发.一个页面只会调用一次.可以在<code>onLoad</code>的参数中获取打开当前页面路径中的参数<br><code>onShow</code>: 页面显示/切入前台时触发<br><code>onReady</code>: 页面初次渲染时触发.一个页面只调用一次.<br><code>onHide</code>: 页面隐藏/切入后台时触发.如<code>navigateTo</code>或底部tab切换到其他页面,小程序切入后台.<br><code>onUnload</code>: 页面卸载时触发.如<code>navigateTo</code>或<code>navigateBack</code>时触发.</p>
<h1 id="组件通信"><a href="#组件通信" class="headerlink" title="组件通信"></a>组件通信</h1><p>父传子: <code>properties</code><br>子传父: <code>triggerEvent(&#39;自定义事件名&#39;, {})</code></p>
<h1 id="AppID-小程序ID"><a href="#AppID-小程序ID" class="headerlink" title="AppID(小程序ID)"></a>AppID(小程序ID)</h1><p>也是开发者ID,路径:<br>微信公众平台-小程序-开发-开发设置</p>
<h1 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h1><p>微信小程序采用自有的标签,但是基本和h5标签有对应</p>
<table>
<thead>
<tr>
<th>小程序标签</th>
<th>h5标签</th>
</tr>
</thead>
<tbody><tr>
<td>view</td>
<td>div</td>
</tr>
<tr>
<td>text</td>
<td>span</td>
</tr>
</tbody></table>
<h1 id="数据绑定"><a href="#数据绑定" class="headerlink" title="数据绑定"></a>数据绑定</h1><p>数据绑定采用双大括号语法.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;view&gt;&#123;&#123; message &#125;&#125;&lt;<span class="regexp">/view&gt;</span></span><br></pre></td></tr></table></figure>

<p>数据来自对应<code>Page</code>的data中.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    message: <span class="string">'hello world'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="组件属性-需要在双大括号内"><a href="#组件属性-需要在双大括号内" class="headerlink" title="组件属性(需要在双大括号内)"></a>组件属性(需要在双大括号内)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;view id=<span class="string">"item-&#123;&#123;id&#125;&#125;"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    id: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h1><p><code>wx: if=&quot;&quot;</code><br><code>wx: else=&quot;&quot;</code></p>
<h2 id="wx-if-和hidden"><a href="#wx-if-和hidden" class="headerlink" title="wx: if 和hidden"></a><code>wx: if</code> 和<code>hidden</code></h2><p>类似于<code>v-if</code>和<code>v-show</code>,<code>hidden</code>是始终渲染的,<code>wx: if</code>只有为<code>true</code>才渲染.</p>
<h1 id="列表渲染"><a href="#列表渲染" class="headerlink" title="列表渲染"></a>列表渲染</h1><p><code>wx: for</code><br>在组件上使用 <code>wx:for</code> 控制属性绑定一个数组，即可使用数组中各项的数据重复渲染该组件。<br>默认数组的当前项的下标变量名默认为 <code>index</code>，数组当前项的变量名默认为 <code>item</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;view wx:<span class="keyword">for</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span>&gt;</span><br><span class="line">  &#123;&#123;index&#125;&#125;: &#123;&#123;item.message&#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/view&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    array: [&#123;</span><br><span class="line">      message: <span class="string">'foo'</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      message: <span class="string">'bar'</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>使用 <code>wx:for-item</code> 可以指定数组当前元素的变量名，<br>使用 <code>wx:for-index</code> 可以指定数组当前下标的变量名：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;view wx:<span class="keyword">for</span>=<span class="string">"&#123;&#123;array&#125;&#125;"</span> wx:<span class="keyword">for</span>-index=<span class="string">"idx"</span> wx:<span class="keyword">for</span>-item=<span class="string">"itemName"</span>&gt;</span><br><span class="line">  &#123;&#123;idx&#125;&#125;: &#123;&#123;itemName.message&#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/view&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意: 当 <code>wx:for</code> 的值为字符串时，会将字符串解析成字符串数组.<br>花括号和引号之间如果有空格，将最终被解析成为字符串.</p>
</blockquote>
<h1 id="wx-key"><a href="#wx-key" class="headerlink" title="wx:key"></a><code>wx:key</code></h1><h1 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h1><p>WXML提供模板（template），可以在模板中定义代码片段，然后在不同的地方调用。</p>
<p>##定义模板<br>使用 <code>name</code>属性，作为模板的名字。然后在<code>&lt;template/&gt;</code>内定义代码片段，如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;template name=<span class="string">"msgItem"</span>&gt;</span><br><span class="line">  &lt;view&gt;</span><br><span class="line">    &lt;text&gt; &#123;&#123;index&#125;&#125;: &#123;&#123;msg&#125;&#125; &lt;<span class="regexp">/text&gt;</span></span><br><span class="line"><span class="regexp">    &lt;text&gt; Time: &#123;&#123;time&#125;&#125; &lt;/</span>text&gt;</span><br><span class="line">  &lt;<span class="regexp">/view&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br></pre></td></tr></table></figure>

<h2 id="使用模板"><a href="#使用模板" class="headerlink" title="使用模板"></a>使用模板</h2><p>使用<code>is</code>属性,声明需要的使用模板,然后将模板所需要的data传入,</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;template is=<span class="string">"msgItem"</span> data=<span class="string">"&#123;&#123;..item&#125;&#125;"</span>&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Page(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    item: &#123;</span><br><span class="line">      index: <span class="number">0</span>,</span><br><span class="line">      msg: <span class="string">"this is a template"</span>,</span><br><span class="line">      time: <span class="string">'2019-11-11'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>is</code>属性可以用双大括号,来动态决定渲染哪个模板.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;template name=<span class="string">"odd"</span>&gt;</span><br><span class="line">  &lt;view&gt; odd&lt;<span class="regexp">/view&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line">&lt;template name=<span class="string">"even"</span>&gt;</span><br><span class="line">  &lt;view&gt; even &lt;<span class="regexp">/view&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>template&gt;</span><br><span class="line"></span><br><span class="line">&lt;block wx:<span class="keyword">for</span>=<span class="string">"&#123;&#123;[1,2,3,4,5]&#125;&#125;"</span>&gt;</span><br><span class="line">  &lt;template is=<span class="string">"&#123;&#123;item % 2 == 0 ? 'even' : 'odd'&#125;&#125;"</span>/&gt;</span><br><span class="line">&lt;<span class="regexp">/block&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="模板的作用域"><a href="#模板的作用域" class="headerlink" title="模板的作用域"></a>模板的作用域</h2><p>模板拥有自己的作用域，只能使用 <code>data</code> 传入的数据以及模板定义文件中定义的 <code>&lt;wxs /&gt;</code> 模块。</p>
<h1 id="WXS语法-WeiXin-Script"><a href="#WXS语法-WeiXin-Script" class="headerlink" title="WXS语法(WeiXin Script)"></a><code>WXS</code>语法(<code>WeiXin Script</code>)</h1><ol>
<li>WXS 不依赖于运行时的基础库版本，可以在所有版本的小程序中运行。</li>
<li>WXS 与 JavaScript 是不同的语言，有自己的语法，并不和 JavaScript 一致。</li>
<li>WXS 的运行环境和其他 JavaScript 代码是隔离的，WXS 中不能调用其他 JavaScript 文件中定义的函数，也不能调用小程序提供的API。</li>
<li>WXS 函数不能作为组件的事件回调。</li>
<li>由于运行环境的差异，在 iOS 设备上小程序内的 WXS 会比 JavaScript 代码快 2 ~ 20 倍。在 android 设备上二者运行效率无差异</li>
</ol>
<h1 id="封装小程序wx-request"><a href="#封装小程序wx-request" class="headerlink" title="封装小程序wx.request"></a>封装小程序wx.request</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 官方例子</span></span><br><span class="line">wx.request(&#123;</span><br><span class="line">  url: <span class="string">'test.php'</span>, <span class="comment">//仅为示例，并非真实的接口地址</span></span><br><span class="line">  data: &#123;</span><br><span class="line">     x: <span class="string">''</span> ,</span><br><span class="line">     y: <span class="string">''</span></span><br><span class="line">  &#125;,</span><br><span class="line">  header: &#123;</span><br><span class="line">      <span class="string">'content-type'</span>: <span class="string">'application/json'</span> <span class="comment">// 默认值</span></span><br><span class="line">  &#125;,</span><br><span class="line">  success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res.data)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>Promsie封装</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> baseUrl = <span class="string">'https://api.it120.cc'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> http = <span class="function">(<span class="params">&#123; url = <span class="string">''</span>, param = &#123;&#125;, ...other &#125; = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    wx.showLoading(&#123;</span><br><span class="line">        title: <span class="string">'请求中，请耐心等待..'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">let</span> timeStart = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        wx.request(&#123;</span><br><span class="line">            url: getUrl(url),</span><br><span class="line">            data: param,</span><br><span class="line">            header: &#123;</span><br><span class="line">                <span class="string">'content-type'</span>: <span class="string">'application/json'</span> <span class="comment">// 默认值 ,另一种是 "content-type": "application/x-www-form-urlencoded"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            ...other,</span><br><span class="line">            complete: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                wx.hideLoading();</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">`耗时<span class="subst">$&#123;<span class="built_in">Date</span>.now() - timeStart&#125;</span>`</span>);</span><br><span class="line">                <span class="keyword">if</span> (res.statusCode &gt;= <span class="number">200</span> &amp;&amp; res.statusCode &lt; <span class="number">300</span>) &#123;</span><br><span class="line">                    resolve(res.data)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    reject(res)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUrl = <span class="function">(<span class="params">url</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (url.indexOf(<span class="string">'://'</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        url = baseUrl + url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> url</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get方法</span></span><br><span class="line"><span class="keyword">const</span> _get = <span class="function">(<span class="params">url, param = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> http(&#123;</span><br><span class="line">        url,</span><br><span class="line">        param</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _post = <span class="function">(<span class="params">url, param = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> http(&#123;</span><br><span class="line">        url,</span><br><span class="line">        param,</span><br><span class="line">        method: <span class="string">'post'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _put = <span class="function">(<span class="params">url, param = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> http(&#123;</span><br><span class="line">        url,</span><br><span class="line">        param,</span><br><span class="line">        method: <span class="string">'put'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> _delete = <span class="function">(<span class="params">url, param = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> http(&#123;</span><br><span class="line">        url,</span><br><span class="line">        param,</span><br><span class="line">        method: <span class="string">'put'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    baseUrl,</span><br><span class="line">    _get,</span><br><span class="line">    _post,</span><br><span class="line">    _put,</span><br><span class="line">    _delete</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> api = <span class="built_in">require</span>(<span class="string">'../../utils/api.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单个请求</span></span><br><span class="line">api.get(<span class="string">'list'</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个页面多个请求</span></span><br><span class="line"><span class="built_in">Promise</span>.all([</span><br><span class="line">  api.get(<span class="string">'list'</span>),</span><br><span class="line">  api.get(<span class="string">`detail/<span class="subst">$&#123;id&#125;</span>`</span>)</span><br><span class="line">]).then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(result)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>登录</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.js</span></span><br><span class="line">App(&#123;</span><br><span class="line">  onLaunch: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'App onLaunch'</span>);</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">//  获取商城名称</span></span><br><span class="line">    wx.request(&#123;</span><br><span class="line">      url: <span class="string">'https://api.it120.cc/'</span>+ that.globalData.subDomain +<span class="string">'/config/get-value'</span>,</span><br><span class="line">      data: &#123;</span><br><span class="line">        key: <span class="string">'mallName'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        wx.setStorageSync(<span class="string">'mallName'</span>, res.data.data.value);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.login();</span><br><span class="line">    <span class="keyword">this</span>.getUserInfo();</span><br><span class="line">  &#125;,</span><br><span class="line">  login : <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">var</span> token = that.globalData.token;</span><br><span class="line">    <span class="comment">// 如果有token</span></span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      <span class="comment">// 检查token是否有效</span></span><br><span class="line">      wx.request(&#123;</span><br><span class="line">        url: <span class="string">'https://api.it120.cc/'</span> + that.globalData.subDomain + <span class="string">'/user/check-token'</span>,</span><br><span class="line">        data: &#123;</span><br><span class="line">          token: token</span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">          <span class="comment">// 如果token失效了</span></span><br><span class="line">          <span class="keyword">if</span> (res.data.code != <span class="number">0</span>) &#123;</span><br><span class="line">            that.globalData.token = <span class="literal">null</span>;</span><br><span class="line">            that.login(); <span class="comment">// 重新登陆</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 【1】调用微信自带登陆</span></span><br><span class="line">    wx.login(&#123;</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 【2】 拿到code去访问我们的后台换取其他信息</span></span><br><span class="line">        wx.request(&#123;</span><br><span class="line">          url: <span class="string">'https://api.it120.cc/'</span>+ that.globalData.subDomain +<span class="string">'/user/wxapp/login'</span>,</span><br><span class="line">          data: &#123;</span><br><span class="line">            code: res.code</span><br><span class="line">          &#125;,</span><br><span class="line">          success: <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 如果说这个code失效的</span></span><br><span class="line">            <span class="keyword">if</span> (res.data.code == <span class="number">10000</span>) &#123;</span><br><span class="line">              <span class="comment">// 去注册</span></span><br><span class="line">              that.registerUser();</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果返回失败了</span></span><br><span class="line">            <span class="keyword">if</span> (res.data.code != <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// 登录错误 </span></span><br><span class="line">              wx.hideLoading();</span><br><span class="line">              <span class="comment">// 提示无法登陆</span></span><br><span class="line">              wx.showModal(&#123;</span><br><span class="line">                title: <span class="string">'提示'</span>,</span><br><span class="line">                content: <span class="string">'无法登录，请重试'</span>,</span><br><span class="line">                showCancel:<span class="literal">false</span></span><br><span class="line">              &#125;)</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 【3】 如果成功后设置token到本地</span></span><br><span class="line">            that.globalData.token = res.data.data.token;</span><br><span class="line">            <span class="comment">// 保存用户信息</span></span><br><span class="line">            wx.setStorage(&#123;</span><br><span class="line">              key: <span class="string">'token'</span>,</span><br><span class="line">              data:  res.data.data.token</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 注册？？ [这个看需求]</span></span><br><span class="line">  registerUser: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">    wx.login(&#123;</span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> code = res.code; <span class="comment">// 微信登录接口返回的 code 参数，下面注册接口需要用到</span></span><br><span class="line">        wx.getUserInfo(&#123;</span><br><span class="line">          success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> iv = res.iv;</span><br><span class="line">            <span class="keyword">var</span> encryptedData = res.encryptedData;</span><br><span class="line">            <span class="comment">// 下面开始调用注册接口</span></span><br><span class="line">            wx.request(&#123;</span><br><span class="line">              url: <span class="string">'https://api.it120.cc/'</span> + that.globalData.subDomain +<span class="string">'/user/wxapp/register/complex'</span>,</span><br><span class="line">              data: &#123;<span class="attr">code</span>:code,<span class="attr">encryptedData</span>:encryptedData,<span class="attr">iv</span>:iv&#125;, <span class="comment">// 设置请求的 参数</span></span><br><span class="line">              success: <span class="function">(<span class="params">res</span>) =&gt;</span>&#123;</span><br><span class="line">                wx.hideLoading();</span><br><span class="line">                that.login();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 获取用户信息</span></span><br><span class="line">  getUserInfo:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.getUserInfo(&#123;</span><br><span class="line">      success:<span class="function">(<span class="params">data</span>) =&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.globalData.userInfo = data.userInfo;</span><br><span class="line">        wx.setStorage(&#123;</span><br><span class="line">          key: <span class="string">'userInfo'</span>,</span><br><span class="line">          data:  data.userInfo</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.globalData.userInfo;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  globalData:&#123;</span><br><span class="line">    userInfo:<span class="literal">null</span>,</span><br><span class="line">    subDomain:<span class="string">"34vu54u7vuiuvc546d"</span>,</span><br><span class="line">    token: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><strong>授权</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">getUserInfo: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先调用wx.getSetting 获取用户权限设置</span></span><br><span class="line">  wx.getSetting(&#123;</span><br><span class="line">    success(res) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'1'</span>);</span><br><span class="line">      <span class="keyword">if</span> (!res.authSetting[<span class="string">'scope.userInfo'</span>]) &#123;</span><br><span class="line">        wx.authorize(&#123;</span><br><span class="line">          scope: <span class="string">'scope.userInfo'</span>,</span><br><span class="line">          success() &#123;</span><br><span class="line">            <span class="comment">// 用户已经同意小程序使用录音功能，后续调用 wx.getUserInfo接口不会弹窗询问</span></span><br><span class="line">            wx.getUserInfo(&#123;</span><br><span class="line">              success: <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.globalData.userInfo = data.userInfo;</span><br><span class="line">                wx.setStorage(&#123;</span><br><span class="line">                  key: <span class="string">'userInfo'</span>,</span><br><span class="line">                  data: data.userInfo</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.globalData.userInfo;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h1 id="小程序的双向绑定和vue哪里不一样"><a href="#小程序的双向绑定和vue哪里不一样" class="headerlink" title="小程序的双向绑定和vue哪里不一样"></a>小程序的双向绑定和vue哪里不一样</h1><p>小程序直接<code>this.data</code>的属性不可以直接同步到视图,必须调用<code>this.data</code></p>
<h1 id="哪些方法可以用来提高微信小程序的应用速度"><a href="#哪些方法可以用来提高微信小程序的应用速度" class="headerlink" title="哪些方法可以用来提高微信小程序的应用速度"></a>哪些方法可以用来提高微信小程序的应用速度</h1><ol>
<li>提高页面加载速度</li>
<li>用户行为预测</li>
<li>减少默认 data 的大小</li>
<li>组件化方案</li>
</ol>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/09/移动端适配/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zax Tseng">
      <meta itemprop="description" content="Zax's BLOG">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zax's BLOG">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
              
              <a href="/2019/10/09/移动端适配/" class="post-title-link" itemprop="url">移动端适配</a>
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-10-09 21:30:02" itemprop="dateCreated datePublished" datetime="2019-10-09T21:30:02+08:00">2019-10-09</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-10-22 18:19:38" itemprop="dateModified" datetime="2019-10-22T18:19:38+08:00">2019-10-22</time>
              </span>
            
          

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h1 id="媒体查询media-query"><a href="#媒体查询media-query" class="headerlink" title="媒体查询media-query"></a>媒体查询media-query</h1><p>当媒体查询为true时，相关的样式表或样式规则会按照正常的级联规被应用。 当媒体查询返回false， 标签上带有媒体查询的样式表仍将被下载 （只不过不会被应用）。</p>
<p>包含了一个媒体类型和至少一个使用宽度、高度和颜色等媒体属性来限制样式表范围的表达式。CSS3加入的媒体查询使得无需修改内容便可以使样式应用于某些特定的设备范围。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt; </span><br><span class="line">@media (min-width: <span class="number">700</span>px) and (orientation: landscape)&#123; </span><br><span class="line">    .sidebar &#123; </span><br><span class="line">        display: none; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&lt;<span class="regexp">/style&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="视口iewport"><a href="#视口iewport" class="headerlink" title="视口iewport"></a>视口iewport</h1><p> 为什么要设置 viewport<br>viewport 的设置不会对 PC 页面产生影响，但对于移动页面却很重要。下面我们举例来说明：</p>
<ol>
<li>媒体查询 @media响应式布局中，会根据媒体查询功能来适配多端布局，必须对 viewport 进行设置，否则根据查询到的尺寸无法正确匹配视觉宽度而导致布局混乱。如不设置 viewport 参数，多说移动端媒体查询的结果将是 980px 这个节点布局的参数，而非我们通常设置的 768px 范围内的这个布局参数</li>
<li>由于目前多数手机的 dpr 都不再是 1，为了产出高保真页面，我们一般会给出 750px 的设计稿，那么就需要通过设置 viewport 的参数来进行整体换算，而不是在每次设置尺寸时进行长度的换算。</li>
</ol>
<h2 id="viewport-详解"><a href="#viewport-详解" class="headerlink" title="viewport 详解"></a>viewport 详解</h2><p>在移动端有三种类型的 viewport: layoutviewport、visualviewport、idealviewport。具体解释如下：</p>
<p><code>layoutviewport</code>:  大于实际屏幕， 元素的宽度继承于 layoutviewport，用于保证网站的外观特性与桌面浏览器一样。layoutviewport 到底多宽，每个浏览器不同。iPhone 的 safari 为 980px，通过 document.documentElement.clientWidth 获取。<br><code>visualviewport</code>: 当前显示在屏幕上的页面，即浏览器可视区域的宽度。<br><code>idealviewport</code>: 为浏览器定义的可完美适配移动端的理想 viewport，固定不变，可以认为是设备视口宽度。比如 iphone 7 为 375px, iphone 7p 为 414px。</p>
<h2 id="viewport设置"><a href="#viewport设置" class="headerlink" title="viewport设置"></a>viewport设置</h2><p><code>&lt;meta name=&#39;viewport&#39; content=&#39;width=device-width,initial-scale=1,user-scalable=no&#39;/&gt;</code><br>通过对meta标签三个viewport的设置，最终使页面完美展示。</p>
<ol>
<li>width 设置的是 layoutviewport 的宽度</li>
<li>initial-scale 设置页面的初始缩放值，并且这个初始缩放值是相对于 idealviewport 缩放的，最终得到的结果不仅会决定 visualviewport，还会影响到 layoutviewport</li>
<li>user-scalable 是否允许用户进行缩放的设置</li>
</ol>
<blockquote>
<p>只要 layoutviewport === visualviewport，页面下面不会出现滚动条，默认只是把页面放大或缩小。</p>
</blockquote>
<h2 id="设备像素比-dpr-与-1px-物理像素"><a href="#设备像素比-dpr-与-1px-物理像素" class="headerlink" title="设备像素比 dpr 与 1px 物理像素"></a>设备像素比 dpr 与 1px 物理像素</h2><h4 id="物理像素（physical-pixel）"><a href="#物理像素（physical-pixel）" class="headerlink" title="物理像素（physical pixel）"></a>物理像素（physical pixel）</h4><p>手机屏幕上显示的最小单元，该最小单元具有颜色及亮度的属性可供设置，iphone6、7、8 为：750 * 1334，iphone6+、7+、8+ 为 1242 * 2208</p>
<h4 id="设备独立像素（density-indenpendent-pixel）"><a href="#设备独立像素（density-indenpendent-pixel）" class="headerlink" title="设备独立像素（density-indenpendent pixel）"></a>设备独立像素（density-indenpendent pixel）</h4><p>此为逻辑像素，计算机设备中的一个点，css 中设置的像素指的就是该像素。老早在没有 retina 屏之前，设备独立像素与物理像素是相等的。</p>
<h4 id="设备像素比（device-pixel-ratio）"><a href="#设备像素比（device-pixel-ratio）" class="headerlink" title="设备像素比（device pixel ratio）"></a>设备像素比（device pixel ratio）</h4><p>设备像素比(dpr) = 物理像素/设备独立像素。如 iphone 6、7、8 的 dpr 为 2，那么一个设备独立像素便为 4 个物理像素，因此在 css 上设置的 1px 在其屏幕上占据的是 2个物理像素，0.5px 对应的才是其所能展示的最小单位。这就是 1px 在 retina 屏上变粗的原因，目前有很多办法来解决这一问题。</p>
<h4 id="1px的物理像素的解决方案"><a href="#1px的物理像素的解决方案" class="headerlink" title="1px的物理像素的解决方案"></a>1px的物理像素的解决方案</h4><p>从第一部分的讨论可知 viewport 的 initial-scale 具有缩放页面的效果。对于 dpr=2 的屏幕，1px压缩一半便可与1px的设备像素比匹配，这就可以通过将缩放比 initial-scale 设置为 0.5=1/2 而实现。以此类推 dpr=3的屏幕可以将 initial-scale设置为 0.33=1/3 来实现。</p>
<h1 id="设备像素比-dpr-与-rem-的适配方案"><a href="#设备像素比-dpr-与-rem-的适配方案" class="headerlink" title="设备像素比 dpr 与 rem 的适配方案"></a>设备像素比 dpr 与 rem 的适配方案</h1><p>rem 是相对于根元素 html 的 font-size 来做计算。通常在页面初始化时加载时通过对document.documentElement.style.fontSize 设置来实现。</p>
<h4 id="rem适配规则"><a href="#rem适配规则" class="headerlink" title="rem适配规则"></a>rem适配规则</h4><p>通过对 initial-scale = 1/dpr 的设置，已将对屏幕的描述从物理像素转化到了物理像素上了，这将是后续推导的基础，且设计稿为 750px。</p>
<p>物理像素为 750 = 375 * 2，若屏幕等分为 10 份，那么 1rem = 75px，10rem = 750px;<br>物理像素为 1125 = 375 * 3，若屏幕等分为 10 份，那么 1rem = 112.5px, 10rem = 1125px;<br>物理像素为 1242 = 414 * 3, 若屏幕等分为 10 份，那么 1rem = 124.2px, 10rem = 1242px;</p>
<p>同时为了书写方便可以直接通过 px 布局，然后在打包时利用 pxtorem 库转化为基于 rem 的布局。</p>
<h1 id="视口单位-vw-vh-适配方案"><a href="#视口单位-vw-vh-适配方案" class="headerlink" title="视口单位(vw,vh)适配方案"></a>视口单位(vw,vh)适配方案</h1><p>将视口宽度 window.innerWidth 和视口高度 window.innerHeight 等分为 100 份，且将这里的视口理解成 idealviewport 更为贴切，并不会随着 viewport 的不同设置而改变。</p>
<p>vw : 1vw 为视口宽度的 1%<br>vh : 1vh 为视口高度的 1%<br>vmin :  vw 和 vh 中的较小值<br>vmax : 选取 vw 和 vh 中的较大值</p>
<p>如果设计稿为 750px，那么 1vw = 7.5px，100vw = 750px。其实设计稿按照设么都没多大关系，最终转化过来的都是相对单位，上面讲的 rem 也是对它的模拟。这里的比例关系也推荐不要自己换算，使用 pxtoviewport 的库就可以帮我们转换。当然每种方案都会有其弊端，这里就不展开讨论。</p>

          
        
      
    </div>

    
    
    
      <footer class="post-footer">
          <div class="post-eof"></div>
        
      </footer>
  </div>
  
  
  
  </article>

    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zax Tseng</p>
  <div class="site-description motion-element" itemprop="description">Zax's BLOG</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">46</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>



        </div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zax Tseng</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.3.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

<script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>


  <script src="/js/schemes/muse.js?v=7.3.0"></script>


<script src="/js/next-boot.js?v=7.3.0"></script>




  




























  

  

  


  
</body>
</html>
