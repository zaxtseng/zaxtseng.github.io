<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="ZAX">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="ZAX">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zax Tseng">
<meta property="article:tag" content="javascript, React, Vue, HTML5">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ZAX</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ZAX</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zax Tseng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">103</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/05/Node/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/05/Node/" class="post-title-link" itemprop="url">Node</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-05 15:08:16" itemprop="dateCreated datePublished" datetime="2022-11-05T15:08:16+08:00">2022-11-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:22" itemprop="dateModified" datetime="2022-11-08T08:54:22+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>根据 Node.js 官网的定义：Node.js 是一个基于 Chrome V8 引擎的 JavaScript 运行环境。 Node.js 使用了一个事件驱动、非阻塞式 I&#x2F;O 的模型，使其轻量又高效。</p>
<p>Node.js 是基于 Chrome V8 引擎构建的.由事件循环分发 I&#x2F;O 任务,最终工作线程将任务丢进线程池中去执行,而事件循环只要等待执行结果就可以了.</p>
<h1 id="异步-IO"><a href="#异步-IO" class="headerlink" title="异步 IO"></a>异步 IO</h1><p>重复调用 IO 操作,判断是否完成,称为轮询.包括<code>read</code>,<code>select</code>,<code>poll</code>,<code>kqueue</code>,<code>event ports</code>.<br>期望实现无须主动判断的非阻塞 I&#x2F;O.</p>
<h2 id="异步-IO-优点"><a href="#异步-IO-优点" class="headerlink" title="异步 IO 优点"></a>异步 IO 优点</h2><ul>
<li>前端通过异步 IO 可以消除阻塞。</li>
<li>请求耗时少，假如有两个请求 A 和 B，那么异步 IO 用时为：Max（A+B）。同步则为 A+B，请求越多差距越大。</li>
<li>IO 是昂贵的，分布式 IO 是更昂贵的。</li>
<li>Node.js 适用于 IO 密集型，而不适用于 CPU 密集型。</li>
<li>并不是所有都用异步任务好，遵循一个公式： s&#x3D; (Ws+Wp)&#x2F;(Ws+Wp&#x2F;p) Ws 表示同步任务，Wp 表示异步任务，p 表示处理器的数量。</li>
</ul>
<h2 id="异步-IO-实现"><a href="#异步-IO-实现" class="headerlink" title="异步 IO 实现"></a>异步 IO 实现</h2><ul>
<li>应用程序先将 JS 代码经 V8 转换为机器码。</li>
<li>通过 Node.js Bindings 层，向操作系统 Libuv 的事件队列中添加一个任务。</li>
<li>Libuv 将事件推送到线程池中执行。</li>
<li>线程池执行完事件，返回数据给 Libuv。</li>
<li>Libuv 将返回结果通过 Node.js Bindings 返回给 V8。</li>
<li>V8 再将结果返回给应用程序。</li>
</ul>
<h2 id="libuv"><a href="#libuv" class="headerlink" title="libuv"></a>libuv</h2><p>多种异步 IO 实现的抽象封装层.<br>libuv 实现了 Node.js 中 Eventloop,主要分为以下几个阶段:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   ┌───────────────────────────┐</span><br><span class="line">┌─&gt;│           timers          │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │     pending callbacks     │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │       idle, prepare       │</span><br><span class="line">│  └─────────────┬─────────────┘      ┌───────────────┐</span><br><span class="line">│  ┌─────────────┴─────────────┐      │   <span class="attr">incoming</span>:   │</span><br><span class="line">│  │           poll            │&lt;─────┤  connections, │</span><br><span class="line">│  └─────────────┬─────────────┘      │   data, etc.  │</span><br><span class="line">│  ┌─────────────┴─────────────┐      └───────────────┘</span><br><span class="line">│  │           check           │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">└──┤      close callbacks      │</span><br><span class="line">   └───────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>上图中每一个阶段都有一个先进先出的回调队列，只有当队列内的事件执行完成之后，才会进入下一个阶段。</p>
<ul>
<li>timers：执行 <code>setTimeout</code> 和 <code>setInterval</code> 中到期的 callback。</li>
<li>pending callbacks：上一轮循环中有少数的 I&#x2F;O callback 会被延迟到这一轮的这一阶段执行。<ul>
<li>执行一些系统操作的回调，例如 tcp 连接发生错误。</li>
</ul>
</li>
<li>idle, prepare：仅内部使用。</li>
<li>poll：最为重要的阶段，执行 I&#x2F;O callback(node 异步 api 的回调，事件订阅回调等)，在适当的条件下会阻塞在这个阶段。<ul>
<li>如果 poll 队列不为空，直接执行队列内的事件，直到队列清空。</li>
<li>如果 poll 队列为空。<ul>
<li>如果有设置 <code>setImmediate</code>，则直接进入 check 阶段。</li>
<li>如果没有设置 <code>setImmediate</code>，则会检查是否有 timers 事件到期。<ul>
<li>如果有 timers 事件到期，则执行 timers 阶段。</li>
<li>如果没有 timers 事件到期，则会阻塞在当前阶段，等待事件加入。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>check：执行 <code>setImmediate</code> 的 callback。</li>
<li>close callbacks：执行 close 事件的 callback，例如 <code>socket.on(&quot;close&quot;,func)</code>。</li>
</ul>
<p><strong>除此之外，Node.js 提供了 process.nextTick(微任务，promise 也一样) 方法，在以上的任意阶段开始执行的时候都会触发。</strong></p>
<blockquote>
<ul>
<li>Event Loop 是一个很重要的概念，指的是计算机系统的一种运行机制。</li>
<li>Libuv 在 Linux 下基于 Custom Threadpool 实现。</li>
<li>Libuv 在 Windows 下基于 IOCP 实现。</li>
</ul>
</blockquote>
<h2 id="常见的异步-IO-使用方式"><a href="#常见的异步-IO-使用方式" class="headerlink" title="常见的异步 IO 使用方式"></a>常见的异步 IO 使用方式</h2><ul>
<li>使用 step，q，async 等异步控制库。</li>
<li>使用 Promise 处理异步。</li>
<li>使用 EventEmitter，实现“发布&#x2F;订阅”模式处理异步。</li>
<li>Node.js 暂不支持协程，可使用 Generator 代替。</li>
<li>终极解决方案：async、await。</li>
</ul>
<h1 id="事件驱动架构"><a href="#事件驱动架构" class="headerlink" title="事件驱动架构"></a>事件驱动架构</h1><h1 id="commonjs-模块"><a href="#commonjs-模块" class="headerlink" title="commonjs 模块"></a>commonjs 模块</h1><h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><ul>
<li>引入模块：require(“.&#x2F;index.js”)</li>
<li>导出模块：module.exports&#x3D;{…} 或者 exports.key&#x3D;{}<ul>
<li>注意：exports 为 module.exports 的引用，不可使用 exports 直接赋值，模块无法导出，eg：exports&#x3D;{}</li>
</ul>
</li>
<li>缓存：require 值会缓存，通过 require 引用文件时，会将文件执行一遍后，将结果通过浅克隆的方式，写入全局内存，后续 require 该路径，直接从内存获取，无需重新执行文件</li>
<li>值拷贝：模块输出是值的拷贝，一但输出，模块内部变化后，无法影响之前的引用，而 ESModule 是引用拷贝。commonJS 运行时加载，ESModule 编译阶段引用<ul>
<li>CommonJS 在引入时是加载整个模块，生成一个对象，然后再从这个生成的对象上读取方法和属性</li>
<li>ESModule 不是对象，而是通过 export 暴露出要输出的代码块，在 import 时使用静态命令的方法引用制定的输出代码块，并在 import 语句处执行这个要输出的代码，而不是直接加载整个模块<blockquote>
<p>面试题：为何直接使用 exports 导出 commonjs 模块，eg：exports &#x3D; “hello”<br>解析：commonjs 模块是通过 module.exports 导出模块，exports 为 module.exports 的引用，使用 exports 直接赋值导出模块，只会改变 exports 的引用不会导出 commonjs 模块。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cjs正确导出用法</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">key</span> = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="comment">//错误导出</span></span><br><span class="line"><span class="built_in">exports</span> = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//无法输出</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//解析：</span></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">key</span>: &#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line">obj.<span class="property">key</span> = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//可改变obj</span></span><br><span class="line"><span class="keyword">const</span> key = obj.<span class="property">key</span>;</span><br><span class="line">key.<span class="property">key1</span> = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//可改变obj</span></span><br><span class="line">key = <span class="string">&quot;hello world&quot;</span>; <span class="comment">//无法改变obj，改变了key的引用</span></span><br></pre></td></tr></table></figure>

<h2 id="module-属性"><a href="#module-属性" class="headerlink" title="module 属性"></a>module 属性</h2><ul>
<li>任意 js 文件就是一个模块.可以直接使用 module 属性.</li>
<li>id: 返回模块标识符,一般是一个绝对路径</li>
<li>filename: 返回绝对路径</li>
<li>loaded: 返回布尔值,表示模块是否加载完成</li>
<li>parent: 返回对象存放调用当前模块的模块</li>
<li>children: 返回数组,存放当前模块调用的其他模块</li>
<li>exports;返回当前模块需要暴露的内容</li>
<li>paths: 返回数组,存放不同目录下的 node_modules 位置</li>
</ul>
<h2 id="原理实现"><a href="#原理实现" class="headerlink" title="原理实现"></a>原理实现</h2><p>使用 fs、vm、path 内置模块，以及函数包裹形式实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * commonjs的require函数：引入module</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; filename module的名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">customRequire</span>(<span class="params">filename</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> pathToFile = path.<span class="title function_">resolve</span>(__dirname, filename);</span><br><span class="line">  <span class="keyword">const</span> content = fs.<span class="title function_">readFileSync</span>(pathToFile, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">  <span class="comment">//使用函数包裹模块，执行函数</span></span><br><span class="line">  <span class="comment">//注入形参：require、module、exports、__dirname、__filename</span></span><br><span class="line">  <span class="keyword">const</span> wrapper = [</span><br><span class="line">    <span class="string">&quot;(function(require, module, exports, __dirname, __filename)&#123;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&#125;)&quot;</span>,</span><br><span class="line">  ];</span><br><span class="line">  <span class="keyword">const</span> wrappedContent = wrapper[<span class="number">0</span>] + content + wrapper[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(wrappedContent, &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">module</span> = &#123;</span><br><span class="line">    <span class="attr">exports</span>: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">//转换为函数，类似eval，(funcion(require, module, exports)&#123; xxx &#125;)</span></span><br><span class="line">  <span class="keyword">const</span> result = script.<span class="title function_">runInThisContext</span>();</span><br><span class="line">  <span class="comment">//函数执行，引入模块，若内部有require继续递归</span></span><br><span class="line">  <span class="comment">//exports为module.exports的引用</span></span><br><span class="line">  <span class="title function_">result</span>(customRequire, <span class="variable language_">module</span>, <span class="variable language_">module</span>.<span class="property">exports</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">global</span>.<span class="property">customRequire</span> = customRequire;</span><br></pre></td></tr></table></figure>

<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><ul>
<li>源码路径：&#x2F;lib&#x2F;internal&#x2F;modules&#x2F;cjs&#x2F;</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//loader.js</span></span><br><span class="line"><span class="comment">//require函数定义</span></span><br><span class="line"><span class="number">1</span>、<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">require</span>：调用__load函数</span><br><span class="line"><span class="number">2</span>、<span class="title class_">Module</span>.<span class="property">__load</span>：_cache处理，调用load函数</span><br><span class="line"><span class="number">3</span>、<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">load</span>函数：调用<span class="title class_">Module</span>.<span class="property">_extensions</span>[extension](<span class="variable language_">this</span>, filename);</span><br><span class="line"><span class="comment">//不同的后缀通过定义不同的函数指定解析规则：以Module._extensions[&#x27;.js&#x27;]为例</span></span><br><span class="line"><span class="number">4</span>、<span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&#x27;.js&#x27;</span>] = <span class="keyword">function</span>(<span class="params"><span class="variable language_">module</span>, filename</span>) &#123;</span><br><span class="line">  <span class="comment">//读取缓存或者通过readFileSync读取内容</span></span><br><span class="line">  <span class="keyword">if</span> (cached?.<span class="property">source</span>) &#123;</span><br><span class="line">    content = cached.<span class="property">source</span>;</span><br><span class="line">    cached.<span class="property">source</span> = <span class="literal">undefined</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    content = fs.<span class="title function_">readFileSync</span>(filename, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">//调用compile解析</span></span><br><span class="line">  <span class="variable language_">module</span>.<span class="title function_">_compile</span>(content, filename);</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">5</span>、<span class="title class_">Module</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_compile</span> = <span class="keyword">function</span>(<span class="params">content, filename</span>)&#123;</span><br><span class="line">  <span class="comment">//生成包裹函数：warpSafe获取函数字符串并使用vm执行生成执行函数</span></span><br><span class="line">  <span class="keyword">const</span> compiledWrapper = <span class="title function_">wrapSafe</span>(filename, content, <span class="variable language_">this</span>);</span><br><span class="line">  <span class="comment">//执行函数</span></span><br><span class="line">  <span class="keyword">const</span> <span class="built_in">exports</span> = <span class="variable language_">this</span>.<span class="property">exports</span>;</span><br><span class="line">  <span class="keyword">const</span> thisValue = <span class="built_in">exports</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (inspectorWrapper) &#123;</span><br><span class="line">    result = <span class="title function_">inspectorWrapper</span>(compiledWrapper, thisValue, <span class="built_in">exports</span>,</span><br><span class="line">                              <span class="built_in">require</span>, <span class="variable language_">module</span>, filename, dirname);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//静态方法Reflect.apply(target, thisArgument, argumentsList)</span></span><br><span class="line">    <span class="comment">//通过指定的参数列表发起对目标(target)函数的调用</span></span><br><span class="line">    result = <span class="title class_">ReflectApply</span>(compiledWrapper, thisValue,</span><br><span class="line">                          [<span class="built_in">exports</span>, <span class="built_in">require</span>, <span class="variable language_">module</span>, filename, dirname]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">6</span>、<span class="keyword">function</span> <span class="title function_">wrapSafe</span>(<span class="params">filename, content, cjsModuleInstance</span>) &#123;</span><br><span class="line">    <span class="comment">/* 生成包裹函数字符：</span></span><br><span class="line"><span class="comment">    let wrap = function(script) &#123;</span></span><br><span class="line"><span class="comment">       return Module.wrapper[0] + script + Module.wrapper[1];</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    const wrapper = [</span></span><br><span class="line"><span class="comment">      &#x27;(function (exports, require, module, __filename, __dirname) &#123; &#x27;,</span></span><br><span class="line"><span class="comment">      &#x27;\n&#125;);&#x27;,</span></span><br><span class="line"><span class="comment">    ]；*/</span></span><br><span class="line">  	<span class="keyword">const</span> wrapper = <span class="title class_">Module</span>.<span class="title function_">wrap</span>(content);</span><br><span class="line">    <span class="comment">//获取包裹函数</span></span><br><span class="line">    <span class="keyword">return</span> vm.<span class="title function_">runInThisContext</span>(wrapper, &#123;</span><br><span class="line">      filename,</span><br><span class="line">      <span class="attr">lineOffset</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">displayErrors</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">importModuleDynamically</span>: <span class="keyword">async</span> (specifier) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> loader = asyncESM.<span class="property">ESMLoader</span>;</span><br><span class="line">        <span class="keyword">return</span> loader.<span class="title function_">import</span>(specifier, <span class="title function_">normalizeReferrerURL</span>(filename));</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Module</span> = <span class="built_in">require</span>(<span class="string">&quot;module&quot;</span>);</span><br><span class="line"><span class="comment">//后缀解析扩展：.test后缀同.js后缀</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.test&quot;</span>] = <span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.js&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//切面编程：解析js模块前做打印处理</span></span><br><span class="line"><span class="keyword">const</span> prevFunc = <span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.js&quot;</span>];</span><br><span class="line"><span class="title class_">Module</span>.<span class="property">_extensions</span>[<span class="string">&quot;.js&quot;</span>] = <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;load script&quot;</span>);</span><br><span class="line">  prevFunc.<span class="title function_">apply</span>(prevFunc, args);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h1><ul>
<li>同步代码</li>
<li>process.nextTick 和 promise.then() ，之后进入事件循环</li>
<li>timers 阶段：这个阶段执行 timer（setTimeout、setInterval）的回调</li>
<li>I&#x2F;O callbacks 阶段 ：处理一些上一轮循环中的少数未执行的 I&#x2F;O 回调</li>
<li>idle, prepare 阶段 ：仅 node 内部使用</li>
<li>poll 阶段 ：获取新的 I&#x2F;O 事件, 适当的条件下 node 将阻塞在这里</li>
<li>check 阶段 ：执行 setImmediate() 的回调</li>
<li>close callbacks 阶段：执行 socket 的 close 事件回调</li>
</ul>
<p>习题解析：</p>
<ul>
<li>new Promise(()&#x3D;&gt;{&#x2F;&#x2F;同步执行}).then(()&#x3D;&gt;{&#x2F;&#x2F;异步执行})</li>
<li>async function test(){console.log() &#x2F;&#x2F;同步 -&gt; await test(0) &#x2F;&#x2F;同步 -&gt; console.log()&#x2F;&#x2F;异步}</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//习题1:</span></span><br><span class="line"><span class="comment">// 顺序不确定，只有两个语句，执行环境有差异</span></span><br><span class="line"><span class="comment">// 场景1: setTimeout 0 最少1ms，未推入timers队列中，执行结果为：setImmediate、setTimeout</span></span><br><span class="line"><span class="comment">// 场景2: setTimeout 0 已推入timers队列中，执行结果为：setTimeout、setImmediate</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setImmediate&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//习题2: 都在回调函数中，内容确定</span></span><br><span class="line"><span class="comment">//首轮事件循环setTimeout1的timers清空，执行至check阶段，先输出setImmediate</span></span><br><span class="line"><span class="comment">//第二轮事件循环setTimeout2</span></span><br><span class="line"><span class="comment">//最终输出：setTimeout1、setImmediate、setTimeout2</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout2&quot;</span>);</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setImmediate&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout1&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//习题3: 混合题</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;timeout&quot;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;immediate&quot;</span>);</span><br><span class="line">  <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;immediate1&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">77</span>);</span><br><span class="line">    <span class="title function_">resolve</span>();</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">88</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;nextTick1&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">7</span>);</span><br><span class="line">  <span class="title function_">resolve</span>();</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">8</span>);</span><br><span class="line">&#125;);</span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;nextTick2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一轮：7 start -  timeout | immediate 77 | 8 ｜ nextTick2</span></span><br><span class="line"><span class="comment">// 第二轮：7 start nextTick2  8 timeout immediate 77 - immediate1 ｜ 88 ｜ nextTick1</span></span><br><span class="line"><span class="comment">// 第三轮：7 start nextTick2  8 timeout immediate 77 nextTick1 88 immediate1</span></span><br></pre></td></tr></table></figure>

<h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><h2 id="全局对象"><a href="#全局对象" class="headerlink" title="全局对象"></a>全局对象</h2><p>Node 中全局对象是<code>global</code>,如果直接在模块中获取 this 指向的是<code>&#123;&#125;</code>.<br>而模块最终会封装进自执行函数中,指向的是<code>global</code>.</p>
<ul>
<li>全局对象：global，下挂如下对象和函数，使用时无需模块引入<ul>
<li>global</li>
<li>Buffer、process、console、queueMicrotask</li>
<li>setTimeout、clearTimeout、setInterval、setImmediate、clearInterval</li>
</ul>
</li>
<li>模块中使用注入变量：<ul>
<li><code>__filename</code>：当前文件名称带路径，eg：&#x2F;Users&#x2F;jian&#x2F;workspace&#x2F;cjs&#x2F;index.js</li>
<li><code>__dirname</code>：当前文件夹路径，eg：&#x2F;Users&#x2F;jian&#x2F;workspace&#x2F;cjs&#x2F;</li>
<li><code>cjs</code>：require, module, exports</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//全局this指向global</span></span><br><span class="line"><span class="comment">//模块文件中this指向：module.exports的对象</span></span><br><span class="line"><span class="comment">/* 模块中才可以使用的变量：commonjs模块注入，非模块中使用报错</span></span><br><span class="line"><span class="comment">__dirname、__filename、exports、module、require */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//node命令行中</span></span><br><span class="line">&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(__dirname)</span><br><span class="line"><span class="comment">// Uncaught ReferenceError: __dirname is not defined</span></span><br><span class="line">&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line"><span class="comment">/* &lt;ref *1&gt; Object [global] &#123;</span></span><br><span class="line"><span class="comment">  global: [Circular *1],</span></span><br><span class="line"><span class="comment">  clearInterval: [Function: clearInterval],</span></span><br><span class="line"><span class="comment">  clearTimeout: [Function: clearTimeout],</span></span><br><span class="line"><span class="comment">  setInterval: [Function: setInterval],</span></span><br><span class="line"><span class="comment">  setTimeout: [Function: setTimeout] &#123;</span></span><br><span class="line"><span class="comment">    [Symbol(nodejs.util.promisify.custom)]: [Getter]</span></span><br><span class="line"><span class="comment">  &#125;,</span></span><br><span class="line"><span class="comment">  queueMicrotask: [Function: queueMicrotask],</span></span><br><span class="line"><span class="comment">  clearImmediate: [Function: clearImmediate],</span></span><br><span class="line"><span class="comment">  setImmediate: [Function: setImmediate] &#123;</span></span><br><span class="line"><span class="comment">    [Symbol(nodejs.util.promisify.custom)]: [Getter]</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//node模块中执行</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(__filename)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(__dirname)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123;&#125;</span></span><br><span class="line"><span class="comment">/Users/jian/workspace/cjs/index.js</span></span><br><span class="line"><span class="comment">/Users/jian/workspace/cjs</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="process"><a href="#process" class="headerlink" title="process"></a>process</h3><ul>
<li>argv：返回一个数组，由命令行执行脚本时的各个参数组成。它的第一个成员总是 node，第二个成员是脚本文件名，其余成员是脚本文件的参数</li>
<li>env：返回一个对象，成员为当前 shell 的环境变量</li>
<li>stdin：标准输入流</li>
<li>stdout：标准输出流</li>
<li>cwd()：返回当前进程的工作目录</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="property">argv</span>);</span><br><span class="line"><span class="comment">//[ &#x27;/usr/local/bin/node&#x27;, &#x27;/Users/jian/workspace/cjs/index.js&#x27; ]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(process.<span class="title function_">cwd</span>()); <span class="comment">////Users/jian/workspace/cjs</span></span><br><span class="line">process.<span class="property">stdout</span>.<span class="title function_">write</span>(<span class="string">&quot;Hello World!&quot;</span>); <span class="comment">//Hello World!</span></span><br></pre></td></tr></table></figure>

<h2 id="底层依赖模块"><a href="#底层依赖模块" class="headerlink" title="底层依赖模块"></a>底层依赖模块</h2><ul>
<li>V8 引擎：主要是 JS 语法的解析，有了它才能识别 JS 语法</li>
<li>libuv：C 语⾔实现的⼀个⾼性能异步⾮阻塞 IO 库，⽤来实现 node.js 的事件循环</li>
<li>http-parser&#x2F;llhttp：底层处理 http 请求，处理报⽂，解析请求包等内容</li>
<li>openssl：处理加密算法，各种框架运⽤⼴泛，底层依赖，无需 js 实现</li>
<li>zlib：处理压缩等内容</li>
</ul>
<h3 id="Eventmitter"><a href="#Eventmitter" class="headerlink" title="Eventmitter"></a>Eventmitter</h3><ul>
<li>大多数时候我们不会直接使用 EventEmitter，而是在对象中继承它，包括 fs、net、 http 在内的，只要是支持事件响应的核心模块都是 EventEmitter 的子类。</li>
<li>EventEmitter 会按照监听器注册的顺序同步地调用所有监听器，所以必须确保事件的排序正确，且避免竞态条件。</li>
<li>常见 api<ul>
<li>addListener(event, listener)添加监听器</li>
<li>removeListener(event, listener)移除监听器</li>
<li>removeAllListeners([event])移除所有监听器</li>
<li>on(event, listener)注册监听器</li>
<li>off(eventName, listener)移除监听器</li>
<li>once(event, listener)为指定事件注册一个单次监听器</li>
<li>emit(event, [arg1], [arg2], […])按监听器的顺序执行执行每个监听器，如果事件有注册监听返回 true，否则返回 false</li>
</ul>
</li>
<li>错误处理：当 EventEmitter 实例出错时，应该触发 ‘error’ 事件。 这些在 Node 中被视为特殊情况。如果没有为 ‘error’ 事件注册监听器，则当 ‘error’ 事件触发时，会抛出错误、打印堆栈跟踪、并退出 Node.js 进程。作为最佳，应该始终为 ‘error’ 事件注册监听器</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&quot;events&quot;</span>).<span class="property">EventEmitter</span>;</span><br><span class="line"><span class="keyword">var</span> eventEmitter = <span class="keyword">new</span> <span class="title class_">EventEmitter</span>();</span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&quot;event&quot;</span>, <span class="keyword">function</span> (<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, <span class="variable language_">this</span>, <span class="variable language_">this</span> === eventEmitter);</span><br><span class="line">  <span class="comment">// 打印: 普通函数，this指向eventEmitter实例</span></span><br><span class="line">  <span class="comment">//   a b MyEmitter &#123;</span></span><br><span class="line">  <span class="comment">//     domain: null,</span></span><br><span class="line">  <span class="comment">//     _events: &#123; event: [Function] &#125;,</span></span><br><span class="line">  <span class="comment">//     _eventsCount: 1,</span></span><br><span class="line">  <span class="comment">//     _maxListeners: undefined &#125; true</span></span><br><span class="line">&#125;);</span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&quot;event&quot;</span>, <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">//箭头函数，this指向module.exports</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, <span class="variable language_">this</span>, <span class="variable language_">this</span> === <span class="variable language_">module</span>.<span class="property">exports</span>);</span><br><span class="line">  <span class="comment">// 打印: a b &#123;&#125; true</span></span><br><span class="line">&#125;);</span><br><span class="line">eventEmitter.<span class="title function_">emit</span>(<span class="string">&quot;event&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>事件模型设计（使用：发布订阅模式）</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventEmitter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">maxListeners</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span> = &#123;&#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxListeners</span> = maxListners || <span class="title class_">Infinity</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">on</span>(<span class="params">event, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">events</span>[event]) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event] = [];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">maxListener</span> != <span class="title class_">Infinity</span> &amp;&amp;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event].<span class="property">length</span> &gt; <span class="variable language_">this</span>.<span class="property">maxListeners</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;event&#125;</span> has reached max listeners.`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">events</span>[event].<span class="title function_">push</span>(listener);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">off</span>(<span class="params">event, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!listener) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event] = <span class="literal">null</span>; <span class="comment">//无listener全部移除</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">events</span>[event] = <span class="variable language_">this</span>.<span class="property">events</span>[event].<span class="title function_">filter</span>(</span><br><span class="line">        <span class="function">(<span class="params">item</span>) =&gt;</span> item !== listener</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>; <span class="comment">//链式调用</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">once</span>(<span class="params">event, listener</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">func</span> = (<span class="params">...args</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">off</span>(event, listener);</span><br><span class="line">      listener.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">on</span>(event, func);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">event, ...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="variable language_">this</span>.<span class="property">events</span>[event];</span><br><span class="line">    <span class="keyword">if</span> (!listeners) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;no listeners&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listeners.<span class="title function_">forEach</span>(<span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">      cb.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h1><ul>
<li>fs：⽂件系统，能够读取写⼊当前安装系统环境中硬盘的数据</li>
<li>path：路径系统，能够处理路径之间的问题</li>
<li>crypto：加密相关模块，能够以标准的加密⽅式对我们的内容进⾏加解密</li>
<li>dns：处理 dns 相关内容，例如我们可以设置 dns 服务器等等</li>
<li>http: 设置⼀个 http 服务器，发送 http 请求，监听响应等等</li>
<li>readline: 读取 stdin 的⼀⾏内容，可以读取、增加、删除我们命令⾏中的内容</li>
<li>os：操作系统层⾯的⼀些 api，例如告诉你当前系统类型及⼀些参数</li>
<li>vm: ⼀个专⻔处理沙箱的虚拟机模块，底层主要来调⽤ v8 相关 api 进⾏代码解析</li>
</ul>
<h2 id="fs"><a href="#fs" class="headerlink" title="fs"></a>fs</h2><ul>
<li>文件常识<ul>
<li>权限位 mode：文件所有者&#x2F;文件所属组&#x2F;其他用户的 rwx，eg：默认 0o666，对应十进制 438</li>
<li>标志位 flag：文件的操作方式，r、w、s 同步、+增加相反操作、x 排他方式</li>
<li>文件描述符 fd：识别和追踪文件</li>
</ul>
</li>
<li>完整性读写文件操作<ul>
<li>fs.readFile(filename,[encoding],[callback(error,data)]</li>
<li>fs.writeFile(filename,data,[options],callback)<ul>
<li>options：可选，为对象，{encoding, mode, flag}</li>
<li>默认编码为 utf8，模式为 0666（可读可写可操作），flag 为 ‘w’</li>
</ul>
</li>
<li>fs.unlink(filename, callback)</li>
</ul>
</li>
<li>指定位置读写文件操作(高级文件操作)<ul>
<li>fs.open(path,flags,[mode],callback)</li>
<li>fs.read(fd, buffer, offset, length, position, callback);</li>
<li>fs.write(fd, buffer, offset, length, position, callback);</li>
<li>fs.close(fd,callback)</li>
</ul>
</li>
</ul>
<ol>
<li>fd：文件描述符，需要先使用 open 打开，使用 fs.open 打开成功后返回的文件描述符；</li>
<li>buffer：一个 Buffer 对象，v8 引擎分配的一段内存，要将内容读取到的 Buffer；</li>
<li>offset：整数，向 Buffer 缓存区写入的初始位置，以字节为单位；</li>
<li>length：整数，读取文件的长度；</li>
<li>position：整数，读取文件初始位置；文件大小以字节为单位</li>
<li>callback：回调函数，有三个参数 err（错误），bytesRead（实际读取的字节数），buffer（被写入的缓存区对象），读取执行完成后执行。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//nodejs中最好使用绝对路径</span></span><br><span class="line"><span class="keyword">const</span> pathToFile = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;./text&quot;</span>);</span><br><span class="line"><span class="comment">//err first, 异步</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(pathTofile, <span class="string">&quot;utf-8&quot;</span>, <span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;e&quot;</span>, e);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result&quot;</span>, result);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//同步文件</span></span><br><span class="line">fs.<span class="title function_">readFileSync</span>(pathToFile, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//耦合promise封装</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">path</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">    fs.<span class="title function_">readFile</span>(path, &#123; <span class="attr">flag</span>: <span class="string">&quot;r&quot;</span>, <span class="attr">encoding</span>: <span class="string">&quot;utf-8&quot;</span> &#125;, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="comment">// 失败执行的内容</span></span><br><span class="line">        <span class="title function_">reject</span>(err);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 成功执行的内容</span></span><br><span class="line">        <span class="title function_">resolve</span>(data);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//通用promise封装，高版本已内置该库</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">promisify</span>(<span class="params">func</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      args.<span class="title function_">push</span>(<span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">reject</span>(err);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">resolve</span>(result);</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> func.<span class="title function_">apply</span>(func, args);</span><br><span class="line">      <span class="comment">/* 等价于</span></span><br><span class="line"><span class="comment">      fs.readFile(path, &#123; flag: &#x27;r&#x27;, encoding: &#x27;utf-8&#x27; &#125;, function (err, data) &#123;</span></span><br><span class="line"><span class="comment">      	if (err) &#123;</span></span><br><span class="line"><span class="comment">        	// 失败执行的内容</span></span><br><span class="line"><span class="comment">        	reject(err)</span></span><br><span class="line"><span class="comment">      	&#125; else &#123;</span></span><br><span class="line"><span class="comment">        	// 成功执行的内容</span></span><br><span class="line"><span class="comment">        	resolve(data)</span></span><br><span class="line"><span class="comment">      	&#125;</span></span><br><span class="line"><span class="comment">    	&#125;) */</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> creadFileAsync = <span class="title function_">promisify</span>(fs.<span class="property">readFile</span>);</span><br><span class="line"><span class="title function_">creadFileAsync</span>(pathToFile, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">content</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(content);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;e&quot;</span>, e);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="大文件拷贝"><a href="#大文件拷贝" class="headerlink" title="大文件拷贝"></a>大文件拷贝</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// copy 方法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">src, dest, size = <span class="number">16</span> * <span class="number">1024</span>, callback</span>) &#123;</span><br><span class="line">  <span class="comment">// 打开源文件</span></span><br><span class="line">  fs.<span class="title function_">open</span>(src, <span class="string">&#x27;r&#x27;</span>, <span class="function">(<span class="params">err, readFd</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 打开目标文件</span></span><br><span class="line">    fs.<span class="title function_">open</span>(dest, <span class="string">&#x27;w&#x27;</span>, <span class="function">(<span class="params">err, writeFd</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> buf = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(size);</span><br><span class="line">      <span class="keyword">let</span> readed = <span class="number">0</span>; <span class="comment">// 下次读取文件的位置</span></span><br><span class="line">      <span class="keyword">let</span> writed = <span class="number">0</span>; <span class="comment">// 下次写入文件的位置</span></span><br><span class="line"></span><br><span class="line">      (<span class="keyword">function</span> <span class="title function_">next</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">// 读取</span></span><br><span class="line">        fs.<span class="title function_">read</span>(readFd, buf, <span class="number">0</span>, size, readed, <span class="function">(<span class="params">err, bytesRead</span>) =&gt;</span> &#123;</span><br><span class="line">          readed += bytesRead;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 如果都不到内容关闭文件</span></span><br><span class="line">          <span class="keyword">if</span> (!bytesRead) fs.<span class="title function_">close</span>(readFd, <span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;关闭源文件&#x27;</span>));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 写入</span></span><br><span class="line">          fs.<span class="title function_">write</span>(writeFd, buf, <span class="number">0</span>, bytesRead, writed, <span class="function">(<span class="params">err, bytesWritten</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 如果没有内容了同步缓存，并关闭文件后执行回调</span></span><br><span class="line">            <span class="keyword">if</span> (!bytesWritten) &#123;</span><br><span class="line">              fs.<span class="title function_">fsync</span>(writeFd, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">                fs.<span class="title function_">close</span>(writeFd, <span class="function"><span class="params">err</span> =&gt;</span> <span class="keyword">return</span> !err &amp;&amp; <span class="title function_">callback</span>());</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            writed += bytesWritten;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 继续读取、写入</span></span><br><span class="line">            <span class="title function_">next</span>();</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;)();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="目录-文件夹-操作"><a href="#目录-文件夹-操作" class="headerlink" title="目录(文件夹)操作"></a>目录(文件夹)操作</h4><ul>
<li>fs.mkdir: 创建目录</li>
<li>fs.rmdir: 删除目录</li>
<li>fs.access: 判断文件或目录是否有操作权限</li>
<li>fs.stat: 获取目录及文件信息</li>
<li>fs.readdir: 读取目录中内容</li>
<li>fs.unlink: 删除指定文件</li>
</ul>
<h2 id="path"><a href="#path" class="headerlink" title="path"></a>path</h2><ul>
<li>path.join([path1][, path2][, …])：连接路径，主要用途在于，会正确使用当前系统的路径分隔符</li>
<li>path.resolve([from …], to)：用于返回绝对路径，类似于多次 cd 处理</li>
<li>path.dirname(p)：返回文件夹</li>
<li>path.extname(p)：返回后缀名</li>
<li>path.basename(p)：返回路径中的最后一部分,也就是名称</li>
<li>path.parse(): 解析路径,返回数组</li>
<li>path.format(): 序列化路径,将上面的数组重组成路径.</li>
<li>path.normalize(): 规范化路径</li>
<li>path.isAbsolute(): 判断传入路径是否是绝对路径</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接路径：/test/test1/2slashes/1slash</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;join path : &#x27;</span> + path.<span class="title function_">join</span>(<span class="string">&#x27;/test&#x27;</span>, <span class="string">&#x27;test1&#x27;</span>, <span class="string">&#x27;2slashes/1slash&#x27;</span>, <span class="string">&#x27;tab&#x27;</span>, <span class="string">&#x27;..&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换为绝对路径：/Users/jian/workspace/cjs/main.js</span></span><br><span class="line"><span class="keyword">const</span> mainPath = path.<span class="title function_">resolve</span>(<span class="string">&#x27;main.js&#x27;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;resolve : &#x27;</span> + mainPath);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>()) <span class="comment">// 什么都不传,返回绝对路径,不包含文件名.</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>)) <span class="comment">//返回绝对路径拼接/a/b</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(path.<span class="title function_">resolve</span>(<span class="string">&#x27;a&#x27;</span>,<span class="regexp">/b&#x27;)) /</span><span class="regexp">/ 返回`/</span>b<span class="string">`</span></span><br><span class="line"><span class="string">// resolve接收两部分参数,如果to的部分有路径(包含/),就返回&#x27;/xxx&#x27;,</span></span><br><span class="line"><span class="string">// 如果不含路径,就将当前目录的绝对路径拼接上</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 路径中文件的后缀名：.js</span></span><br><span class="line"><span class="string">console.log(&#x27;ext name : &#x27; + path.extname(mainPath));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// 路径最后名字：main.js</span></span><br><span class="line"><span class="string">console.log(&#x27;ext name : &#x27; + path.basename(mainPath));</span></span><br></pre></td></tr></table></figure>

<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建服务器</span></span><br><span class="line">http</span><br><span class="line">  .<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">request, response</span>) &#123;</span><br><span class="line">    <span class="comment">// 解析请求，包括文件名</span></span><br><span class="line">    <span class="keyword">var</span> pathname = url.<span class="title function_">parse</span>(request.<span class="property">url</span>).<span class="property">pathname</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 输出请求的文件名</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Request for &quot;</span> + pathname + <span class="string">&quot; received.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从文件系统中读取请求的文件内容</span></span><br><span class="line">    fs.<span class="title function_">readFile</span>(pathname.<span class="title function_">substr</span>(<span class="number">1</span>), <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">        <span class="comment">// HTTP 状态码: 404 : NOT FOUND</span></span><br><span class="line">        <span class="comment">// Content Type: text/html</span></span><br><span class="line">        response.<span class="title function_">writeHead</span>(<span class="number">404</span>, &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/html&quot;</span> &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// HTTP 状态码: 200 : OK</span></span><br><span class="line">        <span class="comment">// Content Type: text/html</span></span><br><span class="line">        response.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/html&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 响应文件内容</span></span><br><span class="line">        response.<span class="title function_">write</span>(data.<span class="title function_">toString</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//  发送响应数据</span></span><br><span class="line">      response.<span class="title function_">end</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台会输出以下信息</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Server running at http://127.0.0.1:8080/&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h2><p>Buffer 用于读取或操作二进制数据流，做为 Node.js API 的一部分使用时无需 require，用于操作网络协议、数据库、图片和文件 I&#x2F;O 等一些需要大量二进制数据的场景。Buffer 在创建时大小已经被确定且是无法调整的.<br>Buffer 是单独创建的,不占用 V8 的内存空间.</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p><strong>Buffer 的创建</strong><br>在此之前我们需要去简单的学习依一下 Buffer 的两个 API</p>
<ul>
<li>Buffer.from(): 根据现有的数据结构去创建 buffer 数据</li>
<li>Buffer.alloc(): 指定 buffer 数据的长度来创建 buffer 数据</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个长度为 10、且用零填充的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf1 = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">10</span>); <span class="comment">// &lt;Buffer 00 00 00 00 00 00 00 00 00 00&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个长度为 10、且用 0x1 填充的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf2 = <span class="title class_">Buffer</span>.<span class="title function_">alloc</span>(<span class="number">10</span>, <span class="number">1</span>); <span class="comment">// &lt;Buffer 01 01 01 01 01 01 01 01 01 01&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个长度为 10、且未初始化的 Buffer。</span></span><br><span class="line"><span class="comment">// 这个方法比调用 Buffer.alloc() 更快，</span></span><br><span class="line"><span class="comment">// 但返回的 Buffer 实例可能包含旧数据，</span></span><br><span class="line"><span class="comment">// 因此需要使用 fill() 或 write() 重写。</span></span><br><span class="line"><span class="keyword">const</span> buf3 = <span class="title class_">Buffer</span>.<span class="title function_">allocUnsafe</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含 [0x1, 0x2, 0x3] 的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf4 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]); <span class="comment">// &lt;Buffer 01 02 03&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含 UTF-8 字节 [0x74, 0xc3, 0xa9, 0x73, 0x74] 的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf5 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;tést&quot;</span>); <span class="comment">// &lt;Buffer 74 c3 a9 73 74&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个包含 Latin-1 字节 [0x74, 0xe9, 0x73, 0x74] 的 Buffer。</span></span><br><span class="line"><span class="keyword">const</span> buf6 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;tést&quot;</span>, <span class="string">&quot;latin1&quot;</span>); <span class="comment">// &lt;Buffer 74 e9 73 74&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Buffer 的读写</strong><br>关于 Buffer 的数据读取在官网上有很多方法：如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">buf.<span class="title function_">readBigInt64BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readBigInt64LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readBigUInt64BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readBigUInt64LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readDoubleBE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readDoubleLE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readFloatBE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readFloatLE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt8</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt16BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt16LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt32BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readInt32LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readIntBE</span>(offset, byteLength);</span><br><span class="line">buf.<span class="title function_">readIntLE</span>(offset, byteLength);</span><br><span class="line">buf.<span class="title function_">readUInt8</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt16BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt16LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt32BE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUInt32LE</span>([offset]);</span><br><span class="line">buf.<span class="title function_">readUIntBE</span>(offset, byteLength);</span><br><span class="line">buf.<span class="title function_">readUIntLE</span>(offset, byteLength);</span><br></pre></td></tr></table></figure>

<p>这些方法名称有 BE 和 LE 的区别，这个大段和小段的意思，说白了就是方向的问题，而 Int8 是没有 BE 和 LE 的区别的，我们用代码来演示一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">buffer2.<span class="title function_">writeInt8</span>(<span class="number">12</span>, <span class="number">1</span>); <span class="comment">// 在buffer2的第二位写入一个int8 的数字12</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer2); <span class="comment">// &lt;Buffer 01 0c 03 04&gt;</span></span><br><span class="line"></span><br><span class="line">buffer2.<span class="title function_">writeInt16BE</span>(<span class="number">512</span>, <span class="number">2</span>); <span class="comment">// 在buffer2的第三位开始写一个 int16的数字 512</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer2); <span class="comment">// &lt;Buffer 01 0c 02 00&gt;</span></span><br><span class="line"></span><br><span class="line">buffer2.<span class="title function_">writeInt16LE</span>(<span class="number">512</span>, <span class="number">2</span>); <span class="comment">// 在buffer2的第三位开始写一个 int16的数字 512</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buffer2); <span class="comment">// &lt;Buffer 01 0c 00 02&gt;</span></span><br></pre></td></tr></table></figure>

<p>所以你看到了，因为 int8 类型的数字只占一位，所以不存在方向不方向的问题，而 int16 类型的数字要占两位，比如 512 用 16 进制表示就是 [02 00],所以使用 BE 表示正方向，而 LE 表示反方向。具体使用什么样的表示方法要和被人协商议定</p>
<h3 id="实例属性"><a href="#实例属性" class="headerlink" title="实例属性"></a>实例属性</h3><ul>
<li>buf.length:返回内存中分配给 buf 的字节数。 不一定反映 buf 中可用数据的字节量。</li>
<li>buf.toString:根据 encoding 指定的字符编码将 buf 解码成字符串</li>
<li>buf.fill:用指定的 value 填充 buf。 如果没有指定 offset 与 end，则填充整个 buf</li>
<li>buf.equals:如果 buf 与参数具有完全相同的字节，则返回 true，否则返回 false</li>
<li>buf.indexOf:是否包含参数，包含则返回所在下标，不包含返回-1</li>
<li>buf.slice: 截取 buffer</li>
<li>buf.copy: 拷贝 buffer 中的数据</li>
</ul>
<h3 id="常用静态属性"><a href="#常用静态属性" class="headerlink" title="常用静态属性"></a>常用静态属性</h3><h4 id="Buffer-byteLength"><a href="#Buffer-byteLength" class="headerlink" title="Buffer.byteLength"></a>Buffer.byteLength</h4><p>这个表示整个 buffer 实际所占的字节数，因为不同的语言可能有不同的问题，比如英文字母在表达的时候一个字母就是一个字节，而中文用三个字节来表达汉字</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">byteLength</span>(<span class="string">&quot;test&quot;</span>)); <span class="comment">// 4</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">byteLength</span>(<span class="string">&quot;测试&quot;</span>)); <span class="comment">// 6</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;test&quot;</span>).<span class="property">length</span>); <span class="comment">// 4</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;测试&quot;</span>).<span class="property">length</span>); <span class="comment">// 6</span></span><br></pre></td></tr></table></figure>

<h4 id="Buffer-isBuffer"><a href="#Buffer-isBuffer" class="headerlink" title="Buffer.isBuffer"></a>Buffer.isBuffer</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(&#123;&#125;)); <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;test&quot;</span>))); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]))); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="Buffer-concat"><a href="#Buffer-concat" class="headerlink" title="Buffer.concat"></a>Buffer.concat</h4><p>拼接 Buffer，注意的是里面不是传入多个 Buffer 对象，而是一个 Buffer 的数组</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> buf1 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;This &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf2 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;is &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf3 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;buffer &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf4 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;test &quot;</span>);</span><br><span class="line"><span class="keyword">const</span> buf5 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;demo &quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bufConcat = <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([buf1, buf2, buf3, buf4, buf5]);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(bufConcat.<span class="title function_">toString</span>()); <span class="comment">// This is buffer test demo</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义-Buffer-split-拆分"><a href="#自定义-Buffer-split-拆分" class="headerlink" title="自定义 Buffer: split 拆分"></a>自定义 Buffer: split 拆分</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ArrayBuffer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">split</span> = <span class="keyword">function</span> (<span class="params">sep</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> len = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(sep).<span class="property">length</span>;</span><br><span class="line">  <span class="keyword">let</span> ret = [];</span><br><span class="line">  <span class="keyword">let</span> start = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">let</span> offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ((offset = <span class="variable language_">this</span>.<span class="title function_">indexOf</span>(sep, start) !== -<span class="number">1</span>)) &#123;</span><br><span class="line">    ret.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">slice</span>(start, offset));</span><br><span class="line">    start = offset + len;</span><br><span class="line">  &#125;</span><br><span class="line">  ret.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">slice</span>(start));</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf = <span class="string">&quot;吃馒头, 吃面条, 吃所有&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> bufArr = buf.<span class="title function_">split</span>(<span class="string">&quot;吃&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="乱码问题"><a href="#乱码问题" class="headerlink" title="乱码问题"></a>乱码问题</h3><p>乱码的出现因为是汉字是三个字节的，现在 11 个字节不是三个倍数，没有办法正确按照每 3 个字节解析汉字，我们的解决方法是：使用内置的 string_decoder（字符串解码器）来解析 Buffer</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">StringDecoder</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;string_decoder&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> decoder = <span class="keyword">new</span> <span class="title class_">StringDecoder</span>(<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> buf1 = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;我正在学习&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(buf1); <span class="comment">// &lt;Buffer e6 88 91 e6 ad a3 e5 9c a8 e5 ad a6 e4 b9 a0&gt;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; buf1.<span class="property">length</span>; i += <span class="number">5</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> buf2 = <span class="title class_">Buffer</span>.<span class="title function_">allocUnsafe</span>(<span class="number">5</span>);</span><br><span class="line">  buf1.<span class="title function_">copy</span>(buf2, <span class="number">0</span>, i);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(decoder.<span class="title function_">write</span>(buf2));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &lt;Buffer e6 88 91 e6 ad a3 e5 9c a8 e5 ad a6 e4 b9 a0&gt;</span></span><br><span class="line"><span class="comment">//我</span></span><br><span class="line"><span class="comment">//正在</span></span><br><span class="line"><span class="comment">//学习</span></span><br></pre></td></tr></table></figure>

<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><h4 id="I-x2F-O-操作"><a href="#I-x2F-O-操作" class="headerlink" title="I&#x2F;O 操作"></a>I&#x2F;O 操作</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> inputStream = fs.<span class="title function_">createReadStream</span>(<span class="string">&quot;input.txt&quot;</span>); <span class="comment">// 创建可读流</span></span><br><span class="line"><span class="keyword">const</span> outputStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&quot;output.txt&quot;</span>); <span class="comment">// 创建可写流</span></span><br><span class="line"></span><br><span class="line">inputStream.<span class="title function_">pipe</span>(outputStream); <span class="comment">// 管道读写</span></span><br></pre></td></tr></table></figure>

<p>在 Stream 中我们是不需要手动去创建自己的缓冲区，在 Node.js 的流中将会自动创建。</p>
<h4 id="加密解密"><a href="#加密解密" class="headerlink" title="加密解密"></a>加密解密</h4><p>在一些加解密算法中会遇到使用 Buffer，例如 crypto.createCipheriv 的第二个参数 key 为 String 或 Buffer 类型，如果是 Buffer 类型，就用到了本篇我们讲解的内容，以下做了一个简单的加密示例，重点使用了 Buffer.alloc()初始化一个实例（这个上面有介绍），之后使用了 fill 方法做了填充，这里重点在看下这个方法的使用。 <strong>buf.fill(value[, offset[, end]][, encoding])</strong></p>
<ul>
<li>value: 第一个参数为要填充的内容</li>
<li>offset: 偏移量，填充的起始位置</li>
<li>end: 结束填充 buf 的偏移量</li>
<li>encoding: 编码集</li>
</ul>
<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><p><strong>Buffer 和 Cache 的区别</strong></p>
<ul>
<li>缓冲（Buffer）是用于处理二进制流数据，将数据缓冲起来，它是临时性的，对于流式数据，会采用缓冲区将数据临时存储起来，等缓冲到一定的大小之后在存入硬盘中。视频播放器就是一个经典的例子，有时你会看到一个缓冲的图标，这意味着此时这一组缓冲区并未填满，当数据到达填满缓冲区并且被处理之后，此时缓冲图标消失，你可以看到一些图像数据。</li>
<li>缓存（Cache）我们可以看作是一个中间层，它可以是永久性的将热点数据进行缓存，使得访问速度更快，例如我们通过 Memory、Redis 等将数据从硬盘或其它第三方接口中请求过来进行缓存，目的就是将数据存于内存的缓存区中，这样对同一个资源进行访问，速度会更快，也是性能优化一个重要的点。</li>
</ul>
<p><strong>Buffer 与 String 比较</strong><br>在 HTTP 传输中传输的是二进制数据，那么如果使用 Buffer 和 String 情况如下：</p>
<ul>
<li>接口如果直接返回的字符串，这时候 HTTP 在传输之前会先将字符串转换为 Buffer 类型，以二进制数据传输，通过流（Stream）的方式一点点返回到客户端。</li>
<li>但是直接返回 Buffer 类型，则少了每次的转换操作，对于性能也是有提升的。</li>
</ul>
<p>所以在一些 Web 应用中，对于静态数据可以预先转为 Buffer 进行传输，可以有效减少 CPU 的重复使用（重复的字符串转 Buffer 操作）</p>
<h2 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>在 node 当中 stream 是一种处理流数据的抽象接口，stream 模块提供了一系列实现流的 API,在 node 当中提供了很多关于流的对象，比如 http 服务器的请求和 process.stdout 标准输出都是流的实例，流是可读的，可写的，同时也可以是可读写的，所有的流都是 EventEmitter 的实例。</p>
<blockquote>
<p>之所以用 stream ，是因为一次性读取、操作大文件，内存和网络是“吃不消”的，因此要让数据流动起来，一点一点的进行操作,这其实也符合算法中一个很重要的思想 —— 分而治之</p>
</blockquote>
<h3 id="流转和应用"><a href="#流转和应用" class="headerlink" title="流转和应用"></a>流转和应用</h3><ul>
<li>data 事件: 用来监听 stream 数据的流入</li>
<li>end 事件：用来监听 stream 数据输入的完成</li>
<li>pipe 方法: 用来做数据流转</li>
</ul>
<p><strong>① stream 从哪里来-soucre</strong><br>stream 的常见来源方式有三种：</p>
<ul>
<li>从控制台输入</li>
<li>http 请求中的 request</li>
<li>读取文件</li>
</ul>
<p>这里先说一下从控制台输入这种方式，看一段 process.stdin 的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">process.<span class="property">stdin</span>.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stream by stdin&quot;</span>, chunk); <span class="comment">// stream by stdin &lt;Buffer 6b 6f 61 6c 61 6b 6f 61 6c 61 0a&gt;</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;stream by stdin&quot;</span>, chunk.<span class="title function_">toString</span>()); <span class="comment">// stream by stdin koalakoala</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后从控制台输入任何内容都会被 data 事件监听到，process.stdin 就是一个 stream 对象,data 是 stream 对象用来监听数据传入的一个自定义函数， (说明： stream 对象可以监听”data”,”end”,”opne”,”close”,”error”等事件。node.js 中监听自定义事件使用.on 方法，例如 process.stdin.on(‘data’,…), req.on(‘data’,…),通过这种方式，能很直观的监听到 stream 数据的传入和结束)<br><strong>② 连接水桶的管道-pipe</strong><br>从水桶管道流转图中可以看到，在 source 和 dest 之间有一个连接的管道 pipe,它的基本语法是 source.pipe(dest) ，source 和 dest 就是通过 pipe 连接，让数据从 source 流向了 dest。<br><strong>③ stream 到哪里去-dest</strong><br>stream 的常见输出方式有三种：</p>
<ul>
<li>输出控制台</li>
<li>http 请求中的 response</li>
<li>写入文件</li>
</ul>
<p>我们上面借助控制台输入输出来讲解了 stream 的流转过程，可是在实际应用场景中，http 请求和文件操作当中使用 stream 的频率异常的频繁。原因是这样：<br>http 请求和文件操作都属于 IO ，即 stream 主要的应用场景就是处理 IO ，这就又回到了 stream 的本质 —— 由于一次性 IO 操作过大，硬件开销太多，影响软件运行效率，因此将 IO 分批分段操作，让数据一点一点的流动起来，直到操作完成 。</p>
<h3 id="http-中的-steam"><a href="#http-中的-steam" class="headerlink" title="http 中的 steam"></a>http 中的 steam</h3><h4 id="get-请求"><a href="#get-请求" class="headerlink" title="get 请求"></a>get 请求</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// get 请求</span></span><br><span class="line">    <span class="keyword">const</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> stream = fs.<span class="title function_">createReadStream</span>(fileName);</span><br><span class="line">    stream.<span class="title function_">pipe</span>(res); <span class="comment">// 将 res 作为 stream 的 dest</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他method暂时忽略</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>从上面例子可以看出，对 response 使用 stream 特性能提高性能。因此，在 nodejs 中如果要返回的数据是经过 IO 操作得来的，例如上面例子中读取文件内容，可以直接使用 stream.pipe(res) ,毕竟 response 也是一个 stream 对象，可以作为参数传入 pipe 当中，而不要再用 res.end(data)了。<br>这种应用的实例应该比较多，主要有两种场景：</p>
<ul>
<li>使用 node.js 作为服务代理，即客户端通过 node.js 服务作为跳板去请求其他服务，返回请求的内容</li>
<li>使用 node.js 做静态文件服务器，直接返回静态文件</li>
</ul>
<h4 id="post-请求"><a href="#post-请求" class="headerlink" title="post 请求"></a>post 请求</h4><p>web server 接收 http 请求肯定是通过 request，而 request 接收数据的本质其实就是 stream。所以 看似是 request 接收数据，但是在服务端的角度来说，request 就是产生数据的 source,那么 soucre 类型的 stream 对象都能监听 data,end 事件。分别触发数据接收和数据接收完成的通知，所以代码可以如下进行改造：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 暂只关注 post 请求</span></span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">      <span class="comment">// 接收到部分数据</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;chunk&quot;</span>, chunk.<span class="title function_">toString</span>().<span class="property">length</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 接收数据完成</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他请求方法暂不关心</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>总结一下，request 和 response 一样，本身也是一个 stream 对象，可以用 stream 的特性，那肯定也能提高性能。两者的区别就在于，request 是 source 类型的、是 stream 的源头，而 response 是 dest 类型的、是 stream 的目的地。<br>这里再多举个例子，比如我们现在要将 node.js 接收到的 post 请求的数据写入文件，一般的小伙伴会这样写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 暂只关注 post 请求</span></span><br><span class="line">    <span class="keyword">var</span> dataStr = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;data&quot;</span>, <span class="keyword">function</span> (<span class="params">chunk</span>) &#123;</span><br><span class="line">      <span class="comment">// 接收到数据，先存储起来</span></span><br><span class="line">      <span class="keyword">var</span> chunkStr = chunk.<span class="title function_">toString</span>();</span><br><span class="line">      dataStr += chunkStr;</span><br><span class="line">    &#125;);</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 接收数据完成，将数据写入文件</span></span><br><span class="line">      <span class="keyword">var</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;post.txt&quot;</span>);</span><br><span class="line">      fs.<span class="title function_">writeFile</span>(fileName, dataStr);</span><br><span class="line"></span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他请求方法暂不关心</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>这种写法也是对的，但是还没有真正理解 stream，当我们学习了文件操作中的 stream，你可能就 hi 写出更简单的代码，比如说下面这种：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.<span class="title function_">createServer</span>(<span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> method = req.<span class="property">method</span>; <span class="comment">// 获取请求方法</span></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// 暂只关注 post 请求</span></span><br><span class="line">    <span class="keyword">var</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;post.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> writeStream = fs.<span class="title function_">createWriteStream</span>(fileName);</span><br><span class="line">    req.<span class="title function_">pipe</span>(writeStream);</span><br><span class="line">    req.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// 接收数据完成</span></span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他请求方法暂不关心</span></span><br><span class="line">&#125;);</span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8000</span>);</span><br></pre></td></tr></table></figure>

<p>和 get 请求使用 stream 的场景类似，post 请求使用 stream 的场景，主要是用于将接收的数据直接进行 IO 操作，例如：</p>
<ul>
<li>将接受的数据直接存储为文件</li>
<li>将接受的数据直接 post 给其他的 web server</li>
</ul>
<h3 id="fs-中的-stream"><a href="#fs-中的-stream" class="headerlink" title="fs 中的 stream"></a>fs 中的 stream</h3><p>用 stream 读写文件其实前面章节都有多处用到，这里在统一整理一下：</p>
<ul>
<li>可以使用 fs.createReadStream(fileName)来创建读取文件的 stream 对象</li>
<li>可以使用 fs.createWriteStream(fileName)来创建写入文件的 stream 对象</li>
</ul>
<p>读取文件的 stream 对象，对应的就是 source，即数据的来源。写入文件的 steram 对象对应的就是 dest ，即数据的目的地。下面我们分别用普通的读写和使用 stream 实现一个文件拷贝的功能，并通过监控工具 memeye 来监控 node.js 内存占用的情况</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> memeye = <span class="built_in">require</span>(<span class="string">&quot;memeye&quot;</span>);</span><br><span class="line"><span class="title function_">memeye</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">num</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> fileName1 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>); <span class="comment">// 42kb左右</span></span><br><span class="line">  fs.<span class="title function_">readFile</span>(fileName1, <span class="keyword">function</span> (<span class="params">err, data</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;读取出错&quot;</span>, err.<span class="property">message</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> dataStr = data.<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> fileName2 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data-bak.txt&quot;</span>);</span><br><span class="line">    fs.<span class="title function_">writeFile</span>(fileName2, dataStr, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;写入出错&quot;</span>, err.<span class="property">message</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`拷贝第<span class="subst">$&#123;num&#125;</span>次成功`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">copy</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<p>启动文件，在浏览器打开 localhost:23333&#x2F;,可以看到 heapUsed 在 13.26M 左右，heapTotal 在 30M 左右，rss 在 40M 左右</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> memeye = <span class="built_in">require</span>(<span class="string">&quot;memeye&quot;</span>);</span><br><span class="line"><span class="title function_">memeye</span>();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">num</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> fileName1 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>); <span class="comment">// 42KB左右</span></span><br><span class="line">  <span class="keyword">var</span> fileName2 = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data-bak.txt&quot;</span>);</span><br><span class="line">  <span class="comment">// 读取文件的stream对象</span></span><br><span class="line">  <span class="keyword">var</span> readStream = fs.<span class="title function_">createReadStream</span>(fileName1);</span><br><span class="line">  <span class="comment">// 写入文件的stream对象</span></span><br><span class="line">  <span class="keyword">var</span> writeStream = fs.<span class="title function_">createWriteStream</span>(fileName2);</span><br><span class="line">  <span class="comment">// 通过pipe实现数据的流转</span></span><br><span class="line">  readStream.<span class="title function_">pipe</span>(writeStream);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听数据完成的情况</span></span><br><span class="line">  readStream.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;拷贝完成&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="title function_">copy</span>(i);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>

<p>启动文件，在浏览器打开 localhost:23333&#x2F;,可以看到 heapUsed 在 6.4M 左右，heapTotal 在 9.23M 左右，rss 在 30M 左右</p>
<p>总结：所有执行文件操作的场景，都应该尝试使用 stream ，例如文件的读写、拷贝、压缩、解压、格式转换等。除非是体积很小的文件，而且读写次数很少，性能上被忽略。如果是体积很大或者读写次数很多的情况下，建议使用 stream 来优化性能</p>
<h3 id="逐行读取-readline"><a href="#逐行读取-readline" class="headerlink" title="逐行读取 readline"></a>逐行读取 readline</h3><p>用 stream 操作文件，会来带很大的性能提升。但是原生的 stream 却对“行”无能为力，它只是把文件当做一个数据流、简单粗暴的流动。很多文件格式都是分行的，例如 csv 文件、日志文件，以及其他一些自定义的文件格式。</p>
<p>node.js 提供了非常简单的按行读取的 API —— readline，它本质上也是 stream，只不过是以“行”作为数据流动的单位。本节将结合一个分析日志文件的案例，讲解 readline 的使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> readline = <span class="built_in">require</span>(<span class="string">&quot;readline&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fileName = path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;data.txt&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> readStream = fs.<span class="title function_">createReadStream</span>(fileName);</span><br><span class="line"><span class="comment">// 创建readline对象</span></span><br><span class="line"><span class="keyword">var</span> readlineObj = readline.<span class="title function_">createInterface</span>(&#123;</span><br><span class="line">  <span class="attr">input</span>: readStream,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">readlineObj.<span class="title function_">on</span>(<span class="string">&quot;line&quot;</span>, <span class="function">(<span class="params">lineDate</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(lineDate);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;---- line ----&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">readlineObj.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>对 readline 最常见的使用应该是日志的逐行分析了，比如我们要从一个 10 万行的日志中去找一个 2018-10-23 14:00 这一分钟，对 user.html 的访问次数，我们就应该这样做</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> num = <span class="number">0</span></span><br><span class="line"><span class="comment">// 逐行读取日志内容，如果有包含`2018-10-23 14:00`和`user.html`的字符串就表示</span></span><br><span class="line"><span class="comment">// 在这一分钟有人访问了user.html,我们就记录一次</span></span><br><span class="line">readlineObj.<span class="title function_">on</span>(<span class="string">&#x27;line&#x27;</span>，<span class="keyword">function</span>(<span class="params">lineData</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(lineData.<span class="title function_">indexOf</span>(<span class="string">&#x27;2018-10-23 14:00&#x27;</span>)&gt;=<span class="number">0</span> &amp;&amp; lineData.<span class="title function_">indexOf</span>(<span class="string">&#x27;user.html&#x27;</span>) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">        num++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听读取完成</span></span><br><span class="line">readline.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>,<span class="function">()=&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;num&#x27;</span>,num)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>借用这个简单的例子来演示 readline 的使用以及使用场景，其实日常工作中情况会更加复杂，不过再复杂的场景选择 readline 做逐行分析一定是不会错的。方向选对了很重要，选择大于努力.</p>
<h3 id="stream-的种类"><a href="#stream-的种类" class="headerlink" title="stream 的种类"></a>stream 的种类</h3><h4 id="readable-stream"><a href="#readable-stream" class="headerlink" title="readable stream"></a>readable stream</h4><p>可读流是对提供数据的来源的一种抽象。<br>可读流的例子包括：客户端的 HTTP 响应、服务器的 HTTP 请求、fs 的读取流、zilb 流、crypto 流、TCP socket、子进程 stdout 与 stderr、process.stdin，因为这些可读流都实现了 stream.Readable 类定义的接口</p>
<h4 id="writeable-stream"><a href="#writeable-stream" class="headerlink" title="writeable stream"></a>writeable stream</h4><p>可写流是对数据要被写入的目的地的一种抽象<br>可写流的例子包括：客户端的 HTTP 响应、服务器的 HTTP 请求、fs 的读取流、zilb 流、crypto 流、TCP socket、子进程 stdout 与 stderr、process.stdin，因为这些可写流都实现了 stream.Writable 类定义的接口</p>
<h4 id="duplex-stream"><a href="#duplex-stream" class="headerlink" title="duplex stream"></a>duplex stream</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> zlib = <span class="built_in">require</span>(<span class="string">&quot;zlib&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> readStream = fs.<span class="title function_">createReadStream</span>(<span class="string">&quot;./data.txt&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> writeStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&quot;./data-bak.txt&quot;</span>);</span><br><span class="line">readStream.<span class="title function_">pipe</span>(zlib.<span class="title function_">createGzip</span>()).<span class="title function_">pipe</span>(writeStream);</span><br></pre></td></tr></table></figure>

<p>pipe 的严谨用法要遵循下面三个原则：</p>
<ul>
<li>调用 pipe 的对象必须是 readable stream 或者 duplex stream 这样的具有读取数据的功能的流对象</li>
<li>pipe 中的参数对象必须是 writeable stream 或者 duplex stream 这样的具有写入数据的功能的流对象</li>
<li>pipe 支持链式调用</li>
</ul>
<h4 id="transform-stream"><a href="#transform-stream" class="headerlink" title="transform stream"></a>transform stream</h4><p>转换流（Transform）是一种 Duplex 流，但它的输出与输入是相关联的,而且一般只有触发了写入操作时才会进入_transform 方法中。 与 Duplex 流一样， Transform 流也同时实现了 Readable 和 Writable 接口。</p>
<h2 id="stream-有什么弊端"><a href="#stream-有什么弊端" class="headerlink" title="stream 有什么弊端"></a>stream 有什么弊端</h2><ul>
<li>用 rs.pipe(ws) 的方式来写文件并不是把 rs 的内容 append 到 ws 后面，而是直接用 rs 的内容覆盖 ws 原有的内容</li>
<li>已结束&#x2F;关闭的流不能重复使用，必须重新创建数据流</li>
<li>pipe 方法返回的是目标数据流，如 a.pipe(b) 返回的是 b，因此监听事件的时候请注意你监听的对象是否正确</li>
<li>如果你要监听多个数据流，同时你又使用了 pipe 方法来串联数据流的话，你就要写成：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data</span><br><span class="line">  .<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data end&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">pipe</span>(a)</span><br><span class="line">  .<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;a end&quot;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">pipe</span>(b)</span><br><span class="line">  .<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;b end&quot;</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/03/npm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/03/npm/" class="post-title-link" itemprop="url">npm</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-03 13:56:47" itemprop="dateCreated datePublished" datetime="2022-11-03T13:56:47+08:00">2022-11-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:22" itemprop="dateModified" datetime="2022-11-08T08:54:22+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="nvm"><a href="#nvm" class="headerlink" title="nvm"></a>nvm</h1><p>切换不同 node 版本.安装之前建议删除之前的 node 版本.</p>
<h2 id="删除之前-node"><a href="#删除之前-node" class="headerlink" title="删除之前 node"></a>删除之前 node</h2><p>打开 <code>/usr/local/lib</code>，删除 node 和 node_modules 相关的文件和文件夹<br>打开<code> /usr/local/include</code>，删除 node 和 node_modules 相关的文件和文件夹<br>如果你是使用的 <code>brew install node</code> 安装的 NodeJS，那么你还需要在终端中执行 <code>brew uninstall node</code> 命令来卸载<br>检查你的个人主文件夹下面的所有的 local、lib 以及 include 文件夹，并且删除所有与 node 和 node_modules 相关的文件以及文件夹<br>打开 <code>/usr/local/bin</code> 并删除 node 可执行文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /usr/local/bin/npm</span><br><span class="line">sudo rm /usr/local/share/man/man1/node.1</span><br><span class="line">sudo rm /usr/local/lib/dtrace/node.d</span><br><span class="line">sudo rm -rf ~/.npm</span><br><span class="line">sudo rm -rf ~/.node-gyp</span><br><span class="line">sudo rm /opt/local/bin/node</span><br><span class="line">sudo rm /opt/local/include/node</span><br><span class="line">sudo rm -rf /opt/local/lib/node_modules</span><br></pre></td></tr></table></figure>

<h2 id="安装-nvm"><a href="#安装-nvm" class="headerlink" title="安装 nvm"></a>安装 nvm</h2><p>mac 安装: <code>$ brew install nvm</code><br>命令安装:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash</span><br><span class="line">或</span><br><span class="line">$ wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash</span><br></pre></td></tr></table></figure>

<p>安装的时候可以需要配置解释器,按照当时反馈的描述写就行.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建 zsh 配置文件,一遍安装了zsh就不用创建</span></span><br><span class="line">$ <span class="built_in">touch</span> ~/.zshrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">$ vim ~/.zshrc</span><br></pre></td></tr></table></figure>

<p>比如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、这是本地不存在配置文件的时候提示需要添加的配置</span></span><br><span class="line"><span class="built_in">export</span> NVM_DIR=<span class="string">&quot;<span class="variable">$HOME</span>/.nvm&quot;</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="comment"># This loads nvm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、这是本地存在配置文件的时候提示需要添加的配置（推荐）</span></span><br><span class="line"><span class="built_in">export</span> NVM_DIR=<span class="string">&quot;<span class="variable">$HOME</span>/.nvm&quot;</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="comment"># This loads nvm</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span>  <span class="comment"># This loads nvm bash_completion</span></span><br></pre></td></tr></table></figure>

<p>之后重新加载一遍</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure>

<h2 id="安装-node"><a href="#安装-node" class="headerlink" title="安装 node"></a>安装 node</h2><p>列出所有远程版本<code>$ nvm ls-remote</code><br>显示当前版本<code>$ nvm current</code><br>列出所有已安装版本<code>$ nvm ls</code><br>切换指定版本 node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 临时版本 - 只在当前窗口生效指定版本</span><br><span class="line">$ nvm use &lt;version&gt;</span><br><span class="line"></span><br><span class="line">// 永久版本 - 所有窗口生效指定版本</span><br><span class="line">$ nvm <span class="built_in">alias</span> default &lt;version&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：在任意一个命令行窗口进行切换之后，其他的窗口或其他命令行工具窗口 需要关掉工具，重启才能生效。（例如 VSCode 内或外部命令切换之后，需要重启 VSCode，才能正常生效，否则或处于 临时生效状态，也就是在 VSCode 中重新打开一个命令行查看版本还会是旧版本，所以必须要重启。）<br>这里的 重启 不是简单的关掉窗口重启，没有退出后台进程，而是完全退出杀死工具进程，重新启动。</p>
</blockquote>
<blockquote>
<p>本来用 nvm use &lt;版本号&gt; 切换到需要的版本号上，然后用 npm install -g taro 安装是没问题的，但切换了其它命令行后，发现 taro 提示 command not found 。后来细查之后才发现，nvm use &lt;版本号&gt; 只是在当前命令行环境下切换，并不是全局切换。如果想要全局切换，要用 nvm alias default &lt;版本号&gt;</p>
</blockquote>
<h1 id="pnpm"><a href="#pnpm" class="headerlink" title="pnpm"></a>pnpm</h1><h2 id="全局安装"><a href="#全局安装" class="headerlink" title="全局安装"></a>全局安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g pnpm</span><br><span class="line">// brew</span><br><span class="line">brew install pnpm</span><br></pre></td></tr></table></figure>

<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>如果要全局安装其他,比如 typescript,还是用 npm,不然和上面 nvm 有冲突.</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>pnpm add sax</td>
<td>保存到 dependencies 配置项下</td>
</tr>
<tr>
<td>pnpm add -D sax</td>
<td>保存到 devDependencies 配置项下</td>
</tr>
<tr>
<td>pnpm add -O sax</td>
<td>保存到 optionalDependencies 配置项下</td>
</tr>
<tr>
<td>pnpm add -g sax</td>
<td>安装软件包到全局环境中</td>
</tr>
<tr>
<td>pnpm add sax@next</td>
<td>安装标记为 next 的版本</td>
</tr>
<tr>
<td>pnpm add <a href="mailto:&#x73;&#97;&#x78;&#x40;&#x33;&#x2e;&#48;&#46;&#x30;">&#x73;&#97;&#x78;&#x40;&#x33;&#x2e;&#48;&#46;&#x30;</a></td>
<td>安装指定版本 3.0.0</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/02/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/02/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83%E5%8C%96/" class="post-title-link" itemprop="url">代码规范化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-02 22:25:08" itemprop="dateCreated datePublished" datetime="2022-11-02T22:25:08+08:00">2022-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:22" itemprop="dateModified" datetime="2022-11-08T08:54:22+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Eslint-安装"><a href="#Eslint-安装" class="headerlink" title="Eslint 安装"></a>Eslint 安装</h3><ul>
<li>安装 <code>npm install eslint --save-dev</code></li>
<li>使用 <code>npx eslint --init</code> 初始化一个配置文件</li>
<li>执行 <code>npm eslint test.js --fix</code> –fix 会自动修正代码风格问题，而一些问题代码就需要手动修正</li>
<li>当代码有语法问题时 Eslint 无法检查问题代码和代码风格，所有要先手动解决语法问题</li>
</ul>
<h3 id="ESLint-配置文件解析"><a href="#ESLint-配置文件解析" class="headerlink" title="ESLint 配置文件解析"></a>ESLint 配置文件解析</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">env</span>: &#123;</span><br><span class="line">    <span class="comment">// 标记代码运行环境</span></span><br><span class="line">    <span class="attr">browser</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">es2020</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">extends</span>: [</span><br><span class="line">    <span class="comment">// 继承共享配置</span></span><br><span class="line">    <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">parser</span>: <span class="string">&quot;@typescript-eslint/parser&quot;</span>, <span class="comment">// 语法解析器</span></span><br><span class="line">  <span class="attr">parserOptions</span>: &#123;</span><br><span class="line">    <span class="comment">// 设置语法解析器，检查语法，而不是代表某个成员是否可以，成员通过环境定义</span></span><br><span class="line">    <span class="attr">ecmaVersion</span>: <span class="number">11</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">rules</span>: &#123;</span><br><span class="line">    <span class="comment">// 校验规则的开启、关闭 off：关闭 warning：结果 error：警告</span></span><br><span class="line">    <span class="string">&quot;no-alert&quot;</span>: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">globals</span>: &#123;</span><br><span class="line">    <span class="comment">// 额外声明代码中可以使用的全局成员</span></span><br><span class="line">    <span class="attr">jQuery</span>: <span class="string">&quot;readonly&quot;</span>, <span class="comment">// 代码中可以使用jQuery而且不会报错</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="ESLint-配置注释"><a href="#ESLint-配置注释" class="headerlink" title="ESLint 配置注释"></a>ESLint 配置注释</h3><ul>
<li>在编码时有时需要违反 eslint 规则，eslint-disable-line 可以通过注释临时禁用校验规则</li>
<li>当一行有多个问题时可以跟上具体禁用哪个规则</li>
<li><a target="_blank" rel="noopener" href="http://eslint.cn/docs/user-guide/configuring#configuring-rules">具体配置注释介绍文档</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// eslint-disable-line no-template-curly-in-string</span></span><br><span class="line"><span class="keyword">const</span> str = <span class="string">&quot;$&#123;name&#125; is a coder&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(str);</span><br></pre></td></tr></table></figure>

<h3 id="ESLint-结合自动化工具"><a href="#ESLint-结合自动化工具" class="headerlink" title="ESLint 结合自动化工具"></a>ESLint 结合自动化工具</h3><ul>
<li>gulp<ul>
<li>安装 gulp-eslint</li>
<li>创建 eslint 配置文件</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// plugins 自动加载插件模块</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">script</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="title function_">src</span>(<span class="string">&quot;src/assets/script/*.js&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">eslint</span>()) <span class="comment">// 默认只会检查代码的问题，并不会根据检查结果做出反馈</span></span><br><span class="line">      <span class="comment">// 控制台打印错误信息</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="property">eslint</span>.<span class="title function_">format</span>())</span><br><span class="line">      <span class="comment">// eslint检查错误后终止任务</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="property">eslint</span>.<span class="title function_">failAfterError</span>())</span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">babel</span>(&#123; <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>] &#125;))</span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line">      .<span class="title function_">pipe</span>(bs.<span class="title function_">reload</span>(&#123; <span class="attr">stream</span>: <span class="literal">true</span> &#125;))</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="ESLint-结合-Webpack"><a href="#ESLint-结合-Webpack" class="headerlink" title="ESLint 结合 Webpack"></a>ESLint 结合 Webpack</h3><ul>
<li>通过 loader 机制完成校验</li>
<li>安装 eslint-loader</li>
<li>初始化配置文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;html-webpack-plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;production&quot;</span>,</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/main.js&quot;</span>,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&quot;babel-loader&quot;</span>,</span><br><span class="line">          <span class="comment">// &#x27;eslint-loader&#x27;</span></span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: <span class="string">&quot;eslint-loader&quot;</span>,</span><br><span class="line">        <span class="attr">enfore</span>: <span class="string">&quot;pre&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&quot;style-loader&quot;</span>, <span class="string">&quot;css-loader&quot;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;src/index.html&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>在 react 项目中会报 React 未使用的问题，和 App is defined but never used no-unused-vars，可以使用插件</li>
<li>安装插件 <code>npm install eslint-plugin-react</code></li>
<li>在配置文件的 plugins 属性配置</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">modul.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">rules</span>: &#123;</span><br><span class="line">    <span class="string">&quot;react/jsx-uses-react&quot;</span>: <span class="number">2</span>, <span class="comment">// 开启报错，2 代替 error</span></span><br><span class="line">    <span class="string">&quot;react/jsx-uses-vars&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">extends</span>: [</span><br><span class="line">    <span class="comment">// &#x27;plugin:react/recommended&#x27; // 方法二</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="string">&quot;react&quot;</span>, <span class="comment">// 模块名会去除eslint-plugin</span></span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Stylelint-认识"><a href="#Stylelint-认识" class="headerlink" title="Stylelint 认识"></a>Stylelint 认识</h3><ul>
<li>安装 <code>npm install stylelint -D</code></li>
<li>添加配置文件 .stylelintrc.js</li>
<li>共享配置名称要完整的模块名称</li>
<li>stylelint 内部没有提供任何可用的共享配置，可以自定义安装</li>
<li><code>npm install stylelint-config-standard -D</code> 对 css 代码检查</li>
<li><code>npm install stylelint-config-sass-guidelines -D</code> 对 sass 代码检查</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 共享配置</span></span><br><span class="line">  <span class="attr">extends</span>: [<span class="string">&quot;stylelint-config-standard&quot;</span>, <span class="string">&quot;stylelint-config-sass-guidelines&quot;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="Prettier-的使用—代码格式化工具"><a href="#Prettier-的使用—代码格式化工具" class="headerlink" title="Prettier 的使用—代码格式化工具"></a>Prettier 的使用—代码格式化工具</h3><ul>
<li>安装 <code>npm install prettier -D</code></li>
<li><code>npm prettier style.css --write</code> 自动格式化文件，–write 把格式化的代码覆盖源代码</li>
</ul>
<h3 id="ESLint-结合-Git-Hooks"><a href="#ESLint-结合-Git-Hooks" class="headerlink" title="ESLint 结合 Git Hooks"></a>ESLint 结合 Git Hooks</h3><ul>
<li>安装依赖 <code>npm install husky -D</code></li>
<li>在 package.json 文件添加一个 husky 字段，在 husky 添加一个 hooks 属性，在 hooks 属性添加一个 pre-commit 钩子属性，值为 npm run xxxx，在提交 commit 前就会先执行 scripts 下的对应命令，比如执行 eslint，如果不符合规范就不能直接提交到代码仓库中</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;link&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eslint ./index.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;husky&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hooks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;pre-commit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run link&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>安装 <code>npm install lint-staged -D</code> 在 commit 前执行 eslint 后，再进行其他操作，如格式化代码</li>
<li>安装代码格式化工具 <code>npm install prettier -D</code></li>
<li>在 package.json 中添加一个 lint-staged 字段</li>
<li>一般 husky 和 lint-staged 配合使用</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;link&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eslint ./index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;precommit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lint-staged&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;husky&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hooks&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;pre-commit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run precommit&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lint-staged&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;*.js&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;prettier --write&quot;</span><span class="punctuation">,</span> <span class="string">&quot;eslint --fix&quot;</span><span class="punctuation">,</span> <span class="string">&quot;git add&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="Git-提交规范—commitlint"><a href="#Git-提交规范—commitlint" class="headerlink" title="Git 提交规范—commitlint"></a>Git 提交规范—commitlint</h3><ul>
<li>文档：<a target="_blank" rel="noopener" href="https://commitlint.js.org/#/">https://commitlint.js.org/#/</a></li>
<li>安装插件 <code>yarn add husky @commitlint/cli @commitlint/config-conventional --dev</code></li>
<li>husky 是一个 Git Hook 工具</li>
<li>项目根目录创建配置文件 commitlint.config.js</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">extends</span>: [<span class="string">&quot;@commitlint/config-conventional&quot;</span>],</span><br><span class="line">  <span class="attr">rules</span>: &#123;</span><br><span class="line">    <span class="string">&quot;subject-case&quot;</span>: [<span class="number">0</span>, <span class="string">&quot;never&quot;</span>],</span><br><span class="line">    <span class="string">&quot;type-enum&quot;</span>: [</span><br><span class="line">      <span class="number">2</span>, <span class="comment">// 代表必须输入</span></span><br><span class="line">      <span class="string">&quot;always&quot;</span>,</span><br><span class="line">      [</span><br><span class="line">        <span class="string">&quot;docs&quot;</span>, <span class="comment">// Adds or alters documentation. 仅仅修改了文档，比如README, CHANGELOG, CONTRIBUTE等等</span></span><br><span class="line">        <span class="string">&quot;chore&quot;</span>, <span class="comment">// Other changes that don&#x27;t modify src or test files. 改变构建流程、或者增加依赖库、工具等</span></span><br><span class="line">        <span class="string">&quot;feat&quot;</span>, <span class="comment">// Adds a new feature. 新增feature</span></span><br><span class="line">        <span class="string">&quot;fix&quot;</span>, <span class="comment">// Solves a bug. 修复bug</span></span><br><span class="line">        <span class="string">&quot;merge&quot;</span>, <span class="comment">// Merge branch ? of ?.</span></span><br><span class="line">        <span class="string">&quot;perf&quot;</span>, <span class="comment">// Improves performance. 优化相关，比如提升性能、体验</span></span><br><span class="line">        <span class="string">&quot;refactor&quot;</span>, <span class="comment">// Rewrites code without feature, performance or bug changes. 代码重构，没有加新功能或者修复bug</span></span><br><span class="line">        <span class="string">&quot;revert&quot;</span>, <span class="comment">// Reverts a previous commit. 回滚到上一个版本</span></span><br><span class="line">        <span class="string">&quot;style&quot;</span>, <span class="comment">// Improves formatting, white-space. 仅仅修改了空格、格式缩进、都好等等，不改变代码逻辑</span></span><br><span class="line">        <span class="string">&quot;test&quot;</span>, <span class="comment">// Adds or modifies tests. 测试用例，包括单元测试、集成测试等</span></span><br><span class="line">      ],</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 package.json 文件，添加一下内容，在执行 <code>git commit -m &quot;commit message&quot;</code> 命令的时候，将会对 commit message 校验，是否符合 rules</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;husky&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;hooks&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;commit-msg&quot;</span>: <span class="string">&quot;commitlint -E HUSKY_GIT_PARAMS&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/25/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">自动化构建工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-25 19:17:34" itemprop="dateCreated datePublished" datetime="2022-10-25T19:17:34+08:00">2022-10-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:22" itemprop="dateModified" datetime="2022-11-08T08:54:22+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="自动化构建"><a href="#自动化构建" class="headerlink" title="自动化构建"></a>自动化构建</h1><h2 id="自动化构建简介"><a href="#自动化构建简介" class="headerlink" title="自动化构建简介"></a>自动化构建简介</h2><p>一切重复工作本应自动化</p>
<ul>
<li>自动化构建（自动化构建工作流）：把开发阶段代码自动转换为生产环境运行的代码&#x2F;程序；</li>
<li>作用：脱离运行环境兼容带来的问题，使用提高效率的语法、规范和标准</li>
<li>自动化构建工具，构建转换那些不被支持的【特性】（sass、ECMAScript next、模板引擎）</li>
</ul>
<h2 id="自动化构建初体验"><a href="#自动化构建初体验" class="headerlink" title="自动化构建初体验"></a>自动化构建初体验</h2><p>NPM Scripts 可以在 NPM Scripts 中定义一些与项目开发过程有关的脚本命令便于后期开发使用</p>
<ul>
<li>使用过程<ul>
<li>在命令行执行<code>yarn init -y</code>生成 package.json 文件</li>
<li>在 package.json 文件添加 scripts 字段，该字段是一个对象，键是 scripts 名称，值是需要执行的命令；scripts 可以自动发现 node_modules 里面的命令，所以不用写完整的路径直接使用命令的名称即可</li>
<li>使用 npm&#x2F;yarn 启动 scripts</li>
<li><code>--watch: scss</code>在工作是会监听文件的变化，scss 文件发生改变时会自动编译</li>
</ul>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sass scss/main.scss css/style.css --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>NPM Scripts 实现自动化构建工作流的最简单方式</li>
</ul>
<p>使用 browser-sync 模块可以开启测试服务器运行项目，在 scripts 中添加命令<code>&quot;serve&quot;: &quot;browser-sync .&quot;</code>运行项目</p>
<p><code>--files &quot;css/*.css&quot;</code> 参数可以让 browser-sync 在启动过后监听项目下文件的变化，browser-sync 会将文件内容自动同步到浏览器，更新浏览器界面</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sass scss/main.scss css/style.css --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;serve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;browser-sync . --files \&quot;css/*.css\&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>在启动 serve 前让 build 工作可以借助 NPM Scripts 钩子机制定义一个 preserve，它可以在 serve 执行前去执行</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sass scss/main.scss css/style.css --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;preserve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yarn build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;serve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;browser-sync . --files \&quot;css/*.css\&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>可以使用<code>npm-run-all</code>模块同时执行多个任务</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sass scss/main.scss css/style.css&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;serve&quot;</span><span class="punctuation">:</span> <span class="string">&quot;browser-sync . --files \&quot;css/*.css\&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;run-p build serve&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h2 id="常用的自动化构建工具"><a href="#常用的自动化构建工具" class="headerlink" title="常用的自动化构建工具"></a>常用的自动化构建工具</h2><ul>
<li>Grunt 最早的构建系统；插件生态完善；工作过程基于临时文件实现所以构建速度较慢，如使用它完成 scss 文件构建，我们会先对 scss 文件进行编译工作，自动添加属性前缀，压缩代码，Grunt 每一步都有磁盘读写操作，处理环节越多，磁盘的读写越多；大型项目中速度会非常慢</li>
<li>Gulp 可以解决 Grunt 中构建速度慢的问题，他基于内存实现的，对文件的读写都是基于内存完成的，相对与磁盘读写就快了；支持同时执行多个任务效率高；使用方式相对于 Grunt 更直观易懂；插件生态完善</li>
<li>FIS 微内核；更像是一种捆绑套餐，把项目中典型的需求尽可能集成在内部</li>
</ul>
<h1 id="Grunt"><a href="#Grunt" class="headerlink" title="Grunt"></a>Grunt</h1><h2 id="Grunt-的基本使用"><a href="#Grunt-的基本使用" class="headerlink" title="Grunt 的基本使用"></a>Grunt 的基本使用</h2><ul>
<li>项目命令行输入 <code>yarn init -y</code> 生成 package.json 文件</li>
<li>安装 grunt <code>yarn add grunt</code></li>
<li>项目根目录创建 gruntfile.js 文件，该文件是 Grunt 入口文件，用于定义一些需要 Grunt 自动执行的任务，需要导出一个函数，此函数接收一个 grunt 的形参，内部提供一些创建任务时可以用到的 API</li>
<li>最后使用 <code>yanr grunt taskName</code> 执行任务</li>
</ul>
<p>使用 grunt.registerTask() 方法注册一个任务</p>
<ul>
<li>第一个参数为任务名称，如果任务名称为 default，该任务将作为默认任务，运行时不用指定任务名，Grunt 将自动调用 default</li>
<li>第二个参数<ul>
<li>第二个参数是字符串时，该字符串将是任务的描述，命令行输入 <code>yarn grunt --help</code> 可以看到该信息；</li>
<li>一般会使用 default 任务映射一些其他的任务，其他的任务将作为第二个参数，参数是数组，元素为任务名，当执行 default 任务时 Grunt 会依次执行数组中的任务；</li>
<li>当第二个参数为函数时，将制定任务函数，任务发生时自动执行函数</li>
</ul>
</li>
<li>异步任务：需要使用 this.async() 方法得到一个回调函数，在异步回调函数完成后调用这个函数标识任务已经完成</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Grunt 的入口文件</span></span><br><span class="line"><span class="comment">// 用于定义一些需要 Grunt 自动执行的任务</span></span><br><span class="line"><span class="comment">// 需要导出一个函数</span></span><br><span class="line"><span class="comment">// 此函数接收一个 grunt 的对象类型的形参</span></span><br><span class="line"><span class="comment">// grunt 对象中提供一些创建任务时会用到的 API</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;a sample task&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hello grunt&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;bar&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;other task&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// // default 是默认任务名称</span></span><br><span class="line">  <span class="comment">// // 通过 grunt 执行时可以省略</span></span><br><span class="line">  <span class="comment">// grunt.registerTask(&#x27;default&#x27;, () =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   console.log(&#x27;default task&#x27;)</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 第二个参数可以指定此任务的映射任务，</span></span><br><span class="line">  <span class="comment">// 这样执行 default 就相当于执行对应的任务</span></span><br><span class="line">  <span class="comment">// 这里映射的任务会按顺序依次执行，不会同步执行</span></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;default&quot;</span>, [<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 也可以在任务函数中执行其他任务</span></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;run-other&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// foo 和 bar 会在当前任务执行完成过后自动依次执行</span></span><br><span class="line">    grunt.<span class="property">task</span>.<span class="title function_">run</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;current task runing~&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认 grunt 采用同步模式编码</span></span><br><span class="line">  <span class="comment">// 如果需要异步可以使用 this.async() 方法创建回调函数</span></span><br><span class="line">  <span class="comment">// grunt.registerTask(&#x27;async-task&#x27;, () =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//   setTimeout(() =&gt; &#123;</span></span><br><span class="line">  <span class="comment">//     console.log(&#x27;async task working~&#x27;)</span></span><br><span class="line">  <span class="comment">//   &#125;, 1000)</span></span><br><span class="line">  <span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 由于函数体中需要使用 this，所以这里不能使用箭头函数</span></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;async-task&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> done = <span class="variable language_">this</span>.<span class="title function_">async</span>();</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async task working~&quot;</span>);</span><br><span class="line">      <span class="title function_">done</span>();</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Grunt-标记任务失败"><a href="#Grunt-标记任务失败" class="headerlink" title="Grunt 标记任务失败"></a>Grunt 标记任务失败</h2><p>在 grunt.registerTask() 任务函数 return false，在命令行执行该任务时将会提示执行失败，在任务列表中会导致后面的任务无法执行，在执行任务时添加 –force 命令，将会强制执行所有的任务 <code>yarn grunt --force</code>，在异步任务中无法通过 return false 来标记失败，要给异步的回调函数指定 false 实参就可以标记失败了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;foo&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hello grunt~&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;bar&quot;</span>, <span class="string">&quot;任务描述&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;other task~&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;bad-async&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> done = <span class="variable language_">this</span>.<span class="title function_">async</span>();</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async task working~&quot;</span>);</span><br><span class="line">      <span class="title function_">done</span>(<span class="literal">false</span>); <span class="comment">// 出入实参false标识异步任务失败</span></span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;bad&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;bad working~&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;default&quot;</span>, [<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bad&quot;</span>, <span class="string">&quot;bar&quot;</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Grunt-的配置方法"><a href="#Grunt-的配置方法" class="headerlink" title="Grunt 的配置方法"></a>Grunt 的配置方法</h2><ul>
<li>通过 grunt.initConfig() 方法为任务添加一些配置项</li>
<li>grunt.initConfig() 参数为一个对象，键一般对应任务的名，值可以是任意类型的数据</li>
<li>在 grunt.registerTask() 中可以通过 grunt.config() 获取配置，如果配置中的属性值是对象的话，config 可以使用点的方式定位对象中的属性值</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// grunt.initConfig() 用于为任务添加一些配置选项</span></span><br><span class="line">  grunt.<span class="title function_">initConfig</span>(&#123;</span><br><span class="line">    <span class="comment">// 键一般对应任务的名称</span></span><br><span class="line">    <span class="comment">// 值可以是任意类型的数据</span></span><br><span class="line">    <span class="attr">foo</span>: &#123;</span><br><span class="line">      <span class="attr">bar</span>: <span class="string">&quot;baz&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;foo&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 任务中可以使用 grunt.config() 获取配置</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(grunt.<span class="title function_">config</span>(<span class="string">&quot;foo&quot;</span>));</span><br><span class="line">    <span class="comment">// 如果属性值是对象的话，config 中可以使用点的方式定位对象中属性的值</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(grunt.<span class="title function_">config</span>(<span class="string">&quot;foo.bar&quot;</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Grunt-多目标任务（子任务）"><a href="#Grunt-多目标任务（子任务）" class="headerlink" title="Grunt 多目标任务（子任务）"></a>Grunt 多目标任务（子任务）</h2><ul>
<li>grunt.registerMultiTask()<ul>
<li>通过 grunt.registerMultiTask() 定义多目标</li>
<li>多目标模式，可以让任务根据配置形成多个子任务</li>
<li>grunt.registerMultiTask() 第一个参数是任务的名字，第二个参数是任务执行过程要做的事情</li>
<li>多任务，要使用 grunt.initConfig()为任务配置目标</li>
<li>当运行任务时会去执行目标（子任务），如果要运行指定的目标可以使用“:目标名”，yarn grunt build:css</li>
<li>可以通过 this.target 拿到当前执行的目标名称，通过 this.data 拿到目标的配置数据</li>
<li>可以通过 this.options()方法拿到配置选项</li>
</ul>
</li>
<li>grunt.initConfig()<ul>
<li>参数为对象，键名与任务名相同(registerMultiTask()方法的第一个参数)，值必须为对象，对象中每个属性名就是目标名称</li>
<li>除了 options 键，其他都会作为目标，options 指定的信息会作为这个任务的配置选项</li>
<li>目标当中也可以添加 options，运行目标是可以获取相应的 options（目标 options 覆盖任务 options），如果目标没指定而任务指定了则可以获取任务的 options</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  grunt.<span class="title function_">initConfig</span>(&#123;</span><br><span class="line">    <span class="attr">build</span>: &#123;</span><br><span class="line">      <span class="comment">// ‘build’名与</span></span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">foo</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">css</span>: &#123;</span><br><span class="line">        <span class="attr">options</span>: &#123;</span><br><span class="line">          <span class="attr">foo</span>: <span class="string">&quot;baz&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">js</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  grunt.<span class="title function_">registerMultiTask</span>(<span class="string">&quot;build&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="title function_">options</span>());</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`task: <span class="subst">$&#123;<span class="variable language_">this</span>.target&#125;</span>, data:<span class="subst">$&#123;<span class="variable language_">this</span>.data&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Grunt-插件的使用"><a href="#Grunt-插件的使用" class="headerlink" title="Grunt 插件的使用"></a>Grunt 插件的使用</h2><ul>
<li>通过 npm 安装</li>
<li>在 gruntfile.js 文件中通过 grunt.loadNpmTasks() 方法把插件中提供的任务加载进来，根据插件文档配置</li>
<li>在 grunt.initConfig() 方法中为任务添加配置选项</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除文件的任务</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  grunt.<span class="title function_">initConfig</span>(&#123;</span><br><span class="line">    <span class="attr">clean</span>: &#123;</span><br><span class="line">      <span class="comment">// temp:&#x27;temp/app.js&#x27; // 需要清除的文件，可以使用通配符&quot;*&quot;，“**”表示找到该目录下的文件以及子目录的文件（即该目录下的所有文件）</span></span><br><span class="line">      <span class="attr">temp</span>: <span class="string">&quot;temp/*.txt&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过 loadNpmTasks 加载插件中提供的任务</span></span><br><span class="line">  grunt.<span class="title function_">loadNpmTasks</span>(<span class="string">&quot;grunt-contrib-clean&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Grunt-常用插件及总结"><a href="#Grunt-常用插件及总结" class="headerlink" title="Grunt 常用插件及总结"></a>Grunt 常用插件及总结</h2><ul>
<li>grunt-sass<ul>
<li>安装 <code>yarn grunt-sass sass --dev</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sass = <span class="built_in">require</span>(<span class="string">&quot;sass&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  grunt.<span class="title function_">initConfig</span>(&#123;</span><br><span class="line">    <span class="attr">sass</span>: &#123;</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">implementation</span>: sass,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">main</span>: &#123;</span><br><span class="line">        <span class="comment">// 目标main(随便写)</span></span><br><span class="line">        <span class="attr">files</span>: &#123;</span><br><span class="line">          <span class="string">&quot;dist/css/main.css&quot;</span>: <span class="string">&quot;src/scss/main.scss&quot;</span>, <span class="comment">// 键是输出文件，值是输入文件</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 通过 loadNpmTasks 加载插件中提供的任务</span></span><br><span class="line">  grunt.<span class="title function_">loadNpmTasks</span>(<span class="string">&quot;grunt-sass&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>load-grunt-tasks<br>自动加载所有的 grunt 插件<ul>
<li>安装 <code>yarn add load-grunt-tasks --dev</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loadGruntTasks = <span class="built_in">require</span>(<span class="string">&quot;load-grunt-tasks&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// grunt.loadNpmTasks(&#x27;grunt-sass&#x27;)</span></span><br><span class="line">  <span class="title function_">loadGruntTasks</span>(grunt); <span class="comment">// 自动加载所有的 grunt 插件中的任务</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>babel<ul>
<li>安装 <code>yarn add grunt-babel @babel/core @babel/preset-env --dev</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sass = <span class="built_in">require</span>(<span class="string">&quot;sass&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> loadGruntTasks = <span class="built_in">require</span>(<span class="string">&quot;load-grunt-tasks&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  grunt.<span class="title function_">initConfig</span>(&#123;</span><br><span class="line">    <span class="attr">sass</span>: &#123;</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">implementation</span>: sass,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">main</span>: &#123;</span><br><span class="line">        <span class="comment">// 目标main(随便写)</span></span><br><span class="line">        <span class="attr">files</span>: &#123;</span><br><span class="line">          <span class="string">&quot;dist/css/main.css&quot;</span>: <span class="string">&quot;src/scss/main.scss&quot;</span>, <span class="comment">// 键是输出文件，值是输入文件</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">babel</span>: &#123;</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">sourceMap</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">main</span>: &#123;</span><br><span class="line">        <span class="attr">files</span>: &#123;</span><br><span class="line">          <span class="string">&quot;dist/js/app.js&quot;</span>: <span class="string">&quot;src/js/app.js&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// grunt.loadNpmTasks(&#x27;grunt-sass&#x27;)</span></span><br><span class="line">  <span class="title function_">loadGruntTasks</span>(grunt); <span class="comment">// 自动加载所有的 grunt 插件中的任务</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>grunt-contrib-watch 自动编译<ul>
<li>安装 <code>yarn add grunt-contrib-watch --dev</code></li>
<li>执行 <code>yarn grunt watch</code>，当监听的文件发生变化的时候会执行相应的任务，但是刚开始的时候不会执行，可以使用 grunt.registerTask() 方法，执行<code>yarn grunt</code></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sass = <span class="built_in">require</span>(<span class="string">&quot;sass&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> loadGruntTasks = <span class="built_in">require</span>(<span class="string">&quot;load-grunt-tasks&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">grunt</span>) =&gt;</span> &#123;</span><br><span class="line">  grunt.<span class="title function_">initConfig</span>(&#123;</span><br><span class="line">    <span class="attr">sass</span>: &#123;</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">implementation</span>: sass,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">main</span>: &#123;</span><br><span class="line">        <span class="comment">// 目标main(随便写)</span></span><br><span class="line">        <span class="attr">files</span>: &#123;</span><br><span class="line">          <span class="string">&quot;dist/css/main.css&quot;</span>: <span class="string">&quot;src/scss/main.scss&quot;</span>, <span class="comment">// 键是输出文件，值是输入文件</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">babel</span>: &#123;</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">sourceMap</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">main</span>: &#123;</span><br><span class="line">        <span class="attr">files</span>: &#123;</span><br><span class="line">          <span class="string">&quot;dist/js/app.js&quot;</span>: <span class="string">&quot;src/js/app.js&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">watch</span>: &#123;</span><br><span class="line">      <span class="attr">js</span>: &#123;</span><br><span class="line">        <span class="attr">files</span>: [<span class="string">&quot;src/js/*.js&quot;</span>], <span class="comment">// 监听的文件</span></span><br><span class="line">        <span class="attr">tasks</span>: [<span class="string">&quot;babel&quot;</span>], <span class="comment">// 当文件发生改变要执行什么任务</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">css</span>: &#123;</span><br><span class="line">        <span class="attr">files</span>: [<span class="string">&quot;src/scss/*.scss&quot;</span>], <span class="comment">// 监听的文件</span></span><br><span class="line">        <span class="attr">tasks</span>: [<span class="string">&quot;sass&quot;</span>], <span class="comment">// 当文件发生改变要执行什么任务</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// grunt.loadNpmTasks(&#x27;grunt-sass&#x27;)</span></span><br><span class="line">  <span class="title function_">loadGruntTasks</span>(grunt); <span class="comment">// 自动加载所有的 grunt 插件中的任务</span></span><br><span class="line">  grunt.<span class="title function_">registerTask</span>(<span class="string">&quot;default&quot;</span>, [<span class="string">&quot;sass&quot;</span>, <span class="string">&quot;babel&quot;</span>, <span class="string">&quot;watch&quot;</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="Gulp"><a href="#Gulp" class="headerlink" title="Gulp"></a>Gulp</h1><h2 id="Gulp-的基本使用"><a href="#Gulp-的基本使用" class="headerlink" title="Gulp 的基本使用"></a>Gulp 的基本使用</h2><ul>
<li>执行 <code>yarn init -y</code></li>
<li>安装 <code>yarn add gulp --dev</code></li>
<li>在根目录新建 gulpfile.js，此文件作为 gulp 入口文件</li>
<li>导出函数，导出的函数都会作为 gulp 任务</li>
<li>gulp 的任务函数都是异步的，可以通过调用回调函数标识任务完成</li>
<li>default 是默认任务，在运行是可以省略任务名参数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gulp入口文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出的函数都会作为 gulp 任务</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">foo</span> = <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// gulp 的任务函数都是异步的</span></span><br><span class="line">  <span class="comment">// 可以通过调用回调函数标识任务完成</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo task working~&quot;</span>);</span><br><span class="line">  <span class="title function_">done</span>(); <span class="comment">// 标识任务执行完成</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// default 是默认任务</span></span><br><span class="line"><span class="comment">// 在运行是可以省略任务名参数</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">default</span> = <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;default task working~&quot;</span>);</span><br><span class="line">  <span class="title function_">done</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-的组合任务"><a href="#Gulp-的组合任务" class="headerlink" title="Gulp 的组合任务"></a>Gulp 的组合任务</h2><p><code>series()</code>,<code>parallel()</code> 可以创建并行任务和串行任务</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; series, parallel &#125; = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以没导出的理解为私有任务</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">task1</span> = (<span class="params">done</span>) =&gt; &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;task1 working~&quot;</span>);</span><br><span class="line">    <span class="title function_">done</span>();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">task2</span> = (<span class="params">done</span>) =&gt; &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;task2 working~&quot;</span>);</span><br><span class="line">    <span class="title function_">done</span>();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">task3</span> = (<span class="params">done</span>) =&gt; &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;task3 working~&quot;</span>);</span><br><span class="line">    <span class="title function_">done</span>();</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">foo</span> = <span class="title function_">series</span>(task1, task2, task3); <span class="comment">// // 让多个任务按照顺序依次执行</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">bar</span> = <span class="title function_">parallel</span>(task1, task2, task3); <span class="comment">// // 让多个任务同时执行</span></span><br></pre></td></tr></table></figure>

<h2 id="Gulp-的异步任务"><a href="#Gulp-的异步任务" class="headerlink" title="Gulp 的异步任务"></a>Gulp 的异步任务</h2><ul>
<li>回调函数<ul>
<li>gulp 的任务为异步，异步函数无法知道是否执行完成，可以通过回调解决（done），任务执行完后调用回调函数通知 gulp 任务执行完成</li>
<li>回调函数叫做一种错误优先的回调函数，在执行过程中报错，阻止剩下任务执行可以通过给回调函数的第一个参数指定一个错误对象</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">callback_error</span> = <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;callback task~&quot;</span>);</span><br><span class="line">  <span class="title function_">done</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;task failed!&quot;</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>promise<ul>
<li>使用 promise 通知任务执行完成</li>
<li>任务中返回一个 Promise 对象，如果 resolve 意味着任务结束了，不需要返回任何的值，如果 reject，gulp 会认为是一个失败任务结束后续任务的执行</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.<span class="property">promise</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise task~&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">promise</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise task~&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;task failed~&quot;</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>async await</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">timeout</span> = (<span class="params">time</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(resolve, time);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">exports</span>.<span class="property">async</span> = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">timeout</span>(<span class="number">1000</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async task~&quot;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>stream</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exports.stream = () =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     const readStream = fs.createReadStream(&#x27;package.json&#x27;)</span></span><br><span class="line"><span class="comment">//     const writeStream = fs.createWriteStream(&#x27;temp.txt&#x27;)</span></span><br><span class="line"><span class="comment">//     readStream.pipe(writeStream)</span></span><br><span class="line"><span class="comment">//     return readStream</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">stream</span> = <span class="function">(<span class="params">done</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> readStream = fs.<span class="title function_">createReadStream</span>(<span class="string">&quot;package.json&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&quot;temp.txt&quot;</span>);</span><br><span class="line">  readStream.<span class="title function_">pipe</span>(writeStream);</span><br><span class="line">  readStream.<span class="title function_">on</span>(<span class="string">&quot;end&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">done</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-构建过程核心工作原理"><a href="#Gulp-构建过程核心工作原理" class="headerlink" title="Gulp 构建过程核心工作原理"></a>Gulp 构建过程核心工作原理</h2><ul>
<li>工作过程：输入(读取流) &#x3D;&gt; 加工(转换流) &#x3D;&gt; 输出(写入流)</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Transform</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;stream&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">default</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 文件读取流</span></span><br><span class="line">  <span class="keyword">const</span> read = fs.<span class="title function_">createReadStream</span>(<span class="string">&quot;normalize.css&quot;</span>);</span><br><span class="line">  <span class="comment">// 文件写入流</span></span><br><span class="line">  <span class="keyword">const</span> write = fs.<span class="title function_">createWriteStream</span>(<span class="string">&quot;normalize.min.css&quot;</span>);</span><br><span class="line">  <span class="comment">// 文件转换流</span></span><br><span class="line">  <span class="keyword">const</span> transform = <span class="keyword">new</span> <span class="title class_">Transform</span>(&#123;</span><br><span class="line">    <span class="attr">transform</span>: <span class="function">(<span class="params">chunk, encoding, callback</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 核心转换过程</span></span><br><span class="line">      <span class="comment">// chunk =&gt; 读取流中读取到的内容（Buffer）</span></span><br><span class="line">      <span class="keyword">const</span> input = chunk.<span class="title function_">toString</span>();</span><br><span class="line">      <span class="comment">// 替换空格、注释（压缩代码）</span></span><br><span class="line">      <span class="keyword">const</span> output = input.<span class="title function_">replace</span>(<span class="regexp">/\s+/g</span>, <span class="string">&quot;&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/\/\*.+?\*\//g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">      <span class="comment">// 把内容传出</span></span><br><span class="line">      <span class="title function_">callback</span>(<span class="literal">null</span>, output); <span class="comment">// 错误优先的回调函数</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 把读取出来的文件流导入写入文件流</span></span><br><span class="line">  read</span><br><span class="line">    .<span class="title function_">pipe</span>(transform) <span class="comment">// 转换</span></span><br><span class="line">    .<span class="title function_">pipe</span>(write); <span class="comment">// 写入</span></span><br><span class="line">  <span class="keyword">return</span> read;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-文件操作-API"><a href="#Gulp-文件操作-API" class="headerlink" title="Gulp 文件操作 API"></a>Gulp 文件操作 API</h2><ul>
<li>src：读取流，方法参数为文件路径，可以使用通配符匹配所以的文件</li>
<li>dest：写入流</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; src, dest &#125; = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> cleanCss = <span class="built_in">require</span>(<span class="string">&quot;gulp-clean-css&quot;</span>); <span class="comment">// 压缩代码转换流模块</span></span><br><span class="line"><span class="keyword">const</span> rename = <span class="built_in">require</span>(<span class="string">&quot;gulp-rename&quot;</span>); <span class="comment">// 重命名扩展名模块</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">default</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// gulp读取流 和 写入流，可以使用统配符</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/*.css&quot;</span>)</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">cleanCss</span>())</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">rename</span>(&#123; <span class="attr">extname</span>: <span class="string">&quot;.min.css&quot;</span> &#125;)) <span class="comment">// 指定重命名的扩展名</span></span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-样式编译"><a href="#Gulp-案例-样式编译" class="headerlink" title="Gulp 案例 - 样式编译"></a>Gulp 案例 - 样式编译</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; src, dest &#125; = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该依赖会把下划线文件名的文件认为是主文件中依赖的文件，所以不会吧下划线文件名的文件转换</span></span><br><span class="line"><span class="keyword">const</span> sass = <span class="built_in">require</span>(<span class="string">&quot;gulp-sass&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">style</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// base 基准路径，会把src后面的路径保留下来，否则不会按照原本路径输出</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/styles/*.scss&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">sass</span>(&#123; <span class="attr">outputStyle</span>: <span class="string">&quot;expanded&quot;</span> &#125;)) <span class="comment">// outputStyle编译后“&#125;”位于后面</span></span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  style,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-脚本编译"><a href="#Gulp-案例-脚本编译" class="headerlink" title="Gulp 案例 - 脚本编译"></a>Gulp 案例 - 脚本编译</h2><p>安装 babel 依赖 <code>yarn add babel @babel/core @babel/preset-env --dev</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; src, dest &#125; = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&quot;gulp-babel&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">script</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// base 基准路径，会把src后面的路径保留下来，否则不会按照原本路径输出</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/scripts/*.js&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">babel</span>(&#123; <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>] &#125;)) <span class="comment">// 如果不添加presets转换无效</span></span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  script,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-页面模板编译"><a href="#Gulp-案例-页面模板编译" class="headerlink" title="Gulp 案例 - 页面模板编译"></a>Gulp 案例 - 页面模板编译</h2><p>安装 swig 模板引擎转换插件 <code>yarn add gulp-swig --dev</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> swig = <span class="built_in">require</span>(<span class="string">&quot;gulp-swig&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  <span class="attr">menus</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;Home&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;aperture&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;index.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;Features&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;features.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;About&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;about.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;Contact&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;#&quot;</span>,</span><br><span class="line">      <span class="attr">children</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;Twitter&quot;</span>,</span><br><span class="line">          <span class="attr">link</span>: <span class="string">&quot;https://twitter.com/w_zce&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;About&quot;</span>,</span><br><span class="line">          <span class="attr">link</span>: <span class="string">&quot;https://weibo.com/zceme&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;divider&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;About&quot;</span>,</span><br><span class="line">          <span class="attr">link</span>: <span class="string">&quot;https://github.com/zce&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">pkg</span>: <span class="built_in">require</span>(<span class="string">&quot;./package.json&quot;</span>),</span><br><span class="line">  <span class="attr">date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">page</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 如果存在子目录：&#x27;src/**/*.html&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="title function_">src</span>(<span class="string">&quot;src/*.html&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">      <span class="comment">// data 把数据传入到模板中，渲染对应的数据</span></span><br><span class="line">      <span class="comment">// cache 防止模板缓存导致页面不能及时更新</span></span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">swig</span>(&#123; data, <span class="attr">defaults</span>: &#123; <span class="attr">cache</span>: <span class="literal">false</span> &#125; &#125;))</span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  page,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-图片和字体文件转换"><a href="#Gulp-案例-图片和字体文件转换" class="headerlink" title="Gulp 案例 - 图片和字体文件转换"></a>Gulp 案例 - 图片和字体文件转换</h2><p>安装图片压缩转换插件 <code>yarn add gulp-imagemin --dev</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> imagemin = <span class="built_in">require</span>(<span class="string">&quot;gulp-imagemin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">image</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/images/**&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">imagemin</span>())</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">font</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/fonts/**&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">imagemin</span>())</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-其他文件及文件清除"><a href="#Gulp-案例-其他文件及文件清除" class="headerlink" title="Gulp 案例 - 其他文件及文件清除"></a>Gulp 案例 - 其他文件及文件清除</h2><p>打包是自动删除 dist 文件目录，安装插件 <code>yarn add del --dev</code>，这个模块不是 gulp 的插件，只是可以在 gulp 中使用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> del = <span class="built_in">require</span>(<span class="string">&quot;del&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">extra</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 转换其他文件</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;public/**&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;public&quot;</span> &#125;).<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clean</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">del</span>([<span class="string">&quot;dist&quot;</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-自动加载插件"><a href="#Gulp-案例-自动加载插件" class="headerlink" title="Gulp 案例 - 自动加载插件"></a>Gulp 案例 - 自动加载插件</h2><p>安装插件 <code>yarn add gulp-load-plugins --dev</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loadPlugins = <span class="built_in">require</span>(<span class="string">&quot;gulp-load-plugins&quot;</span>);</span><br><span class="line"><span class="comment">// 自动加载所有的插件</span></span><br><span class="line"><span class="keyword">const</span> plugins = <span class="title function_">loadPlugins</span>(); <span class="comment">// 把‘gulp-’去掉，如果后面有多个‘-’会变为驼峰命名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">style</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// base 基准路径，会把src后面的路径保留下来，否则不会按照原本路径输出</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/styles/*.scss&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(plugins.<span class="title function_">sass</span>(&#123; <span class="attr">outputStyle</span>: <span class="string">&quot;expanded&quot;</span> &#125;)) <span class="comment">// 使用plugins.sass</span></span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-开发服务器"><a href="#Gulp-案例-开发服务器" class="headerlink" title="Gulp 案例 - 开发服务器"></a>Gulp 案例 - 开发服务器</h2><p>热更新开发服务器<br>安装模块 <code>yarn add browser-sync --dev</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browserSync = <span class="built_in">require</span>(<span class="string">&quot;browser-sync&quot;</span>);</span><br><span class="line"><span class="comment">// 创建服务器</span></span><br><span class="line"><span class="keyword">const</span> bs = browserSync.<span class="title function_">create</span>();</span><br><span class="line"><span class="comment">// 服务任务</span></span><br><span class="line"><span class="comment">// 此时dist文件目录的样式指向node_modules，需要修改配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">serve</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  bs.<span class="title function_">init</span>(&#123;</span><br><span class="line">    <span class="attr">notify</span>: <span class="literal">false</span>, <span class="comment">// 关闭notify提示</span></span><br><span class="line">    <span class="attr">port</span>: <span class="number">8080</span>, <span class="comment">// 端口</span></span><br><span class="line">    <span class="comment">// open: false, // 是否自动打开浏览器</span></span><br><span class="line">    <span class="attr">files</span>: <span class="string">&quot;dist/**&quot;</span>, <span class="comment">// browserSync服务监听的路径通配符，文件发生改变自动刷新浏览器</span></span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">      <span class="attr">baseDir</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">      <span class="attr">routes</span>: &#123;</span><br><span class="line">        <span class="comment">// 优先于baseDir，请求发生后会先看routes是否有对应的配置，如果有就走routes配置，否则就走baseDir对应的文件</span></span><br><span class="line">        <span class="string">&quot;/node_modules&quot;</span>: <span class="string">&quot;node_modules&quot;</span>, <span class="comment">// 键是请求的前缀</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-监视变化以及构建优化"><a href="#Gulp-案例-监视变化以及构建优化" class="headerlink" title="Gulp 案例 - 监视变化以及构建优化"></a>Gulp 案例 - 监视变化以及构建优化</h2><p>使用 gulp 提供的 watch()方法，第一个参数是监听的文件，第二个参数是执行任务</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; watch &#125; = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>);</span><br><span class="line"><span class="comment">// 服务任务</span></span><br><span class="line"><span class="comment">// 此时dist文件目录的样式指向node_modules，使用路由映射</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">serve</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">watch</span>(<span class="string">&quot;src/assets/styles/*.scss&quot;</span>, style);</span><br><span class="line">  <span class="title function_">watch</span>(<span class="string">&quot;src/assets/scripts/*.js&quot;</span>, script);</span><br><span class="line">  <span class="title function_">watch</span>(<span class="string">&quot;src/*.html&quot;</span>, page);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开发阶段对图片、字体不构建，提高构建效率</span></span><br><span class="line">  <span class="comment">// watch(&#x27;src/assets/images/**&#x27;, image)</span></span><br><span class="line">  <span class="comment">// watch(&#x27;src/assets/fonts/**&#x27;, font)</span></span><br><span class="line">  <span class="comment">// watch(&#x27;public/**&#x27;, extra)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件变化后自动更新浏览器，浏览器重新发起请求</span></span><br><span class="line">  <span class="title function_">watch</span>(</span><br><span class="line">    [<span class="string">&quot;src/assets/images/**&quot;</span>, <span class="string">&quot;src/assets/fonts/**&quot;</span>, <span class="string">&quot;public/**&quot;</span>],</span><br><span class="line">    bs.<span class="property">reload</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  bs.<span class="title function_">init</span>(&#123;</span><br><span class="line">    <span class="attr">notify</span>: <span class="literal">false</span>, <span class="comment">// 关闭notify提示</span></span><br><span class="line">    <span class="attr">port</span>: <span class="number">8080</span>, <span class="comment">// 端口</span></span><br><span class="line">    <span class="comment">// open: false, // 是否自动打开浏览器</span></span><br><span class="line">    <span class="attr">files</span>: <span class="string">&quot;dist/**&quot;</span>, <span class="comment">// browserSync服务监听的路径通配符，文件发生改变自动刷新浏览器</span></span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">      <span class="attr">baseDir</span>: [<span class="string">&quot;dist&quot;</span>, <span class="string">&quot;src&quot;</span>, <span class="string">&quot;public&quot;</span>], <span class="comment">// 如果资源在dist找不到就到src找，还找不到就到public找</span></span><br><span class="line">      <span class="attr">routes</span>: &#123;</span><br><span class="line">        <span class="comment">// 优先于baseDir，请求发生后会先看routes是否有对应的配置，如果有就走routes配置，否则就走baseDir对应的文件</span></span><br><span class="line">        <span class="string">&quot;/node_modules&quot;</span>: <span class="string">&quot;node_modules&quot;</span>, <span class="comment">// 键是请求的前缀</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-useref-文件引用处理"><a href="#Gulp-案例-useref-文件引用处理" class="headerlink" title="Gulp 案例 - useref 文件引用处理"></a>Gulp 案例 - useref 文件引用处理</h2><p>安装 <code>yarn add gulp-useref --dev</code></p>
<p>把 HTML 文件中的构建注释去除、把构建注释中的内容合并到一个文件（比如上边提到的引用了 node_modules 目录中的文件）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">useref</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="title function_">src</span>(<span class="string">&quot;dist/*.html&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;dist&quot;</span> &#125;)</span><br><span class="line">      <span class="comment">// 去除HTML文件构建注释、把构建注释的内容合并到一个文件中</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">useref</span>(&#123; <span class="attr">searchPath</span>: [<span class="string">&quot;dist&quot;</span>, <span class="string">&quot;.&quot;</span>] &#125;))</span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>))</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-文件压缩"><a href="#Gulp-案例-文件压缩" class="headerlink" title="Gulp 案例 - 文件压缩"></a>Gulp 案例 - 文件压缩</h2><p>对 html、js、css 压缩</p>
<p>安装插件 <code>yarn add gulp-htmlmin gulp-uglify gulp-clean-css --dev</code></p>
<p>判断读取流的文件使用对应的压缩插件，安装 <code>yarn add gulp-if --dev</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">useref</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="title function_">src</span>(<span class="string">&quot;dist/*.html&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;dist&quot;</span> &#125;)</span><br><span class="line">      <span class="comment">// 去除HTML文件构建注释、把构建注释的内容合并到一个文件中</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">useref</span>(&#123; <span class="attr">searchPath</span>: [<span class="string">&quot;dist&quot;</span>, <span class="string">&quot;.&quot;</span>] &#125;))</span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">if</span>(<span class="regexp">/\.js$/</span>, plugins.<span class="title function_">uglify</span>())) <span class="comment">// 压缩js</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">if</span>(<span class="regexp">/\.css$/</span>, plugins.<span class="title function_">cleanCss</span>())) <span class="comment">// 压缩css</span></span><br><span class="line">      .<span class="title function_">pipe</span>(</span><br><span class="line">        plugins.<span class="title function_">if</span>(</span><br><span class="line">          <span class="regexp">/\.html$/</span>,</span><br><span class="line">          plugins.<span class="title function_">htmlmin</span>(&#123;</span><br><span class="line">            <span class="attr">collapseWhitespace</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">minifyCSS</span>: <span class="literal">true</span>, <span class="comment">// 把html文件中的style压缩</span></span><br><span class="line">            <span class="attr">minifyJS</span>: <span class="literal">true</span>, <span class="comment">// 把script中的js压缩</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      ) <span class="comment">// 压缩html</span></span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;release&quot;</span>))</span><br><span class="line">  ); <span class="comment">// 写入到另外一个文件，防止读、写同一个文件引发错乱</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-重新规划构建过程"><a href="#Gulp-案例-重新规划构建过程" class="headerlink" title="Gulp 案例 - 重新规划构建过程"></a>Gulp 案例 - 重新规划构建过程</h2><p>因为 useref 任务导致项目目录结构发生改变，所以构建时先把 html、css、js 文件放到一个临时目录中，开启的服务读取文件也是读取临时目录中的文件；在 useref 任务中把临时目录中的 html、css、js 取出压缩放进最终目录（dist）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/ 转换样式</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">style</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// base 基准路径，会把src后面的路径保留下来，否则不会按照原本路径输出</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&#x27;src/assets/styles/*.scss&#x27;</span>, &#123; <span class="attr">base</span>: <span class="string">&#x27;src&#x27;</span> &#125;)</span><br><span class="line">        .<span class="title function_">pipe</span>(plugins.<span class="title function_">sass</span>(&#123; <span class="attr">outputStyle</span>: <span class="string">&#x27;expanded&#x27;</span> &#125;)) <span class="comment">// outputStyle编译后“&#125;”位于后面</span></span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&#x27;temp&#x27;</span>))</span><br><span class="line">        .<span class="title function_">page</span>(bs.<span class="title function_">reload</span>(&#123; <span class="attr">stream</span>: <span class="literal">true</span> &#125;)) <span class="comment">// 把信息以流的方法推到浏览器</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换脚本</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">script</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&#x27;src/assets/scripts/*.js&#x27;</span>, &#123; <span class="attr">base</span>: <span class="string">&#x27;src&#x27;</span> &#125;)</span><br><span class="line">        .<span class="title function_">pipe</span>(plugins.<span class="title function_">babel</span>(&#123; <span class="attr">presets</span>: [<span class="string">&#x27;@babel/preset-env&#x27;</span>] &#125;))</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&#x27;temp&#x27;</span>))</span><br><span class="line">        .<span class="title function_">page</span>(bs.<span class="title function_">reload</span>(&#123; <span class="attr">stream</span>: <span class="literal">true</span> &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换模板</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">page</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果存在子目录：&#x27;src/**/*.html&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&#x27;src/*.html&#x27;</span>, &#123; <span class="attr">base</span>: <span class="string">&#x27;src&#x27;</span> &#125;)</span><br><span class="line">        <span class="comment">// data 把数据传入到模板中，渲染对应的数据</span></span><br><span class="line">        <span class="comment">// cache 防止模板缓存导致页面不能及时更新</span></span><br><span class="line">        .<span class="title function_">pipe</span>(plugins.<span class="title function_">swig</span>(&#123; data, <span class="attr">defaults</span>: &#123; <span class="attr">cache</span>: <span class="literal">false</span> &#125; &#125;))</span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&#x27;temp&#x27;</span>))</span><br><span class="line">        .<span class="title function_">page</span>(bs.<span class="title function_">reload</span>(&#123; <span class="attr">stream</span>: <span class="literal">true</span> &#125;))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useref</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&#x27;temp/*.html&#x27;</span>, &#123; <span class="attr">base</span>: <span class="string">&#x27;temp&#x27;</span> &#125;)</span><br><span class="line">        <span class="comment">// 去除HTML文件构建注释、把构建注释的内容合并到一个文件中</span></span><br><span class="line">        .<span class="title function_">pipe</span>(plugins.<span class="title function_">useref</span>(&#123; <span class="attr">searchPath</span>: [<span class="string">&#x27;temp&#x27;</span>, <span class="string">&#x27;.&#x27;</span>] &#125;))</span><br><span class="line">        .<span class="title function_">pipe</span>(plugins.<span class="title function_">if</span>(<span class="regexp">/\.js$/</span>, plugins.<span class="title function_">uglify</span>())) <span class="comment">// 压缩js</span></span><br><span class="line">        .<span class="title function_">pipe</span>(plugins.<span class="title function_">if</span>(<span class="regexp">/\.css$/</span>, plugins.<span class="title function_">cleanCss</span>())) <span class="comment">// 压缩css</span></span><br><span class="line">        .<span class="title function_">pipe</span>(plugins.<span class="title function_">if</span>(<span class="regexp">/\.html$/</span>, plugins.<span class="title function_">htmlmin</span>(&#123;</span><br><span class="line">            <span class="attr">collapseWhitespace</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">minifyCSS</span>: <span class="literal">true</span>, <span class="comment">// 把html文件中的style压缩</span></span><br><span class="line">            <span class="attr">minifyJS</span>: <span class="literal">true</span> <span class="comment">// 把script中的js压缩</span></span><br><span class="line">        &#125;))) <span class="comment">// 压缩html</span></span><br><span class="line">        .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&#x27;dist&#x27;</span>)) <span class="comment">// 写入到另外一个文件，防止读、写同一个文件引发错乱</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="完整构建"><a href="#完整构建" class="headerlink" title="完整构建"></a>完整构建</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; src, dest, parallel, series, watch &#125; = <span class="built_in">require</span>(<span class="string">&quot;gulp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> del = <span class="built_in">require</span>(<span class="string">&quot;del&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> browserSync = <span class="built_in">require</span>(<span class="string">&quot;browser-sync&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> loadPlugins = <span class="built_in">require</span>(<span class="string">&quot;gulp-load-plugins&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动加载所有的插件</span></span><br><span class="line"><span class="keyword">const</span> plugins = <span class="title function_">loadPlugins</span>(); <span class="comment">// 把‘gulp-’去掉，如果后面有多个‘-’会变为驼峰命名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建服务器</span></span><br><span class="line"><span class="keyword">const</span> bs = browserSync.<span class="title function_">create</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  <span class="attr">menus</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;Home&quot;</span>,</span><br><span class="line">      <span class="attr">icon</span>: <span class="string">&quot;aperture&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;index.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;Features&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;features.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;About&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;about.html&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;Contact&quot;</span>,</span><br><span class="line">      <span class="attr">link</span>: <span class="string">&quot;#&quot;</span>,</span><br><span class="line">      <span class="attr">children</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;Twitter&quot;</span>,</span><br><span class="line">          <span class="attr">link</span>: <span class="string">&quot;https://twitter.com/w_zce&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;About&quot;</span>,</span><br><span class="line">          <span class="attr">link</span>: <span class="string">&quot;https://weibo.com/zceme&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;divider&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;About&quot;</span>,</span><br><span class="line">          <span class="attr">link</span>: <span class="string">&quot;https://github.com/zce&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">pkg</span>: <span class="built_in">require</span>(<span class="string">&quot;./package.json&quot;</span>),</span><br><span class="line">  <span class="attr">date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除文件目录</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clean</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">del</span>([<span class="string">&quot;dist&quot;</span>, <span class="string">&quot;temp&quot;</span>]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">style</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// base 基准路径，会把src后面的路径保留下来，否则不会按照原本路径输出</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/styles/*.scss&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(plugins.<span class="title function_">sass</span>(&#123; <span class="attr">outputStyle</span>: <span class="string">&quot;expanded&quot;</span> &#125;)) <span class="comment">// outputStyle编译后“&#125;”位于后面</span></span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line">    .<span class="title function_">pipe</span>(bs.<span class="title function_">reload</span>(&#123; <span class="attr">stream</span>: <span class="literal">true</span> &#125;)); <span class="comment">// 把信息以流的方法推到浏览器</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">script</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/scripts/*.js&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(plugins.<span class="title function_">babel</span>(&#123; <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>] &#125;))</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line">    .<span class="title function_">pipe</span>(bs.<span class="title function_">reload</span>(&#123; <span class="attr">stream</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">page</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 如果存在子目录：&#x27;src/**/*.html&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="title function_">src</span>(<span class="string">&quot;src/*.html&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">      <span class="comment">// data 把数据传入到模板中，渲染对应的数据</span></span><br><span class="line">      <span class="comment">// cache 防止模板缓存导致页面不能及时更新</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">swig</span>(&#123; data, <span class="attr">defaults</span>: &#123; <span class="attr">cache</span>: <span class="literal">false</span> &#125; &#125;)) <span class="comment">// 防止模板缓存导致页面不能及时更新</span></span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;temp&quot;</span>))</span><br><span class="line">      .<span class="title function_">pipe</span>(bs.<span class="title function_">reload</span>(&#123; <span class="attr">stream</span>: <span class="literal">true</span> &#125;))</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩图片</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">image</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/images/**&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(plugins.<span class="title function_">imagemin</span>())</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩字体</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">font</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;src/assets/fonts/**&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;src&quot;</span> &#125;)</span><br><span class="line">    .<span class="title function_">pipe</span>(plugins.<span class="title function_">imagemin</span>())</span><br><span class="line">    .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换其他文件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">extra</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 转换其他文件</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">src</span>(<span class="string">&quot;public/**&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;public&quot;</span> &#125;).<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务任务</span></span><br><span class="line"><span class="comment">// 此时dist文件目录的样式指向node_modules，需要修改配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">serve</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">watch</span>(<span class="string">&quot;src/assets/styles/*.scss&quot;</span>, style);</span><br><span class="line">  <span class="title function_">watch</span>(<span class="string">&quot;src/assets/scripts/*.js&quot;</span>, script);</span><br><span class="line">  <span class="title function_">watch</span>(<span class="string">&quot;src/*.html&quot;</span>, page);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开发阶段对图片、字体不构建，提高构建效率</span></span><br><span class="line">  <span class="comment">// watch(&#x27;src/assets/images/**&#x27;, image)</span></span><br><span class="line">  <span class="comment">// watch(&#x27;src/assets/fonts/**&#x27;, font)</span></span><br><span class="line">  <span class="comment">// watch(&#x27;public/**&#x27;, extra)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 文件变化后自动更新浏览器，浏览器重新发起请求</span></span><br><span class="line">  <span class="title function_">watch</span>(</span><br><span class="line">    [<span class="string">&quot;src/assets/images/**&quot;</span>, <span class="string">&quot;src/assets/fonts/**&quot;</span>, <span class="string">&quot;public/**&quot;</span>],</span><br><span class="line">    bs.<span class="property">reload</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  bs.<span class="title function_">init</span>(&#123;</span><br><span class="line">    <span class="attr">notify</span>: <span class="literal">false</span>, <span class="comment">// 关闭notify提示</span></span><br><span class="line">    <span class="attr">port</span>: <span class="number">8080</span>, <span class="comment">// 端口</span></span><br><span class="line">    <span class="comment">// open: false, // 是否自动打开浏览器</span></span><br><span class="line">    <span class="attr">files</span>: <span class="string">&quot;dist/**&quot;</span>, <span class="comment">// browserSync服务监听的路径通配符，文件发生改变自动刷新浏览器</span></span><br><span class="line">    <span class="attr">server</span>: &#123;</span><br><span class="line">      <span class="attr">baseDir</span>: [<span class="string">&quot;temp&quot;</span>, <span class="string">&quot;src&quot;</span>, <span class="string">&quot;public&quot;</span>], <span class="comment">// 如果资源在dist找不到就到src找，还找不到就到public找</span></span><br><span class="line">      <span class="attr">routes</span>: &#123;</span><br><span class="line">        <span class="comment">// 优先于baseDir，请求发生后会先看routes是否有对应的配置，如果有就走routes配置，否则就走baseDir对应的文件</span></span><br><span class="line">        <span class="string">&quot;/node_modules&quot;</span>: <span class="string">&quot;node_modules&quot;</span>, <span class="comment">// 键是请求的前缀</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">useref</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="title function_">src</span>(<span class="string">&quot;temp/*.html&quot;</span>, &#123; <span class="attr">base</span>: <span class="string">&quot;temp&quot;</span> &#125;)</span><br><span class="line">      <span class="comment">// 去除HTML文件构建注释、把构建注释的内容合并到一个文件中</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">useref</span>(&#123; <span class="attr">searchPath</span>: [<span class="string">&quot;temp&quot;</span>, <span class="string">&quot;.&quot;</span>] &#125;))</span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">if</span>(<span class="regexp">/\.js$/</span>, plugins.<span class="title function_">uglify</span>())) <span class="comment">// 压缩js</span></span><br><span class="line">      .<span class="title function_">pipe</span>(plugins.<span class="title function_">if</span>(<span class="regexp">/\.css$/</span>, plugins.<span class="title function_">cleanCss</span>())) <span class="comment">// 压缩css</span></span><br><span class="line">      .<span class="title function_">pipe</span>(</span><br><span class="line">        plugins.<span class="title function_">if</span>(</span><br><span class="line">          <span class="regexp">/\.html$/</span>,</span><br><span class="line">          plugins.<span class="title function_">htmlmin</span>(&#123;</span><br><span class="line">            <span class="attr">collapseWhitespace</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">minifyCSS</span>: <span class="literal">true</span>, <span class="comment">// 把html文件中的style压缩</span></span><br><span class="line">            <span class="attr">minifyJS</span>: <span class="literal">true</span>, <span class="comment">// 把script中的js压缩</span></span><br><span class="line">          &#125;)</span><br><span class="line">        )</span><br><span class="line">      ) <span class="comment">// 压缩html</span></span><br><span class="line">      .<span class="title function_">pipe</span>(<span class="title function_">dest</span>(<span class="string">&quot;dist&quot;</span>))</span><br><span class="line">  ); <span class="comment">// 写入到另外一个文件，防止读、写同一个文件引发错乱</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并行执行任务</span></span><br><span class="line"><span class="keyword">const</span> compile = <span class="title function_">parallel</span>(style, script, page);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 串行执行任务，上线前执行的任务</span></span><br><span class="line"><span class="keyword">const</span> build = <span class="title function_">series</span>(</span><br><span class="line">  clean,</span><br><span class="line">  <span class="title function_">parallel</span>(<span class="title function_">series</span>(compile, useref), image, font, extra)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> develop = <span class="title function_">series</span>(compile, serve);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  clean,</span><br><span class="line">  build,</span><br><span class="line">  develop,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Gulp-案例-补充"><a href="#Gulp-案例-补充" class="headerlink" title="Gulp 案例 - 补充"></a>Gulp 案例 - 补充</h2><ul>
<li>不需要全部任务都导出，只需要导出部分用到的就行</li>
<li>把任务写入到 package.json 文件中的 scripts 属性</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;clean&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gulp clean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gulp build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gulp develop&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h2 id="封装工作流-提取-gulpfile"><a href="#封装工作流-提取-gulpfile" class="headerlink" title="封装工作流 - 提取 gulpfile"></a>封装工作流 - 提取 gulpfile</h2><ul>
<li>把 gulp 构建文件封装打包为模块发布到 npm</li>
<li>如果模块还在本地没有发布到 npm 可以使用 <code>yarn link</code> 的方式把构建模块 link 到全局，然后在项目中 <code>yarn link zce-pages (脚手架名)</code> 的方式安装进项目（相当于 yarn add xxx）</li>
<li>如果有不应该提取到 gulp 构建模块的内容，应把它们抽离到项目配置文件（约定文件名），然后 gulp 构建模块读取该配置文件<ul>
<li>在 gulp 构建模块中获取抽离的配置，process.cwd()返回当前命令行所在的工作目录</li>
</ul>
</li>
<li>如果报 babel 相关的错误，如@babel&#x2F;preset-env，因为 gulp 构建模块使用 babel 转换语法，@babel&#x2F;preset-env 会查找根目录的 node_modules 目录中的@babel&#x2F;preset-env 模块，所以就报错；可以在 gulp 构建模块 javascript 任务的 babel 修改为 <code>&#123;presets: [require(&#39;@babel/preset-env&#39;)]&#125;</code></li>
<li>如果是通过 link 到全局的话，在构建项目时会报 gulp gulp-cli 相关的错误，是因为构建时在 node_modules 找不到 gulp 相关的命令，这时可以先在项目中安装依赖 <code>yarn add gulp gulp-cli --dev</code></li>
<li>在入口文件 gulpfile.js 导入 gulp 构建模块</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="built_in">require</span>(<span class="string">&quot;zce-pages&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="封装工作流-抽象路径配置"><a href="#封装工作流-抽象路径配置" class="headerlink" title="封装工作流 - 抽象路径配置"></a>封装工作流 - 抽象路径配置</h2><p>封装的 gulp 构建模块中任务使用的路径应该可配置，使任务中的文件路径可根据开发者配置<br>模块中默认路径配置；在开发项目中也可以传入该配置，让封装的 gulp 构建模块灵活</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">build</span>: &#123;</span><br><span class="line">  <span class="attr">src</span>: <span class="string">&#x27;src&#x27;</span>,</span><br><span class="line">  <span class="attr">dist</span>: <span class="string">&#x27;dist&#x27;</span>,</span><br><span class="line">  <span class="attr">temp</span>: <span class="string">&#x27;temp&#x27;</span>,</span><br><span class="line">  <span class="attr">public</span>: <span class="string">&#x27;public&#x27;</span>,</span><br><span class="line">  <span class="attr">paths</span>: &#123;</span><br><span class="line">   <span class="attr">styles</span>: <span class="string">&#x27;assets/styles/*.scss&#x27;</span>,</span><br><span class="line">    <span class="attr">scripts</span>: <span class="string">&#x27;assets/scripts/*.js&#x27;</span>,</span><br><span class="line">    <span class="attr">pages</span>: <span class="string">&#x27;*.html&#x27;</span>,</span><br><span class="line">    <span class="attr">images</span>: <span class="string">&#x27;assets/images/**&#x27;</span>,</span><br><span class="line">    <span class="attr">fonts</span>: <span class="string">&#x27;assets/fonts/**&#x27;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="封装工作流-包装-Gulp-CLI"><a href="#封装工作流-包装-Gulp-CLI" class="headerlink" title="封装工作流 - 包装 Gulp CLI"></a>封装工作流 - 包装 Gulp CLI</h2><p>在 gulp 构建模块添加一个 cli，在 cli 里自动传递参数(参数：–gulpfile)： <code>yarn gulp build --gulpfile</code>，然后在内部调用 gulp 提供的可执行程序</p>
<ul>
<li>在模块根目录新建目录 bin，在目录下新建 js 文件作为 cli 的入口，入口文件的文件头需要添加 <code>#!/usr/bin/env node</code></li>
<li>在 package.json 文件中添加‘bin’字段，值为该入口文件路径</li>
<li>把 gulp 的调用和传入的参数放在该文件中</li>
<li>在 window 系统执行 gulp 构建命令，会去 node_modules 下的.bin 目录下的 gulp.cmd 文件，如下代码；在该文件中根据判断执行当前目录外面的 gulp-cli&#x2F;bin&#x2F;gulp.js，该文件就 <code>require (&#39;gulp-cli&#39;)()</code>，所以我们只需在入口文件中引入这个 gulp.js： <code>require(&#39;gulp/bin/gulp&#39;)</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// %~dp0: 当前目录</span></span><br><span class="line">@<span class="variable constant_">IF</span> <span class="variable constant_">EXIST</span> <span class="string">&quot;%~dp0\node.exe&quot;</span> (</span><br><span class="line">  <span class="string">&quot;%~dp0\node.exe&quot;</span>  <span class="string">&quot;%~dp0\..\gulp-cli\bin\gulp.js&quot;</span> %*</span><br><span class="line">) <span class="variable constant_">ELSE</span> (</span><br><span class="line">  @<span class="variable constant_">SETLOCAL</span></span><br><span class="line">  @<span class="variable constant_">SET</span> <span class="variable constant_">PATHEXT</span>=%<span class="attr">PATHEXT</span>:;.<span class="property">JS</span>;=;%</span><br><span class="line">  node  <span class="string">&quot;%~dp0\..\gulp-cli\bin\gulp.js&quot;</span> %*</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>接下来要指定 gulpfile 和 cmd 路径，命令行传递的产生可以通过<code>process.argv</code>获取，该属性返回一个数组</li>
<li>从中可以看出<code>gulp-cli</code>是通过<code>process.argv</code>拿到参数的，可以在代码运行前 push 需要传递的参数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 入口文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 参数cwd：告诉gulp工作目录是命令行所在的目录</span></span><br><span class="line">process.<span class="property">argv</span>.<span class="title function_">push</span>(<span class="string">&quot;--cwd&quot;</span>);</span><br><span class="line">process.<span class="property">argv</span>.<span class="title function_">push</span>(process.<span class="title function_">cwd</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// gulpfile：告诉gulp gulpfile的目录</span></span><br><span class="line">process.<span class="property">argv</span>.<span class="title function_">push</span>(<span class="string">&quot;--gulpfile&quot;</span>);</span><br><span class="line">process.<span class="property">argv</span>.<span class="title function_">push</span>(<span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&quot;..&quot;</span>));</span><br><span class="line"><span class="comment">// require：载入模块</span></span><br><span class="line"><span class="comment">// resolve：找到模块所对应的路径；这里传递‘..’它会找到package.json中的bin字段对应的文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;gulp/bin/gulp&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这时把该构建模块安装在项目，项目中就不在需要 gulpfile.js 文件</p>
<h2 id="封装工作流-发布并使用模块"><a href="#封装工作流-发布并使用模块" class="headerlink" title="封装工作流 - 发布并使用模块"></a>封装工作流 - 发布并使用模块</h2><ul>
<li>在发布 npm 时会把项目根目录的文件和 package.json 中的 files 字段中的目录发布到 npm 仓库，所以要在 files 字段添加一个 cli 入口目录 bin，然后<code>yarn publish --registry https ://registry.yarnpkg.com</code> 推到 npm 仓库</li>
<li>在新项目中安装发布的模块，如果发布时间和安装时间间距短可能会安装到的是老版本，因为国能的镜像同步 npm 原地址需要时间，可以在淘宝镜像中搜索发布的模块，然后点击 <code>SYNC</code></li>
<li>在项目中执行 <code>yarn zce-pages build</code>就可以构建项目了，<code>zce-pages</code> 是发布到 npm 的模块名</li>
<li>也可以在项目的 package.json 文件中的 scripts 字段添加命令</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;clean&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zce-pages clean&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zce-pages build&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;develop&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zce-pages develop&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/25/%E8%84%9A%E6%89%8B%E6%9E%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/25/%E8%84%9A%E6%89%8B%E6%9E%B6/" class="post-title-link" itemprop="url">脚手架</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-25 15:56:35" itemprop="dateCreated datePublished" datetime="2022-10-25T15:56:35+08:00">2022-10-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:22" itemprop="dateModified" datetime="2022-11-08T08:54:22+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Yeoman"><a href="#Yeoman" class="headerlink" title="Yeoman"></a>Yeoman</h1><p>构建定制化的脚手架.</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn global add yo</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn global add generator-node</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yo node</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yo node:cli</span><br></pre></td></tr></table></figure>

<h2 id="小问题"><a href="#小问题" class="headerlink" title="小问题"></a>小问题</h2><p>这里执行当前项目的命令时会遇到权限问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn <span class="built_in">link</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> -R 777 目录名</span><br></pre></td></tr></table></figure>

<p>这里需要目录名,要么是绝对路径,要么可以先返回到上一层,再给这个文件夹权限.</p>
<h2 id="自定义-generator"><a href="#自定义-generator" class="headerlink" title="自定义 generator"></a>自定义 generator</h2><h3 id="Yeoman-使用步骤总结"><a href="#Yeoman-使用步骤总结" class="headerlink" title="Yeoman 使用步骤总结"></a>Yeoman 使用步骤总结</h3><ul>
<li>明确需求</li>
<li>找到合适的<a target="_blank" rel="noopener" href="https://yeoman.io/generators/">Generator</a></li>
<li>全局范围安装找到 Generator</li>
<li>通过 yo 运行对应的 Generator</li>
<li>通过命令行交互填写选项</li>
<li>生成你需要的项目结构</li>
</ul>
<h3 id="创建-Generator-模块"><a href="#创建-Generator-模块" class="headerlink" title="创建 Generator 模块"></a>创建 Generator 模块</h3><p>Generator 本质上就是一个 NPM 模块<br>Generator 基本结构</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|— generator-sample</span><br><span class="line">| |— generators/ ------------- 生成器目录</span><br><span class="line">| | |— app/ ----------------- 默认生成器目录</span><br><span class="line">| |— components -------- 模板文件</span><br><span class="line">| |— index.js ---------- 默认生成器实现</span><br><span class="line">|— package.json --------------- 模块包配置文件</span><br></pre></td></tr></table></figure>

<p>如果需要提供多个 Sub Generator，可以在 app 目录添加新的生成器目录</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">|— generator-sample</span><br><span class="line">| |— generators/ ------------ 生成器目录</span><br><span class="line">| | |— app/ ---------------- 默认生成器目录</span><br><span class="line">| | | |— components ------- 模板文件</span><br><span class="line">| | | |— index.js --------- 默认生成器实现</span><br><span class="line">+| |— component/ ------------- 其他生产器目录</span><br><span class="line">+| |— index.js ------------ 其他生成器实现</span><br><span class="line">|— package.json -------------- 模块包配置文件</span><br></pre></td></tr></table></figure>

<p>Yeoman Generator 模快的名称必须是<code>generator-</code>，否则 Yeoman 后续工作无法找到你的生成器模块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 此文件为 Generator 的核心入口</span></span><br><span class="line"><span class="comment">// 需要导出一个继承自 Yeoman Generator 的类</span></span><br><span class="line"><span class="comment">// Yeoman Generator 在工作时会自动调用我们在此类型中定义的一些生命周期方法</span></span><br><span class="line"><span class="comment">// 我们在这些生命周期方法中通过调用父类提供的一些工具方法实现一些功能，例如文件写入</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Generator</span> = <span class="built_in">require</span>(<span class="string">&quot;yeoman-generator&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">class</span> <span class="title class_">extends</span> <span class="title class_">Generator</span> &#123;</span><br><span class="line">  <span class="title function_">writing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Yeoman 自动在生成文件阶段调用此方法</span></span><br><span class="line">    <span class="comment">// 我们尝试往项目目录中写入文件</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fs</span>.<span class="title function_">write</span>(<span class="variable language_">this</span>.<span class="title function_">destinationPath</span>(<span class="string">&quot;temp.txt&quot;</span>), <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>在生成器目录终端执行<code>yarn link</code></li>
<li>在新建项目终端执行<code>yo sample</code></li>
</ul>
<h3 id="根据模板创建文件"><a href="#根据模板创建文件" class="headerlink" title="根据模板创建文件"></a>根据模板创建文件</h3><p>在生成器目录下添加 template 目录，模板中遵循 EJS 模板语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">class</span> <span class="title class_">extends</span> <span class="title class_">Generator</span> &#123;</span><br><span class="line">  <span class="title function_">writing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Yeoman 自动在生成文件阶段调用此方法</span></span><br><span class="line">    <span class="comment">// 通过模板方式写入文件到目标目录</span></span><br><span class="line">    <span class="comment">// 模板文件路径</span></span><br><span class="line">    <span class="keyword">const</span> tmpl = <span class="variable language_">this</span>.<span class="title function_">templatePath</span>(<span class="string">&quot;foo.txt&quot;</span>); <span class="comment">// 自动获取当前生成器下template目录下的文件路径</span></span><br><span class="line">    <span class="comment">// 输出目标路径</span></span><br><span class="line">    <span class="keyword">const</span> outPut = <span class="variable language_">this</span>.<span class="title function_">destinationPath</span>(<span class="string">&quot;foo.txt&quot;</span>);</span><br><span class="line">    <span class="comment">// 模板数据上下文</span></span><br><span class="line">    <span class="keyword">const</span> context = &#123; <span class="attr">title</span>: <span class="string">&quot;Hello zyh~&quot;</span>, <span class="attr">success</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fs</span>.<span class="title function_">copyTpl</span>(tmpl, outPut, context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="接收用户输入（终端命令行交互）prompting-方法"><a href="#接收用户输入（终端命令行交互）prompting-方法" class="headerlink" title="接收用户输入（终端命令行交互）prompting()方法"></a>接收用户输入（终端命令行交互）prompting()方法</h3><p>Yeoman 在询问用户环节会调用<code>prompting()</code>方法，在此方法中可以调用父类的 <code>prompt()</code> 方法发出对用户的命令行询问<br><code>prompt()</code>方法参数为一个数组，数组的每一个元素是一个问题对象(命令行交互)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Generator</span> = <span class="built_in">require</span>(<span class="string">&quot;yeoman-generator&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">class</span> <span class="title class_">extends</span> <span class="title class_">Generator</span> &#123;</span><br><span class="line">  <span class="title function_">prompting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Yeoman 在询问用户环节会自动调用此方法</span></span><br><span class="line">    <span class="comment">// 在此方法中可以调用父类的 prompt() 方法发出对用户的命令行询问</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数组的每个元素都是一个问题（终端命令行交互）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">prompt</span>([</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;input&quot;</span>, <span class="comment">// input:使用用户输入的方式</span></span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>, <span class="comment">// value是最终得到结果的键（用户输入的值的键）</span></span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;Your project name&quot;</span>, <span class="comment">// 终端界面给用户的提示（问题）</span></span><br><span class="line">        <span class="attr">default</span>: <span class="variable language_">this</span>.<span class="property">appname</span>, <span class="comment">// 默认值，如果用户不输入则使用默认值，appname 为项目生成目录名称</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ]).<span class="title function_">then</span>(<span class="function">(<span class="params">answers</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 用户交互选择的结果</span></span><br><span class="line">      <span class="comment">// answers =&gt; &#123; name: &#x27;user input value&#x27; &#125;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">answers</span> = answers;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">writing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// Yeoman 自动在生成文件阶段调用此方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模板文件路径</span></span><br><span class="line">    <span class="keyword">const</span> tmp = <span class="variable language_">this</span>.<span class="title function_">templatePath</span>(<span class="string">&quot;bar.html&quot;</span>);</span><br><span class="line">    <span class="comment">//输出模板路径</span></span><br><span class="line">    <span class="keyword">const</span> outPut = <span class="variable language_">this</span>.<span class="title function_">destinationPath</span>(<span class="string">&quot;bar.html&quot;</span>);</span><br><span class="line">    <span class="comment">// 模板数据上下文</span></span><br><span class="line">    <span class="keyword">const</span> context = <span class="variable language_">this</span>.<span class="property">answers</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fs</span>.<span class="title function_">copyTpl</span>(tmp, outPut, context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="生成-vue-项目结构"><a href="#生成-vue-项目结构" class="headerlink" title="生成 vue 项目结构"></a>生成 vue 项目结构</h3><p>如果模板文件中有<code>&#39;&lt;%= BASE_URL %&gt;&#39;</code>需要添加一个<code>%</code>进行转义，<code>&#39;&lt;%%= BASE_URL %&gt;&#39;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Generator</span> = <span class="built_in">require</span>(<span class="string">&quot;yeoman-generator&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">class</span> <span class="title class_">extends</span> <span class="title class_">Generator</span> &#123;</span><br><span class="line">  <span class="title function_">prompting</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">prompt</span>([</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;input&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;Your project name&quot;</span>,</span><br><span class="line">        <span class="attr">default</span>: <span class="variable language_">this</span>.<span class="property">appname</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;list&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">        <span class="attr">choices</span>: [<span class="string">&quot;yarn&quot;</span>, <span class="string">&quot;npm&quot;</span>],</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;请选择版本管理工具&quot;</span>,</span><br><span class="line">        <span class="attr">default</span>: <span class="string">&quot;yarn&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]).<span class="title function_">then</span>(<span class="function">(<span class="params">answers</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">answers</span> = answers;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">writing</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 把每一个文件都通过模板转换到目标路径</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// templates目录下的模板文件相对路径</span></span><br><span class="line">    <span class="keyword">const</span> templates = [</span><br><span class="line">      <span class="string">&quot;.browserslistrc&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.editorconfig&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.env.development&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.env.production&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.eslintrc.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;.gitignore&quot;</span>,</span><br><span class="line">      <span class="string">&quot;babel.config.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;package.json&quot;</span>,</span><br><span class="line">      <span class="string">&quot;postcss.config.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;README.md&quot;</span>,</span><br><span class="line">      <span class="string">&quot;public/favicon.ico&quot;</span>,</span><br><span class="line">      <span class="string">&quot;public/index.html&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/App.vue&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/main.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/router.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/assets/logo.png&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/components/HelloWorld.vue&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/store/actions.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/store/getters.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/store/index.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/store/mutations.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/store/state.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/utils/request.js&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/views/About.vue&quot;</span>,</span><br><span class="line">      <span class="string">&quot;src/views/Home.vue&quot;</span>,</span><br><span class="line">    ];</span><br><span class="line">    templates.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> temp = <span class="variable language_">this</span>.<span class="title function_">templatePath</span>(item);</span><br><span class="line">      <span class="keyword">const</span> outPut = <span class="variable language_">this</span>.<span class="title function_">destinationPath</span>(<span class="variable language_">this</span>.<span class="property">answers</span>.<span class="property">name</span> + <span class="string">&quot;/&quot;</span> + item);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">fs</span>.<span class="title function_">copyTpl</span>(temp, outPut, <span class="variable language_">this</span>.<span class="property">answers</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 进入项目目录，根据用户选择的管理工具安装依赖</span></span><br><span class="line">  <span class="title function_">install</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, tool &#125; = <span class="variable language_">this</span>.<span class="property">answers</span>;</span><br><span class="line">    <span class="keyword">const</span> npmDir = process.<span class="title function_">cwd</span>() + <span class="string">&quot;/&quot;</span> + name;</span><br><span class="line">    process.<span class="title function_">chdir</span>(npmDir);</span><br><span class="line">    tool === <span class="string">&quot;yarn&quot;</span> ? <span class="variable language_">this</span>.<span class="title function_">yarnInstall</span>() : <span class="variable language_">this</span>.<span class="title function_">npmInstall</span>();</span><br><span class="line">    <span class="comment">// this.installDependencies(&#123;</span></span><br><span class="line">    <span class="comment">//   bower: true,</span></span><br><span class="line">    <span class="comment">//   npm: true</span></span><br><span class="line">    <span class="comment">// &#125;)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="发布-Generator"><a href="#发布-Generator" class="headerlink" title="发布 Generator"></a>发布 Generator</h3><ol>
<li>上传 GitHub</li>
<li><code>yarn publish</code>填写相关信息后，如果出现错误是因为使用淘宝镜像取代官方镜像，所以往 npm 仓库发布代码就会出现问题，淘宝镜像是只读镜像；<ul>
<li>可以修改本地的镜像配置；</li>
<li><code>yarn publish --registry=https://registry.yarnpkg.com</code>(官方的镜像)</li>
</ul>
</li>
<li>发布成功</li>
</ol>
<h1 id="Plop"><a href="#Plop" class="headerlink" title="Plop"></a>Plop</h1><p>小型脚手架工具.<br>相当于一个可定制化的自动生成代码文件的工具.<br>比如有一套文件,包括 js,css,还要复制很多几乎相同的页面文件,使用 Plop 就可以一键生成.</p>
<p>可以帮助我们自动生成文件</p>
<ul>
<li>将 plop 模快作为项目开发依赖安装<code>yarn add plop --dev</code></li>
<li>在项目根目录新建文件 plopfile.js 作为 Plop 入口文件，需要导出一个函数，此函数接收一个 plop 对象，用于创建生成器任务</li>
<li>在 plopfile.js 文件中定义脚手架任务</li>
<li>编写用于生成特定类型文件的模板</li>
<li>通过 Plop 提供的 CLI 运行脚手架任务<code>yarn plop component</code></li>
<li>如果执行 <code>yarn plop Home</code>，则直接把<code>Home</code>作为文件名创建相应的目录文件，如何输入的是<code>yarn plop component</code>，则会提示输入组件名</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">plop</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 第一个：生成器名字 第二个：生成器的配置选项</span></span><br><span class="line">  plop.<span class="title function_">setGenerator</span>(<span class="string">&quot;component&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">description</span>: <span class="string">`cretate a component`</span>,</span><br><span class="line">    <span class="attr">prompts</span>: [</span><br><span class="line">      <span class="comment">// 命令行问题</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;input&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;component name&quot;</span>,</span><br><span class="line">        <span class="attr">default</span>: <span class="string">&quot;MyComponent&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;input&quot;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&quot;path&quot;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&quot;output path&quot;</span>,</span><br><span class="line">        <span class="attr">default</span>: <span class="string">&quot;src/components&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// 完成命令行交互后，执行的一些动作</span></span><br><span class="line">    <span class="attr">actions</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;add&quot;</span>, <span class="comment">// 代表添加文件</span></span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;&#123;&#123;path&#125;&#125;/&#123;&#123;name&#125;&#125;/&#123;&#123;name&#125;&#125;.js&quot;</span>, <span class="comment">// 输出路径；name为上面命令行交互中得到的name值</span></span><br><span class="line">        <span class="attr">templateFile</span>: <span class="string">&quot;plop-templates/component.hbs&quot;</span>, <span class="comment">// 添加的文件的模板文件</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;add&quot;</span>, <span class="comment">// 代表添加文件</span></span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;&#123;&#123;path&#125;&#125;/&#123;&#123;name&#125;&#125;/&#123;&#123;name&#125;&#125;.css&quot;</span>, <span class="comment">// name为上面命令行交互中得到的name值</span></span><br><span class="line">        <span class="attr">templateFile</span>: <span class="string">&quot;plop-templates/component.css.hbs&quot;</span>, <span class="comment">// 添加的文件的模板文件</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;add&quot;</span>, <span class="comment">// 代表添加文件</span></span><br><span class="line">        <span class="attr">path</span>: <span class="string">&quot;&#123;&#123;path&#125;&#125;/&#123;&#123;name&#125;&#125;/&#123;&#123;name&#125;&#125;.test.js&quot;</span>, <span class="comment">// name为上面命令行交互中得到的name值</span></span><br><span class="line">        <span class="attr">templateFile</span>: <span class="string">&quot;plop-templates/component.test.hbs&quot;</span>, <span class="comment">// 添加的文件的模板文件</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="脚手架的工作原理"><a href="#脚手架的工作原理" class="headerlink" title="脚手架的工作原理"></a>脚手架的工作原理</h3><p>工作原理：启用脚手架后询问用户一些问题，将用户回答结果结合一些模板文件生成项目结构</p>
<ul>
<li>新建一个项目</li>
<li><code>yarn init -y</code>初始化，在 package.json 文件下添加<code>bin</code>字段，用于指定 CLI 的入口文件：如：<code>&quot;bin&quot;: &quot;cli.js&quot;</code></li>
<li>在项目新增 bin 入口文件 cli.js</li>
<li>Node CLI 应用入口文件必须要有这样的文件头：<code>#!/usr/bin/env node</code>，如果是 Linux 或者 macOS 系统下还需要修改此文件的读写权限为 755，具体就是通过 <code>chmod 755 cli.js</code> 实现修改</li>
<li>脚手架的工作过程：<ul>
<li>通过命令行交互询问用户问题</li>
<li>根据用户回答的结果生成文件</li>
</ul>
</li>
<li>node 中发起命令行交互方式使用<code>inquirer</code>库。安装 inquirer 库 <code>yarn add inquirer</code>；inquirer 库提供一个 prompt 方法用于发起命令行交互</li>
<li><code>commander</code>库，命令行工具</li>
<li><code>chalk</code>库，命令行输出美化</li>
<li><code>child_process</code>模块，nodejs 的子进程模块，可以运行命令、检查 npm、yarn<ul>
<li><code>child_process.execSync(&#39;yarnpkg --version&#39;).toString()</code></li>
<li><code>child_process.spawn(&#39;npm&#39;, [&#39;isntall&#39;, &#39;webpack&#39;, &#39;-D&#39;], &#123;shell: true&#125;)</code></li>
</ul>
</li>
<li><code>download-git-repo</code>库，下载仓库模板</li>
<li>编写用于生成特定类型文件的模板</li>
<li>命令行执行<code>yarn link</code>把模块 link 到全局</li>
<li>新建项目，在项目命令行执行<code>sample-scaffolding</code></li>
<li>另外 webpack 的<code>ProgressPlugin</code>插件，用于监听编译进度</li>
<li>webpack 启动的 devServer，可以通过 nodejs 的<code>os</code>模块获取本机 IP 地址</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sample-scaffolding</span><br><span class="line">|— templates</span><br><span class="line">|— cli.js</span><br><span class="line">|— package.json</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> inquirer = <span class="built_in">require</span>(<span class="string">&quot;inquirer&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> ejs = <span class="built_in">require</span>(<span class="string">&quot;ejs&quot;</span>);</span><br><span class="line"></span><br><span class="line">inquirer</span><br><span class="line">  .<span class="title function_">prompt</span>([</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// 命令行问题</span></span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;input&quot;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;Project name?&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ])</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">anwsers</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 用户回答</span></span><br><span class="line">    <span class="comment">// console.log(anwsers)</span></span><br><span class="line">    <span class="comment">// 根据用户回答的结果生成文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模板目录</span></span><br><span class="line">    <span class="keyword">const</span> tmplDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;templates&quot;</span>);</span><br><span class="line">    <span class="comment">// 目标目录</span></span><br><span class="line">    <span class="keyword">const</span> destDir = process.<span class="title function_">cwd</span>(); <span class="comment">// 输出目录（命令行在那执行，就输出到哪个目录）</span></span><br><span class="line">    <span class="comment">// 将模板下的文件全部转换到目标目录</span></span><br><span class="line">    fs.<span class="title function_">readdir</span>(tmplDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      files.<span class="title function_">forEach</span>(<span class="function">(<span class="params">file</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 通过模板引擎渲染文件</span></span><br><span class="line">        ejs.<span class="title function_">renderFile</span>(path.<span class="title function_">join</span>(tmplDir, file), anwsers, <span class="function">(<span class="params">err, result</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 将结果写入目标文件路径</span></span><br><span class="line">          fs.<span class="title function_">writeFileSync</span>(path.<span class="title function_">join</span>(destDir, file), result);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/24/rolllup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/24/rolllup/" class="post-title-link" itemprop="url">rolllup</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-24 22:20:58" itemprop="dateCreated datePublished" datetime="2022-10-24T22:20:58+08:00">2022-10-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:22" itemprop="dateModified" datetime="2022-11-08T08:54:22+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Rollup-概述"><a href="#Rollup-概述" class="headerlink" title="Rollup 概述"></a>Rollup 概述</h2><ul>
<li>Rollup 更小巧，仅仅是一款 ESM 打包器</li>
<li>Rollup 中并不支持类似 HMR 这种高级特性</li>
<li>提供一个充分利用 ESM 各项特性的高效打包器</li>
</ul>
<h2 id="Rollup-快速上手"><a href="#Rollup-快速上手" class="headerlink" title="Rollup 快速上手"></a>Rollup 快速上手</h2><ul>
<li>安装 <code>yarn add rollup --dev</code></li>
<li>打包 <code>yarn rollup ./src/index.js --format iife --file dist/bundle.js</code></li>
<li>入口文件 index.js，指定输出格式：–format，格式：iife（自执行函数），–file：输出到目录</li>
<li>没使用的不会打包，自动开启 Tree Shaking</li>
</ul>
<h2 id="Rollup-配置文件"><a href="#Rollup-配置文件" class="headerlink" title="Rollup 配置文件"></a>Rollup 配置文件</h2><ul>
<li>rollup 运行在 node 环境中</li>
<li>根目录新建 <code>rollup.config.mjs</code> 配置文件</li>
<li>rollup 会额外处理这个配置文件，所有可以使用 ESM,注意使用 esm 需要将后缀改为<code>.mjs</code></li>
<li>配置文件导出一个对象</li>
<li>通过 input 属性指定打包入口</li>
<li>通过 output 属性指定输出，该属性值是一个对象，通过 file 指定输出的文件名，format 属性指定输出格式</li>
<li>打包 <code>pnpm rollup --config rollup.config.mjs</code> 通过–config 告诉 rollup 使用配置文件，可以根据开发、生产指定对应的配置文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">file</span>: <span class="string">&quot;dist/bundle.js&quot;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&quot;iife&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Rollup-使用插件"><a href="#Rollup-使用插件" class="headerlink" title="Rollup 使用插件"></a>Rollup 使用插件</h2><ul>
<li>插件是 rollup 唯一的扩展途径</li>
<li>安装插件 <code>pnpm add @rollup/plugin-json -D</code> 一个可以在代码导入 json 文件的插件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-json&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">file</span>: <span class="string">&quot;dist/bundle.js&quot;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&quot;iife&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">json</span>()],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">// package.json 的属性会作为成员导出</span></span><br><span class="line"><span class="keyword">import</span> &#123; name, version &#125; <span class="keyword">from</span> <span class="string">&quot;../package&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(name, version);</span><br></pre></td></tr></table></figure>

<h2 id="Rollup-加载-NPM-模块"><a href="#Rollup-加载-NPM-模块" class="headerlink" title="Rollup 加载 NPM 模块"></a>Rollup 加载 NPM 模块</h2><ul>
<li>安装插件 <code>pnpm add @rollup/plugin-node-resolve -D</code></li>
<li>安装 lodash 的 es 版本 <code>pnpm add lodash-es</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; nodeResolve &#125; <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-node-resolve&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">file</span>: <span class="string">&quot;dist/bundle.js&quot;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&quot;iife&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">json</span>(), <span class="title function_">nodeResolve</span>()],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&quot;lodash-es&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(_.<span class="title function_">camelCase</span>(<span class="string">&quot;hello world&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="Rollup-加载-CommonJS-模块"><a href="#Rollup-加载-CommonJS-模块" class="headerlink" title="Rollup 加载 CommonJS 模块"></a>Rollup 加载 CommonJS 模块</h2><ul>
<li>安装插件 <code>yarn add @rollup/plugin-commonjs --dev</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-json&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; nodeResolve &#125; <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-node-resolve&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> commonjs <span class="keyword">from</span> <span class="string">&quot;@rollup/plugin-commonjs&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">file</span>: <span class="string">&quot;dist/bundle.js&quot;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&quot;iife&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">json</span>(), <span class="title function_">nodeResolve</span>(), <span class="title function_">commonjs</span>()],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cjs-module.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; <span class="attr">foo</span>: <span class="string">&quot;bar&quot;</span> &#125;;</span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> cjs <span class="keyword">from</span> <span class="string">&quot;./cjs-module.js&quot;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(cjs);</span><br></pre></td></tr></table></figure>

<h2 id="Rollup-代码拆分"><a href="#Rollup-代码拆分" class="headerlink" title="Rollup 代码拆分"></a>Rollup 代码拆分</h2><ul>
<li>可以 ESM 的动态导入方式（import()）实现模块的按需加载</li>
<li>rollup 内部会自动处理代码拆分</li>
<li>代码拆分的方式打包 formats 不可以使用 iife（自执行函数）</li>
<li>自执行函数会把所有模块放到同一个函数中，可以使用 AMD 或者 Commonjs 标准，浏览器使用 AMD</li>
<li>需要输出多个文件 output 中就不能使用 file 属性，而是使用 dis 属性 值是输出目录</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&quot;src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">dir</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&quot;amd&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="title function_">import</span>(<span class="string">&quot;./logger&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; log &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">log</span>(<span class="string">&quot;code splitting~&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="Rollup-多入口打包"><a href="#Rollup-多入口打包" class="headerlink" title="Rollup 多入口打包"></a>Rollup 多入口打包</h2><ul>
<li>会把不同入口公共代码自动提取到单个文件中作为独立的 bundle</li>
<li>把配置文件的 input 属性值修改为一个数组，或者使用对象的方式</li>
<li>rollup 内部会自动拆分 format 要使用 AMD</li>
<li>AMD 文件不能直接引入，要使用特定的库去加载</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// input: [&#x27;src/index.js&#x27;, &#x27;src/album.js&#x27;]</span></span><br><span class="line">  <span class="attr">input</span>: &#123;</span><br><span class="line">    <span class="attr">foo</span>: <span class="string">&quot;src/index.js&quot;</span>,</span><br><span class="line">    <span class="attr">bar</span>: <span class="string">&quot;src/album.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">dir</span>: <span class="string">&quot;dist&quot;</span>,</span><br><span class="line">    <span class="attr">format</span>: <span class="string">&quot;amd&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- AMD 标准格式的输出 bundle 不能直接引用 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;script src=&quot;foo.js&quot;&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 需要 Require.js 这样的库 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--data-main：指定require入口路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span></span></span><br><span class="line"><span class="tag">      <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/requirejs@2.3.6/require.js&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">data-main</span>=<span class="string">&quot;foo.js&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Rollup-选用原则"><a href="#Rollup-选用原则" class="headerlink" title="Rollup 选用原则"></a>Rollup 选用原则</h2><ul>
<li>优势<ul>
<li>输出结果更加扁平</li>
<li>自动移除未引用的代码</li>
<li>打包结果依然完全可读</li>
</ul>
</li>
<li>缺点<ul>
<li>加载非 ESM 的第三方模块比较复杂</li>
<li>模块最终都被打包到一个函数中，无法实现 HMR</li>
<li>浏览器环境中，代码拆分功能依赖 AMD 库</li>
</ul>
</li>
<li>应用开发建议使用 webpack</li>
<li>库、框架开发建议使用 Rollup</li>
</ul>
<h2 id="Parcel-打包器"><a href="#Parcel-打包器" class="headerlink" title="Parcel 打包器"></a>Parcel 打包器</h2><ul>
<li>零配置的前端应用打包器</li>
<li>安装 <code>yarn add parcel-bundler --dev</code></li>
<li>官方建议使用 html 文件作为打包入口</li>
<li>打包 <code>yarn parcel src/index.html</code> parcel 会根据导入的模块查找 从而完成整个项目的打包，会自动开启一个服务</li>
<li>模块热更新</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable language_">module</span>.<span class="property">hot</span>) &#123;</span><br><span class="line">  <span class="variable language_">module</span>.<span class="property">hot</span>.<span class="title function_">accept</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;hmr&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>会自动安装模块依赖，如文件中导入 JQ，保存文件后，会自动安装模块</li>
<li>支持导入其他类型文件，而且是零配置的 <code>import &#39;./style.css</code> 保存就生效了</li>
<li>可以动态导入模块 import()</li>
<li>生成环境打包 <code>yarn parcel build src/index.html</code></li>
<li>内部使用多进程同时工作，构建速度快</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/24/webpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/24/webpack/" class="post-title-link" itemprop="url">webpack</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-24 22:20:43" itemprop="dateCreated datePublished" datetime="2022-10-24T22:20:43+08:00">2022-10-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:23" itemprop="dateModified" datetime="2022-11-08T08:54:23+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一、模块化开发"><a href="#一、模块化开发" class="headerlink" title="一、模块化开发"></a>一、模块化开发</h1><h2 id="Commonjs-规范"><a href="#Commonjs-规范" class="headerlink" title="Commonjs 规范"></a>Commonjs 规范</h2><ul>
<li>Commonjs 是以同步模式加载模块</li>
<li>一个文件就是一个模块</li>
<li>每个模块都有单独的作用域</li>
<li>通过 module.exports 导出成员</li>
<li>通过 require 函数载入模块</li>
</ul>
<h2 id="ES-Module-特性"><a href="#ES-Module-特性" class="headerlink" title="ES Module 特性"></a>ES Module 特性</h2><p>通过给 script 添加 type &#x3D; module 的属性，就可以以 ES Module 的标准执行其中的 js 代码了</p>
<ul>
<li>自动采用严格模式，忽略‘use strict’</li>
<li>每个 ES Module 模块都是单独的私有作用域</li>
<li>ES Module 是通过 CORS 去请求外部 js 模块的，服务器要支持 CORS</li>
<li>ES Module 的 script 标签会延迟执行脚本（页面渲染完在执行脚本）</li>
</ul>
<h3 id="ES-Module-导出"><a href="#ES-Module-导出" class="headerlink" title="ES Module 导出"></a>ES Module 导出</h3><ul>
<li>导出<ul>
<li>导出成员使用 export 修饰成员声明的方式，如：<code>export var name = &#39;yan; exprot var age = 18&#39;</code></li>
<li>export 可以单独使用，如:<code>var name = &#39;yan&#39;; var age = 18; export &#123; name, age &#125;</code></li>
<li>使用 as 给导出的成员重命名，导入时就要使用重命名后的变量名，如：<code>var name = &#39;yan&#39;; exprot &#123; name as firstName &#125;</code></li>
<li>如果重命名为 default 那这个成员就会做为当前模块默认导出的成员</li>
<li>在导入这个成员就必须要给这个成员重命名，default 是一个关键词不能作为一个变量使用</li>
</ul>
</li>
<li>导入<ul>
<li>导入使用 import 导入，如：<code>import &#123; name &#125; from &#39;./module.js&#39;</code>，name 为导出的变量名</li>
<li>导入默认导出传成员可以不使用花括号，变量名可以根据需要随便取，如：<code>import name from &#39;./module.js&#39;</code></li>
<li>如果导入的变量名为 default，需要使用 as 重命名，如：<code>import &#123; default as firstName &#125; from &#39;./module.js&#39;</code></li>
</ul>
</li>
</ul>
<h3 id="ES-Modules-导入导出的注意事项"><a href="#ES-Modules-导入导出的注意事项" class="headerlink" title="ES Modules 导入导出的注意事项"></a>ES Modules 导入导出的注意事项</h3><ul>
<li><code>export &#123; name, age &#125;</code> 该写法不是对象字面量的，如果要对象字面量的写法应该是：<code>export default &#123; name, age &#125;</code>，这样花括号会被理解为对象</li>
<li><code>import &#123;&#125; from &#39;./module.js&#39;</code>，花括号不是解构</li>
<li>导出成员时，导出的是这个成员的引用，导出的变量是只读的（在导入的文件中无法改变变量的值），如，在导出成员的文件中在一秒后改变变量的值，在导入变量的文件中两秒后输出变量值，输出的结果是改变后的值</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  a = <span class="number">2</span>;</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; a &#125; <span class="keyword">from</span> <span class="string">&quot;./module.js&quot;</span>;</span><br><span class="line"><span class="comment">// a = 22 // 报错，Assignment to constant variable</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(a); <span class="comment">// 2</span></span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="ES-Modules-导入用法"><a href="#ES-Modules-导入用法" class="headerlink" title="ES Modules 导入用法"></a>ES Modules 导入用法</h3><ul>
<li>import 必须使用完整的路径不能省略扩展名，即使是引入 index 也要完整的路径不能省略 index</li>
<li>import 可以使用完整的 url 加载模块 <code>import &#123; name &#125; from &#39;https://xxx.com/xxx.js&#39;</code></li>
<li>相对路径，在网页引用资源是可以省略‘.&#x2F;’的，但是 import 不可以省略，如果省略了就是以字母开头 ES Module 会以为在加载第三方模块，可以使用绝对路径和完整的 url</li>
<li>如果想要执行某个模块而不用提取模块成员，花括号为空即可，这是就只会执行这个模块，不会提出成员，如：<code>import &#123;&#125; from &#39;./module.js&#39;</code>，简写：<code>import &#39;./module.js&#39;</code></li>
<li>如果模块导出的成员特别多，而导入的都用到，可以使用星号‘_’，把这个模块的成员全部导入，在通过 as 将导入的成员全部放到一个对象中,导出的成员都会作为这个对象的属性，如：<code>import _ as mod from &#39;./module.js&#39;</code></li>
<li>动态导入模块，不可以通过判断使用<code>if (true)&#123;import &#123;name&#125; from &#39;./module.js&#39;&#125;</code>，如果需要动态导入，可以使用 import 函数<code>import(&#39;./module.js&#39;)</code>，import 函数返回的是一个 promise</li>
<li>如果模块同时导出默认成员和命名成员，在导入时可以给默认成员重命名<code>import &#123; name, default as age &#125; from &#39;./module.js&#39;</code>，也可以<code>import age(默认成员), &#123; name &#125; from &#39;./module.js&#39;</code></li>
</ul>
<h3 id="ES-Modules-导出导入成员"><a href="#ES-Modules-导出导入成员" class="headerlink" title="ES Modules 导出导入成员"></a>ES Modules 导出导入成员</h3><ul>
<li>import 可以配合 export 使用，效果就是将导入的结果直接作为当前模块的导出成员，那么在当前作用域就不能访问这些成员，如：<code>export &#123; name, age &#125; from &#39;./module&#39;</code>，利用这种特性可以把散落的模块组织在一起，如，一个 index 把零散的模块组织一起，然后再导出</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// button.js</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Button</span> = <span class="string">&quot;Button Component&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Button</span>;</span><br><span class="line"><span class="comment">// avatar.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">var</span> <span class="title class_">Avatar</span> = <span class="string">&quot;Avatar Component&quot;</span>;</span><br><span class="line"><span class="comment">// index.mjs</span></span><br><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> <span class="title class_">Button</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./button.js&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> &#123; <span class="title class_">Avatar</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./avatar.js&quot;</span>;</span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Button</span>, <span class="title class_">Avatar</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./index.mjs&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="ES-Modules-浏览器环境-Polyfill"><a href="#ES-Modules-浏览器环境-Polyfill" class="headerlink" title="ES Modules 浏览器环境 Polyfill"></a>ES Modules 浏览器环境 Polyfill</h3><ul>
<li>在不支持 ES Module 的浏览器中，可以使用 browser-es-module-loader 第三方库，在执行的时候解析</li>
<li>但是在支持 ES Module 的浏览器中，这样会执行两次，可以添加 script 标签的新属性 nomodule</li>
<li>nomodule:在不支持 ES Module 的浏览器工作</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span></span></span><br><span class="line"><span class="tag">  <span class="attr">nomodule</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/promise-polyfill@8.1.3/dist/polyfill.min.js&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span></span></span><br><span class="line"><span class="tag">  <span class="attr">nomodule</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/browser-es-module-loader@0.4.1/dist/babel-browser-build.js&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span></span></span><br><span class="line"><span class="tag">  <span class="attr">nomodule</span></span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/browser-es-module-loader@0.4.1/dist/browser-es-module-loader.js&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="ES-Modules-in-Node-js-支持情况"><a href="#ES-Modules-in-Node-js-支持情况" class="headerlink" title="ES Modules in Node.js - 支持情况"></a>ES Modules in Node.js - 支持情况</h3><ul>
<li>在 node 中使用 ES Module 文件后缀名为‘mjs’</li>
<li>执行 <code>node --experimental-modules 文件</code>，experimental-modules：启用 ES Module 实验特性</li>
<li>可以通过 import 导入原生的模块和第三方模块<code>import fs from &#39;fs&#39;; import _ form &#39;loadsh&#39;</code></li>
<li><code>import &#123; camelCase &#125; from &#39;lodash&#39;</code>，不支持，因为第三方模块都是导出默认成员；内置模块兼容了 ES Module 的提取成员方式，所以<code>import &#123; writeFileSync &#125; from &#39;fs&#39;</code>支持</li>
</ul>
<h3 id="ES-Modules-in-Node-js-与-CommonJS-交互"><a href="#ES-Modules-in-Node-js-与-CommonJS-交互" class="headerlink" title="ES Modules in Node.js - 与 CommonJS 交互"></a>ES Modules in Node.js - 与 CommonJS 交互</h3><ul>
<li>ES Module 中可以导入 Commonjs 模块</li>
<li>Commonjs 中不能导入 ES Module 模块</li>
<li>Commonjs 始终只会导出一个默认成员</li>
<li>注意 import 不是解构导出对象</li>
</ul>
<h3 id="ES-Modules-in-Node-js-与-CommonJS-的差异"><a href="#ES-Modules-in-Node-js-与-CommonJS-的差异" class="headerlink" title="ES Modules in Node.js - 与 CommonJS 的差异"></a>ES Modules in Node.js - 与 CommonJS 的差异</h3><ul>
<li>ES Module 中没有 Commonjs 中的那些模块全局成员（require&#x2F;module&#x2F;exports&#x2F;**filename&#x2F;**dirname）</li>
<li>Commonjs 中 require&#x2F;module&#x2F;exports 在 ES Module 中使用 import 和 export 替代，**filename 和 **dirname 可以通过 import.meta.url 可以拿到当前工作文件的文件 url 地址，可以使用原生的 url 模块的 fileURLToPath()方法可以把文件 url 转换为路径</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&quot;url&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; dirname &#125; <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> __filename = <span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>);</span><br><span class="line"><span class="keyword">const</span> __dirname = <span class="title function_">dirname</span>(__filename);</span><br></pre></td></tr></table></figure>

<h3 id="ES-Modules-in-Node-js-新版本进一步支持"><a href="#ES-Modules-in-Node-js-新版本进一步支持" class="headerlink" title="ES Modules in Node.js - 新版本进一步支持"></a>ES Modules in Node.js - 新版本进一步支持</h3><ul>
<li>在 package.json 文件添加 type 字段值为 module，此时文件扩展名可以用 js，而不需要 mjs</li>
<li>此时想要使用 Commonjs 规范，那么文件后缀名要改为 cjs</li>
</ul>
<h3 id="ES-Modules-in-Node-js-Babel-兼容方案"><a href="#ES-Modules-in-Node-js-Babel-兼容方案" class="headerlink" title="ES Modules in Node.js - Babel 兼容方案"></a>ES Modules in Node.js - Babel 兼容方案</h3><ul>
<li>安装 babel 相关依赖 <code>yarn add @babel/node @babel/core @babel/preset-env</code> babel 工作依赖插件，preset 是一个插件集合</li>
<li>执行 <code>yarn babel-node index.js(想要转换的文件) --presets=@babel/preset-env</code></li>
<li>或者添加一个.babelrc 文件</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;@babel/preset-env&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="二、Webpack-打包"><a href="#二、Webpack-打包" class="headerlink" title="二、Webpack 打包"></a>二、Webpack 打包</h1><h2 id="模块打包工具的由来"><a href="#模块打包工具的由来" class="headerlink" title="模块打包工具的由来"></a>模块打包工具的由来</h2><ul>
<li>ES Module 存在环境兼容问题</li>
<li>模块文件过多，网络请求频繁</li>
<li>所有的前端资源都需要模块化</li>
</ul>
<h2 id="Webpack-配置文件"><a href="#Webpack-配置文件" class="headerlink" title="Webpack 配置文件"></a>Webpack 配置文件</h2><ul>
<li>webpack 默认以<code>src/index.js</code> 为入口文件</li>
<li>在项目的根目录添加<code>webpack.config.js</code>文件，可以自定义相应的配置，该文件是运行在 nodejs 环境中</li>
<li>该文件导出一个对象，通过导出对象的属性就可以完成相应的配置选项</li>
<li>entry 属性：webpack 打包入口文件的路径，如果是相对路径<code>‘./’</code>不能省略</li>
<li>output 属性：webpack 打包输出的位置，值要求是一个对象，通过对象的 filename 属性指定输出的文件名，path 属性指定输出的目录(绝对路径)</li>
</ul>
<h2 id="Webpack-工作模式"><a href="#Webpack-工作模式" class="headerlink" title="Webpack 工作模式"></a>Webpack 工作模式</h2><ul>
<li>在 webpack.config.js 文件对象中添加 mode 属性</li>
<li>mode 默认值是 production，mode 可选值有 production、development、none</li>
<li>production：自动启动优化，会把代码压缩加密</li>
<li>development：会自动优化打包速度，添加一些调式过程中的辅助</li>
<li>none：运行最原始的打包，不做额外的处理</li>
</ul>
<h2 id="Webpack-资源模块加载"><a href="#Webpack-资源模块加载" class="headerlink" title="Webpack 资源模块加载"></a>Webpack 资源模块加载</h2><ul>
<li>webpack 内容默认只会处理 javascript 文件</li>
<li>处理其他类型的文件要安装使用对角的 loader（加载器）</li>
<li>使用 loader，在 webpack.config.js 导出的对象中的 module 属性，添加一个 rules 数组</li>
<li>rules 数组就是针对加载其他资源模块的规则配置</li>
<li>每个规则对象要设置两个属性，test：正则表达式，匹配打包过程中遇到的文件；use：匹配到的文件使用的 loader，use 的值可以是单个 loader 字符串也可以是一个数组 loader，<strong>如果是一个数组，会从右往左执行</strong></li>
<li>css-loader 的作用就是将 css 文件转换为一个 js 模块；具体实现就是将 css 代码 push 到一个数组中</li>
<li>style-loader 的作用就是将 css-loader 转换后的结果通过 style 标签追加到页面上</li>
<li>loader 是 webpack 的核心特性</li>
<li>借助不同的 loader 就可以加载任何类型的资源</li>
</ul>
<h2 id="Webpack-文件资源加载器"><a href="#Webpack-文件资源加载器" class="headerlink" title="Webpack 文件资源加载器"></a>Webpack 文件资源加载器</h2><ul>
<li>安装依赖 <code>yarn add file-loader</code></li>
<li>在配置文件中添加 rules <code>&#123; test: /.png$/, use: &#39;file-loader&#39; &#125;</code></li>
<li>webpack 默认所有打包的结果放在网站根目录；为项目中的所有资源指定一个基础路径，在 output 中添加 publicPath 属性，默认值为空表示网站的根目录</li>
<li>把 publicPath 值修改为 ‘dist&#x2F;‘ 注意“&#x2F;”不能省略，打包后是一个变量名（publicPath 值）拼接资源名（资源名前面没有“&#x2F;”）所有“&#x2F;”不能省略</li>
</ul>
<h2 id="Webpack-URL-加载器"><a href="#Webpack-URL-加载器" class="headerlink" title="Webpack URL 加载器"></a>Webpack URL 加载器</h2><ul>
<li>Data URLS 格式：data(协议):[mediatype(媒体类型和编码)][;base64],</li>
<li>安装插件 <code>yarn add url-loader --dev</code></li>
<li>在配置文件中添加 rules</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">use</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/.png$/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&quot;url-loader&quot;</span>,</span><br><span class="line">          <span class="attr">option</span>: &#123;</span><br><span class="line">            <span class="attr">limit</span>: <span class="number">10</span> * <span class="number">1024</span>, <span class="comment">// 对于小于10kb的png图片使用url-loader打包；而大于10kb的会使用file-loader打包</span></span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>打包后，图片将是以 base64 的格式显示</li>
</ul>
<p>最佳实践</p>
<ul>
<li>小文件使用 Data URLs，减少请求次数</li>
<li>大文件单独提取存放，提高加载速度</li>
</ul>
<h2 id="Webpack-常用加载器分类"><a href="#Webpack-常用加载器分类" class="headerlink" title="Webpack 常用加载器分类"></a>Webpack 常用加载器分类</h2><ul>
<li>编译转换类：会把加载的资源转为 js 代码</li>
<li>文件操作类：会把加载的资源拷贝到输出的目录，导出文件访问路径</li>
<li>代码检查类：目的是统一代码风格</li>
</ul>
<h2 id="Webpack-与-ES-2015"><a href="#Webpack-与-ES-2015" class="headerlink" title="Webpack 与 ES 2015"></a>Webpack 与 ES 2015</h2><ul>
<li>安装 babel-loader @babel&#x2F;core @babel&#x2F;preset-env</li>
<li>在配置文件中 module rules 添加</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&quot;babel-loader&quot;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-加载资源的方式"><a href="#Webpack-加载资源的方式" class="headerlink" title="Webpack 加载资源的方式"></a>Webpack 加载资源的方式</h2><ul>
<li>遵循 ES Modules 标准的 import 声明</li>
<li>遵循 Commonjs 标准的 require 函数</li>
<li>遵循 AMD 标准的 define 函数和 require 函数</li>
<li>Loader 加载器的非 JavaScript 也会触发资源加载<ul>
<li>样式代码中的@import 指令和 url 函数</li>
<li>HTML 代码中图片标签的 src 属性</li>
</ul>
</li>
</ul>
<h2 id="Webpack-核心工作原理"><a href="#Webpack-核心工作原理" class="headerlink" title="Webpack 核心工作原理"></a>Webpack 核心工作原理</h2><ul>
<li>webpack 会根据配置找到打包入口文件，然后顺着入口文件的代码</li>
<li>根据代码中的 import 或者 require 解析推断这个文件依赖的资源模块</li>
<li>然后分别解析每个资源模块对应的依赖，形成整个项目中所有用到文件之间的依赖关系的依赖树</li>
<li>webpack 递归依赖树，找到每个节点对于的资源文件</li>
<li>根据配置文件中的 rules 属性找到模块对应的加载器，找到对于的资源放在打包结果中，实现整个项目的打包</li>
</ul>
<h2 id="Webpack-开发一个-Loader"><a href="#Webpack-开发一个-Loader" class="headerlink" title="Webpack 开发一个 Loader"></a>Webpack 开发一个 Loader</h2><ul>
<li>loader 负责资源文件从输入到输出的转换</li>
<li>对于同一个资源可以依次使用多个 loader （css-loader -&gt; style-loader）</li>
<li>loader 模块导出一个函数；该函数输入的是加载到的资源文件内容；函数体是处理内容的过程；输出的是经过处理过的资源文件内容结果，结果必须是 javascript 代码</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> about <span class="keyword">from</span> <span class="string">&quot;./about.md&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(about);</span><br><span class="line"></span><br><span class="line"><span class="comment">// markdown-loader.js</span></span><br><span class="line"><span class="keyword">const</span> marked = <span class="built_in">require</span>(<span class="string">&quot;marked&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">source</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// source接受输入</span></span><br><span class="line">  <span class="comment">// console.log(source);</span></span><br><span class="line">  <span class="comment">// return &#x27;hello&#x27;;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法一</span></span><br><span class="line">  <span class="keyword">const</span> html = <span class="title function_">marked</span>(source);</span><br><span class="line">  <span class="comment">// return `module.exports = $&#123;JSON.stringify(html)&#125;`</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 方法二 返回 html 字符串交给下一个 loader处理 (html-loader)</span></span><br><span class="line">  <span class="keyword">return</span> html;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/main.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;bundle.js&quot;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;dist&quot;</span>),</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&quot;dist/&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/.md$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&quot;html-loader&quot;</span>, <span class="string">&quot;./markdown-loader&quot;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-插件机制介绍"><a href="#Webpack-插件机制介绍" class="headerlink" title="Webpack 插件机制介绍"></a>Webpack 插件机制介绍</h2><ul>
<li>增强 webpack 自动化能力</li>
<li>loader 专注实现资源模块加载</li>
<li>plugin 解决其他自动化工作<ul>
<li>清除 dist 目录</li>
<li>拷贝静态文件至输出目录</li>
<li>压缩输出代码</li>
</ul>
</li>
</ul>
<h2 id="Webpack-自动清除输出目录插件"><a href="#Webpack-自动清除输出目录插件" class="headerlink" title="Webpack 自动清除输出目录插件"></a>Webpack 自动清除输出目录插件</h2><ul>
<li>安装插件 <code>yarn add clean-webpack-plugin --dev</code></li>
<li>配置文件中导入插件</li>
<li>在配置对象中 plugins 属性，该属性是专门配置插件的地方，属性值是一个数组</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">CleanWebpackPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;clean-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="keyword">new</span> <span class="title class_">CleanWebpackPlugin</span>()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-自动生成-HTML-插件"><a href="#Webpack-自动生成-HTML-插件" class="headerlink" title="Webpack 自动生成 HTML 插件"></a>Webpack 自动生成 HTML 插件</h2><ul>
<li>安装插件 <code>yarn add html-webpack-plugin --dev</code></li>
<li>在配置文件中导入插件</li>
<li>在配置对象中 plugins 属性，该属性是专门配置插件的地方，属性值是一个数组</li>
<li>同时输出多个页面文件，可以再通过 HtmlWebpackPlugin 创建额外的 html 文件,通过 filename 指定文件名</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;html-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// 用于生成 index.html</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;Webpack Plugin Sample&quot;</span>, <span class="comment">// html文件的title</span></span><br><span class="line">      <span class="attr">meta</span>: &#123;</span><br><span class="line">        <span class="attr">viewport</span>: <span class="string">&quot;width=device-width&quot;</span>, <span class="comment">// 设置meta的viewport</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;./src/index.html&quot;</span>, <span class="comment">// 模版</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&quot;about.html&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.html</span></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"><span class="comment">// &lt;h1&gt;&lt;%= htmlWebpackPlugin.options.title %&gt;&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Webpack-插件使用总结"><a href="#Webpack-插件使用总结" class="headerlink" title="Webpack 插件使用总结"></a>Webpack 插件使用总结</h2><ul>
<li>安装插件 <code>yarn add copy-webpack-plugin --dev</code></li>
</ul>
<h2 id="Webpack-开发一个插件"><a href="#Webpack-开发一个插件" class="headerlink" title="Webpack 开发一个插件"></a>Webpack 开发一个插件</h2><ul>
<li>相比于 loader，plugin 拥有更宽的能力范围</li>
<li>plugin 通过钩子机制实现</li>
<li>插件必须是一个函数或者是一个包含 apply 方法的对象</li>
<li>通过在生命周期的钩子中挂载函数实现扩展</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyPlugin</span> &#123;</span><br><span class="line">  <span class="comment">// 目标 删除bundle.js中的注释</span></span><br><span class="line">  <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">    <span class="comment">// 会自动执行</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;my plugin 启动&quot;</span>);</span><br><span class="line">    <span class="comment">// https://webpack.js.org/api/compiler-hooks/</span></span><br><span class="line">    <span class="comment">// emit钩子：即将输出文件时执行</span></span><br><span class="line">    <span class="comment">// 参数一：插件名 参数二、挂载到钩子上的函数</span></span><br><span class="line">    compiler.<span class="property">hooks</span>.<span class="property">emit</span>.<span class="title function_">tap</span>(<span class="string">&quot;MyPlugin&quot;</span>, <span class="function">(<span class="params">compilation</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// compilation =&gt; 可以理解为此次打包的上下文</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> name <span class="keyword">in</span> compilation.<span class="property">assets</span>) &#123;</span><br><span class="line">        <span class="comment">// assets:资源文件</span></span><br><span class="line">        <span class="comment">// console.log(name); // 文件名</span></span><br><span class="line">        <span class="comment">// console.log(compilation.assets[name].source());//文件内容</span></span><br><span class="line">        <span class="keyword">if</span> (name.<span class="title function_">endsWith</span>(<span class="string">&quot;.js&quot;</span>)) &#123;</span><br><span class="line">          <span class="comment">// 判断是js文件</span></span><br><span class="line">          <span class="keyword">const</span> contents = compilation.<span class="property">assets</span>[name].<span class="title function_">source</span>(); <span class="comment">// 文件内容</span></span><br><span class="line">          <span class="keyword">const</span> withoutComments = contents.<span class="title function_">replace</span>(<span class="regexp">/\/\*\*+\*\//g</span>, <span class="string">&quot;&quot;</span>); <span class="comment">// 全局替换注释</span></span><br><span class="line">          compilation.<span class="property">assets</span>[name] = &#123;</span><br><span class="line">            <span class="comment">// 覆盖原有内容</span></span><br><span class="line">            <span class="attr">source</span>: <span class="function">() =&gt;</span> withoutComments, <span class="comment">// 返回新的内容</span></span><br><span class="line">            <span class="attr">size</span>: <span class="function">() =&gt;</span> withoutComments.<span class="property">length</span>, <span class="comment">// 返回内容的大小 webpack内部规定必须</span></span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-Dev-Server-静态资源访问"><a href="#Webpack-Dev-Server-静态资源访问" class="headerlink" title="Webpack Dev Server 静态资源访问"></a>Webpack Dev Server 静态资源访问</h2><ul>
<li>Dev Server 默认只会 serve 打包输出文件</li>
<li>只要是 webpack 打包输出的文件都可以直接被访问</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">  <span class="comment">// 额外开发服务指定静态资源路径，可以是字符串或数组</span></span><br><span class="line">  <span class="attr">contentBase</span>: <span class="string">&quot;./public&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-Dev-Server-代理-API"><a href="#Webpack-Dev-Server-代理-API" class="headerlink" title="Webpack Dev Server 代理 API"></a>Webpack Dev Server 代理 API</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="comment">// 前缀</span></span><br><span class="line">      <span class="string">&quot;/api&quot;</span>: &#123;</span><br><span class="line">        <span class="comment">// http://localhost:8080/api/users =&gt; https://api.github.com/api/users</span></span><br><span class="line">        <span class="attr">target</span>: <span class="string">&quot;https://api.github.com&quot;</span>,</span><br><span class="line">        <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">          <span class="string">&quot;^/api&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="comment">// 去除 /api</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 不能使用 localhost:8080 作为请求github的主机名</span></span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Source-Map-介绍"><a href="#Source-Map-介绍" class="headerlink" title="Source Map 介绍"></a>Source Map 介绍</h2><ul>
<li>调试和报错都是基于运行代码</li>
<li>source map 映射转换后代码和源代码关系，通过 source map 逆向解析</li>
<li>解决源代码与运行代码不一致所产生的调试问题</li>
</ul>
<h2 id="Webpack-配置-Source-Map"><a href="#Webpack-配置-Source-Map" class="headerlink" title="Webpack 配置 Source Map"></a>Webpack 配置 Source Map</h2><p>在配置项添加 <code>devtool: &#39;source-map&#39;</code></p>
<h2 id="Webpack-eval-模式的-Source-Map"><a href="#Webpack-eval-模式的-Source-Map" class="headerlink" title="Webpack eval 模式的 Source Map"></a>Webpack eval 模式的 Source Map</h2><ul>
<li>eval 是否使用 eval 执行模块代码，带 eval，用 eval 执行模块代码</li>
<li>cheap-source map 是否包含行信息</li>
<li>module 是否能够得到 Loader 处理之前的源代码</li>
<li>带 module 的模式下解析的出来的原代码是没有经过 loader 加工，手写的源代码</li>
<li>不带 module 是 loader 加工过后的代码</li>
<li>inline-source-map：source map 是因 dataURL 嵌入代码，其他的 source map 是以物理文件存在</li>
<li>hidden-source-map：开发工具看不到 source map 效果 在开发第三方包比较有用</li>
</ul>
<h2 id="Webpack-选择-Source-Map-模式"><a href="#Webpack-选择-Source-Map-模式" class="headerlink" title="Webpack 选择 Source Map 模式"></a>Webpack 选择 Source Map 模式</h2><ul>
<li>开发模式<ul>
<li>cheap-module-eval-source-map：代码每行不会超过 80 个字符；代码进过 loader 转换后差异较大需要 module 模式（loader 处理前的源代码）；首次打包速度慢无所谓，重写打包相对较快</li>
</ul>
</li>
<li>生成模式<ul>
<li>none 或 nosources-source-map：Source Map 会暴露源代码</li>
</ul>
</li>
</ul>
<h2 id="Webpack-HMR-体验（热更新）"><a href="#Webpack-HMR-体验（热更新）" class="headerlink" title="Webpack HMR 体验（热更新）"></a>Webpack HMR 体验（热更新）</h2><ul>
<li>应用运行过程中实时替换某个模块，应用运行状态不受影响</li>
<li>HMR 集成在 webpack-dev-server 中</li>
<li>开启 HMR<ul>
<li>css 样式（经过 loader 处理的）可以热更新但是 js 还是会刷新浏览器，webpack 中的 HMR 不可以开箱即用</li>
<li>webpack 中的 HMR 需要手动处理模块热替换逻辑</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">hot</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="keyword">new</span> webpack.<span class="title class_">HotModuleReplacementPlugin</span>()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-使用-HMR-API"><a href="#Webpack-使用-HMR-API" class="headerlink" title="Webpack 使用 HMR API"></a>Webpack 使用 HMR API</h2><h2 id="Webpack-处理-JS-模块热替换"><a href="#Webpack-处理-JS-模块热替换" class="headerlink" title="Webpack 处理 JS 模块热替换"></a>Webpack 处理 JS 模块热替换</h2><p>js 热更新：保存旧数据，代码发生变化后把数据回填</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> lastEditor = editor;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">hot</span>.<span class="title function_">accept</span>(<span class="string">&quot;./editor&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// console.log(&#x27;editor HMR&#x27;)</span></span><br><span class="line">  <span class="comment">// console.log(createEditor)</span></span><br><span class="line">  <span class="keyword">const</span> value = lastEditor.<span class="property">innerHTML</span>;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">removeChild</span>(editor);</span><br><span class="line">  <span class="keyword">const</span> newEditor = <span class="title function_">createEditor</span>();</span><br><span class="line">  newEditor.<span class="property">innerHTML</span> = value;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(newEditor);</span><br><span class="line">  lastEditor = newEditor;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 图片热更新</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">hot</span>.<span class="title function_">accept</span>(<span class="string">&quot;./better.png&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  img.<span class="property">src</span> = background;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(background);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="HMR-注意事项"><a href="#HMR-注意事项" class="headerlink" title="HMR 注意事项"></a>HMR 注意事项</h2><ul>
<li>如果没有开启热更新，但是 js 代码做了热更新处理，先做判断 <code>if (module.hot)&#123;// 热更新逻辑&#125;</code></li>
<li>hot 会刷新浏览器，报错信息会被刷走；hotOnly 不会刷新浏览器，可以把错误信息输出</li>
<li>打包后会自动去除 js 热更新逻辑代码</li>
</ul>
<h2 id="Webpack-生产环境优化"><a href="#Webpack-生产环境优化" class="headerlink" title="Webpack 生产环境优化"></a>Webpack 生产环境优化</h2><ul>
<li>mode：none、production、development</li>
<li>为不同的工作环境创建不同的配置</li>
</ul>
<h2 id="Webpack-不同环境下的配置"><a href="#Webpack-不同环境下的配置" class="headerlink" title="Webpack 不同环境下的配置"></a>Webpack 不同环境下的配置</h2><ul>
<li>配置文件根据环境不同导出不同的配置<ul>
<li>webpack 可以导出一个函数，函数返回配置</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数一：cli传递的环境名参数；参数二：运行cli传递的所有参数</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">env, argv</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> config = &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (env === <span class="string">&quot;production&quot;</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 执行 yarn webpack --env production</span></span><br></pre></td></tr></table></figure>

<ul>
<li>一个环境对应一个配置文件<ul>
<li>webpack.common.js 存放公共配置</li>
<li>webpack.dev.js 开发配置，把公共配置和开发配置合并（使用 loadsh merge）</li>
<li>webpack.prod.js 生产环境，把公共配置和生产配置合并（使用 loadsh merge）</li>
<li>执行 yarn webpack –config webpack.dev.js</li>
<li>或者在 scripts 中添加命令 <code>&quot;build&quot;: &quot;webpack --config webpack.dev.js&quot;</code></li>
</ul>
</li>
</ul>
<h2 id="Webpack-DefinePlugin"><a href="#Webpack-DefinePlugin" class="headerlink" title="Webpack DefinePlugin"></a>Webpack DefinePlugin</h2><ul>
<li>DefinePlugin 为代码注入全局成员</li>
<li>接收的是一个对象，每一个键值都会注入到代码中</li>
<li>文件代码中直接使用键，打包后把注入的值 直接替换到代码中，definePlugin 传递的字符串应该是代码</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">&quot;webpack&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="title class_">DefinePlugin</span>(&#123;</span><br><span class="line">      <span class="comment">// 想要输出的是字符串要个引号，否则输出的不是字符串</span></span><br><span class="line">      <span class="comment">// 输出值可以使用JSON.stringify(&#x27;https://api.github.com&#x27;)</span></span><br><span class="line">      <span class="attr">API_BASE_URL</span>: <span class="string">&#x27;&quot;https://api.github.com&quot;&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ==</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">API_BASE_URL</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-体验-Tree-Shaking"><a href="#Webpack-体验-Tree-Shaking" class="headerlink" title="Webpack 体验 Tree Shaking"></a>Webpack 体验 Tree Shaking</h2><ul>
<li>在生成模式下自动开启，对于冗余、未引用代码不会打包</li>
<li>不是指某个配置选项，是一组功能搭配使用后的优化效果</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack 使用 Tree Shaking</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;bundle.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 集中配置webpack内部优化功能</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">usedExports</span>: <span class="literal">true</span>, <span class="comment">// 只到处外部使用了的成员 （相当于标记没使用的代码）</span></span><br><span class="line">    <span class="attr">minimize</span>: <span class="literal">true</span>, <span class="comment">// 开启webpack代码压缩  会把外部没使用的代码去除</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-合并模块—concatenateModules"><a href="#Webpack-合并模块—concatenateModules" class="headerlink" title="Webpack 合并模块—concatenateModules"></a>Webpack 合并模块—concatenateModules</h2><ul>
<li>尽可能的将所有模块合并输出到一个函数中</li>
<li>提升运行效率，减少代码体积</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;bundle.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 集中配置webpack内部优化功能</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">concatenateModules</span>: <span class="literal">true</span>, <span class="comment">// 打包后把所有的模块放在同一个函数中；</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-Tree-Shaking-与-Babel"><a href="#Webpack-Tree-Shaking-与-Babel" class="headerlink" title="Webpack Tree Shaking 与 Babel"></a>Webpack Tree Shaking 与 Babel</h2><ul>
<li>babel 和 tree shaking 同时使用会导致 tree shaking 失效<ul>
<li>tree shaking 前提是 ES Modules，由 webpack 打包的代码必须使用 ESM</li>
<li>babel-loader 转换代码时可能会把 ES Modules 转为 CommonJS<br>新版的 babel-loader 不会导致 tree shaking 失效，</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&quot;babel-loader&quot;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [</span><br><span class="line">              <span class="comment">// modules：默认值是auto 根据环境判断是否开启ESM，可以设为false</span></span><br><span class="line">              [<span class="string">&quot;@babel/preset-env&quot;</span>, &#123; <span class="attr">modules</span>: <span class="string">&quot;commonjs&quot;</span> &#125;], <span class="comment">// 强制使用babel ESM，把ESM转为commonjs</span></span><br><span class="line">            ],</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-sideEffects"><a href="#Webpack-sideEffects" class="headerlink" title="Webpack sideEffects"></a>Webpack sideEffects</h2><ul>
<li>允许通过配置方式标识代码是否有副作用（模块执行时除了导出成员之外所做的事情）</li>
<li>一般用于开发 npm 包时 标记是否有副作用</li>
<li>生产模式自动开启 会检查当前代码所属的 package.json 有没有 sideEffects 标识，以此来判断这个模块是否有副作用</li>
<li>如果这个模块没有副作用，那些没有用到的模块不会被打包</li>
<li>package.json 添加 <code>sideEffects: false</code> 表示 package.json 所影响的项目当中所有的代码都没有副作用</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">optimization</span>: &#123;</span><br><span class="line">  <span class="attr">sideEffects</span>: <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-sideEffects-注意"><a href="#Webpack-sideEffects-注意" class="headerlink" title="Webpack sideEffects 注意"></a>Webpack sideEffects 注意</h2><ul>
<li>使用 sideEffects 前提确保代码真的没有副作用，否则 webpack 再打报时会误删有副作用的代码</li>
<li>如在 Number 原型添加方法然后载入、载入 css 也是</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// extend.js</span></span><br><span class="line"><span class="comment">// 为Number的原型添加一个扩展方法</span></span><br><span class="line"><span class="comment">// 副作用代码 在package.json声明没有副作用，在打包时会被去除</span></span><br><span class="line"><span class="title class_">Number</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">pad</span> = <span class="keyword">function</span>(<span class="params">size</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="variable language_">this</span> + <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">while</span>(result.<span class="property">length</span> &lt; size) &#123;</span><br><span class="line">    result = <span class="string">&#x27;0&#x27;</span> + result</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./extend.js&#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">8.</span><span class="title function_">pad</span>(<span class="number">3</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>解决：在 package.json 关闭副作用、标识哪些文件有副作用</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line"><span class="string">&quot;sideEffects&quot;</span>: [ <span class="comment">// 标识有副作用的文件</span></span><br><span class="line">  <span class="string">&#x27;./src/extends.js&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;*.css&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-代码分割"><a href="#Webpack-代码分割" class="headerlink" title="Webpack 代码分割"></a>Webpack 代码分割</h2><ul>
<li>所有代码最终都被打包到一起，打包文件体积过大</li>
<li>分包，按需加载</li>
<li>多入口打包</li>
<li>动态导入</li>
</ul>
<h2 id="Webpack-多入口打包"><a href="#Webpack-多入口打包" class="headerlink" title="Webpack 多入口打包"></a>Webpack 多入口打包</h2><ul>
<li>多页应用程序，一个页面对应一个打包入口，公共部分单独提取</li>
<li>多个入口可以把 entry 定义为对象，一个属性就是一个入口，键就是入口名，值就是入口对应的文件路径</li>
<li>多入口，输出也要多个，可以给 filename 的值添加 <code>[name]</code>占位 <code>outpur:&#123;filename: &#39;[name].bundle.js&#39;&#125;</code> 这样 <code>[name]</code>就会被替换为入口名称</li>
<li>plugins 中的 HtmlWebpackPlugin 插件会自动输入注入所以打包结果的 html，所以此时入口文件会注入所有的打包结果</li>
<li>可以给 HtmlWebpackPlugin 插件配置注入的打包文件 <code>new HtmlWebpackPlugin(&#123;chunks:[&#39;index&#39;]&#125;), new HtmlWebpackPlugin(&#123;chunks:[&#39;album&#39;]&#125;)</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">CleanWebpackPlugin</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;clean-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;html-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">  <span class="attr">entry</span>: &#123;</span><br><span class="line">    <span class="attr">index</span>: <span class="string">&quot;./src/index.js&quot;</span>,</span><br><span class="line">    <span class="attr">album</span>: <span class="string">&quot;./src/album.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;[name].bundle.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&quot;style-loader&quot;</span>, <span class="string">&quot;css-loader&quot;</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CleanWebpackPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;Multi Entry&quot;</span>,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;./src/index.html&quot;</span>,</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&quot;index.html&quot;</span>,</span><br><span class="line">      <span class="attr">chunks</span>: [<span class="string">&quot;index&quot;</span>],</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&quot;Multi Entry&quot;</span>,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;./src/album.html&quot;</span>,</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&quot;album.html&quot;</span>,</span><br><span class="line">      <span class="attr">chunks</span>: [<span class="string">&quot;album&quot;</span>],</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-提取公共模块"><a href="#Webpack-提取公共模块" class="headerlink" title="Webpack 提取公共模块"></a>Webpack 提取公共模块</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="comment">// 自动提取所有公共模块到单独 bundle</span></span><br><span class="line">      <span class="attr">chunks</span>: <span class="string">&quot;all&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-动态导入"><a href="#Webpack-动态导入" class="headerlink" title="Webpack 动态导入"></a>Webpack 动态导入</h2><ul>
<li>需要用到某个模块时，再加载这个模块</li>
<li>动态导入的模块会被自动分包</li>
<li>一般我们都是在文件头直接 import 文件的，这会造成资源浪费</li>
<li>可以使用 ES Modules 的 import()在需要导入的地方导入模块，该方法返回的是 promise 可以拿到导出的对象</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="title function_">import</span>(<span class="string">&quot;./posts&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">&#123; <span class="keyword">default</span>: posts &#125;</span>) =&gt;</span> &#123;&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-魔法注释"><a href="#Webpack-魔法注释" class="headerlink" title="Webpack 魔法注释"></a>Webpack 魔法注释</h2><ul>
<li>在 import()方法中添加特定的注释 <code>import(/* webpackChunkName: &#39;posts&#39; */ &#39;./posts&#39;)</code> 这样在打包后文件名就会带上这个 webpackChunkName 值</li>
<li>如果 webpackChunkName 相同，打包后会打包在一起</li>
</ul>
<h2 id="Webpack-MiniCssExtractPlugin—提取-css-到单独文件"><a href="#Webpack-MiniCssExtractPlugin—提取-css-到单独文件" class="headerlink" title="Webpack MiniCssExtractPlugin—提取 css 到单独文件"></a>Webpack MiniCssExtractPlugin—提取 css 到单独文件</h2><ul>
<li>安装插件 <code>yarn add mini-css-extract-plugin --dev</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">MiniCssExtractPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;mini-css-extract-plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="comment">// &#x27;style-loader&#x27;, // 将样式通过 style 标签注入</span></span><br><span class="line">          <span class="title class_">MiniCssExtractPlugin</span>.<span class="property">loader</span>, <span class="comment">// 通过 link 标签注入</span></span><br><span class="line">          <span class="string">&quot;css-loader&quot;</span>,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="keyword">new</span> <span class="title class_">MiniCssExtractPlugin</span>()],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-OptimizeCssAssetsWebpackPlugin—-压缩-css"><a href="#Webpack-OptimizeCssAssetsWebpackPlugin—-压缩-css" class="headerlink" title="Webpack OptimizeCssAssetsWebpackPlugin— 压缩 css"></a>Webpack OptimizeCssAssetsWebpackPlugin— 压缩 css</h2><ul>
<li>安装插件 <code>yarn add optimize-css-assets-webpack-plugin --dev</code></li>
<li>如果配置在 plugins 中这个插件在任何情况都会正常工作</li>
<li>配置在 minimizer 中 只有 minimizer 开启（生产环境自动开启）是才工作</li>
<li>webpack 建议压缩创建配置在 minimizer 中，以便通过 minimizer 选项统一控制</li>
<li>当 minimizer 使用一个数组，webpack 认为我们要自定义所使用的压缩器插件，webpack 内部的 js 压缩器就会被覆盖，如果不配置 js 压缩器，这是打包，js 代码不会被压缩</li>
<li>手动把 js 压缩器添加回来，安装插件 <code>yarn add terser-webpack-plugin --dev</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">OptimizeCssAssetsWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;optimize-css-assets-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">TerserWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;terser-webpack-plugin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimizer</span>: [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">TerserWebpackPlugin</span>(),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">OptimizeCssAssetsWebpackPlugin</span>(),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Webpack-输出文件名-Hash"><a href="#Webpack-输出文件名-Hash" class="headerlink" title="Webpack 输出文件名 Hash"></a>Webpack 输出文件名 Hash</h2><ul>
<li>在部署时服务器开启静态文件缓存，如果缓存时间过长，程序发生更改，得不到更新</li>
<li>生产环境下，文件名使用 Hash，文件名发生变化 对客户端而言全新的文件名就是全新的请求，就不会有缓存问题</li>
<li>[hash]【占位符】：整个项目级别的，项目中有任何地方改动，这次打包的 hash 值都会发生变化</li>
<li>[chunkhash]【占位符】：chuankhash 级别，打包过程中只要是同一路的打包 chunkhash 都是相同的</li>
<li>[contenthask]【占位符】：文件级别 hash，根据文件输出内容生成 hash 值（不同的文件就有不同的 hash 值）</li>
<li>指定 hash 值长度[chunkhash:8]【占位符】</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;[name]-[contenthash:8].bundle.js&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/24/React%20Query/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/24/React%20Query/" class="post-title-link" itemprop="url">React Query</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-24 16:58:46" itemprop="dateCreated datePublished" datetime="2022-10-24T16:58:46+08:00">2022-10-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:23" itemprop="dateModified" datetime="2022-11-08T08:54:23+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>也就是解决了什么问题?</p>
<h2 id="常规流程"><a href="#常规流程" class="headerlink" title="常规流程"></a>常规流程</h2><p>请求数据 &#x3D;&gt;加载中 &#x3D;&gt; 后端返回 &#x3D;&gt; 如果有报错展示报错 &#x3D;&gt;刷新数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 存储 后端返回数据</span></span><br><span class="line">  <span class="keyword">const</span> [zen, setZen] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>); <span class="comment">// 存储 加载状态</span></span><br><span class="line">  <span class="keyword">const</span> [isLoading, setIsLoading] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">false</span>); <span class="comment">// 存储 是否请求成功</span></span><br><span class="line">  <span class="keyword">const</span> [isError, setIsError] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">false</span>); <span class="comment">// 存储 后端返回的错误数据</span></span><br><span class="line">  <span class="keyword">const</span> [errorMessage, setErrorMessage] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">fetchData</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 开始获取数据，将isLoading置为true</span></span><br><span class="line">    <span class="title function_">setIsLoading</span>(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&quot;https://api.github.com/zen&quot;</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="keyword">async</span> (response) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 如果请求返回status不为200 则抛出后端错误</span></span><br><span class="line">        <span class="keyword">if</span> (response.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; message &#125; = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response.<span class="title function_">text</span>();</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">text: string</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 请求完成将isLoading置为false</span></span><br><span class="line">        <span class="title function_">setIsLoading</span>(<span class="literal">false</span>); <span class="comment">// 接口请求成功，将isError置为false</span></span><br><span class="line">        <span class="title function_">setIsError</span>(<span class="literal">false</span>); <span class="comment">// 存储后端返回的数据</span></span><br><span class="line">        <span class="title function_">setZen</span>(text);</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 请求完成将isLoading置为false</span></span><br><span class="line">        <span class="title function_">setIsLoading</span>(<span class="literal">false</span>); <span class="comment">// 接口请求错误，将isError置为true</span></span><br><span class="line">        <span class="title function_">setIsError</span>(<span class="literal">true</span>); <span class="comment">// 存储后端返回的错误数据</span></span><br><span class="line">        <span class="title function_">setErrorMessage</span>(error.<span class="property">message</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化请求数据</span></span><br><span class="line">    <span class="title function_">fetchData</span>();</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Zen from Github<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>     <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;isLoading ? &quot;加载中...&quot; : isError ? errorMessage : zen&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span>   &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;!isLoading &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;fetchData&#125;</span>&gt;</span>&#123;isError ? &quot;重试&quot; : &quot;刷新&quot;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">         </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 isLoading 来存储加载状态</li>
<li>使用 isError 来存储接口是否有错误</li>
<li>使用 errorMessage 来存储后端返回的报错信息</li>
<li>使用 zen 来存储后端返回数据存储</li>
<li>重新调用 fetchData 方法来刷新数据</li>
</ul>
<h2 id="修正"><a href="#修正" class="headerlink" title="修正"></a>修正</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fetchData</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.github.com/zen&quot;</span>).<span class="title function_">then</span>(<span class="keyword">async</span> (response) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 如果请求返回status不为200 则抛出后端错误</span></span><br><span class="line">    <span class="keyword">if</span> (response.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; message &#125; = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response.<span class="title function_">text</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> zenQuery = <span class="title function_">useQuery</span>([<span class="string">&quot;zen&quot;</span>], fetchData); <span class="comment">// ①</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Zen from Github<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>     <span class="tag">&lt;<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">        &#123;zenQuery.isLoading || zenQuery.isFetching</span></span><br><span class="line"><span class="language-xml">          ? &quot;加载中...&quot;</span></span><br><span class="line"><span class="language-xml">          : zenQuery.isError</span></span><br><span class="line"><span class="language-xml">          ? zenQuery.error?.message</span></span><br><span class="line"><span class="language-xml">          : data&#125;</span></span><br><span class="line"><span class="language-xml">             </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">p</span>&gt;</span>   &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;!zenQuery.isLoading &amp;&amp; !zenQuery.isFetching &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            zenQuery.refetch();</span></span><br><span class="line"><span class="language-xml">          &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">                  &#123;zenQuery.isError ? &quot;重试&quot; : &quot;刷新&quot;&#125;       </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">         </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>为了解决这么多大量冗杂的模板代码.使用 react-query 会变得十分整洁.<br>上面各种 loading,error,数据刷新等等都交给 react-query 处理.</p>
<h1 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h1><h2 id="查询键和查询函数"><a href="#查询键和查询函数" class="headerlink" title="查询键和查询函数"></a>查询键和查询函数</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> zenQuery = <span class="title function_">useQuery</span>([<span class="string">&quot;zen&quot;</span>], fetchData);</span><br></pre></td></tr></table></figure>

<ul>
<li>其中<code>[&#39;zen&#39;]</code>就是 react-query 的查询键，react-query 通过不同的查询键来标识(映射)不同接口(或是同一接口不同参数请求)返回的数据。在 react-query@4 中，查询键必须是数组。</li>
<li>而<code>fetchData</code>就是我们请求后端接口的函数，也就是查询函数.<blockquote>
<p>PS：查询键内的元素可以是嵌套数组、对象、字符串、数字<br>例如：[‘zen’, { form: ‘confucius’ }]或[‘zen’, [‘confucius’, ‘Lao Tzu’]]</p>
</blockquote>
</li>
</ul>
<p>为了方便记忆，打个比方，你可以将查询键看做是你存储 localStorage 时的 key，而 value 则是通过查询函数查询到数据后，将各种我们需要的状态数据存储进入 value<br>使用变量作为查询键的元素时，当变量的值变化后，react-query 将会重新调用 fetchData 方法，获取新的数据，并缓存到对应变量值为 key 的缓存中。</p>
<h2 id="并行请求"><a href="#并行请求" class="headerlink" title="并行请求"></a>并行请求</h2><p>同时多个请求就写多个 useQuery,合并请求就用 Promise.all 包裹.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getReposAndGists</span> = (<span class="params">username</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`https://api.github.com/users/<span class="subst">$&#123;username&#125;</span>/repos`</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">json</span>()</span><br><span class="line">    ),</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`https://api.github.com/users/<span class="subst">$&#123;username&#125;</span>/gists`</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">json</span>()</span><br><span class="line">    ),</span><br><span class="line">  ]);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ReposAndGists</span> = (<span class="params">&#123; username &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> reposAndGistsQuery = <span class="title function_">useQuery</span>([<span class="string">&quot;reposAndGists&quot;</span>, username], <span class="function">() =&gt;</span></span><br><span class="line">    <span class="title function_">getReposAndGists</span>(username)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (reposAndGistsQuery.<span class="property">isLoading</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>加载数据中...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (reposAndGistsQuery.<span class="property">isError</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>数据加载错误: &#123;reposAndGistsQuery.error.message&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!reposAndGistsQuery.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [repos, gists] = reposAndGistsQuery.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">h2</span>&gt;</span>仓库列表<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>     <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">        &#123;repos.map((repo) =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;repo.id&#125;</span>&gt;</span>&#123;repo.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ))&#125;</span></span><br><span class="line"><span class="language-xml">             </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">hr</span> /&gt;</span>     <span class="tag">&lt;<span class="name">h2</span>&gt;</span>代码片段列表<span class="tag">&lt;/<span class="name">h2</span>&gt;</span>     </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">        &#123;gists.map((gist) =&gt; (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;gist.id&#125;</span>&gt;</span>&#123;gist.description || &quot;暂无描述&quot;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ))&#125;</span></span><br><span class="line"><span class="language-xml">             </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ReposAndGists</span>;</span><br></pre></td></tr></table></figure>

<h2 id="动态生成请求"><a href="#动态生成请求" class="headerlink" title="动态生成请求"></a>动态生成请求</h2><p><code>useQueries</code>.从动态获取[‘facebook’, ‘vuejs’, ‘nestjs’, ‘mongdb’]，到重新批量获取了以下用户的仓库[‘microsoft’, ‘tesla’].</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQueries &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [users, setUsers] = <span class="title class_">React</span>.<span class="title function_">useState</span>([</span><br><span class="line">    <span class="string">&quot;facebook&quot;</span>,</span><br><span class="line">    <span class="string">&quot;vuejs&quot;</span>,</span><br><span class="line">    <span class="string">&quot;nestjs&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mongodb&quot;</span>,</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">getRepos</span> = (<span class="params">username</span>) =&gt;</span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`https://api.github.com/users/<span class="subst">$&#123;username&#125;</span>/repos`</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">json</span>()</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> userQueries = <span class="title function_">useQueries</span>(&#123;</span><br><span class="line">    <span class="attr">queries</span>: users.<span class="title function_">map</span>(<span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">queryKey</span>: [<span class="string">&quot;user&quot;</span>, user],</span><br><span class="line">        <span class="attr">queryFn</span>: <span class="function">() =&gt;</span> <span class="title function_">getRepos</span>(user),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">h1</span>&gt;</span>查看github用户的仓库<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>     <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setUsers([&quot;microsoft&quot;, &quot;tesla&quot;])&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">               更改获取用户      </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span>   &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;userQueries.map((query) =&gt;</span></span><br><span class="line"><span class="language-xml">        query.isLoading ? (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span>&gt;</span>加载中....<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ) : (</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">ol</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                     &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">            &#123;query.data.map((item) =&gt; (</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;item.full_name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            ))&#125;</span></span><br><span class="line"><span class="language-xml">                     </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        )</span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">         </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="依赖请求"><a href="#依赖请求" class="headerlink" title="依赖请求"></a>依赖请求</h2><p>请求 B 接口的某个参数依赖 A 接口请求返回的内容。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">IssueLabelFilter</span> = (<span class="params">&#123; owner, repo &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> labelsQuery = <span class="title function_">useQuery</span>([<span class="string">&quot;repos&quot;</span>, owner, repo, <span class="string">&quot;labels&quot;</span>], <span class="function">() =&gt;</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`https://api.github.com/repos/<span class="subst">$&#123;owner&#125;</span>/<span class="subst">$&#123;repo&#125;</span>/labels`</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">json</span>()</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> labels = labelsQuery.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> issuesQuery = <span class="title function_">useQuery</span>(</span><br><span class="line">    [<span class="string">&quot;repos&quot;</span>, owner, repo, <span class="string">&quot;issues&quot;</span>],</span><br><span class="line">    <span class="function">() =&gt;</span></span><br><span class="line">      <span class="title function_">fetch</span>(</span><br><span class="line">        <span class="string">`https://api.github.com/repos/<span class="subst">$&#123;owner&#125;</span>/<span class="subst">$&#123;repo&#125;</span>/issues?labels=<span class="subst">$&#123;labels[<span class="number">1</span>].name&#125;</span>`</span></span><br><span class="line">      ).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>()),</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 该配置项在value为true时，会触发接口请求。</span></span><br><span class="line"><span class="comment">       * 因此当第一个接口请求返回后，此时该配置项表达式为true</span></span><br><span class="line"><span class="comment">       * 会触发请求github中的issue列表</span></span><br><span class="line"><span class="comment">       * ①</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="attr">enabled</span>: !!labels,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>标签<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;labelsQuery.isLoading ? (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>加载标签中...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ) : (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;labelsQuery.data.map((label) =&gt; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;label.id&#125;</span>&gt;</span>&#123;label.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          ))&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        Issues</span></span><br><span class="line"><span class="language-xml">        &#123;Array.isArray(issuesQuery.data) ? `($&#123;labels[1].name&#125;)` : &quot;&quot;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;issuesQuery.isLoading ? (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>加载issues中...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ) : (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;issuesQuery.data.map((issue) =&gt; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;issue.id&#125;</span>&gt;</span>&#123;issue.title&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          ))&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">IssueLabelFilter</span> <span class="attr">owner</span>=<span class="string">&#123;</span>&quot;<span class="attr">facebook</span>&quot;&#125; <span class="attr">repo</span>=<span class="string">&#123;</span>&quot;<span class="attr">react</span>&quot;&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 react-query 中，当该组件被加载时，组件内的 useQuery 就会开始请求。<br>此时明显不符合需求，需求的要求是在加载完标签列表后，获取到第二个标签，再开始请求 issues 列表。<br>因此就需要使用到 useQuery 的 enabled 参数，当参数值为 false 时，将会禁止请求接口。<br>现在回到上面的例子中，当 labelsQuery 请求还没有结果时，labels 变量值为 undefined,此时在 ① 行代码中的值为 false，当 labelsQuery 请求结束时，labels 变量值为数组，此时在 ① 行代码中的值为 true，issuesQuery 开始请求数据。完全符合需求的要求。</p>
<h2 id="改进依赖查询接口一直为-loading-的问题"><a href="#改进依赖查询接口一直为-loading-的问题" class="headerlink" title="改进依赖查询接口一直为 loading 的问题"></a>改进依赖查询接口一直为 loading 的问题</h2><p>上面的例子中，issuesQuery 在加载后，由于处于禁用状态(配置项 enabled: false)，此时 isLoading 将会一直处于 true 的状态，直到 issuesQuery 请求完成数据后变为 false。<br>这种提示会非常奇怪，明明有一段时间里 issuesQuery 没有真正的请求数据，为啥要一直显示加载标签中…的内容？<br>解决办法是：需要一个字段来区分查询函数当前并没有请求数据，处于摸鱼状态。<br>在 useQuery 中当 fetchStatus 字段在为 idle 时，表示当前查询函数不在运行，处于摸鱼状态^ ^</p>
<blockquote>
<p>fetchStatus 一共有三个状态，fetching 状态表示当前查询函数正在运行，idle 状态表示当时查询函数不在运行。paused 状态表示查询函数尝试运行，但是无法进行请求，最可能的原因是由于当前没有联网，处于离线状态</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./style.css&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">IssueLabelFilter</span> = (<span class="params">&#123; owner, repo &#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> labelsQuery = <span class="title function_">useQuery</span>([<span class="string">&quot;repos&quot;</span>, owner, repo, <span class="string">&quot;labels&quot;</span>], <span class="function">() =&gt;</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`https://api.github.com/repos/<span class="subst">$&#123;owner&#125;</span>/<span class="subst">$&#123;repo&#125;</span>/labels`</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span></span><br><span class="line">      res.<span class="title function_">json</span>()</span><br><span class="line">    )</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> labels = labelsQuery.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> issuesQuery = <span class="title function_">useQuery</span>(</span><br><span class="line">    [<span class="string">&quot;repos&quot;</span>, owner, repo, <span class="string">&quot;issues&quot;</span>],</span><br><span class="line">    <span class="function">() =&gt;</span></span><br><span class="line">      <span class="title function_">fetch</span>(</span><br><span class="line">        <span class="string">`https://api.github.com/repos/<span class="subst">$&#123;owner&#125;</span>/<span class="subst">$&#123;repo&#125;</span>/issues?labels=<span class="subst">$&#123;labels[<span class="number">1</span>].name&#125;</span>`</span></span><br><span class="line">      ).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>()),</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">enabled</span>: !!labels, <span class="comment">// 👈🏻❗️❗️❗️该配置项在value为true时，会触发接口请求。因此当第一个接口请求返回后，此时该配置项表达式为true，会触发请求github中的issue列表</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h2</span>&gt;</span>标签<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;labelsQuery.isLoading ? (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>加载标签中...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ) : (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;labelsQuery.data.map((label) =&gt; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;label.id&#125;</span>&gt;</span>&#123;label.name&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          ))&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">hr</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      // 👇🏻下面的代码判断了在查询函数处于摸鱼状态时，不显示任何内容 ②&#123;issuesQuery.isLoading &amp;&amp;</span></span><br><span class="line"><span class="language-xml">      issuesQuery.fetchStatus === &quot;idle&quot; ? null : (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            Issues</span></span><br><span class="line"><span class="language-xml">            &#123;Array.isArray(issuesQuery.data) ? `($&#123;labels[1].name&#125;)` : &quot;&quot;&#125;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          // 当查询函数处于干活状态时，显示加载issues中 ③&#123;issuesQuery.isLoading ? (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>加载issues中...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          ) : (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              &#123;issuesQuery.data.map((issue) =&gt; (</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;issue.id&#125;</span>&gt;</span>&#123;issue.title&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              ))&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          )&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">IssueLabelFilter</span> <span class="attr">owner</span>=<span class="string">&#123;</span>&quot;<span class="attr">facebook</span>&quot;&#125; <span class="attr">repo</span>=<span class="string">&#123;</span>&quot;<span class="attr">react</span>&quot;&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>并行请求</li>
</ul>
<p>通过在查询函数中，使用<code>Promise.all</code>来进行接口的合并请求<br>通过<code>useQueries</code>来进行动态的并行请求</p>
<ul>
<li>依赖请求</li>
</ul>
<p><code>isLoading</code>为<code>true</code>表示第一次请求未返回结果前这段时间的状态，如果对接口进行了禁用，可以通过<code>fetchStatus</code>为<code>idle</code>来获取接口禁用请求这段时间的状态。</p>
<h1 id="缓存状态"><a href="#缓存状态" class="headerlink" title="缓存状态"></a>缓存状态</h1><p>react-query 通常在挂载组件时获取数据；在获取数据后，将数据存储到缓存中，并将该数据提供给组件使用。<br>在获取数据时,有三种状态.<code>loading</code>,<code>success</code>,<code>error</code>.<br>也对应<code>useQuery</code>钩子中的<code>isLoading</code>、<code>isSuccess</code>、<code>isError</code>属性<br>当 react-query 进行后端请求查询时，会有以下三个状态：</p>
<ul>
<li><code>idle</code>：空闲，表示当前不需要从后端获取数据</li>
<li><code>fetching</code>: 获取数据，表示当前正在从后端获取数据</li>
<li><code>paused</code>：暂停，表示原本尝试从后端获取数据，但是通常由于未联网的原因导致暂停</li>
</ul>
<p><code>fetchStatus</code>将会在 idle、fetching、paused 这三个状态间经历循环</p>
<blockquote>
<p>在 react-query 中 status 为<strong>loading</strong>状态(或者<strong>isLoading</strong>为 true)指的是第一次从后端获取成功之前的状态.<br>而 fetchStatus 为<strong>fetching</strong>状态(或者<strong>isFetching</strong>为 true)指的是每次从后端获取数据的加载状态（包含第一次获取数据）。</p>
</blockquote>
<p>整个生命周期:<br>假如你使用 react-query 从 Github 的接口请求了 react 的 issue 列表，你此次的请求结果将会在 status 中标记为 success 或 error，或者从 isSuccess、isError 中判断请求成功或者失败。<br>请求后端数据成功后，在写入缓存时，此时的缓存状态是<code>fresh</code>(最新)状态，但是很快(默认过期时间是 0ms)就会变为<code>stale</code>(老旧)状态。<br>如果使用 react 的 issue 列表的每个组件都被卸载后，issue 列表数据的缓存状态将会被标记为<code>inactive</code>(不活跃)状态。此时数据将不会被删除，直到一段时间后(默认为 5 分钟)，react-query 将会从缓存中删除该条数据。<br>在变为<code>inactive</code>(不活跃)状态之前，该条数据将会在<code>fresh</code>(最新)与<code>stale</code>(老旧)之间来回切换，同时接口请求状态也会在<code>idle</code>与<code>fetching</code> 之间切换。</p>
<h1 id="fresh-最新态和-stale-老旧态"><a href="#fresh-最新态和-stale-老旧态" class="headerlink" title="fresh 最新态和 stale 老旧态"></a>fresh 最新态和 stale 老旧态</h1><p>react-query 是否会触发查询函数，并从后端接口获取数据，与缓存状态是：<code>fresh</code>(最新)状态或<code>stale</code>(老旧)状态有关。如果缓存状态是<code>stale</code>(老旧)，表示该查询将会有资格重新获取，但如果缓存状态是<code>fresh</code>(最新)的，就不会重新获取。</p>
<p>如果使用 react 的 issue 列表的每个组件都被卸载后，issue 列表数据的缓存状态将会被标记为<code>inactive</code>(不活跃)状态。此时数据将不会被删除，直到一段时间后(默认为 5 分钟)，react-query 将会从缓存中删除该条数据。<br>在变为<code>inactive</code>(不活跃)状态之前，该条数据将会在<code>fresh</code>(最新)与<code>stale</code>(老旧)之间来回切换，同时接口请求状态也会在<code>idle</code>与<code>fetching</code>之间切换。</p>
<h2 id="staleTime"><a href="#staleTime" class="headerlink" title="staleTime"></a>staleTime</h2><p>在默认情况下，后端返回的数据其缓存状态将会立即<code>(&#123;staleTime: 0&#125;)</code>从<code>fresh</code>(最新)状态变为<code>stale</code>(老旧)状态。<br>其实这样做不难理解，因为当你请求到数据后，后端的数据有可能就发生了变化，因此当拿到后端返回的数据瞬间，缓存状态就是<code>stale</code>(陈旧)的了。<br>你可以将配置中的<code>staleTime</code>，设置一个毫秒数的数字，那么缓存将会在<code>staleTime</code>毫秒后过期(从<code>fresh</code>(最新)变为<code>stale</code>(陈旧))<br>如果把<code>staleTime</code>设置为<code>Infinity</code>，表示当前查询的数据将只会获取一次，且会在整个网页的生命周期内缓存。</p>
<h2 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h2><p>在 react-query 中并不是缓存从 fresh(最新)转换为 stale(老旧)状态时，就会重新获取。</p>
<ol>
<li>当组件首次加载，将会触发数据的获取。如果组件被卸载后再次被加载，此时也会触发数据的重新获取。</li>
<li>当用户把浏览器重新聚焦,或者切换到当前选项卡。这个触发条件是默认开启的，如果希望关闭这个触发条件，可以把<code>refetchOnWindowFocus</code>选项设置为 false 来禁止。</li>
<li>网络重新连接。可以使用<code>refetchOnReconnect</code>来禁止。</li>
<li>定时刷新。当你在配置中设置<code>refetchInterval</code>为数字(代表 xxx 毫秒)时。无论此时数据是<code>fresh</code>(最新)还是<code>stale</code>(老旧)的缓存状态，react-query 都会在你设置的毫秒时间间隔内重新获取数据</li>
</ol>
<h1 id="清理缓存"><a href="#清理缓存" class="headerlink" title="清理缓存"></a>清理缓存</h1><p>在缓存状态处于<code>inactive</code>(不活跃)状态或者使用这个查询数据的组件卸载时，超过 5 分钟（默认情况下）后，react-query 将会自动清除该缓存。<br>如果你希望自定义这个时间，你可以使用<code>cacheTime</code>配置，下面的例子中将<code>cacheTime</code>设置为 0，实现的效果是，当查询数据在<code>inactive</code>状态时，立即从缓存中删除。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userQuery = <span class="title function_">useQuery</span>(</span><br><span class="line">  [<span class="string">&quot;user&quot;</span>, username],</span><br><span class="line">  <span class="function">() =&gt;</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`https://api.github.com/users/<span class="subst">$&#123;username&#125;</span>`</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>()),</span><br><span class="line">  &#123; <span class="attr">cacheTime</span>: <span class="number">0</span> &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h1 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h1><h2 id="错误重试"><a href="#错误重试" class="headerlink" title="错误重试"></a>错误重试</h2><p>当一个查询无法重新获取时，将会基于指数退避算法的时间间隔，尝试请求 3 次。 从 1s 的延迟起步，到 30s 的最大延迟。下面是默认重试策略的相关配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> exampleQuery = <span class="title function_">useQuery</span>(<span class="string">&quot;example&quot;</span>, fetchExample, &#123;</span><br><span class="line">  <span class="attr">retry</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">retryDelay</span>: <span class="function">(<span class="params">attempt</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">min</span>(attempt &gt; <span class="number">1</span> ? <span class="number">2</span> ** attempt * <span class="number">1000</span> : <span class="number">1000</span>, <span class="number">30</span> * <span class="number">1000</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>PS: 如果只配置了 retry 的次数，那么 retry 的时间间隔，将会默认采用指数退避算法。</p>
</blockquote>
<h2 id="错误边界"><a href="#错误边界" class="headerlink" title="错误边界"></a>错误边界</h2><p>使用<code>react-error-boundary</code>这个包，来减少相关错误边界的配置。<br>需要在配置项中，配置<code>useErrorBoundary</code>为<code>true</code>，之后错误边界就能捕获到相关的报错</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./style.css&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ErrorBoundary</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-error-boundary&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fetchWithError</span> = <span class="keyword">async</span> (<span class="params">url, options = &#123;&#125;</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, options);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> errorMessage = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (response.<span class="property">status</span> !== <span class="number">200</span>) &#123;</span><br><span class="line">    errorMessage += <span class="string">`请求错误状态码为： <span class="subst">$&#123;response.status&#125;</span>. `</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> body = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">  <span class="keyword">if</span> (body.<span class="property">message</span>) &#123;</span><br><span class="line">    errorMessage += body.<span class="property">message</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(errorMessage);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (errorMessage) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(errorMessage);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> body;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Repos</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> reposQuery = <span class="title function_">useQuery</span>(</span><br><span class="line">    [<span class="string">&quot;users&quot;</span>],</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">fetchWithError</span>(<span class="string">&quot;https://api.github.com/users/facebook/repos&quot;</span>),</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">useErrorBoundary</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">onError</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(error, <span class="string">&quot;onError&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;JSON.stringify(reposQuery.data)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Gists</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> gistsQuery = <span class="title function_">useQuery</span>(</span><br><span class="line">    [<span class="string">&quot;gists&quot;</span>],</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">fetchWithError</span>(<span class="string">&quot;https://api.github.com/users/facebook/gists&quot;</span>),</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">useErrorBoundary</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">onError</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(error, <span class="string">&quot;onError&quot;</span>),</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;JSON.stringify(gistsQuery.data)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">QueryError</span>(<span class="params">&#123; error &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>出现错误<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;error.message&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ErrorBoundary</span> <span class="attr">FallbackComponent</span>=<span class="string">&#123;QueryError&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Repos</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Gists</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ErrorBoundary</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="错误回调"><a href="#错误回调" class="headerlink" title="错误回调"></a>错误回调</h2><p>在 react-query 中，你可以在配置中设置 onError 属性，来获取错误的回调。包含了 error 的数据。<br>你可以在回调中，调用消息弹窗来提示报错信息，如果你使用 ant-design 组件库，你可以这么写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> reposQuery = <span class="title function_">useQuery</span>(</span><br><span class="line">  [<span class="string">&quot;users&quot;</span>],</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="title function_">fetchWithError</span>(<span class="string">&quot;https://api.github.com/users/facebook/repos&quot;</span>),</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">onError</span>: <span class="function">(<span class="params">error</span>) =&gt;</span> message.<span class="title function_">error</span>(&#123; <span class="attr">content</span>: error.<span class="property">message</span> &#125;),</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="针对重新获取数据失败处理的方式"><a href="#针对重新获取数据失败处理的方式" class="headerlink" title="针对重新获取数据失败处理的方式"></a>针对重新获取数据失败处理的方式</h2><p>在第一次请求数据时，查询函数返回成功。在页面失焦后，重新聚焦，触发第二次请求时，查询函数返回失败。<br>如何处理?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;react-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> mockQuery = <span class="title function_">useQuery</span>(</span><br><span class="line">    [<span class="string">&quot;mock&quot;</span>],</span><br><span class="line">    <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span>));</span><br><span class="line">      <span class="keyword">if</span> (count === <span class="number">0</span>) &#123;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;成功&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;失败&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">retry</span>: <span class="literal">false</span> &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         &#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;mockQuery.isError ? (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;error-message&quot;</span>&gt;</span>&#123;mockQuery.error.message&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ) : null&#125;</span></span><br><span class="line"><span class="language-xml">          &#123;mockQuery.isLoading ? &quot;首次加载中...&quot; : mockQuery.data&#125;   </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以根据不同的情况来指定你的显示策略：</p>
<ul>
<li>当重新获取数据失败后，你可以像上面的例子一样即显示缓存数据，又显示报错</li>
<li>也可以判断 isError 字段为 true 时，只显示报错信息，隐藏缓存数据。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/19/%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/19/%E5%B8%B8%E7%94%A8%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">常用组件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-19 16:23:33" itemprop="dateCreated datePublished" datetime="2022-10-19T16:23:33+08:00">2022-10-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:23" itemprop="dateModified" datetime="2022-11-08T08:54:23+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="树形选项点击主项子项默认全选"><a href="#树形选项点击主项子项默认全选" class="headerlink" title="树形选项点击主项子项默认全选"></a>树形选项点击主项子项默认全选</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">carSelectedChange</span>(<span class="params">val, row</span>) &#123;</span><br><span class="line">  <span class="comment">//先重置</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">responseData</span>.<span class="property">carInfo</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">car</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (val.<span class="title function_">find</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> x.<span class="property">accCarSeq</span> == car.<span class="property">accCarSeq</span>)) &#123;</span><br><span class="line">      car.<span class="property">checked</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      car.<span class="property">checked</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (car.<span class="property">children</span>) &#123;</span><br><span class="line">      car.<span class="property">children</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (val.<span class="title function_">find</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> x.<span class="property">accCarSeq</span> == p.<span class="property">accCarSeq</span>)) &#123;</span><br><span class="line">          p.<span class="property">checked</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          p.<span class="property">checked</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (row) &#123;</span><br><span class="line">    <span class="comment">//单独操作行</span></span><br><span class="line">    <span class="keyword">let</span> action = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断是否是新增</span></span><br><span class="line">    <span class="keyword">if</span> (val.<span class="title function_">find</span>(<span class="function">(<span class="params">x</span>) =&gt;</span> x.<span class="property">accCarSeq</span> == row.<span class="property">accCarSeq</span>)) &#123;</span><br><span class="line">      <span class="comment">//新增</span></span><br><span class="line">      action = <span class="string">&quot;add&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//移除</span></span><br><span class="line">      action = <span class="string">&quot;remove&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> carIndex = <span class="variable language_">this</span>.<span class="property">responseData</span>.<span class="property">carInfo</span>.<span class="title function_">findIndex</span>(</span><br><span class="line">      <span class="function">(<span class="params">car</span>) =&gt;</span> car.<span class="property">accCarSeq</span> == row.<span class="property">accCarSeq</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (carIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">responseData</span>.<span class="property">carInfo</span>[carIndex].<span class="property">children</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">        p.<span class="property">checked</span> = action == <span class="string">&quot;add&quot;</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">carTable</span>.<span class="title function_">toggleRowSelection</span>(p, action == <span class="string">&quot;add&quot;</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">responseData</span>.<span class="property">carInfo</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">car</span>) =&gt;</span> &#123;</span><br><span class="line">        car.<span class="property">children</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (p.<span class="property">accCarSeq</span> == row.<span class="property">accCarSeq</span> &amp;&amp; action == <span class="string">&quot;add&quot;</span>) &#123;</span><br><span class="line">            car.<span class="property">checked</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">carTable</span>.<span class="title function_">toggleRowSelection</span>(car, <span class="literal">true</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//全选</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">responseData</span>.<span class="property">carInfo</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">car</span>) =&gt;</span> &#123;</span><br><span class="line">      car.<span class="property">children</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> &#123;</span><br><span class="line">        p.<span class="property">checked</span> = car.<span class="property">checked</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">carTable</span>.<span class="title function_">toggleRowSelection</span>(p, p.<span class="property">checked</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/12/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/12/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">单元测试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-10-12 17:29:11" itemprop="dateCreated datePublished" datetime="2022-10-12T17:29:11+08:00">2022-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-11-08 08:54:24" itemprop="dateModified" datetime="2022-11-08T08:54:24+08:00">2022-11-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>常用测试工具 Jest,用于测试 js 相关.<br>测试 react 使用<code>@testing-library/react</code><br>测试 react-hook 使用<code>@testing-library/react-hooks</code></p>
<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add @testing-library/react-hooks msw -D</span><br></pre></td></tr></table></figure>

<p>新建<code>__tests__</code>文件夹,约定<code>__</code>为测试使用文件夹.</p>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>在<code>__tests__/http</code>中测试<code>http</code>模块.<br>下面模块用于模拟异步请求.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; setupServer &#125; <span class="keyword">from</span> <span class="string">&quot;msw/node&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> server = <span class="title function_">setupServer</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// beforeAll是Jest测试库中一个方法,表示执行所有测试之前先执行</span></span><br><span class="line"><span class="title function_">beforeAll</span>(<span class="function">() =&gt;</span> server.<span class="title function_">listen</span>());</span><br><span class="line"><span class="comment">//每次测试完毕都重置mock路由</span></span><br><span class="line"><span class="title function_">afterEach</span>(<span class="function">() =&gt;</span> server.<span class="title function_">resetHandlers</span>());</span><br><span class="line"><span class="comment">//所有测试完毕后,关闭mock路由</span></span><br><span class="line"><span class="title function_">afterAll</span>(<span class="function">() =&gt;</span> server.<span class="title function_">close</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始测试,第二个参数是回调函数就是测试内容</span></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&quot;http异步发送请求&quot;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> endpoint = <span class="string">&quot;test-endpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> mockResult = &#123; <span class="attr">mockValue</span>: <span class="string">&quot;mock&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用msw模拟mock</span></span><br><span class="line">  server.<span class="title function_">use</span>(</span><br><span class="line">    <span class="comment">// rest是msw中用于restful接口的方法</span></span><br><span class="line">    rest.<span class="title function_">get</span>(<span class="string">`<span class="subst">$&#123;apiUrl&#125;</span>/<span class="subst">$&#123;endpoint&#125;</span>`</span>, <span class="function">(<span class="params">req, res, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">res</span>(ctx.<span class="title function_">json</span>(mockResult));</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 使用http模块返回mock值</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">http</span>(endpoint);</span><br><span class="line">  <span class="comment">// 期望http的返回值和mock数据相等(注意不是完全相等,完全是toBe)</span></span><br><span class="line">  <span class="title function_">expect</span>(result).<span class="title function_">toEqual</span>(mockResult);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&quot;http请求时携带token&quot;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> token = <span class="string">&quot;FAKE_TOKEN&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> endpoint = <span class="string">&quot;test-endpoint&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> mockResult = &#123; <span class="attr">mockValue</span>: <span class="string">&quot;mock&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">request</span>: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用msw模拟mock</span></span><br><span class="line">  server.<span class="title function_">use</span>(</span><br><span class="line">    <span class="comment">// rest是msw中用于restful接口的方法</span></span><br><span class="line">    rest.<span class="title function_">get</span>(<span class="string">`<span class="subst">$&#123;apiUrl&#125;</span>/<span class="subst">$&#123;endpoint&#125;</span>`</span>, <span class="function">(<span class="params">req, res, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">      request = req;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">res</span>(ctx.<span class="title function_">json</span>(mockResult));</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 使用http模块返回mock值</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">http</span>(endpoint, &#123; token &#125;);</span><br><span class="line">  <span class="comment">// 期望http的返回值和mock数据相等(注意不是完全相等,完全是toBe)</span></span><br><span class="line">  <span class="title function_">expect</span>(request.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;Authorization&quot;</span>)).<span class="title function_">toBe</span>(<span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="测试-Hook"><a href="#测试-Hook" class="headerlink" title="测试 Hook"></a>测试 Hook</h2><p>新建<code>__test__/use-async</code>文件.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; act, renderHook &#125; <span class="keyword">from</span> <span class="string">&quot;@testing-library/react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useAsync &#125; <span class="keyword">from</span> <span class="string">&quot;utils/use-async&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">defaultState</span>: <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> useAsync&gt; = &#123;</span><br><span class="line">  <span class="attr">stat</span>: <span class="string">&quot;idle&quot;</span>,</span><br><span class="line">  <span class="attr">error</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">data</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">isIdle</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">isLoading</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">isError</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">isSuccess</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">run</span>: expect.<span class="title function_">any</span>(<span class="title class_">Function</span>),</span><br><span class="line">  <span class="attr">setData</span>: expect.<span class="title function_">any</span>(<span class="title class_">Function</span>),</span><br><span class="line">  <span class="attr">setError</span>: expect.<span class="title function_">any</span>(<span class="title class_">Function</span>),</span><br><span class="line">  <span class="attr">retry</span>: expect.<span class="title function_">any</span>(<span class="title class_">Function</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">loadingState</span>: <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> useAsync&gt; = &#123;</span><br><span class="line">  ...defaultState,</span><br><span class="line">  <span class="attr">stat</span>: <span class="string">&quot;loading&quot;</span>,</span><br><span class="line">  <span class="attr">isLoading</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">isIdle</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="attr">successState</span>: <span class="title class_">ReturnType</span>&lt;<span class="keyword">typeof</span> useAsync&gt; = &#123;</span><br><span class="line">  ...defaultState,</span><br><span class="line">  <span class="attr">stat</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">  <span class="attr">isSuccess</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">isIdle</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试脚本</span></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&quot;useAsync可以异步处理&quot;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">resolve</span>: <span class="built_in">any</span>, reject;</span><br><span class="line">  <span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> &#123;</span><br><span class="line">    resolve = res;</span><br><span class="line">    reject = rej;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; result &#125; = <span class="title function_">renderHook</span>(<span class="function">() =&gt;</span> <span class="title function_">useAsync</span>());</span><br><span class="line">  <span class="comment">// 期望Hook的默认返回值与test的默认值一致</span></span><br><span class="line">  <span class="title function_">expect</span>(result.<span class="property">current</span>).<span class="title function_">toEqual</span>(defaultState);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">p</span>: <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line">  <span class="comment">// 如果操作包含改变setState,需要使用act包裹</span></span><br><span class="line">  <span class="title function_">act</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    p = result.<span class="property">current</span>.<span class="title function_">run</span>(promise);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 期望刚创建的promise中是loading状态</span></span><br><span class="line">  <span class="title function_">expect</span>(result.<span class="property">current</span>).<span class="title function_">toEqual</span>(loadingState);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 期望promise执行完毕后,返回的值是success状态的值</span></span><br><span class="line">  <span class="keyword">const</span> resolvedValue = &#123; <span class="attr">mockValue</span>: <span class="string">&quot;resolved&quot;</span> &#125;;</span><br><span class="line">  <span class="title function_">act</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 执行resolve,之后promise就是fulfilled</span></span><br><span class="line">    <span class="title function_">resolve</span>(resolvedValue);</span><br><span class="line">    <span class="keyword">await</span> p;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">expect</span>(result.<span class="property">current</span>).<span class="title function_">toEqual</span>(&#123;</span><br><span class="line">    ...successState,</span><br><span class="line">    <span class="attr">data</span>: resolvedValue,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="测试组件"><a href="#测试组件" class="headerlink" title="测试组件"></a>测试组件</h2><p>新建<code>__tests__/mark.tsx</code>用于测试高亮组件.</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; renderHook &#125; <span class="keyword">from</span> <span class="string">&quot;@testing-library/react-hooks&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; screen &#125; <span class="keyword">from</span> <span class="string">&quot;@testing-library/react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Mark</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../components/mark&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&quot;Mark组件正确高亮关键词&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> name = <span class="string">&quot;物料管理&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> keyword = <span class="string">&quot;管理&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">renderHook</span>(<span class="function">() =&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Mark</span> <span class="attr">name</span>=<span class="string">&#123;name&#125;</span> <span class="attr">keyword</span>=<span class="string">&#123;keyword&#125;</span> /&gt;</span></span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 期望keyword存在document中</span></span><br><span class="line">  <span class="title function_">expect</span>(screen.<span class="title function_">getByText</span>(keyword)).<span class="title function_">toBeInTheDocument</span>();</span><br><span class="line">  <span class="title function_">expect</span>(screen.<span class="title function_">getByText</span>(keyword)).<span class="title function_">toHaveStyle</span>(<span class="string">&quot;color: #257AFD&quot;</span>);</span><br><span class="line">  <span class="comment">// 期望其他字没有高亮颜色</span></span><br><span class="line">  <span class="title function_">expect</span>(screen.<span class="title function_">getByText</span>(<span class="string">&quot;物料&quot;</span>)).<span class="property">not</span>.<span class="title function_">toHaveStyle</span>(<span class="string">&quot;color: #257AFD&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zax Tseng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
