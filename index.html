<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.13.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="ZAX">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="ZAX">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zax Tseng">
<meta property="article:tag" content="javascript, React, Vue, HTML5">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ZAX</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">ZAX</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zax Tseng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/02/02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/12/02/02/" class="post-title-link" itemprop="url">2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-12-02 09:01:56" itemprop="dateCreated datePublished" datetime="2022-12-02T09:01:56+08:00">2022-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:17" itemprop="dateModified" datetime="2022-12-08T17:09:17+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h1><h3 id="从输入-URL-到页面加载的全过程"><a href="#从输入-URL-到页面加载的全过程" class="headerlink" title="从输入 URL 到页面加载的全过程"></a>从输入 URL 到页面加载的全过程</h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e44aa8a92602405db3c12161b71e2094~tplv-k3u1fbpfcp-zoom-1.image#crop=0&crop=0&crop=1&crop=1&id=N3OQj&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p><img src="/%5Bhttps:/p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e44aa8a92602405db3c12161b71e2094~tplv-k3u1fbpfcp-zoom-1.image%5D(https:/p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e44aa8a92602405db3c12161b71e2094~tplv-k3u1fbpfcp-zoom-1.image)" alt="流程"></p>
<ol>
<li>首先在浏览器中输入 URL</li>
<li>查找缓存：浏览器先查看浏览器缓存-系统缓存-路由缓存中是否有该地址页面，如果有则显示页面内容。如果没有则进行下一步。</li>
</ol>
<ul>
<li>浏览器缓存：浏览器会记录 DNS 一段时间，因此，只是第一个地方解析 DNS 请求；</li>
<li>操作系统缓存:如果在浏览器缓存中不包含这个记录，则会使系统调用操作系统， 获取操作系统的记录(保存最近的 DNS 查询缓存)；</li>
<li>路由器缓存：如果上述两个步骤均不能成功获取 DNS 记录，继续搜索路由器缓存；</li>
<li>ISP 缓存：若上述均失败，继续向 ISP 搜索。</li>
</ul>
<ol start="3">
<li>DNS 域名解析：浏览器向 DNS 服务器发起请求，解析该 URL 中的域名对应的 IP 地址。<code>DNS服务器是基于UDP的，因此会用到UDP协议</code>。</li>
<li>建立 TCP 连接：解析出 IP 地址后，根据 IP 地址和默认 80 端口，和服务器建立 TCP 连接</li>
<li>发起 HTTP 请求：浏览器发起读取文件的 HTTP 请求，，该请求报文作为 TCP 三次握手的第三次数据发送给服务器</li>
<li>服务器响应请求并返回结果：服务器对浏览器请求做出响应，并把对应的 html 文件发送给浏览器</li>
<li>关闭 TCP 连接：通过四次挥手释放 TCP 连接</li>
<li>浏览器渲染：客户端（浏览器）解析 HTML 内容并渲染出来，浏览器接收到数据包后的解析流程为：</li>
</ol>
<ul>
<li>构建 DOM 树：词法分析然后解析成 DOM 树（dom tree），是由 dom 元素及属性节点组成，树的根是 document 对象</li>
<li>构建 CSS 规则树：生成 CSS 规则树（CSS Rule Tree）</li>
<li>构建 render 树：Web 浏览器将 DOM 和 CSSOM 结合，并构建出渲染树（render tree）</li>
<li>布局（Layout）：计算出每个节点在屏幕中的位置</li>
<li>绘制（Painting）：即遍历 render 树，并使用 UI 后端层绘制每个节点。</li>
</ul>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a90660027f0d4c559732519bad4c6323~tplv-k3u1fbpfcp-zoom-1.image#crop=0&crop=0&crop=1&crop=1&id=THEl7&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<ol start="9">
<li>JS 引擎解析过程：调用 JS 引擎执行 JS 代码（JS 的解释阶段，预处理阶段，执行阶段生成执行上下文，VO，作用域链、回收机制等等）</li>
</ol>
<ul>
<li>创建 window 对象：window 对象也叫全局执行环境，当页面产生时就被创建，所有的全局变量和函数都属于 window 的属性和方法，而 DOM Tree 也会映射在 window 的 doucment 对象上。当关闭网页或者关闭浏览器时，全局执行环境会被销毁。</li>
<li>加载文件：完成 js 引擎分析它的语法与词法是否合法，如果合法进入预编译</li>
<li>预编译：在预编译的过程中，浏览器会寻找全局变量声明，把它作为 window 的属性加入到 window 对象中，并给变量赋值为’undefined’；寻找全局函数声明，把它作为 window 的方法加入到 window 对象中，并将函数体赋值给他（匿名函数是不参与预编译的，因为它是变量）。而变量提升作为不合理的地方在 ES6 中已经解决了，函数提升还存在。</li>
<li>解释执行：执行到变量就赋值，如果变量没有被定义，也就没有被预编译直接赋值，在 ES5 非严格模式下这个变量会成为 window 的一个属性，也就是成为全局变量。string、int 这样的值就是直接把值放在变量的存储空间里，object 对象就是把指针指向变量的存储空间。函数执行，就将函数的环境推入一个环境的栈中，执行完成后再弹出，控制权交还给之前的环境。JS 作用域其实就是这样的执行流机制实现的。</li>
</ul>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/7005468491067162655"># DNS 域名解析过程</a> ☞<a target="_blank" rel="noopener" href="https://juejin.cn/post/6992597760935460901"># 浏览器的工作原理</a></p>
<h3 id="在浏览器中输入-URL-到显示页面经历哪些过程，涉及到哪些协议？"><a href="#在浏览器中输入-URL-到显示页面经历哪些过程，涉及到哪些协议？" class="headerlink" title="在浏览器中输入 URL 到显示页面经历哪些过程，涉及到哪些协议？"></a>在浏览器中输入 URL 到显示页面经历哪些过程，涉及到哪些协议？</h3><p>浏览器要将 URL 解析为 IP 地址，解析域名就要用到 DNS 协议，首先主机会查询 DNS 的缓存，如果没有就给本地 DNS 发送查询请求。DNS 查询分为两种方式，一种是递归查询，一种是迭代查询。如果是迭代查询，本地的 DNS 服务器，向根域名服务器发送查询请求，根域名服务器告知该域名的一级域名服务器，然后本地服务器给该一级域名服务器发送查询请求，然后依次类推直到查询到该域名的 IP 地址。<code>DNS服务器是基于UDP的，因此会用到UDP协议。</code></p>
<p>得到 IP 地址后，浏览器就要与服务器建立一个 http 连接。因此要用到 http 协议。http 生成一个 get 请求报文，将该报文传给 TCP 层处理，所以还会用到 TCP 协议。如果采用 https 还会使用 https 协议先对 http 数据进行加密。TCP 层如果有需要先将 HTTP 数据包分片，分片依据路径 MTU 和 MSS。TCP 的数据包然后会发送给 IP 层，用到 IP 协议。IP 层通过路由选路，一跳一跳发送到目的地址。当然在一个网段内的寻址是通过以太网协议实现(也可以是其他物理层协议，比如 PPP，SLIP)，以太网协议需要直到目的 IP 地址的物理地址，有需要 ARP 协议。</p>
<p>其中：</p>
<p>1、<code>DNS协议，http协议，https协议属于应用层</code></p>
<p>应用层是体系结构中的最高层。应用层确定进程之间通信的性质以满足用户的需要。这里的进程就是指正在运行的程序。应用层不仅要提供应用进程所需要的信息交换和远地操作，而且还要作为互相作用的应用进程的用户代理，来完成一些为进行语义上有意义的信息交换所必须的功能。应用层直接为用户的应用进程提供服务。</p>
<p>2、<code>TCP/UDP属于传输层</code></p>
<p>传输层的任务就是负责主机中两个进程之间的通信。因特网的传输层可使用两种不同协议：即面向连接的传输控制协议 TCP，和无连接的用户数据报协议 UDP。面向连接的服务能够提供可靠的交付，但无连接服务则不保证提供可靠的交付，它只是“尽最大努力交付”。这两种服务方式都很有用，备有其优缺点。在分组交换网内的各个交换结点机都没有传输层。</p>
<p>3、<code>IP协议，ARP协议属于网络层</code></p>
<p>网络层负责为分组交换网上的不同主机提供通信。在发送数据时，网络层将运输层产生的报文段或用户数据报封装成分组或包进行传送。在 TCP&#x2F;IP 体系中，分组也叫作 IP 数据报，或简称为数据报。网络层的另一个任务就是要选择合适的路由，使源主机运输层所传下来的分组能够交付到目的主机。</p>
<p>4、数据链路层</p>
<p>当发送数据时，数据链路层的任务是将在网络层交下来的 IP 数据报组装成帧，在两个相邻结点间的链路上传送以帧为单位的数据。每一帧包括数据和必要的控制信息（如同步信息、地址信息、差错控制、以及流量控制信息等）。控制信息使接收端能够知道—个帧从哪个比特开始和到哪个比特结束。控制信息还使接收端能够检测到所收到的帧中有无差错。</p>
<p>5、物理层</p>
<p>物理层的任务就是透明地传送比特流。在物理层上所传数据的单位是比特。传递信息所利用的一些物理媒体，如双绞线、同轴电缆、光缆等，并不在物理层之内而是在物理层的下面。因此也有人把物理媒体当做第 0 层。</p>
<h3 id="浏览器的主要功能"><a href="#浏览器的主要功能" class="headerlink" title="浏览器的主要功能"></a>浏览器的主要功能</h3><p>浏览器的主要功能就是向服务器发出请求，在浏览器窗口中展示您选择的网络资源。这里所说的资源一般是指 HTML 文档，也可以是 PDF、图片或其他的类型。资源的位置由用户使用 URI（统一资源标示符）指定。</p>
<h3 id="浏览器的工作原理"><a href="#浏览器的工作原理" class="headerlink" title="浏览器的工作原理"></a>浏览器的工作原理</h3><p>渲染引擎一开始会从网络层获取请求文档的内容，内容的大小一般限制在 8000 个块以内。</p>
<p>然后进行如下所示的基本流程：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ef6cb226b374e89914a2315e4ca9ba9~tplv-k3u1fbpfcp-zoom-1.image#crop=0&crop=0&crop=1&crop=1&id=sGDPK&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>图：渲染引擎的基本流程。</p>
<p>渲染引擎将开始<code>解析 HTML 文档</code>，并将各标记逐个转化成“内容树”上的  <a href="https://link.juejin.cn/?target=https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/%23DOM">DOM</a>  节点。同时也会<code>解析外部 CSS 文件以及样式元素中的样式数据</code>。HTML 中这些带有视觉指令的样式信息将用于创建另一个树结构：<code>[渲染树](https://link.juejin.cn?target=https%3A%2F%2Fwww.html5rocks.com%2Fzh%2Ftutorials%2Finternals%2Fhowbrowserswork%2F%23Render_tree_construction)</code>。</p>
<p>渲染树包含多个带有视觉属性（如颜色和尺寸）的矩形。这些矩形的排列顺序就是它们将在屏幕上显示的顺序。</p>
<p>渲染树构建完毕之后，进入“<a href="https://link.juejin.cn/?target=https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/%23layout">布局</a>”处理阶段，也就是为每个节点分配一个应出现在屏幕上的确切坐标。下一个阶段是<a href="https://link.juejin.cn/?target=https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/%23Painting">绘制</a> - 渲染引擎会遍历渲染树，由用户界面后端层将每个节点绘制出来。</p>
<p>需要着重指出的是，这是一个渐进的过程。为达到更好的用户体验，渲染引擎会力求尽快将内容显示在屏幕上。它不必等到整个 HTML 文档解析完毕之后，就会开始构建呈现树和设置布局。在不断接收和处理来自网络的其余内容的同时，渲染引擎会将部分内容解析并显示出来。</p>
<h3 id="浏览器的主要组成部分是什么？"><a href="#浏览器的主要组成部分是什么？" class="headerlink" title="浏览器的主要组成部分是什么？"></a>浏览器的主要组成部分是什么？</h3><ol>
<li><strong>用户界面</strong> - 包括地址栏、前进&#x2F;后退按钮、书签菜单等。除了浏览器主窗口显示的您请求的页面外，其他显示的各个部分都属于用户界面。</li>
<li><strong>浏览器引擎</strong> - 在用户界面和呈现引擎之间传送指令。</li>
<li><strong>呈现引擎</strong> - 负责显示请求的内容。如果请求的内容是 HTML，它就负责解析 HTML 和 CSS 内容，并将解析后的内容显示在屏幕上。</li>
<li><strong>网络</strong> - 用于网络调用，比如 HTTP 请求。其接口与平台无关，并为所有平台提供底层实现。</li>
<li><strong>用户界面后端</strong> - 用于绘制基本的窗口小部件，比如组合框和窗口。其公开了与平台无关的通用接口，而在底层使用操作系统的用户界面方法。</li>
<li><strong>JavaScript 解释器</strong>。用于解析和执行 JavaScript 代码。</li>
<li><strong>数据存储</strong>。这是持久层。浏览器需要在硬盘上保存各种数据，例如 Cookie。新的 HTML 规范 (HTML5) 定义了“网络数据库”，这是一个完整（但是轻便）的浏览器内数据库。<br><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f83cb61cb9de4a65abeb95e50608af48~tplv-k3u1fbpfcp-watermark.awebp#crop=0&crop=0&crop=1&crop=1&id=XwxpW&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title="></li>
</ol>
<p>图：浏览器的主要组件。</p>
<p>值得注意的是，和大多数浏览器不同，Chrome 浏览器的每个标签页都分别对应一个呈现引擎实例。每个标签页都是一个独立的进程。</p>
<h3 id="浏览器是如何渲染-UI-的？"><a href="#浏览器是如何渲染-UI-的？" class="headerlink" title="浏览器是如何渲染 UI 的？"></a>浏览器是如何渲染 UI 的？</h3><ol>
<li>浏览器获取 HTML 文件，然后对文件进行解析，形成 DOM Tree</li>
<li>与此同时，进行 CSS 解析，生成 Style Rules</li>
<li>接着将 DOM Tree 与 Style Rules 合成为 Render Tree</li>
<li>接着进入布局（Layout）阶段，也就是为每个节点分配一个应出现在屏幕上的确切坐标</li>
<li>随后调用 GPU 进行绘制（Paint），遍历 Render Tree 的节点，并将元素呈现出来</li>
</ol>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67b1336692f540c9a81756f93e82c2f5~tplv-k3u1fbpfcp-watermark.image#crop=0&crop=0&crop=1&crop=1&id=fL7g4&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h3 id="DOM-Tree-是如何构建的？"><a href="#DOM-Tree-是如何构建的？" class="headerlink" title="DOM Tree 是如何构建的？"></a>DOM Tree 是如何构建的？</h3><ol>
<li>转码: 浏览器将接收到的二进制数据按照指定编码格式转化为 HTML 字符串</li>
<li>生成 Tokens: 之后开始 parser，浏览器会将 HTML 字符串解析成 Tokens</li>
<li>构建 Nodes: 对 Node 添加特定的属性，通过指针确定 Node 的父、子、兄弟关系和所属 treeScope</li>
<li>生成 DOM Tree: 通过 node 包含的指针确定的关系构建出 DOM<br>Tree</li>
</ol>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1dc0f577836c4705bb582b2ac15bc5d1~tplv-k3u1fbpfcp-zoom-1.image#crop=0&crop=0&crop=1&crop=1&id=wCvBc&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<h3 id="浏览器重绘与重排的区别？"><a href="#浏览器重绘与重排的区别？" class="headerlink" title="浏览器重绘与重排的区别？"></a>浏览器重绘与重排的区别？</h3><ul>
<li><code>重排/回流（Reflow）</code>：当<code>DOM</code>的变化影响了元素的几何信息，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫做重排。表现为重新生成布局，重新排列元素。</li>
<li><code>重绘(Repaint)</code>: 当一个元素的外观发生改变，但没有改变布局,重新把元素外观绘制出来的过程，叫做重绘。表现为某些元素的外观被改变</li>
</ul>
<p>单单改变元素的外观，肯定不会引起网页重新生成布局，但当浏览器完成重排之后，将会重新绘制受到此次重排影响的部分</p>
<p>重排和重绘代价是高昂的，它们会破坏用户体验，并且让 UI 展示非常迟缓，而相比之下重排的性能影响更大，在两者无法避免的情况下，一般我们宁可选择代价更小的重绘。</p>
<p>『重绘』不一定会出现『重排』，『重排』必然会出现『重绘』。</p>
<h3 id="如何触发重排和重绘？"><a href="#如何触发重排和重绘？" class="headerlink" title="如何触发重排和重绘？"></a>如何触发重排和重绘？</h3><p>任何改变用来构建渲染树的信息都会导致一次重排或重绘：</p>
<ul>
<li>添加、删除、更新 DOM 节点</li>
<li>通过 display: none 隐藏一个 DOM 节点-触发重排和重绘</li>
<li>通过 visibility: hidden 隐藏一个 DOM 节点-只触发重绘，因为没有几何变化</li>
<li>移动或者给页面中的 DOM 节点添加动画</li>
<li>添加一个样式表，调整样式属性</li>
<li>用户行为，例如调整窗口大小，改变字号，或者滚动。</li>
</ul>
<h3 id="如何避免重绘或者重排？"><a href="#如何避免重绘或者重排？" class="headerlink" title="如何避免重绘或者重排？"></a>如何避免重绘或者重排？</h3><ol>
<li><code>集中改变样式</code>，不要一条一条地修改 DOM 的样式。</li>
<li>不要把 DOM 结点的属性值放在循环里当成循环里的变量。</li>
<li>为动画的 HTML 元件使用 <code>fixed</code> 或 <code>absoult</code> 的 <code>position</code>，那么修改他们的 CSS 是不会 reflow 的。</li>
<li>不使用 table 布局。因为可能很小的一个小改动会造成整个 table 的重新布局。</li>
<li>尽量只修改<code>position：absolute</code>或<code>fixed</code>元素，对其他元素影响不大</li>
<li>动画开始<code>GPU</code>加速，<code>translate</code>使用<code>3D</code>变化</li>
<li>提升为合成层<br>将元素提升为合成层有以下优点：</li>
</ol>
<ul>
<li>合成层的位图，会交由 GPU 合成，比 CPU 处理要快</li>
<li>当需要 repaint 时，只需要 repaint 本身，不会影响到其他的层</li>
<li>对于 transform 和 opacity 效果，不会触发 layout 和 paint</li>
</ul>
<p>提升合成层的最好方式是使用 CSS 的 will-change 属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#target &#123;</span><br><span class="line">  will-change: transform;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于合成层的详解请移步<a href="https://link.juejin.cn/?target=http://taobaofed.org/blog/2016/04/25/performance-composite/">无线性能优化：Composite</a></p>
</blockquote>
<h3 id="介绍下-304-过程"><a href="#介绍下-304-过程" class="headerlink" title="介绍下 304 过程"></a>介绍下 304 过程</h3><ul>
<li>a. 浏览器请求资源时首先命中资源的 Expires 和 Cache-Control，Expires 受限于本地时间，如果修改了本地时间，可能会造成缓存失效，可以通过 Cache-control: max-age 指定最大生命周期，状态仍然返回 200，但不会请求数据，在浏览器中能明显看到 from cache 字样。</li>
<li>b. 强缓存失效，进入协商缓存阶段，首先验证 ETagETag 可以保证每一个资源是唯一的，资源变化都会导致 ETag 变化。服务器根据客户端上送的 If-None-Match 值来判断是否命中缓存。</li>
<li>c. 协商缓存 Last-Modify&#x2F;If-Modify-Since 阶段，客户端第一次请求资源时，服务服返回的 header 中会加上 Last-Modify，Last-modify 是一个时间标识该资源的最后修改时间。再次请求该资源时，request 的请求头中会包含 If-Modify-Since，该值为缓存之前返回的 Last-Modify。服务器收到 If-Modify-Since 后，根据资源的最后修改时间判断是否命中缓存。</li>
</ul>
<h3 id="浏览器的缓存机制-强制缓存-amp-amp-协商缓存"><a href="#浏览器的缓存机制-强制缓存-amp-amp-协商缓存" class="headerlink" title="浏览器的缓存机制 强制缓存 &amp;&amp; 协商缓存"></a>浏览器的缓存机制 强制缓存 &amp;&amp; 协商缓存</h3><p>浏览器与服务器通信的方式为应答模式，即是：浏览器发起 HTTP 请求 – 服务器响应该请求。那么浏览器第一次向服务器发起该请求后拿到请求结果，会根据响应报文中 HTTP 头的缓存标识，决定是否缓存结果，是则将请求结果和缓存标识存入浏览器缓存中，简单的过程如下图：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/487144abaada4b9a8b34bc9375191ec7~tplv-k3u1fbpfcp-zoom-1.image#crop=0&crop=0&crop=1&crop=1&id=VOzik&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&title="></p>
<p>由上图我们可以知道：</p>
<ul>
<li>浏览器每次发起请求，都会<code>先在浏览器缓存中查找该请求的结果以及缓存标识</code></li>
<li>浏览器每次拿到返回的请求结果都会<code>将该结果和缓存标识存入浏览器缓存中</code></li>
</ul>
<p>以上两点结论就是浏览器缓存机制的关键，他确保了每个请求的缓存存入与读取，只要我们再理解浏览器缓存的使用规则，那么所有的问题就迎刃而解了。为了方便理解，这里根据是否需要向服务器重新发起 HTTP 请求将缓存过程分为两个部分，分别是<code>强制缓存</code>和<code>协商缓存</code>。</p>
<ul>
<li><strong>强制缓存</strong><br><code>强制缓存就是向浏览器缓存查找该请求结果，并根据该结果的缓存规则来决定是否使用该缓存结果的过程。</code>当浏览器向服务器发起请求时，服务器会将缓存规则放入 HTTP 响应报文的 HTTP 头中和请求结果一起返回给浏览器，控制强制缓存的字段分别是 <code>Expires</code> 和 <code>Cache-Control</code>，其中 Cache-Control 优先级比 Expires 高。<br>强制缓存的情况主要有三种(暂不分析协商缓存过程)，如下：<ol>
<li>不存在该缓存结果和缓存标识，强制缓存失效，则直接向服务器发起请求（跟第一次发起请求一致）。</li>
<li>存在该缓存结果和缓存标识，但该结果已失效，强制缓存失效，则使用协商缓存。</li>
<li>存在该缓存结果和缓存标识，且该结果尚未失效，强制缓存生效，直接返回该结果</li>
</ol>
</li>
<li><strong>协商缓存</strong><br><code>协商缓存就是强制缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程</code>，同样，协商缓存的标识也是在响应报文的 HTTP 头中和请求结果一起返回给浏览器的，控制协商缓存的字段分别有：<code>Last-Modified / If-Modified-Since</code> 和 <code>Etag / If-None-Match</code>，其中 Etag &#x2F; If-None-Match 的优先级比 Last-Modified &#x2F; If-Modified-Since 高。协商缓存主要有以下两种情况：<ol>
<li>协商缓存生效，返回 304</li>
<li>协商缓存失效，返回 200 和请求结果结果</li>
</ol>
</li>
</ul>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/6992843117963509791"># 彻底理解浏览器的缓存机制</a></p>
<h3 id="Cookie、sessionStorage、localStorage-的区别"><a href="#Cookie、sessionStorage、localStorage-的区别" class="headerlink" title="Cookie、sessionStorage、localStorage 的区别"></a>Cookie、sessionStorage、localStorage 的区别</h3><p><strong>相同点</strong>：</p>
<ul>
<li>存储在客户端</li>
</ul>
<p><strong>不同点</strong>：</p>
<ul>
<li>cookie 数据大小不能超过 4k；sessionStorage 和 localStorage 的存储比 cookie 大得多，可以达到 5M+</li>
<li>cookie 设置的过期时间之前一直有效；localStorage 永久存储，浏览器关闭后数据不丢失除非主动删除数据；sessionStorage 数据在当前浏览器窗口关闭后自动删除</li>
<li>cookie 的数据会自动的传递到服务器；sessionStorage 和 localStorage 数据保存在本地</li>
</ul>
<h3 id="说下进程、线程和协程"><a href="#说下进程、线程和协程" class="headerlink" title="说下进程、线程和协程"></a>说下进程、线程和协程</h3><p><strong>进程</strong>是一个具有一定独立功能的程序在一个数据集上的一次动态执行的过程，<code>是操作系统进行资源分配和调度的一个独立单位</code>，是应用程序运行的载体。进程是一种抽象的概念，从来没有统一的标准定义。</p>
<p><strong>线程</strong>是程序执行中一个单一的顺序控制流程，是<code>程序执行流的最小单元</code>，是处理器调度和分派的基本单位。一个进程可以有一个或多个线程，各个线程之间共享程序的内存空间(也就是所在进程的内存空间)。一个标准的线程由线程 ID、当前指令指针(PC)、寄存器和堆栈组成。而进程由内存空间(代码、数据、进程空间、打开的文件)和一个或多个线程组成。</p>
<p><strong>协程</strong>，英文 Coroutines，是一种<code>基于线程之上，但又比线程更加轻量级的存在</code>，这种由程序员自己写程序来管理的轻量级线程叫做『用户空间线程』，具有对内核来说不可见的特性。</p>
<p><strong>进程和线程的区别与联系</strong></p>
<p>【区别】：</p>
<p>调度：线程作为调度和分配的基本单位，进程作为拥有资源的基本单位；</p>
<p>并发性：不仅进程之间可以并发执行，同一个进程的多个线程之间也可并发执行；</p>
<p>拥有资源：进程是拥有资源的一个独立单位，线程不拥有系统资源，但可以访问隶属于进程的资源。</p>
<p>系统开销：在创建或撤消进程时，由于系统都要为之分配和回收资源，导致系统的开销明显大于创建或撤消线程时的开销。但是进程有独立的地址空间，一个进程崩溃后，在保护模式下不会对其它进程产生影响，而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程之间没有单独的地址空间，一个进程死掉就等于所有的线程死掉，所以多进程的程序要比多线程的程序健壮，但在进程切换时，耗费资源较大，效率要差一些。</p>
<p>【联系】：</p>
<p>一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程；</p>
<p>资源分配给进程，同一进程的所有线程共享该进程的所有资源；</p>
<p>处理机分给线程，即真正在处理机上运行的是线程；</p>
<p>线程在执行过程中，需要协作同步。不同进程的线程间要利用消息通信的办法实现同步。</p>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/7005465381791875109"># 一文搞懂进程、线程、协程及 JS 协程的发展</a><br><a target="_blank" rel="noopener" href="http://www.360doc.com/content/20/0417/14/32196507_906628857.shtml">☞ 了解更多</a></p>
<p>关于浏览器传送门 ☞<a target="_blank" rel="noopener" href="https://juejin.cn/post/6993095345576083486"># 深入了解现代 Web 浏览器</a></p>
<h3 id="进程间的通信方式"><a href="#进程间的通信方式" class="headerlink" title="进程间的通信方式"></a>进程间的通信方式</h3><p><code>进程通信</code>：<br>每个进程各自有不同的用户地址空间,任何一个进程的全局变量在另一个进程中都看不到，所以进程之间要交换数据必须通过内核,在内核中开辟一块缓冲区,进程 A 把数据从用户空间拷到内核缓冲区,进程 B 再从内核缓冲区把数据读走,内核提供的这种机制称为进程间通信。</p>
<p>进程间的通信方式：管道、有名管道、信号、消息队列、共享内存、信号量、socket</p>
<p><code>匿名管道( pipe )</code>： 管道是一种半双工的通信方式，数据只能<strong>单向流动</strong>，而且只能在具有亲缘关系的进程间使用。进程的亲缘关系通常是指<strong>父子进程关系</strong>。</p>
<p><code>高级管道(popen)</code>：将另一个程序当做一个新的进程在当前程序进程中启动，则它算是当前程序的子进程，这种方式我们成为高级管道方式。</p>
<p><code>有名管道 (named pipe)</code>： 有名管道也是半双工的通信方式，但是它允许无亲缘关系进程间的通信。</p>
<p><code>消息队列( message queue )</code> ： 消息队列是由消息的链表，存放在内核中并由消息队列标识符标识。消息队列克服了信号传递信息少、管道只能承载无格式字节流以及缓冲区大小受限等缺点。</p>
<p><code>信号量( semophore )</code> ： 信号量是一个计数器，可以用来控制多个进程对共享资源的访问。它常作为一种锁机制，防止某进程正在访问共享资源时，其他进程也访问该资源。因此，主要作为进程间以及同一进程内不同线程之间的同步手段。</p>
<p><code>信号 ( sinal )</code> ： 信号是一种比较复杂的通信方式，用于通知接收进程某个事件已经发生。</p>
<p><code>共享内存( shared memory )</code> ：共享内存就是映射一段能被其他进程所访问的内存，这段共享内存由一个进程创建，但多个进程都可以访问。共享内存是最快的 IPC 方式，它是针对其他进程间通信方式运行效率低而专门设计的。它往往与其他通信机制，如信号两，配合使用，来实现进程间的同步和通信。</p>
<p><code>套接字( socket ) 通信</code>： 套接口也是一种进程间通信机制，与其他通信机制不同的是，它可用于不同机器间的进程通信</p>
<h3 id="浏览器样式兼容"><a href="#浏览器样式兼容" class="headerlink" title="浏览器样式兼容"></a>浏览器样式兼容</h3><h4 id="一、CSS-初始化"><a href="#一、CSS-初始化" class="headerlink" title="一、CSS 初始化"></a>一、CSS 初始化</h4><p>每个浏览器的 css 默认样式不尽相同，所以最简单有效的方式就是对其进行初始化（覆盖默认样式）</p>
<blockquote>
<p>常见 :  *{ margin: 0; padding: 0;}</p>
<p>库：normalize.css</p>
</blockquote>
<h4 id="二、浏览器私有属性"><a href="#二、浏览器私有属性" class="headerlink" title="二、浏览器私有属性"></a>二、<strong>浏览器私有属性</strong></h4><blockquote>
<p>常用的前缀有：</p>
<p>firefox 浏览器 ：-moz-</p>
<p>chrome、safari ：-webkit-</p>
<p>opera ：-o- &#x2F; -xv-</p>
<p>IE 浏览器 ：-ms-（目前只有 IE 8+支持）</p>
</blockquote>
<h4 id="三、CSS-hack（条件-hack、属性级-hack、选择符级-hack）"><a href="#三、CSS-hack（条件-hack、属性级-hack、选择符级-hack）" class="headerlink" title="三、CSS hack（条件 hack、属性级 hack、选择符级 hack）"></a><strong>三、CSS hack（条件 hack、属性级 hack、选择符级 hack）</strong></h4><h3 id="JS-垃圾回收机制"><a href="#JS-垃圾回收机制" class="headerlink" title="JS 垃圾回收机制"></a>JS 垃圾回收机制</h3><ol>
<li>项目中，如果存在大量不被释放的内存（堆&#x2F;栈&#x2F;上下文），页面性能会变得很慢。当某些代码操作不能被合理释放，就会造成内存泄漏。我们尽可能减少使用闭包，因为它会消耗内存。</li>
<li>浏览器垃圾回收机制&#x2F;内存回收机制:<blockquote>
<p>浏览器的<code>Javascript</code>具有自动垃圾回收机制(<code>GC:Garbage Collecation</code>)，垃圾收集器会定期（周期性）找出那些不在继续使用的变量，然后释放其内存。</p>
</blockquote>
</li>
</ol>
<p><strong>标记清除</strong>:在<code>js</code>中，最常用的垃圾回收机制是标记清除：当变量进入执行环境时，被标记为“进入环境”，当变量离开执行环境时，会被标记为“离开环境”。垃圾回收器会销毁那些带标记的值并回收它们所占用的内存空间。<br><strong>谷歌浏览器</strong>：“查找引用”，浏览器不定时去查找当前内存的引用，如果没有被占用了，浏览器会回收它；如果被占用，就不能回收。<br><strong>IE 浏览器</strong>：“引用计数法”，当前内存被占用一次，计数累加 1 次，移除占用就减 1，减到 0 时，浏览器就回收它。</p>
<ol start="3">
<li>优化手段：内存优化 ; 手动释放：取消内存的占用即可。<br>（1）堆内存：fn &#x3D; null 【null：空指针对象】<br>（2）栈内存：把上下文中，被外部占用的堆的占用取消即可。</li>
<li>内存泄漏<br>在 JS 中，常见的内存泄露主要有 4 种,全局变量、闭包、DOM 元素的引用、定时器</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/02/%E5%85%AB%E8%82%A1%E6%96%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/12/02/%E5%85%AB%E8%82%A1%E6%96%87/" class="post-title-link" itemprop="url">八股文</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-12-02 08:13:52" itemprop="dateCreated datePublished" datetime="2022-12-02T08:13:52+08:00">2022-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:18" itemprop="dateModified" datetime="2022-12-08T17:09:18+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="1-HTTP-和-HTTPS"><a href="#1-HTTP-和-HTTPS" class="headerlink" title="1. HTTP 和 HTTPS"></a>1. HTTP 和 HTTPS</h3><h4 id="1-http-和-https-的基本概念"><a href="#1-http-和-https-的基本概念" class="headerlink" title="1.http 和 https 的基本概念"></a>1.http 和 https 的基本概念</h4><p>http: 是一个客户端和服务器端请求和应答的标准（TCP），用于从 WWW 服务器传输超文本到本地浏览器的超文本传输协议。<br>https:是以安全为目标的 HTTP 通道，即 HTTP 下 加入 SSL 层进行加密。其作用是：建立一个信息安全通道，来确保数据的传输，确保网站的真实性。</p>
<h4 id="2-http-和-https-的区别及优缺点？"><a href="#2-http-和-https-的区别及优缺点？" class="headerlink" title="2.http 和 https 的区别及优缺点？"></a>2.http 和 https 的区别及优缺点？</h4><ul>
<li>http 是超文本传输协议，信息是明文传输，HTTPS 协议要比 http 协议安全，https 是具有安全性的 ssl 加密传输协议，可防止数据在传输过程中被窃取、改变，确保数据的完整性(当然这种安全性并非绝对的，对于更深入的 Web 安全问题，此处暂且不表)。</li>
<li>http 协议的默认端口为 80，https 的默认端口为 443。</li>
<li>http 的连接很简单，是无状态的。https 握手阶段比较费时，会使页面加载时间延长 50%，增加 10%~20%的耗电。</li>
<li>https 缓存不如 http 高效，会增加数据开销。</li>
<li>Https 协议需要 ca 证书，费用较高，功能越强大的证书费用越高。</li>
<li>SSL 证书需要绑定 IP，不能再同一个 IP 上绑定多个域名，IPV4 资源支持不了这种消耗。</li>
</ul>
<h4 id="3-https-协议的工作原理"><a href="#3-https-协议的工作原理" class="headerlink" title="3.https 协议的工作原理"></a>3.https 协议的工作原理</h4><p>客户端在使用 HTTPS 方式与 Web 服务器通信时有以下几个步骤：</p>
<ol>
<li>客户端使用 https url 访问服务器，则要求 web 服务器建立 ssl 链接。</li>
<li>web 服务器接收到客户端的请求之后，会将网站的证书（证书中包含了公钥），传输给客户端。</li>
<li>客户端和 web 服务器端开始协商 SSL 链接的安全等级，也就是加密等级。</li>
<li>客户端浏览器通过双方协商一致的安全等级，建立会话密钥，然后通过网站的公钥来加密会话密钥，并传送给网站。</li>
<li>web 服务器通过自己的私钥解密出会话密钥。</li>
<li>web 服务器通过会话密钥加密与客户端之间的通信。</li>
</ol>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/6995109407545622542"># 解读 HTTP1&#x2F;HTTP2&#x2F;HTTP3</a></p>
<h3 id="TCP-三次握手"><a href="#TCP-三次握手" class="headerlink" title="TCP 三次握手"></a>TCP 三次握手</h3><ol>
<li>第一次握手：建立连接时，客户端发送 syn 包（syn&#x3D;j）到服务器，并进入 SYN_SENT 状态，等待服务器确认；SYN：同步序列编号（Synchronize Sequence Numbers）。</li>
<li>第二次握手：服务器收到 syn 包并确认客户的 SYN（ack&#x3D;j+1），同时也发送一个自己的 SYN 包（syn&#x3D;k），即 SYN+ACK 包，此时服务器进入 SYN_RECV 状态；</li>
<li>第三次握手：客户端收到服务器的 SYN+ACK 包，向服务器发送确认包 ACK(ack&#x3D;k+1），此包发送完毕，客户端和服务器进入 ESTABLISHED（TCP 连接成功）状态，完成三次握手。</li>
</ol>
<p>握手过程中传送的包里不包含数据，三次握手完毕后，客户端与服务器才正式开始传送数据。</p>
<h3 id="TCP-四次挥手"><a href="#TCP-四次挥手" class="headerlink" title="TCP 四次挥手"></a>TCP 四次挥手</h3><ol>
<li>客户端进程发出连接释放报文，并且停止发送数据。释放数据报文首部，FIN&#x3D;1，其序列号为 seq&#x3D;u（等于前面已经传送过来的数据的最后一个字节的序号加 1），此时，客户端进入 FIN-WAIT-1（终止等待 1）状态。 TCP 规定，FIN 报文段即使不携带数据，也要消耗一个序号。</li>
</ol>
<p>2）服务器收到连接释放报文，发出确认报文，ACK&#x3D;1，ack&#x3D;u+1，并且带上自己的序列号 seq&#x3D;v，此时，服务端就进入了 CLOSE-WAIT（关闭等待）状态。TCP 服务器通知高层的应用进程，客户端向服务器的方向就释放了，这时候处于半关闭状态，即客户端已经没有数据要发送了，但是服务器若发送数据，客户端依然要接受。这个状态还要持续一段时间，也就是整个 CLOSE-WAIT 状态持续的时间。<br>3）客户端收到服务器的确认请求后，此时，客户端就进入 FIN-WAIT-2（终止等待 2）状态，等待服务器发送连接释放报文（在这之前还需要接受服务器发送的最 后的数据）。<br>4）服务器将最后的数据发送完毕后，就向客户端发送连接释放报文，FIN&#x3D;1，ack&#x3D;u+1，由于在半关闭状态，服务器很可能又发送了一些数据，假定此时的序列号为 seq&#x3D;w，此时，服务器就进入了 LAST-ACK（最后确认）状态，等待客户端的确认。<br>5）客户端收到服务器的连接释放报文后，必须发出确认，ACK&#x3D;1，ack&#x3D;w+1，而自己的序列号是 seq&#x3D;u+1，此时，客户端就进入了 TIME-WAIT（时间等待）状态。注意此时 TCP 连接还没有释放，必须经过 2∗∗MSL（最长报文段寿命）的时间后，当客户端撤销相应的 TCB 后，才进入 CLOSED 状态。<br>6）服务器只要收到了客户端发出的确认，立即进入 CLOSED 状态。同样，撤销 TCB 后，就结束了这次的 TCP 连接。可以看到，服务器结束 TCP 连接的时间要比客户端早一些。</p>
<h3 id="TCP-x2F-IP-x2F-如何保证数据包传输的有序可靠？"><a href="#TCP-x2F-IP-x2F-如何保证数据包传输的有序可靠？" class="headerlink" title="TCP&#x2F;IP &#x2F; 如何保证数据包传输的有序可靠？"></a>TCP&#x2F;IP &#x2F; 如何保证数据包传输的有序可靠？</h3><p>对字节流分段并进行编号然后通过 ACK 回复和超时重发这两个机制来保证。<br>（1）为了保证数据包的可靠传递，发送方必须把已发送的数据包保留在缓冲区；<br>（2）并为每个已发送的数据包启动一个超时定时器；<br>（3）如在定时器超时之前收到了对方发来的应答信息（可能是对本包的应答，也可以是对本包后续包的应答），则释放该数据包占用的缓冲区;<br>（4）否则，重传该数据包，直到收到应答或重传次数超过规定的最大次数为止。<br>（5）接收方收到数据包后，先进行 CRC 校验，如果正确则把数据交给上层协议，然后给发送方发送一个累计应答包，表明该数据已收到，如果接收方正好也有数据要发给发送方，应答包也可方在数据包中捎带过去。</p>
<h3 id="TCP-和-UDP-的区别"><a href="#TCP-和-UDP-的区别" class="headerlink" title="TCP 和 UDP 的区别"></a>TCP 和 UDP 的区别</h3><ol>
<li>TCP 是面向链接的，而 UDP 是面向无连接的。</li>
<li>TCP 仅支持单播传输，UDP 提供了单播，多播，广播的功能。</li>
<li>TCP 的三次握手保证了连接的可靠性; UDP 是无连接的、不可靠的一种数据传输协议，首先不可靠性体现在无连接上，通信都不需要建立连接，对接收到的数据也不发送确认信号，发送端不知道数据是否会正确接收。</li>
<li>UDP 的头部开销比 TCP 的更小，数据传输速率更高，实时性更好。</li>
</ol>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/6992743999756845087"># 深度剖析 TCP 与 UDP 的区别</a></p>
<h3 id="HTTP-请求跨域问题"><a href="#HTTP-请求跨域问题" class="headerlink" title="HTTP 请求跨域问题"></a>HTTP 请求跨域问题</h3><ol>
<li>跨域的原理</li>
</ol>
<p><strong>跨域</strong>，是指浏览器不能执行其他网站的脚本。它是由浏览器的同源策略造成的。<br><strong>同源策略</strong>,是浏览器对 JavaScript 实施的安全限制，只要协议、域名、端口有任何一个不同，都被当作是不同的域。<br><strong>跨域原理</strong>，即是通过各种方式，避开浏览器的安全限制。</p>
<ol start="2">
<li>解决方案最初做项目的时候，使用的是 jsonp，但存在一些问题，使用 get 请求不安全，携带数据较小，后来也用过 iframe，但只有主域相同才行，也是存在些问题，后来通过了解和学习发现使用代理和 proxy 代理配合起来使用比较方便，就引导后台按这种方式做下服务器配置，在开发中使用 proxy，在服务器上使用 nginx 代理，这样开发过程中彼此都方便，效率也高；现在 h5 新特性还有 windows.postMessage()<ul>
<li><strong>JSONP</strong>：<br>ajax 请求受同源策略影响，不允许进行跨域请求，而 script 标签 src 属性中的链 接却可以访问跨域的 js 脚本，利用这个特性，服务端不再返回 JSON 格式的数据，而是 返回一段调用某个函数的 js 代码，在 src 中进行了调用，这样实现了跨域。步骤： 1. 去创建一个 script 标签 2. script 的 src 属性设置接口地址 3. 接口参数，必须要带一个自定义函数名，要不然后台无法返回数据 4. 通过定义函数名去接受返回的数据</li>
</ul>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//动态创建 script</span></span><br><span class="line"><span class="keyword">var</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置回调函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getData</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置 script 的 src 属性，并设置请求地址</span></span><br><span class="line">script.<span class="property">src</span> = <span class="string">&quot;http://localhost:3000/?callback=getData&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让 script 生效</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(script);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>JSONP 的缺点</strong>:<br>JSON 只支持 get，因为 script 标签只能使用 get 请求； JSONP 需要后端配合返回指定格式的数据。</li>
<li><strong>document.domain</strong> 基础域名相同 子域名不同</li>
<li><strong>window.name</strong> 利用在一个浏览器窗口内，载入所有的域名都是共享一个 window.name</li>
<li><strong>CORS</strong> CORS(Cross-origin resource sharing)跨域资源共享 服务器设置对 CORS 的支持原理：服务器设置 Access-Control-Allow-Origin HTTP 响应头之后，浏览器将会允许跨域请求</li>
<li><strong>proxy 代理</strong> 目前常用方式,通过服务器设置代理</li>
<li><strong>window.postMessage()</strong> 利用 h5 新特性 window.postMessage()</li>
</ul>
<p>跨域传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/7003232769182547998"># 跨域，不可不知的基础概念</a></p>
<h3 id="Cookie、sessionStorage、localStorage-的区别"><a href="#Cookie、sessionStorage、localStorage-的区别" class="headerlink" title="Cookie、sessionStorage、localStorage 的区别"></a>Cookie、sessionStorage、localStorage 的区别</h3><p><strong>相同点</strong>：</p>
<ul>
<li>存储在客户端</li>
</ul>
<p><strong>不同点</strong>：</p>
<ul>
<li>cookie 数据大小不能超过 4k；sessionStorage 和 localStorage 的存储比 cookie 大得多，可以达到 5M+</li>
<li>cookie 设置的过期时间之前一直有效；localStorage 永久存储，浏览器关闭后数据不丢失除非主动删除数据；sessionStorage 数据在当前浏览器窗口关闭后自动删除</li>
<li>cookie 的数据会自动的传递到服务器；sessionStorage 和 localStorage 数据保存在本地</li>
</ul>
<h3 id="粘包问题分析与对策"><a href="#粘包问题分析与对策" class="headerlink" title="粘包问题分析与对策"></a>粘包问题分析与对策</h3><p>TCP 粘包是指发送方发送的若干包数据到接收方接收时粘成一包，从接收缓冲区看，后一包数据的头紧接着前一包数据的尾。<br><strong>粘包出现原因</strong><br>简单得说，在流传输中出现，UDP 不会出现粘包，因为它有<strong>消息边界</strong><br>粘包情况有两种，一种是粘在一起的包都是完整的数据包，另一种情况是粘在一起的包有不完整的包。<br>为了<strong>避免粘包</strong>现象，可采取以下几种措施：<br>（1）对于发送方引起的粘包现象，用户可通过编程设置来避免，TCP 提供了强制数据立即传送的操作指令 push，TCP 软件收到该操作指令后，就立即将本段数据发送出去，而不必等待发送缓冲区满；<br>（2）对于接收方引起的粘包，则可通过优化程序设计、精简接收进程工作量、提高接收进程优先级等措施，使其及时接收数据，从而尽量避免出现粘包现象；<br>（3）由接收方控制，将一包数据按结构字段，人为控制分多次接收，然后合并，通过这种手段来避免粘包。分包多发。<br>以上提到的三种措施，都有其不足之处。<br>（1）第一种编程设置方法虽然可以避免发送方引起的粘包，但它关闭了优化算法，降低了网络发送效率，影响应用程序的性能，一般不建议使用。<br>（2）第二种方法只能减少出现粘包的可能性，但并不能完全避免粘包，当发送频率较高时，或由于网络突发可能使某个时间段数据包到达接收方较快，接收方还是有可能来不及接收，从而导致粘包。<br>（3）第三种方法虽然避免了粘包，但应用程序的效率较低，对实时应用的场合不适合。</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">一种比较周全的对策是：接收方创建一预处理线程，对接收到的数据包进行预处理，将粘连的包分开。实验证明这种方法是高效可行的。</div>

<h2 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h2><h3 id="从输入-URL-到页面加载的全过程"><a href="#从输入-URL-到页面加载的全过程" class="headerlink" title="从输入 URL 到页面加载的全过程"></a>从输入 URL 到页面加载的全过程</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942744872-b9a1b6a4-8487-4367-a16f-a589b78e5264.webp#averageHue=%23f2f7f1&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u0882bd42&margin=%5Bobject%20Object%5D&originHeight=378&originWidth=814&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u246e15ad-265d-4153-aa24-b998ba63cdf&title="></p>
<ol>
<li>首先在浏览器中输入 URL</li>
<li>查找缓存：浏览器先查看浏览器缓存-系统缓存-路由缓存中是否有该地址页面，如果有则显示页面内容。如果没有则进行下一步。<ul>
<li>浏览器缓存：浏览器会记录 DNS 一段时间，因此，只是第一个地方解析 DNS 请求；</li>
<li>操作系统缓存:如果在浏览器缓存中不包含这个记录，则会使系统调用操作系统， 获取操作系统的记录(保存最近的 DNS 查询缓存)；</li>
<li>路由器缓存：如果上述两个步骤均不能成功获取 DNS 记录，继续搜索路由器缓存；</li>
<li>ISP 缓存：若上述均失败，继续向 ISP 搜索。</li>
</ul>
</li>
<li>DNS 域名解析：浏览器向 DNS 服务器发起请求，解析该 URL 中的域名对应的 IP 地址。DNS 服务器是基于 UDP 的，因此会用到 UDP 协议。</li>
<li>建立 TCP 连接：解析出 IP 地址后，根据 IP 地址和默认 80 端口，和服务器建立 TCP 连接</li>
<li>发起 HTTP 请求：浏览器发起读取文件的 HTTP 请求，，该请求报文作为 TCP 三次握手的第三次数据发送给服务器</li>
<li>服务器响应请求并返回结果：服务器对浏览器请求做出响应，并把对应的 html 文件发送给浏览器</li>
<li>关闭 TCP 连接：通过四次挥手释放 TCP 连接</li>
<li>浏览器渲染：客户端（浏览器）解析 HTML 内容并渲染出来，浏览器接收到数据包后的解析流程为：<img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942744887-29034cf8-9d81-4cc2-8058-a0f342f36fbb.webp#averageHue=%23dde3a9&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u59eed386&margin=%5Bobject%20Object%5D&originHeight=287&originWidth=619&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u13801c5b-d608-4bb2-9ba1-77a13379322&title="><ul>
<li>构建 DOM 树：词法分析然后解析成 DOM 树（dom tree），是由 dom 元素及属性节点组成，树的根是 document 对象</li>
<li>构建 CSS 规则树：生成 CSS 规则树（CSS Rule Tree）</li>
<li>构建 render 树：Web 浏览器将 DOM 和 CSSOM 结合，并构建出渲染树（render tree）</li>
<li>布局（Layout）：计算出每个节点在屏幕中的位置</li>
<li>绘制（Painting）：即遍历 render 树，并使用 UI 后端层绘制每个节点。</li>
</ul>
</li>
<li>JS 引擎解析过程：调用 JS 引擎执行 JS 代码（JS 的解释阶段，预处理阶段，执行阶段生成执行上下文，VO，作用域链、回收机制等等）<ul>
<li>创建 window 对象：window 对象也叫全局执行环境，当页面产生时就被创建，所有的全局变量和函数都属于 window 的属性和方法，而 DOM Tree 也会映射在 window 的 doucment 对象上。当关闭网页或者关闭浏览器时，全局执行环境会被销毁。</li>
<li>加载文件：完成 js 引擎分析它的语法与词法是否合法，如果合法进入预编译</li>
<li>预编译：在预编译的过程中，浏览器会寻找全局变量声明，把它作为 window 的属性加入到 window 对象中，并给变量赋值为’undefined’；寻找全局函数声明，把它作为 window 的方法加入到 window 对象中，并将函数体赋值给他（匿名函数是不参与预编译的，因为它是变量）。而变量提升作为不合理的地方在 ES6 中已经解决了，函数提升还存在。</li>
<li>解释执行：执行到变量就赋值，如果变量没有被定义，也就没有被预编译直接赋值，在 ES5 非严格模式下这个变量会成为 window 的一个属性，也就是成为全局变量。string、int 这样的值就是直接把值放在变量的存储空间里，object 对象就是把指针指向变量的存储空间。函数执行，就将函数的环境推入一个环境的栈中，执行完成后再弹出，控制权交还给之前的环境。JS 作用域其实就是这样的执行流机制实现的。</li>
</ul>
</li>
</ol>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/7005468491067162655"># DNS 域名解析过程</a> ☞<a target="_blank" rel="noopener" href="https://juejin.cn/post/6992597760935460901"># 浏览器的工作原理</a></p>
<h3 id="浏览器重绘与重排的区别？"><a href="#浏览器重绘与重排的区别？" class="headerlink" title="浏览器重绘与重排的区别？"></a>浏览器重绘与重排的区别？</h3><ul>
<li>重排&#x2F;回流（Reflow）：当 DOM 的变化影响了元素的几何信息，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫做重排。表现为重新生成布局，重新排列元素。</li>
<li>重绘(Repaint): 当一个元素的外观发生改变，但没有改变布局,重新把元素外观绘制出来的过程，叫做重绘。表现为某些元素的外观被改变</li>
</ul>
<p>单单改变元素的外观，肯定不会引起网页重新生成布局，但当浏览器完成重排之后，将会重新绘制受到此次重排影响的部分<br>重排和重绘代价是高昂的，它们会破坏用户体验，并且让 UI 展示非常迟缓，而相比之下重排的性能影响更大，在两者无法避免的情况下，一般我们宁可选择代价更小的重绘。<br>『重绘』不一定会出现『重排』，『重排』必然会出现『重绘』。</p>
<h3 id="如何触发重排和重绘？"><a href="#如何触发重排和重绘？" class="headerlink" title="如何触发重排和重绘？"></a>如何触发重排和重绘？</h3><p>任何改变用来构建渲染树的信息都会导致一次重排或重绘：</p>
<ul>
<li>添加、删除、更新 DOM 节点</li>
<li>通过 display: none 隐藏一个 DOM 节点-触发重排和重绘</li>
<li>通过 visibility: hidden 隐藏一个 DOM 节点-只触发重绘，因为没有几何变化</li>
<li>移动或者给页面中的 DOM 节点添加动画</li>
<li>添加一个样式表，调整样式属性</li>
<li>用户行为，例如调整窗口大小，改变字号，或者滚动。</li>
</ul>
<h3 id="如何避免重绘或者重排？"><a href="#如何避免重绘或者重排？" class="headerlink" title="如何避免重绘或者重排？"></a>如何避免重绘或者重排？</h3><ol>
<li>集中改变样式，不要一条一条地修改 DOM 的样式。</li>
<li>不要把 DOM 结点的属性值放在循环里当成循环里的变量。</li>
<li>为动画的 HTML 元件使用 fixed 或 absoult 的 position，那么修改他们的 CSS 是不会 reflow 的。</li>
<li>不使用 table 布局。因为可能很小的一个小改动会造成整个 table 的重新布局。</li>
<li>尽量只修改 position：absolute 或 fixed 元素，对其他元素影响不大</li>
<li>动画开始 GPU 加速，translate 使用 3D 变化</li>
<li>提升为合成层将元素提升为合成层有以下优点：提升合成层的最好方式是使用 CSS 的 will-change 属性：#target { will-change: transform; } 复制代码关于合成层的详解请移步<a href="https://link.juejin.cn/?target=http://taobaofed.org/blog/2016/04/25/performance-composite/">无线性能优化：Composite</a><ul>
<li>合成层的位图，会交由 GPU 合成，比 CPU 处理要快</li>
<li>当需要 repaint 时，只需要 repaint 本身，不会影响到其他的层</li>
<li>对于 transform 和 opacity 效果，不会触发 layout 和 paint</li>
</ul>
</li>
</ol>
<p>提升合成层的最好方式是使用 CSS 的 will-change 属性：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#target</span> &#123;</span><br><span class="line">  <span class="attribute">will-change</span>: transform;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="介绍下-304-过程"><a href="#介绍下-304-过程" class="headerlink" title="介绍下 304 过程"></a>介绍下 304 过程</h3><ul>
<li>a. 浏览器请求资源时首先命中资源的 Expires 和 Cache-Control，Expires 受限于本地时间，如果修改了本地时间，可能会造成缓存失效，可以通过 Cache-control: max-age 指定最大生命周期，状态仍然返回 200，但不会请求数据，在浏览器中能明显看到 from cache 字样。</li>
<li>b. 强缓存失效，进入协商缓存阶段，首先验证 ETag. ETag 可以保证每一个资源是唯一的，资源变化都会导致 ETag 变化。服务器根据客户端上送的 If-None-Match 值来判断是否命中缓存。</li>
<li>c. 协商缓存 Last-Modify&#x2F;If-Modify-Since 阶段，客户端第一次请求资源时，服务服返回的 header 中会加上 Last-Modify，Last-modify 是一个时间标识该资源的最后修改时间。再次请求该资源时，request 的请求头中会包含 If-Modify-Since，该值为缓存之前返回的 Last-Modify。服务器收到 If-Modify-Since 后，根据资源的最后修改时间判断是否命中缓存。</li>
</ul>
<h3 id="浏览器的缓存机制-强制缓存-amp-amp-协商缓存"><a href="#浏览器的缓存机制-强制缓存-amp-amp-协商缓存" class="headerlink" title="浏览器的缓存机制 强制缓存 &amp;&amp; 协商缓存"></a>浏览器的缓存机制 强制缓存 &amp;&amp; 协商缓存</h3><p>浏览器与服务器通信的方式为应答模式，即是：浏览器发起 HTTP 请求 – 服务器响应该请求。那么浏览器第一次向服务器发起该请求后拿到请求结果，会根据响应报文中 HTTP 头的缓存标识，决定是否缓存结果，是则将请求结果和缓存标识存入浏览器缓存中，简单的过程如下图：<br><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942744932-727d7cd5-a847-4ed3-a79e-e0f21b69b9ee.webp#averageHue=%23f2f2f2&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ucc3901e9&margin=%5Bobject%20Object%5D&originHeight=570&originWidth=761&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u27d87681-64b3-4656-a66e-a5c24175c73&title="><br>由上图我们可以知道：</p>
<ul>
<li>浏览器每次发起请求，都会先在浏览器缓存中查找该请求的结果以及缓存标识</li>
<li>浏览器每次拿到返回的请求结果都会将该结果和缓存标识存入浏览器缓存中</li>
</ul>
<p>以上两点结论就是浏览器缓存机制的关键，他确保了每个请求的缓存存入与读取，只要我们再理解浏览器缓存的使用规则，那么所有的问题就迎刃而解了。为了方便理解，这里根据是否需要向服务器重新发起 HTTP 请求将缓存过程分为两个部分，分别是强制缓存和协商缓存。</p>
<ul>
<li><strong>强制缓存</strong></li>
</ul>
<p>强制缓存就是向浏览器缓存查找该请求结果，并根据该结果的缓存规则来决定是否使用该缓存结果的过程。当浏览器向服务器发起请求时，服务器会将缓存规则放入 HTTP 响应报文的 HTTP 头中和请求结果一起返回给浏览器，控制强制缓存的字段分别是 Expires 和 Cache-Control，其中 Cache-Control 优先级比 Expires 高。</p>
<p>强制缓存的情况主要有三种(暂不分析协商缓存过程)，如下：</p>
<ol>
<li>不存在该缓存结果和缓存标识，强制缓存失效，则直接向服务器发起请求（跟第一次发起请求一致）。</li>
<li>存在该缓存结果和缓存标识，但该结果已失效，强制缓存失效，则使用协商缓存。</li>
<li>存在该缓存结果和缓存标识，且该结果尚未失效，强制缓存生效，直接返回该结果</li>
</ol>
<ul>
<li><strong>协商缓存</strong></li>
</ul>
<p>协商缓存就是强制缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程，同样，协商缓存的标识也是在响应报文的 HTTP 头中和请求结果一起返回给浏览器的，控制协商缓存的字段分别有：Last-Modified &#x2F; If-Modified-Since 和 Etag &#x2F; If-None-Match，其中 Etag &#x2F; If-None-Match 的优先级比 Last-Modified &#x2F; If-Modified-Since 高。协商缓存主要有以下两种情况：</p>
<ol>
<li>协商缓存生效，返回 304</li>
<li>协商缓存失效，返回 200 和请求结果结果</li>
</ol>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/6992843117963509791"># 彻底理解浏览器的缓存机制</a></p>
<h3 id="说下进程、线程和协程"><a href="#说下进程、线程和协程" class="headerlink" title="说下进程、线程和协程"></a>说下进程、线程和协程</h3><p><strong>进程</strong>是一个具有一定独立功能的程序在一个数据集上的一次动态执行的过程，是操作系统进行资源分配和调度的一个独立单位，是应用程序运行的载体。进程是一种抽象的概念，从来没有统一的标准定义。<br><strong>线程</strong>是程序执行中一个单一的顺序控制流程，是程序执行流的最小单元，是处理器调度和分派的基本单位。一个进程可以有一个或多个线程，各个线程之间共享程序的内存空间(也就是所在进程的内存空间)。一个标准的线程由线程 ID、当前指令指针(PC)、寄存器和堆栈组成。而进程由内存空间(代码、数据、进程空间、打开的文件)和一个或多个线程组成。<br><strong>协程</strong>，英文 Coroutines，是一种基于线程之上，但又比线程更加轻量级的存在，这种由程序员自己写程序来管理的轻量级线程叫做『用户空间线程』，具有对内核来说不可见的特性。<br><strong>进程和线程的区别与联系</strong><br>【区别】：<br>调度：线程作为调度和分配的基本单位，进程作为拥有资源的基本单位；<br>并发性：不仅进程之间可以并发执行，同一个进程的多个线程之间也可并发执行；<br>拥有资源：进程是拥有资源的一个独立单位，线程不拥有系统资源，但可以访问隶属于进程的资源。<br>系统开销：在创建或撤消进程时，由于系统都要为之分配和回收资源，导致系统的开销明显大于创建或撤消线程时的开销。但是进程有独立的地址空间，一个进程崩溃后，在保护模式下不会对其它进程产生影响，而线程只是一个进程中的不同执行路径。线程有自己的堆栈和局部变量，但线程之间没有单独的地址空间，一个进程死掉就等于所有的线程死掉，所以多进程的程序要比多线程的程序健壮，但在进程切换时，耗费资源较大，效率要差一些。<br>【联系】： 一个线程只能属于一个进程，而一个进程可以有多个线程，但至少有一个线程；<br>资源分配给进程，同一进程的所有线程共享该进程的所有资源；<br>处理机分给线程，即真正在处理机上运行的是线程；<br>线程在执行过程中，需要协作同步。不同进程的线程间要利用消息通信的办法实现同步。<br>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/7005465381791875109"># 一文搞懂进程、线程、协程及 JS 协程的发展</a><a href="https://link.juejin.cn/?target=http://www.360doc.com/content/20/0417/14/32196507_906628857.shtml">☞ 了解更多</a><br>关于浏览器传送门 ☞<a target="_blank" rel="noopener" href="https://juejin.cn/post/6993095345576083486"># 深入了解现代 Web 浏览器</a></p>
<h2 id="HTML-amp-amp-CSS"><a href="#HTML-amp-amp-CSS" class="headerlink" title="HTML &amp;&amp; CSS"></a>HTML &amp;&amp; CSS</h2><h3 id="HTML5-新特性、语义化"><a href="#HTML5-新特性、语义化" class="headerlink" title="HTML5 新特性、语义化"></a>HTML5 新特性、语义化</h3><ol>
<li><strong>概念</strong>：HTML5 的语义化指的是合理正确的使用语义化的标签来创建页面结构。【正确的标签做正确的事】</li>
<li><strong>语义化标签</strong>：header nav main article section aside footer</li>
<li><strong>语义化的优点</strong>:<ul>
<li>在没 CSS 样式的情况下，页面整体也会呈现很好的结构效果</li>
<li>代码结构清晰，易于阅读，</li>
<li>利于开发和维护 方便其他设备解析（如屏幕阅读器）根据语义渲染网页。</li>
<li>有利于搜索引擎优化（SEO），搜索引擎爬虫会根据不同的标签来赋予不同的权重</li>
</ul>
</li>
</ol>
<h3 id="CSS-选择器及优先级"><a href="#CSS-选择器及优先级" class="headerlink" title="CSS 选择器及优先级"></a>CSS 选择器及优先级</h3><p><strong>选择器</strong></p>
<ul>
<li>id 选择器(#myid)</li>
<li>类选择器(.myclass)</li>
<li>属性选择器(a[rel&#x3D;”external”])</li>
<li>伪类选择器(a:hover, li:nth-child)</li>
<li>标签选择器(div, h1,p)</li>
<li>相邻选择器（h1 + p）</li>
<li>子选择器(ul &gt; li)</li>
<li>后代选择器(li a)</li>
<li>通配符选择器(*)</li>
</ul>
<p><strong>优先级：</strong></p>
<ul>
<li>!important</li>
<li>内联样式（1000）</li>
<li>ID 选择器（0100）</li>
<li>类选择器&#x2F;属性选择器&#x2F;伪类选择器（0010）</li>
<li>元素选择器&#x2F;伪元素选择器（0001）</li>
<li>关系选择器&#x2F;通配符选择器（0000）</li>
</ul>
<p>带!important 标记的样式属性优先级最高； 样式表的来源相同时：!important &gt; 行内样式&gt;ID 选择器 &gt; 类选择器 &gt; 标签 &gt; 通配符 &gt; 继承 &gt; 浏览器默认属性</p>
<h3 id="position-属性的值有哪些及其区别"><a href="#position-属性的值有哪些及其区别" class="headerlink" title="position 属性的值有哪些及其区别"></a>position 属性的值有哪些及其区别</h3><p><strong>固定定位 fixed</strong>： 元素的位置相对于浏览器窗口是固定位置，即使窗口是滚动的它也不会移动。Fixed 定 位使元素的位置与文档流无关，因此不占据空间。 Fixed 定位的元素和其他元素重叠。<br><strong>相对定位 relative</strong>： 如果对一个元素进行相对定位，它将出现在它所在的位置上。然后，可以通过设置垂直 或水平位置，让这个元素“相对于”它的起点进行移动。 在使用相对定位时，无论是 否进行移动，元素仍然占据原来的空间。因此，移动元素会导致它覆盖其它框。<br><strong>绝对定位 absolute</strong>： 绝对定位的元素的位置相对于最近的已定位父元素，如果元素没有已定位的父元素，那 么它的位置相对于。absolute 定位使元素的位置与文档流无关，因此不占据空间。 absolute 定位的元素和其他元素重叠。<br><strong>粘性定位 sticky</strong>： 元素先按照普通文档流定位，然后相对于该元素在流中的 flow root（BFC）和 containing block（最近的块级祖先元素）定位。而后，元素定位表现为在跨越特定阈值前为相对定 位，之后为固定定位。<br><strong>默认定位 Static</strong>： 默认值。没有定位，元素出现在正常的流中（忽略 top, bottom, left, right 或者 z-index 声 明）。 inherit: 规定应该从父元素继承 position 属性的值。</p>
<h3 id="box-sizing-属性"><a href="#box-sizing-属性" class="headerlink" title="box-sizing 属性"></a>box-sizing 属性</h3><p>box-sizing 规定两个并排的带边框的框，语法为 box-sizing：content-box&#x2F;border-box&#x2F;inherit<br><strong>content-box</strong>：宽度和高度分别应用到元素的内容框，在宽度和高度之外绘制元素的内边距和边框。【标准盒子模型】<br><strong>border-box</strong>：为元素设定的宽度和高度决定了元素的边框盒。【IE 盒子模型】<br><strong>inherit</strong>：继承父元素的 box-sizing 值。</p>
<h3 id="CSS-盒子模型"><a href="#CSS-盒子模型" class="headerlink" title="CSS 盒子模型"></a>CSS 盒子模型</h3><p>CSS 盒模型本质上是一个盒子，它包括：边距，边框，填充和实际内容。CSS 中的盒子模型包括 IE 盒子模型和标准的 W3C 盒子模型。<br>在标准的盒子模型中，width 指 content 部分的宽度。<br>在 IE 盒子模型中，width 表示 content+padding+border 这三个部分的宽度。<br>故在计算盒子的宽度时存在差异：<br><strong>标准盒模型：</strong> 一个块的总宽度 &#x3D; width+margin(左右)+padding(左右)+border(左右)<br><strong>怪异盒模型：</strong> 一个块的总宽度 &#x3D; width+margin（左右）（既 width 已经包含了 padding 和 border 值）</p>
<h3 id="BFC（块级格式上下文）"><a href="#BFC（块级格式上下文）" class="headerlink" title="BFC（块级格式上下文）"></a>BFC（块级格式上下文）</h3><p><strong>BFC 的概念</strong><br>BFC 是 Block Formatting Context 的缩写，即块级格式化上下文。BFC 是 CSS 布局的一个概念，是一个独立的渲染区域，规定了内部 box 如何布局， 并且这个区域的子元素不会影响到外面的元素，其中比较重要的布局规则有内部 box 垂直放置，计算 BFC 的高度的时候，浮动元素也参与计算。<br><strong>BFC 的原理布局规则</strong></p>
<ul>
<li>内部的 Box 会在垂直方向，一个接一个地放置</li>
<li>Box 垂直方向的距离由 margin 决定。属于同一个 BFC 的两个相邻 Box 的 margin 会发生重叠</li>
<li>每个元素的 margin box 的左边， 与包含块 border box 的左边相接触(对于从左往右的格式化，否则相反</li>
<li>BFC 的区域不会与 float box 重叠</li>
<li>BFC 是一个独立容器，容器里面的子元素不会影响到外面的元素</li>
<li>计算 BFC 的高度时，浮动元素也参与计算高度</li>
<li>元素的类型和 display 属性，决定了这个 Box 的类型。不同类型的 Box 会参与不同的 Formatting Context。</li>
</ul>
<p><strong>如何创建 BFC？</strong></p>
<ul>
<li>根元素，即 HTML 元素</li>
<li>float 的值不为 none</li>
<li>position 为 absolute 或 fixed</li>
<li>display 的值为 inline-block、table-cell、table-caption</li>
<li>overflow 的值不为 visible</li>
</ul>
<p><strong>BFC 的使用场景</strong></p>
<ul>
<li>去除边距重叠现象</li>
<li>清除浮动（让父元素的高度包含子浮动元素）</li>
<li>避免某元素被浮动元素覆盖</li>
<li>避免多列布局由于宽度计算四舍五入而自动换行</li>
</ul>
<h3 id="让一个元素水平垂直居中"><a href="#让一个元素水平垂直居中" class="headerlink" title="让一个元素水平垂直居中"></a>让一个元素水平垂直居中</h3><ul>
<li><strong>水平居中</strong><ul>
<li>对于 行内元素 : text-align: center;</li>
<li>对于确定宽度的块级元素：<ul>
<li>（1）width 和 margin 实现。margin: 0 auto;</li>
<li>（2）绝对定位和 margin-left: (父 width - 子 width）&#x2F;2, 前提是父元素 position: relative</li>
</ul>
</li>
<li>对于宽度未知的块级元素<ul>
<li>（1）table 标签配合 margin 左右 auto 实现水平居中。使用 table 标签（或直接将块级元素设值为 display:table），再通过给该标签添加左右 margin 为 auto</li>
<li>（2）inline-block 实现水平居中方法。display：inline-block 和 text-align:center 实现水平居中。</li>
<li>（3）绝对定位+transform，translateX 可以移动本身元素的 50%。</li>
<li>（4）flex 布局使用 justify-content:center</li>
</ul>
</li>
</ul>
</li>
<li><strong>垂直居中</strong><ol>
<li>利用 line-height 实现居中，这种方法适合纯文字类</li>
<li>通过设置父容器 相对定位 ，子级设置 绝对定位，标签通过 margin 实现自适应居中</li>
<li>弹性布局 flex :父级设置 display: flex; 子级设置 margin 为 auto 实现自适应居中</li>
<li>父级设置相对定位，子级设置绝对定位，并且通过位移 transform 实现</li>
<li>table 布局，父级通过转换成表格形式，然后子级设置 vertical-align 实现。（需要注意的是：vertical-align: middle 使用的前提条件是内联元素以及 display 值为 table-cell 的元素）。</li>
</ol>
</li>
</ul>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/7008348524530106381"># 图解 CSS 水平垂直居中常见面试方法</a></p>
<h3 id="隐藏页面中某个元素的方法"><a href="#隐藏页面中某个元素的方法" class="headerlink" title="隐藏页面中某个元素的方法"></a>隐藏页面中某个元素的方法</h3><p>1.opacity：0，该元素隐藏起来了，但不会改变页面布局，并且，如果该元素已经绑定 一些事件，如 click 事件，那么点击该区域，也能触发点击事件的<br>2.visibility：hidden，该元素隐藏起来了，但不会改变页面布局，但是不会触发该元素已 经绑定的事件 ，隐藏对应元素，在文档布局中仍保留原来的空间（重绘）<br>3.display：none，把元素隐藏起来，并且会改变页面布局，可以理解成在页面中把该元素。 不显示对应的元素，在文档布局中不再分配空间（回流+重绘）</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">该问题会引出 回流和重绘</div>

<h3 id="用-CSS-实现三角符号"><a href="#用-CSS-实现三角符号" class="headerlink" title="用 CSS 实现三角符号"></a>用 CSS 实现三角符号</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*记忆口诀：盒子宽高均为零，三面边框皆透明。 */</span></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">0px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">0px</span>;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot; &quot;</span>;</span><br><span class="line">  <span class="attribute">border-right</span>: <span class="number">100px</span> solid transparent;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">100px</span> solid <span class="number">#ff0</span>;</span><br><span class="line">  <span class="attribute">border-left</span>: <span class="number">100px</span> solid transparent;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">100px</span> solid transparent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><h4 id="1-Flex-布局"><a href="#1-Flex-布局" class="headerlink" title="1.Flex 布局"></a>1.Flex 布局</h4><p>布局的传统解决方案，基于盒状模型，依赖 display 属性 + position 属性 + float 属性。它对于那些特殊布局非常不方便，比如，垂直居中就不容易实现。<br>Flex 是 Flexible Box 的缩写，意为”弹性布局”,用来为盒状模型提供最大的灵活性。指定容器 display: flex 即可。 简单的分为容器属性和元素属性。<br>容器的属性：</p>
<ul>
<li>flex-direction：决定主轴的方向（即子 item 的排列方法）flex-direction: row | row-reverse | column | column-reverse;</li>
<li>flex-wrap：决定换行规则 flex-wrap: nowrap | wrap | wrap-reverse;</li>
<li>flex-flow： .box { flex-flow: || ; }</li>
<li>justify-content：对其方式，水平主轴对齐方式</li>
<li>align-items：对齐方式，竖直轴线方向</li>
<li>align-content</li>
</ul>
<p>项目的属性（元素的属性）：</p>
<ul>
<li>order 属性：定义项目的排列顺序，顺序越小，排列越靠前，默认为 0</li>
<li>flex-grow 属性：定义项目的放大比例，即使存在空间，也不会放大</li>
<li>flex-shrink 属性：定义了项目的缩小比例，当空间不足的情况下会等比例的缩小，如果 定义个 item 的 flow-shrink 为 0，则为不缩小</li>
<li>flex-basis 属性：定义了在分配多余的空间，项目占据的空间。</li>
<li>flex：是 flex-grow 和 flex-shrink、flex-basis 的简写，默认值为 0 1 auto。</li>
<li>align-self：允许单个项目与其他项目不一样的对齐方式，可以覆盖</li>
<li>align-items，默认属 性为 auto，表示继承父元素的 align-items 比如说，用 flex 实现圣杯布局</li>
</ul>
<h4 id="2-Rem-布局"><a href="#2-Rem-布局" class="headerlink" title="2.Rem 布局"></a>2.Rem 布局</h4><p>首先 Rem 相对于根(html)的 font-size 大小来计算。简单的说它就是一个相对单例 如:font-size:10px;,那么（1rem &#x3D; 10px）了解计算原理后首先解决怎么在不同设备上设置 html 的 font-size 大小。其实 rem 布局的本质是等比缩放，一般是基于宽度。<br><strong>优点</strong>：可以快速适用移动端布局，字体，图片高度<br><strong>缺点</strong>：<br>① 目前 ie 不支持，对 pc 页面来讲使用次数不多；<br>② 数据量大：所有的图片，盒子都需要我们去给一个准确的值；才能保证不同机型的适配；<br>③ 在响应式布局中，必须通过 js 来动态控制根元素 font-size 的大小。也就是说 css 样式和 js 代码有一定的耦合性。且必须将改变 font-size 的代码放在 css 样式之前。</p>
<h4 id="3-百分比布局"><a href="#3-百分比布局" class="headerlink" title="3.百分比布局"></a>3.百分比布局</h4><p>通过百分比单位 “ % “ 来实现响应式的效果。通过百分比单位可以使得浏览器中的组件的宽和高随着浏览器的变化而变化，从而实现响应式的效果。 直观的理解，我们可能会认为子元素的百分比完全相对于直接父元素，height 百分比相 对于 height，width 百分比相对于 width。 padding、border、margin 等等不论是垂直方向还是水平方向，都相对于直接父元素的 width。 除了 border-radius 外，还有比如 translate、background-size 等都是相对于自身的。<br><strong>缺点</strong>：<br>（1）计算困难<br>（2）各个属性中如果使用百分比，相对父元素的属性并不是唯一的。造成我们使用百分比单位容易使布局问题变得复杂。</p>
<h4 id="4-浮动布局"><a href="#4-浮动布局" class="headerlink" title="4.浮动布局"></a>4.浮动布局</h4><p>浮动布局:当元素浮动以后可以向左或向右移动，直到它的外边缘碰到包含它的框或者另外一个浮动元素的边框为止。元素浮动以后会脱离正常的文档流，所以文档的普通流中的框就变的好像浮动元素不存在一样。<br><strong>优点</strong><br>这样做的优点就是在图文混排的时候可以很好的使文字环绕在图片周围。另外当元素浮动了起来之后，它有着块级元素的一些性质例如可以设置宽高等，但它与 inline-block 还是有一些区别的，第一个就是关于横向排序的时候，float 可以设置方向而 inline-block 方向是固定的；还有一个就是 inline-block 在使用时有时会有空白间隙的问题<br><strong>缺点</strong><br>最明显的缺点就是浮动元素一旦脱离了文档流，就无法撑起父元素，会造成父级元素高度塌陷。</p>
<h3 id="如何使用-rem-或-viewport-进行移动端适配"><a href="#如何使用-rem-或-viewport-进行移动端适配" class="headerlink" title="如何使用 rem 或 viewport 进行移动端适配"></a>如何使用 rem 或 viewport 进行移动端适配</h3><p><strong>rem 适配原理：</strong><br>改变了一个元素在不同设备上占据的 css 像素的个数<br>rem 适配的优缺点</p>
<ul>
<li>优点：没有破坏完美视口</li>
<li>缺点：px 值转换 rem 太过于复杂(下面我们使用 less 来解决这个问题)</li>
</ul>
<p><strong>viewport 适配的原理</strong><br>viewport 适配方案中，每一个元素在不同设备上占据的 css 像素的个数是一样的。但是 css 像素和物理像素的比例是不一样的，等比的<br>viewport 适配的优缺点</p>
<ul>
<li>在我们设计图上所量取的大小即为我们可以设置的像素大小，即所量即所设</li>
<li>缺点破坏完美视口</li>
</ul>
<h3 id="清除浮动的方式"><a href="#清除浮动的方式" class="headerlink" title="清除浮动的方式"></a>清除浮动的方式</h3><ul>
<li>添加额外标签</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;parent&quot;</span>&gt;</span></span><br><span class="line">  //添加额外标签并且添加clear属性</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;clear:both&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  //也可以加一个br标签</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>父级添加 overflow 属性，或者设置高度</li>
<li>建立伪类选择器清除浮动</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 在css中添加<span class="selector-pseudo">:after</span>伪元素</span><br><span class="line"><span class="selector-class">.parent</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">  <span class="comment">/* 设置添加子元素的内容是空 */</span></span><br><span class="line">  <span class="attribute">content</span>: <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="comment">/* 设置添加子元素为块级元素 */</span></span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="comment">/* 设置添加的子元素的高度0 */</span></span><br><span class="line">  <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* 设置添加子元素看不见 */</span></span><br><span class="line">  <span class="attribute">visibility</span>: hidden;</span><br><span class="line">  <span class="comment">/* 设置clear：both */</span></span><br><span class="line">  <span class="attribute">clear</span>: both;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JS、TS、ES6"><a href="#JS、TS、ES6" class="headerlink" title="JS、TS、ES6"></a>JS、TS、ES6</h2><h3 id="JS-中的-8-种数据类型及区别"><a href="#JS-中的-8-种数据类型及区别" class="headerlink" title="JS 中的 8 种数据类型及区别"></a>JS 中的 8 种数据类型及区别</h3><p>包括值类型(基本对象类型)和引用类型(复杂对象类型)<br><strong>基本类型(值类型)：</strong> Number(数字),String(字符串),Boolean(布尔),Symbol(符号),null(空),undefined(未定义)在内存中占据固定大小，保存在栈内存中<br><strong>引用类型(复杂数据类型)：</strong> Object(对象)、Function(函数)。其他还有 Array(数组)、Date(日期)、RegExp(正则表达式)、特殊的基本包装类型(String、Number、Boolean) 以及单体内置对象(Global、Math)等 引用类型的值是对象 保存在堆内存中，栈内存存储的是对象的变量标识符以及对象在堆内存中的存储地址。<br>传送门 ☞<a target="_blank" rel="noopener" href="https://juejin.cn/post/7000754813801775111"># JavaScript 数据类型之 Symbol、BigInt</a></p>
<h3 id="JS-中的数据类型检测方案"><a href="#JS-中的数据类型检测方案" class="headerlink" title="JS 中的数据类型检测方案"></a>JS 中的数据类型检测方案</h3><h4 id="1-typeof"><a href="#1-typeof" class="headerlink" title="1.typeof"></a>1.typeof</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="number">1</span>); <span class="comment">// number</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">true</span>); <span class="comment">// boolean</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="string">&quot;mc&quot;</span>); <span class="comment">// string</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="title class_">Symbol</span>); <span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;); <span class="comment">// function</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="variable language_">console</span>.<span class="title function_">log</span>()); <span class="comment">// undefined</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> []); <span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> &#123;&#125;); <span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">null</span>); <span class="comment">// object</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> <span class="literal">undefined</span>); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<p>优点：能够快速区分基本数据类型<br>缺点：不能将 Object、Array 和 Null 区分，都返回 object</p>
<h4 id="2-instanceof"><a href="#2-instanceof" class="headerlink" title="2.instanceof"></a>2.instanceof</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span> <span class="keyword">instanceof</span> <span class="title class_">Number</span>); <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="literal">true</span> <span class="keyword">instanceof</span> <span class="title class_">Boolean</span>); <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;str&quot;</span> <span class="keyword">instanceof</span> <span class="title class_">String</span>); <span class="comment">// false</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([] <span class="keyword">instanceof</span> <span class="title class_">Array</span>); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;&#125; <span class="keyword">instanceof</span> <span class="title class_">Function</span>); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(&#123;&#125; <span class="keyword">instanceof</span> <span class="title class_">Object</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>优点：能够区分 Array、Object 和 Function，适合用于判断自定义的类实例对象<br>缺点：Number，Boolean，String 基本数据类型不能判断</p>
<h4 id="3-Object-prototype-toString-call"><a href="#3-Object-prototype-toString-call" class="headerlink" title="3.Object.prototype.toString.call()"></a>3.Object.prototype.toString.call()</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> toString = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>(<span class="number">1</span>)); <span class="comment">//[object Number]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>(<span class="literal">true</span>)); <span class="comment">//[object Boolean]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>(<span class="string">&quot;mc&quot;</span>)); <span class="comment">//[object String]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>([])); <span class="comment">//[object Array]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>(&#123;&#125;)); <span class="comment">//[object Object]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;)); <span class="comment">//[object Function]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>(<span class="literal">undefined</span>)); <span class="comment">//[object Undefined]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(toString.<span class="title function_">call</span>(<span class="literal">null</span>)); <span class="comment">//[object Null]</span></span><br></pre></td></tr></table></figure>

<p>优点：精准判断数据类型<br>缺点：写法繁琐不容易记，推荐进行封装后使用</p>
<h3 id="var-amp-amp-let-amp-amp-const"><a href="#var-amp-amp-let-amp-amp-const" class="headerlink" title="var &amp;&amp; let &amp;&amp; const"></a>var &amp;&amp; let &amp;&amp; const</h3><p>ES6 之前创建变量用的是 var,之后创建变量用的是 let&#x2F;const<br><strong>三者区别</strong>：</p>
<ol>
<li>var 定义的变量，没有块的概念，可以跨块访问, 不能跨函数访问。<br>let 定义的变量，只能在块作用域里访问，不能跨块访问，也不能跨函数访问。<br>const 用来定义常量，使用时必须初始化(即必须赋值)，只能在块作用域里访问，且不能修改。</li>
<li>var 可以先使用，后声明，因为存在变量提升；let 必须先声明后使用。</li>
<li>var 是允许在相同作用域内重复声明同一个变量的，而 let 与 const 不允许这一现象。</li>
<li>在全局上下文中，基于 let 声明的全局变量和全局对象 GO（window）没有任何关系 ;<br>var 声明的变量会和 GO 有映射关系；</li>
<li>会产生暂时性死区：</li>
</ol>
<p>暂时性死区是浏览器的 bug：检测一个未被声明的变量类型时，不会报错，会返回 undefined<br>如：console.log(typeof a) &#x2F;&#x2F;undefined<br>而：console.log(typeof a)&#x2F;&#x2F;未声明之前不能使用<br>let a</p>
<ol>
<li>let &#x2F;const&#x2F;function 会把当前所在的大括号(除函数之外)作为一个全新的块级上下文，应用这个机制，在开发项目的时候，遇到循环事件绑定等类似的需求，无需再自己构建闭包来存储，只要基于 let 的块作用特征即可解决</li>
</ol>
<h3 id="JS-垃圾回收机制"><a href="#JS-垃圾回收机制" class="headerlink" title="JS 垃圾回收机制"></a>JS 垃圾回收机制</h3><ol>
<li>项目中，如果存在大量不被释放的内存（堆&#x2F;栈&#x2F;上下文），页面性能会变得很慢。当某些代码操作不能被合理释放，就会造成内存泄漏。我们尽可能减少使用闭包，因为它会消耗内存。</li>
<li>浏览器垃圾回收机制&#x2F;内存回收机制:</li>
</ol>
<p>浏览器的 Javascript 具有自动垃圾回收机制(GC:Garbage Collecation)，垃圾收集器会定期（周期性）找出那些不在继续使用的变量，然后释放其内存。</p>
<p><strong>标记清除</strong>:在 js 中，最常用的垃圾回收机制是标记清除：当变量进入执行环境时，被标记为“进入环境”，当变量离开执行环境时，会被标记为“离开环境”。垃圾回收器会销毁那些带标记的值并回收它们所占用的内存空间。<br><strong>谷歌浏览器</strong>：“查找引用”，浏览器不定时去查找当前内存的引用，如果没有被占用了，浏览器会回收它；如果被占用，就不能回收。<br><strong>IE 浏览器</strong>：“引用计数法”，当前内存被占用一次，计数累加 1 次，移除占用就减 1，减到 0 时，浏览器就回收它。</p>
<ol start="3">
<li>优化手段：内存优化 ; 手动释放：取消内存的占用即可。（1）堆内存：fn &#x3D; null 【null：空指针对象】（2）栈内存：把上下文中，被外部占用的堆的占用取消即可。</li>
<li>内存泄漏在 JS 中，常见的内存泄露主要有 4 种,全局变量、闭包、DOM 元素的引用、定时器</li>
</ol>
<h3 id="作用域和作用域链"><a href="#作用域和作用域链" class="headerlink" title="作用域和作用域链"></a>作用域和作用域链</h3><p>创建函数的时候，已经声明了当前函数的作用域&#x3D;&#x3D;&gt;当前创建函数所处的上下文。如果是在全局下创建的函数就是[[scope]]:EC(G)，函数执行的时候，形成一个全新的私有上下文 EC(FN)，供字符串代码执行(进栈执行)<br>定义：简单来说作用域就是变量与函数的可访问范围，由当前环境与上层环境的一系列变量对象组成 1.全局作用域：代码在程序的任何地方都能被访问，window 对象的内置属性都拥有全局作用域。 2.函数作用域：在固定的代码片段才能被访问<br>作用：作用域最大的用处就是隔离变量，不同作用域下同名变量不会有冲突。<br><strong>作用域链参考链接</strong>一般情况下，变量到 创建该变量 的函数的作用域中取值。但是如果在当前作用域中没有查到，就会向上级作用域去查，直到查到全局作用域，这么一个查找过程形成的链条就叫做作用域链。</p>
<h3 id="闭包的两大作用：保存-x2F-保护"><a href="#闭包的两大作用：保存-x2F-保护" class="headerlink" title="闭包的两大作用：保存&#x2F;保护"></a>闭包的两大作用：保存&#x2F;保护</h3><ul>
<li><strong>闭包的概念</strong>函数执行时形成的私有上下文 EC(FN)，正常情况下，代码执行完会出栈后释放;但是特殊情况下，如果当前私有上下文中的某个东西被上下文以外的事物占用了，则上下文不会出栈释放，从而形成不销毁的上下文。 函数执行函数执行过程中，会形成一个全新的私有上下文，可能会被释放，可能不会被释放，不论释放与否，他的作用是：</li>
</ul>
<p>（1）保护：划分一个独立的代码执行区域，在这个区域中有自己私有变量存储的空间，保护自己的私有变量不受外界干扰（操作自己的私有变量和外界没有关系）；<br>（2）保存：如果当前上下文不被释放【只要上下文中的某个东西被外部占用即可】，则存储的这些私有变量也不会被释放，可以供其下级上下文中调取使用，相当于把一些值保存起来了；</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">我们把函数执行形成私有上下文，来保护和保存私有变量机制称为闭包。</div>
闭包是指有权访问另一个函数作用域中的变量的函数--《JavaScript高级程序设计》
**稍全面的回答**： 在js中变量的作用域属于函数作用域, 在函数执行完后,作用域就会被清理,内存也会随之被回收,但是由于闭包函数是建立在函数内部的子函数, 由于其可访问上级作用域,即使上级函数执行完, 作用域也不会随之销毁, 这时的子函数(也就是闭包),便拥有了访问上级作用域中变量的权限,即使上级函数执行完后作用域内的值也不会被销毁。

<ul>
<li><strong>闭包的特性</strong>：<ul>
<li>1、内部函数可以访问定义他们外部函数的参数和变量。(作用域链的向上查找，把外围的作用域中的变量值存储在内存中而不是在函数调用完毕后销毁)设计私有的方法和变量，避免全局变量的污染。1.1.闭包是密闭的容器，，类似于 set、map 容器，存储数据的 1.2.闭包是一个对象，存放数据的格式为 key-value 形式</li>
<li>2、函数嵌套函数</li>
<li>3、本质是将函数内部和外部连接起来。优点是可以读取函数内部的变量，让这些变量的值始终保存在内存中，不会在函数被调用之后自动清除</li>
</ul>
</li>
<li><strong>闭包形成的条件</strong>：<ol>
<li>函数的嵌套</li>
<li>内部函数引用外部函数的局部变量，延长外部函数的变量生命周期</li>
</ol>
</li>
<li><strong>闭包的用途</strong>：<ol>
<li>模仿块级作用域</li>
<li>保护外部函数的变量 能够访问函数定义时所在的词法作用域(阻止其被回收)</li>
<li>封装私有化变量</li>
<li>创建模块</li>
</ol>
</li>
<li><strong>闭包应用场景</strong>闭包的两个场景，闭包的两大作用：保存&#x2F;保护。 在开发中, 其实我们随处可见闭包的身影, 大部分前端 JavaScript 代码都是“事件驱动”的,即一个事件绑定的回调方法; 发送 ajax 请求成功|失败的回调;setTimeout 的延时回调;或者一个函数内部返回另一个匿名函数,这些都是闭包的应用。</li>
<li><strong>闭包的优点</strong>：延长局部变量的生命周期</li>
<li><strong>闭包缺点</strong>：会导致函数的变量一直保存在内存中，过多的闭包可能会导致内存泄漏</li>
</ul>
<h3 id="JS-中-this-的五种情况"><a href="#JS-中-this-的五种情况" class="headerlink" title="JS 中 this 的五种情况"></a>JS 中 this 的五种情况</h3><ol>
<li>作为普通函数执行时，this 指向 window。</li>
<li>当函数作为对象的方法被调用时，this 就会指向该对象。</li>
<li>构造器调用，this 指向返回的这个对象。</li>
<li>箭头函数 箭头函数的 this 绑定看的是 this 所在函数定义在哪个对象下，就绑定哪个对象。如果有嵌套的情况，则 this 绑定到最近的一层对象上。</li>
<li>基于 Function.prototype 上的 apply 、 call 和 bind 调用模式，这三个方法都可以显示的指定调用函数的 this 指向。apply 接收参数的是数组，call 接受参数列表，&#96;&#96;bind方法通过传入一个对象，返回一个 this 绑定了传入对象的新函数。这个函数的 this指向除了使用new&#96;时会被改变，其他情况下都不会改变。若为空默认是指向全局对象 window。</li>
</ol>
<h3 id="原型-amp-amp-原型链"><a href="#原型-amp-amp-原型链" class="headerlink" title="原型 &amp;&amp; 原型链"></a>原型 &amp;&amp; 原型链</h3><p><strong>原型关系：</strong></p>
<ul>
<li>每个 class 都有显示原型 prototype</li>
<li>每个实例都有隐式原型 _ proto_</li>
<li>实例的* proto*指向对应 class 的 prototype</li>
</ul>
<p>‌ <strong>原型:</strong> 在 JS 中，每当定义一个对象（函数也是对象）时，对象中都会包含一些预定义的属性。其中每个函数对象都有一个 prototype 属性，这个属性指向函数的原型对象。<br>原型链：函数的原型链对象 constructor 默认指向函数本身，原型对象除了有原型属性外，为了实现继承，还有一个原型链指针<strong>proto</strong>,该指针是指向上一层的原型对象，而上一层的原型对象的结构依然类似。因此可以利用<strong>proto</strong>一直指向 Object 的原型对象上，而 Object 原型对象用 Object.prototype.** proto** &#x3D; null 表示原型链顶端。如此形成了 js 的原型链继承。同时所有的 js 对象都有 Object 的基本防范<br><strong>特点:</strong> JavaScript 对象是通过引用来传递的，我们创建的每个新对象实体中并没有一份属于自己的原型副本。当我们修改原型时，与之相关的对象也会继承这一改变。</p>
<h3 id="new-运算符的实现机制"><a href="#new-运算符的实现机制" class="headerlink" title="new 运算符的实现机制"></a>new 运算符的实现机制</h3><ol>
<li>首先创建了一个新的空对象</li>
<li>设置原型，将对象的原型设置为函数的 prototype 对象。</li>
<li>让函数的 this 指向这个对象，执行构造函数的代码（为这个新对象添加属性）</li>
<li>判断函数的返回值类型，如果是值类型，返回创建的对象。如果是引用类型，就返回这个引用类型的对象。</li>
</ol>
<h3 id="EventLoop-事件循环"><a href="#EventLoop-事件循环" class="headerlink" title="EventLoop 事件循环"></a>EventLoop 事件循环</h3><p>JS 是单线程的，为了防止一个函数执行时间过长阻塞后面的代码，所以会先将同步代码压入执行栈中，依次执行，将异步代码推入异步队列，异步队列又分为宏任务队列和微任务队列，因为宏任务队列的执行时间较长，所以微任务队列要优先于宏任务队列。微任务队列的代表就是，Promise.then，MutationObserver，宏任务的话就是 setImmediate setTimeout setInterval<br>JS 运行的环境。一般为浏览器或者 Node。 在浏览器环境中，有 JS 引擎线程和渲染线程，且两个线程互斥。 Node 环境中，只有 JS 线程。 不同环境执行机制有差异，不同任务进入不同 Event Queue 队列。 当主程结束，先执行准备好微任务，然后再执行准备好的宏任务，一个轮询结束。</p>
<h4 id="浏览器中的事件环（Event-Loop"><a href="#浏览器中的事件环（Event-Loop" class="headerlink" title="浏览器中的事件环（Event Loop)"></a><strong>浏览器中的事件环（Event Loop)</strong></h4><p>事件环的运行机制是，先会执行栈中的内容，栈中的内容执行后执行微任务，微任务清空后再执行宏任务，先取出一个宏任务，再去执行微任务，然后在取宏任务清微任务这样不停的循环。</p>
<ul>
<li>eventLoop 是由 JS 的宿主环境（浏览器）来实现的；</li>
<li>事件循环可以简单的描述为以下四个步骤:<img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942744876-8ec477cb-080f-4e0f-963b-9b5a2e8a7243.webp#averageHue=%23f8f6f1&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u1868f416&margin=%5Bobject%20Object%5D&originHeight=592&originWidth=897&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u0c5c11df-9572-4205-8965-2022aaebfb1&title="><ol>
<li>函数入栈，当 Stack 中执行到异步任务的时候，就将他丢给 WebAPIs,接着执行同步任务,直到 Stack 为空；</li>
<li>此期间 WebAPIs 完成这个事件，把回调函数放入队列中等待执行（微任务放到微任务队列，宏任务放到宏任务队列）</li>
<li>执行栈为空时，Event Loop 把微任务队列执行清空；</li>
<li>微任务队列清空后，进入宏任务队列，取队列的第一项任务放入 Stack(栈）中执行，执行完成后，查看微任务队列是否有任务，有的话，清空微任务队列。重复 4，继续从宏任务中取任务执行，执行完成之后，继续清空微任务，如此反复循环，直至清空所有的任务。</li>
</ol>
</li>
<li>浏览器中的任务源(task):<ul>
<li>宏任务(macrotask)：<br>宿主环境提供的，比如浏览器<br>ajax、setTimeout、setInterval、setTmmediate(只兼容 ie)、script、requestAnimationFrame、messageChannel、UI 渲染、一些浏览器 api</li>
<li>微任务(microtask)：<br>语言本身提供的，比如 promise.then<br>then、queueMicrotask(基于 then)、mutationObserver(浏览器提供)、messageChannel 、mutationObersve</li>
</ul>
</li>
</ul>
<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/7001881781125251086"># 宏任务和微任务</a></p>
<h4 id="Node-环境中的事件环（Event-Loop"><a href="#Node-环境中的事件环（Event-Loop" class="headerlink" title="Node 环境中的事件环（Event Loop)"></a><strong>Node 环境中的事件环（Event Loop)</strong></h4><p>Node 是基于 V8 引擎的运行在服务端的 JavaScript 运行环境，在处理高并发、I&#x2F;O 密集(文件操作、网络操作、数据库操作等)场景有明显的优势。虽然用到也是 V8 引擎，但由于服务目的和环境不同，导致了它的 API 与原生 JS 有些区别，其 Event Loop 还要处理一些 I&#x2F;O，比如新的网络连接等，所以 Node 的 Event Loop(事件环机制)与浏览器的是不太一样。<br><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942744890-1bdfab15-ad14-402a-aa18-0d10dc04d86a.webp#averageHue=%232d3038&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uaa0d719c&margin=%5Bobject%20Object%5D&originHeight=689&originWidth=776&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u2531eb20-c01d-4aaf-86ea-0cadd3da29e&title="> 执行顺序如下：</p>
<ul>
<li>timers: 计时器，执行 setTimeout 和 setInterval 的回调</li>
<li>pending callbacks: 执行延迟到下一个循环迭代的 I&#x2F;O 回调</li>
<li>idle, prepare: 队列的移动，仅系统内部使用</li>
<li>poll 轮询: 检索新的 I&#x2F;O 事件;执行与 I&#x2F;O 相关的回调。事实上除了其他几个阶段处理的事情，其他几乎所有的异步都在这个阶段处理。</li>
<li>check: 执行 setImmediate 回调，setImmediate 在这里执行</li>
<li>close callbacks: 执行 close 事件的 callback，一些关闭的回调函数，如：socket.on(‘close’, …)</li>
</ul>
<h3 id="setTimeout、Promise、Async-x2F-Await-的区别"><a href="#setTimeout、Promise、Async-x2F-Await-的区别" class="headerlink" title="setTimeout、Promise、Async&#x2F;Await 的区别"></a>setTimeout、Promise、Async&#x2F;Await 的区别</h3><ol>
<li>setTimeout</li>
</ol>
<p>settimeout 的回调函数放到宏任务队列里，等到执行栈清空以后执行。</p>
<ol start="2">
<li>Promise</li>
</ol>
<p>Promise 本身是<strong>同步的立即执行函数</strong>， 当在 executor 中执行 resolve 或者 reject 的时候, 此时是异步操作， 会先执行 then&#x2F;catch 等，当主栈完成后，才会去调用 resolve&#x2F;reject 中存放的方法执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> promise1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> (<span class="params">resolve</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise1&quot;</span>);</span><br><span class="line">  <span class="title function_">resolve</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise1 end&quot;</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;promise2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;settimeout&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script end&quot;</span>);</span><br><span class="line"><span class="comment">// 输出顺序: script start-&gt;promise1-&gt;promise1 end-&gt;script end-&gt;promise2-&gt;settimeout</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>async&#x2F;await</li>
</ol>
<p>async 函数返回一个 Promise 对象，当函数执行的时候，一旦遇到 await 就会先返回，等到触发的异步操作完成，再执行函数体内后面的语句。可以理解为，是让出了线程，跳出了 async 函数体。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">async1</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async1 start&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">async2</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async1 end&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">async2</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;async2&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"><span class="title function_">async1</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script end&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：script start-&gt;async1 start-&gt;async2-&gt;script end-&gt;async1 end</span></span><br></pre></td></tr></table></figure>

<p>传送门 ☞ <a target="_blank" rel="noopener" href="https://juejin.cn/post/6999651011304357925"># JavaScript Promise 专题</a></p>
<h3 id="Async-x2F-Await-如何通过同步的方式实现异步"><a href="#Async-x2F-Await-如何通过同步的方式实现异步" class="headerlink" title="Async&#x2F;Await 如何通过同步的方式实现异步"></a>Async&#x2F;Await 如何通过同步的方式实现异步</h3><p>Async&#x2F;Await 就是一个<strong>自执行</strong>的 generate 函数。利用 generate 函数的特性把异步的代码写成“同步”的形式,第一个请求的返回值作为后面一个请求的参数,其中每一个参数都是一个 promise 对象.</p>
<h3 id="介绍节流防抖原理、区别以及应用"><a href="#介绍节流防抖原理、区别以及应用" class="headerlink" title="介绍节流防抖原理、区别以及应用"></a>介绍节流防抖原理、区别以及应用</h3><p>节流：事件触发后，规定时间内，事件处理函数不能再次被调用。也就是说在规定的时间内，函数只能被调用一次，且是最先被触发调用的那次。<br>防抖：多次触发事件，事件处理函数只能执行一次，并且是在触发操作结束时执行。也就是说，当一个事件被触发准备执行事件函数前，会等待一定的时间（这时间是码农自己去定义的，比如 1 秒），如果没有再次被触发，那么就执行，如果被触发了，那就本次作废，重新从新触发的时间开始计算，并再次等待 1 秒，直到能最终执行！<br>使用场景：<br>节流：滚动加载更多、搜索框搜的索联想功能、高频点击、表单重复提交……<br>防抖：搜索框搜索输入，并在输入完以后自动搜索、手机号，邮箱验证输入检测、窗口大小 resize 变化后，再重新渲染。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 节流函数 一个函数执行一次后，只有大于设定的执行周期才会执行第二次。有个需要频繁触发的函数，出于优化性能的角度，在规定时间内，只让函数触发的第一次生效，后面的不生效。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn要被节流的函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> delay规定的时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttle</span>(<span class="params">fn, delay</span>) &#123;</span><br><span class="line">  <span class="comment">//记录上一次函数触发的时间</span></span><br><span class="line">  <span class="keyword">var</span> lastTime = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//记录当前函数触发的时间</span></span><br><span class="line">    <span class="keyword">var</span> nowTime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="keyword">if</span> (nowTime - lastTime &gt; delay) &#123;</span><br><span class="line">      <span class="comment">//修正this指向问题</span></span><br><span class="line">      fn.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">      <span class="comment">//同步执行结束时间</span></span><br><span class="line">      lastTime = nowTime;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">onscroll</span> = <span class="title function_">throttle</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;scllor事件被触发了&quot;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>());</span><br><span class="line">&#125;, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 防抖函数  一个需要频繁触发的函数，在规定时间内，只让最后一次生效，前面的不生效</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> fn要被节流的函数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> delay规定的时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">fn, delay</span>) &#123;</span><br><span class="line">  <span class="comment">//记录上一次的延时器</span></span><br><span class="line">  <span class="keyword">var</span> timer = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//清除上一次的演示器</span></span><br><span class="line">    <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    <span class="comment">//重新设置新的延时器</span></span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//修正this指向问题</span></span><br><span class="line">      fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;btn&quot;</span>).<span class="property">onclick</span> = <span class="title function_">debounce</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;按钮被点击了&quot;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>());</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="简述-MVVM"><a href="#简述-MVVM" class="headerlink" title="简述 MVVM"></a>简述 MVVM</h3><p><strong>什么是 MVVM？</strong><br>视图模型双向绑定，是 Model-View-ViewModel 的缩写，也就是把 MVC 中的 Controller 演变成 ViewModel。Model 层代表数据模型，View 代表 UI 组件，ViewModel 是 View 和 Model 层的桥梁，数据会绑定到 viewModel 层并自动将数据渲染到页面中，视图变化的时候会通知 viewModel 层更新数据。以前是操作 DOM 结构更新视图，现在是数据驱动视图。<br><strong>MVVM 的优点：</strong> 1.低耦合。视图（View）可以独立于 Model 变化和修改，一个 Model 可以绑定到不同的 View 上，当 View 变化的时候 Model 可以不变化，当 Model 变化的时候 View 也可以不变； 2.可重用性。你可以把一些视图逻辑放在一个 Model 里面，让很多 View 重用这段视图逻辑。 3.独立开发。开发人员可以专注于业务逻辑和数据的开发(ViewModel)，设计人员可以专注于页面设计。 4.可测试。</p>
<h3 id="Vue-底层实现原理"><a href="#Vue-底层实现原理" class="headerlink" title="Vue 底层实现原理"></a>Vue 底层实现原理</h3><p>vue.js 是采用数据劫持结合发布者-订阅者模式的方式，通过 Object.defineProperty()来劫持各个属性的 setter 和 getter，在数据变动时发布消息给订阅者，触发相应的监听回调<br>Vue 是一个典型的 MVVM 框架，模型（Model）只是普通的 javascript 对象，修改它则试图（View）会自动更新。这种设计让状态管理变得非常简单而直观<br><strong>Observer（数据监听器）</strong> : Observer 的核心是通过 Object.defineProprtty()来监听数据的变动，这个函数内部可以定义 setter 和 getter，每当数据发生变化，就会触发 setter。这时候 Observer 就要通知订阅者，订阅者就是 Watcher<br><strong>Watcher（订阅者）</strong> : Watcher 订阅者作为 Observer 和 Compile 之间通信的桥梁，主要做的事情是：</p>
<ol>
<li>在自身实例化时往属性订阅器(dep)里面添加自己</li>
<li>自身必须有一个 update()方法</li>
<li>待属性变动 dep.notice()通知时，能调用自身的 update()方法，并触发 Compile 中绑定的回调</li>
</ol>
<p><strong>Compile（指令解析器）</strong> : Compile 主要做的事情是解析模板指令，将模板中变量替换成数据，然后初始化渲染页面视图，并将每个指令对应的节点绑定更新函数，添加鉴定数据的订阅者，一旦数据有变动，收到通知，更新试图</p>
<h3 id="谈谈对-vue-生命周期的理解？"><a href="#谈谈对-vue-生命周期的理解？" class="headerlink" title="谈谈对 vue 生命周期的理解？"></a>谈谈对 vue 生命周期的理解？</h3><p>每个 Vue 实例在创建时都会经过一系列的初始化过程，vue 的生命周期钩子，就是说在达到某一阶段或条件时去触发的函数，目的就是为了完成一些动作或者事件</p>
<ul>
<li>create 阶段：vue 实例被创建<br>beforeCreate: 创建前，此时 data 和 methods 中的数据都还没有初始化<br>created： 创建完毕，data 中有值，未挂载</li>
<li>mount 阶段： vue 实例被挂载到真实 DOM 节点<br>beforeMount：可以发起服务端请求，去数据<br>mounted: 此时可以操作 DOM</li>
<li>update 阶段：当 vue 实例里面的 data 数据变化时，触发组件的重新渲染<br>beforeUpdate :更新前<br>updated：更新后</li>
<li>destroy 阶段：vue 实例被销毁<br>beforeDestroy：实例被销毁前，此时可以手动销毁一些方法<br>destroyed:销毁后</li>
</ul>
<h4 id="组件生命周期"><a href="#组件生命周期" class="headerlink" title="组件生命周期"></a>组件生命周期</h4><p>生命周期（父子组件） 父组件 beforeCreate –&gt; 父组件 created –&gt; 父组件 beforeMount –&gt; 子组件 beforeCreate –&gt; 子组件 created –&gt; 子组件 beforeMount –&gt; 子组件 mounted –&gt; 父组件 mounted –&gt;父组件 beforeUpdate –&gt;子组件 beforeDestroy–&gt; 子组件 destroyed –&gt; 父组件 updated<br><strong>加载渲染过程</strong> 父 beforeCreate-&gt;父 created-&gt;父 beforeMount-&gt;子 beforeCreate-&gt;子 created-&gt;子 beforeMount-&gt;子 mounted-&gt;父 mounted<br><strong>挂载阶段</strong> 父 created-&gt;子 created-&gt;子 mounted-&gt;父 mounted<br><strong>父组件更新阶段</strong> 父 beforeUpdate-&gt;父 updated<br><strong>子组件更新阶段</strong> 父 beforeUpdate-&gt;子 beforeUpdate-&gt;子 updated-&gt;父 updated<br><strong>销毁阶段</strong> 父 beforeDestroy-&gt;子 beforeDestroy-&gt;子 destroyed-&gt;父 destroyed</p>
<h3 id="computed-与-watch"><a href="#computed-与-watch" class="headerlink" title="computed 与 watch"></a>computed 与 watch</h3><p>通俗来讲，既能用 computed 实现又可以用 watch 监听来实现的功能，推荐用 computed， 重点在于 computed 的缓存功能 computed 计算属性是用来声明式的描述一个值依赖了其它的值，当所依赖的值或者变量 改变时，计算属性也会跟着改变； watch 监听的是已经在 data 中定义的变量，当该变量变化时，会触发 watch 中的方法。<br><strong>watch 属性监听</strong><br>是一个对象，键是需要观察的属性，值是对应回调函数，主要用来监听某些特定数据的变化，从而进行某些具体的业务逻辑操作,监听属性的变化，需要在数据变化时执行异步或开销较大的操作时使用<br><strong>computed 计算属性</strong><br>属性的结果会被缓存，当 computed 中的函数所依赖的属性没有发生改变的时候，那么调用当前函数的时候结果会从缓存中读取。除非依赖的响应式属性变化时才会重新计算，主要当做属性来使用 computed 中的函数必须用 return 返回最终的结果 computed 更高效，优先使用。data 不改变，computed 不更新。<br><strong>使用场景</strong><br>computed：当一个属性受多个属性影响的时候使用，例：购物车商品结算功能<br>watch：当一条数据影响多条数据的时候使用，例：搜索数据</p>
<h3 id="组件中的-data-为什么是一个函数？"><a href="#组件中的-data-为什么是一个函数？" class="headerlink" title="组件中的 data 为什么是一个函数？"></a>组件中的 data 为什么是一个函数？</h3><p>1.一个组件被复用多次的话，也就会创建多个实例。本质上，这些实例用的都是同一个构造函数。 2.如果 data 是对象的话，对象属于引用类型，会影响到所有的实例。所以为了保证组件不同的实例之间 data 不冲突，data 必须是一个函数。</p>
<h3 id="为什么-v-for-和-v-if-不建议用在一起"><a href="#为什么-v-for-和-v-if-不建议用在一起" class="headerlink" title="为什么 v-for 和 v-if 不建议用在一起"></a>为什么 v-for 和 v-if 不建议用在一起</h3><p>1.当 v-for 和 v-if 处于同一个节点时，v-for 的优先级比 v-if 更高，这意味着 v-if 将分别重复运行于每个 v-for 循环中。如果要遍历的数组很大，而真正要展示的数据很少时，这将造成很大的性能浪费（Vue2.x） 2.这种场景建议使用 computed，先对数据进行过滤<br>注意：3.x 版本中 v-if 总是优先于 v-for 生效。由于语法上存在歧义，建议避免在同一元素上同时使用两者。比起在模板层面管理相关逻辑，更好的办法是通过创建计算属性筛选出列表，并以此创建可见元素。<br>解惑传送门 ☞ <a href="https://link.juejin.cn/?target=https://v3.cn.vuejs.org/guide/migration/v-if-v-for.html%23%25E6%25A6%2582%25E8%25A7%2588"># v-if 与 v-for 的优先级对比非兼容</a></p>
<h3 id="React-x2F-Vue-项目中-key-的作用"><a href="#React-x2F-Vue-项目中-key-的作用" class="headerlink" title="React&#x2F;Vue 项目中 key 的作用"></a>React&#x2F;Vue 项目中 key 的作用</h3><ul>
<li>key 的作用是为了在 diff 算法执行时更快的找到对应的节点，提高 diff 速度，更高效的更新虚拟 DOM;</li>
</ul>
<p>vue 和 react 都是采用 diff 算法来对比新旧虚拟节点，从而更新节点。在 vue 的 diff 函数中，会根据新节点的 key 去对比旧节点数组中的 key，从而找到相应旧节点。如果没找到就认为是一个新增节点。而如果没有 key，那么就会采用遍历查找的方式去找到对应的旧节点。一种一个 map 映射，另一种是遍历查找。相比而言。map 映射的速度更快。</p>
<ul>
<li>为了在数据变化时强制更新组件，以避免“就地复用”带来的副作用。</li>
</ul>
<p>当 Vue.js 用 v-for 更新已渲染过的元素列表时，它默认用“就地复用”策略。如果数据项的顺序被改变，Vue 将不会移动 DOM 元素来匹配数据项的顺序，而是简单复用此处每个元素，并且确保它在特定索引下显示已被渲染过的每个元素。重复的 key 会造成渲染错误。</p>
<h3 id="vue-组件的通信方式"><a href="#vue-组件的通信方式" class="headerlink" title="vue 组件的通信方式"></a>vue 组件的通信方式</h3><ul>
<li>props&#x2F;$emit 父子组件通信</li>
</ul>
<p>父-&gt;子 props，子-&gt;父 $on、$emit 获取父子组件实例 parent、childrenRef 获取实例的方式调用组件的属性或者方法 父-&gt;子孙 Provide、inject 官方不推荐使用，但是写组件库时很常用</p>
<ul>
<li>$emit&#x2F;$on 自定义事件 兄弟组件通信</li>
</ul>
<p>Event Bus 实现跨组件通信 Vue.prototype.$bus &#x3D; new Vue() 自定义事件</p>
<ul>
<li>vuex 跨级组件通信</li>
</ul>
<p>Vuex、$attrs、$listenersProvide、inject</p>
<h3 id="nextTick-的实现"><a href="#nextTick-的实现" class="headerlink" title="nextTick 的实现"></a>nextTick 的实现</h3><ol>
<li>nextTick 是 Vue 提供的一个全局 API,是在下次 DOM 更新循环结束之后执行延迟回调，在修改数据之后使用$nextTick，则可以在回调中获取更新后的 DOM；</li>
<li>Vue 在更新 DOM 时是异步执行的。只要侦听到数据变化，Vue 将开启 1 个队列，并缓冲在同一事件循环中发生的所有数据变更。如果同一个 watcher 被多次触发，只会被推入到队列中-次。这种在缓冲时去除重复数据对于避免不必要的计算和 DOM 操作是非常重要的。nextTick 方法会在队列中加入一个回调函数，确保该函数在前面的 dom 操作完成后才调用；</li>
<li>比如，我在干什么的时候就会使用 nextTick，传一个回调函数进去，在里面执行 dom 操作即可；</li>
<li>我也有简单了解 nextTick 实现，它会在 callbacks 里面加入我们传入的函数，然后用 timerFunc 异步方式调用它们，首选的异步方式会是 Promise。这让我明白了为什么可以在 nextTick 中看到 dom 操作结果。</li>
</ol>
<h3 id="nextTick-的实现原理是什么？"><a href="#nextTick-的实现原理是什么？" class="headerlink" title="nextTick 的实现原理是什么？"></a>nextTick 的实现原理是什么？</h3><p>在下次 DOM 更新循环结束之后执行延迟回调，在修改数据之后立即使用 nextTick 来获取更新后的 DOM。 nextTick 主要使用了宏任务和微任务。 根据执行环境分别尝试采用 Promise、MutationObserver、setImmediate，如果以上都不行则采用 setTimeout 定义了一个异步方法，多次调用 nextTick 会将方法存入队列中，通过这个异步方法清空当前队列。</p>
<h3 id="使用过插槽么？用的是具名插槽还是匿名插槽或作用域插槽"><a href="#使用过插槽么？用的是具名插槽还是匿名插槽或作用域插槽" class="headerlink" title="使用过插槽么？用的是具名插槽还是匿名插槽或作用域插槽"></a>使用过插槽么？用的是具名插槽还是匿名插槽或作用域插槽</h3><p>vue 中的插槽是一个非常好用的东西 slot 说白了就是一个占位的 在 vue 当中插槽包含三种一种是默认插槽（匿名）一种是具名插槽还有一种就是作用域插槽 匿名插槽就是没有名字的只要默认的都填到这里具名插槽指的是具有名字的</p>
<h3 id="keep-alive-的实现"><a href="#keep-alive-的实现" class="headerlink" title="keep-alive 的实现"></a>keep-alive 的实现</h3><p>作用：实现组件缓存，保持这些组件的状态，以避免反复渲染导致的性能问题。 需要缓存组件 频繁切换，不需要重复渲染<br>场景：tabs 标签页 后台导航，vue 性能优化<br>原理：Vue.js 内部将 DOM 节点抽象成了一个个的 VNode 节点，keep-alive 组件的缓存也是基于 VNode 节点的而不是直接存储 DOM 结构。它将满足条件（pruneCache 与 pruneCache）的组件在 cache 对象中缓存起来，在需要重新渲染的时候再将 vnode 节点从 cache 对象中取出并渲染。</p>
<h3 id="mixin"><a href="#mixin" class="headerlink" title="mixin"></a>mixin</h3><p>mixin 项目变得复杂的时候，多个组件间有重复的逻辑就会用到 mixin<br>多个组件有相同的逻辑，抽离出来<br>mixin 并不是完美的解决方案，会有一些问题<br>vue3 提出的 Composition API 旨在解决这些问题【追求完美是要消耗一定的成本的，如开发成本】<br>场景：PC 端新闻列表和详情页一样的右侧栏目，可以使用 mixin 进行混合<br>劣势：1.变量来源不明确，不利于阅读 2.多 mixin 可能会造成命名冲突 3.mixin 和组件可能出现多对多的关系，使得项目复杂度变高</p>
<h3 id="Vuex-的理解及使用场景"><a href="#Vuex-的理解及使用场景" class="headerlink" title="Vuex 的理解及使用场景"></a>Vuex 的理解及使用场景</h3><p>Vuex 是一个专为 Vue 应用程序开发的状态管理模式。每一个 Vuex 应用的核心就是 store（仓库）。</p>
<ol>
<li>Vuex 的状态存储是响应式的；当 Vue 组件从 store 中读取状态的时候，</li>
</ol>
<p>若 store 中的状态发生变化，那么相应的组件也会相应地得到高效更新 2. 改变 store 中的状态的唯一途径就是显式地提交 (commit) mutation， 这样使得我们可以方便地跟踪每一个状态的变化 Vuex 主要包括以下几个核心模块：</p>
<ol>
<li>State：定义了应用的状态数据</li>
<li>Getter：在 store 中定义“getter”（可以认为是 store 的计算属性），</li>
</ol>
<p>就像计算属性一样，getter 的返回值会根据它的依赖被缓存起来， 且只有当它的依赖值发生了改变才会被重新计算 3. Mutation：是唯一更改 store 中状态的方法，且必须是同步函数 4. Action：用于提交 mutation，而不是直接变更状态，可以包含任意异步操作 5. Module：允许将单一的 Store 拆分为多个 store 且同时保存在单一的状态树中<br><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942745286-4882527b-cca7-49f9-b6fe-a43fa4e72799.webp#averageHue=%23fefcfa&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=uefb7e1ae&margin=%5Bobject%20Object%5D&originHeight=551&originWidth=701&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u77394fb6-f3b5-413e-8b44-4a634410e14&title="></p>
<h3 id="hooks-用过吗？聊聊-react-中-class-组件和函数组件的区别"><a href="#hooks-用过吗？聊聊-react-中-class-组件和函数组件的区别" class="headerlink" title="hooks 用过吗？聊聊 react 中 class 组件和函数组件的区别"></a>hooks 用过吗？聊聊 react 中 class 组件和函数组件的区别</h3><p>类组件是使用 ES6 的 class 来定义的组件。<br>函数组件是接收一个单一的 props 对象并返回一个 React 元素。</p>
<p>关于 React 的两套 API（类（class）API 和基于函数的钩子（hooks） API）。官方推荐使用钩子（函数），而不是类。因为钩子更简洁，代码量少，用起来比较”轻”，而类比较”重”。而且，钩子是函数，更符合 React 函数式的本质。<br>函数一般来说，只应该做一件事，就是返回一个值。 如果你有多个操作，每个操作应该写成一个单独的函数。而且，数据的状态应该与操作方法分离。根据函数这种理念，React 的函数组件只应该做一件事情：返回组件的 HTML 代码，而没有其他的功能。函数的返回结果只依赖于它的参数。不改变函数体外部数据、函数执行过程里面没有副作用。<br>类（class）是数据和逻辑的封装。 也就是说，组件的状态和操作方法是封装在一起的。如果选择了类的写法，就应该把相关的数据和操作，都写在同一个 class 里面。<br><strong>类组件的缺点</strong> :<br>大型组件很难拆分和重构，也很难测试。<br>业务逻辑分散在组件的各个方法之中，导致重复逻辑或关联逻辑。<br>组件类引入了复杂的编程模式，比如 render props 和高阶组件。<br>难以理解的 class，理解 JavaScript 中 this 的工作方式。<br><strong>区别</strong>：<br>函数组件的性能比类组件的性能要高，因为类组件使用的时候要实例化，而函数组件直接执行函数取返回结果即可。 1.状态的有无<br>hooks 出现之前，函数组件没有实例，没有生命周期，没有 state，没有 this，所以我们称函数组件为无状态组件。 hooks 出现之前，react 中的函数组件通常只考虑负责 UI 的渲染，没有自身的状态没有业务逻辑代码，是一个纯函数。它的输出只由参数 props 决定，不受其他任何因素影响。 2.调用方式的不同<br>函数组件重新渲染，将重新调用组件方法返回新的 react 元素。类组件重新渲染将 new 一个新的组件实例，然后调用 render 类方法返回 react 元素，这也说明为什么类组件中 this 是可变的。 3.因为调用方式不同，在函数组件使用中会出现问题<br>在操作中改变状态值，类组件可以获取最新的状态值，而函数组件则会按照顺序返回状态值</p>
<p><strong>React Hooks（钩子的作用）</strong><br><em>Hook</em> 是 React 16.8 的新增特性。它可以让你在不编写 class 的情况下使用 state 以及其他的 React 特性。<br>React Hooks 的几个常用钩子:</p>
<ol>
<li>useState() &#x2F;&#x2F;状态钩子</li>
<li>useContext() &#x2F;&#x2F;共享状态钩子</li>
<li>useReducer() &#x2F;&#x2F;action 钩子</li>
<li>useEffect() &#x2F;&#x2F;副作用钩子</li>
</ol>
<p>还有几个不常见的大概的说下，后续会专门写篇文章描述下</p>
<ul>
<li>1.useCallback 记忆函数 一般把<strong>函数式组件理解为 class 组件 render 函数的语法糖</strong>，所以每次重新渲染的时候，函数式组件内部所有的代码都会重新执行一遍。而有了 useCallback 就不一样了，你可以通过 useCallback 获得一个记忆后的函数。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> memoizedHandleClick = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Click happened&quot;</span>);</span><br><span class="line">  &#125;, []); <span class="comment">// 空数组代表无论什么情况下该函数都不会发生改变</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">SomeComponent</span> <span class="attr">onClick</span>=<span class="string">&#123;memoizedHandleClick&#125;</span>&gt;</span>Click Me<span class="tag">&lt;/<span class="name">SomeComponent</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个参数传入一个数组，数组中的每一项一旦值或者引用发生改变，useCallback 就会重新返回一个新的记忆函数提供给后面进行渲染。</p>
<ul>
<li>2.useMemo 记忆组件 useCallback 的功能完全可以由 useMemo 所取代，如果你想通过使用 useMemo 返回一个记忆函数也是完全可以的。 唯一的区别是：<strong>useCallback 不会执行第一个参数函数，而是将它返回给你，而 useMemo 会执行第一个函数并且将函数执行结果返回给你</strong>。<br>所以 useCallback 常用记忆事件函数，生成记忆后的事件函数并传递给子组件使用。而 useMemo 更适合经过函数计算得到一个确定的值，比如记忆组件。</li>
<li>3.useRef 保存引用值 useRef 跟 createRef 类似，都可以用来生成对 DOM 对象的引用。useRef 返回的值传递给组件或者 DOM 的 ref 属性，就可以通过 ref.current 值<strong>访问组件或真实的 DOM 节点，重点是组件也是可以访问到的</strong>，从而可以对 DOM 进行一些操作，比如监听事件等等。</li>
<li>4.useImperativeHandle 穿透 Ref 通过 useImperativeHandle 用于让父组件获取子组件内的索引</li>
<li>5.useLayoutEffect 同步执行副作用大部分情况下，使用 useEffect 就可以帮我们处理组件的副作用，但是如果想要同步调用一些副作用，比如对 DOM 的操作，就需要使用 useLayoutEffect，useLayoutEffect 中的副作用会在 DOM 更新之后同步执行。<strong>useEffect 和 useLayoutEffect 有什么区别</strong>：简单来说就是调用时机不同，useLayoutEffect 和原来 componentDidMount&amp;componentDidUpdate 一致，在 react 完成 DOM 更新后马上同步调用的代码，会阻塞页面渲染。而 useEffect 是会在整个页面渲染完才会调用的代码。官方建议优先使用 useEffect</li>
</ul>
<h3 id="React-组件通信方式"><a href="#React-组件通信方式" class="headerlink" title="React 组件通信方式"></a>React 组件通信方式</h3><p>react 组件间通信常见的几种情况:</p>
<ol>
<li>父组件向子组件通信</li>
<li>子组件向父组件通信</li>
<li>跨级组件通信</li>
<li>非嵌套关系的组件通信</li>
</ol>
<h4 id="1）父组件向子组件通信"><a href="#1）父组件向子组件通信" class="headerlink" title="1）父组件向子组件通信"></a>1）父组件向子组件通信</h4><p>父组件通过 props 向子组件传递需要的信息。父传子是在父组件中直接绑定一个正常的属性，这个属性就是指具体的值，在子组件中，用 props 就可以获取到这个值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子组件: Child</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Child</span> = (<span class="params">props</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;props.name&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父组件 Parent</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Parent</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Child</span> <span class="attr">name</span>=<span class="string">&quot;京程一灯&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Child</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2）子组件向父组件通信"><a href="#2）子组件向父组件通信" class="headerlink" title="2）子组件向父组件通信"></a>2）子组件向父组件通信</h4><p>props+回调的方式，使用公共组件进行状态提升。子传父是先在父组件上绑定属性设置为一个函数，当子组件需要给父组件传值的时候，则通过 props 调用该函数将参数传入到该函数当中，此时就可以在父组件中的函数中接收到该参数了，这个参数则为子组件传过来的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子组件: Child</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Child</span> = (<span class="params">props</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">cb</span> = (<span class="params">msg</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      props.<span class="title function_">callback</span>(msg);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;cb(</span>&quot;<span class="attr">京程一灯欢迎你</span>!&quot;)&#125;&gt;</span>京程一灯欢迎你<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父组件 Parent</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Parent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">callback</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(msg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Child</span> <span class="attr">callback</span>=<span class="string">&#123;this.callback.bind(this)&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">Child</span>&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3）跨级组件通信"><a href="#3）跨级组件通信" class="headerlink" title="3）跨级组件通信"></a>3）跨级组件通信</h4><p>即父组件向子组件的子组件通信，向更深层子组件通信。</p>
<ul>
<li>使用 props，利用中间组件层层传递,但是如果父组件结构较深，那么中间每一层组件都要去传递 props，增加了复杂度，并且这些 props 并不是中间组件自己需要的。</li>
<li>使用 context，context 相当于一个大容器，我们可以把要通信的内容放在这个容器中，这样不管嵌套多深，都可以随意取用，对于跨越多层的全局数据可以使用 context 实现。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// context方式实现跨级组件通信</span></span><br><span class="line"><span class="comment">// Context 设计目的是为了共享那些对于一个组件树而言是“全局”的数据</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BatteryContext</span> = <span class="title function_">createContext</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//  子组件的子组件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GrandChild</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">BatteryContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;(color) =&gt; <span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color:</span> <span class="attr">color</span> &#125;&#125;&gt;</span>我是红色的:&#123;color&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">BatteryContext.Consumer</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  子组件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Child</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">GrandChild</span> /&gt;</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 父组件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Parent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&quot;red&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; color &#125; = <span class="variable language_">this</span>.<span class="property">state</span>;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">BatteryContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;color&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Child</span>&gt;</span><span class="tag">&lt;/<span class="name">Child</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">BatteryContext.Provider</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4）非嵌套关系的组件通信"><a href="#4）非嵌套关系的组件通信" class="headerlink" title="4）非嵌套关系的组件通信"></a>4）非嵌套关系的组件通信</h4><p>即没有任何包含关系的组件，包括兄弟组件以及不在同一个父级中的非兄弟组件。</p>
<ol>
<li>可以使用自定义事件通信（发布订阅模式），使用 pubsub-js</li>
<li>可以通过 redux 等进行全局状态管理</li>
<li>如果是兄弟组件通信，可以找到这两个兄弟节点共同的父节点, 结合父子间通信方式进行通信。</li>
<li>也可以 new 一个 Vue 的 EventBus,进行事件监听，一边执行监听，一边执行新增 VUE 的 eventBus 就是发布订阅模式，是可以在 React 中使用的;</li>
</ol>
<h3 id="setState-既存在异步情况也存在同步情况"><a href="#setState-既存在异步情况也存在同步情况" class="headerlink" title="setState 既存在异步情况也存在同步情况"></a>setState 既存在异步情况也存在同步情况</h3><p>1.异步情况 在 React 事件当中是异步操作 2.同步情况 如果是在 setTimeout 事件或者自定义的 dom 事件中，都是同步的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setTimeout事件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Count</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>count:&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.btnAction&#125;</span>&gt;</span>增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  btnAction = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//不能直接修改state，需要通过setState进行修改</span></span><br><span class="line">    <span class="comment">//同步</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Count</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义dom事件</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Count</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>count:&#123;this.state.count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>绑定点击事件<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//自定义dom事件，也是同步修改</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Count</span>;</span><br></pre></td></tr></table></figure>

<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942745343-4d73cb0f-f731-444e-aa3e-20a37adaf966.webp#averageHue=%23d6dfd5&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u6e005328&margin=%5Bobject%20Object%5D&originHeight=436&originWidth=839&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3e6258b7-88e7-42ca-acd7-88ccfcf60af&title="></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//安装</span></span><br><span class="line"><span class="comment">//当组件的实例被创建并插入到 DOM 中时，这些方法按以下顺序调用：</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>)</span><br><span class="line"><span class="keyword">static</span> <span class="title function_">getDerivedStateFromProps</span>()</span><br><span class="line"><span class="title function_">render</span>()</span><br><span class="line"><span class="title function_">componentDidMount</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新中</span></span><br><span class="line"><span class="comment">//更新可能由道具或状态的更改引起。当重新渲染组件时，这些方法按以下顺序调用：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="title function_">getDerivedStateFromProps</span>()</span><br><span class="line"><span class="title function_">shouldComponentUpdate</span>()</span><br><span class="line"><span class="title function_">render</span>()</span><br><span class="line"><span class="title function_">getSnapshotBeforeUpdate</span>()</span><br><span class="line"><span class="title function_">componentDidUpdate</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">//卸载</span></span><br><span class="line"><span class="comment">//当组件从 DOM 中移除时调用此方法：</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">componentWillUnmount</span>()</span><br></pre></td></tr></table></figure>

<h3 id="说一下-react-fiber"><a href="#说一下-react-fiber" class="headerlink" title="说一下 react-fiber"></a>说一下 react-fiber</h3><h4 id="1）背景"><a href="#1）背景" class="headerlink" title="1）背景"></a>1）背景</h4><p>react-fiber 产生的根本原因，是大量的同步计算任务阻塞了浏览器的 UI 渲染。默认情况下，JS 运算、页面布局和页面绘制都是运行在浏览器的主线程当中，他们之间是互斥的关系。如果 JS 运算持续占用主线程，页面就没法得到及时的更新。当我们调用 setState 更新页面的时候，React 会遍历应用的所有节点，计算出差异，然后再更新 UI。如果页面元素很多，整个过程占用的时机就可能超过 16 毫秒，就容易出现掉帧的现象。</p>
<h4 id="2）实现原理"><a href="#2）实现原理" class="headerlink" title="2）实现原理"></a>2）实现原理</h4><ul>
<li>react 内部运转分三层：<ul>
<li>Virtual DOM 层，描述页面长什么样。</li>
<li>Reconciler 层，负责调用组件生命周期方法，进行 Diff 运算等。</li>
<li>Renderer 层，根据不同的平台，渲染出相应的页面，比较常见的是 ReactDOM 和 ReactNative。</li>
</ul>
</li>
</ul>
<p>Fiber 其实指的是一种数据结构，它可以用一个纯 JS 对象来表示：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fiber = &#123;</span><br><span class="line">    stateNode,    <span class="comment">// 节点实例</span></span><br><span class="line">    child,        <span class="comment">// 子节点</span></span><br><span class="line">    sibling,      <span class="comment">// 兄弟节点</span></span><br><span class="line">    <span class="keyword">return</span>,       <span class="comment">// 父节点</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>为了实现不卡顿，就需要有一个调度器 (Scheduler) 来进行任务分配。优先级高的任务（如键盘输入）可以打断优先级低的任务（如 Diff）的执行，从而更快的生效。任务的优先级有六种：<ul>
<li>synchronous，与之前的 Stack Reconciler 操作一样，同步执行</li>
<li>task，在 next tick 之前执行</li>
<li>animation，下一帧之前执行</li>
<li>high，在不久的将来立即执行</li>
<li>low，稍微延迟执行也没关系</li>
<li>offscreen，下一次 render 时或 scroll 时才执行</li>
</ul>
</li>
<li>Fiber Reconciler（react ）执行过程分为 2 个阶段：<ul>
<li>阶段一，生成 Fiber 树，得出需要更新的节点信息。这一步是一个渐进的过程，可以被打断。阶段一可被打断的特性，让优先级更高的任务先执行，从框架层面大大降低了页面掉帧的概率。</li>
<li>阶段二，将需要更新的节点一次过批量更新，这个过程不能被打断。</li>
</ul>
</li>
<li>Fiber 树：React 在 render 第一次渲染时，会通过 React.createElement 创建一颗 Element 树，可以称之为 Virtual DOM Tree，由于要记录上下文信息，加入了 Fiber，每一个 Element 会对应一个 Fiber Node，将 Fiber Node 链接起来的结构成为 Fiber Tree。Fiber Tree 一个重要的特点是链表结构，将递归遍历编程循环遍历，然后配合 requestIdleCallback API, 实现任务拆分、中断与恢复。</li>
</ul>
<p>从 Stack Reconciler 到 Fiber Reconciler，源码层面其实就是干了一件递归改循环的事情<br>传送门 ☞<a target="_blank" rel="noopener" href="https://juejin.cn/post/7002250258826657799"># 深入了解 Fiber</a></p>
<h3 id="Portals"><a href="#Portals" class="headerlink" title="Portals"></a>Portals</h3><p>Portals 提供了一种一流的方式来将子组件渲染到存在于父组件的 DOM 层次结构之外的 DOM 节点中。结构不受外界的控制的情况下就可以使用 portals 进行创建</p>
<h3 id="何时要使用异步组件？如和使用异步组件"><a href="#何时要使用异步组件？如和使用异步组件" class="headerlink" title="何时要使用异步组件？如和使用异步组件"></a>何时要使用异步组件？如和使用异步组件</h3><ul>
<li>加载大组件的时候</li>
<li>路由异步加载的时候</li>
</ul>
<p>react 中要配合 Suspense 使用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步懒加载</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Box</span> = <span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;./components/Box&quot;</span>));</span><br><span class="line"><span class="comment">// 使用组件的时候要用suspense进行包裹</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;&#123;show &amp;&amp; <span class="tag">&lt;<span class="name">Box</span> /&gt;</span>&#125;<span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="React-事件绑定原理"><a href="#React-事件绑定原理" class="headerlink" title="React 事件绑定原理"></a>React 事件绑定原理</h3><p>React 并不是将 click 事件绑在该 div 的真实 DOM 上，而是在 document 处监听所有支持的事件，当事件发生并冒泡至 document 处时，React 将事件内容封装并交由真正的处理函数运行。这样的方式不仅减少了内存消耗，还能在组件挂载销毁时统一订阅和移除事件。<br>另外冒泡到 document 上的事件也不是原生浏览器事件，而是 React 自己实现的合成事件（SyntheticEvent）。因此我们如果不想要事件冒泡的话，调用 event.stopPropagation 是无效的，而应该调用 event.preventDefault。<br><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942745347-0728d400-cc1c-4821-8f8d-6e322b79a1a3.webp#averageHue=%23fafaf8&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=ub257aa56&margin=%5Bobject%20Object%5D&originHeight=395&originWidth=878&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u82f71d93-7a11-4a25-81b4-8225e993961&title="></p>
<h2 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h2><h3 id="webpack-做过哪些优化，开发效率方面、打包策略方面等等"><a href="#webpack-做过哪些优化，开发效率方面、打包策略方面等等" class="headerlink" title="webpack 做过哪些优化，开发效率方面、打包策略方面等等"></a>webpack 做过哪些优化，开发效率方面、打包策略方面等等</h3><p><strong>1）优化 Webpack 的构建速度</strong></p>
<ul>
<li>使用高版本的 Webpack （使用 webpack4）</li>
<li>多线程&#x2F;多实例构建：HappyPack(不维护了)、thread-loader</li>
<li>缩小打包作用域：<ul>
<li>exclude&#x2F;include (确定 loader 规则范围)</li>
<li>resolve.modules 指明第三方模块的绝对路径 (减少不必要的查找)</li>
<li>resolve.extensions 尽可能减少后缀尝试的可能性</li>
<li>noParse 对完全不需要解析的库进行忽略 (不去解析但仍会打包到 bundle 中，注意被忽略掉的文件里不应该包含 import、require、define 等模块化语句)</li>
<li>IgnorePlugin (完全排除模块)</li>
<li>合理使用 alias</li>
</ul>
</li>
<li>充分利用缓存提升二次构建速度：<ul>
<li>babel-loader 开启缓存</li>
<li>terser-webpack-plugin 开启缓存</li>
<li>使用 cache-loader 或者 hard-source-webpack-plugin<br>注意：thread-loader 和 cache-loader 兩個要一起使用的話，請先放 cache-loader 接著是 thread-loader 最後才是 heavy-loader</li>
</ul>
</li>
<li>DLL：<ul>
<li>使用 DllPlugin 进行分包，使用 DllReferencePlugin(索引链接) 对 manifest.json 引用，让一些基本不会改动的代码先打包成静态资源，避免反复编译浪费时间。 2）使用 webpack4-优化原因</li>
</ul>
</li>
<li>(a)V8 带来的优化（for of 替代 forEach、Map 和 Set 替代 Object、includes 替代 indexOf）</li>
<li>(b)默认使用更快的 md4 hash 算法</li>
<li>(c)webpacks AST 可以直接从 loader 传递给 AST，减少解析时间</li>
<li>(d)使用字符串方法替代正则表达式 ①noParse</li>
<li>不去解析某个库内部的依赖关系</li>
<li>比如 jquery 这个库是独立的， 则不去解析这个库内部依赖的其他的东西</li>
<li>在独立库的时候可以使用</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">noParse</span>: <span class="regexp">/jquery/</span>,</span><br><span class="line">    <span class="attr">rules</span>: [],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>②IgnorePlugin</p>
<ul>
<li>忽略掉某些内容 不去解析依赖库内部引用的某些内容</li>
<li>从 moment 中引用 .&#x2F;locol 则忽略掉</li>
<li>如果要用 local 的话 则必须在项目中必须手动引入</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;moment/locale/zh-cn&#x27;</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Webpack</span>.<span class="title class_">IgnorePlugin</span>(<span class="regexp">/./</span>local/, <span class="regexp">/moment/</span>),</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>③dillPlugin</p>
<ul>
<li>不会多次打包， 优化打包时间</li>
<li>先把依赖的不变的库打包</li>
<li>生成 manifest.json 文件</li>
<li>然后在 webpack.config 中引入</li>
<li>webpack.DllPlugin Webpack.DllReferencePlugin ④happypack -&gt; thread-loader</li>
<li>大项目的时候开启多线程打包</li>
<li>影响前端发布速度的有两个方面，一个是构建，一个就是压缩，把这两个东西优化起来，可以减少很多发布的时间。 ⑤thread-loader<br>thread-loader 会将您的 loader 放置在一个 worker 池里面运行，以达到多线程构建。<br>把这个 loader 放置在其他 loader 之前（如下图 example 的位置）， 放置在这个 loader 之后的 loader 就会在一个单独的 worker 池(worker pool)中运行。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/.js$/</span>,</span><br><span class="line">        <span class="attr">include</span>: path.<span class="title function_">resolve</span>(<span class="string">&quot;src&quot;</span>),</span><br><span class="line">        <span class="attr">use</span>: [</span><br><span class="line">          <span class="string">&quot;thread-loader&quot;</span>,</span><br><span class="line">          <span class="comment">// 你的高开销的loader放置在此 (e.g babel-loader)</span></span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每个 worker 都是一个单独的有 600ms 限制的 node.js 进程。同时跨进程的数据交换也会被限制。请在高开销的 loader 中使用，否则效果不佳<br>⑥ 压缩加速——开启多线程压缩</p>
<ul>
<li>不推荐使用 webpack-paralle-uglify-plugin，项目基本处于没人维护的阶段，issue 没人处理，pr 没人合并。<br>Webpack 4.0 以前：uglifyjs-webpack-plugin，parallel 参数</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimizer</span>: [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">UglifyJsPlugin</span>(&#123;</span><br><span class="line">        <span class="attr">parallel</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>推荐使用 terser-webpack-plugin</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimizer</span>: [<span class="keyword">new</span> <span class="title class_">TerserPlugin</span>(</span><br><span class="line">      <span class="attr">parallel</span>: <span class="literal">true</span>   <span class="comment">// 多线程</span></span><br><span class="line">    )],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>2）优化 Webpack 的打包体积</strong></p>
<ul>
<li>压缩代码</li>
<li>提取页面公共资源：</li>
<li>Tree shaking</li>
<li>Scope hoisting</li>
<li>图片压缩</li>
<li>动态 Polyfill</li>
</ul>
<p><strong>3）speed-measure-webpack-plugin</strong><br>简称 SMP，分析出 Webpack 打包过程中 Loader 和 Plugin 的耗时，有助于找到构建过程中的性能瓶颈。<br><strong>开发阶段</strong><br>开启多核压缩 插件：** terser-webpack-plugin **</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">TerserPlugin</span> = <span class="built_in">require</span>(<span class="string">&quot;terser-webpack-plugin&quot;</span>);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">minimizer</span>: [</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">TerserPlugin</span>(&#123;</span><br><span class="line">        <span class="attr">parallel</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">terserOptions</span>: &#123;</span><br><span class="line">          <span class="attr">ecma</span>: <span class="number">6</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>传送门 ☞<a target="_blank" rel="noopener" href="https://juejin.cn/post/6996188856164810789"># 工程化专题</a></p>
<h2 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h2><h3 id="简单描述一下-Babel-的编译过程"><a href="#简单描述一下-Babel-的编译过程" class="headerlink" title="简单描述一下 Babel 的编译过程"></a>简单描述一下 Babel 的编译过程</h3><p>Babel 是一个 JavaScript 编译器，是一个工具链，主要用于将采用 ECMAScript 2015+ 语法编写的代码转换为向后兼容的 JavaScript 语法，以便能够运行在当前和旧版本的浏览器或其他环境中。<br>Babel 本质上就是在操作 AST 来完成代码的转译。AST 是抽象语法树（Abstract Syntax Tree, AST）<br>如果想要了解更多，可以阅读和尝试：</p>
<ul>
<li>分析 AST：<a href="https://link.juejin.cn/?target=https://astexplorer.net/">ASTexplorer.net</a></li>
<li>AST 规范：<a href="https://link.juejin.cn/?target=https://github.com/estree/estree">github.com&#x2F;estree&#x2F;estr…</a></li>
</ul>
<p>Babel 的功能很纯粹，它只是一个编译器。大多数编译器的工作过程可以分为三部分：</p>
<ol>
<li><strong>解析（Parse）</strong> ：将源代码转换成更加抽象的表示方法（例如抽象语法树）。包括词法分析和语法分析。词法分析主要把字符流源代码（Char Stream）转换成令牌流（ Token Stream），语法分析主要是将令牌流转换成抽象语法树（Abstract Syntax Tree，AST）。</li>
<li><strong>转换（Transform）</strong> ：通过 Babel 的插件能力，对（抽象语法树）做一些特殊处理，将高版本语法的 AST 转换成支持低版本语法的 AST。让它符合编译器的期望，当然在此过程中也可以对 AST 的 Node 节点进行优化操作，比如添加、更新以及移除节点等。</li>
<li><strong>生成（Generate）</strong> ：将 AST 转换成字符串形式的低版本代码，同时也能创建 Source Map 映射。</li>
</ol>
<p>经过这三个阶段，代码就被 Babel 转译成功了。<br><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942745368-96fd775f-8dde-4ef5-a2d9-8dfa245ade82.webp#averageHue=%23f5f5f4&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u494cbae4&margin=%5Bobject%20Object%5D&originHeight=457&originWidth=753&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc2067da4-2afc-487b-a8fd-08e13d72ed3&title="><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942745369-893e0cb0-6b6a-46b4-b885-eb785168814a.webp#averageHue=%23f2f2f2&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u31c87bae&margin=%5Bobject%20Object%5D&originHeight=415&originWidth=763&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=uca8b7d72-3e34-463d-ae59-4690559d3e0&title="></p>
<h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><h3 id="Git-常用命令"><a href="#Git-常用命令" class="headerlink" title="Git 常用命令"></a>Git 常用命令</h3><p>查看分支：git branch<br>创建分支：git branch<br>切换分支：git checkout<br>创建+切换分支：git checkout -b<br>合并某分支到当前分支：git merge<br>删除分支：git branch -d</p>
<h3 id="如何使用-Git-管理项目"><a href="#如何使用-Git-管理项目" class="headerlink" title="如何使用 Git 管理项目"></a>如何使用 Git 管理项目</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/webp/473454/1669942745622-bc813697-4afe-43c3-9249-cf2bede0ce44.webp#averageHue=%23cfd59e&clientId=u92e9eb4a-d376-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u8878a7a5&margin=%5Bobject%20Object%5D&originHeight=1342&originWidth=1035&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&status=done&style=none&taskId=u92927494-8d50-49f0-ac7c-f3c8ccfcd7a&title="><br>实际开发中，一个仓库（一般只放一个项目）主要存在两条主分支：master 与 develop 分支。这个两个分支的生命周期是整个项目周期。<br>我们可能使用的不同类型的分支对项目进行管理是：</p>
<ul>
<li>功能分支 功能分支（或有时称为主题分支）用于为即将发布或遥远的未来版本开发新功能。在开始开发某个功能时，将包含该功能的目标版本在那时很可能是未知的。功能分支的本质在于，只要该功能处于开发阶段，它就存在，但最终会被合并回 develop（明确将新功能添加到即将发布的版本中）或丢弃。功能分支通常只存在于开发者仓库中，而不存在于 origin。</li>
<li>发布分支 发布分支支持准备新的生产版本。它们允许在最后一刻打点 i 和交叉 t。此外，它们允许修复小错误并为发布准备元数据（版本号、构建日期等）。通过在发布分支上完成所有这些工作，该 develop 分支被清除以接收下一个大版本的功能。<ul>
<li>从 develop 分支拉取，且必须合并回 develop 和 master</li>
<li>分支命名约定：release-*</li>
</ul>
</li>
<li>修补程序分支 Hotfix 分支与发布分支非常相似，因为它们也旨在为新的生产版本做准备，尽管是计划外的。它们产生于需要立即对现场制作版本的不良状态采取行动。当必须立即解决生产版本中的关键错误时，可以从标记生产版本的主分支上的相应标记中分支出一个修补程序分支。</li>
</ul>
<p><strong>master</strong>：这个分支最为稳定，这个分支表明项目处于可发布的状态。<br><strong>develop</strong>：做为开发的分支，平行于 master 分支。<br><strong>Feature branches</strong>：这种分支和咱们程序员平常开发最为密切，称做功能分支。必须从 develop 分支建立，完成后合并回 develop 分支。<br><strong>Release branches</strong>：这个分支用来分布新版本。从 develop 分支建立，完成后合并回 develop 与 master 分支。这个分支上能够作一些很是小的 bug 修复，固然，你也能够禁止在这个分支作任何 bug 的修复工做，而只作版本发布的相关操做，例如设置版本号等操做，那样的话那些发现的小 bug 就必须放到下一个版本修复了。若是在这个分支上发现了大 bug，那么也绝对不能在这个分支上改，须要 Featrue 分支上改，走正常的流程。<br><strong>Hotfix branches</strong>：这个分支主要为修复线上特别紧急的 bug 准备的。必须从 master 分支建立，完成后合并回 develop 与 master 分支。这个分支主要是解决线上版本的紧急 bug 修复的，例如忽然版本 V0.1 上有一个致命 bug，必须修复。那么咱们就能够从 master 分支上发布这个版本那个时间点 例如 tag v0.1（通常代码发布后会及时在 master 上打 tag），来建立一个 hotfix-v0.1.1 的分支，而后在这个分支上改 bug，而后发布新的版本。最后将代码合并回 develop 与 master 分支。<br><a href="https://link.juejin.cn/?target=https://nvie.com/posts/a-successful-git-branching-model/">更多请参考</a></p>
<h3 id="项目优化"><a href="#项目优化" class="headerlink" title="项目优化"></a>项目优化</h3><p>移除生产环境的控制台打印。方案很多，esling+pre-commit、使用插件自动去除，插件包括 babel-plugin-transform-remove-console、uglifyjs-webpack-plugin、terser-webpack-plugin。最后选择了 terser-webpack-plugin，脚手架 vue-cli 用这个插件来开启缓存和多线程打包，无需安装额外的插件，仅需在 configureWebpack 中设置 terser 插件的 drop_console 为 true 即可。最好还是养成良好的代码习惯，在开发基本完成后去掉无用的 console，vscode 中的 turbo console 就蛮好的。<br>第三方库的按需加载。echarts，官方文档里是使用配置文件指定使用的模块，另一种使用 babel-plugin-equire 实现按需加载。element-ui 使用 babel-plugin-component 实现按需引入。<br>前后端数据交换方面，推动项目组使用蓝湖、接口文档，与后端同学协商，规范后台数据返回。<br>雅虎军规提到的，避免 css 表达式、滤镜，较少 DOM 操作，优化图片、精灵图，避免图片空链接等。<br>性能问题：页面加载性能、动画性能、操作性能。Performance API，记录性能数据。<br>winter 重学前端 优化技术方案：<br>缓存：客户端控制的强缓存策略。<br>降低请求成本：DNS 由客户端控制，隔一段时间主动请求获取域名 IP，不走系统 DNS（完全看不懂）。TCP&#x2F;TLS 连接复用，服务器升级到 HTTP2，尽量合并域名。<br>减少请求数：JS、CSS 打包到 HTML。JS 控制图片异步加载、懒加载。小型图片使用 data-uri。<br>较少传输体积：尽量使用 SVG\gradient 代替图片。根据机型和网络状况控制图片清晰度。对低清晰度图片使用锐化来提升体验。设计上避免大型背景图。<br>使用 CDN 加速，内容分发网络，是建立再承载网基础上的虚拟分布式网络，能够将源站内容缓存到全国或全球的节点服务器上。用户就近获取内容，提高了资源的访问速度，分担源站压力。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/26/%E5%BD%92%E7%BA%B3%E9%9D%A2%E8%AF%95%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/26/%E5%BD%92%E7%BA%B3%E9%9D%A2%E8%AF%95%E9%A2%98/" class="post-title-link" itemprop="url">归纳面试题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-26 19:06:37" itemprop="dateCreated datePublished" datetime="2022-11-26T19:06:37+08:00">2022-11-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:18" itemprop="dateModified" datetime="2022-12-08T17:09:18+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="配置-nginx"><a href="#配置-nginx" class="headerlink" title="配置 nginx"></a>配置 nginx</h1><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> localhost;</span><br><span class="line">	<span class="comment"># 访问 /, 返回静态资源</span></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># api转发,(请求后端api,转发到7001端口)</span></span><br><span class="line">  <span class="attribute">lacation</span> /api/v1 &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:7001;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment"># 报错页面</span></span><br><span class="line">  <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> 50x.html</span><br><span class="line">  location = /50x.html &#123;</span><br><span class="line">    <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="配置-webpack"><a href="#配置-webpack" class="headerlink" title="配置 webpack"></a>配置 webpack</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/index.js&quot;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;bundle.js&quot;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;dist&quot;</span>),</span><br><span class="line">    <span class="attr">publicPath</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">hotOnly</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&quot;/api&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&quot;api.example.com&quot;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">          <span class="string">&quot;^api&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/.js$/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&quot;babel-loader&quot;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [<span class="string">&quot;@babel/preset-env&quot;</span>],</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CleanWebpackPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">CopyWebpackPlugin</span>(),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="配置-rollup"><a href="#配置-rollup" class="headerlink" title="配置 rollup"></a>配置 rollup</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json form <span class="string">&#x27;@rollup/plugin-json&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;nodeResolve&#125; <span class="keyword">from</span> <span class="string">&#x27;@rollup/plugin-node-resolve&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">input</span>: <span class="string">&#x27;src/index.js&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="comment">// 如果是多入口或者分包就不能使用file,需要使用dir</span></span><br><span class="line">    <span class="attr">file</span>: <span class="string">&#x27;dist/bundle.js&#x27;</span>,</span><br><span class="line">    <span class="comment">// dir: &#x27;dist&#x27;,</span></span><br><span class="line">    <span class="comment">// 多入口和分包也不能使用iife,可以使用amd.iife会将文件放在一个函数内</span></span><br><span class="line">    <span class="attr">format</span>: <span class="string">&#x27;iife&#x27;</span></span><br><span class="line">    <span class="comment">// format: &#x27;amd&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 由于roolup默认只支持esm,如果要加载cjs模块需要插件</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// 加载json文件</span></span><br><span class="line">    <span class="title function_">json</span>(),</span><br><span class="line">    <span class="comment">// 加载cjs文件</span></span><br><span class="line">    <span class="title function_">nodeResolve</span>()</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="React-问题"><a href="#React-问题" class="headerlink" title="React 问题"></a>React 问题</h1><h2 id="React-memo-useMemo-useCallback-都是什么-区别-应用场景-方法"><a href="#React-memo-useMemo-useCallback-都是什么-区别-应用场景-方法" class="headerlink" title="React.memo useMemo useCallback 都是什么,区别?应用场景?方法?"></a>React.memo useMemo useCallback 都是什么,区别?应用场景?方法?</h2><ul>
<li>React.memo 是高阶组件,是对整个组件进行包裹.作用类似于 class 组件中的<code>shouldComponentUpdate</code>,对 props 是否变化做浅层比较.<br>变化才会重新渲染.如果想深层比较,可以使用它的第二个参数.和<code>shouldComponentUpdate</code>不同的地方是第二个参数的返回值,props 如果相等是返回 true,而<code>shouldComponentUpdate</code>返回的是 false.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">MyComponent</span>, areEqual); <span class="comment">// 第二个参数areEqual</span></span><br></pre></td></tr></table></figure>

<ul>
<li>React.memo 是对整个组件进行包裹,useMemo 和 useCallback 是对更细粒度的值或函数进行优化.</li>
<li>useMemo 和 useCallback 差异在于返回值,一个是返回的 memorize 值,一个是返回 memorize 函数.</li>
<li>useMemo 和 useCallback 需要配合 React.memo,如果不使用 memo,那么每次 prop 整体都是一个新的对象&#x2F;</li>
<li>Vue 会自动去做这件事,React 需要手动去做.</li>
</ul>
<h2 id="Hook-为啥不能变-不能在前面加判断语句"><a href="#Hook-为啥不能变-不能在前面加判断语句" class="headerlink" title="Hook 为啥不能变.不能在前面加判断语句?"></a>Hook 为啥不能变.不能在前面加判断语句?</h2><p>要保证 hooks 是在最顶层调用.是为了保证多个 hooks 调用的顺序是一致.<br>Hooks 最终是构建了一个单项链表,每次执行都是按照同样的顺序被调用,如果放在循环,条件语句或者嵌套函数中肯定会破坏它的顺序型导致问题.</p>
<h2 id="Fiber-算法"><a href="#Fiber-算法" class="headerlink" title="Fiber 算法"></a>Fiber 算法</h2><p>Fiber 是一个执行单元,一种数据结构.因为 React16 之前是将虚拟 DOM 树看出一个任务执行,递归处理,任务庞大且不能中断.<br>React16 之后,将整个任务分成一个个小的任务在空余时间里处理,主要是通过 requestIdleCallback 这个浏览器的 API 去获取浏览器的空余时间,如果有,就执行,没有就让出主线程.</p>
<h2 id="useLayoutEffect-和-useEffect-区别-在哪个阶段执行-beginWork-commit-Work"><a href="#useLayoutEffect-和-useEffect-区别-在哪个阶段执行-beginWork-commit-Work" class="headerlink" title="useLayoutEffect,和 useEffect 区别?在哪个阶段执行? beginWork,commit Work"></a>useLayoutEffect,和 useEffect 区别?在哪个阶段执行? beginWork,commit Work</h2><p>二者的函数签名是相同的,不同点在于触发的时机不同.<br><code>useLayoutEffect</code>是同步处理副作用.<code>useEffect</code> 是异步处理.<br><code>useLayoutEffect</code>在 DOM 更新后,浏览器渲染之前,<code>useLayoutEffect</code>内部的更新将会同步刷新.<br><code>useEffect</code>是在浏览器渲染后.<br><code>useLayoutEffect</code>是在<code>commitWork</code>阶段.</p>
<h2 id="Redux-是双向数据绑定吗"><a href="#Redux-是双向数据绑定吗" class="headerlink" title="Redux 是双向数据绑定吗?"></a>Redux 是双向数据绑定吗?</h2><p>不是,是单向数据流.</p>
<h2 id="redux-和-react-redux-区别"><a href="#redux-和-react-redux-区别" class="headerlink" title="redux 和 react-redux 区别"></a>redux 和 react-redux 区别</h2><ol>
<li>redux 和组件进行对接的时候是直接在组件中进行创建。react-redux 是运用 Provider 将组件和 store 对接，使在 Provider 里的所有组件都能共享 store 里的数据，还要使用 connect 将组件和 react 连接.</li>
<li>redux 获取 state 是直接通过 store.getState()。<br>react-redux 获取 state 是通过 mapStateToProps 函数，只要 state 数据变化就能获取最新数据</li>
<li>redux 是使用 dispatch 直接触发，来操作 store 的数据。<br>react-redux 是使用 mapDispatchToProps 函数然后在调用 dispatch 进行触发</li>
</ol>
<h2 id="React-vs-Vue-区别"><a href="#React-vs-Vue-区别" class="headerlink" title="React vs Vue 区别"></a>React vs Vue 区别</h2><ol>
<li>从写法上,react 推荐的是 jsx+内联样式,即<code>all in js</code>.Vue 是 template 的单文件格式,即 html,js,css 写在同一个文件中.</li>
<li>虚拟 DOM 的区别,主要是 diff 算法的区别</li>
<li>数据驱动视图.</li>
</ol>
<ul>
<li>Vue 是类似 MVVM 框架,数据响应式 &#x3D;&gt; 转化 data 属性为 getter&#x2F;setter &#x3D;&gt;watcher 实例对象进行依赖收集与监听 &#x3D;&gt;数据 setter 被调用时,watcher 对比前后两个值是否发生变化 &#x3D;&gt; 通知视图是否进行渲染.</li>
<li>React 通过<code>setState</code>实现数据驱动视图. setState 将接收的第一个参数 state 存储在<code>pending</code>队列中,判断当前 React 是否处在批量更新状态,是的话就将需要更新的 state 组件添加到<code>dirtyComponent</code>中,不是的话,就遍历<code>dirtyComponent</code>中的所有组件,调用<code>updateComponent</code>方法更新每个<code>dirty</code>组件.</li>
</ul>
<h2 id="diff-算法区别"><a href="#diff-算法区别" class="headerlink" title="diff 算法区别"></a>diff 算法区别</h2><ol>
<li>dom 更新策略不同<br>react 会自顶而下全 diff,vue 会跟踪每个组件的依赖关系,不需要重新渲染整个组件树.<br>react 当状态发生改变会重新 render 页面,生成新的虚拟 dom 树,新旧 dom 树进行比较,进行打补丁的方式,局部更新 dom.<br>所以需要手动的对不需要重新渲染的组件或者值进行 memo 优化.<br>vue 是通过数据响应式的方式,通过<code>Object.defineProperty</code>把 data 的属性转化为<code>getter/setter</code>.同时进行依赖收集与监听,setter 被调用时进行组件更新.</li>
<li>diff 算法源码实现不同<br>vue 采用双端对比的算法,同时从新旧 children 的两端进行比较,借助 key 值找到可复用的节点,再进行相关操作.</li>
</ol>
<h3 id="react-为什么没有采用双指针"><a href="#react-为什么没有采用双指针" class="headerlink" title="react 为什么没有采用双指针?"></a>react 为什么没有采用双指针?</h3><p>因为目前 Fiber 上没有设置反向链表,单向链表无法使用双指针,所以无法对算法进行双指针优化.</p>
<h2 id="react-异步组件"><a href="#react-异步组件" class="headerlink" title="react 异步组件"></a>react 异步组件</h2><p>原理: 用 componentDidCatch 捕获异步请求，如果有异步请求渲染 fallback，等到异步请求执行完毕，渲染真实组件，借此整个异步流程完毕.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">LazyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&quot;./test.js&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">LazyComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="setState-是异步还是同步"><a href="#setState-是异步还是同步" class="headerlink" title="setState 是异步还是同步"></a>setState 是异步还是同步</h2><p>本质上是批量执行或非批量执行的问题.而且只在 React18 以前存在.<br>在 react17 中，setState 是批量执行的，因为执行前会设置 executionContext。但如果在 setTimeout、事件监听器等函数里，就不会设置 executionContext 了，这时候 setState 会同步执行。可以在外面包一层 batchUpdates 函数，手动设置下 executionContext 来切换成异步批量执行<br>在 react18 里面，如果用 createRoot 的 api，就不会有这种问题了，因为所有的 setState 都是异步批量执行了。</p>
<h1 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h1><h2 id="webpack-plugin-原理"><a href="#webpack-plugin-原理" class="headerlink" title="webpack plugin 原理"></a>webpack plugin 原理</h2><p>利用钩子机制,在生命周期的钩子上挂载函数实现扩展.</p>
<h2 id="webpack-中-publicPath-作用"><a href="#webpack-中-publicPath-作用" class="headerlink" title="webpack 中 publicPath 作用?"></a>webpack 中 publicPath 作用?</h2><p>静态资源的基础路径,一般在生成模式下使用.</p>
<h2 id="tree-shaking"><a href="#tree-shaking" class="headerlink" title="tree shaking"></a>tree shaking</h2><p>作用是移除未引入的代码.<br>webpack 的 tree-shaking 在 production 下是默认开启的.<br>tree-shaking 需要依赖 ESModule 模块才能起作用.<br>在开发环境下可以通过设置<code>optimization: &#123; useExports: true; minimize: true&#125;</code>开启.<br>这个和<code>babel-loader</code>中<code>preset-env</code>互斥,但是新版本的已经改为自动判断是否开启.所以不用担心.</p>
<h2 id="Webpack-x3D-gt-sideEffects"><a href="#Webpack-x3D-gt-sideEffects" class="headerlink" title="Webpack  &#x3D;&gt; sideEffects"></a>Webpack  &#x3D;&gt; sideEffects</h2><p>可以在<code>optimization</code>中开启标识副作用,在<code>package.json</code>中标识是否有副作用.<br>也可以在<code>package.json</code>中标记哪些有副作用,不过在生产环境是默认开启的.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//package.json</span></span><br><span class="line"><span class="attr">sideEffects</span>: [<span class="string">&quot;./src/extends.js&quot;</span>, <span class="string">&quot;*.css&quot;</span>];</span><br></pre></td></tr></table></figure>

<h2 id="直接导出构造函数会被-tree-shaking-吗"><a href="#直接导出构造函数会被-tree-shaking-吗" class="headerlink" title="直接导出构造函数会被 tree-shaking 吗"></a>直接导出构造函数会被 tree-shaking 吗</h2><p>看导出的构造函数有没有被使用了</p>
<h2 id="webpack-打包体积如何减小"><a href="#webpack-打包体积如何减小" class="headerlink" title="webpack 打包体积如何减小?"></a>webpack 打包体积如何减小?</h2><p>chunk 分包,<code>import</code>动态导入,提取公共模块.</p>
<h2 id="webpack-优化"><a href="#webpack-优化" class="headerlink" title="webpack 优化"></a>webpack 优化</h2><p>在加快构建时间方面，作用最大的是配置 cache，可大大加快二次构建速度。</p>
<p>在减小打包体积方面，作用最大的是压缩代码、分离重复代码、Tree Shaking，可最大幅度减小打包体积。</p>
<p>在加快加载速度方面，按需加载、浏览器缓存、CDN 效果都很显著。</p>
<p>配置持久化 cache</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cache: &#123;</span><br><span class="line">    type: &quot;filesystem&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>压缩代码:</p>
<ul>
<li>压缩 js 代码:在 production 模式默认开启压缩.可以在 optimization 的 minimizer 中进行配置</li>
<li>压缩 html 代码: 在 HtmlWebpackPlugin 中 minify 开启压缩.</li>
</ul>
<p>打包的代码加上 hash,实现缓存文件<br>开启 tree Shaking,移除未引用代码(production 默认开启)<br>开启方法: 在 package.json 配置 sideEffects: false(表示都没有副作用,可以清除所有未引用代码),如果有,写个数组[‘*.css’],一般都是 css 文件<br>按照路由拆分代码,实现按需加载</p>
<p>多页应用实现多入口打包,设置多个 entry 入口,htmlWebpackPlugin 也是多个<br>提取公共模块,也就是分离代码,在 optimization 中设置 splitChunks,</p>
<p>图片压缩</p>
<ul>
<li>使用雪碧图,字体图标, 5k 一下使用 base64 编码<br>使用 cdn</li>
</ul>
<p>使用预加载<br>script 标签中 rel&#x3D;”preload”</p>
<ul>
<li>DNS 预解析 dns-prefetch</li>
<li>资源预加载 preload</li>
<li>预渲染 prerender</li>
</ul>
<p>减少重排重绘</p>
<ul>
<li>不使用 table 布局</li>
<li>css 属性读写分离</li>
<li>样式批量修改</li>
<li>减少 dom 深度</li>
<li>将没用的元素设置为不可见 visibility: hidden</li>
</ul>
<h2 id="polyfill-按需加载-babel-典型配置"><a href="#polyfill-按需加载-babel-典型配置" class="headerlink" title="polyfill 按需加载 babel 典型配置"></a>polyfill 按需加载 babel 典型配置</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;@babel/preset-env&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">target</span>: &#123;&#125;, <span class="comment">// 适配哪些浏览器,可以写在.browserlistrc</span></span><br><span class="line">        <span class="attr">corejs</span>: <span class="number">3</span>, <span class="comment">// corejs版本</span></span><br><span class="line">        <span class="attr">useBuiltIns</span>: <span class="string">&quot;usage&quot;</span>, <span class="comment">// 按需加载usage,完全加载entry,</span></span><br><span class="line">        <span class="attr">modules</span>: <span class="literal">false</span>, <span class="comment">// 是否将es6转为其他</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="postcss-什么作用"><a href="#postcss-什么作用" class="headerlink" title="postcss 什么作用?"></a>postcss 什么作用?</h2><p>处理 css 兼容性的工具,一般有多种工具,比如<code>autoprefixer</code>处理不同浏览器的前缀.</p>
<h2 id="sass-loader-用了什么方法"><a href="#sass-loader-用了什么方法" class="headerlink" title="sass-loader 用了什么方法"></a>sass-loader 用了什么方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> nodeSass = <span class="built_in">require</span>(<span class="string">&quot;node-sass&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> result = nodeSass.<span class="title function_">renderSync</span>(&#123;</span><br><span class="line">  <span class="attr">file</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&quot;../src/scss/index.scss&quot;</span>),</span><br><span class="line">  <span class="attr">outputStyle</span>: <span class="string">&quot;expanded&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> result.<span class="property">css</span>.<span class="title function_">toString</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到,sass-loader 使用了 node-sass 解析 sass 文件导出为 css 文件.输出为字符串交给下一个 loader.</p>
<h2 id="Esm-是什么"><a href="#Esm-是什么" class="headerlink" title="Esm 是什么?"></a>Esm 是什么?</h2><p>es6 module 是一种模块化开发的规范.设计思想是尽量的静态化,使得编译时就能确定模块的依赖关系和导入导出的变量.<br>主要功能由两个命令构成: <code>export</code>, <code>import</code>.</p>
<ul>
<li>只能作为模块顶层的语句出现</li>
<li>import 的模块名只能是字符串常量</li>
<li>import 之后是不可修改的 例如，在使用 CommonJS 时，必须导入完整的工具 (tool) 或库 (library) 对象，且可带有条件判断来决定是否导入。</li>
</ul>
<h2 id="Umi-了解吗"><a href="#Umi-了解吗" class="headerlink" title="Umi 了解吗"></a>Umi 了解吗</h2><h2 id="Element-ant-之类的是怎么实现响应式布局"><a href="#Element-ant-之类的是怎么实现响应式布局" class="headerlink" title="Element-ant 之类的是怎么实现响应式布局?"></a>Element-ant 之类的是怎么实现响应式布局?</h2><p>参照了 Bootstrap 的 响应式设计，预设了五个响应尺寸：xs、sm、md、lg 和 xl。<br>也就是通过类名.<br>在 less 或者 scss 文件中设置变量.媒体查询通过断点设置 css.</p>
<h1 id="Vue"><a href="#Vue" class="headerlink" title="Vue"></a>Vue</h1><h2 id="Vue-对数组是怎么处理的"><a href="#Vue-对数组是怎么处理的" class="headerlink" title="Vue 对数组是怎么处理的"></a>Vue 对数组是怎么处理的</h2><ol>
<li>先获取原生 Array 的原型方法，因为拦截后还是需要原生的方法帮我们实现数组的变化。</li>
<li>对 Array 的原型方法使用 Object.defineProperty 做一些拦截操作。</li>
<li>把需要被拦截的 Array 类型的数据原型指向改造后原型。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; def &#125; <span class="keyword">from</span> <span class="string">&quot;../util/index&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>; <span class="comment">// 这是个空数组继承了Array的所有方法</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="title class_">Object</span>.<span class="title function_">create</span>(arrayProto); <span class="comment">// 这是个对象继承了所有Array的方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> methodsToPatch = [</span><br><span class="line">  <span class="string">&quot;push&quot;</span>,</span><br><span class="line">  <span class="string">&quot;pop&quot;</span>,</span><br><span class="line">  <span class="string">&quot;shift&quot;</span>,</span><br><span class="line">  <span class="string">&quot;unshift&quot;</span>,</span><br><span class="line">  <span class="string">&quot;splice&quot;</span>,</span><br><span class="line">  <span class="string">&quot;sort&quot;</span>,</span><br><span class="line">  <span class="string">&quot;reverse&quot;</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">methodsToPatch.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">method</span>) &#123;</span><br><span class="line">  <span class="comment">// 缓存原来的方法</span></span><br><span class="line">  <span class="keyword">const</span> original = arrayProto[method]; <span class="comment">// 原来Array 的方法</span></span><br><span class="line">  <span class="title function_">def</span>(arrayMethods, method, <span class="keyword">function</span> <span class="title function_">mutator</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = original.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args); <span class="comment">// 调用还是用原来Array的方法调用</span></span><br><span class="line">    <span class="keyword">const</span> ob = <span class="variable language_">this</span>.<span class="property">__ob__</span>;</span><br><span class="line">    <span class="keyword">let</span> inserted;</span><br><span class="line">    <span class="comment">// 判断传入的方法,进行修改args,push,unshift只接收一种参数,就把args赋值给inserted</span></span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;push&quot;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;unshift&quot;</span>:</span><br><span class="line">        inserted = args;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="comment">// splice是接收3个参数,实际要处理的参数就是第3个往后的</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;splice&quot;</span>:</span><br><span class="line">        inserted = args.<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inserted) ob.<span class="title function_">observeArray</span>(inserted);</span><br><span class="line">    <span class="comment">// notify change</span></span><br><span class="line">    ob.<span class="property">dep</span>.<span class="title function_">notify</span>();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="set-为什么可以检测数组变化"><a href="#set-为什么可以检测数组变化" class="headerlink" title="$set 为什么可以检测数组变化?"></a>$set 为什么可以检测数组变化?</h3><p>如果 target 是一个数组且索引有效，就设置 length 的属性。<br>通过 splice 方法把 value 设置到 target 数组指定位置。<br>设置的时候，vue 会拦截到 target 发生变化，然后把新增的 value 也变成响应式<br>最后返回 value</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">set</span>(<span class="params">target, key, val</span>) &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">// target是传入数组或对象,key是索引,val是修改的值</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(target) &amp;&amp; <span class="title function_">isValidArrayIndex</span>(key)) &#123;</span><br><span class="line">    target.<span class="property">length</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(target.<span class="property">length</span>, key);</span><br><span class="line">    target.<span class="title function_">splice</span>(key, <span class="number">1</span>, val);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">in</span> target &amp;&amp; !(key <span class="keyword">in</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>)) &#123;</span><br><span class="line">    target[key] = val;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="title function_">defineReactive$$1</span>(ob.<span class="property">value</span>, key, val);</span><br><span class="line">  ob.<span class="property">dep</span>.<span class="title function_">notify</span>();</span><br><span class="line">  <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nextTick-的作用和原理"><a href="#nextTick-的作用和原理" class="headerlink" title="$nextTick 的作用和原理"></a>$nextTick 的作用和原理</h2><p>Vue 中 DOM 更新是异步的,批量的.在修改 DOM 后立即获取,是获取不到的,需要等待 dom 更新后才能获取.<br>tis.$nextTick 接收一个函数,函数会在下一次循环 DOM 渲染完毕后执行,在这里也就得到了最新的值.</p>
<h2 id="mutationObserver-了解吗"><a href="#mutationObserver-了解吗" class="headerlink" title="mutationObserver 了解吗"></a>mutationObserver 了解吗</h2><p>属于微任务,观察 dom 元素,并在检测到更改时触发回调.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过new创建实例,接收一个回调</span></span><br><span class="line"><span class="comment">// 回调的两个参数,一个是包含了MutationRecord 的数组,一个是观察者对象本身</span></span><br><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(<span class="function">(<span class="params">mutationRecords, observer</span>) =&gt;</span> &#123;&#125;);</span><br><span class="line"><span class="comment">// target是观察目标,options 监听哪方面的内容</span></span><br><span class="line">observer.<span class="title function_">observe</span>(target, options);</span><br><span class="line"><span class="comment">// 主要是在回调中处理,当观察元素或者子元素变化,就做出相应处理</span></span><br></pre></td></tr></table></figure>

<h2 id="父子组件的生命周期执行顺序"><a href="#父子组件的生命周期执行顺序" class="headerlink" title="父子组件的生命周期执行顺序?"></a>父子组件的生命周期执行顺序?</h2><p>执行顺序：父组件先创建，然后子组件创建；子组件先挂载，然后父组件挂载，<br>否则父组件先挂载就是结束了,子组件没地方挂载了.<br>大体流程: 先父后字,再先子后父.界限在挂载那里改为先子后父,前面的都是先父后子.</p>
<blockquote>
<p>渲染阶段<br>父 beforeCreate-&gt;父 created-&gt;父 beforeMount-&gt;子 beforeCreate-&gt;子 created-&gt;子 beforeMount-&gt;子 mounted-&gt;父 mounted<br>卸载阶段<br>父 beforeDestroy-&gt;子 beforeDestroy-&gt;子 destroyed-&gt;父 destroyed</p>
</blockquote>
<h1 id="Http"><a href="#Http" class="headerlink" title="Http"></a>Http</h1><h2 id="axios-和-fetch-区别"><a href="#axios-和-fetch-区别" class="headerlink" title="axios 和 fetch 区别"></a>axios 和 fetch 区别</h2><ol>
<li>传递数据方式.axios 放在 data 中,fetch 放在 body 中并且是 string 形式.</li>
<li>设置超时.axios 设置 timeout 即可,fetch 需要使用<code>AbortController</code>属性设置.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">&quot;https://jsonplaceholder.typicode.com/todos&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line"><span class="keyword">const</span> signal = controller.<span class="property">signal</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> controller.<span class="title function_">abort</span>(), <span class="number">4000</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">  <span class="attr">signal</span>: signal,</span><br><span class="line">&#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">  .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">message</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>数据转化. 对于返回类型,axios 可以自动转化,默认是 json 类型.fetch 需要清楚后端传过来是什么类型,并手动转化.</li>
<li>拦截器.axios 自带,fetch 需要手动封装.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// axios</span></span><br><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(response.<span class="property">data</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// fetch手动封装</span></span><br><span class="line">fetch = <span class="function">() =&gt;</span> &#123;&#125;;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>并发请求. 都支持.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">all</span>([axios.<span class="title function_">get</span>(<span class="string">&quot;...&quot;</span>), axios.<span class="title function_">get</span>(<span class="string">&quot;...&quot;</span>)]).<span class="title function_">then</span>(</span><br><span class="line">  axios.<span class="title function_">spread</span>(<span class="function">(<span class="params">obj1, obj2</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;)</span><br><span class="line">);</span><br><span class="line"><span class="comment">// fetch</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="title function_">fetch</span>(<span class="string">&quot;...&quot;</span>), <span class="title function_">fetch</span>(<span class="string">&quot;...&quot;</span>)]).<span class="title function_">then</span>(<span class="keyword">async</span> ([res1, res2]) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="keyword">await</span> res1.<span class="title function_">json</span>();</span><br><span class="line">  <span class="keyword">const</span> b = <span class="keyword">await</span> res2.<span class="title function_">json</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>使用 fetch 封装,注意和 axios 的区别,无法捕获非网络异常导致的 error.必须手动 Promise.reject()抛出.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = <span class="string">&quot;https://jsonplaceholder.typicode.com/todos&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fetch</span>(url)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(</span><br><span class="line">        <span class="string">`This is an HTTP error: The status is <span class="subst">$&#123;response.status&#125;</span>`</span></span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> response.<span class="title function_">json</span>();</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="variable language_">console</span>.<span class="property">log</span>)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err.<span class="property">message</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="interceptor-原理"><a href="#interceptor-原理" class="headerlink" title="interceptor 原理"></a>interceptor 原理</h2><p>1、当使用 axios 时，Axios 被实例化，并内部分别实例化 request、response 拦截器<br>2、当使用 use 添加拦截器时，触发 InterceptorManager.prototype.use 方法，将传过来的 resolve、reject 回调，添加在 this.handlers[]中<br>3、使用 axios.get(‘<a target="_blank" rel="noopener" href="https://xxxx/">https://xxxx</a>‘) 时，触发 Axios.prototype.request ，内部触发 InterceptorManager.prototype.forEach<br>3.1 request 拦截器 和 response 拦截器 触发 Axios.prototype.request 内方法不一样 分别是：this.interceptors.request.forEach、this.interceptors.response.forEach 二者主要区别在于想队列 chain[] 中添加的位置不同，request 拦截器从头开始添加 和 response 拦截器从尾开始添加，而 chain[]本身就含有 xhr 的 promise 调用返回<br>3.2 从而实现：先触发 request 拦截器&#x3D;&gt;发请求，请求返回&#x3D;&gt;触发 response 拦截器</p>
<ol start="4">
<li>Axios.prototype.request 最后 return promise，就是我们最后使用的 axios.get(‘’)这个方法的原样，所有 axios.get(‘’).then(res)会再被调用，res 就是请求返回的数据被 response 拦截器处理后的最终结果了</li>
</ol>
<h3 id="fetch-的-interceptor-原理"><a href="#fetch-的-interceptor-原理" class="headerlink" title="fetch 的 interceptor 原理"></a>fetch 的 interceptor 原理</h3><p>拦截器的原理很简单，原生 fetch，接受两个参数，一个是请求路径 resource，resource 可以是 url 也可以是 request 对象，另外一个参数是 config，可以配置 method，header 等请求参数。而拦截器则是通过替换 window.fetch，在其外面再套一层处理起 request 以及 response。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initFetchInterceptor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">fetch</span>: originalFetch &#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">fetch</span> = <span class="keyword">async</span> (...args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [resource, config] = args;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">originalFetch</span>(resource, config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>request 拦截比较简单，就是直接获取 resource 以及 config 进行处理，替换为自己想要的参数再发起请求</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request拦截</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initFetchInterceptor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">fetch</span>: originalFetch &#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">fetch</span> = <span class="keyword">async</span> (...args) =&gt; &#123;</span><br><span class="line">    <span class="comment">// resource =&gt; https://api.github.com?name=meadery</span></span><br><span class="line">    <span class="keyword">const</span> [resource, config] = args;</span><br><span class="line">    <span class="comment">// 把resouce替换</span></span><br><span class="line">    <span class="keyword">const</span> _reource = <span class="string">&quot;https://api.github.com?name=meadery&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">originalFetch</span>(_reource, config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>response 拦截</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> btn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;btn&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initFetchInterceptor</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">fetch</span>: originalFetch &#125; = <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">window</span>.<span class="property">fetch</span> = <span class="keyword">async</span> (...args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> [resource, config] = args;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;resource: &quot;</span>, resource);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;config: &quot;</span>, config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">originalFetch</span>(resource, config);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;response: &quot;</span>, response);</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">json</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">      response</span><br><span class="line">        .<span class="title function_">clone</span>()</span><br><span class="line">        .<span class="title function_">json</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="string">&quot;hello interceptor&quot;</span>);</span><br><span class="line">    response.<span class="property">json</span> = json;</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">initFetchInterceptor</span>();</span><br><span class="line"></span><br><span class="line">btn.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;https://api.github.com&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  response.<span class="title function_">json</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;data: &quot;</span>, data);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;response: &quot;</span>, response);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="CORS-的请求头"><a href="#CORS-的请求头" class="headerlink" title="CORS 的请求头"></a>CORS 的请求头</h2><p>CORS 是跨域资源共享.<br>当浏览器发现域是不同的,会向服务端发送一个 options 请求,检查请求是否允许.<br>前端可以在该方法中添加<code>Access-Control-Request-Methods</code>,表头中提供一些信息,真实请求何时到来,数据类型是什么.<br>服务端响应发回<code>Access-Control-Allow-Origin</code>,返回允许的地址.</p>
<h1 id="ES6"><a href="#ES6" class="headerlink" title="ES6"></a>ES6</h1><h2 id="Map-set-weakMap-weakSet-区别"><a href="#Map-set-weakMap-weakSet-区别" class="headerlink" title="Map,set, weakMap,weakSet 区别?"></a>Map,set, weakMap,weakSet 区别?</h2><p>Set 是类数组的数据结构,内部存储的值并不重复.<br>weakSet 的成员只能是对象类型,而且是弱引用,就是如果没有对象引用内部的对象,那就可能被 GC,所以不能遍历.<br>Map 是键值对的组合,和 Object 的区别是 key 可以是任意类型,而对象只能是 string 和 symbol.<br>weakMap 类似于 Map,不过只接受对象做 key.<br>弱引用是所引用的对象的其他引用被清除,垃圾回收就会自动释放该对象占用的内存.(就是没被人用了,就清除了)</p>
<h2 id="Proxy-和-Reflect"><a href="#Proxy-和-Reflect" class="headerlink" title="Proxy 和 Reflect?"></a>Proxy 和 Reflect?</h2><p>Proxy 和 Reflect 是 ES6 推出的新特性.<br>Prxoy 可以代理对象的属性,内部有陷阱函数可以对代理的对象进行操作.通过 Rflect 可以将代理对象的方法返回.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Tom&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(key,<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, handler)</span><br></pre></td></tr></table></figure>

<p>receiver 表示代理对象或者继承对象</p>
<h2 id="Promise-并发控制"><a href="#Promise-并发控制" class="headerlink" title="Promise 并发控制"></a>Promise 并发控制</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义请求函数</span></span><br><span class="line"><span class="keyword">var</span> <span class="title function_">request</span> = (<span class="params">url</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="string">`任务<span class="subst">$&#123;url&#125;</span>完成`</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;外部逻辑&quot;</span>, res);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 执行任务</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> urls = [</span><br><span class="line">    <span class="string">&quot;bytedance.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tencent.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;alibaba.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;microsoft.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;apple.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hulu.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;amazon.com&quot;</span>,</span><br><span class="line">  ]; <span class="comment">// 请求地址</span></span><br><span class="line">  <span class="keyword">let</span> pool = []; <span class="comment">//并发池</span></span><br><span class="line">  <span class="keyword">let</span> max = <span class="number">3</span>; <span class="comment">//最大并发量</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; urls.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> url = urls[i];</span><br><span class="line">    <span class="keyword">let</span> task = <span class="title function_">request</span>(url);</span><br><span class="line">    task.<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">//每当并发池跑完一个任务,从并发池删除个任务</span></span><br><span class="line">      pool.<span class="title function_">splice</span>(pool.<span class="title function_">indexOf</span>(task), <span class="number">1</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;url&#125;</span> 结束，当前并发数：<span class="subst">$&#123;pool.length&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 异步队列等待这个同步任务把pool塞满</span></span><br><span class="line">    pool.<span class="title function_">push</span>(task);</span><br><span class="line">    <span class="comment">// 当pool满后,停止循环,执行异步队列中的task,继续循环</span></span><br><span class="line">    <span class="keyword">if</span> (pool.<span class="property">length</span> === max) &#123;</span><br><span class="line">      <span class="comment">//利用Promise.race方法来获得并发池中某任务完成的信号</span></span><br><span class="line">      <span class="comment">//跟await结合当有任务完成才让程序继续执行,让循环把并发池塞满</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;停止循环&quot;</span>);</span><br><span class="line">      <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>(pool);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">fn</span>();</span><br></pre></td></tr></table></figure>

<h1 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h1><h2 id="node-写过-cli-吗"><a href="#node-写过-cli-吗" class="headerlink" title="node 写过 cli 吗"></a>node 写过 cli 吗</h2><h1 id="简历项目"><a href="#简历项目" class="headerlink" title="简历项目"></a>简历项目</h1><p>在项目中发现首屏加载时间 xx 秒,有很大优化空间,经过研究采用 xx 方案优化到了 xx 秒.提升了 60%性能.</p>
<p>借鉴 xx 项目中优秀的方案,讲解</p>
<p>竟可能多说解决方案</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/19/%E7%AE%80%E5%8D%95%E5%81%9A%E7%B3%BB%E5%88%97!Docker%E9%83%A8%E7%BD%B2egg.js%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/19/%E7%AE%80%E5%8D%95%E5%81%9A%E7%B3%BB%E5%88%97!Docker%E9%83%A8%E7%BD%B2egg.js%E5%88%B0%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">简单做系列:Docker部署egg.js到云服务器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-19 10:23:44" itemprop="dateCreated datePublished" datetime="2022-11-19T10:23:44+08:00">2022-11-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:18" itemprop="dateModified" datetime="2022-12-08T17:09:18+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>看了好多 Docker 部署的文章,除了列举相同的主要步骤,具体到底怎么部署的,愣是没搞明白.也许到了这个部署 node 的阶段的前端都已经是大神了,不需要讲那么清楚,那我就只好自己摸索记录一下.</p>
<p>也不需要讲什么具体概念,直接就冲方法,先把成就感拿到,回头你再反复咀嚼,看看别人文章里的概念细节,品位品位.</p>
<p>如果讲的不对的地方有大佬指正,将不胜感激.</p>
<h1 id="0-前提"><a href="#0-前提" class="headerlink" title="0. 前提"></a>0. 前提</h1><p>本项目是 egg.js+mongoDB 的 youtubeclone 的后端项目.</p>
<h2 id="修改项目"><a href="#修改项目" class="headerlink" title="修改项目"></a>修改项目</h2><p>在 egg 项目的 package.json 文件中，在 start 启动项中，–daemon 是后台启动。如果使用 docker 容器，需要去除 –daemon .</p>
<h2 id="大体流程"><a href="#大体流程" class="headerlink" title="大体流程"></a>大体流程</h2><h1 id="1-买服务器"><a href="#1-买服务器" class="headerlink" title="1. 买服务器"></a>1. 买服务器</h1><p>首先,你得有个服务器.没有自己想办法白嫖,什么阿里腾讯的学生机,什么 AWS 的一年免费小水管.<br>买了服务器,肯定要装系统,建议就是 Linux 的,什么 CentOS,Debian 之类的.</p>
<h1 id="2-安装-Docker"><a href="#2-安装-Docker" class="headerlink" title="2. 安装 Docker"></a>2. 安装 Docker</h1><p>文章目的就是冲它,肯定要先装它.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line">// 或者</span><br><span class="line">curl -sSL https://get.daocloud.io/docker | sh</span><br></pre></td></tr></table></figure>

<p>测试安装是否成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker -v</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 启动docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line">// 设置开机自启动</span><br><span class="line">sudo systemctl enable docker</span><br></pre></td></tr></table></figure>

<h1 id="3-安装-Docker-compose"><a href="#3-安装-Docker-compose" class="headerlink" title="3. 安装 Docker-compose"></a>3. 安装 Docker-compose</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 国内</span><br><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/v2.12.2/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</span><br><span class="line">// 国外</span><br><span class="line">curl -L &quot;https://github.com/docker/compose/releases/download/2.12.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>添加可执行权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>

<p>查看版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>

<h1 id="4-创建-Dockerfile"><a href="#4-创建-Dockerfile" class="headerlink" title="4. 创建 Dockerfile"></a>4. 创建 Dockerfile</h1><p>通过 Dockfile 创建镜像.之后使用.</p>
<h2 id="自动生成"><a href="#自动生成" class="headerlink" title="自动生成"></a>自动生成</h2><p>安装 vscode 插件,搜索 docker.安装后 F1,输入 docker add.按照提示一步一步生成 Dockerfile.</p>
<h2 id="手动写"><a href="#手动写" class="headerlink" title="手动写"></a>手动写</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用node镜像</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">14.21</span>.<span class="number">0</span>-alpine</span><br><span class="line"><span class="comment"># 在容器中新建目录文件夹 egg</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /egg</span></span><br><span class="line"><span class="comment"># 将 /egg 设置为默认工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /egg</span></span><br><span class="line"><span class="comment"># 环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> NODE_ENV=production</span><br><span class="line"><span class="comment"># 修改时区</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cp</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span></span><br><span class="line"><span class="comment"># 将 package.json 复制默认工作目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package.json /egg/package.json</span></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm config <span class="built_in">set</span> register https://registry.npm.taobao.org</span></span><br><span class="line"><span class="comment"># 只安装dependencies的包</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm --production</span></span><br><span class="line"><span class="comment"># 再copy代码至容器</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ /egg</span></span><br><span class="line"><span class="comment"># 7001端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7001</span></span><br><span class="line"><span class="comment">#等容器启动之后执行脚本</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> npm start</span></span><br></pre></td></tr></table></figure>

<h2 id="新建dockerignore"><a href="#新建dockerignore" class="headerlink" title="新建dockerignore"></a>新建<code>dockerignore</code></h2><p>排除一些不需要打包的文件.</p>
<h1 id="5-上传代码"><a href="#5-上传代码" class="headerlink" title="5. 上传代码"></a>5. 上传代码</h1><p>不管是上传到 github,gitlab,还是 gitee.因为需要在服务器上下载.<br>当然如果想手动上传压缩也行,不过后期要配置自动化 CI&#x2F;CD 的,那样比较麻烦.</p>
<h1 id="6-下载代码到服务器"><a href="#6-下载代码到服务器" class="headerlink" title="6.下载代码到服务器"></a>6.下载代码到服务器</h1><h2 id="安装-git"><a href="#安装-git" class="headerlink" title="安装 git"></a>安装 git</h2><p>记得安装 git,<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhi-leaf/p/10978538.html">不知道服务端怎么安装点这里</a><br>或者搜符合自己服务器版本的.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/xx-coding/youtube-clone-backend</span><br></pre></td></tr></table></figure>

<h1 id="7-构建镜像"><a href="#7-构建镜像" class="headerlink" title="7. 构建镜像"></a>7. 构建镜像</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd youtube-clone-backend</span><br><span class="line">docker build -t youtube-clone-backend .</span><br></pre></td></tr></table></figure>

<h2 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有镜像</span></span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h1 id="8-创建容器"><a href="#8-创建容器" class="headerlink" title="8. 创建容器"></a>8. 创建容器</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --name youtube-clone-container -p 7001:7001 youtube-clone-backend</span><br></pre></td></tr></table></figure>

<h2 id="测试是否连通"><a href="#测试是否连通" class="headerlink" title="测试是否连通"></a>测试是否连通</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:7001</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意服务器的安全组中端口开放.</p>
</blockquote>
<h2 id="查看容器"><a href="#查看容器" class="headerlink" title="查看容器"></a>查看容器</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有容器</span></span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p>此时,还不能启动这个容器,因为我的需要连接数据库.</p>
<h1 id="9-部署-mongoDB"><a href="#9-部署-mongoDB" class="headerlink" title="9. 部署 mongoDB"></a>9. 部署 mongoDB</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取镜像</span></span><br><span class="line">docker pull mongo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建mongo容器</span></span><br><span class="line">docker run -p 27017:27017 -v ~/docker/mongo:/data/db --name docker_mongodb -d mongo</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-v</code>: 将宿主机<code>~/docker/mongo</code> 目录挂载到容器中的 <code>/data/db</code> 中，此目录为 MongoDB 数据存储位置.</li>
<li><code>-d</code>：设置容器以守护进程方式运行</li>
<li><code>-p</code>：宿主机 27017 端口映射到容器 27017 端口</li>
</ul>
<h2 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h2><p>不创建好像连接后访问不了.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入mongoDb容器</span></span><br><span class="line">docker exec -it docker_mongodb mongosh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入mongoDb</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use admin</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建用户名为admin, 密码为admin, 角色为root的用户;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.createUser(&#123;user:<span class="string">&quot;admin&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;admin&quot;</span>,roles:[&#123;role:<span class="string">&quot;root&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125;]&#125;);</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">出现创建成功提示就对了，退出管理员</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&gt; <span class="built_in">exit</span>;</span></span><br></pre></td></tr></table></figure>

<p>用管理员账户创建普通用户管理你的数据库.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用刚创建的管理用户登录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mongo --port 27017 -u admin -p admin --authenticationDatabase admin</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再创建一个普通用户</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">use youtube-clone</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">普通用户账户: staff, 密码: staff, 有读写权限;</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">db.createUser(&#123;user:<span class="string">&quot;staff&quot;</span>,<span class="built_in">pwd</span>:<span class="string">&quot;staff&quot;</span>,roles:[&#123;role:<span class="string">&quot;readWrite&quot;</span>,db:<span class="string">&quot;youtube-clone&quot;</span>&#125;]&#125;);</span></span><br></pre></td></tr></table></figure>

<h1 id="10-将数据库容器与后端容器关联"><a href="#10-将数据库容器与后端容器关联" class="headerlink" title="10. 将数据库容器与后端容器关联"></a>10. 将数据库容器与后端容器关联</h1><h2 id="修改后端项目中-MongoDB-的配置"><a href="#修改后端项目中-MongoDB-的配置" class="headerlink" title="修改后端项目中 MongoDB 的配置"></a>修改后端项目中 MongoDB 的配置</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.default.js</span></span><br><span class="line"><span class="comment">// 注意xxxxx是你的服务器IP名称,如果不想暴露可以写成环境变量</span></span><br><span class="line"><span class="attr">url</span>: <span class="string">&#x27;mongodb://staff:staff@xxxxxxx:27017/youtube-clone?authSource=staff&#x27;</span>,</span><br></pre></td></tr></table></figure>

<h2 id="创建自定义网络"><a href="#创建自定义网络" class="headerlink" title="创建自定义网络"></a>创建自定义网络</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create youtube-net</span><br></pre></td></tr></table></figure>

<h2 id="将容器连接进网络"><a href="#将容器连接进网络" class="headerlink" title="将容器连接进网络"></a>将容器连接进网络</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端容器连接网络</span></span><br><span class="line">docker network connect youtube-net youtube-clone-container</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">MongoDB连接网络</span></span><br><span class="line">docker network connect youtube-net docker_mongodb</span><br></pre></td></tr></table></figure>

<p>两个都连接到自定义网络就可以通信了.<br>至此.就应该可以通过 ip+端口号进行后端的接口访问了.</p>
<h1 id="查看问题"><a href="#查看问题" class="headerlink" title="查看问题"></a>查看问题</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看执行日志</span></span><br><span class="line">docker logs -f containerID</span><br></pre></td></tr></table></figure>

<h1 id="更简单的方法-docker-compose"><a href="#更简单的方法-docker-compose" class="headerlink" title="更简单的方法 docker-compose"></a>更简单的方法 docker-compose</h1><p>其实就是把上面的指令写到文件中执行</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/18/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/18/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">性能优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-18 14:11:17" itemprop="dateCreated datePublished" datetime="2022-11-18T14:11:17+08:00">2022-11-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:18" itemprop="dateModified" datetime="2022-12-08T17:09:18+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>这是一个比较大的话题.包含了很多部分.总体来讲就是尽量快的加载页面,使用资源又尽量少.</p>
<h1 id="从输入网址到页面渲染-发生了啥"><a href="#从输入网址到页面渲染-发生了啥" class="headerlink" title="从输入网址到页面渲染,发生了啥"></a>从输入网址到页面渲染,发生了啥</h1><p>这道面试题就比较宽范的触及到性能优化的各个点.需要比较系统的去理解.</p>
<h1 id="阻塞渲染"><a href="#阻塞渲染" class="headerlink" title="阻塞渲染"></a>阻塞渲染</h1><p>想要首屏优化,就得先把页面渲染出来,什么会阻塞渲染呢?<br>HTML 和 CSS 会,因为他们要合成渲染树.所以就要降低要渲染的文件大小,扁平层级,优化选择器.<br>还有一个问题,<code>script</code>会暂停 DOM 渲染.所以一般<code>script</code>会放在 body 后面.<br>不想放底部就可以使用<code>defer</code>和<code>async</code>属性.两个都是异步下载,和 dom 并行.区别就是执行了.<br>下载是没区别的.<br><code>defer</code>:要等到 DOM 执行完,再按照顺序执行.<br><code>async</code>: 下载完就执行,不按顺序,谁先完事谁先跑.</p>
<h2 id="为什么操作-DOM-慢"><a href="#为什么操作-DOM-慢" class="headerlink" title="为什么操作 DOM 慢"></a>为什么操作 DOM 慢</h2><p>dom 属于渲染引擎,js 属于 js 引擎,通过 js 操作 dom 就涉及到两个线程之间的通信,就会带来性能损耗.还有可能带来回流重绘的情况,导致性能问题.</p>
<h2 id="插入几万个-DOM-如何实现页面不卡顿"><a href="#插入几万个-DOM-如何实现页面不卡顿" class="headerlink" title="插入几万个 DOM,如何实现页面不卡顿"></a>插入几万个 DOM,如何实现页面不卡顿</h2><p>肯定不能一次性加载,需要分批次加载.<br>方法一: 通过<code>requestAnimationFrame</code>的方式循环插入 DOM.<br>方法二: 虚拟滚动.只渲染可视区域的内容.当用户滚动,实时替换渲染的内容.避免空白记得加上预渲染.</p>
<h1 id="HTML-优化"><a href="#HTML-优化" class="headerlink" title="HTML 优化"></a>HTML 优化</h1><p>就是在不考虑,网络和缓存的情况下,如何加快渲染?</p>
<ul>
<li>从文件大小考虑</li>
<li>从 script 标签使用上来考虑</li>
<li>从 CSS、HTML 的代码书写上来考虑</li>
<li>从需要下载的内容是否需要在首屏使用上来考虑</li>
</ul>
<h1 id="JS-性能优化"><a href="#JS-性能优化" class="headerlink" title="JS 性能优化"></a>JS 性能优化</h1><h1 id="CSS-性能优化"><a href="#CSS-性能优化" class="headerlink" title="CSS 性能优化"></a>CSS 性能优化</h1><p>问题: css 层级设置过多导致性能减弱</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">div</span>&gt;</span><br><span class="line">  &lt;<span class="selector-tag">a</span>&gt; &lt;<span class="selector-tag">span</span>&gt;&lt;/<span class="selector-tag">span</span>&gt; &lt;/<span class="selector-tag">a</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">  <span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-tag">div</span> &gt; <span class="selector-tag">a</span> &gt; <span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>明显第一种要比第二种效率高得多.减少了因查找递归的过程带来的性能损失.<br>防范: 尽量避免写过于具体的 CSS 选择器,对 HTML 尽量减少无意义的标签.</p>
<h2 id="回流-reflow-和重绘-repaint"><a href="#回流-reflow-和重绘-repaint" class="headerlink" title="回流(reflow)和重绘(repaint)"></a>回流(reflow)和重绘(repaint)</h2><ul>
<li>回流: 回的是文档流,都要快加载好了,又倒回去了.就是回流.布局或者几何属性发生的变化.</li>
<li>重绘: 重新绘画,就是上色.就是外观发生的变化.</li>
<li>回流肯定重绘,重绘不一定回流.</li>
</ul>
<p>1、添加、删除元素(回流+重绘)<br>2、隐藏元素，display:none(回流+重绘)，visibility:hidden(只重绘，不回流)<br>3、移动元素，如改变 top、left 或移动元素到另外 1 个父元素中(重绘+回流)<br>4、改变浏览器大小(回流+重绘)<br>5、改变浏览器的字体大小(回流+重绘)<br>6、改变元素的 padding、border、margin(回流+重绘)<br>7、改变浏览器的字体颜色（只重绘，不回流）<br>8、改变元素的背景颜色（只重绘，不回流）</p>
<h3 id="减少"><a href="#减少" class="headerlink" title="减少"></a>减少</h3><ul>
<li>CSS 选择符从右往左匹配查找，避免节点层级过多</li>
<li>不要使用 table 布局</li>
<li>不要把节点的属性值放在一个循环里当成循环里的变量</li>
<li>使用 <code>visibility</code> 替换 <code>display: none</code></li>
</ul>
<h1 id="网络性能优化"><a href="#网络性能优化" class="headerlink" title="网络性能优化"></a>网络性能优化</h1><h1 id="框架性能优化"><a href="#框架性能优化" class="headerlink" title="框架性能优化"></a>框架性能优化</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/10/mongoose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/10/mongoose/" class="post-title-link" itemprop="url">mongoose</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-10 20:20:41" itemprop="dateCreated datePublished" datetime="2022-11-10T20:20:41+08:00">2022-11-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:18" itemprop="dateModified" datetime="2022-12-08T17:09:18+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="连接-mongo"><a href="#连接-mongo" class="headerlink" title="连接 mongo"></a>连接 mongo</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @ use 数据库连接</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&quot;mongoose&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">&quot;../../config/common&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dbConfig = config[process.<span class="property">env</span>.<span class="property">NODE_ENV</span> || <span class="string">&quot;development&quot;</span>];</span><br><span class="line"></span><br><span class="line">mongoose.<span class="title function_">connect</span>(dbConfig.<span class="property">mongo</span>.<span class="property">url</span>, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">mongoose.<span class="title function_">set</span>(<span class="string">&quot;useCreateIndex&quot;</span>, <span class="literal">true</span>); <span class="comment">//加上这个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接成功</span></span><br><span class="line">mongoose.<span class="property">connection</span>.<span class="title function_">on</span>(<span class="string">&quot;connected&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">//console.log(&#x27;连接成功 &#x27; + dbConfig.mongo.url);</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接失败</span></span><br><span class="line">mongoose.<span class="property">connection</span>.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接失败 &quot;</span> + err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 断开连接</span></span><br><span class="line">mongoose.<span class="property">connection</span>.<span class="title function_">on</span>(<span class="string">&quot;disconnected&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;断开连接&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="定义-Schema"><a href="#定义-Schema" class="headerlink" title="定义 Schema"></a>定义 Schema</h3><h4 id="Schema-Type"><a href="#Schema-Type" class="headerlink" title="#Schema.Type"></a><a target="_blank" rel="noopener" href="http://file.jing999.cn/workspace/Server/sql/mongoose.html#schema-type">#</a>Schema.Type</h4><ul>
<li>String</li>
<li>Number</li>
<li>Date</li>
<li>Buffer</li>
<li>Boolean</li>
<li>Mixed</li>
<li>Objectid</li>
<li>Array</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Schema</span>   = mongoose.<span class="property">Schema</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">UserSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">    name  : &#123; <span class="attr">type</span>: <span class="title class_">String</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    posts : [&#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;Post&#x27;</span> &#125;]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">User</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;User&#x27;</span>, <span class="title class_">UserSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">PostSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">    poster   : &#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;User&#x27;</span> &#125;,</span><br><span class="line">    comments : [&#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;Comment&#x27;</span> &#125;],</span><br><span class="line">    title    : <span class="title class_">String</span>,</span><br><span class="line">    content  : <span class="title class_">String</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Post</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Post&#x27;</span>, <span class="title class_">PostSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">CommentSchema</span> = <span class="keyword">new</span> <span class="title class_">Schema</span>(&#123;</span><br><span class="line">    post      : &#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&quot;Post&quot;</span> &#125;,</span><br><span class="line">    commenter : &#123; <span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;User&#x27;</span> &#125;,</span><br><span class="line">    content   : &#123;</span><br><span class="line">        <span class="attr">main</span>: <span class="title class_">String</span>,</span><br><span class="line">        <span class="attr">label</span>: <span class="title class_">String</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">points</span>: [</span><br><span class="line">        <span class="attr">point</span>: [&#123;<span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;Point&#x27;</span>&#125;]</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Comment</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Comment&#x27;</span>, <span class="title class_">CommentSchema</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">PointSchema</span> = <span class="keyword">new</span> mongoose.<span class="title class_">Schema</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">parent</span>: &#123;<span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;point&#x27;</span>&#125;,</span><br><span class="line">  <span class="attr">children</span>: [&#123;<span class="attr">type</span>: <span class="title class_">Schema</span>.<span class="property">Types</span>.<span class="property">ObjectId</span>, <span class="attr">ref</span>: <span class="string">&#x27;point&#x27;</span>&#125;]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Point</span> = mongoose.<span class="title function_">model</span>(<span class="string">&#x27;Point&#x27;</span>, <span class="title class_">PointSchema</span>);</span><br></pre></td></tr></table></figure>

<h1 id="查询条件"><a href="#查询条件" class="headerlink" title="查询条件"></a>查询条件</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$or　　　　或关系</span><br><span class="line">$nor　　　 或关系取反</span><br><span class="line">$gt　　　　大于</span><br><span class="line">$gte　　　 大于等于</span><br><span class="line">$lt　　　　 小于</span><br><span class="line">$lte　　　  小于等于</span><br><span class="line">$ne            不等于</span><br><span class="line">$in             在多个值范围内</span><br><span class="line">$nin           不在多个值范围内</span><br><span class="line">$all            匹配数组中多个值</span><br><span class="line">$regex　　正则，用于模糊查询</span><br><span class="line">$size　　　匹配数组大小</span><br><span class="line">$maxDistance　　范围查询，距离（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$mod　　   取模运算</span><br><span class="line">$near　　　邻域查询，查询附近的位置（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$exists　　  字段是否存在</span><br><span class="line">$elemMatch　　匹配内数组内的元素</span><br><span class="line">$within　　范围查询（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$box　　　 范围查询，矩形范围（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$center       范围醒询，圆形范围（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$centerSphere　　范围查询，球形范围（基于<span class="variable constant_">LBS</span>）</span><br><span class="line">$slice　　　　查询字段集合中的元素（比如从第几个之后，第N到第M个元素）</span><br></pre></td></tr></table></figure>

<h3 id="mongodb-对数组中的所有元素进行一次性修改方法"><a href="#mongodb-对数组中的所有元素进行一次性修改方法" class="headerlink" title="mongodb 对数组中的所有元素进行一次性修改方法"></a>mongodb 对数组中的所有元素进行一次性修改方法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="attr">list</span>: [&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">        <span class="attr">date</span>: <span class="number">1504195200000</span>,</span><br><span class="line">        <span class="attr">other</span>: <span class="string">&quot;c&quot;</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&quot;b&quot;</span>,</span><br><span class="line">        <span class="attr">date</span>: <span class="number">1504195200000</span>,</span><br><span class="line">        <span class="attr">other</span>: <span class="string">&quot;c&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 现在要把other全部更新为&quot;a&quot;,方法如下</span></span><br><span class="line">db.<span class="title function_">getCollection</span>(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">  .<span class="title function_">update</span>(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="number">4</span>&#125;, &#123;<span class="attr">$set</span>: &#123;<span class="string">&#x27;list.$[].other&#x27;</span>: <span class="string">&#x27;a&#x27;</span>&#125;&#125;, &#123;<span class="attr">multi</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/Egg.js/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/Egg.js/" class="post-title-link" itemprop="url">Egg.js</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:08:35" itemprop="dateCreated datePublished" datetime="2022-11-08T17:08:35+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:19" itemprop="dateModified" datetime="2022-12-08T17:09:19+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">核心思想: 约定大于配置</div>

<h1 id="基础用法"><a href="#基础用法" class="headerlink" title="基础用法"></a>基础用法</h1><p>建议直接去这里: <a target="_blank" rel="noopener" href="https://www.eggjs.org/zh-CN/intro/quickstart">官方快速入门</a></p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">egg-project</span><br><span class="line">├── package.json</span><br><span class="line">├── app.js (可选)</span><br><span class="line">├── agent.js (可选)</span><br><span class="line">├── app</span><br><span class="line">|   ├── router.js</span><br><span class="line">│   ├── controller</span><br><span class="line">│   |   └── home.js</span><br><span class="line">│   ├── service (可选)</span><br><span class="line">│   |   └── user.js</span><br><span class="line">│   ├── middleware (可选)</span><br><span class="line">│   |   └── response_time.js</span><br><span class="line">│   ├── schedule (可选)</span><br><span class="line">│   |   └── my_task.js</span><br><span class="line">│   ├── public (可选)</span><br><span class="line">│   |   └── reset.css</span><br><span class="line">│   ├── view (可选)</span><br><span class="line">│   |   └── home.tpl</span><br><span class="line">│   └── extend (可选)</span><br><span class="line">│       ├── helper.js (可选)</span><br><span class="line">│       ├── request.js (可选)</span><br><span class="line">│       ├── response.js (可选)</span><br><span class="line">│       ├── context.js (可选)</span><br><span class="line">│       ├── application.js (可选)</span><br><span class="line">│       └── agent.js (可选)</span><br><span class="line">├── config</span><br><span class="line">|   ├── plugin.js</span><br><span class="line">|   ├── config.default.js</span><br><span class="line">│   ├── config.prod.js</span><br><span class="line">|   ├── config.test.js (可选)</span><br><span class="line">|   ├── config.local.js (可选)</span><br><span class="line">|   └── config.unittest.js (可选)</span><br><span class="line">└── <span class="built_in">test</span></span><br><span class="line">    ├── middleware</span><br><span class="line">    |   └── response_time.test.js</span><br><span class="line">    └── controller</span><br><span class="line">        └── home.test.js</span><br></pre></td></tr></table></figure>

<h1 id="初始化脚本"><a href="#初始化脚本" class="headerlink" title="初始化脚本"></a>初始化脚本</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm create egg --type=simple -r=https://registry.npmmirror.com/</span><br></pre></td></tr></table></figure>

<h1 id="模块设计"><a href="#模块设计" class="headerlink" title="模块设计"></a>模块设计</h1><p>model 层: 放置一些要往数据库中存储的数据类型的模型.主要是<code>Schema</code>的实例.<br>service 层: 对 model 层中对应数据库的数据的操作,增删改查之类.<br>controller 层: 设计的业务逻辑,通过调用 service 的一些方法实现,返回给前端.<br>middleware: 在多处使用的方法可以抽离出,比如<code>auth</code>,<code>error</code>等模块.<br>config: 配置基础参数.<br>extend: 扩展方法,主要是一些和业务逻辑关联性不大的方法.比如<code>md5</code>加密.<br>schedule: 定时任务.</p>
<h1 id="内置基础对象"><a href="#内置基础对象" class="headerlink" title="内置基础对象"></a>内置基础对象</h1><p>Application,Context,Request,Response,Controller,Service,Helper,Config,Logger,Subscription.<br>其中前 4 个是从 Koa 继承而来.其他是框架自身的.</p>
<h1 id="Application"><a href="#Application" class="headerlink" title="Application"></a>Application</h1><p>Application 是全局应用对象。在一个应用中，每个进程只会实例化一个 Application 实例。在它上面我们可以挂载一些全局的方法和对象。</p>
<h1 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h1><p>框架提供了一个 Controller 基类，并推荐所有的 Controller 都继承于该基类实现。这个 Controller 基类有下列属性：</p>
<ul>
<li><code>ctx</code> - 当前请求的 Context 实例。</li>
<li><code>app</code> - 应用的 Application 实例。</li>
<li><code>config</code> - 应用的配置。</li>
<li><code>service</code> - 应用所有的 service。</li>
<li><code>logger</code> - 为当前 controller 封装的 logger 对象。</li>
</ul>
<h1 id="路由相关"><a href="#路由相关" class="headerlink" title="路由相关"></a>路由相关</h1><h2 id="1-get-传值"><a href="#1-get-传值" class="headerlink" title="1. get 传值"></a>1. get 传值</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router.js</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/admin/:id&#x27;</span>, controller.<span class="property">admin</span>.<span class="property">index</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// controller</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取路由get传值参数（路由:id）</span></span><br><span class="line">    ctx.<span class="property">params</span>;</span><br><span class="line">    <span class="comment">// 获取url的问号get传值参数</span></span><br><span class="line">    ctx.<span class="property">query</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-种配置方法"><a href="#2-4-种配置方法" class="headerlink" title="2. 4 种配置方法"></a>2. 4 种配置方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;path-match&#x27;</span>, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;router-name&#x27;</span>, <span class="string">&#x27;path-match&#x27;</span>, app.<span class="property">controller</span>.<span class="property">action</span>);<span class="comment">// 第一个参数可以给name</span></span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;path-match&#x27;</span>, middleware1, ..., middlewareN, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br><span class="line">router.<span class="title function_">verb</span>(<span class="string">&#x27;router-name&#x27;</span>, <span class="string">&#x27;path-match&#x27;</span>, middleware1, ..., middlewareN, app.<span class="property">controller</span>.<span class="property">action</span>);</span><br></pre></td></tr></table></figure>

<h1 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h1><h2 id="1-ctx"><a href="#1-ctx" class="headerlink" title="1. ctx"></a>1. ctx</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">status</span> = <span class="number">301</span>; <span class="comment">// 把重定向改为301</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">redirect</span>(<span class="string">&#x27;/admin/add&#x27;</span>); <span class="comment">// 默认临时重定向 302</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-路由重定向"><a href="#2-路由重定向" class="headerlink" title="2. 路由重定向"></a>2. 路由重定向</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="property">router</span>.<span class="title function_">redirect</span>(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;/home/index&quot;</span>, <span class="number">302</span>);</span><br></pre></td></tr></table></figure>

<h2 id="3-路由分组"><a href="#3-路由分组" class="headerlink" title="3.路由分组"></a>3.路由分组</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./router/news&quot;</span>)(app);</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;./router/admin&quot;</span>)(app);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/news.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/news/list&quot;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">list</span>);</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/news/detail&quot;</span>, app.<span class="property">controller</span>.<span class="property">news</span>.<span class="property">detail</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/router/admin.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/admin/user&quot;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">user</span>);</span><br><span class="line">  app.<span class="property">router</span>.<span class="title function_">get</span>(<span class="string">&quot;/admin/log&quot;</span>, app.<span class="property">controller</span>.<span class="property">admin</span>.<span class="property">log</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h1><h2 id="自定义-Controller-基类"><a href="#自定义-Controller-基类" class="headerlink" title="自定义 Controller 基类"></a>自定义 Controller 基类</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/core/base_controller.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Controller</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">user</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">session</span>.<span class="property">user</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">success</span>(<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">      data,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">notFound</span>(<span class="params">msg</span>) &#123;</span><br><span class="line">    msg = msg || <span class="string">&quot;not found&quot;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="keyword">throw</span>(<span class="number">404</span>, msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">BaseController</span>;</span><br></pre></td></tr></table></figure>

<p>此时在编写应用的 Controller 时，可以继承 BaseController，直接使用基类上的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app/controller/post.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Controller</span> = <span class="built_in">require</span>(<span class="string">&quot;../core/base_controller&quot;</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PostController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> posts = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">service</span>.<span class="title function_">listByUser</span>(<span class="variable language_">this</span>.<span class="property">user</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">success</span>(posts);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h1><h2 id="1-安装和使用-ejs"><a href="#1-安装和使用-ejs" class="headerlink" title="1. 安装和使用 ejs"></a>1. 安装和使用 ejs</h2><h3 id="（1）安装："><a href="#（1）安装：" class="headerlink" title="（1）安装："></a>（1）安装：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i egg-view-ejs --save</span><br></pre></td></tr></table></figure>

<h3 id="（2）配置：-x2F-config"><a href="#（2）配置：-x2F-config" class="headerlink" title="（2）配置：&#x2F;config"></a>（2）配置：&#x2F;config</h3><p>config&#x2F;config.default.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">appInfo</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    config.<span class="property">view</span> = &#123;</span><br><span class="line">        <span class="attr">mapping</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;.html&#x27;</span>: <span class="string">&#x27;ejs&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>config&#x2F;plugin.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 配置ejs</span></span><br><span class="line">  <span class="attr">ejs</span>: &#123;</span><br><span class="line">    <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">package</span>: <span class="string">&quot;egg-view-ejs&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="（3）使用"><a href="#（3）使用" class="headerlink" title="（3）使用"></a>（3）使用</h3><p>app&#x2F;controller</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">// 渲染变量</span></span><br><span class="line">    <span class="keyword">let</span> msg = <span class="string">&quot;测试内容&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>];</span><br><span class="line">    <span class="comment">// 渲染模板（render需要加await）</span></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123;</span><br><span class="line">        msg,</span><br><span class="line">        list</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app&#x2F;view&#x2F;index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;ie=edge&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--渲染变量--&gt;</span></span><br><span class="line">    &lt;%=msg%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      &lt;% for(var i=0; i &lt; list.length; i++)&#123; %&gt;</span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span>&lt;%=list[i]%&gt;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      &lt;% &#125; %&gt;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--加载 app/public 下的资源文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/public/images/find.png&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="模型和数据库"><a href="#模型和数据库" class="headerlink" title="模型和数据库"></a>模型和数据库</h1><h2 id="配置和创建迁移文件"><a href="#配置和创建迁移文件" class="headerlink" title="配置和创建迁移文件"></a>配置和创建迁移文件</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p><strong>文档地址：</strong><a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/blob/v5/migrations.md"><strong>https://github.com/demopark/sequelize-docs-Zh-CN/blob/v5/migrations.md</strong></a></p>
<ol>
<li>安装并配置<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg-sequelize">egg-sequelize</a>插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和<a target="_blank" rel="noopener" href="https://github.com/sidorares/node-mysql2">mysql2</a>模块：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在<code>config/plugin.js</code>中引入 egg-sequelize 插件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exports.sequelize = &#123;</span><br><span class="line">  enable: true,</span><br><span class="line">  package: &#x27;egg-sequelize&#x27;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在<code>config/config.default.js</code></li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">config.<span class="property">sequelize</span> = &#123;</span><br><span class="line">  <span class="attr">dialect</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">  <span class="attr">username</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">password</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">3306</span>,</span><br><span class="line">  <span class="attr">database</span>: <span class="string">&quot;friends&quot;</span>,</span><br><span class="line">  <span class="comment">// 中国时区</span></span><br><span class="line">  <span class="attr">timezone</span>: <span class="string">&quot;+08:00&quot;</span>,</span><br><span class="line">  <span class="attr">define</span>: &#123;</span><br><span class="line">    <span class="comment">// 取消数据表名复数</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 自动写入时间戳 created_at updated_at</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 字段生成软删除时间戳 deleted_at</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">createdAt</span>: <span class="string">&quot;created_at&quot;</span>,</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;updated_at&quot;</span>,</span><br><span class="line">    <span class="attr">deletedAt</span>: <span class="string">&quot;deleted_at&quot;</span>,</span><br><span class="line">    <span class="comment">// 所有驼峰命名格式化</span></span><br><span class="line">    <span class="attr">underscored</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>sequelize 提供了<a target="_blank" rel="noopener" href="https://github.com/sequelize/cli">sequelize-cli</a>工具来实现<a target="_blank" rel="noopener" href="http://docs.sequelizejs.com/manual/tutorial/migrations.html">Migrations</a>，我们也可以在 egg 项目中引入 sequelize-cli。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev sequelize-cli</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在<code>database</code>目录下，所以我们在项目根目录下新建一个<code>.sequelizerc</code>配置文件：</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">config</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/config.json&quot;</span>),</span><br><span class="line">  <span class="string">&quot;migrations-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/migrations&quot;</span>),</span><br><span class="line">  <span class="string">&quot;seeders-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;database/seeders&quot;</span>),</span><br><span class="line">  <span class="string">&quot;models-path&quot;</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;app/model&quot;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>初始化 Migrations 配置文件和目录</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">init</span>:config</span><br><span class="line">npx sequelize <span class="attr">init</span>:migrations</span><br><span class="line"><span class="comment">// npx sequelize init:models</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>行完后会生成<code>database/config.json</code>文件和<code>database/migrations</code>目录，我们修改一下<code>database/config.json</code>中的内容，将其改成我们项目中使用的数据库配置：</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;development&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;root&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dialect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mysql&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timezone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;+08:00&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ol start="8">
<li>创建数据库</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">db</span>:create</span><br></pre></td></tr></table></figure>

<h3 id="创建数据迁移表"><a href="#创建数据迁移表" class="headerlink" title="创建数据迁移表"></a>创建数据迁移表</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize <span class="attr">migration</span>:generate --name=init-users</span><br></pre></td></tr></table></figure>

<p>1.执行完命令后，会在 database &#x2F; migrations &#x2F; 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="keyword">async</span> (queryInterface, <span class="title class_">Sequelize</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="variable constant_">INTEGER</span>, <span class="variable constant_">STRING</span>, <span class="variable constant_">DATE</span>, <span class="variable constant_">ENUM</span> &#125; = <span class="title class_">Sequelize</span>;</span><br><span class="line">    <span class="comment">// 创建表</span></span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">createTable</span>(</span><br><span class="line">      <span class="string">&quot;users&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">INTEGER</span>(<span class="number">20</span>).<span class="property">UNSIGNED</span>,</span><br><span class="line">          <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">username</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户名称&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">email</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">160</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户邮箱&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">avatar_url</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">mobile</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">20</span>),</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户手机&quot;</span>,</span><br><span class="line">          <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">prifix</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">32</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">abstract</span>: &#123; <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">255</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">role_id</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">          <span class="comment">//  定义外键（重要）</span></span><br><span class="line">          <span class="attr">references</span>: &#123;</span><br><span class="line">            <span class="attr">model</span>: <span class="string">&quot;users&quot;</span>, <span class="comment">// 对应表名称（数据表名称）</span></span><br><span class="line">            <span class="attr">key</span>: <span class="string">&quot;id&quot;</span>, <span class="comment">// 对应表的主键</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">onUpdate</span>: <span class="string">&quot;restrict&quot;</span>, <span class="comment">// 更新时操作</span></span><br><span class="line">          <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>, <span class="comment">// 删除时操作</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">gender</span>: &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="variable constant_">ENUM</span>,</span><br><span class="line">          <span class="attr">values</span>: [<span class="string">&quot;男&quot;</span>, <span class="string">&quot;女&quot;</span>, <span class="string">&quot;保密&quot;</span>],</span><br><span class="line">          <span class="attr">allowNull</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">defaultValue</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">          <span class="attr">comment</span>: <span class="string">&quot;用户性别&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">        <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; <span class="attr">engine</span>: <span class="string">&quot;MYISAM&quot;</span> &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// 添加索引</span></span><br><span class="line">    queryInterface.<span class="title function_">addIndex</span>(<span class="string">&quot;users&quot;</span>, [<span class="string">&quot;gender&quot;</span>]);</span><br><span class="line">    <span class="comment">// 添加唯一索引</span></span><br><span class="line">    queryInterface.<span class="title function_">addIndex</span>(<span class="string">&quot;users&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;name&quot;</span>, <span class="comment">// 索引名称</span></span><br><span class="line">      <span class="attr">unique</span>: <span class="literal">true</span>, <span class="comment">// 唯一索引</span></span><br><span class="line">      <span class="attr">fields</span>: [<span class="string">&quot;name&quot;</span>], <span class="comment">// 索引对应字段</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="keyword">async</span> (queryInterface) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.<span class="title function_">dropTable</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>执行 migrate 进行数据库变更</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级数据库</span></span><br><span class="line">npx sequelize db:migrate</span><br><span class="line"><span class="comment"># 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo</span></span><br><span class="line"><span class="comment"># 可以通过 `db:migrate:undo:all` 回退到初始状态</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo:all</span></span><br></pre></td></tr></table></figure>

<h3 id="已创建新增字段"><a href="#已创建新增字段" class="headerlink" title="已创建新增字段"></a>已创建新增字段</h3><p>1.创建迁移文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=user-addcolumn</span><br></pre></td></tr></table></figure>

<p>2.执行完命令后，会在 database &#x2F; migrations &#x2F; 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="property">sequelize</span>.<span class="title function_">transaction</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">        queryInterface.<span class="title function_">addColumn</span>(</span><br><span class="line">          <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="string">&quot;role_id&quot;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="property">INTEGER</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">transaction</span>: t &#125;</span><br><span class="line">        ),</span><br><span class="line">        queryInterface.<span class="title function_">addColumn</span>(</span><br><span class="line">          <span class="string">&quot;user&quot;</span>,</span><br><span class="line">          <span class="string">&quot;ceshi&quot;</span>,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">transaction</span>: t &#125;</span><br><span class="line">        ),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="property">sequelize</span>.<span class="title function_">transaction</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">        queryInterface.<span class="title function_">removeColumn</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;role_id&quot;</span>, &#123; <span class="attr">transaction</span>: t &#125;),</span><br><span class="line">        queryInterface.<span class="title function_">removeColumn</span>(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;ceshi&quot;</span>, &#123; <span class="attr">transaction</span>: t &#125;),</span><br><span class="line">      ]);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>3.执行 migrate 进行数据库变更</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:migrate</span><br></pre></td></tr></table></figure>

<h3 id="创建模型"><a href="#创建模型" class="headerlink" title="创建模型"></a>创建模型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app / model / user.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line">  <span class="comment">// 配置（重要：一定要配置详细，一定要！！！）</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">    <span class="string">&quot;user&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">      <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">      <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">timestamps</span>: <span class="literal">true</span>, <span class="comment">// 是否自动写入时间戳</span></span><br><span class="line">      <span class="attr">tableName</span>: <span class="string">&quot;users&quot;</span>, <span class="comment">// 自定义数据表名称</span></span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个 Model 就可以在 Controller 和 Service 中通过 <code>app.model.User</code> 或者 <code>ctx.model.User</code> 访问到了，例如我们编写 <code>app/controller/users.js</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/users.js</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Controller</span> = <span class="built_in">require</span>(<span class="string">&quot;egg&quot;</span>).<span class="property">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toInt</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> str === <span class="string">&quot;number&quot;</span>) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">if</span> (!str) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">parseInt</span>(str, <span class="number">10</span>) || <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Controller</span> &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> query = &#123;</span><br><span class="line">      <span class="attr">limit</span>: <span class="title function_">toInt</span>(ctx.<span class="property">query</span>.<span class="property">limit</span>),</span><br><span class="line">      <span class="attr">offset</span>: <span class="title function_">toInt</span>(ctx.<span class="property">query</span>.<span class="property">offset</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findAll</span>(query);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123; name, age &#125;);</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">201</span>;</span><br><span class="line">    ctx.<span class="property">body</span> = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">update</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.<span class="property">request</span>.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">update</span>(&#123; name, age &#125;);</span><br><span class="line">    ctx.<span class="property">body</span> = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="variable language_">this</span>.<span class="property">ctx</span>;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">toInt</span>(ctx.<span class="property">params</span>.<span class="property">id</span>);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> user.<span class="title function_">destroy</span>();</span><br><span class="line">    ctx.<span class="property">status</span> = <span class="number">200</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">UserController</span>;</span><br></pre></td></tr></table></figure>

<p>最后我们将这个 controller 挂载到路由上：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">  router.<span class="title function_">resources</span>(<span class="string">&quot;users&quot;</span>, <span class="string">&quot;/users&quot;</span>, controller.<span class="property">users</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>针对 <code>users</code> 表的 CURD 操作的接口就开发完了</p>
<h3 id="模型其他参数"><a href="#模型其他参数" class="headerlink" title="模型其他参数"></a>模型其他参数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置（重要）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">  <span class="string">&quot;user&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">    <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 自定义表名</span></span><br><span class="line">    <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">tableName</span>: <span class="string">&quot;xyz_users&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否需要增加createdAt、updatedAt、deletedAt字段</span></span><br><span class="line">    <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不需要createdAt字段</span></span><br><span class="line">    <span class="attr">createdAt</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将updatedAt字段改个名</span></span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="string">&quot;utime&quot;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将deletedAt字段改名</span></span><br><span class="line">    <span class="comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span></span><br><span class="line">    <span class="attr">deletedAt</span>: <span class="string">&quot;dtime&quot;</span>,</span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="sequelize-命令"><a href="#sequelize-命令" class="headerlink" title="sequelize 命令"></a>sequelize 命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>sequelize db:migrate</td>
<td>运行迁移文件</td>
</tr>
<tr>
<td>sequelize db:migrate:status</td>
<td>列出所有迁移的状态</td>
</tr>
<tr>
<td>sequelize db:migrate:undo</td>
<td>隔离数据库：迁移：撤消</td>
</tr>
<tr>
<td>sequelize db:migrate:undo:all</td>
<td>还原所有运行的迁移</td>
</tr>
<tr>
<td>sequelize db:create</td>
<td>创建由配置指定的数据库</td>
</tr>
<tr>
<td>sequelize db:drop</td>
<td>删除由配置指定的数据库</td>
</tr>
</tbody></table>
<h3 id="外键约束（重要）"><a href="#外键约束（重要）" class="headerlink" title="外键约束（重要）"></a>外键约束（重要）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 迁移文件</span></span><br><span class="line">queryInterface.<span class="title function_">addConstraint</span>(<span class="string">&quot;tableName&quot;</span>, [<span class="string">&quot;user_id&quot;</span>], &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;foreign key&quot;</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;user_id&quot;</span>,</span><br><span class="line">  <span class="attr">references</span>: &#123;</span><br><span class="line">    <span class="comment">//Required field</span></span><br><span class="line">    <span class="attr">table</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">    <span class="attr">field</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">onDelete</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">  <span class="attr">onUpdate</span>: <span class="string">&quot;cascade&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="创建第一个种子"><a href="#创建第一个种子" class="headerlink" title="创建第一个种子"></a>创建第一个种子</h3><p>假设我们希望在默认情况下将一些数据插入到几个表中. 如果我们跟进前面的例子,我们可以考虑为 <code>User</code> 表创建演示用户.</p>
<p>要管理所有数据迁移,你可以使用 <code>seeders</code>. 种子文件是数据的一些变化,可用于使用样本数据或测试数据填充数据库表.</p>
<p>让我们创建一个种子文件,它会将一个演示用户添加到我们的 <code>User</code> 表中.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize seed:generate --name demo-user</span><br></pre></td></tr></table></figure>

<p>这个命令将会在 <code>seeders</code> 文件夹中创建一个种子文件.文件名看起来像是 <code>XXXXXXXXXXXXXX-demo-user.js</code>,它遵循相同的 <code>up/down</code> 语义,如迁移文件.</p>
<p>现在我们应该编辑这个文件,将演示用户插入<code>User</code>表.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">up</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">bulkInsert</span>(</span><br><span class="line">      <span class="string">&quot;Users&quot;</span>,</span><br><span class="line">      [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">firstName</span>: <span class="string">&quot;John&quot;</span>,</span><br><span class="line">          <span class="attr">lastName</span>: <span class="string">&quot;Doe&quot;</span>,</span><br><span class="line">          <span class="attr">email</span>: <span class="string">&quot;demo@demo.com&quot;</span>,</span><br><span class="line">          <span class="attr">createdAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">          <span class="attr">updatedAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">      &#123;&#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="attr">down</span>: <span class="function">(<span class="params">queryInterface, Sequelize</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> queryInterface.<span class="title function_">bulkDelete</span>(<span class="string">&quot;Users&quot;</span>, <span class="literal">null</span>, &#123;&#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="运行种子"><a href="#运行种子" class="headerlink" title="运行种子"></a>运行种子</h3><p>在上一步中,你创建了一个种子文件. 但它还没有保存到数据库. 为此,我们需要运行一个简单的命令.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:all</span><br></pre></td></tr></table></figure>

<p>这将执行该种子文件,你将有一个演示用户插入 <code>User</code> 表.</p>
<p><strong>注意:</strong> _ <em><code>\_seeders_</code></em> 执行不会存储在任何使用 <em><code>_SequelizeMeta_</code></em> 表的迁移的地方. 如果你想覆盖这个,请阅读 <em><code>_存储_</code></em> 部分_</p>
<h3 id="撤销种子"><a href="#撤销种子" class="headerlink" title="撤销种子"></a>撤销种子</h3><p>Seeders 如果使用了任何存储那么就可以被撤消. 有两个可用的命令</p>
<p>如果你想撤消最近的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo</span><br></pre></td></tr></table></figure>

<p>如果你想撤消特定的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo --seed name-of-seed-as-in-data</span><br></pre></td></tr></table></figure>

<p>如果你想撤消所有的种子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize db:seed:undo:all</span><br></pre></td></tr></table></figure>

<h2 id="关联操作"><a href="#关联操作" class="headerlink" title="关联操作"></a>关联操作</h2><h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>模型层：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个用户对应一个用户资料</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// app/model/user.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;user&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">    <span class="attr">age</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// 关联关系</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    <span class="comment">// 关联用户资料 一对一</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">hasOne</span>(app.<span class="property">model</span>.<span class="property">Userinfo</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/model/userinfo.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line">  <span class="keyword">const</span> userinfo = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">    <span class="string">&quot;userinfo&quot;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">nickname</span>: <span class="variable constant_">STRING</span>,</span><br><span class="line">      <span class="attr">user_id</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;&#125;</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 关联用户表</span></span><br><span class="line">  userinfo.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    app.<span class="property">model</span>.<span class="property">Userinfo</span>.<span class="title function_">belongsTo</span>(app.<span class="property">model</span>.<span class="property">User</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> userinfo;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制器调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/users.js</span></span><br><span class="line"><span class="comment">// 显示单条</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根据主键查询 查询一条用findOne</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="comment">// 主表查询字段限制</span></span><br><span class="line">        <span class="attr">attributes</span>:[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">        <span class="comment">// 关联查询</span></span><br><span class="line">        <span class="attr">include</span>: [&#123;</span><br><span class="line">            <span class="comment">// 需要查询的模型</span></span><br><span class="line">            <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">app</span>.<span class="property">model</span>.<span class="property">Userinfo</span>,</span><br><span class="line">            <span class="comment">// 副表查询的字段</span></span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;nickname&#x27;</span>]</span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="comment">// 主表条件</span></span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">City</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">City</span>.<span class="title function_">init</span>(&#123; <span class="attr">countryCode</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;city&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Country</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Country</span>.<span class="title function_">init</span>(</span><br><span class="line">  &#123; <span class="attr">isoCode</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;,</span><br><span class="line">  &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;country&quot;</span> &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在这里,我们可以根据国家代码连接国家和城市</span></span><br><span class="line"><span class="title class_">Country</span>.<span class="title function_">hasMany</span>(<span class="title class_">City</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;countryCode&quot;</span>, <span class="attr">sourceKey</span>: <span class="string">&quot;isoCode&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">City</span>.<span class="title function_">belongsTo</span>(<span class="title class_">Country</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;countryCode&quot;</span>, <span class="attr">targetKey</span>: <span class="string">&quot;isoCode&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">belongsToMany</span>(<span class="title class_">Project</span>, &#123;</span><br><span class="line">  <span class="attr">as</span>: <span class="string">&quot;Tasks&quot;</span>,</span><br><span class="line">  <span class="attr">through</span>: <span class="string">&quot;worker_tasks&quot;</span>,</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;userId&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">belongsToMany</span>(<span class="title class_">User</span>, &#123;</span><br><span class="line">  <span class="attr">as</span>: <span class="string">&quot;Workers&quot;</span>,</span><br><span class="line">  <span class="attr">through</span>: <span class="string">&quot;worker_tasks&quot;</span>,</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;projectId&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="关联常用操作"><a href="#关联常用操作" class="headerlink" title="关联常用操作"></a>关联常用操作</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取关联模型对象，n对一不需要加s</span></span><br><span class="line"><span class="keyword">let</span> userinfo = <span class="keyword">await</span> user.<span class="title function_">getUserinfo</span>();</span><br><span class="line"><span class="comment">// n对多需要加s</span></span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;title&quot;</span>],</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 关联操作</span></span><br><span class="line"><span class="comment">// 1：用户创建文章（一对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">title</span>: <span class="string">&quot;第一篇文章&quot;</span>,</span><br><span class="line">  <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.获取当前用户所有文章</span></span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>();</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;id&quot;</span>],</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;测试&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3：用户删除文章（一对多）</span></span><br><span class="line"><span class="comment">// (1) 获取当前用户的所有文章</span></span><br><span class="line"><span class="keyword">let</span> posts = <span class="keyword">await</span> user.<span class="title function_">getPosts</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;id&quot;</span>],</span><br><span class="line">&#125;);</span><br><span class="line">posts = posts.<span class="title function_">map</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v.<span class="property">id</span>);</span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: posts,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景三：用户关注话题（多对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">bulkCreate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户关注话题（多对多）</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">user_id</span>: user.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">topic_id</span>: [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="获取器和修改器"><a href="#获取器和修改器" class="headerlink" title="获取器和修改器"></a>获取器和修改器</h2><p>模型层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/model/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="variable constant_">STRING</span>, <span class="variable constant_">INTEGER</span>, <span class="variable constant_">DATE</span> &#125; = app.<span class="property">Sequelize</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(<span class="string">&quot;user&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title function_">STRING</span>(<span class="number">30</span>),</span><br><span class="line">      <span class="comment">// 单独字段的getter，查询时都会调用</span></span><br><span class="line">      <span class="comment">// this.getDataValue(&#x27;name&#x27;) 获取原始值</span></span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> age = <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">getDataValue</span>(<span class="string">&quot;name&quot;</span>) + <span class="string">&quot;年龄：&quot;</span> + age;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="variable constant_">INTEGER</span>,</span><br><span class="line">      <span class="comment">// 单独字段的setter，新增和更新时调用</span></span><br><span class="line">      <span class="comment">// this.setDataValue(&#x27;name&#x27;) 设置原始值</span></span><br><span class="line">      <span class="title function_">set</span>(<span class="params">val</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setDataValue</span>(<span class="string">&quot;age&quot;</span>, val * <span class="number">10</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">created_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">    <span class="attr">updated_at</span>: <span class="variable constant_">DATE</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联用户资料</span></span><br><span class="line">  <span class="title class_">User</span>.<span class="property">associate</span> = <span class="keyword">function</span> (<span class="params">models</span>) &#123;</span><br><span class="line">    app.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">hasOne</span>(app.<span class="property">model</span>.<span class="property">Userinfo</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>控制器层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">show</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 根据主键查询</span></span><br><span class="line">    <span class="keyword">let</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 获取原始值 user.getDataValue(&#x27;name&#x27;)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = user.<span class="title function_">getDataValue</span>(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="模型钩子"><a href="#模型钩子" class="headerlink" title="模型钩子"></a>模型钩子</h2><p>模型层</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 钩子</span></span><br><span class="line">    <span class="comment">// 查询前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeFind</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 查询后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterFind</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;查询后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 新增前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeCreate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新增前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 新增后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterCreate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;新增后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 修改前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeUpdate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;修改前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 修改后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterUpdate</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;修改后&#x27;</span>); <span class="comment">// 真正修改才会触发，数据相同不会触发</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 删除前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 删除后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;删除后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 批量删除前</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">beforeBulkDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;批量删除前&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 批量删除后</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">afterBulkDestroy</span>(<span class="function">(<span class="params">user, option</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;批量删除后&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">User</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><h3 id="主键查询"><a href="#主键查询" class="headerlink" title="主键查询"></a>主键查询</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findByPk</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h3 id="查找不存在则创建"><a href="#查找不存在则创建" class="headerlink" title="查找不存在则创建"></a>查找不存在则创建</h3><p>方法 <code>findOrCreate</code> 可用于检查数据库中是否已存在某个元素. 如果是这种情况,则该方法将生成相应的实例. 如果元素不存在,将会被创建.</p>
<p>如果是这种情况,则该方法将导致相应的实例. 如果元素不存在,将会被创建.</p>
<p>假设我们有一个空的数据库,一个 <code>User</code> 模型有一个 <code>username</code> 和 <code>job</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findOrCreate</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&quot;sdepold&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">defaults</span>: &#123;</span><br><span class="line">    <span class="attr">job</span>: <span class="string">&quot;Technical Lead JavaScript&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">[user, created]</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">    user.<span class="title function_">get</span>(&#123;</span><br><span class="line">      <span class="attr">plain</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(created);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    findOrCreate 返回一个包含已找到或创建的对象的数组,找到或创建的对象和一个布尔值,如果创建一个新对象将为true,否则为false,像这样:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [ &#123;</span></span><br><span class="line"><span class="comment">        username: &#x27;sdepold&#x27;,</span></span><br><span class="line"><span class="comment">        job: &#x27;Technical Lead JavaScript&#x27;,</span></span><br><span class="line"><span class="comment">        id: 1,</span></span><br><span class="line"><span class="comment">        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),</span></span><br><span class="line"><span class="comment">        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      true ]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">在上面的例子中,第三行的数组将分成2部分,并将它们作为参数传递给回调函数,在这种情况下将它们视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;true&quot;.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>代码创建了一个新的实例. 所以当我们已经有一个实例了 …</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">create</span>(&#123; <span class="attr">username</span>: <span class="string">&quot;fnord&quot;</span>, <span class="attr">job</span>: <span class="string">&quot;omnomnom&quot;</span> &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span></span><br><span class="line">    <span class="title class_">User</span>.<span class="title function_">findOrCreate</span>(&#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;fnord&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">defaults</span>: &#123;</span><br><span class="line">        <span class="attr">job</span>: <span class="string">&quot;something else&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  )</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">[user, created]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">      user.<span class="title function_">get</span>(&#123;</span><br><span class="line">        <span class="attr">plain</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(created);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在这个例子中,findOrCreate 返回一个如下的数组:</span></span><br><span class="line"><span class="comment">    [ &#123;</span></span><br><span class="line"><span class="comment">        username: &#x27;fnord&#x27;,</span></span><br><span class="line"><span class="comment">        job: &#x27;omnomnom&#x27;,</span></span><br><span class="line"><span class="comment">        id: 2,</span></span><br><span class="line"><span class="comment">        createdAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET),</span></span><br><span class="line"><span class="comment">        updatedAt: Fri Mar 22 2013 21: 28: 34 GMT + 0100(CET)</span></span><br><span class="line"><span class="comment">      &#125;,</span></span><br><span class="line"><span class="comment">      false</span></span><br><span class="line"><span class="comment">    ]</span></span><br><span class="line"><span class="comment">    由findOrCreate返回的数组通过第三行的数组扩展为两部分,并且这些部分将作为2个参数传递给回调函数,在这种情况下将其视为 &quot;user&quot; 和 &quot;created&quot; .(所以“user”将是返回数组的索引0的对象,并且 &quot;created&quot; 将等于 &quot;false&quot;.)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>…现有条目将不会更改. 看到第二个用户的 “job”,并且实际上创建操作是假的.</p>
<h3 id="查找并计数"><a href="#查找并计数" class="headerlink" title="查找并计数"></a>查找并计数</h3><p><code>findAndCountAll</code> - 在数据库中搜索多个元素,返回数据和总计数</p>
<p>这是一个方便的方法,它结合了 <code>findAll</code> 和 <code>count</code>(见下文),当处理与分页相关的查询时,这是有用的,你想用 <code>limit</code> 和 <code>offset</code> 检索数据,但也需要知道总数与查询匹配的记录数:</p>
<p>处理程序成功将始终接收具有两个属性的对象:</p>
<ul>
<li><code>count</code> - 一个整数,总数记录匹配 where 语句和关联的其它过滤器</li>
<li><code>rows</code> - 一个数组对象,记录在 limit 和 offset 范围内匹配 where 语句和关联的其它过滤器,</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;foo%&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">offset</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">count</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(result.<span class="property">rows</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>它支持 include. 只有标记为 <code>required</code> 的 include 将被添加到计数部分:</p>
<p>假设你想查找附有个人资料的所有用户:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Profile</span>, <span class="attr">required</span>: <span class="literal">true</span> &#125;],</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">3</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>因为 <code>Profile</code> 的 include 有 <code>required</code> 设置,这将导致内部连接,并且只有具有 profile 的用户将被计数. 如果我们从 include 中删除<code>required</code>,那么有和没有 profile 的用户都将被计数. 在 include 中添加一个 <code>where</code> 语句会自动使它成为 required:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Profile</span>, <span class="attr">where</span>: &#123; <span class="attr">active</span>: <span class="literal">true</span> &#125; &#125;],</span><br><span class="line">  <span class="attr">limit</span>: <span class="number">3</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的查询只会对具有 active profile 的用户进行计数,因为在将 where 语句添加到 include 时,<code>required</code> 被隐式设置为 true.</p>
<p>传递给 <code>findAndCountAll</code> 的 options 对象与 <code>findAll</code> 相同(如下所述).</p>
<h3 id="查询多个（常用）"><a href="#查询多个（常用）" class="headerlink" title="查询多个（常用）"></a>查询多个（常用）</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到多个条目</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects 将是所有 Project 实例的数组</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 搜索特定属性 - 使用哈希</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;A Project&quot;</span> &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects将是一个具有指定 name 的 Project 实例数组</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在特定范围内进行搜索</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">projects</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// projects将是一系列具有 id 1,2 或 3 的项目</span></span><br><span class="line">  <span class="comment">// 这实际上是在做一个 IN 查询</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">and</span>]: &#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, <span class="comment">// 且 (a = 5)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">a</span>: <span class="number">5</span> &#125;, &#123; <span class="attr">a</span>: <span class="number">6</span> &#125;], <span class="comment">// (a = 5 或 a = 6)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">6</span>, <span class="comment">// id &gt; 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">gte</span>]: <span class="number">6</span>, <span class="comment">// id &gt;= 6</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">10</span>, <span class="comment">// id &lt; 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lte</span>]: <span class="number">10</span>, <span class="comment">// id &lt;= 10</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="number">20</span>, <span class="comment">// id != 20</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">between</span>]: [<span class="number">6</span>, <span class="number">10</span>], <span class="comment">// 在 6 和 10 之间</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notBetween</span>]: [<span class="number">11</span>, <span class="number">15</span>], <span class="comment">// 不在 11 和 15 之间</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">in</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// 在 [1, 2] 之中</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notIn</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// 不在 [1, 2] 之中</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 包含 &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notLike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 不包含 &#x27;%hat&#x27;</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 包含 &#x27;%hat&#x27; (不区分大小写)  (仅限 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">notILike</span>]: <span class="string">&quot;%hat&quot;</span>, <span class="comment">// 不包含 &#x27;%hat&#x27;  (仅限 PG)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// @&gt; [1, 2] (PG数组包含运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>], <span class="comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span></span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="number">2</span>, <span class="number">3</span>], <span class="comment">// 任何数组[2, 3]::INTEGER (仅限 PG)</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">status</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">not</span>]: <span class="literal">false</span>, <span class="comment">// status 不为 FALSE</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="复合过滤-x2F-OR-x2F-NOT-查询"><a href="#复合过滤-x2F-OR-x2F-NOT-查询" class="headerlink" title="复合过滤 &#x2F; OR &#x2F; NOT 查询"></a>复合过滤 &#x2F; OR &#x2F; NOT 查询</h3><p>你可以使用多层嵌套的 AND,OR 和 NOT 条件进行一个复合的 where 查询. 为了做到这一点,你可以使用 <code>or</code> , <code>and</code> 或 <code>not</code> <code>运算符</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;, &#123; <span class="attr">id</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">10</span> &#125; &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    <span class="attr">id</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">10</span> &#125;],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这两段代码将生成以下内容:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> *</span><br><span class="line"><span class="variable constant_">FROM</span> <span class="string">`Projects`</span></span><br><span class="line"><span class="variable constant_">WHERE</span> (</span><br><span class="line">  <span class="string">`Projects`</span>.<span class="string">`name`</span> = <span class="string">&#x27;a project&#x27;</span></span><br><span class="line">   <span class="variable constant_">AND</span> (<span class="string">`Projects`</span>.<span class="string">`id`</span> <span class="variable constant_">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>) <span class="variable constant_">OR</span> <span class="string">`Projects`</span>.<span class="string">`id`</span> &gt; <span class="number">10</span>)</span><br><span class="line">)</span><br><span class="line"><span class="variable constant_">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><code>not</code> 示例:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;a project&quot;</span>,</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">not</span>]: [&#123; <span class="attr">id</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] &#125;, &#123; <span class="attr">array</span>: &#123; [<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] &#125; &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>将生成:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> *</span><br><span class="line"><span class="variable constant_">FROM</span> <span class="string">`Projects`</span></span><br><span class="line"><span class="variable constant_">WHERE</span> (</span><br><span class="line">  <span class="string">`Projects`</span>.<span class="string">`name`</span> = <span class="string">&#x27;a project&#x27;</span></span><br><span class="line">   <span class="variable constant_">AND</span> <span class="variable constant_">NOT</span> (<span class="string">`Projects`</span>.<span class="string">`id`</span> <span class="variable constant_">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>) <span class="variable constant_">OR</span> <span class="string">`Projects`</span>.<span class="string">`array`</span> @&gt; <span class="variable constant_">ARRAY</span>[<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]::<span class="variable constant_">INTEGER</span>[])</span><br><span class="line">)</span><br><span class="line"><span class="variable constant_">LIMIT</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="用限制-偏移-顺序和分组操作数据集"><a href="#用限制-偏移-顺序和分组操作数据集" class="headerlink" title="用限制,偏移,顺序和分组操作数据集"></a>用限制,偏移,顺序和分组操作数据集</h3><p>要获取更多相关数据,可以使用限制,偏移,顺序和分组:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 限制查询的结果</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">limit</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过前10个元素</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过前10个元素,并获取2个</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">10</span>, <span class="attr">limit</span>: <span class="number">2</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>分组和排序的语法是相同的,所以下面只用一个单独的例子来解释分组,而其余的则是排序. 你下面看到的所有内容也可以对分组进行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">order</span>: [[<span class="string">&quot;title&quot;</span>, <span class="string">&quot;DESC&quot;</span>]] &#125;);</span><br><span class="line"><span class="comment">// 生成 ORDER BY title DESC</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">group</span>: <span class="string">&quot;name&quot;</span> &#125;);</span><br><span class="line"><span class="comment">// 生成 GROUP BY name</span></span><br></pre></td></tr></table></figure>

<p>请注意,在上述两个示例中,提供的字符串逐字插入到查询中,所以不会转义列名称. 当你向 order &#x2F; group 提供字符串时,将始终如此. 如果要转义列名,你应该提供一个参数数组,即使你只想通过单个列进行 order &#x2F; group</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">something.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">order</span>: [</span><br><span class="line">    <span class="comment">// 将返回 `name`</span></span><br><span class="line">    [<span class="string">&quot;name&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 `username` DESC</span></span><br><span class="line">    [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;DESC&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 max(`age`)</span></span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&quot;max&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;age&quot;</span>)),</span><br><span class="line">    <span class="comment">// 将返回 max(`age`) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&quot;max&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;age&quot;</span>)), <span class="string">&quot;DESC&quot;</span>],</span><br><span class="line">    <span class="comment">// 将返回 otherfunction(`col1`, 12, &#x27;lalala&#x27;) DESC</span></span><br><span class="line">    [</span><br><span class="line">      sequelize.<span class="title function_">fn</span>(<span class="string">&quot;otherfunction&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;col1&quot;</span>), <span class="number">12</span>, <span class="string">&quot;lalala&quot;</span>),</span><br><span class="line">      <span class="string">&quot;DESC&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// 将返回 otherfunction(awesomefunction(`col`)) DESC,这个嵌套是可以无限的！</span></span><br><span class="line">    [</span><br><span class="line">      sequelize.<span class="title function_">fn</span>(</span><br><span class="line">        <span class="string">&quot;otherfunction&quot;</span>,</span><br><span class="line">        sequelize.<span class="title function_">fn</span>(<span class="string">&quot;awesomefunction&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;col&quot;</span>))</span><br><span class="line">      ),</span><br><span class="line">      <span class="string">&quot;DESC&quot;</span>,</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>回顾一下,order &#x2F; group 数组的元素可以是以下内容:</p>
<ul>
<li>String - 将被引用</li>
<li>Array - 第一个元素将被引用,第二个将被逐字地追加</li>
<li>Object -<ul>
<li>raw 将被添加逐字引用</li>
<li>如果未设置 raw,一切都被忽略,查询将失败</li>
</ul>
</li>
<li>Sequelize.fn 和 Sequelize.col 返回函数和引用的列名</li>
</ul>
<h3 id="字段过滤"><a href="#字段过滤" class="headerlink" title="字段过滤"></a>字段过滤</h3><p>想要只选择某些属性,可以使用 <code>attributes</code> 选项. 通常是传递一个数组:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT foo, bar …</p>
</blockquote>
<p>属性可以使用嵌套数组来重命名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&quot;foo&quot;</span>, [<span class="string">&quot;bar&quot;</span>, <span class="string">&quot;baz&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT foo, bar AS baz …</p>
</blockquote>
<p>也可以使用 <code>sequelize.fn</code> 来进行聚合:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [[sequelize.<span class="title function_">fn</span>(<span class="string">&quot;COUNT&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;hats&quot;</span>)), <span class="string">&quot;no_hats&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT COUNT(hats) AS no_hats …</p>
</blockquote>
<p>使用聚合功能时,必须给它一个别名,以便能够从模型中访问它. 在上面的例子中,你可以使用 <code>instance.get(&#39;no_hats&#39;)</code> 获得帽子数量.</p>
<p>有时,如果你只想添加聚合,则列出模型的所有属性可能令人厌烦:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is a tiresome way of getting the number of hats...</span></span><br><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>, <span class="string">&#x27;baz&#x27;</span>, <span class="string">&#x27;quz&#x27;</span>, [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;COUNT&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;hats&#x27;</span>)), <span class="string">&#x27;no_hats&#x27;</span>]]</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is shorter, and less error prone because it still works if you add / remove attributes</span></span><br><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: &#123; <span class="attr">include</span>: [[sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;COUNT&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;hats&#x27;</span>)), <span class="string">&#x27;no_hats&#x27;</span>]] &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable constant_">SELECT</span> id, foo, bar, baz, quz, <span class="title function_">COUNT</span>(hats) <span class="variable constant_">AS</span> no_hats ...</span><br></pre></td></tr></table></figure>

<p>同样,它也可以排除一些指定的表字段:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Model</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: &#123; <span class="attr">exclude</span>: [<span class="string">&#x27;baz&#x27;</span>] &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable constant_">SELECT</span> id, foo, bar, quz ...</span><br></pre></td></tr></table></figure>

<h3 id="Where"><a href="#Where" class="headerlink" title="Where"></a>Where</h3><p>无论你是通过 findAll&#x2F;find 或批量 updates&#x2F;destroys 进行查询,都可以传递一个 <code>where</code> 对象来过滤查询.</p>
<p><code>where</code> 通常用 attribute:value 键值对获取一个对象,其中 value 可以是匹配等式的数据或其他运算符的键值对象.</p>
<p>也可以通过嵌套 <code>or</code> 和 <code>and</code> <code>运算符</code> 的集合来生成复杂的 AND&#x2F;OR 条件.</p>
<h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Op</span> = <span class="title class_">Sequelize</span>.<span class="property">Op</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 2</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;active&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 AND status = &#x27;active&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123; <span class="attr">authorId</span>: <span class="number">12</span> &#125;, &#123; <span class="attr">authorId</span>: <span class="number">13</span> &#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">authorId</span>: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">or</span>]: [<span class="number">12</span>, <span class="number">13</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE authorId = 12 OR authorId = 13;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;inactive&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// DELETE FROM post WHERE status = &#x27;inactive&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">update</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">updatedAt</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">deletedAt</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="literal">null</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// UPDATE post SET updatedAt = null WHERE deletedAt NOT NULL;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: sequelize.<span class="title function_">where</span>(</span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&quot;char_length&quot;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&quot;status&quot;</span>)),</span><br><span class="line">    <span class="number">6</span></span><br><span class="line">  ),</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// SELECT * FROM post WHERE char_length(status) = 6;</span></span><br></pre></td></tr></table></figure>

<h4 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h4><p>Sequelize 可用于创建更复杂比较的符号运算符 -</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Op</span> = <span class="title class_">Sequelize</span>.<span class="property">Op</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">and</span>]: &#123;<span class="attr">a</span>: <span class="number">5</span>&#125;           <span class="comment">// 且 (a = 5)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">or</span>]: [&#123;<span class="attr">a</span>: <span class="number">5</span>&#125;, &#123;<span class="attr">a</span>: <span class="number">6</span>&#125;]  <span class="comment">// (a = 5 或 a = 6)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">6</span>,                <span class="comment">// id &gt; 6</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">gte</span>]: <span class="number">6</span>,               <span class="comment">// id &gt;= 6</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">10</span>,               <span class="comment">// id &lt; 10</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">lte</span>]: <span class="number">10</span>,              <span class="comment">// id &lt;= 10</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">ne</span>]: <span class="number">20</span>,               <span class="comment">// id != 20</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">eq</span>]: <span class="number">3</span>,                <span class="comment">// = 3</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">not</span>]: <span class="literal">true</span>,            <span class="comment">// 不是 TRUE</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">between</span>]: [<span class="number">6</span>, <span class="number">10</span>],     <span class="comment">// 在 6 和 10 之间</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notBetween</span>]: [<span class="number">11</span>, <span class="number">15</span>], <span class="comment">// 不在 11 和 15 之间</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">in</span>]: [<span class="number">1</span>, <span class="number">2</span>],           <span class="comment">// 在 [1, 2] 之中</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notIn</span>]: [<span class="number">1</span>, <span class="number">2</span>],        <span class="comment">// 不在 [1, 2] 之中</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;%hat&#x27;</span>,         <span class="comment">// 包含 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notLike</span>]: <span class="string">&#x27;%hat&#x27;</span>       <span class="comment">// 不包含 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&#x27;%hat&#x27;</span>         <span class="comment">// 包含 &#x27;%hat&#x27; (不区分大小写)  (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notILike</span>]: <span class="string">&#x27;%hat&#x27;</span>      <span class="comment">// 不包含 &#x27;%hat&#x27;  (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">startsWith</span>]: <span class="string">&#x27;hat&#x27;</span>     <span class="comment">// 类似 &#x27;hat%&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">endsWith</span>]: <span class="string">&#x27;hat&#x27;</span>       <span class="comment">// 类似 &#x27;%hat&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">substring</span>]: <span class="string">&#x27;hat&#x27;</span>      <span class="comment">// 类似 &#x27;%hat%&#x27;</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">regexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>    <span class="comment">// 匹配正则表达式/~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span> <span class="comment">// 不匹配正则表达式/!~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">iRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span>    <span class="comment">// ~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">notIRegexp</span>]: <span class="string">&#x27;^[h|a|t]&#x27;</span> <span class="comment">// !~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">like</span>]: &#123; [<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="string">&#x27;cat&#x27;</span>, <span class="string">&#x27;hat&#x27;</span>]&#125; <span class="comment">// 包含任何数组[&#x27;cat&#x27;, &#x27;hat&#x27;] - 同样适用于 iLike 和 notLike</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>]       <span class="comment">// &amp;&amp; [1, 2] (PG数组重叠运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// @&gt; [1, 2] (PG数组包含运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>]     <span class="comment">// &lt;@ [1, 2] (PG数组包含于运算符)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">any</span>]: [<span class="number">2</span>,<span class="number">3</span>]            <span class="comment">// 任何数组[2, 3]::INTEGER (仅限PG)</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">col</span>]: <span class="string">&#x27;user.organization_id&#x27;</span> <span class="comment">// = &#x27;user&#x27;.&#x27;organization_id&#x27;, 使用数据库语言特定的列标识符, 本例使用 PG</span></span><br></pre></td></tr></table></figure>

<h4 id="范围选项"><a href="#范围选项" class="headerlink" title="范围选项"></a>范围选项</h4><p>所有操作符都支持支持的范围类型查询.</p>
<p>请记住,提供的范围值也可以<a target="_blank" rel="noopener" href="https://itfun.tv/documents/266#range-types">定义绑定的 inclusion&#x2F;exclusion</a>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有上述相等和不相等的操作符加上以下内容:</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: <span class="number">2</span>           <span class="comment">// @&gt; &#x27;2&#x27;::integer (PG range contains element operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contains</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// @&gt; [1, 2) (PG range contains range operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">contained</span>]: [<span class="number">1</span>, <span class="number">2</span>]     <span class="comment">// &lt;@ [1, 2) (PG range is contained by operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">overlap</span>]: [<span class="number">1</span>, <span class="number">2</span>]       <span class="comment">// &amp;&amp; [1, 2) (PG range overlap (have points in common) operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">adjacent</span>]: [<span class="number">1</span>, <span class="number">2</span>]      <span class="comment">// -|- [1, 2) (PG range is adjacent to operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">strictLeft</span>]: [<span class="number">1</span>, <span class="number">2</span>]    <span class="comment">// &lt;&lt; [1, 2) (PG range strictly left of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">strictRight</span>]: [<span class="number">1</span>, <span class="number">2</span>]   <span class="comment">// &gt;&gt; [1, 2) (PG range strictly right of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">noExtendRight</span>]: [<span class="number">1</span>, <span class="number">2</span>] <span class="comment">// &amp;&lt; [1, 2) (PG range does not extend to the right of operator)</span></span><br><span class="line">[<span class="title class_">Op</span>.<span class="property">noExtendLeft</span>]: [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment">// &amp;&gt; [1, 2) (PG range does not extend to the left of operator)</span></span><br></pre></td></tr></table></figure>

<h4 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">rank</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">or</span>]: &#123;</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">1000</span>,</span><br><span class="line">      [<span class="title class_">Op</span>.<span class="property">eq</span>]: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// rank &lt; 1000 OR rank IS NULL</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">createdAt</span>: &#123;</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">    [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="keyword">new</span> <span class="title class_">Date</span>() - <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// createdAt &lt; [timestamp] AND createdAt &gt; [timestamp]</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  [<span class="title class_">Op</span>.<span class="property">or</span>]: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">title</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;Boat%&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">description</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&#x27;%boat%&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// title LIKE &#x27;Boat%&#x27; OR description LIKE &#x27;%boat%&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="关系-x2F-关联"><a href="#关系-x2F-关联" class="headerlink" title="关系 &#x2F; 关联"></a>关系 &#x2F; 关联</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到所有具有至少一个 task 的  project,其中 task.state === project.state</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Task</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">state</span>: <span class="title class_">Sequelize</span>.<span class="title function_">col</span>(<span class="string">&quot;project.state&quot;</span>) &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="分页-x2F-限制"><a href="#分页-x2F-限制" class="headerlink" title="分页 &#x2F; 限制"></a>分页 &#x2F; 限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取10个实例/行</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">limit</span>: <span class="number">10</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过8个实例/行</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">8</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳过5个实例,然后取5个</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">offset</span>: <span class="number">5</span>, <span class="attr">limit</span>: <span class="number">5</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><p><code>order</code> 需要一个条目的数组来排序查询或者一个 sequelize 方法.一般来说,你将要使用任一属性的 tuple&#x2F;array,并确定排序的正反方向.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Subtask</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">order</span>: [</span><br><span class="line">    <span class="comment">// 将转义标题,并根据有效的方向参数列表验证DESC</span></span><br><span class="line">    [<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按最大值排序(age)</span></span><br><span class="line">    sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按最大顺序(age) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)), <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将按 otherfunction 排序(`col1`, 12, &#x27;lalala&#x27;) DESC</span></span><br><span class="line">    [sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;otherfunction&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;col1&#x27;</span>), <span class="number">12</span>, <span class="string">&#x27;lalala&#x27;</span>), <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将使用模型名称作为关联的名称排序关联模型的 created_at.</span></span><br><span class="line">    [<span class="title class_">Task</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order through an associated model&#x27;s created_at using the model names as the associations&#x27; names.</span></span><br><span class="line">    [<span class="title class_">Task</span>, <span class="title class_">Project</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将使用关联的名称由关联模型的created_at排序.</span></span><br><span class="line">    [<span class="string">&#x27;Task&#x27;</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by a nested associated model&#x27;s created_at using the names of the associations.</span></span><br><span class="line">    [<span class="string">&#x27;Task&#x27;</span>, <span class="string">&#x27;Project&#x27;</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by an associated model&#x27;s created_at using an association object. (优选方法)</span></span><br><span class="line">    [<span class="title class_">Subtask</span>.<span class="property">associations</span>.<span class="property">Task</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by a nested associated model&#x27;s created_at using association objects. (优选方法)</span></span><br><span class="line">    [<span class="title class_">Subtask</span>.<span class="property">associations</span>.<span class="property">Task</span>, <span class="title class_">Task</span>.<span class="property">associations</span>.<span class="property">Project</span>, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Will order by an associated model&#x27;s created_at using a simple association object.</span></span><br><span class="line">    [&#123;<span class="attr">model</span>: <span class="title class_">Task</span>, <span class="attr">as</span>: <span class="string">&#x27;Task&#x27;</span>&#125;, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>],</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 嵌套关联模型的 created_at 简单关联对象排序</span></span><br><span class="line">    [&#123;<span class="attr">model</span>: <span class="title class_">Task</span>, <span class="attr">as</span>: <span class="string">&#x27;Task&#x27;</span>&#125;, &#123;<span class="attr">model</span>: <span class="title class_">Project</span>, <span class="attr">as</span>: <span class="string">&#x27;Project&#x27;</span>&#125;, <span class="string">&#x27;createdAt&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将按年龄最大值降序排列</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">literal</span>(<span class="string">&#x27;max(age) DESC&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按最年龄大值升序排列,当省略排序条件时默认是升序排列</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">fn</span>(<span class="string">&#x27;max&#x27;</span>, sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 按升序排列是省略排序条件的默认顺序</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">col</span>(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将根据方言随机排序 (而不是 fn(&#x27;RAND&#x27;) 或 fn(&#x27;RANDOM&#x27;))</span></span><br><span class="line">  <span class="attr">order</span>: sequelize.<span class="title function_">random</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="count-计算数据库中元素的出现次数"><a href="#count-计算数据库中元素的出现次数" class="headerlink" title="count - 计算数据库中元素的出现次数"></a><code>count</code> - 计算数据库中元素的出现次数</h3><p>还有一种数据库对象计数的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">count</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;There are &quot;</span> + c + <span class="string">&quot; projects!&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">count</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">25</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;There are &quot;</span> + c + <span class="string">&quot; projects with an id greater than 25.&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="max-获取特定表中特定属性的最大值"><a href="#max-获取特定表中特定属性的最大值" class="headerlink" title="max - 获取特定表中特定属性的最大值"></a><code>max</code> - 获取特定表中特定属性的最大值</h3><p>这里是获取属性的最大值的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">max</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">max</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 40</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">max</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">lt</span>]: <span class="number">20</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">max</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 10</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="min-获取特定表中特定属性的最小值"><a href="#min-获取特定表中特定属性的最小值" class="headerlink" title="min - 获取特定表中特定属性的最小值"></a><code>min</code> - 获取特定表中特定属性的最小值</h3><p>这里是获取属性的最小值的方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">min</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">min</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 5</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">min</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">5</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">min</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 10</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="sum-特定属性的值求和"><a href="#sum-特定属性的值求和" class="headerlink" title="sum - 特定属性的值求和"></a><code>sum</code> - 特定属性的值求和</h3><p>为了计算表的特定列的总和,可以使用“sum”方法.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   我们假设3个具有属性年龄的对象.</span></span><br><span class="line"><span class="comment">   第一个是10岁,</span></span><br><span class="line"><span class="comment">   第二个是5岁,</span></span><br><span class="line"><span class="comment">   第三个是40岁.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">sum</span>(<span class="string">&quot;age&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">sum</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将返回 55</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">sum</span>(<span class="string">&quot;age&quot;</span>, &#123; <span class="attr">where</span>: &#123; <span class="attr">age</span>: &#123; [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">5</span> &#125; &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">sum</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 将会是 50</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="预加载"><a href="#预加载" class="headerlink" title="预加载"></a>预加载</h2><p>当你从数据库检索数据时,也想同时获得与之相关联的查询,这被称为预加载.这个基本思路就是当你调用 <code>find</code> 或 <code>findAll</code> 时使用 <code>include</code> 属性.让我们假设以下设置:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;user&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Task</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;task&quot;</span> &#125;);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tool</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Tool</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize, <span class="attr">modelName</span>: <span class="string">&quot;tool&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Task</span>.<span class="title function_">belongsTo</span>(<span class="title class_">User</span>);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Task</span>);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Tool</span>, &#123; <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span> &#125;);</span><br><span class="line"></span><br><span class="line">sequelize.<span class="title function_">sync</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 这是我们继续的地方 ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>首先,让我们用它们的关联 user 加载所有的 task.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Task</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">User</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">tasks</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(tasks));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;A Task&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;user&quot;: &#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;</span></span><br><span class="line"><span class="comment">      &#125;</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请注意,访问者(结果实例中的 <code>User</code> 属性)是单数形式,因为关联是一对一的.</p>
<p>接下来的事情:用多对一的关联加载数据！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Task</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;tasks&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;A Task&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请注意,访问者(结果实例中的 <code>Tasks</code> 属性)是复数形式,因为关联是多对一的.</p>
<p>如果关联是别名的(使用 <code>as</code> 参数),则在包含模型时必须指定此别名. 注意用户的 <code>Tool</code> 如何被别名为 <code>Instruments</code>. 为了获得正确的权限,你必须指定要加载的模型以及别名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Tool</span>, <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span> &#125;] &#125;).<span class="title function_">then</span>(</span><br><span class="line">  <span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>你还可以通过指定与关联别名匹配的字符串来包含别名:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="string">&quot;Instruments&quot;</span>] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">association</span>: <span class="string">&quot;Instruments&quot;</span> &#125;] &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当预加载时,我们也可以使用 <code>where</code> 过滤关联的模型. 这将返回 <code>Tool</code> 模型中所有与 <code>where</code> 语句匹配的行的<code>User</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">name</span>: &#123; [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%ooth%&quot;</span> &#125; &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Smith&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 2,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当使用 <code>include.where</code> 过滤一个预加载的模型时,<code>include.required</code> 被隐式设置为 <code>true</code>. 这意味着内部联接完成返回具有任何匹配子项的父模型.</p>
<h3 id="使用预加载模型的顶层-WHERE"><a href="#使用预加载模型的顶层-WHERE" class="headerlink" title="使用预加载模型的顶层 WHERE"></a>使用预加载模型的顶层 WHERE</h3><p>将模型的 <code>WHERE</code> 条件从 <code>ON</code> 条件的 include 模式移动到顶层,你可以使用 <code>&#39;$nested.column$&#39;</code> 语法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;$Instruments.name$&#x27;</span>: &#123; [<span class="title class_">Op</span>.<span class="property">iLike</span>]: <span class="string">&#x27;%ooth%&#x27;</span> &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">        <span class="attr">as</span>: <span class="string">&#x27;Instruments&#x27;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">users</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      [&#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;John Smith&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 2,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">        &quot;Instruments&quot;: [&#123;</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">          &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">          &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">          &quot;userId&quot;: 1</span></span><br><span class="line"><span class="comment">        &#125;]</span></span><br><span class="line"><span class="comment">      &#125;],</span></span><br><span class="line"><span class="comment">    */</span></span><br></pre></td></tr></table></figure>

<h3 id="包括所有"><a href="#包括所有" class="headerlink" title="包括所有"></a>包括所有</h3><p>要包含所有属性,你可以使用 <code>all:true</code> 传递单个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">all</span>: <span class="literal">true</span> &#125;] &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="包括软删除的记录"><a href="#包括软删除的记录" class="headerlink" title="包括软删除的记录"></a>包括软删除的记录</h3><p>如果想要加载软删除的记录,可以通过将 <code>include.paranoid</code> 设置为 <code>false</code> 来实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">where</span>: &#123; <span class="attr">name</span>: &#123; [<span class="title class_">Op</span>.<span class="property">like</span>]: <span class="string">&quot;%ooth%&quot;</span> &#125; &#125;,</span><br><span class="line">      <span class="attr">paranoid</span>: <span class="literal">false</span>, <span class="comment">// query and loads the soft deleted records</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="排序预加载关联"><a href="#排序预加载关联" class="headerlink" title="排序预加载关联"></a>排序预加载关联</h3><p>在一对多关系的情况下.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Division</span>], <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="string">&quot;name&quot;</span>]] &#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [<span class="title class_">Division</span>], <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;DESC&quot;</span>]] &#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">as</span>: <span class="string">&quot;Div&quot;</span> &#125;, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;DESC&quot;</span>]],</span><br><span class="line">&#125;);</span><br><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">include</span>: [<span class="title class_">Department</span>] &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="title class_">Department</span>, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在多对多关系的情况下,你还可以通过表中的属性进行排序.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Company</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">Division</span>, <span class="attr">include</span>: [<span class="title class_">Department</span>] &#125;],</span><br><span class="line">  <span class="attr">order</span>: [[<span class="title class_">Division</span>, <span class="title class_">DepartmentDivision</span>, <span class="string">&quot;name&quot;</span>]],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="嵌套预加载"><a href="#嵌套预加载" class="headerlink" title="嵌套预加载"></a>嵌套预加载</h3><p>你可以使用嵌套的预加载来加载相关模型的所有相关模型:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="title class_">Teacher</span>,</span><br><span class="line">          <span class="attr">include</span>: [</span><br><span class="line">            <span class="comment">/* etc */</span></span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(users));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    [&#123;</span></span><br><span class="line"><span class="comment">      &quot;name&quot;: &quot;John Doe&quot;,</span></span><br><span class="line"><span class="comment">      &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span></span><br><span class="line"><span class="comment">      &quot;Instruments&quot;: [&#123; // 1:M and N:M association</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;Toothpick&quot;,</span></span><br><span class="line"><span class="comment">        &quot;id&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;createdAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;updatedAt&quot;: null,</span></span><br><span class="line"><span class="comment">        &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="comment">        &quot;Teacher&quot;: &#123; // 1:1 association</span></span><br><span class="line"><span class="comment">          &quot;name&quot;: &quot;Jimi Hendrix&quot;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">      &#125;]</span></span><br><span class="line"><span class="comment">    &#125;]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这将产生一个外连接. 但是,相关模型上的 <code>where</code> 语句将创建一个内部连接,并仅返回具有匹配子模型的实例. 要返回所有父实例,你应该添加 <code>required: false</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="title class_">Tool</span>,</span><br><span class="line">      <span class="attr">as</span>: <span class="string">&quot;Instruments&quot;</span>,</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">model</span>: <span class="title class_">Teacher</span>,</span><br><span class="line">          <span class="attr">where</span>: &#123;</span><br><span class="line">            <span class="attr">school</span>: <span class="string">&quot;Woodstock Music School&quot;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">required</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      ],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">users</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上查询将返回所有用户及其所有乐器,但只会返回与 <code>Woodstock Music School</code> 相关的老师.</p>
<p>包括所有也支持嵌套加载:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">findAll</span>(&#123; <span class="attr">include</span>: [&#123; <span class="attr">all</span>: <span class="literal">true</span>, <span class="attr">nested</span>: <span class="literal">true</span> &#125;] &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h2><h3 id="字段限制"><a href="#字段限制" class="headerlink" title="字段限制"></a>字段限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(</span><br><span class="line">  &#123; <span class="attr">username</span>: <span class="string">&quot;barfooz&quot;</span>, <span class="attr">isAdmin</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">fields</span>: [<span class="string">&quot;username&quot;</span>] &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 只有username有效</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">bulkCreate</span>([&#123; <span class="attr">username</span>: <span class="string">&quot;foo&quot;</span> &#125;, &#123; <span class="attr">username</span>: <span class="string">&quot;bar&quot;</span>, <span class="attr">admin</span>: <span class="literal">true</span> &#125;], &#123;</span><br><span class="line">  <span class="attr">fields</span>: [<span class="string">&quot;username&quot;</span>],</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// admin 将不会被构建</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="新增单个"><a href="#新增单个" class="headerlink" title="新增单个"></a>新增单个</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;哈哈哈&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">12</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量新增"><a href="#批量新增" class="headerlink" title="批量新增"></a>批量新增</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量新增 bulkCreate</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">bulkCreate</span>([</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第一个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第二个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;第三个&quot;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">15</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><h3 id="字段限制-1"><a href="#字段限制-1" class="headerlink" title="字段限制"></a>字段限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">task.<span class="property">title</span> = <span class="string">&quot;foooo&quot;</span>;</span><br><span class="line">task.<span class="property">description</span> = <span class="string">&quot;baaaaaar&quot;</span>;</span><br><span class="line"><span class="keyword">await</span> task.<span class="title function_">save</span>(&#123; <span class="attr">fields</span>: [<span class="string">&quot;title&quot;</span>] &#125;);</span><br><span class="line"><span class="comment">// title 现在将是 “foooo”,而 description 与以前一样</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用等效的 update 调用如下所示:</span></span><br><span class="line"><span class="keyword">await</span> task.<span class="title function_">update</span>(</span><br><span class="line">  &#123; <span class="attr">title</span>: <span class="string">&quot;foooo&quot;</span>, <span class="attr">description</span>: <span class="string">&quot;baaaaaar&quot;</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">fields</span>: [<span class="string">&quot;title&quot;</span>] &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">//  title 现在将是 “foooo”,而 description 与以前一样</span></span><br></pre></td></tr></table></figure>

<h3 id="单个修改"><a href="#单个修改" class="headerlink" title="单个修改"></a>单个修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">await</span> user.<span class="title function_">update</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;我被修改了&quot;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">30</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量修改"><a href="#批量修改" class="headerlink" title="批量修改"></a>批量修改</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 批量修改</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">update</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;批量修改&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 条件</span></span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&quot;第一个&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="递增"><a href="#递增" class="headerlink" title="递增"></a>递增</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录 increment</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> user.<span class="title function_">increment</span>(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">3</span>, <span class="comment">// age每次递增3</span></span><br><span class="line">  <span class="attr">other</span>: <span class="number">2</span>, <span class="comment">// other每次递增2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="递减"><a href="#递减" class="headerlink" title="递减"></a>递减</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找出当前记录 decrement</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findByPk</span>(<span class="number">2</span>);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">body</span> = <span class="keyword">await</span> user.<span class="title function_">decrement</span>(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">3</span>, <span class="comment">// age每次递减3</span></span><br><span class="line">  <span class="attr">other</span>: <span class="number">2</span>, <span class="comment">// other每次递减2</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><h3 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h3><p>模型中配置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 配置（重要）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = app.<span class="property">model</span>.<span class="title function_">define</span>(</span><br><span class="line">  <span class="string">&quot;user&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* bla */</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="查询包括软删除内容"><a href="#查询包括软删除内容" class="headerlink" title="查询包括软删除内容"></a>查询包括软删除内容</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> user = <span class="keyword">await</span> ctx.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: &#123;</span><br><span class="line">    <span class="attr">model</span>: ctx.<span class="property">model</span>.<span class="property">Video</span>,</span><br><span class="line">    <span class="comment">// 包括软删除</span></span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: <span class="number">33</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 包括软删除</span></span><br><span class="line">  <span class="attr">paranoid</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="彻底删除"><a href="#彻底删除" class="headerlink" title="彻底删除"></a>彻底删除</h3><p>如果 <code>paranoid</code> 选项为 true,则不会删除该对象,而将 <code>deletedAt</code> 列设置为当前时间戳. 要强制删除,可以将 <code>force: true</code> 传递给 destroy 调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">task.<span class="title function_">destroy</span>(&#123; <span class="attr">force</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>在 <code>paranoid</code> 模式下对象被软删除后,在强制删除旧实例之前,你将无法使用相同的主键创建新实例.</p>
<h3 id="恢复软删除的实例"><a href="#恢复软删除的实例" class="headerlink" title="恢复软删除的实例"></a>恢复软删除的实例</h3><p>如果你使用 <code>paranoid:true</code> 软删除了模型的实例,之后想要撤消删除,请使用 <code>restore</code> 方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进行软删除...</span></span><br><span class="line">task.<span class="title function_">destroy</span>();</span><br><span class="line"><span class="comment">// 恢复软删除...</span></span><br><span class="line">task.<span class="title function_">restore</span>();</span><br></pre></td></tr></table></figure>

<h3 id="条件删除"><a href="#条件删除" class="headerlink" title="条件删除"></a>条件删除</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">User</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;批量修改&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">Post</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">id</span>: posts,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="重载实例"><a href="#重载实例" class="headerlink" title="重载实例"></a>重载实例</h2><p>如果你需要让你的实例同步,你可以使用 <code>reload</code> 方法. 它将从数据库中获取当前数据,并覆盖调用该方法的模型的属性.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Person</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">where</span>: &#123; <span class="attr">name</span>: <span class="string">&quot;john&quot;</span> &#125; &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">person</span>) =&gt;</span> &#123;</span><br><span class="line">  person.<span class="property">name</span> = <span class="string">&quot;jane&quot;</span>;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>); <span class="comment">// &#x27;jane&#x27;</span></span><br><span class="line"></span><br><span class="line">  person.<span class="title function_">reload</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">name</span>); <span class="comment">// &#x27;john&#x27;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="模型自定义方法"><a href="#模型自定义方法" class="headerlink" title="模型自定义方法"></a>模型自定义方法</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模型</span></span><br><span class="line"><span class="comment">// 模型自定义方法</span></span><br><span class="line">topic_user.<span class="property">ceshi</span> = <span class="function">(<span class="params">param</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;模型自定义方法&quot;</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(param);</span><br><span class="line">  <span class="keyword">return</span> param;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制器</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">model</span>.<span class="property">TopicUser</span>.<span class="title function_">ceshi</span>(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Scopes-作用域（重点）"><a href="#Scopes-作用域（重点）" class="headerlink" title="Scopes - 作用域（重点）"></a>Scopes - 作用域（重点）</h2><p>作用域允许你定义常用查询,以便以后轻松使用. 作用域可以包括与常规查找器 <code>where</code>, <code>include</code>, <code>limit</code> 等所有相同的属性.</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>作用域在模型定义中定义,可以是 finder 对象或返回 finder 对象的函数,除了默认作用域,该作用域只能是一个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Project</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">  <span class="comment">// 属性</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">defaultScope</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scopes</span>: &#123;</span><br><span class="line">    <span class="attr">deleted</span>: &#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">deleted</span>: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">activeUsers</span>: &#123;</span><br><span class="line">      <span class="attr">include</span>: [</span><br><span class="line">        &#123; <span class="attr">model</span>: <span class="title class_">User</span>, <span class="attr">where</span>: &#123; <span class="attr">active</span>: <span class="literal">true</span> &#125;&#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    random () &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">          <span class="attr">someNumber</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    accessLevel (value) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">          <span class="attr">accessLevel</span>: &#123;</span><br><span class="line">            [<span class="title class_">Op</span>.<span class="property">gte</span>]: value</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sequelize,</span><br><span class="line">    <span class="attr">modelName</span>: <span class="string">&#x27;project&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>通过调用 <code>addScope</code> 定义模型后,还可以添加作用域. 这对于具有包含的作用域特别有用,其中在定义其他模型时可能不会定义 include 中的模型.</p>
<p>始终应用默认作用域. 这意味着,通过上面的模型定义,<code>Project.findAll()</code> 将创建以下查询:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> active = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>可以通过调用 <code>.unscoped()</code>, <code>.scope(null)</code> 或通过调用另一个作用域来删除默认作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>(); <span class="comment">// 删除默认作用域</span></span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> deleted = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>还可以在作用域定义中包含作用域模型. 这让你避免重复 <code>include</code>,<code>attributes</code> 或 <code>where</code> 定义.</p>
<p>使用上面的例子,并在包含的用户模型中调用 <code>active</code> 作用域(而不是直接在该 include 对象中指定条件):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">activeUsers</span>: &#123;</span><br><span class="line">  <span class="attr">include</span>: [&#123; <span class="attr">model</span>: <span class="title class_">User</span>.<span class="title function_">scope</span>(<span class="string">&quot;active&quot;</span>) &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>通过在模型定义上调用 <code>.scope</code> 来应用作用域,传递一个或多个作用域的名称. <code>.scope</code> 返回一个全功能的模型实例,它具有所有常规的方法:<code>.findAll</code>,<code>.update</code>,<code>.count</code>,<code>.destroy</code>等等.你可以保存这个模型实例并稍后再次使用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">DeletedProjects</span> = <span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&quot;deleted&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">DeletedProjects</span>.<span class="title function_">findAll</span>();</span><br><span class="line"><span class="comment">// 过一段时间</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 让我们再次寻找被删除的项目！</span></span><br><span class="line"><span class="title class_">DeletedProjects</span>.<span class="title function_">findAll</span>();</span><br></pre></td></tr></table></figure>

<p>作用域适用于 <code>.find</code>, <code>.findAll</code>, <code>.count</code>, <code>.update</code>, <code>.increment</code> 和 <code>.destroy</code>.</p>
<p>可以通过两种方式调用作为函数的作用域. 如果作用域没有任何参数,它可以正常调用. 如果作用域采用参数,则传递一个对象:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;random&#x27;</span>, &#123; <span class="attr">method</span>: [<span class="string">&#x27;accessLevel&#x27;</span>, <span class="number">19</span>]&#125;).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> someNumber = <span class="number">42</span> <span class="variable constant_">AND</span> accessLevel &gt;= <span class="number">19</span></span><br></pre></td></tr></table></figure>

<h3 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h3><p>通过将作用域数组传递到 <code>.scope</code> 或通过将作用域作为连续参数传递,可以同时应用多个作用域.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这两个是等价的</span></span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>, <span class="string">&#x27;activeUsers&#x27;</span>).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>([<span class="string">&#x27;deleted&#x27;</span>, <span class="string">&#x27;activeUsers&#x27;</span>]).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects</span><br><span class="line"><span class="variable constant_">INNER</span> <span class="variable constant_">JOIN</span> users <span class="variable constant_">ON</span> projects.<span class="property">userId</span> = users.<span class="property">id</span></span><br><span class="line"><span class="variable constant_">WHERE</span> projects.<span class="property">deleted</span> = <span class="literal">true</span></span><br><span class="line"><span class="variable constant_">AND</span> users.<span class="property">active</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>如果要将其他作用域与默认作用域一起应用,请将键 <code>defaultScope</code> 传递给 <code>.scope</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;defaultScope&#x27;</span>, <span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>();</span><br><span class="line"><span class="variable constant_">SELECT</span> * <span class="variable constant_">FROM</span> projects <span class="variable constant_">WHERE</span> active = <span class="literal">true</span> <span class="variable constant_">AND</span> deleted = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>当调用多个作用域时,后续作用域的键将覆盖以前的作用域(类似于 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a>),除了<code>where</code>和<code>include</code>,它们将被合并. 考虑两个作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">scope1</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">firstName</span>: <span class="string">&#x27;bob&#x27;</span>,</span><br><span class="line">      <span class="attr">age</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scope2</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">age</span>: &#123;</span><br><span class="line">        [<span class="title class_">Op</span>.<span class="property">gt</span>]: <span class="number">30</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">10</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <code>.scope(&#39;scope1&#39;, &#39;scope2&#39;)</code> 将产生以下查询</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">WHERE</span> firstName = <span class="string">&#x27;bob&#x27;</span> <span class="variable constant_">AND</span> age &gt; <span class="number">30</span> <span class="variable constant_">LIMIT</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>注意 <code>scope2</code> 将覆盖 <code>limit</code> 和 <code>age</code>,而 <code>firstName</code> 被保留. <code>limit</code>,<code>offset</code>,<code>order</code>,<code>paranoid</code>,<code>lock</code>和<code>raw</code>字段被覆盖,而<code>where</code>被浅层合并(意味着相同的键将被覆盖). <code>include</code> 的合并策略将在后面讨论.</p>
<p>请注意,多个应用作用域的 <code>attributes</code> 键以这样的方式合并,即始终保留 <code>attributes.exclude</code>. 这允许合并多个作用域,并且永远不会泄漏最终作用域内的敏感字段.</p>
<p>将查找对象直接传递给作用域模型上的<code>findAll</code>(和类似的查找程序)时,适用相同的合并逻辑:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Project</span>.<span class="title function_">scope</span>(<span class="string">&#x27;deleted&#x27;</span>).<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">firstName</span>: <span class="string">&#x27;john&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable constant_">WHERE</span> deleted = <span class="literal">true</span> <span class="variable constant_">AND</span> firstName = <span class="string">&#x27;john&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里的 <code>deleted</code> 作用域与 finder 合并. 如果我们要将 <code>where: &#123; firstName: &#39;john&#39;, deleted: false &#125;</code> 传递给 finder,那么 <code>deleted</code> 作用域将被覆盖.</p>
<h4 id="合并-include"><a href="#合并-include" class="headerlink" title="合并 include"></a>合并 include</h4><p>Include 是根据包含的模型递归合并的. 这是一个非常强大的合并,在 v5 上添加,并通过示例更好地理解.</p>
<p>考虑四种模型:Foo,Bar,Baz 和 Qux,具有如下多种关联:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bar</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Baz</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Qux</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Foo</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Bar</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Baz</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Qux</span>.<span class="title function_">init</span>(&#123; <span class="attr">name</span>: <span class="title class_">Sequelize</span>.<span class="property">STRING</span> &#125;, &#123; sequelize &#125;);</span><br><span class="line"><span class="title class_">Foo</span>.<span class="title function_">hasMany</span>(<span class="title class_">Bar</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;fooId&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">Bar</span>.<span class="title function_">hasMany</span>(<span class="title class_">Baz</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;barId&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">Baz</span>.<span class="title function_">hasMany</span>(<span class="title class_">Qux</span>, &#123; <span class="attr">foreignKey</span>: <span class="string">&quot;bazId&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>现在,考虑 Foo 上定义的以下四个作用域:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">includeEverything</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: &#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">include</span>: <span class="variable language_">this</span>.<span class="property">Qux</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">limitedBars</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">limitedBazs</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">limit</span>: <span class="number">2</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">excludeBazName</span>: &#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">      <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">      <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">exclude</span>: [<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这四个作用域可以很容易地深度合并,例如通过调用 <code>Foo.scope(&#39;includeEverything&#39;, &#39;limitedBars&#39;, &#39;limitedBazs&#39;, &#39;excludeBazName&#39;).findAll()</code>,这完全等同于调用以下内容:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Foo</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">  <span class="attr">include</span>: &#123;</span><br><span class="line">    <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Bar</span>,</span><br><span class="line">    <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">include</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="variable language_">this</span>.<span class="property">Baz</span>,</span><br><span class="line">        <span class="attr">limit</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">attributes</span>: &#123;</span><br><span class="line">          <span class="attr">exclude</span>: [<span class="string">&quot;name&quot;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">include</span>: <span class="variable language_">this</span>.<span class="property">Qux</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>观察四个作用域如何合并为一个. 根据所包含的模型合并作用域的 include. 如果一个作用域包括模型 A 而另一个作用域包括模型 B,则合并结果将包括模型 A 和 B.另一方面,如果两个作用域包括相同的模型 A,但具有不同的参数(例如嵌套 include 或其他属性) ,这些将以递归方式合并,如上所示.</p>
<p>无论应用于作用域的顺序如何,上面说明的合并都以完全相同的方式工作. 如果某个参数由两个不同的作用域设置,那么只会该顺序产生差异 - 这不是上述示例的情况,因为每个作用域都做了不同的事情.</p>
<p>这种合并策略的工作方式与传递给<code>.findAll</code>,<code>.findOne</code>等的参数完全相同.</p>
<h3 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h3><p>Sequelize 与关联有两个不同但相关的作用域概念. 差异是微妙但重要的:</p>
<ul>
<li><strong>关联作用域</strong> 允许你在获取和设置关联时指定默认属性 - 在实现多态关联时很有用. 当使用<code>get</code>,<code>set</code>,<code>add</code>和<code>create</code>相关联的模型函数时,这个作用域仅在两个模型之间的关联上被调用</li>
<li><strong>关联模型上的作用域</strong> 允许你在获取关联时应用默认和其他作用域,并允许你在创建关联时传递作用域模型. 这些作用域都适用于模型上的常规查找和通过关联查找.</li>
</ul>
<p>举个例子,思考模型 Post 和 Comment. Comment 与其他几个模型(图像,视频等)相关联,Comment 和其他模型之间的关联是多态的,这意味着除了外键 <code>commentable_id</code> 之外,注释还存储一个<code>commentable</code>列.</p>
<p>可以使用 association scope 来实现多态关联:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">Post</span>.<span class="title function_">hasMany</span>(<span class="variable language_">this</span>.<span class="property">Comment</span>, &#123;</span><br><span class="line">  <span class="attr">foreignKey</span>: <span class="string">&quot;commentable_id&quot;</span>,</span><br><span class="line">  <span class="attr">scope</span>: &#123;</span><br><span class="line">    <span class="attr">commentable</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当调用 <code>post.getComments()</code> 时,这将自动添加 <code>WHERE commentable = &#39;post&#39;</code>. 类似地,当向帖子添加新的注释时,<code>commentable</code> 会自动设置为 <code>&#39;post&#39;</code>. 关联作用域是为了存活于后台,没有程序员不必担心 - 它不能被禁用. 有关更完整的多态性示例,请参阅 <a target="_blank" rel="noopener" href="https://itfun.tv/documents/272#scopes">关联作用域</a></p>
<p>那么考虑那个 Post 的默认作用域只显示活动的帖子:<code>where: &#123; active: true &#125;</code>. 该作用域存在于相关联的模型(Post)上,而不是像<code>commentable</code> 作用域那样在关联上. 就像在调用<code>Post.findAll()</code> 时一样应用默认作用域,当调用 <code>User.getPosts()</code> 时,它也会被应用 - 这只会返回该用户的活动帖子.</p>
<p>要禁用默认作用域,将 <code>scope: null</code> 传递给 getter: <code>User.getPosts(&#123; scope: null &#125;)</code>. 同样,如果要应用其他作用域,请像这样:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">User</span>.<span class="title function_">getPosts</span>(&#123; <span class="attr">scope</span>: [<span class="string">&quot;scope1&quot;</span>, <span class="string">&quot;scope2&quot;</span>] &#125;);</span><br></pre></td></tr></table></figure>

<p>如果要为关联模型上的作用域创建快捷方式,可以将作用域模型传递给关联. 考虑一个快捷方式来获取用户所有已删除的帖子:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Post</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Model</span> &#123;&#125;</span><br><span class="line"><span class="title class_">Post</span>.<span class="title function_">init</span>(attributes, &#123;</span><br><span class="line">  <span class="attr">defaultScope</span>: &#123;</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">      <span class="attr">active</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">scopes</span>: &#123;</span><br><span class="line">    <span class="attr">deleted</span>: &#123;</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">deleted</span>: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  sequelize,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Post</span>); <span class="comment">// 常规 getPosts 关联</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">hasMany</span>(<span class="title class_">Post</span>.<span class="title function_">scope</span>(<span class="string">&quot;deleted&quot;</span>), &#123; <span class="attr">as</span>: <span class="string">&quot;deletedPosts&quot;</span> &#125;);</span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">getPosts</span>(); <span class="comment">// WHERE active = true</span></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">getDeletedPosts</span>(); <span class="comment">// WHERE deleted = true</span></span><br></pre></td></tr></table></figure>

<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><p>extend&#x2F;helper.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/extend/helper.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 扩展一个格式日期的方法</span></span><br><span class="line">  <span class="title function_">formatTime</span>(<span class="params">val</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(val * <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> d.<span class="title function_">getFullYear</span>();</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>模板中调用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%=helper.formatTime(dateline)%&gt;</span><br></pre></td></tr></table></figure>

<p>其他地方调用</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">helper</span>.<span class="title function_">formatTime</span>(dateline);</span><br></pre></td></tr></table></figure>

<h1 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1. 定义"></a>1. 定义</h2><p>app&#x2F;middleware&#x2F;getIp.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">options: 中间件的配置项，框架会将 app.config[$&#123;middlewareName&#125;] 传递进来。</span></span><br><span class="line"><span class="comment">app: 当前应用 Application 的实例。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">option, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 返回一个异步的方法</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="comment">// 通过option传入额外参数</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(option);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">ip</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h2><p>config&#x2F;config.default.js（配置全局中间件，所有路由都会调用）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function"><span class="params">appInfo</span> =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置全局中间件</span></span><br><span class="line">    config.<span class="property">middleware</span> = [<span class="string">&#x27;getIp&#x27;</span>]; <span class="comment">// 注意驼峰式写法，如果中间件是a_bc.js，则要写成aBc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 配置中间件参数</span></span><br><span class="line">    config.<span class="property">getIp</span> = &#123;</span><br><span class="line">        <span class="attr">ceshi</span>: <span class="number">123</span>,</span><br><span class="line">        <span class="comment">// 通用配置（以下是重点）</span></span><br><span class="line">        <span class="attr">enable</span>:<span class="literal">true</span>, <span class="comment">// 控制中间件是否开启。</span></span><br><span class="line">        <span class="attr">match</span>:<span class="string">&#x27;/news&#x27;</span>, <span class="comment">// 设置只有符合某些规则的请求才会经过这个中间件（匹配路由）</span></span><br><span class="line">        <span class="attr">ignore</span>:<span class="string">&#x27;/shop&#x27;</span> <span class="comment">// 设置符合某些规则的请求不经过这个中间件。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        注意：</span></span><br><span class="line"><span class="comment">        1. match 和 ignore 不允许同时配置</span></span><br><span class="line"><span class="comment">        2. 例如：match:&#x27;/news&#x27;，只要包含/news的任何页面都生效</span></span><br><span class="line"><span class="comment">        **/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// match 和 ignore 支持多种类型的配置方式：字符串、正则、函数（推荐）</span></span><br><span class="line">        <span class="title function_">match</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">          <span class="comment">// 只有 ios 设备才开启</span></span><br><span class="line">          <span class="keyword">const</span> reg = <span class="regexp">/iphone|ipad|ipod/i</span>;</span><br><span class="line">          <span class="keyword">return</span> reg.<span class="title function_">test</span>(ctx.<span class="title function_">get</span>(<span class="string">&#x27;user-agent&#x27;</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3-使用"><a href="#3-使用" class="headerlink" title="3. 使用"></a>3. 使用</h2><h3 id="路由中使用"><a href="#路由中使用" class="headerlink" title="路由中使用"></a>路由中使用</h3><p>app&#x2F;router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 局部中间件（如果只需要局部调用，则不需要在config.default.js中配置）</span></span><br><span class="line">  router.<span class="title function_">get</span>(</span><br><span class="line">    <span class="string">&quot;/admin/:id&quot;</span>,</span><br><span class="line">    app.<span class="property">middleware</span>.<span class="title function_">getIp</span>(&#123;</span><br><span class="line">      <span class="attr">ceshi</span>: <span class="string">&quot;我是admin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    controller.<span class="property">admin</span>.<span class="property">index</span></span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Koa-的中间件（gzip-压缩）"><a href="#使用-Koa-的中间件（gzip-压缩）" class="headerlink" title="使用 Koa 的中间件（gzip 压缩）"></a>使用 Koa 的中间件（gzip 压缩）</h3><p>大大提高网站的访问速度（非常有效）</p>
<p>以 <a target="_blank" rel="noopener" href="https://github.com/koajs/compress">koa-compress</a> 为例，在 Koa 中使用时：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> compress = <span class="built_in">require</span>(<span class="string">&quot;koa-compress&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123; <span class="attr">threshold</span>: <span class="number">2048</span> &#125;;</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">compress</span>(options));</span><br></pre></td></tr></table></figure>

<p>我们按照框架的规范来在应用中加载这个 Koa 的中间件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/compress.js</span></span><br><span class="line"><span class="comment">// koa-compress 暴露的接口(`(options) =&gt; middleware`)和框架对中间件要求一致</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-compress&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">middleware</span>: [<span class="string">&quot;compress&quot;</span>],</span><br><span class="line">  <span class="attr">compress</span>: &#123;</span><br><span class="line">    <span class="attr">threshold</span>: <span class="number">2048</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="表单提交"><a href="#表单提交" class="headerlink" title="表单提交"></a>表单提交</h1><h2 id="post"><a href="#post" class="headerlink" title="post"></a>post</h2><p>app&#x2F;controller&#x2F;home.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">addInput</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&#x27;post&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">add</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    <span class="comment">// 通过ctx.request.body获取post提交数据</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">body</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app&#x2F;view&#x2F;post.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">需要定义：?_csrf=&lt;%=ctx.csrf%&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/add?_csrf=&lt;%=ctx.csrf%&gt;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>app&#x2F;router.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/post&quot;</span>, controller.<span class="property">home</span>.<span class="property">addInput</span>);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/add&quot;</span>, controller.<span class="property">home</span>.<span class="property">add</span>);</span><br></pre></td></tr></table></figure>

<h1 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.设置</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;ceshi&quot;</span>);</span><br><span class="line"><span class="comment">// 2.获取</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.设置中文(加密操作 encrypt: true)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4.设置（其他参数配置）</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;ceshi&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">1000</span> * <span class="number">3600</span> * <span class="number">24</span>, <span class="comment">// 存储24小时，单位毫秒，关闭浏览器cookie还存在</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span></span><br><span class="line">  <span class="attr">signed</span>: <span class="literal">true</span>, <span class="comment">// 签名，防止用户前台修改</span></span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>, <span class="comment">// 加密，注意：get获取时需要解密</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 5.获取时解密</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6.清除cookie</span></span><br><span class="line">ctx.<span class="property">cookies</span>.<span class="title function_">set</span>(<span class="string">&quot;username&quot;</span>, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h1 id="session"><a href="#session" class="headerlink" title="session"></a>session</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.设置</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="string">&quot;测试&quot;</span>;</span><br><span class="line"><span class="comment">// 2.获取</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span>;</span><br><span class="line"><span class="comment">// 3.默认配置（全局配置，config/config.default.js）</span></span><br><span class="line"><span class="built_in">exports</span>.<span class="property">session</span> = &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;EGG_SESS&quot;</span>, <span class="comment">// 设置cookies的key值</span></span><br><span class="line">  <span class="attr">maxAge</span>: <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>, <span class="comment">// 1 天，过期时间</span></span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="comment">// 设置键值对是否可以被 js 访问，默认为 true，不允许被 js 访问。</span></span><br><span class="line">  <span class="attr">encrypt</span>: <span class="literal">true</span>, <span class="comment">// 加密</span></span><br><span class="line">  <span class="attr">renew</span>: <span class="literal">true</span>, <span class="comment">// 每次刷新页面都会被延期</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 4.动态配置</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">maxAge</span> = <span class="number">5000</span>; <span class="comment">// 5秒的过期时间</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="string">&quot;测试&quot;</span>;</span><br><span class="line"><span class="comment">// 5.清空session</span></span><br><span class="line">ctx.<span class="property">session</span>.<span class="property">username</span> = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h1 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/schedule/ceshi.js</span></span><br><span class="line"><span class="keyword">var</span> i = <span class="number">1</span>;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 设置定时任务的执行间隔等配置</span></span><br><span class="line">  <span class="attr">schedule</span>: &#123;</span><br><span class="line">    <span class="attr">interval</span>: <span class="string">&quot;5s&quot;</span>, <span class="comment">// 每5秒执行一次</span></span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;all&quot;</span>, <span class="comment">// 指定所有的 worker 都需要执行</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 任务</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">task</span>(<span class="params">ctx</span>) &#123;</span><br><span class="line">    ++i;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><h2 id="1-context"><a href="#1-context" class="headerlink" title="1. context"></a>1. context</h2><h3 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">ceshi</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 通过ctx中的curl方法获取数据</span></span><br><span class="line">    <span class="keyword">let</span> r = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="title function_">curl</span>(<span class="string">&#x27;http://www.phonegap100.com/appapi.php?a=getPortalList&amp;catid=20&amp;page=1&#x27;</span>);</span><br><span class="line">    <span class="comment">// 将buffer类型数据转为json类型</span></span><br><span class="line">    <span class="keyword">let</span> &#123; result &#125; = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(r.<span class="property">data</span>)</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="常用插件"><a href="#常用插件" class="headerlink" title="常用插件"></a>常用插件</h1><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-cache">https://www.npmjs.com/package/egg-cache</a><br><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-redis">https://www.npmjs.com/package/egg-redis</a></p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p><a target="_blank" rel="noopener" href="https://github.com/temool/egg-validate-plus">https://github.com/temool/egg-validate-plus</a></p>
<h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-jwt">https://www.npmjs.com/package/egg-jwt</a></p>
<p>前端访问：header 头添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Authorization:&quot;Bearer token值&quot;</span></span><br><span class="line"><span class="title class_">Authorization</span>: <span class="string">&quot;Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6MTIzLCJpYXQiOjE1NzkxOTQxNTN9.Ml5B02ZPfYo78QwJic-Jdp2LUi2_AU0RGNgPhhJH--o&quot;</span>;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/Koa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/Koa/" class="post-title-link" itemprop="url">Koa</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:08:25" itemprop="dateCreated datePublished" datetime="2022-11-08T17:08:25+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:19" itemprop="dateModified" datetime="2022-12-08T17:09:19+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>通过利用 async 函数，Koa 帮你丢弃回调函数，并有力地增强错误处理。 Koa 并没有捆绑任何中间件， 而是提供了一套优雅的方法，帮助您快速而愉快地编写服务端应用程序。</p>
<h1 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h1><ul>
<li>需先建对象与 express 不同：const app &#x3D; new Koa()</li>
<li>ctx(context)封装了 res 和 req<ul>
<li>返回使用 ctx.body，可使用 async 和 await<ul>
<li>ctx.body 最终会转换为 res.end</li>
<li>执行时机：洋葱模型的最外层，第一个中间件 promise 有结果后，将 ctx.body 转换为 res.end()</li>
<li>异步使用时，不可放置异步函数中，需放置在 await 的 promise 中</li>
</ul>
</li>
<li>也可直接使用 ctx.res 和 ctx.req</li>
<li>常用属性：req、res、request、response</li>
</ul>
</li>
<li>ctx 属性：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&quot;koa&quot;</span>); <span class="comment">// ⼀个类</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件，可以使⽤async await</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="comment">// throw new Error(&#x27;出错了&#x27;)</span></span><br><span class="line">  <span class="comment">// ctx封装了req和res的功能，这⾥相当于res.end</span></span><br><span class="line">  <span class="comment">// 1、有输出，ctx.body在promise结果后</span></span><br><span class="line">  ctx.<span class="property">body</span> = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;zhuwa&quot;</span>);</span><br><span class="line">  <span class="comment">// 2、无输出</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&quot;zhuwa&quot;</span>;</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误事件</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="keyword">function</span> (<span class="params">err, ctx</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">  ctx.<span class="property">res</span>.<span class="title function_">end</span>(<span class="string">`500 错误`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3002</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;koa server started at 3002&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// req request res response的区别</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">req</span>.<span class="property">path</span>); <span class="comment">// 原⽣的req</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">path</span>); <span class="comment">// koa封装的request</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">req</span>.<span class="property">path</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">path</span>); <span class="comment">// 代理到request</span></span><br><span class="line">  ctx.<span class="property">body</span> = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;zhuwa&quot;</span>); <span class="comment">// ctx封装了req和res的功能，这⾥相当于res.end</span></span><br><span class="line">  <span class="comment">//ctx.throw(401, &quot;err msg&quot;);</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="中间件-洋葱模型"><a href="#中间件-洋葱模型" class="headerlink" title="中间件(洋葱模型)"></a>中间件(洋葱模型)</h2><p>使用 app.use，回调函数只能传一个，多个需多次注册<br>异步流程会等待后续中间件有结果时返回<br>在 koa 中，中间件被 next() 方法分成了两部分。next() 方法上面部分会先执行，下面部门会在后续中间件执行全部结束之后再执行。</p>
<ul>
<li>多个中间件会形成一个栈结构（middlestack），以＂先进后出＂（first-in-last- out）的顺序执行。</li>
<li>最外层的中间件首先执行。</li>
<li>调用 next 函数，把执行权交给下一个中间件。</li>
<li>最内层的中间件最后执行。</li>
<li>执行结束后，把执行权交回上一层的中间件。</li>
<li>最外层的中间件收回执行权之后，执行 next 函数后面的代码.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1-1&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;1-2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2-1&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;2-2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3-1&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;3-2&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//输出：1-1、2-1、3-1、3-2、2-2、1-2</span></span><br></pre></td></tr></table></figure>

<h2 id="与-express-比较"><a href="#与-express-比较" class="headerlink" title="与 express 比较"></a>与 express 比较</h2><table>
<thead>
<tr>
<th>框架</th>
<th>express</th>
<th>koa</th>
</tr>
</thead>
<tbody><tr>
<td>模型</td>
<td>线性模型</td>
<td>洋葱模型</td>
</tr>
<tr>
<td>表现</td>
<td>同步表现为洋葱模型，但遇到异步，即使使⽤了 await next()也不会等待，会继续向下执⾏，因为 next()返回 undefined</td>
<td>⽆论同步，还是异步，都是洋葱模型，可以使⽤ await 和 next() 来等待下⼀个中间件执⾏完成</td>
</tr>
<tr>
<td>原理</td>
<td>使⽤回调, next()，返回 undefined</td>
<td>next()，返回 promise，会把中间件⽤ promise 包裹起来</td>
</tr>
<tr>
<td>错误</td>
<td>错误处理是在⼀个特殊签名的中间件中完成的，它必须被添加到链的后⾯才能捕获到前⾯的错误</td>
<td>可以使⽤ try catch 捕获中间件错误</td>
</tr>
<tr>
<td>注意</td>
<td>await next() 也不会等待下⼀个中间件异步完成</td>
<td>要使⽤ await 来等待异步操作；注意 res.end 的时机，等最外层的中间件（也就是第⼀个中间件）的 promise 有结果后，响应就会被返回 ctx.body -&gt;res.end(ctx.body)</td>
</tr>
</tbody></table>
<h2 id="中间件编写"><a href="#中间件编写" class="headerlink" title="中间件编写"></a>中间件编写</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//编写⼀个计算请求的时⻓的中间件</span></span><br><span class="line"><span class="comment">// koa 中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">ctx, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&quot;serviceTime&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&quot;serviceTime&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// express 中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">  res.<span class="title function_">once</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">在最顶层捕获未处理的错误</div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可以使⽤try catch 捕获中间件错误</span></span><br><span class="line"><span class="comment">// 在最顶层捕获未处理的错误</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// await 可以让异步函数的错误得到捕获</span></span><br><span class="line">   		<span class="keyword">await</span> <span class="title function_">next</span>();</span><br><span class="line">   &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">   		<span class="keyword">const</span> status = err.<span class="property">status</span> || <span class="number">500</span>;</span><br><span class="line">   		ctx.<span class="property">status</span> = status;</span><br><span class="line">   		ctx.<span class="property">type</span> = <span class="string">&quot;html&quot;</span>;</span><br><span class="line">   		ctx.<span class="property">body</span> = <span class="string">`</span></span><br><span class="line"><span class="string">   			&lt;b&gt;<span class="subst">$&#123;status&#125;</span>&lt;/b&gt; <span class="subst">$&#123;err&#125;</span></span></span><br><span class="line"><span class="string">   		`</span>;</span><br><span class="line">   		<span class="comment">// emmit</span></span><br><span class="line">   		ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&quot;error&quot;</span>, err, ctx);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">ctx.<span class="property">body</span> = <span class="string">`Uh-oh: <span class="subst">$&#123;err.message&#125;</span>`</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error handler:&#x27;</span>, err.<span class="property">message</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (ctx.<span class="property">query</span>.<span class="property">greet</span> !== <span class="string">&#x27;world&#x27;</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;can only greet &quot;world&quot;&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Sending response&#x27;</span>)</span><br><span class="line">ctx.<span class="property">status</span> = <span class="number">200</span></span><br><span class="line">ctx.<span class="property">body</span> = <span class="string">`Hello <span class="subst">$&#123;ctx.query.greet&#125;</span> from Koa`</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以使⽤总的错误事件来统⼀处理</span></span><br><span class="line"><span class="comment">// 错误事件</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, <span class="keyword">function</span>(<span class="params">err</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">``</span></span><br><span class="line"></span><br><span class="line">## 常用中间件</span><br><span class="line"></span><br><span class="line">- koa-router：路由</span><br><span class="line">- koa-<span class="keyword">static</span>：静态资源</span><br><span class="line">- koa-mounut：子路由</span><br><span class="line">- koa-body：body解析</span><br><span class="line">- koa-parameter：参数校验</span><br><span class="line"><span class="string">``</span><span class="string">`javascript</span></span><br><span class="line"><span class="string">//1、koa-router</span></span><br><span class="line"><span class="string">const KoaRouter = require(&#x27;koa-router&#x27;)</span></span><br><span class="line"><span class="string">router.get(&#x27;/page&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string"> 		ctx.body = await new Promise((resolve, reject) =&gt; &#123;</span></span><br><span class="line"><span class="string"> 				resolve(&#x27;ok&#x27;)</span></span><br><span class="line"><span class="string"> 		&#125;)</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">// 注册中间件</span></span><br><span class="line"><span class="string">app.use(router.routes())</span></span><br><span class="line"><span class="string">// 添加前缀</span></span><br><span class="line"><span class="string">const router = new Router(&#123; prefix: &#x27;/user&#x27; &#125;)</span></span><br><span class="line"><span class="string">// 重定向</span></span><br><span class="line"><span class="string">router.get(&#x27;/home&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string"> 	ctx.redirect(&#x27;http://baidu.com&#x27;);</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">// 路由参数</span></span><br><span class="line"><span class="string">router.get(&#x27;/:id&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   ctx.body = &#123;</span></span><br><span class="line"><span class="string">     msg: &#x27;index page&#x27;,</span></span><br><span class="line"><span class="string">     params: ctx.params.id // 通过 ctx.params.id 获取到的是 1</span></span><br><span class="line"><span class="string">   &#125;;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">router.get(&#x27;/&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   ctx.body = &#123;</span></span><br><span class="line"><span class="string">     msg: &#x27;index page&#x27;,</span></span><br><span class="line"><span class="string">     query: ctx.query // ctx.query会获取url后⾯携带的参数对象</span></span><br><span class="line"><span class="string">   &#125;;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">// allowedMethod</span></span><br><span class="line"><span class="string">// 如果没有这⼀⾏, 当使⽤其他请求⽅式请求user时, 会提示404</span></span><br><span class="line"><span class="string">// 如果有这⼀⾏, 当使⽤其他请求⽅式请求user时, 提示405 method not allowed</span></span><br><span class="line"><span class="string">app.use(router.allowedMethod());</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//2、koa-static</span></span><br><span class="line"><span class="string">const KoaStatic = require(&#x27;koa-static&#x27;)</span></span><br><span class="line"><span class="string">// 动态加载静态资源</span></span><br><span class="line"><span class="string">app.use(KoaStatic(path.resolve(__dirname, &#x27;../dist/assets&#x27;)))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//3、koa-mounut</span></span><br><span class="line"><span class="string">const KoaMount = require(&#x27;koa-mount&#x27;)</span></span><br><span class="line"><span class="string">// 添加前缀</span></span><br><span class="line"><span class="string">app.use(KoaMount(&#x27;/assets&#x27;, KoaStatic(path.resolve(__dirname, &#x27;../dist/assets&#x27;))))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//4、koa-body</span></span><br><span class="line"><span class="string">const bodyparser = require(&#x27;koa-body&#x27;);</span></span><br><span class="line"><span class="string">// 在注册此中间件之后, 会在 ctx 上下⽂注⼊ ctx.request.body 属性 ⽤于获取客户端传递来的数据</span></span><br><span class="line"><span class="string">app.use(bodyparser());</span></span><br><span class="line"><span class="string">router.post(&#x27;/&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   ctx.body = &#123;</span></span><br><span class="line"><span class="string">   code: 200,</span></span><br><span class="line"><span class="string">   		//body 可以获取form表单数据, json数据</span></span><br><span class="line"><span class="string">   		msg: ctx.request.body</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//5、koa-parameter</span></span><br><span class="line"><span class="string">const parameter = require(&#x27;koa-parameter&#x27;);</span></span><br><span class="line"><span class="string">parameter(app);</span></span><br><span class="line"><span class="string">router.post(&#x27;/&#x27;, async ctx =&gt; &#123;</span></span><br><span class="line"><span class="string">   //接收⼀个对象</span></span><br><span class="line"><span class="string">   ctx.verifyParams(&#123;</span></span><br><span class="line"><span class="string">     // 校验的简写形式</span></span><br><span class="line"><span class="string">     username: &#x27;string&#x27;,</span></span><br><span class="line"><span class="string">     password: &#123; type: &#x27;string&#x27;, required: true &#125; // 或者也可以这样</span></span><br><span class="line"><span class="string">   &#125;)</span></span><br><span class="line"><span class="string">   ctx.body = &#123; code: 1 &#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span><span class="string">`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## koa-compose</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">中间件合并处理</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"><span class="title function_">compose</span>(stack)(&#123;&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>stack 是数组，收集了多个 async 函数，即返回值是 promise，内部有异步，总之就是收集了所有的异步操作；</li>
<li>compose 是核心代码，函数接收 stack 数组返回一个匿名函数（这里采用了闭包）；</li>
<li>核心代码就是执行这个匿名函数；</li>
</ul>
<p>我们来看下 compose 函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compose</span>(<span class="params">middleware</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(middleware))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot;Middleware stack must be an array!&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> fn <span class="keyword">of</span> middleware) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fn !== <span class="string">&quot;function&quot;</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot;Middleware must be composed of functions!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">context</span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> &#123;<span class="type">Promise</span>&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@api</span> <span class="variable">public</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 核心匿名函数：接收上下文对象context和自定义next函数；</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">context, next</span>) &#123;</span><br><span class="line">    <span class="comment">// last called middleware #</span></span><br><span class="line">    <span class="keyword">let</span> index = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatch</span>(<span class="number">0</span>); <span class="comment">//调用第一个元素函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">dispatch</span>(<span class="params">i</span>) &#123;</span><br><span class="line">      <span class="comment">// 防止连续执行两次next</span></span><br><span class="line">      <span class="keyword">if</span> (i &lt;= index)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;next() called multiple times&quot;</span>));</span><br><span class="line">      index = i;</span><br><span class="line">      <span class="keyword">let</span> fn = middleware[i];</span><br><span class="line">      <span class="keyword">if</span> (i === middleware.<span class="property">length</span>) fn = next; <span class="comment">//此处i对应的fn是undefined，也支持自定义next</span></span><br><span class="line">      <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(); <span class="comment">// 最后一个直接返回</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 递归去执行dispatch，本质是获取下一个fn元素</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="title function_">fn</span>(context, dispatch.<span class="title function_">bind</span>(<span class="literal">null</span>, i + <span class="number">1</span>)));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Context-上下文"><a href="#Context-上下文" class="headerlink" title="Context(上下文)"></a>Context(上下文)</h1><p>Koa Context 将 node 的 request 和 response 对象封装到单个对象中，为编写 Web 应用程序和 API 提供了许多有用的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  ctx; <span class="comment">// 这是 Context</span></span><br><span class="line">  ctx.<span class="property">request</span>; <span class="comment">// 这是 koa Request</span></span><br><span class="line">  ctx.<span class="property">response</span>; <span class="comment">// 这是 koa Response</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>为方便起见许多上下文的访问器和方法直接委托给它们的 ctx.request 或 ctx.response ，不然的话它们是相同的。 例如 ctx.type 和 ctx.length 委托给 response 对象，ctx.path 和 ctx.method 委托给 request。</p>
<h2 id="ctx-req"><a href="#ctx-req" class="headerlink" title="ctx.req"></a>ctx.req</h2><p>Node 的 request 对象.</p>
<h2 id="ctx-res"><a href="#ctx-res" class="headerlink" title="ctx.res"></a>ctx.res</h2><p>Node 的 response 对象.<br>绕过 Koa 的 response 处理是 <strong>不被支持的</strong>. 应避免使用以下 node 属性：</p>
<ul>
<li>res.statusCode</li>
<li>res.writeHead()</li>
<li>res.write()</li>
<li>res.end()</li>
</ul>
<h1 id="别名"><a href="#别名" class="headerlink" title="别名"></a>别名</h1><h2 id="Request-别名"><a href="#Request-别名" class="headerlink" title="Request 别名"></a>Request 别名</h2><p>以下访问器和 <a target="_blank" rel="noopener" href="https://koa.bootcss.com/#request">Request</a> 别名等效：</p>
<ul>
<li>ctx.header</li>
<li>ctx.headers</li>
<li>ctx.method</li>
<li>ctx.method&#x3D;</li>
<li>ctx.url</li>
<li>ctx.url&#x3D;</li>
<li>ctx.originalUrl</li>
<li>ctx.origin</li>
<li>ctx.href</li>
<li>ctx.path</li>
<li>ctx.path&#x3D;</li>
<li>ctx.query</li>
<li>ctx.query&#x3D;</li>
<li>ctx.querystring</li>
<li>ctx.querystring&#x3D;</li>
<li>ctx.host</li>
<li>ctx.hostname</li>
<li>ctx.fresh</li>
<li>ctx.stale</li>
<li>ctx.socket</li>
<li>ctx.protocol</li>
<li>ctx.secure</li>
<li>ctx.ip</li>
<li>ctx.ips</li>
<li>ctx.subdomains</li>
<li>ctx.is()</li>
<li>ctx.accepts()</li>
<li>ctx.acceptsEncodings()</li>
<li>ctx.acceptsCharsets()</li>
<li>ctx.acceptsLanguages()</li>
<li>ctx.get()</li>
</ul>
<h2 id="Response-别名"><a href="#Response-别名" class="headerlink" title="Response 别名"></a>Response 别名</h2><p>以下访问器和 <a target="_blank" rel="noopener" href="https://koa.bootcss.com/#response">Response</a> 别名等效：</p>
<ul>
<li>ctx.body</li>
<li>ctx.body&#x3D;</li>
<li>ctx.status</li>
<li>ctx.status&#x3D;</li>
<li>ctx.message</li>
<li>ctx.message&#x3D;</li>
<li>ctx.length&#x3D;</li>
<li>ctx.length</li>
<li>ctx.type&#x3D;</li>
<li>ctx.type</li>
<li>ctx.headerSent</li>
<li>ctx.redirect()</li>
<li>ctx.attachment()</li>
<li>ctx.set()</li>
<li>ctx.append()</li>
<li>ctx.remove()</li>
<li>ctx.lastModified&#x3D;</li>
<li>ctx.etag&#x3D;</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/Redis/" class="post-title-link" itemprop="url">Redis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:07:57" itemprop="dateCreated datePublished" datetime="2022-11-08T17:07:57+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:20" itemprop="dateModified" datetime="2022-12-08T17:09:20+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>Redis 是使用 c 语言开发的一个高性能键值数据库。<br>Redis 可以通过一些键值类型来存储数据。<br>键值类型：</p>
<ul>
<li>String 字符类型</li>
<li>map 散列类型</li>
<li>list 列表类型</li>
<li>set 集合类型</li>
<li>sortedset 有序集合类型</li>
</ul>
<p>Redis 使用起来就像是 JS 中的 Map 数据结构（但 key 只能是字符串，value 要符合支持的数据结构）。在业务中，我们可以用 Redis 来存储用户的鉴权 token，用户带着 token 访问时，可以快速从 redis 取出并对比。</p>
<h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><ul>
<li>缓存（数据查询、短连接、新闻内容、商品内容等等）。（最多使用）</li>
<li>分布式集群架构中的 session 分离。</li>
<li>聊天室的在线好友列表。</li>
<li>任务队列。（秒杀、抢购、12306 等等）</li>
<li>应用排行榜。</li>
<li>网站访问统计。</li>
<li>数据过期处理（可以精确到毫秒）</li>
</ul>
<h1 id="安装-macOS"><a href="#安装-macOS" class="headerlink" title="安装(macOS)"></a>安装(macOS)</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install redis</span><br></pre></td></tr></table></figure>

<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 前台启动redis服务器</span></span><br><span class="line">redis-server</span><br><span class="line"><span class="comment">// server后台启动</span></span><br><span class="line">redis-server --daemonize yes</span><br><span class="line"><span class="comment">// launch后台启动</span></span><br><span class="line">brew services start redis</span><br><span class="line"><span class="comment">// 关闭后台启动</span></span><br><span class="line">brew services stop redis</span><br><span class="line"><span class="comment">// 查看信息</span></span><br><span class="line">brew services info redis</span><br></pre></td></tr></table></figure>

<h1 id="连接-Redis"><a href="#连接-Redis" class="headerlink" title="连接 Redis"></a>连接 Redis</h1><p>启动 Redis 服务后,连接 redis 数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Redis命令行客户端</span><br><span class="line">redis-cli</span><br><span class="line">// 连接远程服务</span><br><span class="line">redis-cli -h host -p port -a password</span><br></pre></td></tr></table></figure>

<h1 id="查看-Redis-状态"><a href="#查看-Redis-状态" class="headerlink" title="查看 Redis 状态"></a>查看 Redis 状态</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep -i redis</span><br></pre></td></tr></table></figure>

<h1 id="停止-Redis"><a href="#停止-Redis" class="headerlink" title="停止 Redis"></a>停止 Redis</h1><p>防止中止进程导致数据丢失,应该使用<code>shutdown</code>命令停止 Redis.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 此方法关闭 redis-server启动的进程</span><br><span class="line">redis-cli shutdown</span><br></pre></td></tr></table></figure>

<p>另一种方法是杀进程,进程号通过查看 Redis 状态得知.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 进程号</span><br></pre></td></tr></table></figure>

<h1 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回所有KEY</span></span><br><span class="line">KEYS *</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取key的类型</span></span><br><span class="line">TYPE my*</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询某个key是否存在</span></span><br><span class="line">EXISTS key [key...]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将key改名为newkey</span></span><br><span class="line">RENAME key newkey</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从当前数据库随机返回(非删除)一个key</span></span><br><span class="line">RANDOMKEY</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空当前数据库内容</span></span><br><span class="line">FLUSHDB</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清空所有数据库内容</span></span><br><span class="line">FLUSHALL</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将当前数据库的key移动的指定db</span></span><br><span class="line">MOVE key db</span><br></pre></td></tr></table></figure>

<h2 id="设置过期时间"><a href="#设置过期时间" class="headerlink" title="设置过期时间"></a>设置过期时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为指定key设置过期时间,当key过期就删除</span></span><br><span class="line">EXPIRE key seconds</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以毫秒为单位</span></span><br><span class="line">PEXPIRE key milliseconds</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过时间戳设置</span></span><br><span class="line">EXPIREAT key timessamp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以毫秒为单位</span></span><br><span class="line">PEXPIREAT key milliseconds-timessamp</span><br></pre></td></tr></table></figure>

<h2 id="获取过期时间"><a href="#获取过期时间" class="headerlink" title="获取过期时间"></a>获取过期时间</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返回指定key的剩余时间(秒)</span></span><br><span class="line">TTL key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">毫秒单位</span></span><br><span class="line">PTTL key</span><br></pre></td></tr></table></figure>

<h1 id="多数据库"><a href="#多数据库" class="headerlink" title="多数据库"></a>多数据库</h1><p>默认分配 16 个数据库,数字 0-15.默认使用 0 数据库.数据库相对独立,可以配置参数<code>databases</code>修改个数.</p>
<h2 id="切换数据库-SELECT"><a href="#切换数据库-SELECT" class="headerlink" title="切换数据库[SELECT]"></a>切换数据库[SELECT]</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SELECT</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="知识体系"><a href="#知识体系" class="headerlink" title="知识体系"></a>知识体系</h1><p>多个数据库并不是完全独立.如果要不同应用存储建议开多个 Redis 实例.<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046045649-ac030646-fb19-4dee-b71a-5e40bbaf3e18.png#averageHue=%23fcfcfc&clientId=u429e2987-0087-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=1694&id=u9cbd2945&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1694&originWidth=2650&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=329193&status=done&style=none&taskId=u36381aa8-c655-4117-8c4c-26305d9a989&title=&width=2650" alt="image.png"></p>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>Redis 数据库支持五种数据类型。</p>
<ul>
<li>字符串（string）</li>
<li>哈希（hash）</li>
<li>列表（list）</li>
<li>集合（set）</li>
<li>有序集合（sorted set）</li>
<li>位图 ( Bitmaps )</li>
<li>基数统计 ( HyperLogLogs )</li>
</ul>
<h1 id="5-种基础数据类型"><a href="#5-种基础数据类型" class="headerlink" title="5 种基础数据类型"></a>5 种基础数据类型</h1><h2 id="String-字符串"><a href="#String-字符串" class="headerlink" title="String 字符串"></a>String 字符串</h2><p>String 是一组字节。在 Redis 数据库中，字符串是二进制安全的。<br>这意味着它们具有已知长度，并且不受任何特殊终止字符的影响。<br>redis 的 string 可以包含任何数据。如数字，字符串，jpg 图片或者序列化的对象。<br>可以在一个字符串中存储最多 512 M 的内容。<br>使用 <code>SET</code> 命令在 <code>name</code> 键中存储字符串 redis.com.cn，然后使用 <code>GET</code> 命令查询 name。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">SET</span> name <span class="string">&quot;redis.com.cn&quot;</span></span><br><span class="line"><span class="variable constant_">OK</span></span><br><span class="line"><span class="variable constant_">GET</span> name</span><br><span class="line"><span class="string">&quot;redis.com.cn&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="命令使用"><a href="#命令使用" class="headerlink" title="命令使用"></a>命令使用</h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>获取存储在给定键中的值</td>
<td>GET name</td>
</tr>
<tr>
<td>SET</td>
<td>设置存储在给定键中的值</td>
<td>SET name value</td>
</tr>
<tr>
<td>DEL</td>
<td>删除存储在给定键中的值</td>
<td>DEL name</td>
</tr>
<tr>
<td>INCR</td>
<td>将键存储的值加 1</td>
<td>INCR key</td>
</tr>
<tr>
<td>DECR</td>
<td>将键存储的值减 1</td>
<td>DECR key</td>
</tr>
<tr>
<td>INCRBY</td>
<td>将键存储的值加上整数</td>
<td>INCRBY key amount</td>
</tr>
<tr>
<td>DECRBY</td>
<td>将键存储的值减去整数</td>
<td>DECRBY key amount</td>
</tr>
</tbody></table>
<h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; set hello world</span><br><span class="line"><span class="variable constant_">OK</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get hello</span><br><span class="line"><span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; del hello</span><br><span class="line">(integer) <span class="number">1</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get hello</span><br><span class="line">(nil)</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; set counter <span class="number">2</span></span><br><span class="line"><span class="variable constant_">OK</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; incr counter</span><br><span class="line">(integer) <span class="number">3</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; incrby counter <span class="number">100</span></span><br><span class="line">(integer) <span class="number">103</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;103&quot;</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; decr counter</span><br><span class="line">(integer) <span class="number">102</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; get counter</span><br><span class="line"><span class="string">&quot;102&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="实战场景"><a href="#实战场景" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>缓存</strong>： 经典使用场景，把常用信息，字符串，图片或者视频等信息放到 redis 中，redis 作为缓存层，mysql 做持久化层，降低 mysql 的读写压力。</li>
<li><strong>计数器</strong>：redis 是单线程模型，一个命令执行完才会执行下一个，同时数据可以一步落地到其他的数据源。</li>
<li><strong>session</strong>：常见方案 spring session + redis 实现 session 共享，</li>
</ul>
<h2 id="List-列表"><a href="#List-列表" class="headerlink" title="List 列表"></a>List 列表</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis中的List其实就是链表（Redis用双端链表实现List）。</div>
使用List结构，我们可以轻松地实现最新消息排队功能（比如新浪微博的TimeLine）。
List的另一个应用就是消息队列，可以利用List的 PUSH 操作，将任务存放在List中，然后工作线程再用 POP 操作将任务取出进行执行。

<h3 id="命令使用-1"><a href="#命令使用-1" class="headerlink" title="命令使用"></a>命令使用</h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>RPUSH</td>
<td>将给定值推入到列表右端</td>
<td>RPUSH key value</td>
</tr>
<tr>
<td>LPUSH</td>
<td>将给定值推入到列表左端</td>
<td>LPUSH key value</td>
</tr>
<tr>
<td>RPOP</td>
<td>从列表的右端弹出一个值，并返回被弹出的值</td>
<td>RPOP key</td>
</tr>
<tr>
<td>LPOP</td>
<td>从列表的左端弹出一个值，并返回被弹出的值</td>
<td>LPOP key</td>
</tr>
<tr>
<td>LRANGE</td>
<td>获取列表在给定范围上的所有值</td>
<td>LRANGE key 0 -1</td>
</tr>
<tr>
<td>LINDEX</td>
<td>通过索引获取列表中的元素。你也可以使用负数下标，以 -1 表示列表的最后一个元素， -2 表示列表的倒数第二个元素，以此类推。</td>
<td>LINDEX key index</td>
</tr>
</tbody></table>
<h3 id="使用列表的技巧"><a href="#使用列表的技巧" class="headerlink" title="使用列表的技巧"></a>使用列表的技巧</h3><ul>
<li>lpush+lpop&#x3D;Stack(栈)</li>
<li>lpush+rpop&#x3D;Queue（队列）</li>
<li>lpush+ltrim&#x3D;Capped Collection（有限集合）</li>
<li>lpush+brpop&#x3D;Message Queue（消息队列）</li>
</ul>
<h3 id="命令执行-1"><a href="#命令执行-1" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lpush mylist 1 2 ll ls mem</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) &quot;mem&quot;</span><br><span class="line">2) &quot;ls&quot;</span><br><span class="line">3) &quot;ll&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;1&quot;</span><br><span class="line">127.0.0.1:6379&gt; lindex mylist -1</span><br><span class="line">&quot;1&quot;</span><br><span class="line">127.0.0.1:6379&gt; lindex mylist 10        # index不在 mylist 的区间范围内</span><br><span class="line">(nil)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="实战场景-1"><a href="#实战场景-1" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>微博 TimeLine</strong>: 有人发布微博，用 lpush 加入时间轴，展示新的列表信息。</li>
<li><strong>消息队列</strong></li>
</ul>
<h2 id="Set-集合"><a href="#Set-集合" class="headerlink" title="Set 集合"></a>Set 集合</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 的 Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。</div>
Redis 中集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是 O(1)。

<ul>
<li><strong>图例</strong></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046794639-85a5122f-003f-44fc-91ee-86f558d484ea.png#averageHue=%23f4f4f4&clientId=u429e2987-0087-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=264&id=ucff4cff4&margin=%5Bobject%20Object%5D&name=image.png&originHeight=544&originWidth=776&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=84607&status=done&style=none&taskId=u38c54c41-b5d6-410b-a6f3-c338680a070&title=&width=376" alt="image.png"></p>
<h3 id="命令使用-2"><a href="#命令使用-2" class="headerlink" title="命令使用"></a><strong>命令使用</strong></h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>SADD</td>
<td>向集合添加一个或多个成员</td>
<td>SADD key value</td>
</tr>
<tr>
<td>SCARD</td>
<td>获取集合的成员数</td>
<td>SCARD key</td>
</tr>
<tr>
<td>SMEMBERS</td>
<td>返回集合中的所有成员</td>
<td>SMEMBERS key member</td>
</tr>
<tr>
<td>SISMEMBER</td>
<td>判断 member 元素是否是集合 key 的成员</td>
<td>SISMEMBER key member</td>
</tr>
</tbody></table>
<p>其它一些集合操作，请参考这里<a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-sets.html">https://www.runoob.com/redis/redis-sets.html</a></p>
<h3 id="命令执行-2"><a href="#命令执行-2" class="headerlink" title="命令执行"></a>命令执行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd myset hao hao1 xiaohao hao</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) &quot;xiaohao&quot;</span><br><span class="line">2) &quot;hao1&quot;</span><br><span class="line">3) &quot;hao&quot;</span><br><span class="line">127.0.0.1:6379&gt; sismember myset hao</span><br><span class="line">(integer) 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="实战场景-2"><a href="#实战场景-2" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>标签</strong>（tag）,给用户添加标签，或者用户给消息添加标签，这样有同一标签或者类似标签的可以给推荐关注的事或者关注的人。</li>
<li><strong>点赞，或点踩，收藏等</strong>，可以放到 set 中实现</li>
</ul>
<h2 id="Hash-散列"><a href="#Hash-散列" class="headerlink" title="Hash 散列"></a>Hash 散列</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis hash 是一个 string 类型的 field（字段） 和 value（值） 的映射表，hash 特别适合用于存储对象。</div>
哈希是键值对的集合。在 Redis 中，哈希是字符串字段和字符串值之间的映射。因此，它们适合表示对象。

<ul>
<li><strong>图例</strong></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046794744-59fa1954-a3fb-4f6b-b9db-2ad186213ecb.png#averageHue=%23f1f1f1&clientId=u429e2987-0087-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=314&id=ue8a23193&margin=%5Bobject%20Object%5D&name=image.png&originHeight=582&originWidth=742&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=110423&status=done&style=none&taskId=ub674fa52-35d2-45ae-8524-6dbbc3ae697&title=&width=400" alt="image.png"></p>
<h3 id="命令使用-3"><a href="#命令使用-3" class="headerlink" title="命令使用"></a><strong>命令使用</strong></h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>HSET</td>
<td>添加键值对</td>
<td>HSET hash-key sub-key1 value1</td>
</tr>
<tr>
<td>HGET</td>
<td>获取指定散列键的值</td>
<td>HGET hash-key key1</td>
</tr>
<tr>
<td>HGETALL</td>
<td>获取散列中包含的所有键值对</td>
<td>HGETALL hash-key</td>
</tr>
<tr>
<td>HDEL</td>
<td>如果给定键存在于散列中，那么就移除这个键</td>
<td>HDEL hash-key sub-key1</td>
</tr>
</tbody></table>
<h3 id="命令执行-3"><a href="#命令执行-3" class="headerlink" title="命令执行"></a><strong>命令执行</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset user name1 hao</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hset user email1 hao@163.com</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user</span><br><span class="line">1) &quot;name1&quot;</span><br><span class="line">2) &quot;hao&quot;</span><br><span class="line">3) &quot;email1&quot;</span><br><span class="line">4) &quot;hao@163.com&quot;</span><br><span class="line">127.0.0.1:6379&gt; hget user user</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; hget user name1</span><br><span class="line">&quot;hao&quot;</span><br><span class="line">127.0.0.1:6379&gt; hset user name2 xiaohao</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hset user email2 xiaohao@163.com</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user</span><br><span class="line">1) &quot;name1&quot;</span><br><span class="line">2) &quot;hao&quot;</span><br><span class="line">3) &quot;email1&quot;</span><br><span class="line">4) &quot;hao@163.com&quot;</span><br><span class="line">5) &quot;name2&quot;</span><br><span class="line">6) &quot;xiaohao&quot;</span><br><span class="line">7) &quot;email2&quot;</span><br><span class="line">8) &quot;xiaohao@163.com&quot;</span><br></pre></td></tr></table></figure>

<h3 id="实战场景-3"><a href="#实战场景-3" class="headerlink" title="实战场景"></a><strong>实战场景</strong></h3><ul>
<li><strong>缓存</strong>： 能直观，相比 string 更节省空间，的维护缓存信息，如用户信息，视频信息等。</li>
</ul>
<h2 id="Zset-有序集合"><a href="#Zset-有序集合" class="headerlink" title="Zset 有序集合"></a>Zset 有序集合</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 有序集合和集合一样也是 string 类型元素的集合,且不允许重复的成员。不同的是每个元素都会关联一个 double 类型的分数。redis 正是通过分数来为集合中的成员进行从小到大的排序。</div>
有序集合的成员是唯一的, 但分数(score)却可以重复。有序集合是通过两种数据结构实现：

<ol>
<li><strong>压缩列表(ziplist)</strong>: ziplist 是为了提高存储效率而设计的一种特殊编码的双向链表。它可以存储字符串或者整数，存储整数时是采用整数的二进制而不是字符串形式存储。它能在 O(1)的时间复杂度下完成 list 两端的 push 和 pop 操作。但是因为每次操作都需要重新分配 ziplist 的内存，所以实际复杂度和 ziplist 的内存使用量相关</li>
<li><strong>跳跃表（zSkiplist)</strong>: 跳跃表的性能可以保证在查找，删除，添加等操作的时候在对数期望时间内完成，这个性能是可以和平衡树来相比较的，而且在实现方面比平衡树要优雅，这是采用跳跃表的主要原因。跳跃表的复杂度是 O(log(n))。</li>
</ol>
<ul>
<li><strong>图例</strong></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668046795662-27f20f36-efd9-477c-89e8-7c313a70203d.png#averageHue=%23efefef&clientId=u429e2987-0087-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=271&id=ucd440152&margin=%5Bobject%20Object%5D&name=image.png&originHeight=542&originWidth=730&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=112382&status=done&style=none&taskId=ua48b7096-4a6b-42d1-9e90-c5b381a661a&title=&width=365" alt="image.png"></p>
<h3 id="命令使用-4"><a href="#命令使用-4" class="headerlink" title="命令使用"></a><strong>命令使用</strong></h3><table>
<thead>
<tr>
<th>命令</th>
<th>简述</th>
<th>使用</th>
</tr>
</thead>
<tbody><tr>
<td>ZADD</td>
<td>将一个带有给定分值的成员添加到有序集合里面</td>
<td>ZADD zset-key 178 member1</td>
</tr>
<tr>
<td>ZRANGE</td>
<td>根据元素在有序集合中所处的位置，从有序集合中获取多个元素</td>
<td>ZRANGE zset-key 0-1 withccores</td>
</tr>
<tr>
<td>ZREM</td>
<td>如果给定元素成员存在于有序集合中，那么就移除这个元素</td>
<td>ZREM zset-key member1</td>
</tr>
</tbody></table>
<p>更多命令请参考这里 <a target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-sorted-sets.html">https://www.runoob.com/redis/redis-sorted-sets.html</a></p>
<h3 id="命令执行-4"><a href="#命令执行-4" class="headerlink" title="命令执行"></a><strong>命令执行</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd myscoreset 100 hao 90 xiaohao</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; ZRANGE myscoreset 0 -1</span><br><span class="line">1) &quot;xiaohao&quot;</span><br><span class="line">2) &quot;hao&quot;</span><br><span class="line">127.0.0.1:6379&gt; ZSCORE myscoreset hao</span><br><span class="line">&quot;100&quot;</span><br></pre></td></tr></table></figure>

<h3 id="实战场景-4"><a href="#实战场景-4" class="headerlink" title="实战场景"></a>实战场景</h3><ul>
<li><strong>排行榜</strong>：有序集合经典使用场景。例如小说视频等网站需要对用户上传的小说视频做排行榜，榜单可以按照用户关注数，更新时间，字数等打分，做排行。</li>
</ul>
<h1 id="3-种特殊类型"><a href="#3-种特殊类型" class="headerlink" title="3 种特殊类型"></a>3 种特殊类型</h1><h2 id="HyperLogLogs（基数统计）"><a href="#HyperLogLogs（基数统计）" class="headerlink" title="HyperLogLogs（基数统计）"></a>HyperLogLogs（基数统计）</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 2.8.9 版本更新了 Hyperloglog 数据结构！</div>

<ul>
<li><strong>什么是基数？</strong></li>
</ul>
<p>举个例子，A &#x3D; {1, 2, 3, 4, 5}， B &#x3D; {3, 5, 6, 7, 9}；那么基数（不重复的元素）&#x3D; 1, 2, 4, 6, 7, 9； （允许容错，即可以接受一定误差）</p>
<ul>
<li><strong>HyperLogLogs 基数统计用来解决什么问题</strong>？</li>
</ul>
<p>这个结构可以非常省内存的去统计各种计数，比如注册 IP 数、每日访问 IP 数、页面实时 UV、在线用户数，共同好友数等。</p>
<ul>
<li><strong>它的优势体现在哪</strong>？</li>
</ul>
<p>一个大型的网站，每天 IP 比如有 100 万，粗算一个 IP 消耗 15 字节，那么 100 万个 IP 就是 15M。而 HyperLogLog 在 Redis 中每个键占用的内容都是 12K，理论存储近似接近 2^64 个值，不管存储的内容是什么，它一个基于基数估算的算法，只能比较准确的估算出基数，可以使用少量固定的内存去存储并识别集合中的唯一元素。而且这个估算的基数并不一定准确，是一个带有 0.81% 标准错误的近似值（对于可以接受一定容错的业务场景，比如 IP 数统计，UV 等，是可以忽略不计的）。</p>
<ul>
<li><strong>相关命令使用</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; pfadd key1 a b c d e f g h i	# 创建第一组元素</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount key1					# 统计元素的基数数量</span><br><span class="line">(integer) 9</span><br><span class="line">127.0.0.1:6379&gt; pfadd key2 c j k l m e g a		# 创建第二组元素</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; pfcount key2</span><br><span class="line">(integer) 8</span><br><span class="line">127.0.0.1:6379&gt; pfmerge key3 key1 key2			# 合并两组：key1 key2 -&gt; key3 并集</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; pfcount key3</span><br><span class="line">(integer) 13</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Bitmap-（位存储）"><a href="#Bitmap-（位存储）" class="headerlink" title="Bitmap （位存储）"></a>Bitmap （位存储）</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Bitmap 即位图数据结构，都是操作二进制位来进行记录，只有0 和 1 两个状态。</div>

<ul>
<li><strong>用来解决什么问题</strong>？</li>
</ul>
<p>比如：统计用户信息，活跃，不活跃！ 登录，未登录！ 打卡，不打卡！ <strong>两个状态的，都可以使用 Bitmaps</strong>！<br>如果存储一年的打卡状态需要多少内存呢？ 365 天 &#x3D; 365 bit 1 字节 &#x3D; 8bit 46 个字节左右！</p>
<ul>
<li><strong>相关命令使用</strong></li>
</ul>
<p>使用 bitmap 来记录 周一到周日的打卡！ 周一：1 周二：0 周三：0 周四：1 ……</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit sign 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 2 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 4 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 5 0</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 6 1</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>查看某一天是否有打卡！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; getbit sign 3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; getbit sign 5</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>统计操作，统计 打卡的天数！</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bitcount sign # 统计这周的打卡记录，就可以看到是否有全勤！</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<h2 id="geospatial-地理位置"><a href="#geospatial-地理位置" class="headerlink" title="geospatial (地理位置)"></a>geospatial (地理位置)</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis 的 Geo 在 Redis 3.2 版本就推出了! 这个功能可以推算地理位置的信息: 两地之间的距离, 方圆几里的人</div>

<h3 id="geoadd-添加地理位置"><a href="#geoadd-添加地理位置" class="headerlink" title="geoadd(添加地理位置)"></a>geoadd(添加地理位置)</h3><p><strong>规则</strong><br>两级无法直接添加，我们一般会下载城市数据(这个网址可以查询 GEO： <a target="_blank" rel="noopener" href="http://www.jsons.cn/lngcode)%EF%BC%81">http://www.jsons.cn/lngcode)！</a></p>
<ul>
<li>有效的经度从-180 度到 180 度。</li>
<li>有效的纬度从-85.05112878 度到 85.05112878 度。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">当坐标位置超出上述指定范围时，该命令将会返回一个错误。</span></span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 39.90 116.40 beijin</span><br><span class="line">(error) ERR invalid longitude,latitude pair 39.900000,116.400000</span><br></pre></td></tr></table></figure>

<h3 id="geopos-获取指定的成员的经度和纬度"><a href="#geopos-获取指定的成员的经度和纬度" class="headerlink" title="geopos(获取指定的成员的经度和纬度)"></a>geopos(获取指定的成员的经度和纬度)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:city taiyuan manjing</span><br><span class="line">1) 1) &quot;112.54999905824661255&quot;</span><br><span class="line">   1) &quot;37.86000073876942196&quot;</span><br><span class="line">2) 1) &quot;118.75999957323074341&quot;</span><br><span class="line">   1) &quot;32.03999960287850968&quot;</span><br></pre></td></tr></table></figure>

<p>获得当前定位, 一定是一个坐标值!</p>
<h3 id="geodist"><a href="#geodist" class="headerlink" title="geodist"></a>geodist</h3><blockquote>
<p>如果不存在, 返回空</p>
</blockquote>
<p>单位如下</p>
<ul>
<li>m</li>
<li>km</li>
<li>mi 英里</li>
<li>ft 英尺</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist china:city taiyuan shenyang m</span><br><span class="line">&quot;1026439.1070&quot;</span><br><span class="line">127.0.0.1:6379&gt; geodist china:city taiyuan shenyang km</span><br><span class="line">&quot;1026.4391&quot;</span><br></pre></td></tr></table></figure>

<h3 id="georadius"><a href="#georadius" class="headerlink" title="georadius"></a>georadius</h3><blockquote>
<p>附近的人 &#x3D;&#x3D;&gt; 获得所有附近的人的地址, 定位, 通过半径来查询</p>
</blockquote>
<p>获得指定数量的人</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km			以 100,30 这个坐标为中心, 寻找半径为1000km的城市</span><br><span class="line">1) &quot;xian&quot;</span><br><span class="line">2) &quot;hangzhou&quot;</span><br><span class="line">3) &quot;manjing&quot;</span><br><span class="line">4) &quot;taiyuan&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 500 km</span><br><span class="line">1) &quot;xian&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 500 km withdist</span><br><span class="line">1) 1) &quot;xian&quot;</span><br><span class="line">   2) &quot;483.8340&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withcoord withdist count 2</span><br><span class="line">1) 1) &quot;xian&quot;</span><br><span class="line">   2) &quot;483.8340&quot;</span><br><span class="line">   3) 1) &quot;108.96000176668167114&quot;</span><br><span class="line">      2) &quot;34.25999964418929977&quot;</span><br><span class="line">2) 1) &quot;manjing&quot;</span><br><span class="line">   2) &quot;864.9816&quot;</span><br><span class="line">   3) 1) &quot;118.75999957323074341&quot;</span><br><span class="line">      2) &quot;32.03999960287850968&quot;</span><br></pre></td></tr></table></figure>

<p>参数 key 经度 纬度 半径 单位 [显示结果的经度和纬度] [显示结果的距离] [显示的结果的数量]</p>
<h3 id="georadiusbymember"><a href="#georadiusbymember" class="headerlink" title="georadiusbymember"></a>georadiusbymember</h3><blockquote>
<p>显示与指定成员一定半径范围内的其他成员</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city taiyuan 1000 km</span><br><span class="line">1) &quot;manjing&quot;</span><br><span class="line">2) &quot;taiyuan&quot;</span><br><span class="line">3) &quot;xian&quot;</span><br><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city taiyuan 1000 km withcoord withdist count 2</span><br><span class="line">1) 1) &quot;taiyuan&quot;</span><br><span class="line">   2) &quot;0.0000&quot;</span><br><span class="line">   3) 1) &quot;112.54999905824661255&quot;</span><br><span class="line">      2) &quot;37.86000073876942196&quot;</span><br><span class="line">2) 1) &quot;xian&quot;</span><br><span class="line">   2) &quot;514.2264&quot;</span><br><span class="line">   3) 1) &quot;108.96000176668167114&quot;</span><br><span class="line">      2) &quot;34.25999964418929977&quot;</span><br></pre></td></tr></table></figure>

<p>参数与 georadius 一样</p>
<h3 id="geohash-较少使用"><a href="#geohash-较少使用" class="headerlink" title="geohash(较少使用)"></a>geohash(较少使用)</h3><blockquote>
<p>该命令返回 11 个字符的 hash 字符串</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash china:city taiyuan shenyang</span><br><span class="line">1) &quot;ww8p3hhqmp0&quot;</span><br><span class="line">2) &quot;wxrvb9qyxk0&quot;</span><br></pre></td></tr></table></figure>

<p>将二维的经纬度转换为一维的字符串, 如果两个字符串越接近, 则距离越近</p>
<h3 id="底层"><a href="#底层" class="headerlink" title="底层"></a>底层</h3><blockquote>
<p>geo 底层的实现原理实际上就是 Zset, 我们可以通过 Zset 命令来操作 geo</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; type china:city</span><br><span class="line">zset</span><br></pre></td></tr></table></figure>

<p>查看全部元素 删除指定的元素</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1 withscores</span><br><span class="line"> 1) &quot;xian&quot;</span><br><span class="line"> 2) &quot;4040115445396757&quot;</span><br><span class="line"> 3) &quot;hangzhou&quot;</span><br><span class="line"> 4) &quot;4054133997236782&quot;</span><br><span class="line"> 5) &quot;manjing&quot;</span><br><span class="line"> 6) &quot;4066006694128997&quot;</span><br><span class="line"> 7) &quot;taiyuan&quot;</span><br><span class="line"> 8) &quot;4068216047500484&quot;</span><br><span class="line"> 9) &quot;shenyang&quot;</span><br><span class="line">1)  &quot;4072519231994779&quot;</span><br><span class="line">2)  &quot;shengzhen&quot;</span><br><span class="line">3)  &quot;4154606886655324&quot;</span><br><span class="line">127.0.0.1:6379&gt; zrem china:city manjing</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1</span><br><span class="line">1) &quot;xian&quot;</span><br><span class="line">2) &quot;hangzhou&quot;</span><br><span class="line">3) &quot;taiyuan&quot;</span><br><span class="line">4) &quot;shenyang&quot;</span><br><span class="line">5) &quot;shengzhen&quot;</span><br></pre></td></tr></table></figure>

<h1 id="Stream-消息队列"><a href="#Stream-消息队列" class="headerlink" title="Stream 消息队列"></a>Stream 消息队列</h1><h2 id="为什么会设计-Stream"><a href="#为什么会设计-Stream" class="headerlink" title="为什么会设计 Stream"></a>为什么会设计 Stream</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">Redis5.0 中还增加了一个数据结构Stream，从字面上看是流类型，但其实从功能上看，应该是Redis对消息队列（MQ，Message Queue）的完善实现。</div>
用过Redis做消息队列的都了解，基于Reids的消息队列实现有很多种，例如：

<ul>
<li><strong>PUB&#x2F;SUB，订阅&#x2F;发布模式</strong><ul>
<li>但是发布订阅模式是无法持久化的，如果出现网络断开、Redis 宕机等，消息就会被丢弃；</li>
</ul>
</li>
<li>基于<strong>List LPUSH+BRPOP</strong> 或者 <strong>基于 Sorted-Set</strong>的实现<ul>
<li>支持了持久化，但是不支持多播，分组消费等</li>
</ul>
</li>
</ul>
<p>为什么上面的结构无法满足广泛的 MQ 场景？ 这里便引出一个核心的问题：如果我们期望设计一种数据结构来实现消息队列，最重要的就是要理解<strong>设计一个消息队列需要考虑什么</strong>？初步的我们很容易想到</p>
<ul>
<li>消息的生产</li>
<li>消息的消费<ul>
<li>单播和多播（多对多）</li>
<li>阻塞和非阻塞读取</li>
</ul>
</li>
<li>消息有序性</li>
<li>消息的持久化</li>
</ul>
<p>其它还要考虑啥嗯？借助美团技术团队的一篇文章，<a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/07/01/mq-design.html">消息队列设计精要(opens new window)</a> 中的图<br><img src="https://cdn.nlark.com/yuque/0/2022/png/473454/1668048056883-714411f5-c41c-4e46-8ae4-143657cf13a0.png#averageHue=%23ece7e0&clientId=u429e2987-0087-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u8cfe1626&margin=%5Bobject%20Object%5D&name=image.png&originHeight=461&originWidth=490&originalType=url%E2%88%B6=1&rotation=0&showTitle=false&size=53767&status=done&style=none&taskId=u2a46a21b-4487-4474-be01-a94c1391f8b&title=" alt="image.png"><br><strong>我们不妨看看 Redis 考虑了哪些设计</strong>？</p>
<ul>
<li>消息 ID 的序列化生成</li>
<li>消息遍历</li>
<li>消息的阻塞和非阻塞读取</li>
<li>消息的分组消费</li>
<li>未完成消息的处理</li>
<li>消息队列监控</li>
<li>…<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">这也是我们需要理解Stream的点，但是结合上面的图，我们也应该理解Redis Stream也是一种超轻量MQ并没有完全实现消息队列所有设计要点，这决定着它适用的场景。</div>
详细内容建议看这篇[Stream详细用法](https://pdai.tech/md/db/nosql-redis/db-redis-data-type-stream.html)</li>
</ul>
<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><p>Redis 事务的本质是一组命令的集合。事务支持一次执行多个命令，一个事务中所有命令都会被序列化。在事务执行过程，会按照顺序串行化执行队列中的命令，其他客户端提交的命令请求不会插入到事务执行命令序列中。</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">总结说：redis事务就是一次性、顺序性、排他性的执行一个队列中的一系列命令。</div>

<h2 id="Redis-事务相关命令和使用"><a href="#Redis-事务相关命令和使用" class="headerlink" title="Redis 事务相关命令和使用"></a>Redis 事务相关命令和使用</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">MULTI 、 EXEC 、 DISCARD 和 WATCH 是 Redis 事务相关的命令。</div>

<ul>
<li><strong>MULTI</strong> ：开启事务，redis 会将后续的命令逐个放入队列中，然后使用 EXEC 命令来原子化执行这个命令系列。</li>
<li><strong>EXEC</strong>：执行事务中的所有操作命令。</li>
<li><strong>DISCARD</strong>：取消事务，放弃执行事务块中的所有命令。</li>
<li><strong>WATCH</strong>：监视一个或多个 key,如果事务在执行前，这个 key(或多个 key)被其他命令修改，则事务被中断，不会执行事务中的任何命令。</li>
<li><strong>UNWATCH</strong>：取消 WATCH 对所有 key 的监视。</li>
</ul>
<h3 id="标准的事务执行"><a href="#标准的事务执行" class="headerlink" title="标准的事务执行"></a>标准的事务执行</h3><p>给 k1、k2 分别赋值，在事务中修改 k1、k2，执行事务后，查看 k1、k2 值都被修改。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;11&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;22&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h3 id="事务取消"><a href="#事务取消" class="headerlink" title="事务取消"></a>事务取消</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 33</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 34</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; DISCARD</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h3 id="事务出现错误的处理"><a href="#事务出现错误的处理" class="headerlink" title="事务出现错误的处理"></a>事务出现错误的处理</h3><ul>
<li><strong>语法错误（编译器错误）</strong></li>
</ul>
<p>在开启事务后，修改 k1 值为 11，k2 值为 22，但 k2 语法错误，最终导致事务提交失败，k1、k2 保留原值。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; sets k2 22</span><br><span class="line">(error) ERR unknown command `sets`, with args beginning with: `k2`, `22`,</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Redis 类型错误（运行时错误）</strong></li>
</ul>
<p>在开启事务后，修改 k1 值为 11，k2 值为 22，但将 k2 的类型作为 List，在运行时检测类型错误，最终导致事务提交失败，此时事务并没有回滚，而是跳过错误命令继续执行， 结果 k1 值改变、k2 保留原值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; lpush k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) (error) WRONGTYPE Operation against a key holding the wrong kind of value</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;11&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="WATCH-命令"><a href="#WATCH-命令" class="headerlink" title="WATCH 命令"></a>WATCH 命令</h2><p>WATCH 命令可以为 Redis 事务提供 check-and-set （CAS）行为。</p>
<ul>
<li><strong>CAS? 乐观锁</strong>？Redis 官方的例子帮你理解</li>
</ul>
<p>被 WATCH 的键会被监视，并会发觉这些键是否被改动过了。 如果有至少一个被监视的键在 EXEC 执行之前被修改了， 那么整个事务都会被取消， EXEC 返回 nil-reply 来表示事务已经失败。<br>举个例子， 假设我们需要原子性地为某个值进行增 1 操作（假设 INCR 不存在）。<br>首先我们可能会这样做：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val = GET mykey</span><br><span class="line">val = val + 1</span><br><span class="line">SET mykey $val</span><br></pre></td></tr></table></figure>

<p>上面的这个实现在只有一个客户端的时候可以执行得很好。 但是， 当多个客户端同时对同一个键进行这样的操作时， 就会产生竞争条件。举个例子， 如果客户端 A 和 B 都读取了键原来的值， 比如 10 ， 那么两个客户端都会将键的值设为 11 ， 但正确的结果应该是 12 才对。<br>有了 WATCH ，我们就可以轻松地解决这类问题了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WATCH mykey</span><br><span class="line">val = GET mykey</span><br><span class="line">val = val + 1</span><br><span class="line">MULTI</span><br><span class="line">SET mykey $val</span><br><span class="line">EXEC</span><br></pre></td></tr></table></figure>

<p>使用上面的代码， 如果在 WATCH 执行之后， EXEC 执行之前， 有其他客户端修改了 mykey 的值， 那么当前客户端的事务就会失败。 程序需要做的， 就是不断重试这个操作， 直到没有发生碰撞为止。<br>这种形式的锁被称作乐观锁， 它是一种非常强大的锁机制。 并且因为大多数情况下， 不同的客户端会访问不同的键， 碰撞的情况一般都很少， 所以通常并不需要进行重试。</p>
<ul>
<li><strong>watch 是如何监视实现的呢</strong>？</li>
</ul>
<p>Redis 使用 WATCH 命令来决定事务是继续执行还是回滚，那就需要在 MULTI 之前使用 WATCH 来监控某些键值对，然后使用 MULTI 命令来开启事务，执行对数据结构操作的各种命令，此时这些命令入队列。<br>当使用 EXEC 执行事务时，首先会比对 WATCH 所监控的键值对，如果没发生改变，它会执行事务队列中的命令，提交事务；如果发生变化，将不会执行事务中的任何命令，同时事务回滚。当然无论是否回滚，Redis 都会取消执行事务前的 WATCH 命令。</p>
<ul>
<li><strong>watch 命令实现监视</strong></li>
</ul>
<p>在事务开始前用 WATCH 监控 k1，之后修改 k1 为 11，说明事务开始前 k1 值被改变，MULTI 开始事务，修改 k1 值为 12，k2 为 22，执行 EXEC，发回 nil，说明事务回滚；查看下 k1、k2 的值都没有被事务中的命令所改变。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; WATCH k1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 12</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;11&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;v2&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>unwatch 取消监视</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; WATCH k1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 11</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; UNWATCH</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set k1 12</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; set k2 22</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;12&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k2</span><br><span class="line">&quot;22&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h2 id="为什么-Redis-不支持回滚？"><a href="#为什么-Redis-不支持回滚？" class="headerlink" title="为什么 Redis 不支持回滚？"></a>为什么 Redis 不支持回滚？</h2><p>如果你有使用关系式数据库的经验， 那么 “<strong>Redis 在事务失败时不进行回滚，而是继续执行余下的命令</strong>”这种做法可能会让你觉得有点奇怪。<br>以下是这种做法的优点：</p>
<ul>
<li>Redis 命令只会因为错误的语法而失败（并且这些问题不能在入队时发现），或是命令用在了错误类型的键上面：这也就是说，从实用性的角度来说，失败的命令是由编程错误造成的，而这些错误应该在开发的过程中被发现，而不应该出现在生产环境中。</li>
<li>因为不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速。</li>
</ul>
<p>有种观点认为 Redis 处理事务的做法会产生 bug ， 然而需要注意的是， 在通常情况下， <strong>回滚并不能解决编程错误带来的问题</strong>。 举个例子， 如果你本来想通过 INCR 命令将键的值加上 1 ， 却不小心加上了 2 ， 又或者对错误类型的键执行了 INCR ， 回滚是没有办法处理这些情况的。</p>
<h2 id="如何理解-Redis-与事务的-ACID？"><a href="#如何理解-Redis-与事务的-ACID？" class="headerlink" title="如何理解 Redis 与事务的 ACID？"></a>如何理解 Redis 与事务的 ACID？</h2><div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">一般来说，事务有四个性质称为ACID，分别是原子性，一致性，隔离性和持久性。</div>

<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><ul>
<li><strong>为什么需要持久化</strong>？</li>
</ul>
<p>Redis 是个基于内存的数据库。那服务一旦宕机，内存中的数据将全部丢失。通常的解决方案是从后端数据库恢复这些数据，但后端数据库有性能瓶颈，如果是大数据量的恢复，1、会对数据库带来巨大的压力，2、数据库的性能不如 Redis。导致程序响应慢。所以对 Redis 来说，实现数据的持久化，避免从后端数据库中恢复数据，是至关重要的。</p>
<h2 id="RDB-持久化"><a href="#RDB-持久化" class="headerlink" title="RDB 持久化"></a>RDB 持久化</h2><p>RDB 就是 Redis DataBase 的缩写，中文名为快照&#x2F;内存快照，RDB 持久化是把当前进程数据生成快照保存到磁盘上的过程，由于是某一时刻的快照，那么快照中的值要早于或者等于内存中的值。</p>
<h3 id="触发方式"><a href="#触发方式" class="headerlink" title="触发方式"></a>触发方式</h3><p>触发 rdb 持久化的方式有 2 种，分别是<strong>手动触发</strong>和<strong>自动触发</strong>。</p>
<h4 id="手动触发"><a href="#手动触发" class="headerlink" title="手动触发"></a>手动触发</h4><p>手动触发分别对应 save 和 bgsave 命令</p>
<h4 id="自动触发"><a href="#自动触发" class="headerlink" title="自动触发"></a>自动触发</h4><p>在以下 4 种情况时会自动触发</p>
<ul>
<li>redis.conf 中配置 save m n，即在 m 秒内有 n 次修改时，自动触发 bgsave 生成 rdb 文件；</li>
<li>主从复制时，从节点要从主节点进行全量复制时也会触发 bgsave 操作，生成当时的快照发送到从节点；</li>
<li>执行 debug reload 命令重新加载 redis 时也会触发 bgsave 操作；</li>
<li>默认情况下执行 shutdown 命令时，如果没有开启 aof 持久化，那么也会触发 bgsave 操作；</li>
</ul>
<h3 id="redis-conf-中配置-RDB"><a href="#redis-conf-中配置-RDB" class="headerlink" title="redis.conf 中配置 RDB"></a>redis.conf 中配置 RDB</h3><p><strong>快照周期</strong>：内存快照虽然可以通过技术人员手动执行 SAVE 或 BGSAVE 命令来进行，但生产环境下多数情况都会设置其周期性执行条件。</p>
<ul>
<li><strong>Redis 中默认的周期新设置</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">周期性执行条件的设置格式为</span></span><br><span class="line">save &lt;seconds&gt; &lt;changes&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认的设置为：</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下设置方式为关闭RDB快照功能</span></span><br><span class="line">save &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>以上三项默认信息设置代表的意义是：</p>
<ul>
<li>如果 900 秒内有 1 条 Key 信息发生变化，则进行快照；</li>
<li>如果 300 秒内有 10 条 Key 信息发生变化，则进行快照；</li>
<li>如果 60 秒内有 10000 条 Key 信息发生变化，则进行快照。读者可以按照这个规则，根据自己的实际请求压力进行设置调整。</li>
<li><strong>其它相关配置</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件名称</span></span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件保存路径</span></span><br><span class="line">dir /home/work/app/redis/data/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果持久化出错，主进程是否停止写入</span></span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">是否压缩</span></span><br><span class="line">rdbcompression yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入时是否检查</span></span><br><span class="line">rdbchecksum yes</span><br></pre></td></tr></table></figure>

<p><strong>dbfilename</strong>: RDB 文件在磁盘上的名称。<br><strong>dir</strong>: RDB 文件的存储路径。默认设置为“.&#x2F;”，也就是 Redis 服务的主目录。<br><strong>stop-writes-on-bgsave-error</strong>：上文提到的在快照进行过程中，主进程照样可以接受客户端的任何写操作的特性，是指在快照操作正常的情况下。如果快照操作出现异常（例如操作系统用户权限不够、磁盘空间写满等等）时，Redis 就会禁止写操作。这个特性的主要目的是使运维人员在第一时间就发现 Redis 的运行错误，并进行解决。一些特定的场景下，您可能需要对这个特性进行配置，这时就可以调整这个参数项。该参数项默认情况下值为 yes，如果要关闭这个特性，指定即使出现快照错误 Redis 一样允许写操作，则可以将该值更改为 no。<br><strong>rdbcompression</strong>：该属性将在字符串类型的数据被快照到磁盘文件时，启用 LZF 压缩算法。Redis 官方的建议是请保持该选项设置为 yes，因为“it’s almost always a win”。<br><strong>rdbchecksum</strong>：从 RDB 快照功能的 version 5 版本开始，一个 64 位的 CRC 冗余校验编码会被放置在 RDB 文件的末尾，以便对整个 RDB 文件的完整性进行验证。这个功能大概会多损失 10%左右的性能，但获得了更高的数据可靠性。所以如果您的 Redis 服务需要追求极致的性能，就可以将这个选项设置为 no。</p>
<h3 id="RDB-优缺点"><a href="#RDB-优缺点" class="headerlink" title="RDB 优缺点"></a>RDB 优缺点</h3><ul>
<li><strong>优点</strong><ul>
<li>RDB 文件是某个时间节点的快照，默认使用 LZF 算法进行压缩，压缩后的文件体积远远小于内存大小，适用于备份、全量复制等场景；</li>
<li>Redis 加载 RDB 文件恢复数据要远远快于 AOF 方式；</li>
</ul>
</li>
<li><strong>缺点</strong><ul>
<li>RDB 方式实时性不够，无法做到秒级的持久化；</li>
<li>每次调用 bgsave 都需要 fork 子进程，fork 子进程属于重量级操作，频繁执行成本较高；</li>
<li>RDB 文件是二进制的，没有可读性，AOF 文件在了解其结构的情况下可以手动修改或者补全；</li>
<li>版本兼容 RDB 文件问题；</li>
</ul>
</li>
</ul>
<p>针对 RDB 不适合实时持久化的问题，Redis 提供了 AOF 持久化方式来解决</p>
<h2 id="AOF-持久化"><a href="#AOF-持久化" class="headerlink" title="AOF 持久化"></a>AOF 持久化</h2><p>Redis 是“写后”日志，Redis 先执行命令，把数据写入内存，然后才记录日志。日志里记录的是 Redis 收到的每一条命令，这些命令是以文本形式保存。PS: 大多数的数据库采用的是写前日志（WAL），例如 MySQL，通过写前日志和两阶段提交，实现数据和逻辑的一致性。<br>而 AOF 日志采用写后日志，即<strong>先写内存，后写日志</strong>。<br><strong>为什么采用写后日志</strong>？<br>Redis 要求高性能，采用写日志有两方面好处：</p>
<ul>
<li><strong>避免额外的检查开销</strong>：Redis 在向 AOF 里面记录日志的时候，并不会先去对这些命令进行语法检查。所以，如果先记日志再执行命令的话，日志中就有可能记录了错误的命令，Redis 在使用日志恢复数据时，就可能会出错。</li>
<li>不会阻塞当前的写操作</li>
</ul>
<p>但这种方式存在潜在风险：</p>
<ul>
<li>如果命令执行完成，写日志之前宕机了，会丢失数据。</li>
<li>主线程写磁盘压力大，导致写盘慢，阻塞后续操作。</li>
</ul>
<h3 id="如何实现-AOF"><a href="#如何实现-AOF" class="headerlink" title="如何实现 AOF"></a>如何实现 AOF</h3><p>AOF 日志记录 Redis 的每个写命令，步骤分为：命令追加（append）、文件写入（write）和文件同步（sync）。</p>
<ul>
<li><strong>命令追加</strong> 当 AOF 持久化功能打开了，服务器在执行完一个写命令之后，会以协议格式将被执行的写命令追加到服务器的 aof_buf 缓冲区。</li>
<li><strong>文件写入和同步</strong> 关于何时将 aof_buf 缓冲区的内容写入 AOF 文件中，Redis 提供了三种写回策略</li>
</ul>
<p>Always，同步写回：每个写命令执行完，立马同步地将日志写回磁盘；<br>Everysec，每秒写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘；<br>No，操作系统控制的写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘。</p>
<ul>
<li><strong>三种写回策略的优缺点</strong></li>
</ul>
<p>上面的三种写回策略体现了一个重要原则：<strong>trade-off</strong>，取舍，指在性能和可靠性保证之间做取舍。</p>
<h3 id="redis-conf-中配置-AOF"><a href="#redis-conf-中配置-AOF" class="headerlink" title="redis.conf 中配置 AOF"></a>redis.conf 中配置 AOF</h3><p>默认情况下，Redis 是没有开启 AOF 的，可以通过配置 redis.conf 文件来开启 AOF 持久化，关于 AOF 的配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendonly参数开启AOF持久化</span></span><br><span class="line">appendonly no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF持久化的文件名，默认是appendonly.aof</span></span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF文件的保存位置和RDB文件的位置相同，都是通过<span class="built_in">dir</span>参数设置的</span></span><br><span class="line">dir ./</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">同步策略</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendfsync no</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">aof重写期间是否同步</span></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重写触发配置</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载aof出错如何处理</span></span><br><span class="line">aof-load-truncated yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">文件重写策略</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure>

<p>以下是 Redis 中关于 AOF 的主要配置信息：<br><strong>appendonly</strong>：默认情况下 AOF 功能是关闭的，将该选项改为 yes 以便打开 Redis 的 AOF 功能。<br><strong>appendfilename</strong>：这个参数项很好理解了，就是 AOF 文件的名字。<br><strong>appendfsync</strong>：这个参数项是 AOF 功能最重要的设置项之一，主要用于设置“真正执行”操作命令向 AOF 文件中同步的策略。<br>什么叫“真正执行”呢？还记得 Linux 操作系统对磁盘设备的操作方式吗？ 为了保证操作系统中 I&#x2F;O 队列的操作效率，应用程序提交的 I&#x2F;O 操作请求一般是被放置在 linux Page Cache 中的，然后再由 Linux 操作系统中的策略自行决定正在写到磁盘上的时机。而 Redis 中有一个 fsync()函数，可以将 Page Cache 中待写的数据真正写入到物理设备上，而缺点是频繁调用这个 fsync()函数干预操作系统的既定策略，可能导致 I&#x2F;O 卡顿的现象频繁 。</p>
<div style="background: #E8F7FF;padding:10px;border: 1px solid #ABD2DA;border-radius:5px;margin-bottom:5px;">与上节对应，appendfsync参数项可以设置三个值，分别是：always、everysec、no，默认的值为everysec。</div>
**no-appendfsync-on-rewrite**：always和everysec的设置会使真正的I/O操作高频度的出现，甚至会出现长时间的卡顿情况，这个问题出现在操作系统层面上，所有靠工作在操作系统之上的Redis是没法解决的。为了尽量缓解这个情况，Redis提供了这个设置项，保证在完成fsync函数调用时，不会将这段时间内发生的命令操作放入操作系统的Page Cache（这段时间Redis还在接受客户端的各种写操作命令）。
**auto-aof-rewrite-percentage**：上文说到在生产环境下，技术人员不可能随时随地使用“BGREWRITEAOF”命令去重写AOF文件。所以更多时候我们需要依靠Redis中对AOF文件的自动重写策略。Redis中对触发自动重写AOF文件的操作提供了两个设置：auto-aof-rewrite-percentage表示如果当前AOF文件的大小超过了上次重写后AOF文件的百分之多少后，就再次开始重写AOF文件。例如该参数值的默认设置值为100，意思就是如果AOF文件的大小超过上次AOF文件重写后的1倍，就启动重写操作。
**auto-aof-rewrite-min-size**：参考auto-aof-rewrite-percentage选项的介绍，auto-aof-rewrite-min-size设置项表示启动AOF文件重写操作的AOF文件最小大小。如果AOF文件大小低于这个值，则不会触发重写操作。注意，auto-aof-rewrite-percentage和auto-aof-rewrite-min-size只是用来控制Redis中自动对AOF文件进行重写的情况，如果是技术人员手动调用“BGREWRITEAOF”命令，则不受这两个限制条件左右.

<h2 id="从持久化中恢复数据"><a href="#从持久化中恢复数据" class="headerlink" title="从持久化中恢复数据"></a>从持久化中恢复数据</h2><p>其实想要从这些文件中恢复数据，只需要重新启动 Redis 即可.</p>
<h3 id="加载步骤"><a href="#加载步骤" class="headerlink" title="加载步骤"></a>加载步骤</h3><ul>
<li>redis 重启时判断是否开启 aof，如果开启了 aof，那么就优先加载 aof 文件；</li>
<li>如果 aof 存在，那么就去加载 aof 文件，加载成功的话 redis 重启成功，如果 aof 文件加载失败，那么会打印日志表示启动失败，此时可以去修复 aof 文件后重新启动；</li>
<li>若 aof 文件不存在，那么 redis 就会转而去加载 rdb 文件，如果 rdb 文件不存在，redis 直接启动成功；</li>
<li>如果 rdb 文件存在就会去加载 rdb 文件恢复数据，如加载失败则打印日志提示启动失败，如加载成功，那么 redis 重启成功，且使用 rdb 文件恢复数据；</li>
</ul>
<p>那么为什么会优先加载 AOF 呢？因为 AOF 保存的数据更完整，通过上面的分析我们知道 AOF 基本上最多损失 1s 的数据。</p>
<h1 id="Node-中使用-Redis"><a href="#Node-中使用-Redis" class="headerlink" title="Node 中使用 Redis"></a>Node 中使用 Redis</h1><p>推荐模块<code>ioredis</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ioredis = <span class="built_in">require</span>(<span class="string">&quot;ioredis&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line"><span class="keyword">const</span> redis = <span class="keyword">new</span> <span class="title function_">ioredis</span>(&#123;</span><br><span class="line">  <span class="attr">port</span>: <span class="number">6379</span>,</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 操作Redis数据库</span></span><br><span class="line"><span class="comment">// redis.set(&#x27;far&#x27;, &#x27;bar&#x27;, (err, ret) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     if(err) &#123;</span></span><br><span class="line"><span class="comment">//         console.log(&#x27;写入失败&#x27;, err);</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;写入成功&#x27;, ret);</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持promise</span></span><br><span class="line">redis</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&quot;far&quot;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">(<span class="params">ret</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ret);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;获取失败&quot;</span>, err);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="使用-pipeline-管道"><a href="#使用-pipeline-管道" class="headerlink" title="使用 pipeline 管道"></a>使用 pipeline 管道</h2><p>存在多条命令时,使用<code>pipeline</code>可以提高效率.使用<code>exec</code>结束 pipeline 就会给数据库发送请求.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pipeline = redis.<span class="title function_">pipeline</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">      pipeline.<span class="title function_">set</span>(<span class="string">`<span class="subst">$&#123;i&#125;</span>-foo`</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 结束命令就执行</span></span><br><span class="line">    <span class="keyword">await</span> pipeline.<span class="title function_">exec</span>();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 甚至能够链式调用命令</span></span><br><span class="line">redis</span><br><span class="line">  .<span class="title function_">pipeline</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>)</span><br><span class="line">  .<span class="title function_">del</span>(<span class="string">&quot;cc&quot;</span>)</span><br><span class="line">  .<span class="title function_">exec</span>(<span class="keyword">function</span> (<span class="params">err, results</span>) &#123;&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// `exec` 也是返回的promise</span></span><br><span class="line"><span class="keyword">var</span> promise = redis.<span class="title function_">pipeline</span>().<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>).<span class="title function_">get</span>(<span class="string">&quot;foo&quot;</span>).<span class="title function_">exec</span>();</span><br><span class="line">promise.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">result</span>) &#123;</span><br><span class="line">  <span class="comment">// result === [[null, &#x27;OK&#x27;], [null, &#x27;bar&#x27;]]</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>每个链式命令也可以有一个回调，当命令得到回复时将调用它</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">  .<span class="title function_">pipeline</span>()</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&quot;foo&quot;</span>, <span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">    <span class="comment">// result === &#x27;bar&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">exec</span>(<span class="keyword">function</span> (<span class="params">err, result</span>) &#123;</span><br><span class="line">    <span class="comment">// result[1][1] === &#x27;bar&#x27;</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>除了单独向管道队列添加命令外，还可以将一组命令和参数传递给构造函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">redis</span><br><span class="line">  .<span class="title function_">pipeline</span>([</span><br><span class="line">    [<span class="string">&quot;set&quot;</span>, <span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;foo&quot;</span>],</span><br><span class="line">  ])</span><br><span class="line">  .<span class="title function_">exec</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>查看管道中有多少命令</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="title function_">pipeline</span>().<span class="title function_">set</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>).<span class="title function_">get</span>(<span class="string">&quot;foo&quot;</span>).<span class="property">length</span>; <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<h2 id="事务-1"><a href="#事务-1" class="headerlink" title="事务"></a>事务</h2><p>调用<code>multi</code>时会自动创建<code>pipeline</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ret = <span class="keyword">await</span> redis.<span class="title function_">multi</span>().<span class="title function_">set</span>(<span class="string">&quot;Jack&quot;</span>, <span class="number">100</span>).<span class="title function_">set</span>(<span class="string">&quot;Tom&quot;</span>, <span class="number">200</span>).<span class="title function_">exec</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ret);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="错误调试"><a href="#错误调试" class="headerlink" title="错误调试"></a>错误调试</h2><p><code>showFriendlyErrorStack</code>: 设置为 true 会在报错时提供错误信息.建议只在调试时开启.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/08/mangoDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zax Tseng">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ZAX">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | ZAX">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/08/mangoDB/" class="post-title-link" itemprop="url">mangoDB</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-11-08 17:07:43" itemprop="dateCreated datePublished" datetime="2022-11-08T17:07:43+08:00">2022-11-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-12-08 17:09:20" itemprop="dateModified" datetime="2022-12-08T17:09:20+08:00">2022-12-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="NoSQL"><a href="#NoSQL" class="headerlink" title="NoSQL"></a>NoSQL</h1><p>不仅仅是 SQL,即非关系型数据库.</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><ol>
<li>键值数据库(Redis,Flare)</li>
</ol>
<p>拥有极高的读写性能,用于处理大量数据的高访问负载,例如日志系统.</p>
<ol start="2">
<li>文档型数据库(mangoDB,CouchDB)</li>
</ol>
<p>满足海量的访问和存储,同时对字段要求不严格,可以随意增删改,适用于网络应用.</p>
<ol start="3">
<li>列存储型数据库(Cassandra,Hbase)</li>
</ol>
<p>查找快,扩展性强,适合用作分布式文件存储系统.(大数据)</p>
<ol start="4">
<li>图存储型数据库(InfoGrid,Heo4J)</li>
</ol>
<p>利用图结构的相关算法来存储实体之间的关系信息,适用于构建社交网络和推荐系统的关系图谱.</p>
<h2 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h2><p>既然 NoSQL 数据库有这么多的优势，那它是否可以直接取代天系型数据库？<br>NoSQL 并不能完全取代关系型数据库，NoSQL 主要被用来处理大量且多元数据的存储及运算问题。在这样的特性差异下，我们该如何选择合适的数据库以解决数据存储与处理问题呢？这里提供以下几点作为判断依据。</p>
<ol>
<li>数据模型的关联性要求</li>
</ol>
<p>NoSQL 适合模型关联性比较低的应用。因此：<br>·如果需要多表关联，则更适合用 RDB<br>·如果对象实体关联少，则更适合用 NoSQL 数据库.<br>其中 MongoDB 可以支持复杂度相对高的数据结构，能够将相关联的数据以文档的方式嵌入，从而减少数据之间的关联操作</p>
<ol start="2">
<li>数据库的性能要求</li>
</ol>
<p>如果数据量多切访问速度至关重要，那么使用 NoSQL 数据库可能是比较合适的。NoSQL 数据库能通过数据的分布存储大幅地提供存储性能。</p>
<ol start="3">
<li>数据的一致性要求</li>
</ol>
<p>NoSQL 数据库有一个缺点：其在事务处理与一致性方面无法与 RDB 相提并论。<br>因此，NoSQL 数据库很难同时满足强一致性与高并发性。如果应用对性能有高要求，则 NoSQL 数据库只能做到数据最终一致。</p>
<ol start="4">
<li>数据的可用性要求</li>
</ol>
<p>考虑到数据不可用可能会造成风险，NoSQL 数据库提供了强大的数据可用性（在一些需要快速反馈信息给使用者的应用中，响应延迟也算某种程度的高可用）。<br><strong>一个项目并非只选择一种数据库，可以将其拆开设计，将需要 RDB 特性的放到 RDB 中管理，而其它数据放到 NoSQL 中管理。</strong></p>
<h1 id="安装-MongoDB"><a href="#安装-MongoDB" class="headerlink" title="安装 MongoDB"></a>安装 MongoDB</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew tap mongodb/brew</span><br><span class="line">brew install mongodb-community@4.4</span><br></pre></td></tr></table></figure>

<p>然后按照提示修改环境变量,使用<code>source</code>命令重启.</p>
<table>
<thead>
<tr>
<th></th>
<th>英特尔处理器</th>
<th>苹果 M1 处理器</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://link.juejin.cn/?target=https://docs.mongodb.com/v4.4/reference/configuration-options/">配置文件</a></td>
<td>&#x2F;usr&#x2F;local&#x2F;etc&#x2F;mongod.conf</td>
<td>&#x2F;opt&#x2F;homebrew&#x2F;etc&#x2F;mongod.conf</td>
</tr>
<tr>
<td><a href="https://link.juejin.cn/?target=https://docs.mongodb.com/v4.4/reference/configuration-options/%23mongodb-setting-systemLog.path">log directory</a>(log 目录)</td>
<td>&#x2F;usr&#x2F;local&#x2F;var&#x2F;log&#x2F;mongodb</td>
<td>&#x2F;opt&#x2F;homebrew&#x2F;var&#x2F;log&#x2F;mongodb</td>
</tr>
<tr>
<td><a href="https://link.juejin.cn/?target=https://docs.mongodb.com/v4.4/reference/configuration-options/%23mongodb-setting-storage.dbPath">data directory</a>(data 目录)</td>
<td>&#x2F;usr&#x2F;local&#x2F;var&#x2F;mongodb</td>
<td>&#x2F;opt&#x2F;homebrew&#x2F;var&#x2F;mongodb</td>
</tr>
</tbody></table>
<h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brew services start mongodb-community@4.4</span><br><span class="line">// 停止</span><br><span class="line">brew services stop mongodb-community@4.4</span><br><span class="line">// 查看后台服务列表</span><br><span class="line">brew services list</span><br></pre></td></tr></table></figure>

<h1 id="mongo-shell"><a href="#mongo-shell" class="headerlink" title="mongo shell"></a>mongo shell</h1><p>mongoDB 退出的 shell 命令,进入方法,先启动 MongoDB 服务,再输入<code>mongo</code>.<br>shell 中支持基本的 js 语法.</p>
<h2 id="端口号"><a href="#端口号" class="headerlink" title="端口号"></a>端口号</h2><p>默认链接 27017 端口,如果要修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mongo --prot 27018</span><br><span class="line">// 连接远程主机</span><br><span class="line">mongo --host mongodb0.example.com:28015</span><br></pre></td></tr></table></figure>

<h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><p>查看数据库: <code>show dbs</code><br>当前数据库: <code>db</code><br>切换&#x2F;创建数据库: <code>use &lt;name&gt;</code><br>查看集合: <code>show collections</code><br>清空数据库: <code>db dropDatabase()</code><br>创建集合: <code>db.xxx.insert(&#123;&#125;)</code><br>查询集合: <code>db.xxx.find()</code><br>删除集合: <code>db.xxx.drop()</code></p>
<h1 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h1><p>MongoDB 将数据存储为 BSON 文档.</p>
<h2 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h2><p>文档对字段名称有以下限制：</p>
<ul>
<li>字段名称＿id 保留用作主键；它的值在集合中必须是唯一的，不可变的，并且可以是数组以外的任何类型.</li>
<li>字段名称不能包含空字符。</li>
</ul>
<h3 id="id-字段"><a href="#id-字段" class="headerlink" title="_id 字段"></a>_id 字段</h3><p>在 MongoDB 中，存储在集合中的每个文档都需要一个唯一的<code>_id</code>字段作为主键。如果插入的文档省略<code>_id</code>字段，则 MongoDB 驱动程序会自动为<code>_id</code>字段生成 Objectld。<br>id 字段具有以下行为和约束：</p>
<ul>
<li>默认情况下，MongoDB 在创建集合时会在<code>_id</code>字段上创建唯一索引。</li>
<li><code>_id</code>字段始终是文档中的第一个字段</li>
<li><code>_id</code>字段可以包含任何 BSON 数据类型的值，而不是数组。</li>
</ul>
<h2 id="创建文档"><a href="#创建文档" class="headerlink" title="创建文档"></a>创建文档</h2><ul>
<li><code>db.xxx.insertOne()</code>: 插入一个,返回 id</li>
<li><code>db.xxx.insertMany()</code>: 插入多个,返回 id</li>
<li><code>db.xxx.insert()</code>: 插入任意个,返回是否成功</li>
</ul>
<h2 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h2><ul>
<li><code>db.xxx.find(query, projection)</code><ul>
<li>query,可选,指定查询条件</li>
<li>projection,可选,使用投影操作符指定返回的键.</li>
<li><code>$or</code>或查询,匹配一个或多个条件</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 条件查询</span></span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="attr">status</span>: <span class="string">&quot;A&quot;</span>, <span class="comment">//查询条件为A的所有</span></span><br><span class="line">&#125;);</span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(</span><br><span class="line">  &#123;&#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">item</span>: <span class="number">1</span>, <span class="comment">//1 表示查询item,0表示不包括item</span></span><br><span class="line">    <span class="attr">qty</span>: <span class="number">1</span>,</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// 或查询</span></span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123;</span><br><span class="line">  <span class="attr">$or</span>: [</span><br><span class="line">    (<span class="attr">status</span>: <span class="string">&quot;A&quot;</span>),</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">qty</span>: &#123; <span class="attr">$lt</span>: <span class="number">30</span> &#125;, <span class="comment">// qty小于30</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>db.xxx.findOne()</code></li>
</ul>
<h3 id="类型检查"><a href="#类型检查" class="headerlink" title="类型检查"></a>类型检查</h3><p>BSON 类型为 Nul(类型编号 10):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123; <span class="attr">item</span>: &#123; <span class="attr">$type</span>: <span class="number">10</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="存在检查"><a href="#存在检查" class="headerlink" title="存在检查"></a>存在检查</h3><p>查询匹配不包含 item 的文档:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">xxx</span>.<span class="title function_">find</span>(&#123; <span class="attr">item</span>: &#123; <span class="attr">$exists</span>: <span class="literal">false</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h2><ul>
<li><code>db.xxx.updateOne(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></li>
<li><code>db.xxx.updateMany(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></li>
<li><code>db.xxx.replaceOne(&lt;filter&gt;, &lt;update&gt;, &lt;options&gt;)</code></li>
</ul>
<p>可以指定更新文档的条件或过滤器.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将age小于18 的文档中status更新为reject</span></span><br><span class="line">db.<span class="property">xxx</span>.<span class="title function_">updateMany</span>(&#123;</span><br><span class="line">  &#123;<span class="attr">age</span>: &#123; <span class="attr">$lt</span>: <span class="number">18</span> &#125;,</span><br><span class="line">  &#123;<span class="attr">$set</span>: &#123;<span class="attr">stastus</span>: <span class="string">&#x27;reject&#x27;</span>&#125;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="替换文档"><a href="#替换文档" class="headerlink" title="替换文档"></a>替换文档</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.<span class="property">xxx</span>.<span class="title function_">replaceOne</span>(</span><br><span class="line">  &#123;<span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">item</span>: <span class="string">&#x27;paper&#x27;</span>, <span class="attr">instock</span>: &#123;<span class="attr">qty</span>: <span class="number">60</span>&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h2><ul>
<li><code>db.xxx.deleteMany()</code></li>
<li><code>db.xxx.deleteOne()</code>: 仅删除一个符合条件的文档</li>
</ul>
<h1 id="数据库的操作"><a href="#数据库的操作" class="headerlink" title="数据库的操作"></a>数据库的操作</h1><ul>
<li>导出数据库 .&#x2F;mongoexport –port [port] –db test –collection users –out export.json</li>
<li>导入数据库 .&#x2F;mongoimport -h 120.79.229.197:27-17 -d test -c scenics –file&#x3D;.&#x2F;export.json</li>
</ul>
<h1 id="Node-中使用-MongoDB"><a href="#Node-中使用-MongoDB" class="headerlink" title="Node 中使用 MongoDB"></a>Node 中使用 MongoDB</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//安装mongo,这是项目中使用的为node准备的工具</span><br><span class="line">npm i mongo -D</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">MongoClient</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;mongodb&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> <span class="title class_">MongoClient</span>(<span class="string">&quot;mongodb://127.0.0.1:27017&quot;</span>); <span class="comment">// 连接本地mongo客户端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 开始连接</span></span><br><span class="line">    <span class="keyword">await</span> client.<span class="title function_">connect</span>();</span><br><span class="line">    <span class="comment">// 操作数据库</span></span><br><span class="line">    <span class="keyword">const</span> testDB = client.<span class="title function_">db</span>(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">    <span class="comment">// 通过数据库获取集合</span></span><br><span class="line">    <span class="keyword">const</span> userCollection = testDB.<span class="title function_">collection</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">    <span class="comment">// 增加</span></span><br><span class="line">    <span class="comment">// const ret = await userCollection.insertOne(&#123;</span></span><br><span class="line">    <span class="comment">// name: &#x27;Jim&#x27;,</span></span><br><span class="line">    <span class="comment">// age: 12</span></span><br><span class="line">    <span class="comment">// &#125;)</span></span><br><span class="line">    <span class="comment">// console.log(ret);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询参数</span></span><br><span class="line">    <span class="keyword">const</span> ret = <span class="keyword">await</span> userCollection.<span class="title function_">find</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ret: &quot;</span>, <span class="keyword">await</span> ret.<span class="title function_">toArray</span>()); <span class="comment">// ret.toArray()返回promise所以await</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;连接失败&quot;</span>, err);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// 断开连接</span></span><br><span class="line">    <span class="keyword">await</span> client.<span class="title function_">close</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">run</span>();</span><br></pre></td></tr></table></figure>

<h2 id="删除-id-的文档"><a href="#删除-id-的文档" class="headerlink" title="删除_id 的文档"></a>删除_id 的文档</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">ObjectId</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;mongodb&quot;</span>);</span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> userCollection.<span class="title function_">deleteOne</span>(&#123;</span><br><span class="line">  <span class="attr">_id</span>: <span class="title class_">ObjectId</span>(<span class="string">&quot;636b5886e7de417db38a5610&quot;</span>),</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(ret);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zax Tseng</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
